/* (c) Mathigon, generated by Mathigon Studio */
(()=>{var Uc=Object.defineProperty,s0=Object.defineProperties,i0=Object.getOwnPropertyDescriptor,n0=Object.getOwnPropertyDescriptors;var Fc=Object.getOwnPropertySymbols;var r0=Object.prototype.hasOwnProperty,o0=Object.prototype.propertyIsEnumerable;var jc=(e,s,t)=>s in e?Uc(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t,et=(e,s)=>{for(var t in s||(s={}))r0.call(s,t)&&jc(e,t,s[t]);if(Fc)for(var t of Fc(s))o0.call(s,t)&&jc(e,t,s[t]);return e},Rt=(e,s)=>s0(e,n0(s));var N=(e,s,t,i)=>{for(var n=i>1?void 0:i?i0(s,t):s,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(s,t,n):o(n))||n);return i&&n&&Uc(s,t,n),n};var R=(e,s,t)=>new Promise((i,n)=>{var r=l=>{try{a(t.next(l))}catch(h){n(h)}},o=l=>{try{a(t.throw(l))}catch(h){n(h)}},a=l=>l.done?i(l.value):Promise.resolve(l.value).then(r,o);a((t=t.apply(e,s)).next())});function gs(e=10){return Math.random().toString(36).substr(2,e)}function Y(e,...s){return s.includes(e)}var a0=(e,s)=>e.concat(s);function Nl(e,s,t=a0){for(let i of Object.keys(s))i in e&&Array.isArray(e[i])&&Array.isArray(s[i])?e[i]=t(e[i],s[i]):i in e&&e[i]instanceof Object&&s[i]instanceof Object?Nl(e[i],s[i]):e[i]=s[i]}function Ae(e,s=0){return s?+setTimeout(e,s):(e(),0)}function ns(e){return new Promise(s=>setTimeout(s,e))}function vs(){let e=()=>{},s=()=>{},t=new Promise((i,n)=>{e=i,s=n});return t.catch(i=>i),{promise:t,resolve:e,reject:s}}var Zc=class extends Error{constructor(e){super("[Cache Error]"),this.data=e}};function ue(e){let s=new Map;return function(...t){let i=t.join("--");if(!s.has(i))try{s.set(i,e(...t))}catch(r){s.set(i,new Zc(r))}let n=s.get(i);if(n instanceof Zc)throw n.data;return n}}function _e(e,s=0,t=!1){let i=!1,n=!1;return(...r)=>{i?n=!0:(t?n=!0:e(...r),i=!0,setTimeout(()=>{n&&e(...r),i=n=!1},s))}}function l0(e){return function(s,t){if(!s||Array.isArray(this)||e.includes(s))return t}}function Gs(e,s,t){if(!e)return s;try{return JSON.parse(e,t?l0(t):void 0)||s}catch(i){return s}}function zt(e,s){return new Array(s).fill(e)}function Gl(e,s,t){let i=[];for(let n=0;n<s;++n)i.push(zt(e,t));return i}function B(e,s){let t=[];for(let i=0;i<s;++i)t.push(e(i));return t}function cr(e,s,t){let i=[];for(let n=0;n<s;++n){let r=[];for(let o=0;o<t;++o)r.push(e(n,o));i.push(r)}return i}function He(e,s,t=1){let i=[];if(s===void 0&&e>=0)for(let n=0;n<e;n+=t)i.push(n);else if(s===void 0)for(let n=0;n>e;n-=t)i.push(n);else if(e<=s)for(let n=e;n<=s;n+=t)i.push(n);else for(let n=e;n>=s;n-=t)i.push(n);return i}function _(e,s=0){return e[e.length-1-s]}function q(e){return e.reduce((s,t)=>s+t,0)}function Ds(e,s,t=!1){return e.slice(0).sort((i,n)=>{let r=s(i),o=s(n);return r<o?t?1:-1:r>o?t?-1:1:0})}function _s(e){let s=0;return()=>e[s++%e.length]}function Ht(e){return e.filter((s,t)=>e.indexOf(s)===t)}function Bt(e){return e.reduce((s,t)=>s.concat(Array.isArray(t)?Bt(t):t),[])}function ws(e){let s=0;return e.map(t=>s+=t)}function gi(e,s){let t=[];for(let i=0;i<e.length;i+=s)t.push(e.slice(i,i+s));return t}function fn(e,s=1){let t=e.length;s=(s%t+t)%t;let i=e.slice(0,s);return e.slice(s).concat(i)}function Xc(...e){return e.reduce((s,t)=>s.concat(t),[])}var Yc=class{constructor(e){let s=e.length,t=e.map(i=>({val:i}));for(let[i,n]of t.entries())n.next=t[(i+1)%s],n.prev=t[(i-1+s)%s];this.root=t[0]}*traverse(){let e=this.root;for(;e;)if(yield e,e=e.next,e===this.root)return}get array(){return Array.from(this.traverse())}delete(e){if(e===this.root){if(e.next===e)return this.root=void 0;this.root=e.next}e.prev.next=e.next,e.next.prev=e.prev}};function lt(e,s=/\s+/){return e?e.trim().split(s):[]}function dr(e){return e.toLowerCase().replace(/^-/,"").replace(/-(.)/g,(s,t)=>t.toUpperCase())}function h0(e,s,t=!1){let i=Gl(0,e.length+1,s.length+1);for(let n=0;n<=e.length;n++)i[n][0]=n;for(let n=0;n<=s.length;n++)i[0][n]=n;for(let n=1;n<=e.length;n++)for(let r=1;r<=s.length;r++)i[n][r]=Math.min(i[n-1][r-1]+(e.charAt(n-1)===s.charAt(r-1)?0:1),i[n-1][r]+1,i[n][r-1]+1);return t?Math.min(...i[e.length]):i[e.length][s.length]}function Qc(e,s){let t=e.length/2,i=s.map(r=>({w:r,d:h0(e,r)})).filter(({d:r})=>r<t),n=Ds(i,r=>r.d)[0];return n?n.w:void 0}var rs=class{constructor(){this.events=new Map}on(e,s){for(let t of lt(e))this.events.has(t)||this.events.set(t,[]),this.events.get(t).push(s)}one(e,s){let t=i=>{this.off(e,t),s(i)};this.on(e,t)}off(e,s){for(let t of lt(e))this.events.has(t)&&this.events.set(t,this.events.get(t).filter(i=>i!==s))}trigger(e,s){for(let t of lt(e))if(this.events.has(t))for(let i of this.events.get(t))i(s)}},c0=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,d0=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i,p0=/rgba?\(([0-9.]+), ?([0-9.]+), ?([0-9.]+)(, ?([0-9.]+))?\)/,u0=["#22ab24","#009ea6","#0f82f2","#6d3bbf","#cd0e66","#eb4726","#fd8c00"];function Wc(e){return e.length===1?`0${e}`:e}function Kc(e,s){if(s<=0)return F.from(e[0]);if(s>=1)return F.from(_(e));let t=Math.floor(s*(e.length-1)),i=s*(e.length-1)-t;return F.mix(e[t+1],e[t],i)}function Il(e,s,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?e+(s-e)*6*t:t<1/2?s:t<2/3?e+(s-e)*(2/3-t)*6:e}var F=class{constructor(e,s,t,i=1){this.r=e,this.g=s,this.b=t,this.a=i}get hex(){let e=[this.r,this.g,this.b].map(t=>Wc(Math.round(t).toString(16))),s=this.a>=1?"":Wc(Math.round(this.a*255).toString(16));return`#${e.join("")}${s}`}get rgb(){return`rgba(${[this.r,this.g,this.b].map(s=>Math.round(s)).join(",")},${this.a})`}get brightness(){return(this.r*299+this.g*587+this.g*114)/1e3}get hsl(){let e=this.r/255,s=this.g/255,t=this.b/255,i=Math.max(e,s,t),n=Math.min(e,s,t),r=(n+i)/2,o=i-n;if(i===n)return[0,0,Math.round(r*100)];let a=e===i?(s-t)/o:s===i?2+(t-e)/o:4+(e-s)/o;a=Math.min(a*60,360),a<0&&(a+=360);let l=r<=.5?o/(i+n):o/(2-i-n);return[Math.round(a),Math.round(l*100),Math.round(r*100)]}get chroma(){return Math.max(this.r,this.g,this.b)-Math.min(this.r,this.g,this.b)}toString(){return this.rgb}copy(){return new F(this.r,this.g,this.b,this.a)}static from(e){return typeof e!="string"?e:e.startsWith("#")?F.fromHex(e):F.fromRgb(e)}static fromRgb(e){let s=e.match(p0);if(!s)return new F(0,0,0);let t=s[4]?+s[5]||0:1;return new F(+s[1],+s[2],+s[3],t)}static fromHex(e){e=e.replace(c0,(t,i,n,r)=>i+i+n+n+r+r);let s=d0.exec(e);return s?new F(parseInt(s[1],16),parseInt(s[2],16),parseInt(s[3],16),s[4]?parseInt(s[4],16)/255:1):new F(0,0,0)}static fromHsl(e,s,t){if(e/=360,s/=100,t/=100,s===0){let l=Math.round(t*255);return new F(l,l,l)}let i=t<.5?t*(1+s):t+s-t*s,n=2*t-i,r=Il(n,i,e+1/3),o=Il(n,i,e),a=Il(n,i,e-1/3);return new F(Math.round(r*255),Math.round(o*255),Math.round(a*255))}static rainbow(e){return B(s=>Kc(u0,s/(e-1)),e)}static gradient(e,s){return B(t=>Kc(e,t/(s-1)),s)}static shades(e,s,t=.5){let i=F.mix("#fff",e,t),n=F.mix("#000",e,t);return F.gradient([i,e,n],s)}static mix(e,s,t=.5){return e=F.from(e),s=F.from(s),new F(t*e.r+(1-t)*s.r,t*e.g+(1-t)*s.g,t*e.b+(1-t)*s.b,t*e.a+(1-t)*s.a)}static mixMany(e,s){s||(s=e.map(()=>1));let t=q(s),i=e.map(g=>g.hsl),n=i.map(g=>g[0]),r=n.map(g=>g<180?g+360:g),o=s.map((g,y)=>g*Math.sqrt(e[y].chroma)),a=q(o),l=q(n.map((g,y)=>g*o[y]))/a,h=q(r.map((g,y)=>g*o[y]))/a,d=q(n.map((g,y)=>Math.abs(g-l)*o[y])),u=q(r.map((g,y)=>Math.abs(g-h)*o[y])),f=d<=u?l:h%360,v=q(i.map((g,y)=>s[y]*g[1]))/t,w=q(i.map((g,y)=>s[y]*g[2]))/t;return F.fromHsl(f,v,w)}};function pr(e){return e[Symbol.iterator]().next().value}function ur(e,s){for(let t of e)if(!s(t))return!1;return!0}function Ve(e,s){for(let t of e)if(s(t))return!0;return!1}function*vi(e,s){for(let t of e)for(let i of s(t))yield i}function*wi(e,s){for(let t of e)for(let i of s)yield[t,i]}function*Dl(e){let s=e.length;for(let t=0;t<s;++t)for(let i=t+1;i<s;++i)yield[e[t],e[i]]}function os(e,s,t=1/0,i){let n,r=t;for(let o of e){let a=s(o);if(a<r&&(n=o,r=a,i!==void 0&&r<i))return n}return n}var hr=class{constructor(...e){this.values=e}map(e){let s=this.values;return new hr(function*(){let t=0;for(let i of s)for(let n of i)yield e(n,t),t+=1}())}every(e){let s=0;for(let t of this.values)for(let i of t){if(!e(i,s))return!1;s+=1}return!0}some(e){let s=0;for(let t of this.values)for(let i of t){if(e(i,s))return!0;s+=1}return!1}slice(e,s){let t=this.values;return new hr(function*(){let i=0;for(let n of t)for(let r of n)i<e||s!==void 0&&i>e+s||(yield r,i+=1)}())}filter(e){let s=this.values;return new hr(function*(){let t=0;for(let i of s)for(let n of i)e(n,t)&&(yield n),t+=1}())}concat(e){this.values.push(e)}[Symbol.iterator](){let e=this.values;return function*(){for(let s of e)for(let t of s)yield t}()}static make(e,s){return new hr(function*(){let t=0;for(;s===void 0||t<s;)yield e(t),t+=1}())}};var f0=Object.defineProperty,Hl=(e,s)=>{for(var t in s)f0(e,t,{get:s[t],enumerable:!0})},Bl=1e-6;function P(e,s,t=Bl){return isNaN(e)||isNaN(s)?!1:Math.abs(e-s)<t}function as(e,s=Bl){return P(e%1,0,s)}function st(e,s,t,i=Bl){return s>t&&([s,t]=[t,s]),e>s+i&&e<t-i}var Jc=/(\d+)(\d{3})/,m0=["","k","m","b","t","q"];function g0(e){let[s,t]=e.split(".");for(;Jc.test(s);)s=s.replace(Jc,"$1,$2");return s+(t?`.${t}`:"")}function v0(e,s=6){if(!s)return`${e}`;let t=`${Math.abs(Math.floor(e))}`.length,i=e<0?1:0;if(t<=s-i)return`${Ft(e,s-t-i-1)}`;let n=Math.floor(Math.log10(Math.abs(e))/3);return Ft(e/Math.pow(10,3*n),s-(t%3||3)-i-1)+m0[n]}function nt(e,s=0,t=!0){let i=v0(e,s).replace("-","\u2013");return t?g0(i):i}var w0=/^-?0,[0-9]+$/,y0=/^-?([0-9]+(,[0-9]{3})*)?\.?[0-9]*$/,b0=/^-?[0-9]+(\.[0-9]{3})*,?[0-9]*$/;function mn(e){return e=e.replace(/^–/,"-").trim(),!e||e.match(/[^0-9.,-]/)?NaN:w0.test(e)?parseFloat(e.replace(/,/,".")):y0.test(e)?parseFloat(e.replace(/,/g,"")):b0.test(e)?parseFloat(e.replace(/\./g,"").replace(/,/,".")):NaN}var _l=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],td=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],$0=[""," thousand"," million"," billion"," trillion"," quadrillion"," quintillion"," sextillion"];function x0(e){let[s,t,i]=e.split(""),n=s==="0"?"":` ${_l[+s]} hundred`;return t+i==="00"?n:+t<2?`${n} ${_l[+(t+i)]}`:i==="0"?`${n} ${td[+t]}`:`${n} ${td[+t]}-${_l[+i]}`}function yi(e){if(e===0)return"zero";let s=Math.round(Math.abs(e)).toString(),t=Math.ceil(s.length/3),i=s.padStart(3*t,"0"),n="";for(let r=0;r<t;r+=1){let o=i.substr(r*3,3);o!=="000"&&(n+=x0(o)+$0[t-1-r])}return n.trim()}function Ft(e,s=0){let t=Math.pow(10,s);return Math.round(e*t)/t}function ht(e,s=1){return Math.round(e/s)*s}function S(e,s=-1/0,t=1/0){return Math.min(t,Math.max(s,e))}function $t(e,s,t=.5){return e+(s-e)*t}function me(e){return e*e}function Ct(e,s){return(e%s+s)%s}function ql(e,s,t){if(P(e,0)&&P(s,0))return[];if(P(e,0))return[-t/s];let i=-s/2/e,n=Math.sqrt(s*s-4*e*t)/2/e;return[i+n,i-n]}function id(e,s=0){let t=e.slice(0),i=nd(t);return s?i.filter(n=>n.length===s):i}function nd(e){if(e.length===1)return[[],e];let s=e.pop(),t=nd(e),i=[];for(let n of t)i.push(n,[...n,s]);return i}var fr=(e,s)=>{let t=e<0?"\u2013":"";return Math.abs(e)===1&&s?t+s:t+Math.abs(e)+(s||"")},Tt=class{constructor(e=0,s=0){this.re=e,this.im=s}get modulus(){return Math.sqrt(this.re*this.re+this.im*this.im)}get argument(){return Math.atan2(this.im,this.re)}get conjugate(){return new Tt(this.re,-this.im)}root(e,s=0){let t=Math.pow(this.modulus,1/e),i=(this.argument+s*2*Math.PI)/e;return new Tt(t*Math.cos(i),t*Math.sin(i))}toString(e=2){let s=Ft(this.re,e),t=Ft(this.im,e);return t===0?fr(s):s===0?fr(t,"i"):[fr(s),t<0?"\u2013":"+",fr(Math.abs(t),"i")].join(" ")}add(e){return Tt.sum(this,e)}subtract(e){return Tt.difference(this,e)}multiply(e){return Tt.product(this,e)}divide(e){return Tt.quotient(this,e)}static sum(e,s){return typeof e=="number"&&(e=new Tt(e,0)),typeof s=="number"&&(s=new Tt(s,0)),new Tt(e.re+s.re,e.im+s.im)}static difference(e,s){return typeof e=="number"&&(e=new Tt(e,0)),typeof s=="number"&&(s=new Tt(s,0)),new Tt(e.re-s.re,e.im-s.im)}static product(e,s){typeof e=="number"&&(e=new Tt(e,0)),typeof s=="number"&&(s=new Tt(s,0));let t=e.re*s.re-e.im*s.im,i=e.im*s.re+e.re*s.im;return new Tt(t,i)}static quotient(e,s){if(typeof e=="number"&&(e=new Tt(e,0)),typeof s=="number"&&(s=new Tt(s,0)),Math.abs(s.re)<Number.EPSILON||Math.abs(s.im)<Number.EPSILON)return new Tt(1/0,1/0);let t=s.re*s.re+s.im*s.im,i=(e.re*s.re+e.im*s.im)/t,n=(e.im*s.re-e.re*s.im)/t;return new Tt(i,n)}static exp(e){typeof e=="number"&&(e=new Tt(e,0));let s=Math.exp(e.re);return new Tt(s*Math.cos(e.im),s*Math.sin(e.im))}};function ys(...e){let[s,...t]=e;if(t.length>1)return ys(s,ys(...t));let i=Math.abs(s),n=Math.abs(t[0]);for(;n;)[i,n]=[n,i%n];return i}function Hs(...e){let[s,...t]=e;return t.length>1?Hs(s,Hs(...t)):Math.abs(s*t[0])/ys(s,t[0])}function gn(e){if(e%1!==0||e<2)return!1;if(e%2===0)return e===2;if(e%3===0)return e===3;let s=Math.sqrt(e);for(let t=5;t<=s;t+=6)if(e%t===0||e%(t+2)===0)return!1;return!0}function Be(e){if(e===1)return[];if(gn(e))return[e];let s=Math.sqrt(e);for(let t=2;t<=s;++t)if(e%t===0)return Be(t).concat(Be(e/t));return[]}function rd(e){return Ht(Be(e))}var P0=/^([0-9\-.]*)([%πkmbtq]?)(\/([0-9\-.]+))?([%π]?)$/,j=class{constructor(e,s,t){this.unit=t,this.num=s!==void 0&&s<0?-e:e,s!==void 0&&Math.abs(s)!==1&&e!==0&&(this.den=Math.abs(s))}valueOf(){return this.value}toString(e=4){let s=nt(this.num,e),t=this.unit||"",i=this.den?`/${nt(this.den,e)}`:"";return s==="0"&&(t=""),t==="\u03C0"&&!this.den&&(s==="1"||s==="\u20131")&&(s=s.replace("1","")),`${s}${i}${t}`}toMathML(){let e=`<mn>${this.num}</mn>`;return this.den!==void 0&&(e=`<mfrac>${e}<mn>${this.den}</mn></mfrac>`),this.unit&&(e+=this.unit==="\u03C0"?"<mi>\u03C0</mi>":"<mo>%</mo>"),e}get value(){let e=this.unit==="%"?.01:this.unit==="\u03C0"?Math.PI:1;return this.num*e/(this.den||1)}get sign(){return Math.sign(this.num)}get simplified(){if(!this.den)return this;let e=ys(Math.abs(this.num),this.den);return new j(this.num/e,this.den/e,this.unit)}get inverse(){return this.den?new j(1/this.num,void 0,this.unit):new j(this.den,this.num)}get negative(){return new j(-this.num,this.den,this.unit)}static fromString(e){e=e.toLowerCase().replace(/[\s,]/g,"").replace("\u2013","-").replace("pi","\u03C0");let s=e.match(P0);if(!s)return;let t=s[2]||s[5]||void 0,i=s[1]?+s[1]:void 0,n=s[4]?+s[4]:void 0;if(t==="\u03C0"&&(!s[1]||s[1]==="-")&&(i=s[1]?-1:1),i===void 0||isNaN(i))return;let r=t?"kmbtq".indexOf(t):-1;if(r>=0&&(i*=1e3**(r+1),t=void 0),n===void 0)return new j(i,void 0,t);if(!(isNaN(n)||P(n,0)))return!as(i)||!as(n)?new j(i/n,void 0,t):new j(i,n,t)}static fractionFromDecimal(e,s=100){let t=Math.sign(e),i=Math.floor(Math.abs(e));e=Math.abs(e)-i;let n=0,r=1,o=1,a=1;for(;r<=s&&a<=s;){let l=(n+o)/(r+a);if(e===l)return r+a<=s?new j(t*(i*(r+a)+n+o),r+a):a>r?new j(t*(i*a+o),a):new j(t*(i*r+n),r);e>l?[n,r]=[n+o,r+a]:[o,a]=[n+o,r+a]}return r>s?new j(t*(i*a+o),a):new j(t*(i*r+n),r)}clamp(e,s){let t=this.value;return e!==void 0&&t<e?new j(e):s!==void 0&&t>s?new j(s):this}add(e){return j.sum(this,e)}subtract(e){return j.difference(this,e)}multiply(e){return j.product(this,e)}divide(e){return j.quotient(this,e)}static sum(e,s){return typeof s=="number"&&(s=new j(s)),e.num===0?s:e.unit!==s.unit?new j(e.value+s.value):!e.den&&!s.den?new j(e.num+s.num,void 0,e.unit):(e.den||([e,s]=[s,e]),as(s.num)?new j(e.num*(s.den||1)+s.num*e.den,e.den*(s.den||1),e.unit).simplified:new j(e.value+s.value,void 0,e.unit))}static difference(e,s){return typeof s=="number"&&(s=new j(s)),j.sum(e,s.negative)}static product(e,s){if(typeof s=="number"&&(s=new j(s)),!e.unit&&!e.den&&as(e.num))return new j(e.num*s.num,s.den,s.unit).simplified;if(!s.unit&&!s.den&&as(s.num))return new j(e.num*s.num,e.den,e.unit).simplified;if(e.unit==="\u03C0"||s.unit==="\u03C0"||!as(e.num)||!as(s.num))return new j(e.value*s.value);let t=(e.unit==="%"?100:1)*(s.unit==="%"?100:1);return new j(e.num*s.num,(e.den||1)*(s.den||1)*t)}static quotient(e,s){return typeof s=="number"&&(s=new j(s)),j.product(e,s.inverse)}},At={};Hl(At,{determinant:()=>E0,fill:()=>od,identity:()=>ad,inverse:()=>cd,product:()=>gr,reflection:()=>C0,rotation:()=>S0,scalarProduct:()=>M0,shear:()=>T0,sum:()=>ld,transpose:()=>hd});function od(e,s,t){return Gl(e,s,t)}function ad(e=2){let s=od(0,e,e);for(let t=0;t<e;++t)s[t][t]=1;return s}function S0(e){let s=Math.sin(e),t=Math.cos(e);return[[t,-s],[s,t]]}function T0(e){return[[1,e],[0,1]]}function C0(e){let s=Math.sin(2*e),t=Math.cos(2*e);return[[t,s],[s,-t]]}function ld(...e){let[s,...t]=e,i=t.length>1?ld(...t):t[0];if(s.length!==i.length||s[0].length!==i[0].length)throw new Error("Matrix sizes don\u2019t match");let n=[];for(let r=0;r<s.length;++r){let o=[];for(let a=0;a<s[r].length;++a)o.push(s[r][a]+i[r][a]);n.push(o)}return n}function M0(e,s){return e.map(t=>t.map(i=>i*s))}function gr(...e){let[s,...t]=e,i=t.length>1?gr(...t):t[0];if(s[0].length!==i.length)throw new Error("Matrix sizes don\u2019t match.");let n=[];for(let r=0;r<s.length;++r){let o=[];for(let a=0;a<i[0].length;++a){let l=0;for(let h=0;h<i.length;++h)l+=s[r][h]*i[h][a];o.push(l)}n.push(o)}return n}function hd(e){let s=[];for(let t=0;t<e[0].length;++t){let i=[];for(let n=0;n<e.length;++n)i.push(e[n][t]);s.push(i)}return s}function E0(e){if(e.length!==e[0].length)throw new Error("Not a square matrix.");let s=e.length;if(s===1)return e[0][0];if(s===2)return e[0][0]*e[1][1]-e[0][1]*e[1][0];let t=0;for(let i=0;i<s;++i){let n=e[0][i],r=e[0][i];for(let o=1;o<s;++o)r*=e[o][(i+o)%s],n*=e[o][(i-o+s)%s];t+=r-n}return t}function cd(e){let s=e.length;if(s!==e[0].length)throw new Error("Not a square matrix.");let t=ad(s),i=cr((n,r)=>e[n][r],s,s);for(let n=0;n<s;++n){let r=i[n][n];if(P(r,0)){for(let o=n+1;o<s;++o)if(i[o][n]!==0){for(let a=0;a<s;++a)[i[o][a],i[n][a]]=[i[n][a],i[o][a]],[t[o][a],t[n][a]]=[t[n][a],t[o][a]];break}if(r=i[n][n],P(r,0))throw new Error("Matrix not invertible.")}for(let o=0;o<s;++o)i[n][o]=i[n][o]/r,t[n][o]=t[n][o]/r;for(let o=0;o<s;++o){if(o===n)continue;let a=i[o][n];for(let l=0;l<s;++l)i[o][l]-=a*i[n][l],t[o][l]-=a*t[n][l]}}return t}var J={};Hl(J,{bernoulli:()=>pd,binomial:()=>L0,cauchy:()=>_0,chiCDF:()=>B0,exponential:()=>G0,find:()=>k0,geometric:()=>D0,integer:()=>V0,integrate:()=>fd,normal:()=>N0,normalPDF:()=>H0,poisson:()=>R0,shuffle:()=>A0,smart:()=>O0,uniform:()=>I0,weighted:()=>dd});function A0(e){e=e.slice(0);for(let s=e.length-1;s>0;--s){let t=Math.floor(Math.random()*(s+1));[e[s],e[t]]=[e[t],e[s]]}return e}function V0(e,s){let t=s===void 0?0:e,i=s===void 0?e:s-e+1;return t+Math.floor(i*Math.random())}function dd(e){let s=Math.random()*q(e),t=0;return e.findIndex(i=>(t+=i)>=s)}function k0(e){return e[Math.floor(e.length*Math.random())]}var mr=new Map;function O0(e,s){s||(s=gs()),mr.has(s)||mr.set(s,zt(1,e));let t=mr.get(s),i=dd(t.map(n=>n*n));return t[i]-=1,t[i]<=0&&mr.set(s,t.map(n=>n+1)),i}function pd(e=.5){return Math.random()<e?1:0}function L0(e=1,s=.5){let t=0;for(let i=0;i<e;++i)t+=pd(s);return t}function R0(e=1){if(e<=0)return 0;let s=Math.exp(-e),t=1,i=0;for(;t>s;++i)t*=Math.random();return i-1}function I0(e=0,s=1){return e+(s-e)*Math.random()}function N0(e=0,s=1){let t=Math.random(),i=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*i)*Math.sqrt(s)+e}function G0(e=1){return e<=0?0:-Math.log(Math.random())/e}function D0(e=.5){if(!(e<=0||e>1))return Math.floor(Math.log(Math.random())/Math.log(1-e))}function _0(){let e,s,t;do s=2*Math.random()-1,t=2*Math.random()-1,e=s*s+t*t;while(e>=1);return s/t}function H0(e,s=1,t=0){return Math.exp(-((e-s)**2)/(2*t))/Math.sqrt(2*Math.PI*t)}var ed=7,sd=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23];function ud(e){if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*ud(1-e));e-=1;let s=sd[0];for(let i=1;i<ed+2;i++)s+=sd[i]/(e+i);let t=e+ed+.5;return Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*s}function fd(e,s,t,i=1){let n=0;for(let r=s;r<t;r+=i)n+=e(r)*i||0;return n}function B0(e,s){let t=fd(i=>Math.pow(i,(s-2)/2)*Math.exp(-i/2),0,e);return 1-t/Math.pow(2,s/2)/ud(s/2)}var zl={};Hl(zl,{bestPolynomial:()=>Z0,coefficient:()=>gd,exponential:()=>F0,linear:()=>z0,logarithmic:()=>j0,polynomial:()=>md,power:()=>U0});function q0(e,s){let t=1,i=e[0];for(let n=1;n<e.length;++n)t*=s,i+=t*e[n];return i}function z0(e,s=!1){let t=0,i=0,n=0,r=0,o=e.length;for(let h=0;h<o;h++)t+=e[h][0],i+=e[h][1],n+=e[h][0]*e[h][0],r+=e[h][0]*e[h][1];if(s){let h=r/n;return[0,h]}let a=(o*r-t*i)/(o*n-t*t);return[i/o-a*t/o,a]}function F0(e){let s=[0,0,0,0,0,0];for(let r of e)s[0]+=r[0],s[1]+=r[1],s[2]+=r[0]*r[0]*r[1],s[3]+=r[1]*Math.log(r[1]),s[4]+=r[0]*r[1]*Math.log(r[1]),s[5]+=r[0]*r[1];let t=s[1]*s[2]-s[5]*s[5],i=Math.exp((s[2]*s[3]-s[5]*s[4])/t),n=(s[1]*s[4]-s[5]*s[3])/t;return[i,n]}function j0(e){let s=[0,0,0,0],t=e.length;for(let r of e)s[0]+=Math.log(r[0]),s[1]+=r[1]*Math.log(r[0]),s[2]+=r[1],s[3]+=Math.pow(Math.log(r[0]),2);let i=(t*s[1]-s[2]*s[0])/(t*s[3]-s[0]*s[0]);return[(s[2]-i*s[0])/t,i]}function U0(e){let s=[0,0,0,0],t=e.length;for(let r of e)s[0]+=Math.log(r[0]),s[1]+=Math.log(r[1])*Math.log(r[0]),s[2]+=Math.log(r[1]),s[3]+=Math.pow(Math.log(r[0]),2);let i=(t*s[1]-s[2]*s[0])/(t*s[3]-s[0]*s[0]);return[Math.exp((s[2]-i*s[0])/t),i]}function md(e,s=2){let t=e.map(l=>He(s+1).map(h=>Math.pow(l[0],h))),i=hd(t),n=e.map(l=>[l[1]]),r=gr(i,t),o=cd(r);return gr(o,i,n).map(l=>l[0])}function gd(e,s){let i=e.reduce((o,a)=>o+a[1],0)/e.length,n=e.reduce((o,a)=>o+(a[1]-i)**2,0),r=e.reduce((o,a)=>o+(a[1]-s(a[0]))**2,0);return 1-r/n}function Z0(e,s=.85,t=8){if(!(e.length<=1))for(let i=1;i<t;++i){let n=md(e,i),r=a=>q0(n,a);if(gd(e,r)>=s)return{order:i,coefficients:n,fn:r}}}function bi(e){return e.length?q(e)/e.length:0}function $i(e,s){let t=e.length;if(!t)return 0;let i=e.slice(0).sort((o,a)=>o-a);if(s===0)return e[0];if(s===1)return e[t-1];let n=t*s-.5;if(Number.isInteger(n))return i[n];let r=Math.floor(n);return $t(i[r],i[r+1],n-r)}var D=2*Math.PI;function bs(e,s){let t=Math.atan2(e.y-(s?s.y:0),e.x-(s?s.x:0));return Ct(t,D)}function vd(e,s){let t,i=1/0,n=-1;for(let[r,o]of s.entries()){let a=o.project(e),l=p.distance(e,a);l<i&&(t=a,i=l,n=r)}return t?[t,n]:void 0}var p=class{constructor(e=0,s=0){this.x=e,this.y=s,this.type="point"}get unitVector(){return P(this.length,0)?new p(1,0):this.scale(1/this.length)}get length(){return Math.sqrt(this.x**2+this.y**2)}get inverse(){return new p(-this.x,-this.y)}get flip(){return new p(this.y,this.x)}get perpendicular(){return new p(-this.y,this.x)}get array(){return[this.x,this.y]}distanceFromLine(e){return p.distance(this,e.project(this))}clamp(e,s=0){let t=S(this.x,e.xMin+s,e.xMax-s),i=S(this.y,e.yMin+s,e.yMax-s);return new p(t,i)}changeCoordinates(e,s){let t=s.xMin+(this.x-e.xMin)/e.dx*s.dx,i=s.yMin+(this.y-e.yMin)/e.dy*s.dy;return new p(t,i)}add(e){return p.sum(this,e)}subtract(e){return p.difference(this,e)}round(e=1){return new p(ht(this.x,e),ht(this.y,e))}floor(){return new p(Math.floor(this.x),Math.floor(this.y))}mod(e,s=e){return new p(this.x%e,this.y%s)}angle(e=$){return bs(this,e)}snap(e,s=5){return P(this.x,e.x,s)?new p(e.x,this.y):P(this.y,e.y,s)?new p(this.x,e.y):this}static average(...e){let s=q(e.map(i=>i.x))/e.length,t=q(e.map(i=>i.y))/e.length;return new p(s,t)}static dot(e,s){return e.x*s.x+e.y*s.y}static sum(e,s){return new p(e.x+s.x,e.y+s.y)}static difference(e,s){return new p(e.x-s.x,e.y-s.y)}static distance(e,s){return Math.sqrt(me(e.x-s.x)+me(e.y-s.y))}static manhattan(e,s){return Math.abs(e.x-s.x)+Math.abs(e.y-s.y)}static interpolate(e,s,t=.5){return new p($t(e.x,s.x,t),$t(e.y,s.y,t))}static interpolateList(e,s=.5){let t=e.length-1,i=Math.floor(S(s,0,1)*t);return p.interpolate(e[i],e[i+1],t*s-i)}static fromPolar(e,s=1){return new p(s*Math.cos(e),s*Math.sin(e))}static random(e){let s=J.uniform(e.xMin,e.xMax),t=J.uniform(e.yMin,e.yMax);return new p(s,t)}static equals(e,s,t){return P(e.x,s.x,t)&&P(e.y,s.y,t)}static colinear(e,s,t,i){let n=e.x-s.x,r=e.y-s.y,o=s.x-t.x,a=s.y-t.y;return P(n*a,o*r,i)}transform(e){let s=e[0][0]*this.x+e[0][1]*this.y+e[0][2],t=e[1][0]*this.x+e[1][1]*this.y+e[1][2];return new p(s,t)}rotate(e,s=$){if(P(e,0))return this;let t=this.x-s.x,i=this.y-s.y,n=Math.cos(e),r=Math.sin(e),o=t*n-i*r+s.x,a=t*r+i*n+s.y;return new p(o,a)}reflect(e){let s=e.p2.x-e.p1.x,t=e.p2.y-e.p1.y,i=this.x-e.p1.x,n=this.y-e.p1.y,r=(s*n-t*i)/(s*s+t*t),o=this.x+2*r*t,a=this.y-2*r*s;return new p(o,a)}scale(e,s=e){return new p(this.x*e,this.y*s)}shift(e,s=e){return new p(this.x+e,this.y+s)}translate(e){return this.shift(e.x,e.y)}equals(e,s){return p.equals(this,e,s)}toString(){return`point(${this.x},${this.y})`}},$=new p(0,0),wt=class{constructor(e,s){this.p1=e,this.p2=s,this.type="line"}make(e,s){return new wt(e,s)}get length(){return p.distance(this.p1,this.p2)}get lengthSquared(){return(this.p1.x-this.p2.x)**2+(this.p1.y-this.p2.y)**2}get midpoint(){return p.average(this.p1,this.p2)}get slope(){return(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x)}get intercept(){return this.p1.y-this.slope*this.p1.x}get angle(){return bs(this.p2,this.p1)}get unitVector(){return this.p2.subtract(this.p1).unitVector}get perpendicularVector(){return new p(this.p2.y-this.p1.y,this.p1.x-this.p2.x).unitVector}parallel(e){let s=p.sum(e,p.difference(this.p2,this.p1));return new wt(e,s)}perpendicular(e){return new wt(e,p.sum(e,this.perpendicularVector))}get perpendicularBisector(){return this.perpendicular(this.midpoint)}distanceSquared(e){let s=this.project(e);return(e.x-s.x)**2+(e.y-s.y)**2}offset(e){let s=p.difference(this.p2,this.p1),t=p.difference(e,this.p1);return p.dot(s,t)/this.lengthSquared}project(e){return this.at(this.offset(e))}side(e,s){let t=p.difference(this.p2,this.p1),i=p.difference(e,this.p1),n=i.x*t.y-i.y*t.x;return P(n,0,s)?0:Math.sign(n)}contains(e,s){return this.side(e,s)===0}at(e){return p.interpolate(this.p1,this.p2,e)}transform(e){return new this.constructor(this.p1.transform(e),this.p2.transform(e))}rotate(e,s=$){return P(e,0)?this:new this.constructor(this.p1.rotate(e,s),this.p2.rotate(e,s))}reflect(e){return new this.constructor(this.p1.reflect(e),this.p2.reflect(e))}scale(e,s=e){return this.make(this.p1.scale(e,s),this.p2.scale(e,s))}shift(e,s=e){return this.make(this.p1.shift(e,s),this.p2.shift(e,s))}translate(e){return this.shift(e.x,e.y)}equals(e,s){return this.contains(e.p1,s)&&this.contains(e.p2,s)}toString(){return`line(${this.p1},${this.p2})`}},Zl=class extends wt{constructor(){super(...arguments),this.type="ray"}make(e,s){return new Zl(e,s)}equals(e,s){return e.type!=="ray"?!1:this.p1.equals(e.p1,s)&&this.contains(e.p2,s)}contains(e,s){if(!wt.prototype.contains.call(this,e,s))return!1;let t=this.offset(e);return P(t,0,s)||t>0}toString(){return`ray(${this.p1},${this.p2})`}},it=class extends wt{constructor(){super(...arguments),this.type="segment"}contains(e,s){return wt.prototype.contains.call(this,e,s)?this.p1.equals(e,s)||this.p2.equals(e,s)?!0:P(this.p1.x,this.p2.x,s)?st(e.y,this.p1.y,this.p2.y):st(e.x,this.p1.x,this.p2.x):!1}make(e,s){return new it(e,s)}project(e){let s=p.difference(this.p2,this.p1),t=p.difference(e,this.p1),i=S(p.dot(s,t)/this.lengthSquared,0,1);return p.sum(this.p1,s.scale(i))}contract(e){return new it(this.at(e),this.at(1-e))}equals(e,s,t=!1){return e.type!=="segment"?!1:this.p1.equals(e.p1,s)&&this.p2.equals(e.p2,s)||!t&&this.p1.equals(e.p2,s)&&this.p2.equals(e.p1,s)}toString(){return`segment(${this.p1},${this.p2})`}},H=class{constructor(e=$,s=1){this.c=e,this.r=s,this.type="circle"}get circumference(){return D*this.r}get area(){return Math.PI*this.r**2}get arc(){let e=this.c.shift(this.r,0);return new re(this.c,e,D)}tangentAt(e){let s=this.at(e),t=this.c.rotate(Math.PI/2,s);return new wt(s,t)}collision(e){let s=this.c.x<e.p.x?e.p.x:this.c.x>e.p.x+e.w?e.p.x+e.w:this.c.x,t=this.c.y<e.p.y?e.p.y:this.c.y>e.p.y+e.h?e.p.y+e.h:this.c.y;return p.distance(this.c,new p(s,t))<=this.r}project(e){let s=e.subtract(this.c).unitVector.scale(this.r);return p.sum(this.c,s)}at(e){let s=D*e;return this.c.shift(this.r*Math.cos(s),this.r*Math.sin(s))}offset(e){return bs(e,this.c)/D}contains(e){return p.distance(e,this.c)<=this.r}transform(e){let s=Math.abs(e[0][0])+Math.abs(e[1][1]);return new H(this.c.transform(e),this.r*s/2)}rotate(e,s=$){return P(e,0)?this:new H(this.c.rotate(e,s),this.r)}reflect(e){return new H(this.c.reflect(e),this.r)}scale(e,s=e){return new H(this.c.scale(e,s),this.r*(e+s)/2)}shift(e,s=e){return new H(this.c.shift(e,s),this.r)}translate(e){return this.shift(e.x,e.y)}equals(e,s){return P(this.r,e.r,s)&&this.c.equals(e.c,s)}toString(){return`circle(${this.c},${this.r})`}},re=class{constructor(e,s,t){this.c=e,this.start=s,this.angle=t,this.type="arc"}get circle(){return new H(this.c,this.radius)}get radius(){return p.distance(this.c,this.start)}get end(){return this.start.rotate(this.angle,this.c)}get startAngle(){return bs(this.start,this.c)}contract(e){return new this.constructor(this.c,this.at(e/2),this.angle*(1-e))}get minor(){return this.angle<=Math.PI?this:new this.constructor(this.c,this.end,D-this.angle)}get major(){return this.angle>=Math.PI?this:new this.constructor(this.c,this.end,D-this.angle)}get center(){return this.at(.5)}project(e){let s=this.startAngle,t=s+this.angle,i=bs(e,this.c);return t>D&&i<t-D&&(i+=D),i=S(i,s,t),this.c.shift(this.radius,0).rotate(i,this.c)}at(e){return this.start.rotate(this.angle*e,this.c)}offset(e){return new Vt(this.start,this.c,e).rad/this.angle}contains(e){return e.equals(this.project(e))}transform(e){return new this.constructor(this.c.transform(e),this.start.transform(e),this.angle)}rotate(e,s=$){return P(e,0)?this:new this.constructor(this.c.rotate(e,s),this.start.rotate(e,s),this.angle)}reflect(e){return new this.constructor(this.c.reflect(e),this.start.reflect(e),this.angle)}scale(e,s=e){return new this.constructor(this.c.scale(e,s),this.start.scale(e,s),this.angle)}shift(e,s=e){return new this.constructor(this.c.shift(e,s),this.start.shift(e,s),this.angle)}translate(e){return this.shift(e.x,e.y)}equals(){return!1}toString(){return`arc(${this.c},${this.start},${this.angle})`}},qe=class extends re{constructor(){super(...arguments),this.type="sector"}contains(e){return p.distance(e,this.c)<=this.radius&&new Vt(this.start,this.c,e).rad<=this.angle}toString(){return`sector(${this.c},${this.start},${this.angle})`}},Bs=1e-6;function jl(e,s,t){let i=(t.x-s.x)*(e.y-s.y),n=(t.y-s.y)*(e.x-s.x);return i-n>=-Bs}function wd(e,s,t){let i=e.y-s.y,n=t.x-s.x,r=e.x-s.x,o=t.y-s.y,a=r*n+i*o;if(a<Bs)return!1;let l=n*n+o*o;return a-l<=-Bs}function Sd(e,s){return P(e.x,s.x)?P(e.y,s.y)?0:e.y<s.y?-1:1:e.x<s.x?-1:1}function yd(e){return e<=-Bs?-2:e<Bs?-1:e-1<=-Bs?0:e-1<Bs?1:2}function W0(e,s,t,i){let n=s.x-e.x,r=s.y-e.y,o=i.x-t.x,a=i.y-t.y,l=n*a-r*o;if(P(l,0))return!1;let h=e.x-t.x,d=e.y-t.y,u=(o*d-a*h)/l,f=(n*d-r*h)/l,v=new p(e.x+u*n,e.y+u*r);return{alongA:yd(u),alongB:yd(f),pt:v}}var xi=class{constructor(){this.root={root:!0,next:void 0}}exists(e){return e!==void 0&&e!==this.root}get head(){return this.root.next}insertBefore(e,s){let t=this.root,i=this.root.next;for(;i;){if(s(i)){e.prev=i.prev,e.next=i,i.prev.next=e,i.prev=e;return}t=i,i=i.next}t.next=e,e.prev=t,e.next=void 0}findTransition(e){let s=this.root,t=this.root.next;for(;t&&!e(t);)s=t,t=t.next;return{before:s===this.root?void 0:s,after:t,insert:i=>(i.prev=s,i.next=t,s.next=i,t&&(t.prev=i),i)}}static node(e){let s=e;return s.remove=()=>{s.prev&&(s.prev.next=s.next),s.next&&(s.next.prev=s.prev),s.prev=s.next=void 0},s}};function Ul(e,s,t){let i={above:t.myFill.above,below:t.myFill.below};return{start:e,end:s,myFill:i}}function K0(e,s,t,i,n,r){let o=Sd(s,n);return o!==0?o:p.equals(t,r)?0:e!==i?e?1:-1:jl(t,i?n:r,i?r:n)?1:-1}function Wl(e,s,t){e.insertBefore(s,i=>K0(!!s.isStart,s.pt,t,!!i.isStart,i.pt,i.other.pt)<0)}function X0(e,s,t){let i=xi.node({isStart:!0,pt:s.start,seg:s,primary:t});return Wl(e,i,s.end),i}function Y0(e,s,t,i){let n=xi.node({pt:t.end,seg:t,primary:i,other:s});s.other=n,Wl(e,n,s.pt)}function vr(e,s,t){let i=X0(e,s,t);return Y0(e,i,s,t),i}function Q0(e,s,t){s.other.remove(),s.seg.end=t,s.other.pt=t,Wl(e,s.other,s.pt)}function ke(e,s,t){let i=Ul(t,s.seg.end,s.seg);return Q0(e,s,t),vr(e,i,!!s.primary)}function J0(e,s){let t=e.seg.start,i=e.seg.end,n=s.seg.start,r=s.seg.end;return p.colinear(t,n,r)?p.colinear(i,n,r)||jl(i,n,r)?1:-1:jl(t,n,r)?1:-1}function Fl(e,s,t){let i=s.seg,n=t.seg,r=i.start,o=i.end,a=n.start,l=n.end,h=W0(r,o,a,l);if(h===!1){if(!p.colinear(r,o,a)||p.equals(r,l)||p.equals(o,a))return!1;let d=p.equals(r,a),u=p.equals(o,l);if(d&&u)return t;let f=!d&&wd(r,a,l),v=!u&&wd(o,a,l);if(d)return v?ke(e,t,o):ke(e,s,l),t;f&&(u||(v?ke(e,t,o):ke(e,s,l)),ke(e,t,r))}else h.alongA===0&&(h.alongB===-1?ke(e,s,a):h.alongB===0?ke(e,s,h.pt):h.alongB===1&&ke(e,s,l)),h.alongB===0&&(h.alongA===-1?ke(e,t,r):h.alongA===0?ke(e,t,h.pt):h.alongA===1&&ke(e,t,o));return!1}function Td(e,s){var t,i;let n=new xi,r=[];for(;e.head;){let o=e.head;if(o.isStart){let a=function(){if(h){let f=Fl(e,o,h);if(f)return f}return d?Fl(e,o,d):!1},l=n.findTransition(f=>J0(o,f.ev)>0),h=(t=l.before)==null?void 0:t.ev,d=(i=l.after)==null?void 0:i.ev,u=a();if(u&&(s?(!o.seg.myFill.below||o.seg.myFill.above!==o.seg.myFill.below)&&(u.seg.myFill.above=!u.seg.myFill.above):u.seg.otherFill=o.seg.myFill,o.other.remove(),o.remove()),e.head!==o)continue;if(s){let f=o.seg.myFill.below?o.seg.myFill.above!==o.seg.myFill.below:!0;o.seg.myFill.below=d?d.seg.myFill.above:!1,o.seg.myFill.above=f?!o.seg.myFill.below:o.seg.myFill.below}else if(o.seg.otherFill===void 0){let f=d?o.primary===d.primary?d.seg.otherFill.above:d.seg.myFill.above:!1;o.seg.otherFill={above:f,below:f}}o.other.status=l.insert(xi.node({ev:o}))}else{let a=o.status;if(a===void 0)throw new Error("[Euclid.js] Zero-length segment detected!");if(n.exists(a.prev)&&n.exists(a.next)&&Fl(e,a.prev.ev,a.next.ev),a.remove(),!o.primary){let l=o.seg.myFill;o.seg.myFill=o.seg.otherFill,o.seg.otherFill=l}r.push(o.seg)}e.head.remove()}return r}function tg(e){let s=[],t=[];return e.forEach(i=>{let n=i.start,r=i.end;if(p.equals(n,r))return;let o={index:0,matchesHead:!1,matchesPt1:!1},a={index:0,matchesHead:!1,matchesPt1:!1},l=o;function h(g,y,C){l.index=g,l.matchesHead=y,l.matchesPt1=C;let A=l===o;return l=A?a:void 0,!A}for(let g=0;g<s.length;g++){let y=s[g],C=y[0],A=_(y);if(p.equals(C,n)){if(h(g,!0,!0))break}else if(p.equals(C,r)){if(h(g,!0,!1))break}else if(p.equals(A,n)){if(h(g,!1,!0))break}else if(p.equals(A,r)&&h(g,!1,!1))break}if(l===o){s.push([n,r]);return}if(l===a){let g=o.index,y=o.matchesPt1?r:n,C=o.matchesHead,A=s[g],L=C?A[0]:A[A.length-1],k=C?A[1]:A[A.length-2],rt=C?A[A.length-1]:A[0],_t=C?A[A.length-2]:A[1];if(p.colinear(k,L,y)&&(C?A.shift():A.pop(),L=k),p.equals(rt,y)){s.splice(g,1),p.colinear(_t,rt,L)&&(C?A.pop():A.shift()),t.push(A);return}C?A.unshift(y):A.push(y);return}function d(g){s[g].reverse()}function u(g,y){let C=s[g],A=s[y],L=C[C.length-1],k=C[C.length-2],rt=A[0],_t=A[1];p.colinear(k,L,rt)&&(C.pop(),L=k),p.colinear(L,rt,_t)&&A.shift(),s[g]=C.concat(A),s.splice(y,1)}let f=o.index,v=a.index,w=s[f].length<s[v].length;o.matchesHead?a.matchesHead?w?(d(f),u(f,v)):(d(v),u(v,f)):u(v,f):a.matchesHead?u(f,v):w?(d(f),u(v,f)):(d(v),u(f,v))}),t}function eg(e,s){let t=[];for(let i of e){let n=(i.myFill.above?8:0)+(i.myFill.below?4:0)+(i.otherFill&&i.otherFill.above?2:0)+(i.otherFill&&i.otherFill.below?1:0);s[n]!==0&&t.push({start:i.start,end:i.end,myFill:{above:s[n]===1,below:s[n]===2}})}return t}function bd(e){let s=new xi;for(let t of e)for(let i=0;i<t.length;i++){let n=i?t[i-1]:_(t),r=t[i],o=Sd(n,r);if(o===0)continue;let a=o<0?n:r,l=o<0?r:n;vr(s,{start:a,end:l,myFill:{}},!0)}return Td(s,!0)}function Kl(e,s,t){let i=new xi;for(let r of bd(e))vr(i,Ul(r.start,r.end,r),!0);for(let r of bd(s))vr(i,Ul(r.start,r.end,r),!1);let n=eg(Td(i,!1),t);return tg(n)}var sg=[0,2,1,0,2,2,0,0,1,0,1,0,0,0,0,0],ig=[0,0,0,0,0,2,0,2,0,0,1,1,0,2,1,0],ng=[0,0,0,0,2,0,2,0,1,1,0,0,0,1,2,0];var rg=(e,s)=>Kl(e,s,sg),og=(e,s)=>Kl(e,s,ig),ag=(e,s)=>Kl(e,s,ng);function oe(e){return["polygon","polyline","rectangle","triangle"].includes(e.type)}function Pi(e){return["polygon","triangle"].includes(e.type)}function yr(e){return e.type==="polyline"}function vn(e){return e.type==="rectangle"}function Mt(e){return["line","ray","segment"].includes(e.type)}function Xl(e){return e.type==="line"}function Cd(e){return e.type==="ray"}function Oe(e){return e.type==="segment"}function ct(e){return e.type==="circle"}function lg(e){return e.type==="ellipse"}function ne(e){return e.type==="arc"}function ze(e){return e.type==="sector"}function ae(e){return e.type==="angle"}function yt(e){return e.type==="point"}function hg(e,s){return P(e.p1.x,e.p2.x)?st(s.y,e.p1.y,e.p2.y):st(s.x,e.p1.x,e.p2.x)}function cg(e,s){return P(e.p1.x,e.p2.x)?(s.y-e.p1.y)/(e.p2.y-e.p1.y)>0:(s.x-e.p1.x)/(e.p2.x-e.p1.x)>0}function dg(e,s){return st(e.offset(s),0,1)}function pg(e,s){let t=e.p1.x-e.p2.x,i=e.p1.y-e.p2.y,n=s.p1.x-s.p2.x,r=s.p1.y-s.p2.y,o=t*r-i*n;if(P(o,0))return[];let a=e.p1.x*e.p2.y-e.p1.y*e.p2.x,l=s.p1.x*s.p2.y-s.p1.y*s.p2.x,h=a*n-t*l,d=a*r-i*l;return[new p(h/o,d/o)]}function ug(e,s){let t=p.distance(e.c,s.c);if(t>e.r+s.r)return[];if(t<Math.abs(e.r-s.r))return[];if(P(t,0)&&P(e.r,s.r))return[];if(P(t,e.r+s.r))return[new wt(e.c,s.c).midpoint];let i=(me(e.r)-me(s.r)+me(t))/(2*t),n=Math.sqrt(me(e.r)-me(i)),r=(s.c.x-e.c.x)*i/t+(s.c.y-e.c.y)*n/t+e.c.x,o=(s.c.y-e.c.y)*i/t-(s.c.x-e.c.x)*n/t+e.c.y,a=(s.c.x-e.c.x)*i/t-(s.c.y-e.c.y)*n/t+e.c.x,l=(s.c.y-e.c.y)*i/t+(s.c.x-e.c.x)*n/t+e.c.y;return[new p(r,o),new p(a,l)]}function $d(e,s){let t=e.p2.x-e.p1.x,i=e.p2.y-e.p1.y,n=me(t)+me(i),r=s.c.x,o=s.c.y,a=(e.p1.x-r)*(e.p2.y-o)-(e.p2.x-r)*(e.p1.y-o),l=me(s.r)*n-me(a);if(l<0)return[];let h=a*i/n,d=-a*t/n;if(P(l,0))return[s.c.shift(h,d)];let u=t*(i<0?-1:1)*Math.sqrt(l)/n,f=Math.abs(i)*Math.sqrt(l)/n;return[s.c.shift(h+u,d+f),s.c.shift(h-u,d-f)]}function fg(e,s){let t=[],i=ne(e)?e.circle:e,n=ne(s)?s.circle:s;Mt(e)&&Mt(s)?t=pg(e,s):Mt(i)&&ct(n)?t=$d(i,n):ct(i)&&Mt(n)?t=$d(n,i):ct(i)&&ct(n)&&(t=ug(i,n));for(let r of[e,s])Oe(r)&&(t=t.filter(o=>hg(r,o))),Cd(r)&&(t=t.filter(o=>cg(r,o))),ne(r)&&(t=t.filter(o=>dg(r,o)));return t}function ft(...e){if(e.length<2)return[];if(e.length>2)return Bt(id(e,2).map(i=>ft(...i)));let[s,t]=e;if(ae(s)&&(s=s.shape(!0)),ae(t)&&(t=t.shape(!0)),oe(t)&&([s,t]=[t,s]),oe(s)){let i=Mt(t)?s.points.filter(n=>t.contains(n)):[];for(let n of s.edges)i.push(...ft(n,t));return i}return fg(s,t)}var M=class{constructor(...e){this.type="polygon",this.points=e}get circumference(){if(this.points.length<=1)return 0;let e=p.distance(this.points[0],_(this.points));for(let s=1;s<this.points.length;++s)e+=p.distance(this.points[s-1],this.points[s]);return e}get signedArea(){let e=this.points,s=e.length,t=e[s-1].x*e[0].y-e[0].x*e[s-1].y;for(let i=1;i<s;++i)t+=e[i-1].x*e[i].y-e[i].x*e[i-1].y;return t/2}get area(){return Math.abs(this.signedArea)}get centroid(){let e=this.points,s=e.length,t=0;for(let n=0;n<s;++n)t+=e[n].x;let i=0;for(let n=0;n<s;++n)i+=e[n].y;return new p(t/s,i/s)}get edges(){let e=this.points.length,s=[];for(let t=0;t<e;++t)s.push(new it(this.points[t],this.points[(t+1)%e]));return s}get radius(){let e=this.centroid,s=this.points.map(t=>p.distance(t,e));return Math.max(...s)}get oriented(){if(this.signedArea>=0)return this;let e=[...this.points].reverse();return new this.constructor(...e)}cut(e){let s=this.radius/e.length*10,t=e.at(-s),i=e.at(s),n=e.perpendicularVector.scale(e.length*s),r=[t,i,i.add(n),t.add(n)],o=og([this.points],[r]),a=ag([this.points],[r]);return[...o,...a].map(l=>new M(...l))}static collision(e,s){if(e.points.some(t=>s.contains(t))||s.points.some(t=>e.contains(t)))return!0;for(let t of e.edges)for(let i of s.edges)if(ft(t,i)[0])return!0;return!1}static union(...e){let[s,...t]=e;if(!t.length)return[s];let i=[s.points],n=t.length>1?M.union(...t).map(r=>r.points):[e[1].points];return rg(i,n).map(r=>new M(...r))}static regular(e,s=1){let t=D/e,i=Math.PI/2-t/2,n=B(r=>p.fromPolar(i+t*r,s),e);return new M(...n)}static interpolate(e,s,t=.5){let i=e.points.map((n,r)=>p.interpolate(n,s.points[r],t));return new M(...i)}static convexHull(...e){if(e.length<=3)return new M(...e);let s=e.sort((r,o)=>r.x!==o.x?r.x-o.x:r.y-o.y),t=s.slice(0).reverse(),i=[],n=[];for(let[r,o]of[[s,i],[t,n]]){for(let a of r){for(;o.length>=2;){let l=o[o.length-1],h=o[o.length-2];if((l.x-h.x)*(a.y-h.y)>=(a.x-h.x)*(l.y-h.y))o.pop();else break}o.push(a)}o.pop()}return new M(...i.concat(n))}contains(e){let s=!1;for(let t of this.edges){if(t.p1.equals(e)||t.contains(e))return!1;if(t.p1.y>e.y==t.p2.y>e.y)continue;let i=(t.p2.x-t.p1.x)/(t.p2.y-t.p1.y);e.x<i*(e.y-t.p1.y)+t.p1.x&&(s=!s)}return s}at(e){e<0&&(e+=Math.floor(e));let s=e*this.circumference,t=0;for(let i of this.edges){let n=i.length;if(t+n>s)return i.at((s-t)/n);t+=n}return this.points[0]}offset(e){let s=this.edges,t=vd(e,this.edges)||[this.points[0],0],i=0;for(let n=0;n<t[1];++n)i+=s[n].length;return i+=s[t[1]].offset(e)*s[t[1]].length,i/this.circumference}project(e){let s=vd(e,this.edges);return s?s[0]:this.points[0]}centerAt(e=$){return this.translate(e.subtract(this.centroid))}transform(e){return new this.constructor(...this.points.map(s=>s.transform(e)))}rotate(e,s=$){if(P(e,0))return this;let t=this.points.map(i=>i.rotate(e,s));return new this.constructor(...t)}reflect(e){let s=this.points.map(t=>t.reflect(e));return new this.constructor(...s)}scale(e,s=e){let t=this.points.map(i=>i.scale(e,s));return new this.constructor(...t)}shift(e,s=e){let t=this.points.map(i=>i.shift(e,s));return new this.constructor(...t)}translate(e){return this.shift(e.x,e.y)}equals(e,s,t){let i=this.points.length;if(i!==e.points.length)return!1;let n=t?this:this.oriented,r=t?e:e.oriented;for(let o=0;o<i;++o)if(n.points.every((a,l)=>a.equals(r.points[(l+o)%i],s)))return!0;return!1}toString(){return`polygon(${this.points.join(",")})`}},le=class extends M{constructor(){super(...arguments),this.type="polyline"}get circumference(){return this.length}get length(){let e=0;for(let s=1;s<this.points.length;++s)e+=p.distance(this.points[s-1],this.points[s]);return e}get edges(){let e=[];for(let s=0;s<this.points.length-1;++s)e.push(new it(this.points[s],this.points[s+1]));return e}toString(){return`polyline(${this.points.join(",")})`}},wn=class extends M{constructor(){super(...arguments),this.type="triangle"}get circumcircle(){let[e,s,t]=this.points,i=2*(e.x*(s.y-t.y)+s.x*(t.y-e.y)+t.x*(e.y-s.y)),n=(e.x**2+e.y**2)*(s.y-t.y)+(s.x**2+s.y**2)*(t.y-e.y)+(t.x**2+t.y**2)*(e.y-s.y),r=(e.x**2+e.y**2)*(t.x-s.x)+(s.x**2+s.y**2)*(e.x-t.x)+(t.x**2+t.y**2)*(s.x-e.x),o=new p(n/i,r/i),a=p.distance(o,this.points[0]);if(!(isNaN(a)||a>Number.MAX_SAFE_INTEGER))return new H(o,a)}get incircle(){let e=this.edges,s=e.map(d=>d.length),t=s[0]+s[1]+s[2],[i,n,r]=this.points,o=s[1]*i.x+s[2]*n.x+s[0]*r.x,a=s[1]*i.y+s[2]*n.y+s[0]*r.y,l=new p(o/t,a/t),h=l.distanceFromLine(e[0]);return isNaN(h)?void 0:new H(l,h)}get orthocenter(){let[e,s,t]=this.points,i=new wt(e,s).perpendicular(t),n=new wt(e,t).perpendicular(s);return ft(i,n)[0]}},mg=180/Math.PI,gg=Math.PI/180;function It(e){return e*mg}function U(e){return e*gg}var Vt=class{constructor(e,s,t){this.a=e,this.b=s,this.c=t,this.type="angle"}static fromDegrees(e){return Vt.fromRadians(e*(Math.PI/180))}static fromRadians(e){let s=new p(1,0),t=s.rotate(e);return new Vt(s,$,t)}static equals(e,s,t=Math.PI/360){return P(e.rad,s.rad,t)}get rad(){let e=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),t=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x)-e;return t<0&&(t+=D),t}get deg(){return this.rad*180/Math.PI}get isRight(){return P(this.rad,Math.PI/2,Math.PI/360)}get bisector(){if(this.b.equals(this.a)||this.b.equals(this.c))return;let e=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),s=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x),t=(e+s)/2;e>s&&(t+=Math.PI);let i=Math.cos(t)+this.b.x,n=Math.sin(t)+this.b.y;return new wt(this.b,new p(i,n))}get sup(){return this.rad<Math.PI?this:new Vt(this.c,this.b,this.a)}get arc(){return new re(this.b,this.a,this.rad)}get radius(){return 24+20*(1-S(this.rad,0,Math.PI)/Math.PI)}shape(e=!0,s,t){if(this.a.equals(this.b)||this.c.equals(this.b))return new M($);let i=this.isRight&&!t;s||(s=i?20:this.radius);let n=new it(this.b,this.a),r=n.at(s/n.length);if(i){let o=p.difference(this.c,this.b).unitVector.scale(s);return e?new M(this.b,r,r.add(o),this.b.add(o)):new le(r,r.add(o),this.b.add(o))}return e?new qe(this.b,r,this.rad):new re(this.b,r,this.rad)}project(e){return this.contains(e)?e:this.shape(!0).project(e)}at(){return this.c}offset(){return 0}contains(e){return this.shape(!0).contains(e)}transform(e){return new Vt(this.a.transform(e),this.b.transform(e),this.c.transform(e))}rotate(e,s){return P(e,0)?this:new Vt(this.a.rotate(e,s),this.b.rotate(e,s),this.c.rotate(e,s))}reflect(e){return new Vt(this.a.reflect(e),this.b.reflect(e),this.c.reflect(e))}scale(e,s=e){return new Vt(this.a.scale(e,s),this.b.scale(e,s),this.c.scale(e,s))}shift(e,s=e){return new Vt(this.a.shift(e,s),this.b.shift(e,s),this.c.shift(e,s))}translate(e){return new Vt(this.a.translate(e),this.b.translate(e),this.c.translate(e))}equals(e,s){return Vt.equals(e,this,s)}toString(){return`angle(${this.a},${this.b},${this.c})`}},x=class{constructor(e,s=1,t=s){this.p=e,this.w=s,this.h=t,this.type="rectangle"}static aroundPoints(e){let s=1/0,t=-1/0,i=1/0,n=-1/0;for(let r of e)s=s<r.x?s:r.x,t=t>r.x?t:r.x,i=i<r.y?i:r.y,n=n>r.y?n:r.y;return new x(new p(s,i),t-s,n-i)}get center(){return new p(this.p.x+this.w/2,this.p.y+this.h/2)}get centroid(){return this.center}get circumference(){return 2*Math.abs(this.w)+2*Math.abs(this.h)}get area(){return Math.abs(this.w*this.h)}get edges(){return this.polygon.edges}get points(){return this.polygon.points}get polygon(){let e=new p(this.p.x+this.w,this.p.y),s=new p(this.p.x+this.w,this.p.y+this.h),t=new p(this.p.x,this.p.y+this.h);return new M(this.p,e,s,t)}collision(e){return this.p.x<e.p.x+e.w&&this.p.x+this.w>e.p.x&&this.p.y<e.p.y+e.h&&this.p.y+this.h>e.p.y}padding(e,s,t,i){return new x(this.p.shift(-i,-e),this.w+i+s,this.h+e+t)}contains(e,s){return st(e.x,this.p.x,this.p.x+this.w,s)&&st(e.y,this.p.y,this.p.y+this.h,s)}project(e){let s;for(let t of this.edges){let i=t.project(e);(!s||p.distance(e,i)<p.distance(e,s))&&(s=i)}return s}at(e){return this.polygon.at(e)}offset(e){return this.polygon.offset(e)}transform(e){return this.polygon.transform(e)}rotate(e,s=$){return P(e,0)?this:this.polygon.rotate(e,s)}reflect(e){return this.polygon.reflect(e)}scale(e,s=e){return new x(this.p.scale(e,s),this.w*e,this.h*s)}shift(e,s=e){return new x(this.p.shift(e,s),this.w,this.h)}translate(e){return this.shift(e.x,e.y)}equals(e){return!1}toString(){return`rectangle(${this.p},${this.w},${this.h})`}},kt=class{constructor(e,s,t,i){this.xMin=e,this.xMax=s,this.yMin=t,this.yMax=i}contains(e){return this.containsX(e)&&this.containsY(e)}containsX(e){return st(e.x,this.xMin,this.xMax)}containsY(e){return st(e.y,this.yMin,this.yMax)}resize(e,s){return new kt(this.xMin,this.xMax+e,this.yMin,this.yMax+s)}get dx(){return this.xMax-this.xMin}get dy(){return this.yMax-this.yMin}get xRange(){return[this.xMin,this.xMax]}get yRange(){return[this.yMin,this.yMax]}get rect(){return new x(new p(this.xMin,this.yMin),this.dx,this.dy)}get center(){return new p(this.xMin+this.dx/2,this.yMin+this.dy/2)}get flip(){return new kt(this.yMin,this.yMax,this.xMin,this.xMax)}};function Yl(e,s,t={}){if(ae(s))return Yl(e,s.shape(!!t.fill),t);if(t.fill&&(e.fillStyle=t.fill),t.opacity&&(e.globalAlpha=t.opacity),t.stroke&&(e.strokeStyle=t.stroke,e.lineWidth=t.strokeWidth||1,t.lineCap&&(e.lineCap=t.lineCap),t.lineJoin&&(e.lineJoin=t.lineJoin)),e.beginPath(),Oe(s))e.moveTo(s.p1.x,s.p1.y),e.lineTo(s.p2.x,s.p2.y);else if(ct(s))e.arc(s.c.x,s.c.y,s.r,0,D);else if(oe(s)){let i=s.points;e.moveTo(i[0].x,i[0].y);for(let n of i.slice(1))e.lineTo(n.x,n.y);e.closePath()}else if(yr(s)){e.moveTo(s.points[0].x,s.points[0].y);for(let i of s.points.slice(1))e.lineTo(i.x,i.y)}else lg(s)&&e.ellipse(s.c.x,s.c.y,s.a,s.b,s.angle,0,D);t.fill&&e.fill(),t.stroke&&e.stroke()}function xd(e,s,t){let n=s.x*(t.y-e.y)+e.x*(s.y-t.y)+t.x*(e.y-s.y)>0?1:0,r=p.distance(s,e);return[e.x,`${e.y}A${r}`,r,0,n,1,t.x,t.y].join(",")}function ge(...e){return`M${e.map(s=>`${s.x},${s.y}`).join("L")}`}function Pd(e,s){let t=e.perpendicularVector.scale(6),i=e.unitVector.scale(3),n=e.midpoint;switch(s){case"bar":return ge(n.add(t),n.add(t.inverse));case"bar2":return ge(n.add(i).add(t),n.add(i).add(t.inverse))+ge(n.add(i.inverse).add(t),n.add(i.inverse).add(t.inverse));case"arrow":return ge(n.add(i.inverse).add(t),n.add(i),n.add(i.inverse).add(t.inverse));case"arrow2":return ge(n.add(i.scale(-2)).add(t),n,n.add(i.scale(-2)).add(t.inverse))+ge(n.add(t),n.add(i.scale(2)),n.add(t.inverse));default:return""}}function wr(e,s){if(!e||!s)return"";let t=s.perpendicular,i=e.add(s.scale(9)).add(t.scale(9)),n=e.add(s.scale(9)).add(t.scale(-9));return ge(i,e,n)}function vg(e,s){let t="";return Y(s,"start","both")&&(t+=wr(e.p1,e.unitVector)),Y(s,"end","both")&&(t+=wr(e.p2,e.unitVector.inverse)),t}function wg(e,s){let t="";if(Y(s,"start","both")){let i=new wt(e.c,e.start).perpendicularVector.inverse;t+=wr(e.start,i)}if(Y(s,"end","both")){let i=new wt(e.c,e.end).perpendicularVector;t+=wr(e.end,i)}return t}function jt(e,s={}){if(ae(e)){let t=e.shape(!!s.fill,s.size,s.round);return jt(t,s)}if(Oe(e)){if(e.p1.equals(e.p2))return"";let t=ge(e.p1,e.p2);return s.mark&&(t+=Pd(e,s.mark)),s.arrows&&(t+=vg(e,s.arrows)),t}if(Cd(e)){if(!s.box)return"";let t=ft(e,s.box)[0];return t?ge(e.p1,t):""}if(Xl(e)){if(!s.box)return"";let t=ft(e,s.box);if(t.length<2)return"";let i=ge(t[0],t[1]);return s.mark&&(i+=Pd(e,s.mark)),i}if(ct(e))return`M ${e.c.x-e.r} ${e.c.y} a ${e.r},${e.r} 0 1 0 ${2*e.r} 0 a ${e.r} ${e.r} 0 1 0 ${-2*e.r} 0`;if(ne(e)){let t=`M${xd(e.start,e.c,e.end)}`;return s.arrows&&(t+=wg(e,s.arrows)),t}return ze(e)?`M ${e.c.x} ${e.c.y} L ${xd(e.start,e.c,e.end)} Z`:yr(e)?ge(...e.points):Pi(e)?`${ge(...e.points)}Z`:vn(e)?`${ge(...e.polygon.points)}Z`:""}var Le=(e,s,t)=>new Promise((i,n)=>{var r=l=>{try{a(t.next(l))}catch(h){n(h)}},o=l=>{try{a(t.throw(l))}catch(h){n(h)}},a=l=>l.done?i(l.value):Promise.resolve(l.value).then(r,o);a((t=t.apply(e,s)).next())});function yg(e){let s=[];for(let t of Object.keys(e)){let i=e[t];if(t=encodeURIComponent(t),i==null){s.push(t);continue}i=Array.isArray(i)?i.join(","):`${i}`,i=i.replace(/(\r)?\n/g,`\r
`),i=encodeURIComponent(i),i=i.replace(/%20/g,"+"),s.push(`${t}=${i}`)}return s.join("&")}function nh(e){e=e.replace(/^[?,&]/,"");let s=decodeURIComponent(e).split("&"),t={};return s.forEach(i=>{let n=i.split("=");t[n[0]]=n[1]}),t}function ls(e,s){return Le(this,null,function*(){let t=s instanceof FormData,i={method:"POST",body:t?s:s?yg(s):void 0,headers:{"X-CSRF-Token":window.csrfToken||""}};t||(i.headers["Content-Type"]="application/x-www-form-urlencoded");let n=e.includes("?")?"&xhr=1":"?xhr=1",r=yield fetch(e+n,i);if(!r.ok)throw new Error(`Fetch error ${r.status}: ${e}`);return r.text()})}function Sr(e,s=!1){return new Promise(t=>{let i=new Image;s||(i.crossOrigin="Anonymous"),i.onload=()=>t(i),i.src=e})}var bn=new Map;function Id(e,s){bn.has(e)?Nl(bn.get(e),s,(t,i)=>Ht(t.concat(i))):bn.set(e,s)}function Nd(){if(!!window.navigator.onLine)for(let[e,s]of bn)bn.delete(e),ls(e,{data:JSON.stringify(s)}).catch(t=>{console.error("Failed to send POST request:",t),Id(e,s)})}var Gd=_e(Nd,5e3);window.addEventListener("online",Gd);window.onbeforeunload=Nd;function Dd(e,s){Id(e,s),Gd()}var Pe=class{constructor(e,s=1,t=!0){this.src=e,this.defaultVolume=s,this.player=new Audio,this.player.src=e,t&&(this.player.preload="auto")}play(e){this.player.currentTime=0,this.player.volume=e||this.defaultVolume,this.player.play()}},_d={"===":(e,s)=>e===s,"!==":(e,s)=>e!==s,"||":(e,s)=>e||s,"&&":(e,s)=>e&&s,"==":(e,s)=>e==s,"!=":(e,s)=>e!=s,"<=":(e,s)=>e<=s,">=":(e,s)=>e>=s,"**":(e,s)=>e**s,"<":(e,s)=>e<s,">":(e,s)=>e>s,"+":(e,s)=>e+s,"-":(e,s)=>e-s,"*":(e,s)=>e*s,"/":(e,s)=>e/s,"%":(e,s)=>e%s},Hd={"-":e=>-e,"+":e=>+e,"!":e=>!e},Md={"||":1,"&&":2,"==":3,"!=":3,"===":3,"!==":3,"<":4,">":4,"<=":4,">=":4,"+":5,"-":5,"*":6,"/":6,"%":6,"**":7},Ed={true:!0,false:!1,undefined:void 0},bg=/\s/,Ql=/[0-9]/,Jl=/[a-zA-Zα-ωΑ-Ω$_]/,$g=/[0-9a-zA-Zα-ωΑ-Ω$_]/;function xg(e){let s=e.length,t=0;function i(g){throw new Error(`${g} at character ${t} of "${e}"`)}function n(){for(;bg.test(e[t]);)t+=1}function r(){let g="";for(;Ql.test(e[t]);)g+=e[t++];if(e[t]===".")for(g+=e[t++];Ql.test(e[t]);)g+=e[t++];let y=e[t];if(y&&Jl.test(y)){let C=g+e[t];i(`Variable names cannot start with a number (${C})`)}else y==="."&&i("Unexpected period");return{type:5,value:parseFloat(g)}}function o(){let g=e[t];t+=1;let y=!1,C="";for(;t<s;){let A=e[t++];if(A===g){y=!0;break}C+=A}return y||i(`Unclosed quote after "${C}"`),{type:5,value:C}}function a(){let g=e[t];for(Jl.test(e[t])||i(`Unexpected ${g}`),t+=1;t<s&&$g.test(e[t]);)g+=e[t++];return g in Ed?{type:5,value:Ed[g]}:{type:4,name:g}}function l(g){let y=[],C=!1,A;for(;t<s;)if(e[t]===g){A&&y.push(A),C=!0,t+=1;break}else e[t]===","?(y.push(A||{type:5,value:void 0}),t+=1):A=v();return C||i(`Expected ${g}`),y}function h(){let g;if(e[t]==="("){if(t+=1,g=v(),n(),e[t]===")")return t+=1,g;i("Unclosed (")}else g=a();for(n();".[(".includes(e[t]);)e[t]==="."?(t++,n(),g={type:6,object:g,computed:!1,property:a()}):e[t]==="["?(t++,g={type:6,object:g,computed:!0,property:v()},n(),e[t]!=="]"&&i("Unclosed ["),t++):e[t]==="("&&(t++,g={type:2,args:l(")"),callee:g}),n();return g}function d(){n();for(let g of[3,2,1]){let y=e.substr(t,g);if(y in _d)return t+=g,y}}function u(){n();let g=e[t];if(Ql.test(g)||g===".")return r();if(g==="'"||g==='"')return o();if(g==="[")return t+=1,{type:0,elements:l("]")};if(g in Hd)return t+=1,{type:7,operator:g,argument:u()};if(Jl.test(g)||g==="(")return h();i("Expression parsing error")}function f(){let g=u(),y=d();if(!y)return g;let C=u();C||i(`Expected expression after ${y}`);let A,L=[g,y,C];for(;y=d();){let rt=Md[y],_t=y;for(;L.length>2&&rt<=Md[L[L.length-2]];)C=L.pop(),y=L.pop(),g=L.pop(),A={type:1,operator:y,left:g,right:C},L.push(A);A=u(),A||i(`Expected expression after ${_t}`),L.push(_t,A)}let k=L.length-1;for(A=L[k];k>1;)A={type:1,operator:L[k-1],left:L[k-2],right:A},k-=2;return A}function v(){let g=f();if(n(),g&&e[t]==="?"){t+=1;let y=v();if(y||i("Expected expression"),n(),e[t]===":"){t++;let C=v();return C||i("Expected expression"),{type:3,test:g,consequent:y,alternate:C}}else i("Expected :")}else return g}let w=v();return t<e.length&&i(`Unexpected "${e[t]}"`),w}var br=[void 0,void 0];function xe(e,s,t){switch(e.type){case 0:let i=e.elements.map(w=>xe(w,s,t)[0]);return i.some(w=>w===void 0)?br:[i,void 0];case 1:let n=xe(e.left,s,t)[0],r=xe(e.right,s,t)[0];return"+-**/%".includes(e.operator)&&(n===void 0||r===void 0)?br:[_d[e.operator](n,r),void 0];case 2:let[o,a]=xe(e.callee,s,t),l=e.args.map(w=>xe(w,s,t)[0]);return l.some(w=>w===void 0)||typeof o!="function"?br:[o.apply(a,l),void 0];case 3:let h=xe(e.consequent,s,t),d=xe(e.alternate,s,t);return xe(e.test,s,t)[0]?h:d;case 4:return[t[e.name]||s[e.name],void 0];case 5:return[e.value,void 0];case 6:let u=xe(e.object,s,t)[0],f=e.computed?xe(e.property,s,t)[0]:e.property.name;return u?[u[f],u]:[void 0,void 0];case 7:let v=xe(e.argument,s,t)[0];return v===void 0&&e.operator!=="!"?br:[Hd[e.operator](v),void 0]}}function Pt(e){let s=xg(e);return s?(t={},i={})=>xe(s,t,i)[0]:(t={})=>{}}var Pg=/\${([^}]+)}/g;function Tr(e){let s=e.split(Pg),t=s.map((i,n)=>n%2?Pt(i.replace(/×/g,"*")):void 0);return i=>s.map((n,r)=>{if(!(r%2))return n;let o=t[r](i);return typeof o=="number"&&o<0?`\u2013${-o}`:o}).join("")}var yn="ontouchstart"in window,Ti="onpointerdown"in window;function Qt(e){if(e.touches){let s=e.targetTouches.length?e.targetTouches:e.changedTouches;return new p(s[0].clientX,s[0].clientY)}else return new p(e.clientX||0,e.clientY||0)}function Sg(e){return e.touches||[]}function Se(e,s){return Qt(e).transform(s.inverseTransformMatrix)}function Bd(e,s){let t=Qt(e),i=s.bounds,n=(t.x-i.left)*s.canvasWidth/i.width,r=(t.y-i.top)*s.canvasHeight/i.height;return new p(n,r)}function Tg(e){if(e instanceof PointerEvent&&e.pointerType==="mouse")return G(e.target);let s=Qt(e);return G(document.elementFromPoint(s.x,s.y)||void 0)}function Cg(e){if(e._data.tapEvent)return;e._data.tapEvent=!0;let s;e.on("pointerdown",t=>s=Qt(t)),e.on("pointerup",t=>{if(!s)return;let i=Qt(t);p.distance(s,i)<6&&e.trigger("tap",t),s=void 0}),e.on("pointercancel",()=>s=void 0)}function Mg(e){e._data.clickOutsideEvent||(e._data.clickOutsideEvent=!0,Z.on("pointerdown",s=>{var t,i;let n=s.target,r=(i=(t=e._el).getRootNode)==null?void 0:i.call(t),o=Qt(s);r!=null&&r.host&&(n=r.elementFromPoint(o.x,o.y)),!(!n||e._el===n||e._el.contains(n))&&e.trigger("clickOutside",s)}))}function Fs(e,s){let t=s.$box||e,i=Qt;t.type==="svg"?i=f=>Se(f,t.$ownerSVG):t.type==="canvas"&&(i=f=>Bd(f,t));let n=s.justInside?e:Z,r,o,a=!1,l=0;e.css("touch-action")==="auto"&&e.css("touch-action","none"),e.addClass("noselect");function h(f){f.handled||Sg(f).length>1||(f.preventDefault(),a=!1,l=f.pointerId||0,n.on("pointermove",d),n.on("pointerstop",u),r=o=i(f),s.down&&s.down(r))}function d(f){if(!r||l&&f.pointerId!==l)return;f.preventDefault();let v=i(f);p.distance(v,o)<.5||(!a&&s.start&&s.start(r),s.move&&s.move(v,r,o),o=v,a=!0)}function u(f,v=!1){!r||l&&f.pointerId!==l||(f.preventDefault(),n.off("pointermove",d),n.off("pointerstop",u),s.up&&s.up(o,r),a&&s.end&&s.end(o,r),!a&&s.click&&!v&&s.click(r),r=void 0)}b.onKey("escape",()=>{if(!r)return;a&&s.move&&s.move(r,r,o),o=r;let f=document.createEvent("MouseEvent");f.pointerId=l,u(f,!0)}),e.on("pointerdown",h),s.justInside&&e.on("mouseleave",u),s.accessible&&(e.setAttr("tabindex","0"),document.addEventListener("keydown",f=>{if(![37,38,39,40].includes(f.keyCode)||e!==b.getActiveInput())return;let v=e.boxCenter,w=i({clientX:v.x,clientY:v.y}),g=f.keyCode===37?-25:f.keyCode===39?25:0,y=f.keyCode===38?-25:f.keyCode===40?25:0,C=w.shift(g,y);s.down&&s.down(w),s.start&&s.start(w),s.move&&s.move(C,w,w),s.end&&s.end(C,w)}))}function qd(e,s){let t=Qt;e.type==="svg"?t=n=>Se(n,e.$ownerSVG):e.type==="canvas"&&(t=n=>Bd(n,e));let i=!1;e.on("touchstart mouseenter",n=>{!i&&s.enter&&s.enter(),s.move&&s.move(t(n)),i=!0},{passive:!0}),e.on("pointermove",n=>{i&&s.move&&s.move(t(n))}),e.on("touchend mouseleave",()=>{i&&s.exit&&s.exit(),i=!1},{passive:!0})}function Eg(e){if(e._data.scrollEvents)return;e._data.scrollEvents=!0;let s=!1,t;function i(){let l=e.scrollTop;if(l===t){s=!1;return}t=l,e.trigger("scroll",{top:t}),window.requestAnimationFrame(i)}function n(){s||window.requestAnimationFrame(i),s=!0}(e.type==="window"?window:e._el).addEventListener("scroll",n);function o(){window.addEventListener("touchmove",n),window.addEventListener("touchend",a)}function a(){window.removeEventListener("touchmove",n),window.removeEventListener("touchend",a)}e._el.addEventListener("touchstart",function(l){l.handled||o()})}function Ci(e,s){let t=s.$clickTarget||e,i=0,n=!1,r=!1,o=!1;function a(){n||(s.enter&&s.enter(),n=!0)}function l(){!n||(clearTimeout(i),s.exit&&s.exit(),n=!1)}e.on("mouseover",()=>{s.preventMouseover&&s.preventMouseover()||(clearTimeout(i),i=Ae(()=>{a(),r=!0},s.delay))}),e.on("mouseout",()=>{!r||(clearTimeout(i),i=Ae(l,s.exitDelay||s.delay))}),t.on("focus",()=>{n||s.preventMouseover&&s.preventMouseover()||(clearTimeout(i),a(),o=!0)});let h=()=>{!o||(s.canFocusWithin?setTimeout(()=>{let d=b.getActiveInput();d&&d.hasParent(e)?d.one("blur",h):l()}):l())};t.on("blur",h),t.on("click",()=>{n&&!r?l():n||(a(),r=!1)}),e.on("clickOutside",l)}var th;function Ag(e){for(let s of e){let t=s.isIntersecting?"enterViewport":"exitViewport";setTimeout(()=>G(s.target).trigger(t))}}function Ad(e){if(!e._data.intersectionEvents){if(e._data.intersectionEvents=!0,!window.IntersectionObserver){let s=!1;Z.on("scroll",()=>{let t=e.isInViewport;s&&!t?(e.trigger("exitViewport"),s=!1):t&&!s&&(e.trigger("enterViewport"),s=!0)});return}th||(th=new IntersectionObserver(Ag)),th.observe(e._el)}}function Vg(e,s=!1){if(s&&(e._data.resizeObserver&&e._data.resizeObserver.disconnect(),e._data.resizeObserver=void 0),!e._data.resizeObserver){if(window.ResizeObserver){let t=new window.ResizeObserver(()=>e.trigger("resize"));t.observe(e._el),e._data.resizeObserver=t}else if(window.MutationObserver){let t=new MutationObserver(()=>e.trigger("resize"));t.observe(e._el,{attributes:!0,childList:!0,characterData:!0,subtree:!0}),e._data.resizeObserver=t}}}function Vd(e){if(e._data.pointerPositionEvents)return;e._data.pointerPositionEvents=!0;let s=e.parent,t;s.on("pointerend",()=>t=void 0),s.on("pointermove",i=>{let n=t,r=Tg(i);t=r.equals(e)||r.hasParent(e),n!==void 0&&t&&!n&&e.trigger("pointerenter",i),!t&&n&&e.trigger("pointerleave",i)})}function eh(e,s){s._data[`_${e}`]||(s._data[`_${e}`]=!0,Ti?s.on(e.replace("mouse","pointer"),t=>{t.pointerType==="mouse"&&s.trigger(e,t)}):yn||s._el.addEventListener(e,t=>s.trigger(e,t)))}function kg(e){e.on("keydown",s=>{if(s.metaKey||s.ctrlKey||b.isAndroid&&s.keyCode===229)return;let t=s.key||String.fromCharCode(s.which),i=t.toLowerCase(),n=!!s.shiftKey;e.trigger("key",{code:s.keyCode,key:i,char:t,shift:n})}),b.isAndroid&&e.type==="input"&&e.on("input",s=>{let t=s.data[s.data.length-1],i=t.toLowerCase();e.trigger("key",{code:void 0,key:i,char:t}),e.value=""})}var Cr={scrollwheel:"DOMMouseScroll mousewheel",pointerdown:Ti?"pointerdown":yn?"touchstart":"mousedown",pointermove:Ti?"pointermove":yn?"touchmove":"mousemove",pointerup:Ti?"pointerup":yn?"touchend":"mouseup",pointercancel:Ti?"pointercancel":"touchcancel",pointerstop:Ti?"pointerup pointercancel":yn?"touchend touchcancel":"mouseup"},Mr={scroll:Eg,tap:Cg,clickOutside:Mg,key:kg,mousedown:eh.bind(void 0,"mousedown"),mousemove:eh.bind(void 0,"mousemove"),mouseup:eh.bind(void 0,"mouseup"),pointerenter:Vd,pointerleave:Vd,enterViewport:Ad,exitViewport:Ad,resize:Vg};function Og(e,s,t,i){if(s in Mr)Mr[s](e,!1);else if(s in Cr){let n=lt(Cr[s]);for(let r of n)e._el.addEventListener(r,t,i)}else e._el.addEventListener(s,t,i)}function Lg(e,s,t){if(s in Mr)(!e._events[s]||!e._events[s].length)&&Mr[s](e,!0);else if(t&&s in Cr){let i=lt(Cr[s]);for(let n of i)e._el.removeEventListener(n,t)}else t&&e._el.removeEventListener(s,t)}var Pr=0,ih=new Map;function kd(e,s){ih.set(e,s)}function Rg(e){if(Pr++,e(),Pr--,Pr===0){for(let[s,t]of ih.entries())s(t);ih.clear()}}function mt(e,s){let t=new Map,i=new Map,n=new Set,r,o=0;function a(L){r=L;let k=L(A,!0);return r=void 0,k}function l(L){for(let k of t.values())k.has(L)&&k.delete(L);n.delete(L)}function h(L,k){return n.add(L),k?void 0:L(A,!0)}function d(L,k){i.has(L)&&l(i.get(L));let rt=()=>{e[L]=k(A),r===rt&&(r=void 0),u(L)};i.set(L,rt),a(rt)}function u(L){if(Pr>0){for(let k of t.get(L)||[])kd(k,e);for(let k of n)kd(k,e)}else{for(let k of t.get(L)||[])k(e);for(let k of n)k(e)}}function f(){for(let L of t.values())for(let k of L)k(e);for(let L of n)L(e)}function v(L,k){k&&(e={}),Rg(()=>{for(let[rt,_t]of Object.entries(L))A[rt]=_t})}function w(){for(o+=1;`_x${o}`in e;)o+=1;return`_x${o}`}function g(){e={},t.clear(),i.clear(),o=0}function y(){return Object.assign({},e)}function C(L){!s||s.watch(()=>A[L]=s[L])}let A=new Proxy(e,{get(L,k){return k==="watch"?a:k==="unwatch"?l:k==="watchAll"?h:k==="setComputed"?d:k==="forceUpdate"?f:k==="assign"?v:k==="getKey"?w:k==="clear"?g:k==="copy"?y:k==="_internal"?[e,t]:(r&&(t.has(k)||t.set(k,new Set),t.get(k).add(r)),k in e||C(k),e[k])},set(L,k,rt){return e[k]===rt||(e[k]=rt,i.has(k)&&(l(i.get(k)),i.delete(k)),u(k)),!0},deleteProperty(L,k){return delete e[k],t.delete(k),i.delete(k),!0}});return A}var Ig={A:7,C:6,H:1,L:2,M:2,Q:4,S:4,T:2,V:1,Z:0},Ng=/[astvzqmhlc]([^astvzqmhlc]*)/ig,Gg=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function Er(e){let s=[],t;for(let i of e.match(Ng)||[]){let n=i[0].toUpperCase();if(n==="Z"){s.push({type:"Z",points:[]});continue}let r=(i.slice(1).match(Gg)||[]).map(a=>+a),o=n===i[0];for(let[a,l]of gi(r,Ig[n]).entries()){let h=[],d=n==="M"&&a>0?"L":n,u;n==="H"?(d="L",h=[new p(l[0],o&&(t==null?void 0:t.y)||0)]):n==="V"?(d="L",h=[new p(o&&(t==null?void 0:t.x)||0,l[0])]):n==="A"?(d="A",h=[new p(l[5],l[6])],u=l.slice(0,5)):"MLCSQT".includes(n)&&(h=gi(l,2).map(f=>new p(f[0],f[1]))),!o&&t&&(h=h.map(f=>f.translate(t))),t=_(h),s.push({type:d,points:h,options:u})}}return s}function js(e){return e?Er(e).map(t=>_(t.points)).filter(t=>!!t):[]}var Dg=["font-family","font-size","font-style","font-weight","letter-spacing","text-decoration","color","display","visibility","alignment-baseline","baseline-shift","opacity","text-anchor","clip","clip-path","clip-rule","mask","filter","transform","transform-origin","white-space","line-height"],_g=["fill","fill-rule","marker","marker-start","marker-mid","marker-end","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-width","text-rendering","dominant-baseline","transform-box","paint-order"],Hg=["padding","min-width","max-width","height","border-width","border-style","border-color","box-sizing","background","width","grid-template-columns","text-align"],Bg=["class","tabindex","contenteditable"],qg=new Set(["opacity","transform-box","transform-origin","border-width","border-style","border-color"]),zg={"font-style":"normal","font-weight":"400","letter-spacing":"normal","text-decoration":"none",display:"block",visibility:"visible","alignment-baseline":"auto","baseline-shift":"0px","text-anchor":"start",clip:"auto","clip-path":"none","clip-rule":"nonzero",mask:"none",opacity:"1",filter:"none",fill:"rgb(0, 0, 0)","fill-rule":"nonzero",marker:"none",stroke:"none","stroke-dasharray":"none","stroke-dashoffset":"0px","stroke-linecap":"butt","stroke-linejoin":"miter","stroke-width":"1px","text-rendering":"auto",transform:"none","dominant-baseline":"auto","transform-origin":"0px 0px","transform-box":"view-box","paint-order":"normal"};function zd(e){var s,t;if(e.getAttribute("hidden")||e.style.opacity==="0"||e.style.display==="none")(s=e.parentNode)==null||s.removeChild(e);else{for(let i of Array.from(e.children))zd(i);if(e.tagName==="g"&&e.childElementCount===0)(t=e.parentNode)==null||t.removeChild(e);else for(let i of Bg)e.hasAttribute(i)&&e.removeAttribute(i)}}function Fg(e,s){let t=e.parentElement;for(;t;){let i=t.style.getPropertyValue(s);if(i)return i;t=t.parentElement}}function Fd(e,s,t=!1){let i=window.getComputedStyle(e);s.removeAttribute("style");let n=t||e.tagName==="foreignObject",r=[...Dg,...n?Hg:_g];for(let l of r){let h=i.getPropertyValue(l),d=Fg(s,l);h===zg[l]&&!d||!qg.has(l)&&h===d||s.style.setProperty(l,h)}let o=e.children,a=s.children;for(let l=0;l<a.length;++l)Fd(o[l],a[l],n)}var jd=class{constructor(e){this._el=e,this._data={},this._events={},this.type="default",e._view=this}get id(){return this._el.id}get data(){return this._el.dataset}get tagName(){return this._el.tagName.toUpperCase()}equals(e){return this._el===e._el}addClass(e){for(let s of lt(e))this._el.classList.add(s)}removeClass(e){for(let s of lt(e))this._el.classList.remove(s)}hasClass(e){return this._el.classList.contains(e)}toggleClass(e){return this._el.classList.toggle(e)}setClass(e,s){s?this.addClass(e):this.removeClass(e)}attr(e){return this._el.getAttribute(e)||""}hasAttr(e){return this._el.hasAttribute(e)}setAttr(e,s){s===void 0?this.removeAttr(e):this._el.setAttribute(e,s.toString())}removeAttr(e){this._el.removeAttribute(e)}get attributes(){return Array.from(this._el.attributes||[])}get html(){return this._el.innerHTML||""}set html(e){this._el.innerHTML=e}get text(){return this._el.textContent||""}set text(e){this._el.textContent=e}set textStr(e){this._el.textContent=`${e}`}blur(){this._el.blur()}focus(){this._el.focus()}getParentModel(){let e=this.parent;return e?e.model||e.getParentModel():void 0}bindModel(e,s=!0){var t;if(!this.model){if(this.model=e,this.hasAttr(":for"))return this.makeDynamicList(e);for(let{name:i,value:n}of this.attributes)this.makeDynamicAttribute(i,n,e);for(let i of this.childNodes)if(i instanceof Text){if((t=i.textContent)!=null&&t.includes("${")){let n=Tr(i.textContent);e.watch(()=>i.textContent=n(e)||"")}}else s&&i.bindModel(e)}}bindVariable(e,s){}toggleDOM(e=!0){e!==!!this._el.parentNode&&(this.$placeholder||(this.$placeholder=G(document.createComment("")),this.insertBefore(this.$placeholder)),e?this.$placeholder.insertBefore(this):this.detach())}makeDynamicAttribute(e,s,t){if(e.startsWith("@")){let i=e.slice(1),n=Pt(s);this.on(i,r=>n(t,{$event:r}))}else if(e===":show"){let i=Pt(s);t.watch(()=>this.toggle(!!i(t)))}else if(e===":if"){let i=Pt(s);t.watch(()=>this.toggleDOM(!!i(t)))}else if(e===":html"){let i=Pt(s);t.watch(()=>this.html=i(t)||"")}else if(e===":draw"){let i=Pt(s);t.watch(()=>this.draw(i(t)))}else if(e===":class"){let i=Pt(s),n=`${this.attr("class")} `;t.watch(()=>this.setAttr("class",n+i(t)))}else if(e===":bind")this.bindVariable(t,s);else if(e.startsWith(":")){let i=Pt(s),n=e.slice(1);t.watch(()=>this.setAttr(n,i(t)))}else if(s.includes("${")){let i=Tr(s);t.watch(()=>this.setAttr(e,i(t)||""))}(e.startsWith("@")||e.startsWith(":"))&&this.removeAttr(e)}makeDynamicList(e){let[s,t]=this.attr(":for").split(" in ");this.removeAttr(":for");let i=Pt(t),n=G(document.createComment(""));this.insertBefore(n),this.detach();let r=[],o=0;e.watch(()=>{let a=i(e);Array.isArray(a)||(a=[]);for(let l=a.length;l<o;++l)r[l].detach();for(let l=o;l<r.length;++l)n.insertBefore(r[l]);for(let l=r.length;l<a.length;++l){let h=this.copy(!0);h.bindModel(mt({[s]:void 0},e)),n.insertBefore(h),r.push(h)}o=a.length;for(let l=0;l<o;++l)r[l].model[s]=a[l]})}get bounds(){return this._el.getBoundingClientRect()}get boundsRect(){let e=this.bounds;return new x(new p(e.x,e.y),e.width,e.height)}contains(e){return this.boundsRect.contains(e)}get isInViewport(){if(this.height===0)return!1;let e=this.bounds;return st(e.top,-e.height,b.height)}get topLeftPosition(){let e=this.bounds;return new p(e.left,e.top)}get boxCenter(){let e=this.bounds;return new p(e.left+e.width/2,e.top+e.height/2)}get scrollWidth(){return this._el.scrollWidth}get scrollHeight(){return this._el.scrollHeight}get scrollTop(){return this._el.scrollTop}set scrollTop(e){this._el.scrollTop=e,this.trigger("scroll",{top:e,left:this.scrollLeft})}get scrollLeft(){return this._el.scrollLeft}set scrollLeft(e){this._el.scrollLeft=e,this.trigger("scroll",{top:this.scrollTop,left:e})}scrollTo(e,s=1e3,t="cubic"){e<0&&(e=0);let i=this.scrollTop,n=e-i;this._data.scrollAnimation&&this._data.scrollAnimation.cancel(),this._data.scrollAnimation=K(r=>{let o=i+n*ot(t,r);this.scrollTop=o,this.trigger("scroll",{top:o})},s)}scrollBy(e,s=1e3,t="cubic"){!e||this.scrollTo(this.scrollTop+e,s,t)}css(e,s){if(s===void 0){if(typeof e=="string")return window.getComputedStyle(this._el).getPropertyValue(e);{let t=Object.keys(e);for(let i of t)this._el.style.setProperty(i,`${e[i]}`)}}else typeof e=="string"&&this._el.style.setProperty(e,`${s}`)}get transform(){return this.css("transform").replace("none","")}get transformMatrix(){let e=this.transform;if(!e)return[[1,0,0],[0,1,0]];let s=e.match(/matrix\(([0-9,.\s-]*)\)/);if(!s||!s[1])return[[1,0,0],[0,1,0]];let t=s[1].split(",");return[[+t[0],+t[2],+t[4]],[+t[1],+t[3],+t[5]]]}get scale(){let e=this.transformMatrix;return[e[0][0],e[1][1]]}setTransform(e,s=0,t=1){let i="";e&&(i+=`translate(${ht(e.x,.1)}px,${ht(e.y,.1)}px)`),s&&(i+=` rotate(${s}rad)`),t&&(i+=` scale(${t})`),this._el.style.transform=i}translate(e,s){this.setTransform(new p(e,s))}show(){this.hasAttr("hidden")&&this.removeAttr("hidden"),this.data.display==="visibility"?this._el.style.visibility="visible":this._el.style.display=this.data.display||"block"}hide(){this.data.display==="visibility"?this._el.style.visibility="hidden":this._el.style.display="none"}toggle(e){e?this.show():this.hide()}is(e){return this._el.matches?this._el.matches(e):Array.from(document.querySelectorAll(e)).includes(this._el)}index(){let e=0,s=this._el;for(;(s=s.previousSibling||void 0)!==void 0;)++e;return e}prepend(e){let s=this._el.childNodes;s.length?this._el.insertBefore(e._el,s[0]):this._el.appendChild(e._el)}append(e){this._el.appendChild(e instanceof Text?e:e._el)}insertBefore(e){this.parent._el.insertBefore(e._el,this._el)}insertAfter(e){let s=this._el.nextSibling;s?this.parent._el.insertBefore(e._el,s):this.parent._el.appendChild(e._el)}get next(){return G(this._el.nextSibling)}get prev(){return G(this._el.previousSibling)}$(e){return G(e,this)}$$(e){return Fe(e,this)}get parent(){return G(this._el.parentElement||void 0)}parents(e){let s=[],t=this.parent;for(;t;)(!e||t.is(e))&&s.push(t),t=t.parent;return s}hasParent(...e){let s=e.map(i=>i._el),t=this._el.parentNode;for(;t;){if(Y(t,...s))return!0;t=t.parentNode}return!1}get children(){return Array.from(this._el.children||[],e=>G(e))}get childNodes(){return Array.from(this._el.childNodes,e=>{if(!(e instanceof Comment))return e instanceof Text?e:G(e)}).filter(e=>e)}restartAnimation(){let e=this.next,s=this.parent;this.detach(),e?e.insertBefore(this):s.append(this)}detach(){this._el&&this._el.parentNode&&this._el.parentNode.removeChild(this._el)}remove(){this.detach()}removeChildren(){for(;this._el.firstChild;)this._el.removeChild(this._el.firstChild)}copy(e=!0){return G(this._el.cloneNode(e))}on(e,s,t){for(let i of lt(e))i in this._events?this._events[i].includes(s)||this._events[i].push(s):this._events[i]=[s],Og(this,i,s,t)}one(e,s,t){let i=n=>{this.off(e,i),s(n)};this.on(e,i,t)}off(e,s){for(let t of lt(e))t in this._events&&(this._events[t]=s?this._events[t].filter(i=>i!==s):[]),Lg(this,t,s)}trigger(e,s={}){for(let t of lt(e)){if(!this._events[t])return;for(let i of this._events[t])i.call(this,s)}}onKeyDown(e,s){let t=lt(e).map(i=>ce[i]||i);this._el.addEventListener("keydown",i=>{t.indexOf(i.keyCode)>=0&&s(i)})}onAttr(e,s){new MutationObserver(i=>{for(let n of i)n.type==="attributes"&&n.attributeName===e&&s(this.attr(e))}).observe(this._el,{attributes:!0}),s(this.attr(e),!0)}onPromise(e,s=!1){return s?Promise.resolve():new Promise(t=>this.one("solve",()=>t()))}animate(e,s=400,t=0,i="ease-in-out"){return he(this,e,s,t,i)}enter(e="fade",s=500,t=0){return a1(this,e,s,t)}exit(e="fade",s=500,t=0,i=!1){return l1(this,e,s,t,i)}effect(e){this.one("animationend",()=>this.removeClass(`effects-${e}`)),this.addClass(`effects-${e}`)}},Us=class extends jd{get offsetTop(){return this._el.offsetTop}get offsetLeft(){return this._el.offsetLeft}get offsetParent(){return G(this._el.offsetParent||void 0)}get width(){return this._el.offsetWidth}get height(){return this._el.offsetHeight}get innerWidth(){let e=parseFloat(this.css("padding-left")),s=parseFloat(this.css("padding-right"));return this._el.clientWidth-e-s}get innerHeight(){let e=parseFloat(this.css("padding-bottom")),s=parseFloat(this.css("padding-top"));return this._el.clientHeight-e-s}get outerWidth(){let e=parseFloat(this.css("margin-left")),s=parseFloat(this.css("margin-right"));return this.width+e+s||0}get outerHeight(){let e=parseFloat(this.css("margin-bottom")),s=parseFloat(this.css("margin-top"));return this.height+e+s||0}get positionTop(){let e=this._el,s=0;for(;e;)s+=e.offsetTop,e=e.offsetParent;return s}get positionLeft(){let e=this._el,s=0;for(;e;)s+=e.offsetLeft,e=e.offsetParent;return s}offset(e){if(e._el===this._el.offsetParent){let s=this.offsetTop+e._el.clientTop,t=this.offsetLeft+e._el.clientLeft,i=s+this.height,n=t+this.width;return{top:s,left:t,bottom:i,right:n}}else{let s=e._el.getBoundingClientRect(),t=this._el.getBoundingClientRect();return{top:t.top-s.top,left:t.left-s.left,bottom:t.bottom-s.top,right:t.right-s.left}}}},Ud=class extends jd{constructor(){super(...arguments),this.type="svg"}get $ownerSVG(){return G(this._el.ownerSVGElement||void 0)}get width(){return this.bounds.width}get height(){return this.bounds.height}get positionLeft(){let e=this._el.getBBox().x+this._el.getCTM().e;return this.$ownerSVG.positionLeft+e}get positionTop(){let e=this._el.getBBox().y+this._el.getCTM().f;return this.$ownerSVG.positionTop+e}get inverseTransformMatrix(){let e=this._el.getScreenCTM().inverse(),s=[[e.a,e.c,e.e],[e.b,e.d,e.f]];if(b.isFirefox){let t=this.transformMatrix;s[0][2]-=t[0][2],s[1][2]-=t[1][2]}return s}setTransform(e,s=0,t=1){let i=e?`translate(${ht(e.x,.1)} ${ht(e.y,.1)})`:"",n=P(s,0)?"":`rotate(${s*180/Math.PI})`,r=P(t,1)?"":`scale(${t})`;this.setAttr("transform",[i,n,r].join(" "))}get strokeLength(){if(this._el instanceof SVGGeometryElement)return this._el.getTotalLength();{let e=this.bounds;return 2*e.height+2*e.width}}getPointAtLength(e){if(this._el instanceof SVGGeometryElement){let s=this._el.getPointAtLength(e);return new p(s.x,s.y)}else return new p(0,0)}getPointAt(e){return this.getPointAtLength(e*this.strokeLength)}get points(){return js(this.attr("d"))}set points(e){let s=e.length?`M${e.map(t=>`${t.x},${t.y}`).join("L")}`:"";this.setAttr("d",s)}addPoint(e){let s=`${this.attr("d")} L ${e.x},${e.y}`;this.setAttr("d",s)}get center(){let e=+this.attr(this.tagName==="TEXT"?"x":"cx"),s=+this.attr(this.tagName==="TEXT"?"y":"cy");return new p(e,s)}setCenter(e){this.setAttr(this.tagName==="TEXT"?"x":"cx",e.x),this.setAttr(this.tagName==="TEXT"?"y":"cy",e.y)}setLine(e,s){this.setAttr("x1",e.x),this.setAttr("y1",e.y),this.setAttr("x2",s.x),this.setAttr("y2",s.y)}setRect(e){this.setAttr("x",e.p.x),this.setAttr("y",e.p.y),this.setAttr("width",e.w),this.setAttr("height",e.h)}draw(e,s={}){if(!e)return this.setAttr("d","");let t={mark:this.attr("mark"),arrows:this.attr("arrows"),size:+this.attr("size")||void 0,fill:this.hasClass("fill"),round:this.hasAttr("round")};this.setAttr("d",jt(e,Object.assign(s,t)))}},jg=class extends Ud{get viewBox(){return this._el.viewBox.baseVal||{width:0,height:0}}get $ownerSVG(){return this}get positionLeft(){return parseInt(this.css("margin-left"))+this.parent.positionLeft}get positionTop(){return parseInt(this.css("margin-top"))+this.parent.positionTop}get svgWidth(){return this.viewBox.width||this.width}get svgHeight(){return this.viewBox.height||this.height}drawPath(e,s={},t={}){let i=c("path",s,this);return i.draw(e,t),i}image(e,s,t,i){return Le(this,null,function*(){let n=this.copy(!0);if(Fd(this._el,n._el),e==="svg"&&zd(n._el),t||(t=s||this.svgHeight),s||(s=this.svgWidth),n.setAttr("width",s),n.setAttr("height",t),n.setAttr("viewBox",i||this.attr("viewBox")||`0 0 ${this.svgWidth} ${this.svgHeight}`),n.setAttr("xmlns","http://www.w3.org/2000/svg"),e==="svg"){let h=n.$$('image[href^="/"]');for(let d of h)d.setAttr("href",`${location.protocol}//${location.host}${d.attr("href")}`)}else{let h=n.$$('image[href^="http"]');yield Promise.all(h.map(d=>Le(this,null,function*(){let u=yield Sr(d.attr("href")),f=c("canvas",{width:u.width,height:u.height});f.ctx.drawImage(u,0,0,u.width,u.height);let v=yield f.image("png");d.setAttr("href",v)})))}let r=new XMLSerializer().serializeToString(n._el),o=`data:image/svg+xml;utf8,${encodeURIComponent(r)}`;if(e==="svg")return o;let a=c("canvas",{width:s,height:t});e==="jpg"&&(a.ctx.fillStyle="white",a.ctx.fillRect(0,0,s,t));let l=yield Sr(o);return a.ctx.drawImage(l,0,0,s,t),a.image(e)})}downloadImage(e,s,t,i){let n=b.isIOS?window.open("","_blank"):void 0,r=b.theme.isDark;r&&b.setTheme("light");let o=e.endsWith(".jpg")?"jpg":e.endsWith(".svg")?"svg":"png",a=this.image(o,s,t,i);r&&b.setTheme("dark"),a.then(l=>{if(n)return n.location.href=l;c("a",{download:e,href:l,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))})}},Zd=class extends Us{constructor(){super(...arguments),this.type="window"}get width(){return window.innerWidth}get height(){return window.innerHeight}get innerWidth(){return window.innerWidth}get innerHeight(){return window.innerHeight}get outerWidth(){return window.outerWidth}get outerHeight(){return window.outerHeight}get scrollWidth(){return document.body.scrollWidth}get scrollHeight(){return document.body.scrollHeight}get scrollTop(){return window.pageYOffset}set scrollTop(e){document.body.scrollTop=document.documentElement.scrollTop=e,this.trigger("scroll",{top:e,left:this.scrollLeft})}get scrollLeft(){return window.pageXOffset}set scrollLeft(e){document.body.scrollLeft=document.documentElement.scrollLeft=e,this.trigger("scroll",{top:this.scrollTop,left:e})}},Ug=class extends Us{constructor(){super(...arguments),this.type="form"}get action(){return this._el.action}get formData(){let e={};for(let s of Array.from(this._el.elements)){let t=s.name||s.id;t&&(e[t]=s.value)}return e}get isValid(){return this._el.checkValidity()}},Zg=class extends Us{constructor(){super(...arguments),this.type="input"}get checked(){return this._el.checked||!1}set checked(e){this._el.checked=e}get value(){return this._el.value}set value(e){this._el.value=e}bindVariable(e,s){let t=this._el.type==="number",i=this._el.type==="checkbox";if(s in e?i?this.checked=e[s]:this.value=e[s]:this.value&&(i?e[s]=this.checked:e[s]=this.value),t){let n=this.hasAttr("min")?+this.attr("min"):-1/0,r=this.hasAttr("max")?+this.attr("max"):1/0;this.change(o=>e[s]=S(+o,n,r)),this.on("blur",()=>this.value=e[s])}else i?this.on("change",()=>e[s]=this.checked):this.change(n=>e[s]=n);e.watch(()=>{i?this.checked=e[s]:this.value=e[s],this.trigger("model-change",{defaultPrevented:!0})})}setInputPattern(e){if(isNaN(+e))return;let s=e.match(/^[0-9]+$/);this.setAttr("inputmode",s?"numeric":"decimal"),s&&this.setAttr("pattern","[0-9]*")}change(e){let s=this.value||"";this.on("change keyup input paste model-change",t=>{this.value!==s&&(s=this.value.trim(),t.defaultPrevented||e(s))})}validate(e){this.change(s=>this.setValidity(e(s)))}setValidity(e){this._el.setCustomValidity(e)}get isValid(){return this._el.checkValidity()}},Wg=class extends Us{constructor(){super(...arguments),this.type="canvas"}getContext(e="2d",s={}){return this._el.getContext(e,s)}image(e="png"){return this._el.toDataURL(e==="png"?"image/png":"image/jpeg")}get canvasWidth(){return this._el.width}get canvasHeight(){return this._el.height}get ctx(){return this._ctx||(this._ctx=this.getContext()),this._ctx}draw(e,s={}){this.ctx.save(),Yl(this.ctx,e,s),this.ctx.restore()}clear(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}fill(e){this.ctx.save(),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.restore()}clearCircle(e,s){this.ctx.save(),this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,s,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.restore()}downloadImage(e){let s=this.image(e.endsWith(".jpg")?"jpg":"png");c("a",{download:e,href:s,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))}},Kg=class extends Us{play(){return this._el.play()||Promise.resolve()}pause(){return this._el.pause()}},Wd=["path","rect","circle","ellipse","polygon","polyline","g","defs","marker","line","text","tspan","pattern","mask","svg","foreignObject","image","use","clipPath"];function G(e,s){if(!e)return;let t=s?s._el:document.documentElement,i=typeof e=="string"?t.querySelector(e):e;if(!i)return;if(i._view)return i._view;let n=(i.tagName||"").toLowerCase();return n==="svg"?new jg(i):n==="canvas"?new Wg(i):n==="form"?new Ug(i):n==="input"||n==="select"||n==="textarea"?new Zg(i):n==="video"||n==="audio"?new Kg(i):Wd.includes(n)?new Ud(i):new Us(i)}function Fe(e,s){let t=s?s._el:document.documentElement,i=e?t.querySelectorAll(e):[];return Array.from(i,n=>G(n))}function c(e,s={},t){let i=Wd.includes(e)?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);for(let[r,o]of Object.entries(s))o!==void 0&&(r==="id"?i.id=o:r==="html"?i.innerHTML=o:r==="text"?i.textContent=o:r==="path"?i.setAttribute("d",jt(o)):i.setAttribute(r,o));let n=G(i);return t&&t.append(n),n}var Z=new Zd(document.body),Ut=new Zd(document.documentElement),ce={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46},$r="_M",Si=window.navigator.userAgent.toLowerCase(),Kd={};for(let[e,s]of Object.entries(ce))Kd[s]=e;var Xg=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i,Od=/iphone|ipad|ipod/i,Yg=/^((?!chrome|android).)*safari/i,Ld,Qg=class{constructor(){this.isMobile=Xg.test(Si),this.isRetina=(window.devicePixelRatio||1)>1,this.isTouch=!!window.Touch||"ontouchstart"in window,this.isChrome=!!window.chrome,this.isFirefox=Si.indexOf("firefox")>=0,this.isAndroid=Si.indexOf("android")>=0,this.isIOS=Od.test(Si),this.isSafari=Od.test(Si)||Yg.test(Si),this.loadQueue=[],this.loaded=!1,this.width=window.innerWidth,this.height=window.innerHeight,this.resizeCallbacks=[],this.theme={name:"light",isDark:!1},this.themeChangedCallbacks=[],this.themeOverride="",this.darkQuery=(Ld=window.matchMedia)==null?void 0:Ld.call(window,"(prefers-color-scheme: dark)");var e,s;window.onload=()=>this.afterLoad(),document.addEventListener("DOMContentLoaded",()=>this.afterLoad());let t=_e(()=>this.applyResize());window.addEventListener("resize",t);try{(e=this.darkQuery)==null||e.addEventListener("change",()=>this.applyThemeChange())}catch(n){(s=this.darkQuery)==null||s.addListener(()=>this.applyThemeChange())}let i=this.getCookie("theme");i&&this.setTheme(i);try{this.localStorage=window.localStorage}catch(n){console.warn("Unable to access Local Storage in this context.")}}afterLoad(){if(!this.loaded){this.loaded=!0;for(let e of this.loadQueue)e();setTimeout(()=>this.resize())}}ready(e){this.loaded?e():this.loadQueue.push(e)}redraw(){document.body.offsetHeight}applyResize(){let e=window.innerWidth,s=window.innerHeight;if(!(this.width===e&&this.height===s)){this.width=e,this.height=s;for(let t of this.resizeCallbacks)t({width:this.width,height:this.height});Z.trigger("scroll",{top:Z.scrollTop})}}onResize(e){e({width:this.width,height:this.height}),this.resizeCallbacks.push(e)}offResize(e){let s=this.resizeCallbacks.indexOf(e);s>=0&&this.resizeCallbacks.splice(s,1)}resize(){this.applyResize()}applyThemeChange(){let e=this.theme.name,s=e==="dark"||e==="auto"&&this.darkQuery.matches;if(s!==this.theme.isDark){this.theme.isDark=s,Ut.setAttr("theme",this.themeOverride||(s?"dark":"light"));for(let t of this.themeChangedCallbacks)t(this.theme)}}setTheme(e){e!==this.theme.name&&(this.theme.name=e,this.setCookie("theme",e),this.applyThemeChange())}onThemeChange(e){this.themeChangedCallbacks.push(e)}getHash(){return window.location.hash.slice(1)}setHash(e){let s=document.body.scrollTop;window.location.hash=e,document.body.scrollTop=s}setURL(e,s=""){window.history.replaceState({},s,e),s&&(window.document.title=s)}getCookies(){let e=document.cookie.split(";"),s={};for(let t=0,i=e.length;t<i;++t){let n=e[t].split("=");s[decodeURIComponent(n[0]).trim()]=decodeURIComponent(n[1])}return s}getCookie(e){let s=document.cookie.match(new RegExp(`(^|;) ?${e}=([^;]*)(;|$)`));return s?s[2]:void 0}setCookie(e,s,t=60*60*24*365){let i=window.location.hostname.replace(/^[a-z]{2}\./,"");document.cookie=`${e}=${s};path=/;max-age=${t};domain=${i}`}deleteCookie(e){this.setCookie(e,"",-1)}setStorage(e,s){var t,i;let n=(e||"").split("."),r=Gs(((t=this.localStorage)==null?void 0:t.getItem($r))||void 0,{}),o=r;for(let a=0;a<n.length-1;++a)o[n[a]]===void 0&&(o[n[a]]={}),o=o[n[a]];o[n[n.length-1]]=s,(i=this.localStorage)==null||i.setItem($r,JSON.stringify(r))}getStorage(e){var s;let t=Gs((s=this.localStorage)==null?void 0:s.getItem($r),{});if(!e)return t;let i=(e||"").split("."),n=i.pop();for(let r of i){if(!(r in t))return;t=t[r]}return t[n]}deleteStorage(e){var s;e?this.setStorage(e,void 0):(s=this.localStorage)==null||s.setItem($r,"")}getActiveInput(){let e=document.activeElement;return e!=null&&e.shadowRoot&&(e=e.shadowRoot.activeElement),e===document.body?void 0:G(e)}onKey(e,s,t=!1){let i=lt(e),n=t?"keyup":"keydown";document.addEventListener(n,r=>{let o=Kd[r.keyCode]||r.key;if(!i.includes(o))return;let a=this.getActiveInput();a&&a.is("input, textarea, [contenteditable]")||a&&["space","enter","tab"].includes(o)&&a.is("button, a, [tabindex]")||s(r,o)})}},b=window.BoostBrowser||new Qg;window.BoostBrowser=b;var Jg=/\bTrident\/[567]\b|\bMSIE (?:9|10)\.0\b/,t1=/\bAppleWebKit\/(\d+)\b/,e1=/\bEdge\/12\.(\d+)\b/,s1=Jg.test(navigator.userAgent)||+(navigator.userAgent.match(e1)||[])[1]<10547||+(navigator.userAgent.match(t1)||[])[1]<537,sh={};function i1(){if(!s1)return;Array.from(document.querySelectorAll("svg > use")).forEach(function(s){let t=s.getAttribute("xlink:href"),[i,n]=t.split("#");if(!i.length||!n)return;let r=s.parentNode;r.removeChild(s),i in sh||(sh[i]=fetch(i).then(a=>a.text())),sh[i].then(a=>{let l=document.implementation.createHTMLDocument("");l.documentElement.innerHTML=a;let d=l.getElementById(n).cloneNode(!0),u=document.createDocumentFragment();for(;d.childNodes.length;)u.appendChild(d.firstChild);r.appendChild(u)})})}function Xd(){document.addEventListener("keydown",e=>{if(e.keyCode===ce.enter||e.keyCode===ce.space){let s=b.getActiveInput();s&&s.hasAttr("tabindex")&&s.tagName!=="TEXTAREA"&&(e.preventDefault(),s.trigger("pointerdown",e),s.trigger("pointerstop",e),Z.trigger("pointerstop",e),s.trigger("click",e))}})}var Ar=!1;setTimeout(()=>Ar=!0);var n1="cubic-bezier(0.175, 0.885, 0.32, 1.275)",r1="cubic-bezier(0.68, -0.275, 0.825, 0.115)",zs={cancel:()=>{},promise:Promise.resolve()};function K(e,s){if(s===0)return e(1,0,()=>{}),zs;let t=Date.now(),i=vs(),n=0,r=!0,o=()=>{r=!1,i.reject()};function a(){r&&(!s||n<=s)&&window.requestAnimationFrame(a);let l=Date.now()-t;e(s?Math.min(1,l/s):l,l-n,o),s&&l>=s&&i.resolve(),n=l}return a(),{cancel:o,promise:i.promise}}function xr(e,s=0,t=0){switch(e){case"quad":return s**2;case"cubic":return s**3;case"quart":return s**4;case"quint":return s**5;case"circ":return 1-Math.sqrt(1-s**2);case"sine":return 1-Math.cos(s*Math.PI/2);case"exp":return s<=0?0:Math.pow(2,10*(s-1));case"back":return t||(t=1.70158),s*s*((t+1)*s-t);case"elastic":return t||(t=.3),-Math.pow(2,10*(s-1))*Math.sin(((s-1)*2/t-.5)*Math.PI);case"swing":return .5-Math.cos(s*Math.PI)/2;case"spring":return 1-Math.cos(s*4.5*Math.PI)*Math.exp(-s*6);case"bounce":return s<1/11?1/64-7.5625*(.5/11-s)*(.5/11-s):s<3/11?1/16-7.5625*(2/11-s)*(2/11-s):s<7/11?1/4-7.5625*(5/11-s)*(5/11-s):1-7.5625*(1-s)*(1-s);default:return s}}function ot(e,s=0,t=0){if(s===0)return 0;if(s===1)return 1;let[i,n]=e.split("-");return n==="in"?xr(i,s,t):n==="out"?1-xr(i,1-s,t):s<=.5?xr(i,2*s,t)/2:1-xr(i,2*(1-s),t)/2}function he(e,s,t=400,i=0,n="ease-in-out"){if(!Ar)return Object.keys(s).forEach(g=>{let y=s[g];e.css(g,Array.isArray(y)?y[1]:y)}),zs;n==="bounce-in"&&(n=n1),n==="bounce-out"&&(n=r1);let r="";b.isSafari&&(r=e._el.style.transition,e.css("transition","none"),b.redraw());let o=e._data.animation;o&&o.cancel();let a={},l={},h=vs(),d=window.getComputedStyle(e._el);Object.keys(s).forEach(g=>{let y=s[g],C=dr(g);l[C]=Array.isArray(y)?y[0]:d.getPropertyValue(g),a[C]=Array.isArray(y)?y[1]:y,i&&e.css(g,l[C])});let u=a.height;if(a.height==="auto"){let g=e.children.filter(y=>y.css("position")!=="absolute");a.height=`${q(g.map(y=>y.outerHeight))}px`}let f,v=!1;Ae(()=>{v||(f=e._el.animate([l,a],{duration:t,easing:n,fill:"forwards"}),f.onfinish=()=>{e._el&&Object.keys(s).forEach(g=>e.css(g,g==="height"?u:a[g])),b.isSafari&&e.css("transition",r),h.resolve(),f.cancel()})},i);let w={cancel(){v=!0,e._el&&Object.keys(s).forEach(g=>e.css(g,e.css(g))),f&&f.cancel()},promise:h.promise};return setTimeout(()=>e._data.animation=w),w}var o1=/matrix\([0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,([0-9.\-\s]+),([0-9.\-\s]+)\)/;function a1(e,s="fade",t=500,i=0){if(e.show(),!Ar)return zs;let n=+e.css("opacity")||1;if(s==="fade")return he(e,{opacity:[0,n]},t,i);if(s==="pop"){let r=e.transform.replace(/scale\([0-9.]*\)/,"").replace(o1,"translate($1px,$2px)");return he(e,{opacity:[0,n]},t,i),he(e,{transform:[`${r} scale(0.5)`,`${r} scale(1)`]},t,i,"bounce-in")}else{if(s==="descend")return he(e,{opacity:[0,1],transform:["translateY(-50%)","none"]},t,i);if(s.startsWith("draw")){let r=e.strokeLength;e.css("stroke-dasharray",`${r}px`),e.css("opacity")||e.css("opacity",1);let o=s==="draw-reverse"?`${2*r}px`:0,a={"stroke-dashoffset":[`${r}px`,o]},l=he(e,a,t,i,"linear");return l.promise.then(()=>e.css("stroke-dasharray","")),l}else if(s.startsWith("slide")){let r={opacity:[0,n],transform:["translateY(50px)","none"]};return s.includes("down")&&(r.transform[0]="translateY(-50px)"),s.includes("right")&&(r.transform[0]="translateX(-50px)"),s.includes("left")&&(r.transform[0]="translateX(50px)"),he(e,r,t,i)}else if(s.startsWith("reveal")){let r={opacity:[0,n],height:[0,"auto"]};return s.includes("left")&&(r.transform=["translateX(-50%)","none"]),s.includes("right")&&(r.transform=["translateX(50%)","none"]),he(e,r,t,i)}}return zs}function l1(e,s="fade",t=400,i=0,n=!1){if(!e._el)return zs;if(!Ar)return e.hide(),zs;if(e.css("display")==="none")return zs;let r;if(s==="fade")r=he(e,{opacity:[1,0]},t,i);else if(s==="pop"){let o=e.transform.replace(/scale\([0-9.]*\)/,"");he(e,{opacity:[1,0]},t,i),r=he(e,{transform:[`${o} scale(1)`,`${o} scale(0.5)`]},t,i,"bounce-out")}else if(s==="ascend")r=he(e,{opacity:[1,0],transform:["none","translateY(-50%)"]},t,i);else if(s.startsWith("draw")){let o=e.strokeLength;e.css("stroke-dasharray",o);let l={"stroke-dashoffset":[s==="draw-reverse"?`${2*o}px`:0,`${o}px`]};r=he(e,l,t,i,"linear")}else if(s.startsWith("slide")){let o={opacity:0,transform:"translateY(50px)"};s.includes("up")&&(o.transform="translateY(-50px)"),r=he(e,o,t,i)}else if(s.startsWith("reveal")){let o={opacity:0,height:0};s.includes("left")&&(o.transform="translateX(-50%)"),s.includes("right")&&(o.transform="translateX(50%)"),r=he(e,o,t,i)}return r.promise.then(()=>n?e.remove():e.hide()),r}var h1=_s(["#cd0e66","#0f82f2","#22ab24","#fd8c00"]),c1=class{constructor(e){this.index=e,this.color=h1(),this.tilt=Math.floor(Math.random()*10)-10,this.tiltAngleIncrement=Math.random()*.07+.05,this.tiltAngle=0,this.x=Math.random()*b.width,this.y=(Math.random()-1)*b.height,this.r=J.uniform(10,30)}draw(e){e.beginPath(),e.lineWidth=this.r/2,e.strokeStyle=this.color,e.moveTo(this.x+this.tilt+this.r/4,this.y),e.lineTo(this.x+this.tilt,this.y+this.tilt+this.r/4),e.stroke()}update(e,s){this.tiltAngle+=this.tiltAngleIncrement,this.y+=(Math.cos(e)+3+this.r/2)/2,this.x+=Math.sin(e),this.tilt=Math.sin(this.tiltAngle-this.index/3)*15,this.x<-20?(this.x=-20,this.y=Math.random()*b.height,this.tilt=Math.floor(Math.random()*10)-20):this.x>b.width+20?(this.x=b.width+20,this.y=Math.random()*b.height,this.tilt=Math.floor(Math.random()*10)-20):s&&this.y>b.height&&(this.x=Math.random()*b.width,this.y=-10,this.tilt=Math.floor(Math.random()*10)-20)}},d1="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999",qs=void 0;function Zs(e=2e3,s=150){qs||(qs=c("canvas",{style:d1},Z)),qs.setAttr("width",b.width),qs.setAttr("height",b.height),qs.show();let t=qs.ctx,i=B(r=>new c1(r),s),n=K(r=>{t.clearRect(0,0,b.width,b.height);let o=r<e,a=0;for(let l of i)l.draw(t),l.update(r,o),l.y<b.height&&(a+=1);a||(n.cancel(),qs.hide())})}var Ws=class extends rs{constructor(e,s={}){super(),this.$el=e,this.startPos=new p(0,0),this.position=new p(0,0),this.disabled=!1,this.options=Object.assign({moveX:!0,moveY:!0,withinBounds:!0},s),b.onResize(()=>this.updateBounds()),Fs(e,{start:()=>{this.disabled||(this.startPos=this.position,this.trigger("start"),Ut.addClass("grabbing"))},move:(t,i)=>{this.disabled||(this.setPosition(this.startPos.x+t.x-i.x,this.startPos.y+t.y-i.y),this.trigger("drag",{posn:this.position,pointerPosn:t}),this.checkTarget(t))},end:(t,i)=>{this.disabled||(this.trigger(t.equals(i)?"click":"end",{$target:this.$over}),this.options.$targets&&!this.$over&&this.options.resetOnMiss&&this.resetPosition(),this.$over=void 0,Ut.removeClass("grabbing"))},click:()=>this.trigger("click"),accessible:!0})}addTarget(e){var s;this.options.$targets||(this.options.$targets=[]),(s=this.options.$targets)==null||s.push(e)}removeTarget(e){var s,t;this.options.$targets=(s=this.options.$targets)==null?void 0:s.filter(i=>i!==e),(t=this.options.$targets)!=null&&t.length||(this.options.$targets=void 0)}checkTarget(e){if(!this.options.$targets)return;let s=this.options.$targets.find(t=>t.boundsRect.contains(e));s!==this.$over&&(this.$over&&this.trigger("exit-target",{$target:this.$over}),s&&this.trigger("enter-target",{$target:s}),this.$over=s)}updateBounds(){if(!this.options.withinBounds)return this.bounds=void 0;if(this.options.bounds)return this.bounds=this.options.bounds;let e=this.bounds,s=this.options.$parent||this.$el.parent,t=s.type==="svg"?s.svgWidth:s.width,i=s.type==="svg"?s.svgHeight:s.height;this.bounds=new kt(0,t,0,i),!t&&!i&&setTimeout(()=>this.updateBounds()),e&&this.setPosition(this.position.x*this.bounds.dx/e.dx||0,this.position.y*this.bounds.dy/e.dy||0)}setPosition(e,s){var t;let i=new p(this.options.moveX?e:0,this.options.moveY?s:0);this.bounds&&(i=i.clamp(this.bounds,(t=this.options.margin)!=null?t:0)),i=i.round(this.options.snap||1),this.options.round&&(i=this.options.round(i)),!i.equals(this.position)&&(this.position=i,this.options.useTransform?this.$el.translate(i.x,i.y):(this.options.moveX&&this.$el.css("left",`${i.x}px`),this.options.moveY&&this.$el.css("top",`${i.y}px`)),this.trigger("move",{posn:i}))}resetPosition(e=250){return Le(this,null,function*(){let s=this.position;this.$el.css({"pointer-events":"none"}),yield K(t=>{let i=p.interpolate(s,this.startPos,t);this.setPosition(i.x,i.y)},e).promise,this.$el.css({"pointer-events":"initial"})})}},p1="position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #0f82f2; pointer-events: none; z-index: 9999; will-change: transform;";function Rd(e,s){let t=s.regex.exec(e);if(t){t.shift();let i={};for(let[n,r]of s.params.entries())i[r]=t[n];return i}else return}function u1(e,s,t){return Le(this,null,function*(){return e.template?typeof e.template=="string"?e.template:e.template(s):(yield fetch(t+(t.indexOf("?")>=0?"&xhr=1":"?xhr=1"))).text()})}var Yd=document.readyState==="complete";window.addEventListener("load",()=>setTimeout(()=>Yd=!0));"scrollRestoration"in window.history&&(window.history.scrollRestoration="manual");var f1=class extends rs{constructor(){super(...arguments),this.$viewport=Z,this.views=[],this.active={path:"",hash:""},this.preloaded=!1,this.transition=!1,this.noLoad=!1,this.initialise=()=>{}}setup(e={}){e.$viewport&&(this.$viewport=e.$viewport),e.initialise&&(this.initialise=e.initialise),e.preloaded&&(this.preloaded=e.preloaded),e.transition&&(this.transition=e.transition),e.noLoad&&(this.noLoad=e.noLoad),e.click&&Z.on("click",s=>this.onLinkClick(s)),e.history&&window.addEventListener("popstate",s=>Le(this,null,function*(){var t;if(!Yd||!((t=s.state)!=null&&t.path))return;(yield this.load(s.state.path,s.state.hash))||window.history.pushState(this.active,"",this.active.path+this.active.hash)}))}view(e,{enter:s,exit:t,template:i}={}){let n=(e.match(/:\w+/g)||[]).map(u=>u.substr(1)),r=`${e.replace(/:\w+/g,"([\\w-]+)").replace("/","\\/")}\\/?`,o=e.includes("?")?"":"(\\?.*)?",l={regex:new RegExp(`^${r}${o}$`,"i"),params:n,enter:s,exit:t,template:i};this.views.push(l);let h=window.location.pathname+window.location.search,d=Rd(h,l);!d||(this.active={path:h,hash:window.location.hash},window.history.replaceState(this.active,"",this.active.path+this.active.hash),b.ready(()=>{setTimeout(()=>{this.preloaded?(this.initialise(this.$viewport,d),l.enter&&l.enter(this.$viewport,d)):this.loadView(l,d)})}))}paths(...e){for(let s of e)this.view(s)}getView(e){for(let s of this.views){let t=Rd(e,s);if(t)return{view:s,params:t}}}load(e,s){return Le(this,null,function*(){if(e===this.active.path&&s!==this.active.hash)return this.trigger("hashChange",s.slice(1)),this.trigger("change",e+s),this.active={path:e,hash:s},!0;let t=this.getView(e);return!t||this.beforeChange&&!(yield this.beforeChange())?!1:(this.active={path:e,hash:s},this.trigger("change",e+s),window.ga&&window.ga("send","pageview",e+s),this.noLoad?t.view.enter&&t.view.enter(this.$viewport,t.params):this.loadView(t.view,t.params),!0)})}loadView(e){return Le(this,arguments,function*(s,t={}){this.showLoadingBar();let i=this.active.path,n=yield u1(s,t,i);if(this.active.path!==i)return;yield this.$viewport.animate({opacity:0},200).promise,this.$viewport.removeChildren(),Z.scrollTop=0,this.$viewport.html=n,b.resize(),i1(),this.$viewport.animate({opacity:1},200),this.hideLoadingBar();let r=this.$viewport.$("title");r&&(document.title=r.text),this.initialise(this.$viewport,t),s.enter&&s.enter(this.$viewport,t),this.trigger("afterChange",{$viewport:this.$viewport})})}onLinkClick(e){if(e.metaKey||e.ctrlKey||e.shiftKey||e.defaultPrevented)return;let s=e.target;for(;s&&s.nodeName!=="A";)s=s.parentNode;if(!s||s.nodeName!=="A")return;let t=s;if(t.target||t.origin!==window.location.origin||t.hasAttribute("download")||t.getAttribute("rel")==="external")return;let i=t.getAttribute("href");i&&i.indexOf("mailto:")>-1||this.getView(t.pathname+t.search)&&(e.preventDefault(),this.goTo(t.pathname+t.search,t.hash))}goTo(e,s=""){return Le(this,null,function*(){let t=this.active.path+this.active.hash;(yield this.load(e,s))&&t!==this.active.path+this.active.hash&&window.history.pushState(this.active,"",e+s)})}replace(e,s=""){this.active={path:e,hash:s},window.history.replaceState(this.active,"",e+s)}back(){window.history.back()}forward(){window.history.forward()}showLoadingBar(){this.$loadingBar||(this.$loadingBar=c("div",{style:p1},Z)),this.$loadingBar.css({transform:"translateX(-100%)",opacity:1}),this.$loadingBar.show(),this.animation=K(e=>{this.$loadingBar.css("transform",`translateX(-${10+90*Math.exp(-4*e)}%)`)},3e3)}hideLoadingBar(){return Le(this,null,function*(){var e,s,t;(e=this.animation)==null||e.cancel(),yield(s=this.$loadingBar)==null?void 0:s.animate({transform:"none",opacity:0}).promise,(t=this.$loadingBar)==null||t.hide()})}},$n=new f1;function m1(e,s){let t=Array.from(e.childNodes);e.innerHTML=s;let i={};for(let n of Array.from(e.querySelectorAll("slot")))i[n.getAttribute("name")||""]=n;for(let n of t){let r=n.getAttribute&&n.getAttribute("slot")||"",o=i[r]||i[""];o&&o.parentNode.insertBefore(n,o)}for(let n of Object.values(i))n.parentNode.removeChild(n)}function Qd(e){let s=[];for(let t of Array.from(e.children))t.tagName.startsWith("X-")?s.push(t):s.push(...Qd(t));return s}var Jd=new Map,g1=class extends HTMLElement{constructor(){super(...arguments),this.wasConnected=!1,this.isReady=!1}connectedCallback(){return Le(this,null,function*(){if(this.wasConnected){this._view.trigger("connected");return}this.wasConnected=!0,this.isReady=!1,this._view.created();let e=Jd.get(this._view.tagName)||{};e.template&&m1(this,e.template);let s=Qd(this).filter(t=>!t.isReady).map(t=>new Promise(i=>t.addEventListener("ready",i)));yield Promise.all(s),this._view.ready(),this.dispatchEvent(new CustomEvent("ready")),this.isReady=!0})}disconnectedCallback(){this._view.trigger("disconnected")}},O=class extends Us{created(){}ready(){}};function V(e,s={}){return function(t){if(window.customElements.get(e)){console.warn(`Trying to declare the custom element ${e} twice!`);return}class i extends g1{constructor(){super(),this._view=new t(this)}}Jd.set(e.toUpperCase(),s),window.customElements.define(e,i)}}var Vr=class{constructor(s){this.clipEndTime=0;this.player=new Audio(s),this.player.preload="true",this.player.addEventListener("timeupdate",()=>{this.player.currentTime>=this.clipEndTime&&this.triggerCallback(!0)}),window.addEventListener("beforeunload",()=>this.player.pause())}playClip(s,t,i){this.triggerCallback(!1),this.player.currentTime=s,this.clipEndTime=t,this.clipCallback=i,this.player.play()}triggerCallback(s){if(!this.clipCallback)return;let t=this.clipCallback;this.clipCallback=void 0,this.player.pause(),t({ended:s})}pause(){this.triggerCallback(!1)}get isPlaying(){return!!this.clipCallback}},oh=!1,rh,kr=class{constructor(s,t){this.audio=s;this.paragraphs=[];this.paragraphs=t.$$(".voice").map(i=>new ah(i,s));for(let[i,n]of this.paragraphs.entries())n.on("end",()=>{var r;if(this.paragraphs[i+1])this.paragraphs[i+1].play();else{let o=t.nextStep;o&&o.isShown&&((r=o.narration)==null||r.play())}})}play(){var s;this.audio.isPlaying||!oh||(s=this.paragraphs[0])==null||s.play()}},ah=class extends rs{constructor(t,i){super();this.$p=t;this.audio=i;this.playing=void 0;this.sentences=t.$$(".sentence[data-timings]").map(n=>new lh(n,i)),this.$button=c("button",{class:"playback-btn",title:"Play Narration"}),this.$button.on("click",()=>{this.playing?this.audio.pause():this.play(),oh=!oh,rh=void 0}),t.prepend(this.$button),t.addClass("sentence-wrap");for(let[n,r]of this.sentences.entries())r.on("end",o=>{this.playing=void 0,o&&this.sentences[n+1]?setTimeout(()=>this.play(this.sentences[n+1]),200):(this.$button.removeClass("active"),o&&setTimeout(()=>this.trigger("end"),400))})}play(t){let i=t||this.sentences[0],n=i.$reveal;if(n&&n.css("visibility")==="hidden"){this.$button.removeClass("active"),rh=n,n.one("reveal",()=>{rh===n&&!this.audio.isPlaying&&this.play(i)});return}this.playing=i,this.playing.play(),this.$button.addClass("active");let r=this.$p.parents("x-tabbox .tab")[0];if(r){let l=r.parents("x-tabbox")[0];l.makeActive(r.index());let h=l.active;l.one("change",d=>{this.playing&&d!==h&&this.audio.pause()})}let o=this.$p.bounds,a=o.top+o.height-b.height+20;a>0&&Z.scrollBy(a+100),setTimeout(()=>this.$button.focus(),800)}},lh=class extends rs{constructor(t,i){super();this.$el=t;this.audio=i;let n=t.attr("data-timings").split("-");this.start=+n[0]/1e3,this.end=(+n[1]-200)/1e3}play(){this.$el.addClass("playing"),this.audio.playClip(this.start,this.end,({ended:t})=>{this.$el.removeClass("playing"),this.trigger("end",t)})}get $reveal(){return this.$el.parents(".reveal")[0]}};var v1=Object.defineProperty,w1=Object.getOwnPropertyDescriptor,xn=(e,s,t,i)=>{for(var n=i>1?void 0:i?w1(s,t):s,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(s,t,n):o(n))||n);return i&&n&&v1(s,t,n),n},tp=(e,s,t)=>new Promise((i,n)=>{var r=l=>{try{a(t.next(l))}catch(h){n(h)}},o=l=>{try{a(t.throw(l))}catch(h){n(h)}},a=l=>l.done?i(l.value):Promise.resolve(l.value).then(r,o);a((t=t.apply(e,s)).next())}),Mi,y1=c("div",{class:"snackbar"},Z),ep=class extends O{ready(){var e;y1.append(this),(e=this.$("button"))==null||e.on("click",()=>this.close())}open(e=2e3){return tp(this,null,function*(){Mi!==this&&(Mi&&(yield Mi.close()),Mi=this,yield this.enter("pop",300).promise,this.setAttr("role","alert"),e&&setTimeout(()=>this.close(),e))})}close(){return tp(this,null,function*(){Mi===this&&(Mi=void 0,this.removeAttr("role"),yield this.exit("pop",300).promise)})}};ep=xn([V("x-alert")],ep);var sp=void 0,ip=class extends O{ready(){if(this.children.length)return;let e=+this.attr("size")||24;this.css({width:`${e}px`,height:`${e}px`});let s=c("svg",{viewBox:"0 0 24 24"},this);if(s.css({width:`${e}px`,height:`${e}px`}),sp)this.onAttr("name",t=>s.html=sp[t]);else{let t=c("use",{},s);this.onAttr("name",i=>t.setAttr("href",`/icons.54b14688.svg#${i}`))}}};ip=xn([V("x-icon")],ip);var Ks=c("div",{class:"modal-background"},Z),hh,je=void 0,ch=void 0;function dh(){je&&je.canClose&&je.close()}Ks.on("click",dh);b.onKey("escape",dh);$n.on("change",dh);Ks.on("scrollwheel touchmove",e=>{e.preventDefault(),e.stopPropagation()});b.onKey("space up down pagedown pageup",e=>{je&&(e.preventDefault(),e.stopPropagation())});var np=class extends O{constructor(){super(...arguments),this.isOpen=!1,this.canClose=!0}ready(){this.canClose=!this.hasAttr("no-close"),this.$iframe=this.$("iframe[data-src]"),this.$video=this.$("video");let e=Fe(`[data-modal=${this.id}]`);for(let t of e)t.on("click",()=>this.open());$n.on("afterChange",({$viewport:t})=>{let i=t.$$(`[data-modal=${this.id}]`);for(let n of i)n.on("click",()=>this.open())}),(this.hasClass("open")||b.getHash()===this.id)&&!je&&this.open(!0),this.$("input")&&this.addClass("interactive");let s=this.$(".close");s&&s.on("click",()=>this.close());for(let t of this.$$(".btn"))t.on("click",()=>this.trigger("btn-click",t))}open(e=!1){if(this.isOpen)return;Ks.setClass("light",this.hasClass("light")),je?je.close(!0):e?Ks.show():Ks.css("display")==="block"?hh==null||hh.cancel():Ks.enter("fade",250),this.isOpen=!0,je=this,this.$iframe&&this.$iframe.setAttr("src",this.$iframe.data.src),this.$video&&this.$video.play(),e?this.show():this.enter("pop",250).promise.then(()=>this.css("transform","")),this.setAttr("role","dialog"),this.trigger("open"),ch=document.activeElement;let s=this.$('input, a, button, textarea, [tabindex="0"]');s&&s.focus()}close(e=!1,s=!1){!this.isOpen||(this.isOpen=!1,this.removeAttr("role"),je=void 0,this.$iframe&&this.$iframe.setAttr("src",""),this.$video&&this.$video.pause(),e||(hh=Ks.exit("fade",250)),this.exit("pop",250).promise.then(()=>this.css("transform","")),s||this.trigger("close"),ch&&ch.focus())}getOpenModal(){return je}};np=xn([V("x-modal")],np);var rp=class extends O{constructor(){super(...arguments),this.isOpen=!1}ready(){this.animation=this.attr("animation")||"pop",this.$bubble=this.$(".popup-body"),this.$bubble.hide(),this.$(".popup-target").on("click",()=>this.toggle()),this.on("clickOutside",()=>this.close());for(let s of this.$bubble.$$("a"))s.on("click",()=>this.close());b.onKey("escape",()=>this.close())}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen||(this.isOpen=!0,this.addClass("active"),this.$bubble.enter(this.animation,150),this.$bubble.setAttr("role","dialog"),this.$bubble.focus())}close(){!this.isOpen||(this.isOpen=!1,this.removeClass("active"),this.$bubble.exit(this.animation,150),this.$bubble.removeAttr("role"))}};rp=xn([V("x-popup")],rp);var op=class extends O{constructor(){super(...arguments),this.$options={}}ready(){let e=this.children;this.$active=this.$(".active")||e[0],this.$active.addClass("active");for(let[s,t]of e.entries())!Y(t.tagName,"A","BUTTON")&&!t.hasAttr("tabindex")&&t.setAttr("tabindex",0),t.on("click",()=>this.makeActive(t)),this.$options[t.attr("value")||s]=t;this.trigger("change",this.$active)}makeActive(e){e!==this.$active&&(this.$active.removeClass("active"),this.$active=e,e.addClass("active"),this.trigger("change",e))}bindVariable(e,s){e[s]===void 0&&(e[s]=this.$active.attr("value")),this.on("change",t=>e[s]=t.attr("value")),e.watch(()=>{let t=this.$options[e[s]];t&&this.makeActive(t)})}};op=xn([V("x-select")],op);var ph=12;function b1(e){return`M${e},${e/2}a${e/2},${e/2},0,0,1,0,${e}A${e/2},${e/2},0,0,1,${e},${e/2}`}function $1(e){return`M ${e},0 C ${e/2},0,0,${e/2},0,${e}  s ${e/2},${e},${e},${e} s ${e}-${e/2},${e}-${e}     S ${e*1.5},0,${e},0 z M ${e*44.6/50},${e*76.1/50} L ${e*19.2/50},${e*48.8/50} l ${e*4/50}-${e*4.2/50}     l ${e*19.8/50},${e*11.9/50} l ${e*34.2/50}-${e*32.6/50} l ${e*3.5/50},${e*3.5/50} L ${e*44.6/50},${e*76.1/50} z`}var Or=class extends O{constructor(){super(...arguments);this.completed=!1}ready(){this.r=+this.attr("r")||10,this.r1=this.r+ph,this.$svg=c("svg",{width:2*this.r1,height:2*this.r1},this),this.$progress=c("path",{class:"pie",d:b1(this.r),"stroke-width":this.r},this.$svg),this.onAttr("p",t=>this.setProgress(+t,!1))}setProgress(t,i=!0){if(t>.99)return this.complete(i);let n=Math.PI*this.r;this.$progress.css("stroke",t?"currentColor":"none"),this.$progress.css("stroke-dasharray",`${t*n} ${n}`)}complete(t=!0){if(this.completed||(this.completed=!0,this.$progress.css("stroke","none"),this.$progress.css("fill","currentColor"),this.$progress.setAttr("d",$1(this.r)),!t))return;let i=`translate(${this.r1} ${this.r1})`,n=c("g",{transform:i},this.$svg),r=B(()=>c("line",{},n),18);K(o=>{let a=this.r+ph*ot("quint-out",o),l=this.r+ph*o;for(let h=0;h<18;++h){let d=Math.cos(Math.PI*2*h/18),u=Math.sin(Math.PI*2*h/18);r[h].setLine({x:d*a,y:u*a},{x:d*l,y:u*l})}},800).promise.then(()=>n.remove())}};Or=N([V("x-progress")],Or);var ap="2.4.1",uh="i5iSjo",lp="_av",fh="_au",mh="(not set)";var Lr=[],ve=class{static add(s,t,i){hp(s,t).add(i)}static remove(s,t,i){hp(s,t).remove(i)}constructor(s,t){this.context=s,this.methodName=t,this.isTask=/Task$/.test(t),this.originalMethodReference=this.isTask?s.get(t):s[t],this.methodChain=[],this.boundMethodChain=[],this.wrappedMethod=(...i)=>this.boundMethodChain[this.boundMethodChain.length-1](...i),this.isTask?s.set(t,this.wrappedMethod):s[t]=this.wrappedMethod}add(s){this.methodChain.push(s),this.rebindMethodChain()}remove(s){let t=this.methodChain.indexOf(s);t>-1&&(this.methodChain.splice(t,1),this.methodChain.length>0?this.rebindMethodChain():this.destroy())}rebindMethodChain(){this.boundMethodChain=[];for(let s,t=0;s=this.methodChain[t];t++){let i=this.boundMethodChain[t-1]||this.originalMethodReference.bind(this.context);this.boundMethodChain.push(s(i))}}destroy(){let s=Lr.indexOf(this);s>-1&&(Lr.splice(s,1),this.isTask?this.context.set(this.methodName,this.originalMethodReference):this.context[this.methodName]=this.originalMethodReference)}};function hp(e,s){let t=Lr.filter(i=>i.context==e&&i.methodName==s)[0];return t||(t=new ve(e,s),Lr.push(t)),t}var Ei=window.Element.prototype,qb=Ei.matches||Ei.matchesSelector||Ei.webkitMatchesSelector||Ei.mozMatchesSelector||Ei.msMatchesSelector||Ei.oMatchesSelector;var S1="80",T1="443",Jb=RegExp(":("+S1+"|"+T1+")$"),t$=document.createElement("a");function Rr(e,s,t=void 0,i=void 0,n=void 0,r=void 0){if(typeof i=="function"){let o=t.get("buildHitTask");return{buildHitTask:a=>{a.set(e,null,!0),a.set(s,null,!0),i(a,n,r),o(a)}}}else return $s({},e,s)}var gh={};function dp(e,s){let t=e.get("trackingId"),i=gh[t]=gh[t]||{},n=()=>{clearTimeout(i.timeout),i.send&&ve.remove(e,"send",i.send),delete gh[t],i.queue.forEach(r=>r())};clearTimeout(i.timeout),i.timeout=setTimeout(n,0),i.queue=i.queue||[],i.queue.push(s),i.send||(i.send=r=>(...o)=>{n(),r(...o)},ve.add(e,"send",i.send))}var $s=Object.assign||function(e,...s){for(let t=0,i=s.length;t<i;t++){let n=Object(s[t]);for(let r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e};function pp(e){return e.charAt(0).toUpperCase()+e.slice(1)}function up(e){return typeof e=="object"&&e!==null}function xs(){return+new Date}var Pn=function e(s){return s?(s^Math.random()*16>>s/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)};function vh(e,s){let t=window.GoogleAnalyticsObject||"ga";window[t]=window[t]||function(...i){(window[t].q=window[t].q||[]).push(i)},window.gaDevIds=window.gaDevIds||[],window.gaDevIds.indexOf(uh)<0&&window.gaDevIds.push(uh),window[t]("provide",e,s),window.gaplugins=window.gaplugins||{},window.gaplugins[pp(e)]=s}var Sn=class{constructor(){this.registry_={}}on(s,t){this.getRegistry_(s).push(t)}off(s=void 0,t=void 0){if(s&&t){let i=this.getRegistry_(s),n=i.indexOf(t);n>-1&&i.splice(n,1)}else this.registry_={}}emit(s,...t){this.getRegistry_(s).forEach(i=>i(...t))}getEventCount(){let s=0;return Object.keys(this.registry_).forEach(t=>{s+=this.getRegistry_(t).length}),s}getRegistry_(s){return this.registry_[s]=this.registry_[s]||[]}};var Ir="autotrack",Ai={},yh=!1,Tn,de=class extends Sn{static getOrCreate(s,t,i){let n=[Ir,s,t].join(":");return Ai[n]||(Ai[n]=new de(n,i),yh||M1()),Ai[n]}static isSupported_(){if(Tn!=null)return Tn;try{window.localStorage.setItem(Ir,Ir),window.localStorage.removeItem(Ir),Tn=!0}catch(s){Tn=!1}return Tn}static get_(s){return window.localStorage.getItem(s)}static set_(s,t){window.localStorage.setItem(s,t)}static clear_(s){window.localStorage.removeItem(s)}constructor(s,t={}){super(),this.key_=s,this.defaults_=t,this.cache_=null}get(){if(this.cache_)return this.cache_;if(de.isSupported_())try{this.cache_=wh(de.get_(this.key_))}catch(s){}return this.cache_=$s({},this.defaults_,this.cache_)}set(s){if(this.cache_=$s({},this.defaults_,this.cache_,s),de.isSupported_())try{de.set_(this.key_,JSON.stringify(this.cache_))}catch(t){}}clear(){if(this.cache_={},de.isSupported_())try{de.clear_(this.key_)}catch(s){}}destroy(){delete Ai[this.key_],Object.keys(Ai).length||E1()}};function M1(){window.addEventListener("storage",fp),yh=!0}function E1(){window.removeEventListener("storage",fp),yh=!1}function fp(e){let s=Ai[e.key];if(s){let t=$s({},s.defaults_,wh(e.oldValue)),i=$s({},s.defaults_,wh(e.newValue));s.cache_=i,s.emit("externalSet",i,t)}}function wh(e){let s={};if(e)try{s=JSON.parse(e)}catch(t){}return s}var A1=1e3,V1=60*A1,Nr={},Ue=class{static getOrCreate(s,t,i){let n=s.get("trackingId");return Nr[n]?Nr[n]:Nr[n]=new Ue(s,t,i)}constructor(s,t,i){this.tracker=s,this.timeout=t||Ue.DEFAULT_TIMEOUT,this.timeZone=i,this.sendHitTaskOverride=this.sendHitTaskOverride.bind(this),ve.add(s,"sendHitTask",this.sendHitTaskOverride);try{this.dateTimeFormatter=new Intl.DateTimeFormat("en-US",{timeZone:this.timeZone})}catch(r){}let n={hitTime:0,isExpired:!1};this.store=de.getOrCreate(s.get("trackingId"),"session",n),this.store.get().id||this.store.set({id:Pn()})}getId(){return this.store.get().id}isExpired(s=this.getId()){if(s!=this.getId())return!0;let t=this.store.get();if(t.isExpired)return!0;let i=t.hitTime;if(i){let n=new Date,r=new Date(i);if(n-r>this.timeout*V1||this.datesAreDifferentInTimezone(n,r))return!0}return!1}datesAreDifferentInTimezone(s,t){return this.dateTimeFormatter?this.dateTimeFormatter.format(s)!=this.dateTimeFormatter.format(t):!1}sendHitTaskOverride(s){return t=>{s(t);let i=t.get("sessionControl"),n=i=="start"||this.isExpired(),r=i=="end",o=this.store.get();o.hitTime=xs(),n&&(o.isExpired=!1,o.id=Pn()),r&&(o.isExpired=!0),this.store.set(o)}}destroy(){ve.remove(this.tracker,"sendHitTask",this.sendHitTaskOverride),this.store.destroy(),delete Nr[this.tracker.get("trackingId")]}};Ue.DEFAULT_TIMEOUT=30;var bh={CLEAN_URL_TRACKER:1,EVENT_TRACKER:2,IMPRESSION_TRACKER:3,MEDIA_QUERY_TRACKER:4,OUTBOUND_FORM_TRACKER:5,OUTBOUND_LINK_TRACKER:6,PAGE_VISIBILITY_TRACKER:7,SOCIAL_WIDGET_TRACKER:8,URL_CHANGE_TRACKER:9,MAX_SCROLL_TRACKER:10},mp=Object.keys(bh).length;function gp(e,s){N1(e),I1(e,s)}function k1(e){return parseInt(e||"0",16).toString(2)}function O1(e){return parseInt(e||"0",2).toString(16)}function L1(e,s){if(e.length<s){let t=s-e.length;for(;t;)e="0"+e,t--}return e}function R1(e,s){return e.substr(0,s)+1+e.substr(s+1)}function I1(e,s){let t=e.get("&"+fh),i=L1(k1(t),mp);i=R1(i,mp-s),e.set("&"+fh,O1(i))}function N1(e){e.set("&"+lp,ap)}var Cn="hidden",Ze="visible",Vi=Pn(),vp=1e3,$h=class{constructor(s,t){if(gp(s,bh.PAGE_VISIBILITY_TRACKER),!document.visibilityState)return;let i={sessionTimeout:Ue.DEFAULT_TIMEOUT,visibleThreshold:5*vp,sendInitialPageview:!1,fieldsObj:{}};this.opts=$s(i,t),this.tracker=s,this.lastPageState=document.visibilityState,this.visibleThresholdTimeout_=null,this.isInitialPageviewSent_=!1,this.trackerSetOverride=this.trackerSetOverride.bind(this),this.handleChange=this.handleChange.bind(this),this.handleWindowUnload=this.handleWindowUnload.bind(this),this.handleExternalStoreSet=this.handleExternalStoreSet.bind(this),this.store=de.getOrCreate(s.get("trackingId"),"plugins/page-visibility-tracker"),this.store.on("externalSet",this.handleExternalStoreSet),this.session=Ue.getOrCreate(s,this.opts.sessionTimeout,this.opts.timeZone),ve.add(s,"set",this.trackerSetOverride),window.addEventListener("unload",this.handleWindowUnload),document.addEventListener("visibilitychange",this.handleChange),dp(this.tracker,()=>{document.visibilityState==Ze?(this.opts.sendInitialPageview&&(this.sendPageview({isPageLoad:!0}),this.isInitialPageviewSent_=!0),this.store.set({time:xs(),state:Ze,pageId:Vi,sessionId:this.session.getId()})):this.opts.sendInitialPageview&&this.opts.pageLoadsMetricIndex&&this.sendPageLoad()})}handleChange(){if(!(document.visibilityState==Ze||document.visibilityState==Cn))return;let s=this.getAndValidateChangeData(),t={time:xs(),state:document.visibilityState,pageId:Vi,sessionId:this.session.getId()};document.visibilityState==Ze&&this.opts.sendInitialPageview&&!this.isInitialPageviewSent_&&(this.sendPageview(),this.isInitialPageviewSent_=!0),document.visibilityState==Cn&&this.visibleThresholdTimeout_&&clearTimeout(this.visibleThresholdTimeout_),this.session.isExpired(s.sessionId)?(this.store.clear(),this.lastPageState==Cn&&document.visibilityState==Ze&&(clearTimeout(this.visibleThresholdTimeout_),this.visibleThresholdTimeout_=setTimeout(()=>{this.store.set(t),this.sendPageview({hitTime:t.time})},this.opts.visibleThreshold))):(s.pageId==Vi&&s.state==Ze&&this.sendPageVisibilityEvent(s),this.store.set(t)),this.lastPageState=document.visibilityState}getAndValidateChangeData(){let s=this.store.get();return this.lastPageState==Ze&&s.state==Cn&&s.pageId!=Vi&&(s.state=Ze,s.pageId=Vi,this.store.set(s)),s}sendPageVisibilityEvent(s,{hitTime:t}={}){let i=this.getTimeSinceLastStoredChange(s,{hitTime:t});if(i&&i>=this.opts.visibleThreshold){let n=Math.round(i/vp),r={transport:"beacon",nonInteraction:!0,eventCategory:"Page Visibility",eventAction:"track",eventValue:n,eventLabel:mh};t&&(r.queueTime=xs()-t),this.opts.visibleMetricIndex&&(r["metric"+this.opts.visibleMetricIndex]=n),this.tracker.send("event",Rr(r,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}}sendPageLoad(){let s={transport:"beacon",eventCategory:"Page Visibility",eventAction:"page load",eventLabel:mh,["metric"+this.opts.pageLoadsMetricIndex]:1,nonInteraction:!0};this.tracker.send("event",Rr(s,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}sendPageview({hitTime:s,isPageLoad:t}={}){let i={transport:"beacon"};s&&(i.queueTime=xs()-s),t&&this.opts.pageLoadsMetricIndex&&(i["metric"+this.opts.pageLoadsMetricIndex]=1),this.tracker.send("pageview",Rr(i,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}trackerSetOverride(s){return(t,i)=>{let n=up(t)?t:{[t]:i};n.page&&n.page!==this.tracker.get("page")&&this.lastPageState==Ze&&this.handleChange(),s(t,i)}}getTimeSinceLastStoredChange(s,{hitTime:t}={}){return s.time?(t||xs())-s.time:0}handleExternalStoreSet(s,t){s.time!=t.time&&t.pageId==Vi&&t.state==Ze&&!this.session.isExpired(t.sessionId)&&this.sendPageVisibilityEvent(t,{hitTime:s.time})}handleWindowUnload(){this.lastPageState!=Cn&&this.handleChange()}remove(){this.store.destroy(),this.session.destroy(),ve.remove(this.tracker,"set",this.trackerSetOverride),window.removeEventListener("unload",this.handleWindowUnload),document.removeEventListener("visibilitychange",this.handleChange)}};vh("pageVisibilityTracker",$h);Xd();Ut.addClass((b.isMobile?"is":"not")+"-mobile");b.isSafari&&Ut.addClass("is-safari");setTimeout(()=>Ut.addClass("ready"));window.addEventListener("keydown",e=>{e.keyCode===9&&Ut.addClass("is-tabbing")});window.addEventListener("mousedown",()=>{Ut.removeClass("is-tabbing")});var wp=G(".cookie-warning");wp&&G("#yes-to-cookies").on("click",function(){wp.exit("pop",300),b.setCookie("cookie_consent",1)});var xh=G("x-modal#privacy");xh&&xh.$("form").on("submit",e=>{e.preventDefault(),fetch("/profile/accept-policies",{method:"POST"}),xh.close()});var bp;(bp=navigator.serviceWorker)==null||bp.register("/service_worker.js",{scope:"/"}).catch(()=>console.warn("Unable to register Service Worker."));window.addEventListener("beforeinstallprompt",e=>{e.prompt()});var $p;($p=G("#skip-nav"))==null||$p.on("click",()=>{var s;(s=(G("article")||G(".panel.active")||G(".body")||Z).$("input, button, a, textarea, [contenteditable], [tabindex]"))==null||s.focus()});var Ph=G("nav x-popup");if(Ph){let e=Ph.$$(".popup-body a, .popup-body button");for(let s of e)s.on("click",()=>Ph.close())}var G1=Fe("#language .locale-link");$n.on("change",e=>{for(let s of G1)s.setAttr("href",s.data.host+e)});var Gr=G("#dark-mode");Gr&&(Gr.checked=b.theme.isDark,Gr.on("change",()=>b.setTheme(Gr.checked?"dark":"light")));var Mn={},Xs=G("#search"),Ps=Xs==null?void 0:Xs.$(".form-field input"),Dr=Xs==null?void 0:Xs.$(".search-body");Mn[""]=(Dr==null?void 0:Dr.html)||"";function D1(e){return e=e.trim().replace(/\s+/," ").toLowerCase().slice(0,50),e==="pi"||e.length>=3?e:""}function _1(e){return R(this,null,function*(){if(e=encodeURIComponent(D1(e)),e in Mn)return Mn[e];let s=yield fetch(`/api/search?q=${e}`);return s.ok?Mn[e]=yield s.text():Mn[e]=""})}var H1=0,yp=0;function xp(e){return R(this,null,function*(){let s=H1+=1,t=yield _1(e);s<=yp||(yp=s,Dr.html=t)})}Ps==null||Ps.change(e=>{b.setCookie("search",e,60*60*24),setTimeout(()=>{Ps.value===e&&xp(e)},300)});Ps!=null&&Ps.value&&Xs.one("open",()=>xp(Ps.value));var Pp='<label class="target"><input maxlength="15" autocomplete="off" aria-label="Fill in this blank"></label>';function Sp(e){if(e.match("^[0-9]+/[0-9]+$")){let s=e.split("/");return+s[0]/+s[1]}else return mn(e)}var _r=class extends O{constructor(){super(...arguments);this.solution="";this.solutionNum=NaN;this.solutionDisplay="";this.range=0;this.input="";this.hint="";this.attempts=0;this.placeholder="???";this.done=!1}ready(){if(this.$input=this.$("input"),this.$target=this.$(".target"),this.solution=this.attr("solution"),this.solution.indexOf("\xB1")>=0){let t=this.solution.split("\xB1");this.solution=t[0].trim(),this.range=+t[1]}this.solutionNum=Sp(this.solution),this.solutionDisplay=this.solution,this.hint=this.attr("hint"),this.removeAttr("solution"),this.removeAttr("hint"),this.$input.setInputPattern(this.solution),this.hasAttr("placeholder")&&(this.placeholder=this.attr("placeholder")),this.$input.setAttr("placeholder",this.placeholder),this.removeAttr("placeholder"),this.$input.change(t=>{this.input=t,this.isCorrect&&(this.solve(),this.trigger("valid",t),this.moveCursor())}),this.$input.onKeyDown("enter",()=>this.$input.blur()),this.$input.on("focus",()=>{this.addClass("on"),this.removeClass("invalid"),this.$input.setAttr("placeholder"," ")}),this.$input.on("blur",()=>{if(this.removeClass("on"),this.setClass("invalid",!!this.input&&!this.done),this.$input.setAttr("placeholder",this.placeholder),this.input&&!this.done){this.attempts+=1;let t=this.attempts>=(this.hint?4:3)?`Hmmm\u2026 maybe try ${this.solution}?`:this.attempts>=2?this.hint:void 0;this.trigger("invalid",{hint:t})}})}setup(t,i,n){var r;this.goal=i,this.$step=t,(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(!0),this.one("valid",()=>{t.addHint("correct"),t.score(this.solvedBlank?this.solvedBlank.goal:i)}),this.on("invalid",o=>t.addHint(o.hint||"incorrect",{class:"incorrect"}))}get isCorrect(){if(this.done)return!0;if(this.linkedBlanks){let t=this.linkedBlanks.map(i=>i.solvedBlank);return this.solvedBlank=this.linkedBlanks.find(i=>{if(i.done&&!i.solvedBlank||t.includes(i))return!1;if(i.checkAnswer(this.input))return!0}),this.solvedBlank&&(this.solutionDisplay=this.solvedBlank.solution),!!this.solvedBlank}return this.checkAnswer(this.input)}checkAnswer(t){let i=Sp(t);return t.toLowerCase()===this.solution.toLowerCase()?!0:this.range&&Math.abs(i-this.solutionNum)<=this.range?(this.solutionDisplay=t,!0):P(i,this.solutionNum)||yi(i)===this.solution||t===yi(this.solutionNum)}moveCursor(){if(!this.$step)return;let t=this.$step.$blanks[this.$step.$blanks.indexOf(this)+1];!t||t.done||t.tagName==="X-BLANK-MC"||t.css("visibility")==="hidden"||!t.bounds.width||t.focus()}solve(t=!1){this.done=!0,this.$input.remove(),this.$target.html=this.solutionDisplay,this.addClass("done"),this.trigger("solve",{solution:this.solutionDisplay,restore:t})}focus(){this.$input.focus()}blur(){this.$input.blur()}};_r=N([V("x-blank",{template:Pp})],_r);var Tp='<span class="target" slot="target" tabindex="0" aria-label="Fill in this blank">???</span><div class="popup"><slot></slot></div>';var Hr=class extends O{constructor(){super(...arguments);this.done=!1}ready(){this.$target=this.$(".target"),this.$popup=this.$(".popup");let t=this.$popup.$$(".choice");this.solution=t[0].html,J.shuffle(He(t.length)).forEach(r=>{this.$popup.append(t[r]),t[r].on("click",()=>{this.removeClass("on"),t[r].blur(),r?(this.$target.html=t[r].html,this.addClass("invalid"),this.trigger("invalid")):(this.solve(),this.trigger("valid",this.solution))})});let n=this.$target.bounds.left+this.$popup.width>b.width-15;this.setClass("left",n),Ci(this,{enter:()=>{if(this.done)return;this.addClass("on");let r=this.$target.bounds,o=this.$popup.width,a=this.$popup.height,l=b.width-10-r.left,h=o<l,d=r.right-o>10,u=r.top+r.height+a>b.height-10;this.setClass("left",d&&!h),this.setClass("top",u),this.$popup.css("max-width",!d&&!h?`${l}px`:"none")},exit:()=>{this.removeClass("on")},delay:100,exitDelay:400,$clickTarget:this.$target})}setup(t,i,n){var r;(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(!0),this.one("valid",()=>{t.addHint("correct"),t.score(i)}),this.on("invalid",o=>t.addHint(o.hint||"incorrect",{class:"incorrect"}))}solve(t=!1){this.done=!0,this.$target.html=this.solution,this.removeClass("on invalid"),this.addClass("done"),this.trigger("solve",{solution:this.solution,restore:t}),setTimeout(()=>this.$popup.remove(),250),this.$target.removeAttr("tabindex")}};Hr=N([V("x-blank-mc",{template:Tp})],Hr);var Cp='<div class="text-area" contenteditable="true"></div><div class="toolbar"><button class="command" data-command="bold"><x-icon name="bold" size="20"></x-icon></button><button class="command" data-command="italic"><x-icon name="italic" size="20"></x-icon></button><button class="command" data-command="underline"><x-icon name="underline" size="20"></x-icon></button><div class="space"></div><button class="btn btn-green submit"><x-icon name="check"></x-icon> Done</button></div>';var Mp=40,Ep="free-text",Br=class extends O{setup(s,t,i){var h,d;let n=this.$(".text-area"),r=this.$(".toolbar .submit"),o=((h=i==null?void 0:i.data)==null?void 0:h[Ep])||"";o&&(n.html=o);for(let u of this.$$(".toolbar .command")){let f=u.data.command.split(":");u.on("click",()=>document.execCommand(f[0],!1,f[1]))}let a=o,l=_e(()=>{a!==o&&s.storeData(Ep,o),a=o},5e3);n.on("change keyup input paste",()=>{o=n.html.replace(/&nbsp;/g," ").trim().slice(0,500).trim(),r.setClass("invisible",o.length<Mp),l()}),(d=i==null?void 0:i.scores)!=null&&d.includes(t)?r.remove():(r.setClass("invisible",o.length<Mp),r.on("click",()=>{l(),s.score(t),r.exit("pop"),this.trigger("submit")}))}};Br=N([V("x-free-text",{template:Cp})],Br);var Ap='<div class="wrapper"><div class="panel"><slot></slot></div></div><div class="nav"><button class="btn back" aria-label="Previous Step"><x-icon name="left"></x-icon></button><button class="btn next" aria-label="Next Step"><x-icon name="right"></x-icon></button><div class="dots"></div></div>';var qr=class extends O{ready(){let s=this.$(".wrapper"),t=this.$(".panel"),i=t.children,n=this.$(".next"),r=this.$(".back"),o=this.$(".dots"),a=i.map(()=>c("div",{class:"dot"},o)),l=i.length,h=+this.attr("slide-width")||void 0,d=this.width,u=1,f=d,v=0,w=0,g=St=>{w=St,t.translate(St,0),this.trigger("move",St)},y=St=>{v=St;for(let[De,un]of a.entries())un.setClass("on",De>=St&&De<St+u);n.setClass("disabled",St===l-u),r.setClass("disabled",St===0),this.trigger("change",St)};b.onResize(()=>{d=this.width,u=h?Math.ceil(d/h):1,f=d/u;for(let St of i)St.css("width",f+"px");t.css("width",l*f+"px"),g(-v*f),y(v)});let C="quad",A=500,L,k,rt,_t,kl=!1,qc=()=>{L=Date.now()-_t,g(k+rt*ot(C,L/A)),!kl&&L<A?requestAnimationFrame(qc):this.trigger("slide-end")},Ol=St=>{kl=!1,L=0,k=w,rt=-St*f-w,_t=Date.now(),y(St),qc()};n.on("click",()=>{C="quad",v<l-u&&Ol(v+1)}),r.on("click",()=>{C="quad",v>0&&Ol(v-1)});let zc,Ll,Rl,lr;Fs(s,{start:St=>{kl=!0,zc=w,Ll=St.x,lr=Rl=Ll},move:St=>{Rl=lr,lr=St.x;let De=zc-Ll+St.x,un=-(l-u)*f,e0=De>0?De/4:De<un?un+(De-un)/4:De;g(e0),this.css("pointer-events","none")},end:()=>{let St=lr-Rl,De=St>12?1:St<-12?-1:0;C="quad-out",Ol(S(Math.round(-w/f-De),0,l-u)),setTimeout(()=>this.css("pointer-events","auto"))}})}};qr=N([V("x-gallery",{template:Ap})],qr);var Vp='<svg width="70" height="80"><path d="M20.5,7.4,27.2,24c-1.9-4.7,6-7.1,8-2.3l1.4,3.6c-1.9-4.8,6.1-7.1,8-2.3l1.3,3.1c-2-4.7,5.7-6.5,7.7-1.8,3.3,7.8,5.8,13.6,9,21.3S60.8,56.2,65,66.7L44.9,75A13.9,13.9,0,0,0,36,66.9c-7.7-2.2-11.4-8.3-18.4-14.3a44.2,44.2,0,0,0-9.5-6.5c-2.6-1.5-4.2-3.4-2.2-5.7,3.5-4.1,9.3-1.3,13.1,1.5,1.6,1.2,4.4,4.1,5.9,3.8s1.7-.8,1-2.6L12.8,10.5c-1.9-4.7,5.8-7.9,7.7-3.1Z"></path></svg>';function Sh(e,s){let t=s.positionLeft-e.positionLeft+s.width/2,i=s.positionTop-e.positionTop+s.height/2;return new p(t,i)}function kp(e){return e?new p(...e.split(",").map(s=>+s)):void 0}var zr=class extends O{constructor(){super(...arguments);this.doAnimation=!1}created(){this.slide=kp(this.attr("slide")),this.shift=kp(this.attr("offset"))}ready(){this.$target=G(this.attr("target")),this.$target&&(this.$target.on("click pointerdown focus",()=>this.stop()),this.hasAttr("start")&&this.start())}setTarget(t,i,n){this.$target=typeof t=="string"?G(t):t,i&&(this.slide=i),n&&(this.slide=n)}start(t){this.doAnimation||!this.from&&!this.$target||(this.doAnimation=!0,t&&(this.slide=t),this.slide||this.$end?this.runSlideAnimation():this.runClickAnimation())}startSlide(t,i){this.$target=t,this.$end=i,this.start()}stop(){this.doAnimation=!1}runSlideAnimation(){return R(this,null,function*(){this.show();let t=this.from||Sh(this,this.$target);this.shift&&(t=t.add(this.shift));let i=this.slide?t.add(this.slide):Sh(this,this.$end),n=`translate(${t.x-15}px,${t.y-10}px)`,r=`translate(${i.x-15}px,${i.y-10}px)`;yield this.animate({transform:[n+" scale(2)",n],opacity:[0,1]},300).promise,yield this.animate({transform:[n,r]},1e3).promise,yield this.animate({transform:[r,r+" scale(2)"],opacity:[1,0]},300).promise,this.hide(),setTimeout(()=>{this.doAnimation&&this.runSlideAnimation()},1e3)})}runClickAnimation(){return R(this,null,function*(){this.show();let t=this.from||Sh(this,this.$target);this.shift&&(t=t.add(this.shift));let i=`translate(${t.x-15}px,${t.y-10}px)`;yield this.animate({transform:[i+" scale(2)",i],opacity:[0,1]},500).promise,yield this.animate({transform:[i,i+" scale(2)"],opacity:[1,0]},500,200).promise,this.hide(),setTimeout(()=>{this.doAnimation&&this.runClickAnimation()},1e3)})}};zr=N([V("x-gesture",{template:Vp})],zr);var Th='<span class="target" tabindex="0"><slot></slot></span><div class="popup"></div>';var B1=JSON.parse(G("#glossary").text),q1=JSON.parse(G("#bios").text),Ch=600,jr;b.onResize(()=>{jr&&jr.hide()});var En=class extends O{ready(){this.xid=this.attr("xid"),this.$target=this.$(".target"),this.$popup=this.$(".popup"),this.$popup.html=this.body()||"",this.setClass("left",b.width>Ch&&this.$target.bounds.left+this.$popup.width>b.width-15),Ci(this,{enter:()=>this.show(),exit:()=>this.hide(),delay:100,exitDelay:200,$clickTarget:this.$target,canFocusWithin:!0,preventMouseover:()=>b.width<=Ch})}show(){if(jr=this,this.addClass("on"),b.width<=Ch){let a=G("#glossary-modal");return a.$(".modal-body").html=this.body(),a.open()}let t=this.$target.bounds,i=this.$popup.width,n=this.$popup.height,r=t.top+t.height+n<b.height-10,o=t.top-n>54;this.setClass("top",o&&!r),this.setClass("left",t.left+i>b.width-15)}hide(){jr=void 0,this.removeClass("on")}body(){let t=B1[this.xid];if(!t)return console.warn("missing gloss:",this.xid);let i=t.text;return t.image&&(i+=`<img class="gloss-img" alt="" src="/content/shared/glossary/${t.image}"/>`),t.link&&(location.pathname===t.link.split("#")[0]||(i+=`<p><a href="${t.link}" class="btn btn-white btn-small">Learn more\u2026</a></p>`)),i}};En=N([V("x-gloss",{template:Th})],En);var Fr=class extends En{body(){let s=q1[this.xid];if(!s)return console.warn("missing bio:",this.xid);let t=`<img class="bio-img" alt="" src="/content/shared/bios/${this.xid}.jpg"/>`,i=s.born?`<p><a href="/timeline/${this.xid}" class="btn btn-white btn-small" target="_blank">Timeline</a></p>`:"";return(s.image===!1?"":t)+s.bio+i}};Fr=N([V("x-bio",{template:Th})],Fr);var Op='<div class="wrap"><img alt=""><div class="credit"></div><button class="zoom"><x-icon name="fullscreen" size="24"></x-icon></button><slot></slot></div>';var z1=document.createElement("a").relList.supports("ar"),Zr=!1,Mh={x:0,y:0,s:1},Lp,Ys=c("div",{class:"lightbox-overlay"},Z),hs=c("div",{class:"lightbox-img"},Ys);function F1(e,s,t){Zr=!0,Lp=e,Ys.show(),hs.show();let i=e.bounds,n=hs.bounds,r=i.left+i.width/2-n.left-n.width/2,o=i.top+i.height/2-n.top-n.height/2,a=Math.max(i.width/n.width,i.height/n.height);Mh={x:r,y:o,s:a},hs.css("background-image",`url(${t}), url(${s})`),hs.css("transform",`translate(${r}px, ${o}px) scale(${a})`),b.redraw(),hs.addClass("transitions"),b.redraw(),e.css("visibility","hidden"),Ys.addClass("on"),hs.css("transform","scale(1) translate(0,0)")}function Rp(){!Zr||(Zr=!1,Ys.removeClass("on"),hs.setTransform(Mh,0,Mh.s),setTimeout(()=>{Lp.css("visibility","visible"),Ys.css("display","none"),hs.css("transform","none"),hs.removeClass("transitions")},400))}Ys.on("click touchmove",Rp);b.onKey("escape",Rp);Ys.on("scrollwheel touchmove",e=>{e.preventDefault(),e.stopPropagation()});b.onKey("space up down left right pagedown pageup",e=>{Zr&&(e.preventDefault(),e.stopPropagation())});var Ur=class extends O{ready(){let s=this.attr("src"),t=this.$(".wrap"),i=this.attr("width"),n=this.attr("height");this.css("width",i+"px"),t.css("padding-bottom",+n/+i*100+"%");let r=t.$("img");r.setAttr("src",s),r.setAttr("alt",this.attr("alt")||""),r.setAttr("width",i),r.setAttr("height",n),s.endsWith(".gif")&&r.on("click",()=>r.setAttr("src",s));let o=t.$(".credit"),a=this.attr("credit");a?o.text=a:o.remove();let l=t.$(".zoom");if(this.hasAttr("lightbox")){this.addClass("interactive");let h=s.replace(/\.(?=[^.]*$)/,"-large.");this.on("click",()=>F1(this,s,h))}else l.remove();if(z1&&this.hasAttr("ar")){let h=c("a",{href:this.attr("ar"),rel:"ar"});t.prepend(h),h.append(r)}}};Ur=N([V("x-img",{template:Op})],Ur);var Wr=class extends O{constructor(){super(...arguments);this.correctCount=0;this.solvedCount=0;this.isSolved=!1}setup(t,i,n){var l;let r=this.children,o=r.map(()=>!1);for(let[h,d]of r.entries()){let u=d.data.error,f=u?"incorrect":"correct";u||(this.correctCount+=1),d.one("click",()=>{o[h]||this.isSolved||(t.addHint(u||"correct",{class:f}),d.addClass(f),u||(this.solvedCount+=1,t.score("picker-"+h),this.checkSolved()))})}let a=((l=n==null?void 0:n.scores)==null?void 0:l.filter(h=>h.startsWith("picker-")))||[];for(let h of a){let d=+h.slice(7);o[d]=!0,r[d].addClass("correct")}this.solvedCount=a.length,this.checkSolved()}checkSolved(){this.solvedCount<this.correctCount||(this.addClass("solved"),this.isSolved=!0)}};Wr=N([V("x-picker")],Wr);var Ip='<button class="play" aria-label="Play Slider"><x-icon name="play" size="32"></x-icon></button><div class="bar"><div class="knob"></div></div>';var Kr=class extends O{constructor(){super(...arguments);this.current=0}ready(){this.onAttr("steps",a=>this.steps=+a),this.speed=+this.attr("speed")||1;let t=this.$(".bar"),i=this.$(".knob"),n=this.$(".play");this.hasAttr("no-play")?n.remove():n.on("click",()=>this.play());let r=this.hasAttr("continuous"),o=this.hasAttr("snap")?t.width/this.steps:.001;this.drag=new Ws(i,{moveY:!1,snap:o}),this.drag.on("start",()=>{this.animation&&this.animation.cancel(),this.animation=void 0}),this.drag.on("move",({posn:a})=>{let l=a.x/this.drag.bounds.dx*this.steps;r||(l=Math.round(l)),!P(l,this.current)&&(this.current=l,this.trigger("move",l))}),this.drag.on("end",()=>this.trigger("slide-end"))}setup(t,i){this.bindModel(t.model),this.one("slide-end",()=>t.score(i))}set(t){P(t,this.current)||this.drag.setPosition(t*this.drag.bounds.dx/this.steps,0)}play(){return R(this,null,function*(){this.current>=this.steps&&this.set(0);let t=(1-this.current/this.steps)*3e3/this.speed;this.moveTo(this.steps,t)})}moveTo(t,i=600){return R(this,null,function*(){if(this.animation||t===this.current)return;let n=this.current;this.animation=K(r=>{this.set(n+(t-n)*ot("quad",r))},i),yield this.animation.promise,this.animation=void 0,this.trigger("slide-end")})}bindVariable(t,i){t[i]=0,this.on("move",n=>t[i]=n),t.watch(()=>this.set(t[i]))}};Kr=N([V("x-slider",{template:Ip})],Kr);var Np='<slot name="stage"></slot><div class="nav"><button class="btn back disabled" aria-label="Previous Step"><x-icon name="left" size="24"></x-icon></button><button class="btn next" aria-label="Next Step"><x-icon name="right" size="24"></x-icon></button><div class="dots"></div></div><div class="legend-box"><slot></slot></div>';function j1(e){let s=e.$$("x-blank, x-blank-mc");if(!s.length)return Promise.resolve();let t=0;return new Promise(i=>{for(let n of s)n.on("solve",()=>{t+=1,t>=s.length&&i()})})}var Xr=class extends O{constructor(){super(...arguments);this.length=0;this.current=0;this.locked=!1}ready(){this.$legend=this.$(".legend-box"),this.$steps=this.$legend.children,this.$back=this.$(".back"),this.$next=this.$(".next");let t=this.$(".dots");this.$dots=this.$steps.map(()=>c("div",{class:"dot"},t)),this.length=this.$steps.length,this.current=0,this.$back.on("click",()=>this.goBack()),this.$next.on("click",()=>this.goNext()),this.blanks=this.$steps.map(i=>j1(i)),this.reveals=this.$$("[slide]").map(i=>{let n=i.attr("slide").split("-"),r=n.length>1?[+n[0]||0,+n[1]||this.length]:[+n[0],+n[0]],o=[i.data.animation||"fade",+i.data.duration||400];return i.data.display="visibility",r[0]>=0&&!i.hasClass("reveal")&&i.hide(),[i,r,o]}),this.autoAdvance=this.attr("step")==="auto",this.$steps[0].show(),this.$dots[0].addClass("on"),this.setupSlide(0)}setup(t,i,n){var o;let r=(o=n==null?void 0:n.scores)==null?void 0:o.filter(a=>a.startsWith("slide-")).length;if(r&&r<this.$steps.length-1){this.go(r);for(let a=1;a<=r;++a)this.trigger("next",a)}this.on("next",a=>t.score("slide-"+(a-1)))}go(t){if(this.locked||t<0||t>this.length-1||t===this.current)return;this.locked=!0,setTimeout(()=>this.locked=!1,600),this.$back.setClass("disabled",t===0),this.$next.setClass("disabled",t===this.length-1),this.$dots[this.current].removeClass("on"),this.$dots[t].addClass("on"),this.$steps[t].show();let i=this.$steps[t].height+"px";this.$steps[t].hide(),this.$steps[this.current].exit("fade",300).promise.then(()=>this.$steps[t].enter("fade",300)),this.$legend.animate({height:i},600).promise.then(()=>this.$legend.css("height","auto")),this.setupSlide(t),this.current=t,this.trigger("step",t)}setupSlide(t){this.$next.setAttr("disabled","true"),this.blanks[t].then(()=>this.$next.removeAttr("disabled"));for(let[i,n,r]of this.reveals){if(i.hasClass("reveal"))continue;let o=i.css("visibility")!=="hidden",a=t>=n[0]&&t<=n[1];a&&!o&&i.enter(...r,300),!a&&o&&i.exit(...r)}}goNext(){this.locked||(this.go(this.current+1),this.trigger("next",this.current))}goBack(){this.locked||(this.go(this.current-1),this.trigger("back",this.current))}};Xr=N([V("x-slideshow",{template:Np})],Xr);var Yr=class extends O{ready(){var v,w;(v=G(".sidebar-toggle"))==null||v.on("click",()=>this.addClass("open")),(w=G(".sidebar-shadow"))==null||w.on("pointerdown",()=>this.removeClass("open"));let s=G("#feedback form"),t=G("#feedback button"),i=G("#feedback .error"),n=G("#feedback-success"),r=G('#feedback textarea[name="message"]'),o=G("x-course").id;s==null||s.on("submit",g=>{g.preventDefault(),t.setAttr("disabled","true"),i.hide(),ls(`/course/${o}/feedback`,s.formData).then(()=>{n.open(),r.value=""}).catch(()=>i.show()).then(()=>t.removeAttr("disabled"))});let a=JSON.parse(G("#glossary").text),l=G("#glossary-search"),h=l.$(".gloss-body"),d=l.$(".gloss-list"),u=l.$(".gloss-search input"),f;for(let g of Object.keys(a).sort()){let y=a[g],C=c("div",{class:"gloss-item",html:y.title,tabindex:0},d);C.on("click",()=>{f&&f.removeClass("on"),f=C,C.addClass("on"),h.html=y.text});let A=y.title.toLowerCase();u.change(L=>C.setClass("hidden",!!L&&A.indexOf(L.toLowerCase())<0))}}};Yr=N([V("x-course-sidebar")],Yr);function Eh(e,s){let t=ws(e.map(i=>i.h+10));for(let[i,n]of e.entries())n.drag.bounds=new kt(0,0,0,_(t)),n!==s&&n.drag.setPosition(0,t[i-1]||0)}function U1(e){return e.every((s,t)=>s.index===t)||e.every((s,t)=>s.index===e.length-t-1)}var Qr=class extends O{ready(){this.items=this.children.map(t=>({drag:new Ws(t,{moveX:!1,useTransform:!0}),index:+t.data.index,h:0}));for(let t of this.children)t.removeAttr("data-index");for(let t of this.items)t.drag.on("drag",()=>{this.items=Ds(this.items,i=>i.drag.position.y-(i===t?10:0)),Eh(this.items,t)}),t.drag.on("end",()=>{Eh(this.items),U1(this.items)&&this.solve()});b.onResize(()=>{for(let i of this.items)i.h=i.drag.$el.height;let t=q(this.items.map(i=>i.h));this.css("height",t+this.items.length*10-10+"px"),Eh(this.items)})}setup(t,i,n){var r;(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(),this.one("solve",()=>{t.addHint("correct"),t.score(i)})}solve(){this.trigger("solve"),this.addClass("solved");for(let t of this.items)t.drag.disabled=!0}};Qr=N([V("x-sortable")],Qr);function Gp(e,s=!1){return R(this,null,function*(){if(e.css("visibility")==="visible")return;e.data.display="visibility";let t=+e.data.duration||400,i=(s?0:600)+(+e.data.delay||0);yield e.enter(e.data.animation||"fade",t,i).promise,e.css({opacity:"",transform:""}),e.trigger("reveal"),e.removeClass("reveal")})}var Jr=class extends O{constructor(){super(...arguments);this.model=mt({});this.isShown=!1;this.isCompleted=!1;this.scores=new Set}ready(){var i,n,r,o;this.$course=this.parents("x-course")[0],this.$blanks=this.$$("x-blank, x-blank-mc"),this.$components=this.$$("[goal]"),this.userData=(r=(n=(i=this.$course)==null?void 0:i.userData)==null?void 0:n.steps)==null?void 0:r[this.id],this.goals=lt(this.attr("goals")),this.$reveals=this.$$(".reveal");let t=this.$$(".check[data-when]");for(let a of[...this.$reveals,...t])this.onScore(a.data.when,()=>Gp(a));this.$nextBtn=this.$$(".next-step");for(let[a,l]of this.$nextBtn.entries())this.onScore("next-"+a,()=>l.exit("pop")),l.one("click",()=>this.score("next-"+a));for(let a of this.$$(".step-target"))a.tagName!=="X-TARGET"&&Ci(a,{enter:()=>{let l=this.$$('[target~="'+a.data.to+'"]');for(let h of l)h.addClass("focus");this.addClass("focus"),this.trigger("target-focus",{$targets:l})},exit:()=>{for(let l of this.$$(".focus"))l.removeClass("focus");this.removeClass("focus")}});for(let a of this.$$(".var, .var-action"))a.bindModel(this.model);(o=this.$course)!=null&&o.audio&&(this.narration=new kr(this.$course.audio,this))}show(){var n,r,o;if(this.isShown)return;this.isShown=!0,(n=StepFunctions==null?void 0:StepFunctions[dr(this.id)])==null||n.call(StepFunctions,this);for(let a of this.$components)a.setup(this,a.attr("goal"),this.userData);let t=((r=this.userData)==null?void 0:r.scores)||[];for(let a of t)this.score(a,!1);let i=this.$$("x-gesture[target]");setTimeout(()=>{if(!this.isReady)for(let a of i)a.start()},2e3),(o=this.$course)==null||o.log("Step","show",this.id),this.trigger("show"),this.addClass("on"),this.narration&&setTimeout(()=>this.narration.play(),400)}complete(){if(!this.isCompleted){this.isShown||this.show(),this.isCompleted=!0;for(let t=0;t<this.$nextBtn.length;++t)this.score("next-"+t);for(let t of this.$reveals)t.parents("svg").length||Gp(t,!0);this.trigger("complete")}}get isReady(){return this.goals.every(t=>this.scores.has(t))}get isPageLoaded(){return this.$course?this.$course.isReady:!0}score(t,i=!0){this.scores.has(t)||(this.scores.add(t),this.trigger("score-"+t),this.trigger("score"),this.$course&&(this.$course.trigger("score"),this.$course.saveProgress({steps:{[this.id]:{scores:[t]}}}),this.$course.log("Step","score",this.id+"/"+t)),i&&this.isReady&&this.$course&&this.$course.isReady&&setTimeout(()=>{this.$course.$activeStep===this&&this.$course.nextStep()},1200))}storeData(t,i){var n;(n=this.$course)==null||n.saveProgress({steps:{[this.id]:{data:{[t]:i}}}})}onScore(t,i){let n=lt(t);if(n.every(a=>this.scores.has(a)))return i&&i(),Promise.resolve();let r=vs(),o=()=>{!n.every(a=>this.scores.has(a))||(i&&i(),r.resolve(),this.off("score",o))};return this.on("score",o),r.promise}addHint(t,i={}){var n,r,o;return this.trigger("hint",t),(n=this.$course)!=null&&n.isReady?this.isInViewport?(r=this.$course.$tutor)==null?void 0:r.showHint(t,i):(this.one("enterViewport",()=>{var a;return(a=this.$course.$tutor)==null?void 0:a.showHint(t,i)}),{text:((o=this.$course.$tutor)==null?void 0:o.hints[t])||t}):{text:t}}delayedHint(t,i=1e4){let n=setTimeout(t,i);this.on("score",()=>{clearTimeout(n),this.isCompleted||(n=setTimeout(t,i))}),this.on("complete",()=>clearTimeout(n))}get nextStep(){if(!this.$course)return;let t=this.$course.$steps.indexOf(this);return this.$course.$steps[t+1]}groupBlanks(...t){let i=t.map(n=>this.$blanks[n]);for(let n of i)n.linkedBlanks=i}};Jr=N([V("x-step")],Jr);var Z1='<div class="titles"></div><div class="body"><slot></slot></div>',to=class extends O{constructor(){super(...arguments);this.$titles=[];this.active=0}ready(){let t=this.$(".titles");this.$body=this.$(".body"),this.$tabs=this.$$(".tab");for(let i=0;i<this.$tabs.length;++i){let n=this.$tabs[i].$("h3")||c("h3");n.setAttr("tabindex","0"),t.append(n),this.$titles.push(n),n.on("click",()=>this.makeActive(i))}this.$titles[0].addClass("active"),this.$tabs[0].show()}makeActive(t){if(this.active===t)return;this.$titles[this.active].removeClass("active"),this.$titles[t].addClass("active"),this.$tabs[t].show();let i=this.$tabs[t].outerHeight+"px";this.$tabs[t].hide(),this.$tabs[this.active].exit("fade",300).promise.then(()=>this.$tabs[t].enter("fade",300)),this.$body.animate({height:i},600).promise.then(()=>this.$body.css("height","auto")),this.active=t,this.trigger("change",t)}};to=N([V("x-tabbox",{template:Z1})],to);var Dp='<defs><mask id="masking"><rect width="100%" height="100%" fill="white"></rect></mask></defs><marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><rect x="0" y="0" width="100%" height="100%" mask="url(#masking)" opacity="0.8"></rect><path class="target-arrow" stroke-width="5" marker-end="url(#arrow)" opacity="0.4" stroke-linecap="round"></path>';function W1(e,s,t,i){let n=new p(e.left-15,e.top+t-15),r=new x(n,e.width+30,e.height+30),o=new p(s.left-15,s.top+i-15),a=new x(o,s.width+30,s.height+30),l=new it(r.center,a.center);return[ft(l,r)[0],ft(l,a)[0]]}function K1(e,s){return Math.abs(e[0]-s[0])+Math.abs(e[1]-s[1])}var _p=Fe("header, x-tutor, .sidebar"),Oi=c("svg",{class:"target-body",html:Dp},Z),X1=Oi.$("mask"),Y1=Oi.$(".target-arrow"),ki=!1,Hp=[],eo=class extends O{ready(){this.setAttr("tabindex",0);let s=this.attr("to").replace(/_/g," "),t=this.hasClass("no-margins"),i,n,r,o,a=()=>{ki=!0;let u=Fe(s);if(!u.length)return;let f=u[0].hasParent(..._p);i===void 0&&(i=this.hasParent(..._p));let v=this.bounds,w=u.map(g=>g.bounds).filter(g=>g.width||g.height);if(r=0,!f){let g=Math.min(...w.map(L=>L.top)),y=Math.max(...w.map(L=>L.top+L.height)),C=b.height-12-y,A=56-g;r=C<0?C:A>0?A:0}for(let g of Hp)g.remove();Hp=[v,...w].map((g,y)=>{let C=!y||t?4:10;return c("rect",{x:g.left-C,y:g.top-C+(y||!i?r:0),width:g.width+2*C,height:g.height+2*C,rx:y?4:18,ry:y?4:18},X1)}),Y1.points=W1(v,w[0],i?0:r,f?0:r)},l=()=>{r&&Z.scrollBy(-r,300),Oi.css("display","block"),b.redraw(),Ae(function(){Oi.css("opacity",1)},r?300:0)},h=u=>{!ki||u&&Y(u.type,"mousemove","pointermove")&&K1(n,[u.clientX,u.clientY])<40||(clearTimeout(o),ki=!1,Oi.css("opacity",0),setTimeout(()=>{ki||Oi.css("display","none")},300),Z.off("mousewheel mousemove touchend touchmove",h),this.off("mouseleave blur",h))},d=()=>{r&&!i?Z.on("mousemove",h):this.on("mouseleave",h),Z.on("mousewheel touchend touchmove",h),this.on("blur",h)};this.on("mouseenter touchstart focus",u=>{n=[u.clientX,u.clientY],a(),o=window.setTimeout(l,r?50:30),d()}),this.on("click",u=>{ki?(u.handled=!0,h(),setTimeout(()=>G(s).trigger("click mousedown"))):(ki=!0,r=0,l(),d())})}};eo=N([V("x-target")],eo);var tt=class extends Error{constructor(e,s){super(s),this.name=e}static undefinedVariable(e){return new tt("EvalError",`Undefined variable \u201C${e}\u201D.`)}static undefinedFunction(e){return new tt("EvalError",`Undefined function \u201C${e}\u201D.`)}static uncallableExpression(e){return new tt("EvalError",`Cannot call \u201C${e}\u201D.`)}static evalLoop(e){return new tt("EvalError",`Loop in nested evaluation \u201C${e}\u201D.`)}static invalidCharacter(e){return new tt("SyntaxError",`Unknown symbol \u201C${e}\u201D.`)}static conflictingBrackets(e){return new tt("SyntaxError",`Conflicting brackets \u201C${e}\u201D.`)}static unclosedBracket(e){return new tt("SyntaxError",`Unclosed bracket \u201C${e}\u201D.`)}static startOperator(e){return new tt("SyntaxError",`A term cannot start with a \u201C${e}\u201D.`)}static endOperator(e){return new tt("SyntaxError",`A term cannot end with a \u201C${e}\u201D.`)}static consecutiveOperators(e,s){return new tt("SyntaxError",`A \u201C${e}\u201D cannot be followed by a \u201C${s}\u201D.`)}static invalidExpression(){return new tt("SyntaxError","This expression is invalid.")}},Nh={pi:Math.PI,\u03C0:Math.PI,e:Math.E},Oh={"(":")","[":"]","{":"}"},Ii={"*":"\xB7","**":"\u2217","//":"//","+-":"\xB1","\u2013":"\u2212","-":"\u2212",xx:"\xD7",sum:"\u2211",prod:"\u220F",int:"\u222B",del:"\u2202",grad:"\u2207",aleph:"\u2135",not:"\xAC",AA:"\u2200",EE:"\u2203","'":"\u2019","!=":"\u2260","<=":"\u2264",">=":"\u2265",in:"\u2208","!in":"\u2209","==":"\u2261","~=":"\u2245","~~":"\u2248",sub:"\u2282",sube:"\u2286",prop:"\u221D",oo:"\u221E",cap:"\u2229",cup:"\u222A","<-":"\u2190","->":"\u2192","=>":"\u21D2","<=>":"\u21D4","|->":"\u21A6",uarr:"\u2191",darr:"\u2193",lArr:"\u21D0"},Ts={Gamma:"\u0393",Delta:"\u0394",Theta:"\u0398",Lambda:"\u039B",Xi:"\u039E",Pi:"\u03A0",Sigma:"\u03A3",Phi:"\u03A6",Psi:"\u03A8",Omega:"\u03A9",alpha:"\u03B1",beta:"\u03B2",gamma:"\u03B3",delta:"\u03B4",epsilon:"\u025B",zeta:"\u03B6",eta:"\u03B7",theta:"\u03B8",iota:"\u03B9",kappa:"\u03BA",lambda:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",pi:"\u03C0",rho:"\u03C1",sigma:"\u03C3",tau:"\u03C4",upsilon:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",omega:"\u03C9",CC:"\u2102",NN:"\u2115",QQ:"\u211A",RR:"\u211D",ZZ:"\u2124"},Kp="abcdefghijklmnopqrstuvwxyz",Q1=Kp.split(""),J1=Kp.toUpperCase().split(""),t2=Object.values(Ts),e2=[...Q1,...J1,...t2,"$"],s2="|()[]{}\xF7,!<>=*/+-\u2013\u2212~^_\u2026\xB0\u2022\u2225\u22A5'\u2220:%\u223C\u25B3",i2=Object.values(Ii),n2=[...s2,...i2],r2={_:"sub","^":"sup","//":"/","\xF7":"/"},Bp={"<":"&lt;",">":"&gt;"};function Xp(e){return e in Bp?Bp[e]:e}var o2=["abs","round","floor","ceil","max","min","mod","lcm","gcd","gcf","log","exp","ln","sqrt","root","sin","cos","tan","sec","csc","cot","cosec","cotan","arcsin","arccos","arctan","sinh","cosh","tanh","sech","csch","coth","cosech"];function ti(e){return o2.includes(e)}var Ni={"+":"plus","\u2212":"minus","\xB7":"times","\xD7":"times","/":"over","//":"divided by","%":"percent","!":"factorial","\xB1":"plus-minus","=":"equals","\u2260":"does not equal","<":"is less than",">":"is greater than","\u2264":"is less than or equal to","\u2265":"is greater than or equal to",\u03C0:"pi","\u2245":"is congruent to","\u2225":"is parallel to","\u22A5":"is perpendicular to"};for(let e of Object.keys(Ts))Ni[Ts[e]]=e;var Yp=e=>typeof e=="number"?e:e[0],Qp=e=>typeof e=="number"?[e,e]:e,Cs=class{evaluate(e={},s){return NaN}interval(e={},s){return Qp(this.evaluate(e))}substitute(e={}){return this}recursiveSubstitute(e){let s=Object.keys(e);return this.unknowns.filter(t=>s.includes(t)).length?this.substitute(e).recursiveSubstitute(e):this}get simplified(){return this}get unknowns(){return this.variables.filter(e=>!Object.prototype.hasOwnProperty.call(Nh,e))}get variables(){return[]}get functions(){return[]}collapse(){return this}toString(){return""}toVoice(e={}){return""}toMathML(e={}){return""}},Ah=new Set;function Lh(e,s,t=!1){var i;let n=(i=s[e])!=null?i:Nh[e];if(n===void 0)throw tt.undefinedVariable(e);if(typeof n=="string"||n instanceof Cs){if(t||Ah.clear(),Ah.has(e))throw tt.evalLoop(e);return Ah.add(e),typeof n=="string"&&(n=Ot.parse(n)),n.evaluate(s,!0)}else return typeof n=="function"?n():n}var cs=class extends Cs{constructor(e){super(),this.n=e}evaluate(){return this.n}toString(){return`${this.n}`}toVoice(){return`${this.n}`}toMathML(){return`<mn>${this.n}</mn>`}},Gi=class extends Cs{constructor(e){super(),this.i=e}evaluate(e={},s){return Yp(Lh(this.i,e,s))}interval(e={},s){return Qp(Lh(this.i,e,s))}toMathML(){return`<mi${ti(this.i)?' mathvariant="normal"':""}>${this.i}</mi>`}substitute(e={}){return e[this.i]||this}get variables(){return[this.i]}toString(){return this.i}toVoice(){return this.i in Ni?Ni[this.i]:this.i.length===1?`_${this.i}_`:this.i}},a2=class extends Cs{constructor(e){super(),this.s=e}evaluate(e={},s){return Yp(Lh(this.s,e,s))}toString(){return`"${this.s}"`}toVoice(){return this.s}toMathML(){return`<mtext>${this.s}</mtext>`}},Jp=class extends Cs{toString(){return" "}toMathML(){return"<mspace></mspace>"}},Ke=class extends Cs{constructor(e){super(),this.o=e}toString(){return this.o.replace("//","/")}toVoice(){return Ni[this.o]||this.o}get functions(){return[this.o]}toMathML(){let e=Xp(this.toString());return`<mo value="${e}">${e}</mo>`}},qp=[-1/0,1/0],Ri=[NaN,NaN],Qs=Math.PI/2,Rh=Math.PI*2,xt=(e,s)=>[e-Number.EPSILON,s+Number.EPSILON],Js=(...e)=>xt(Math.min(...e),Math.max(...e)),l2=e=>Math.abs(e[1]-e[0]);var Li=e=>isNaN(e[0])||isNaN(e[1]),zp=e=>!isFinite(e[0])&&e[0]===e[1],h2=(e,s)=>st(s,e[0]-Number.EPSILON,e[1]+Number.EPSILON),no=e=>h2(e,0),We={add:(...e)=>e.reduce((s,t)=>s+t,0),sub:(...e)=>e.length>1?e[0]-e[1]:-e[0],mul:(...e)=>e.reduce((s,t)=>s*t,1),div:(e,s)=>e/s,abs:e=>Math.abs(e),round:e=>Math.round(e),floor:e=>Math.floor(e),ceil:e=>Math.ceil(e),max:(...e)=>Math.max(...e),min:(...e)=>Math.min(...e),mod:(e,s)=>e%s,lcm:(...e)=>Hs(...e),gcd:(...e)=>ys(...e),gcf:(...e)=>ys(...e),sup:(e,s)=>Math.pow(e,s),log:(e,s)=>Math.log(e)/(s===void 0?1:Math.log(s)),exp:e=>Math.exp(e),ln:e=>Math.log(e),sqrt:e=>Math.sqrt(e),root:(e,s)=>Math.pow(e,1/s),sin:e=>Math.sin(e),cos:e=>Math.cos(e),tan:e=>Math.tan(e),sec:e=>1/Math.cos(e),csc:e=>1/Math.sin(e),cot:e=>1/Math.tan(e),cosec:e=>We.csc(e),cotan:e=>We.cot(e),arcsin:e=>Math.asin(e),arccos:e=>Math.acos(e),arctan:e=>Math.atan(e),sinh:e=>Math.sinh(e),cosh:e=>Math.cosh(e),tanh:e=>Math.tanh(e),sech:e=>1/Math.cosh(e),csch:e=>1/Math.sinh(e),coth:e=>1/Math.tanh(e),cosech:e=>We.csch(e)};function so(e,s){if(e[0]>0)return s[0]>=0?xt(e[0]**s[0],e[1]**s[1]):Js(e[0]**s[0],e[0]**s[1],e[1]**s[0],e[1]**s[1]);let t=s[0];return Number.isInteger(t)&&t===s[1]?t===0?[no(e)?0:1,1]:t%2?xt(e[0]**t,e[1]**t):no(e)?[0,Math.max(e[0]**t,e[1]**t)]:Js(e[1]**t,e[0]**t):Ri}function Fp(e,s=Rh){let t=Math.floor(e[0]/s)*s;return[e[0]-t,e[1]-t]}var Q={add:(...e)=>xt(q(e.map(s=>s[0])),q(e.map(s=>s[1]))),sub:(e,s)=>s!==void 0?xt(e[0]-s[1],e[1]-s[0]):xt(-e[1],-e[0]),mul:(e,...s)=>(s.length>1&&(s=[Q.mul(...s)]),Js(e[0]*s[0][0],e[0]*s[0][1],e[1]*s[0][0],e[1]*s[0][1])),div:(e,s)=>no(s)?qp:Js(e[0]/s[0],e[0]/s[1],e[1]/s[0],e[1]/s[1]),abs:e=>no(e)?xt(0,Math.max(-e[0],e[1])):Js(Math.abs(e[0]),Math.abs(e[1])),round:e=>xt(Math.round(e[0]),Math.round(e[1])),floor:e=>xt(Math.floor(e[0]),Math.floor(e[1])),ceil:e=>xt(Math.ceil(e[0]),Math.ceil(e[1])),max:(...e)=>xt(Math.max(...e.map(s=>s[0])),Math.max(...e.map(s=>s[1]))),min:(...e)=>xt(Math.min(...e.map(s=>s[0])),Math.min(...e.map(s=>s[1]))),mod:(e,s)=>{if(Li(e)||Li(s))return Ri;let t=e[0]/(e[0]<0?s[0]:s[1]);return t=t<0?Math.ceil(t):Math.floor(t),Q.sub(e,Q.mul(s,[t,t]))},lcm:(...e)=>Js(Hs(...e.map(s=>s[0]))),gcd:(...e)=>Js(ys(...e.map(s=>s[0]))),gcf:(...e)=>Q.gcd(...e),sup:(e,s)=>so(e,s),log:(e,s)=>(s!==void 0&&Q.div(Q.log(e),Q.log(s)),xt(e[0]<=0?-1/0:Math.log(e[0]),Math.log(e[1]))),exp:e=>so([Math.E,Math.E],e),ln:e=>Q.log(e),sqrt:e=>so(e,[.5,.5]),root:(e,s)=>so(e,Q.div([1,1],s)),sin:e=>Q.cos(Q.sub(e,[Qs,Qs])),cos:e=>Li(e)||zp(e)?Ri:l2(e)>=Rh-Number.EPSILON?[-1,1]:(e=Fp(e),e[0]>Math.PI+Number.EPSILON?Q.sub(Q.cos(Q.sub(e,[Math.PI,Math.PI]))):e[1]<Math.PI-Number.EPSILON?xt(Math.cos(e[1]),Math.cos(e[0])):e[1]<Rh-Number.EPSILON?xt(-1,Math.max(Math.cos(e[1]),Math.cos(e[0]))):xt(-1,1)),tan:e=>Li(e)||zp(e)?Ri:(e=Fp(e,Math.PI),e[0]>Qs+Number.EPSILON&&(e=Q.sub(e,[Math.PI,Math.PI])),e[0]<-Qs+Number.EPSILON||e[1]>Qs-Number.EPSILON?qp:xt(Math.tan(e[0]),Math.tan(e[1]))),sec:e=>Q.div([1,1],Q.cos(e)),csc:e=>Q.div([1,1],Q.sin(e)),cot:e=>Q.div([1,1],Q.tan(e)),cosec:e=>Q.csc(e),cotan:e=>Q.cot(e),arcsin:e=>Li(e)||e[1]<-1||e[0]>1?Ri:xt(e[0]<=-1?-Qs:Math.asin(e[0]),e[1]>=1?Qs:Math.asin(e[1])),arccos:e=>Li(e)||e[1]<-1||e[0]>1?Ri:xt(e[1]>=1?0:Math.acos(e[1]),e[0]<=-1?Math.PI:Math.acos(e[0])),arctan:e=>xt(Math.atan(e[0]),Math.atan(e[1])),sinh:e=>xt(Math.sinh(e[0]),Math.sinh(e[1])),cosh:e=>e[1]<0?xt(Math.cosh(e[1]),Math.cosh(e[0])):e[0]>0?xt(Math.cosh(e[0]),Math.cosh(e[1])):xt(1,Math.cosh(Math.max(-e[0],e[1]))),tanh:e=>xt(Math.tanh(e[0]),Math.tanh(e[1])),sech:e=>Q.div([1,1],Q.cosh(e)),csch:e=>Q.div([1,1],Q.sinh(e)),coth:e=>Q.div([1,1],Q.tanh(e)),cosech:e=>Q.csch(e)},io=lt("+ \u2212 * \xD7 \xB7 / \xF7 // sup sub subsup"),jp=lt("sub sup subsup"),Vh='<mo value="," lspace="0">,</mo>';function tu(e,s){return io.includes(s)?e instanceof ro?!0:!(e instanceof Xt)||!io.includes(e.fn)?!1:jp.includes(e.fn)&&jp.includes(s)?!0:io.indexOf(s)>io.indexOf(e.fn):!1}function c2(e,s,t){return tu(e,s)?`<mfenced>${t}</mfenced>`:t}function Ss(e,s){return e instanceof ro||e instanceof Xt?`<mrow>${s}</mrow>`:s}function Up(e){return e==="2"?"squared":e==="3"?"cubed":`to the power of ${e}`}var Xt=class extends Cs{constructor(e,s=[]){super(),this.fn=e,this.args=s}evaluate(e={}){let s=this.args.map(t=>t.evaluate(e));if(this.fn in e){let t=e[this.fn];if(typeof t=="function")return t(...s);if(typeof t=="number"&&s.length===1)return We.mul(t,s[0]);throw tt.uncallableExpression(this.fn)}if(this.fn==="+")return We.add(...s);if(this.fn==="\u2212")return We.sub(...s);if(["*","\xB7","\xD7"].includes(this.fn))return We.mul(...s);if(this.fn==="/")return We.div(...s);if(this.fn==="sup")return We.sup(...s);if(ti(this.fn))return We[this.fn](...s);if(this.fn==="(")return s[0];throw tt.undefinedFunction(this.fn)}interval(e={}){let s=this.args.map(t=>t.interval(e));if(this.fn in e){let t=e[this.fn];if(typeof t=="function")return zt(t(...s.map(i=>i[0])),2);if(typeof t=="number"&&s.length===1)return Q.mul([t,t],s[0]);if(Array.isArray(t)&&s.length===1)return Q.mul(t,s[0]);throw tt.uncallableExpression(this.fn)}if(this.fn==="+")return Q.add(...s);if(this.fn==="\u2212")return Q.sub(...s);if(["*","\xB7","\xD7"].includes(this.fn))return Q.mul(...s);if(this.fn==="/")return Q.div(...s);if(this.fn==="sup")return Q.sup(...s);if(ti(this.fn))return Q[this.fn](...s);if(this.fn==="(")return s[0];throw tt.undefinedFunction(this.fn)}substitute(e={}){return new Xt(this.fn,this.args.map(s=>s.substitute(e)))}collapse(){return this.fn==="("?this.args[0].collapse():new Xt(this.fn,this.args.map(e=>e.collapse()))}get simplified(){return this}get variables(){return Ht(Bt(this.args.map(e=>e.variables)))}get functions(){return Ht([this.fn,...Bt(this.args.map(e=>e.functions))])}toString(){let e=this.args.map(s=>tu(s,this.fn)?`(${s.toString()})`:s.toString());return this.fn==="\u2212"?e.length>1?e.join(" \u2212 "):`\u2212${e[0]}`:this.fn==="sup"?e.join("^"):this.fn==="sub"?e.join("_"):this.fn==="subsup"?`${e[0]}_${e[1]}^${e[2]}`:lt("+ * \xD7 \xB7 / = < > \u2264 \u2265 \u2248").includes(this.fn)?e.join(` ${this.fn} `):Y(this.fn,"(","[","{")?this.fn+this.args.join(", ")+Oh[this.fn]:Y(this.fn,"!","%")?e[0]+this.fn:`${this.fn}(${e.join(", ")})`}toMathML(e={}){let s=this.args.map(n=>n.toMathML(e)),t=this.args.map((n,r)=>c2(n,this.fn,s[r]));if(this.fn in e){let n=s.map((r,o)=>({toString:()=>r,val:this.args[o]}));return e[this.fn](...n)}if(this.fn==="\u2212")return t.length>1?t.join('<mo value="\u2212">\u2212</mo>'):`<mo rspace="0" value="\u2212">\u2212</mo>${t[0]}`;if(Y(this.fn,"+","=","<",">","\u2264","\u2265","\u2248")){let n=Xp(this.fn);return t.join(`<mo value="${n}">${n}</mo>`)}if(Y(this.fn,"*","\xD7","\xB7")){let n=t[0];for(let r=1;r<t.length-1;++r)n+=(this.args[0]instanceof cs&&this.args[1]instanceof cs?'<mo value="\xD7">\xD7</mo>':"")+t[1];return n}if(this.fn==="//")return t.join('<mo value="/">/</mo>');if(this.fn==="sqrt")return`<msqrt>${t[0]}</msqrt>`;if(Y(this.fn,"/","root")){let n=this.fn==="/"?"mfrac":"mroot",r=this.args.map((o,a)=>Ss(o,s[a]));return`<${n}>${r.join("")}</${n}>`}if(Y(this.fn,"sup","sub")){let n=[Ss(this.args[0],t[0]),Ss(this.args[1],s[1])];return`<m${this.fn}>${n.join("")}</m${this.fn}>`}return this.fn==="subsup"?`<msubsup>${[Ss(this.args[0],t[0]),Ss(this.args[1],s[1]),Ss(this.args[2],s[2])].join("")}</msubsup>`:Y(this.fn,"(","[","{")?`<mfenced open="${this.fn}" close="${Oh[this.fn]}">${t.join(Vh)}</mfenced>`:Y(this.fn,"!","%")?`${t[0]}<mo value="${this.fn}" lspace="0">${this.fn}</mo>`:this.fn==="abs"?`<mfenced open="|" close="|">${t.join(Vh)}</mfenced>`:this.fn==="bar"?`<mover>${Ss(this.args[0],t[0])}<mo value="\u203E">\u203E</mo></mover>`:this.fn==="vec"?`<mover>${Ss(this.args[0],t[0])}<mo value="\u2192">\u2192</mo></mover>`:`<mi${ti(this.fn)?' mathvariant="normal"':""}>${this.fn}</mi><mfenced>${t.join(Vh)}</mfenced>`}toVoice(e={}){let s=this.args.map(i=>i.toVoice(e)),t=s.join(" ");if(this.fn in e){let i=s.map((n,r)=>({toString:()=>n,val:this.args[r]}));return e[this.fn](...i)}return Y(this.fn,"(","[","{")?t:this.fn==="sqrt"?`square root of ${t}`:this.fn==="%"?`${t} percent`:this.fn==="!"?`${t} factorial`:this.fn==="/"?`${s[0]} over ${s[1]}`:this.fn==="//"?`${s[0]} divided by ${s[1]}`:this.fn==="sub"?t:this.fn==="subsup"?`${s[0]} ${s[1]} ${Up(s[2])}`:this.fn==="sup"?`${s[0]} ${Up(s[1])}`:Ni[this.fn]?s.join(` ${Ni[this.fn]} `):ti(this.fn)?`${this.fn} ${t}`:`${this.fn} of ${t}`}},ro=class extends Cs{constructor(e){super(),this.items=e}evaluate(e={}){return this.collapse().evaluate(e)}interval(e={}){return this.collapse().interval(e)}substitute(e={}){return this.collapse().substitute(e)}get simplified(){return this.collapse().simplified}get variables(){return Ht(Xc(...this.items.map(e=>e.variables)))}get functions(){return this.collapse().functions}toString(){return this.items.map(e=>e.toString()).join(" ")}toMathML(e={}){return this.items.map(s=>s.toMathML(e)).join("")}toVoice(e={}){return this.items.map(s=>s.toVoice(e)).join(" ")}collapse(){return Ih(this.items).collapse()}};function kh(e,s){if(s===2)return new a2(e);if(!(!e||!s)){if(s===1&&e.length>1)return new Jp;if(s===3){if(isNaN(+e))throw tt.invalidExpression();return new cs(+e)}if(s===4)return e in Ts?new Gi(Ts[e]):e in Ii?new Ke(Ii[e]):new Gi(e);if(s===5)return e in Ii?new Ke(Ii[e]):new Ke(e)}}function d2(e){let s=[],t="",i=0;for(let r of e){if(r==='"'){let a=i===2?0:2,l=kh(t,i);l&&s.push(l),t="",i=a;continue}else if(i===2){t+=r;continue}let o=r.match(/[0-9.]/)?3:e2.includes(r)?4:n2.includes(r)?5:r.match(/\s/)?1:0;if(!o)throw tt.invalidCharacter(r);if(!i||i===3&&o!==3||i===4&&o!==4&&o!==3||i===5&&!(t+r in Ii)||i===1&&o!==1){let a=kh(t,i);a&&s.push(a),t="",i=o}t+=r}let n=kh(t,i);return n&&s.push(n),s}function p2(e){return e.length>1?new ro(e):e[0]instanceof Ke?new ro(e):e[0]}function u2(e,s){let t=[[]];for(let i of e)s(i)?t.push([]):_(t).push(i);return t}function Jt(e,s){return e instanceof Ke&&lt(s).includes(e.o)}function An(e){return e instanceof Xt&&e.fn==="("?e.args[0]:e}function oo(e,s){if(Jt(e[0],s))throw tt.startOperator(e[0]);if(Jt(_(e),s))throw tt.endOperator(_(e));for(let t=1;t<e.length-1;++t){if(!Jt(e[t],s))continue;let i=e[t],n=e[t-1],r=e[t+1];if(n instanceof Ke)throw tt.consecutiveOperators(n.o,i.o);if(r instanceof Ke)throw tt.consecutiveOperators(i.o,r.o);let o=e[t+2];if(s==="^ _"&&Jt(i,"_ ^")&&Jt(o,"_ ^")&&i.o!==o.o){let a=e[t+3];if(a instanceof Ke)throw tt.consecutiveOperators(o.o,a.o);let l=[An(n),An(r),An(a)];i.o==="^"&&([l[1],l[2]]=[l[2],l[1]]),e.splice(t-1,5,new Xt("subsup",l)),t-=4}else{let a=r2[i.o]||i.o,l=[An(n),An(r)];e.splice(t-1,3,new Xt(a,l)),t-=2}}}function Zp(e){return oo(e,"^ _"),oo(e,"/"),p2(e)}function f2(e,s){let t=[[]],i=["\u03C0",...(s==null?void 0:s.variables)||[]];for(let n of e){let r=_(t).length?_(t)[0].o:void 0;if(Jt(n,") ] }")){if(!Jt(n,Oh[r]))throw tt.conflictingBrackets(n.o);let o=t.pop(),a=_(t),l=_(a),d=Jt(n,")")&&l instanceof Gi&&!i.includes(l.i)?a.pop().i:o[0].o,u=u2(o.slice(1),f=>Jt(f,","));a.push(new Xt(d,u.map(Zp)))}else Jt(n,"( [ {")?t.push([n]):_(t).push(n)}if(t.length>1)throw tt.unclosedBracket(_(t)[0].o);return Zp(t[0])}function Wp(e,s,t=!1){let i=[],n=[],r=!1;function o(){if(r)throw tt.invalidExpression();!n.length||(i.push(n.length>1?new Xt(s[0],n):n[0]),n=[])}for(let a of e)if(Jt(a,s)){if(r||!n.length)throw tt.invalidExpression();r=!0}else if(a instanceof Ke)o(),i.push(a),r=!1;else{let l=!t||a instanceof cs;if(n.length&&!r&&l)throw tt.invalidExpression();n.push(a),r=!1}return o(),i}function Ih(e){if(e=e.filter(t=>!(t instanceof Jp)),!e.length)throw tt.invalidExpression();let s=e.findIndex(t=>Jt(t,"= < > \u2264 \u2265"));if(s===0)throw tt.startOperator(e[0]);if(s===e.length-1)throw tt.endOperator(e[0]);if(s>0){let t=Ih(e.slice(0,s)),i=Ih(e.slice(s+1));return new Xt(e[s].o,[t,i])}if(Jt(e[0],"%!"))throw tt.startOperator(e[0]);for(let t=0;t<e.length;++t)!Jt(e[t],"%!")||(e.splice(t-1,2,new Xt(e[t].o,[e[t-1]])),t-=1);oo(e,"// \xF7");for(let t=1;t<e.length;++t){let i=e[t];if(i instanceof Xt&&i.fn==="/"){let n=e[t-1];if(n instanceof cs)e.splice(t-1,2,new Xt("+",[n,i])),t-=1;else if(!(n instanceof Ke))throw tt.consecutiveOperators(n.toString(),i.toString())}}if(e=Wp(e,"\xD7 * \xB7",!0),Jt(e[0],"\u2212 \xB1")&&e.splice(0,2,new Xt(e[0].o,[e[1]])),oo(e,"\u2212 \xB1"),Jt(e[0],"+")&&(e=e.slice(1)),e=Wp(e,"+"),e.length>1)throw tt.invalidExpression();return e[0]}function m2(e,s=!1,t){let i=f2(d2(e),t);return s?i.collapse():i}function g2(e,s){try{let t=Ht([...e.variables,...s.variables]),i=e.collapse(),n=s.collapse(),r=0;for(let o=0;o<5;++o){let a={};for(let d of t)a[d]=Nh[d]||Math.random()*5;let l=i.evaluate(a),h=n.evaluate(a);if(!(isNaN(l)||isNaN(h))){if(!P(l,h))return!1;r+=1}}return!!r}catch(t){return!1}}var Ot={numEquals:g2,parse:ue(m2)};var eu='<div class="toasts"><div class="msg-wrap"><button class="msg archie" aria-label="Virtual Tutor"><slot name="icon"></slot></button></div></div><div class="chat" data-display="flex"><div class="chat-header"><slot name="header"></slot><button class="close"><x-icon name="close" size="24"></x-icon></button></div><div class="chat-body"></div><div class="chat-footer"><div class="input" contenteditable></div><button class="hint"><x-icon name="lightbulb" size="24"></x-icon></button></div></div>';var v2=/[0-9+\-*/()^\s]+/g,w2=_s(J.shuffle(["happy","spongebob","sloth","party","robot","excited","cute","highfive1","applause","highfive2"])),y2=_s(J.shuffle(["minions","panther","dog","snape","what","door","horrible"]));function Gh(e,s,t={}){let i=c("div",{class:"msg-wrap","data-display":"flex"}),n=c("div",{class:"msg "+s},i);return t.class&&n.addClass(t.class),t.visible||i.hide(),Y(s,"hint","question")?n.html=e:s==="img"?n.css("background-image",`url(${e})`):s==="video"&&c("iframe",{src:e,allowfullscreen:!0},n),i}var ao=class extends O{constructor(){super(...arguments);this.recentMessages=[];this.isOpen=!1;this.queuePromise=Promise.resolve()}ready(){var r;this.$course=this.parents("x-course")[0],this.hints=this.$course?JSON.parse(this.$course.$("#hints").text):{};let t=window.user;this.correct=_s(J.shuffle(this.hints.correct||[])),this.incorrect=_s(J.shuffle(this.hints.incorrect||[])),this.$toasts=this.$(".toasts"),this.$chat=this.$(".chat"),this.$chatBody=this.$(".chat-body"),this.$toasts.on("click",o=>{o.handled||this.open()}),this.$(".close").on("click",()=>this.close());let i=this.$(".chat-footer");if(this.$query=i.$(".input"),this.$query.onKeyDown("enter",o=>{o.preventDefault(),this.askQuestion(this.$query.text.trim()),this.$query.text=""}),this.$query.on("focus",()=>i.addClass("focus")),this.$query.on("blur",()=>i.removeClass("focus")),this.$(".hint").on("click",()=>{this.queue(this.hints.tutorial1),this.queue(t?this.hints.tutorial2:this.hints.account)}),this.$course&&((r=this.$course.userData)==null?void 0:r.messages))for(let o of this.$course.userData.messages)this.$chatBody.append(Gh(o.content,o.kind||"hint",{visible:!0}));if(!b.getCookie("sessionWelcome")&&this.$course){b.setCookie("sessionWelcome",1,60*60*4);let o=new Date().getHours(),a=o<12?"Morning":o<18?"Afternoon":"Evening";t?setTimeout(()=>this.showHint(`welcome${a}Named`,{variables:{name:t.shortName}}),3e3):b.getCookie("welcome")?(setTimeout(()=>this.showHint(`welcome${a}`),3e3),setTimeout(()=>this.queue(this.hints.account),4500)):(b.setCookie("welcome",1),setTimeout(()=>this.queue(this.hints.welcome),3e3),setTimeout(()=>this.queue(this.hints.tutorial1),4500))}}open(){this.isOpen||(this.isOpen=!0,this.$chat.enter("slide-up",200),this.$chatBody.scrollTop=this.$chatBody.scrollHeight,this.trigger("open"))}close(){!this.isOpen||(this.isOpen=!1,this.$query.blur(),this.trigger("close"),this.$chat.exit("slide-down",200))}queue(t,i="hint",n={}){this.queuePromise=this.queuePromise.then(()=>(this.display(t,i,n),ns(500)))}display(t,i="hint",n={}){let r=n.timeout||8e3;if(b.width<640&&(r*=.7),(n.toast==null?!0:n.toast)&&!this.isOpen){let l=Gh(t,i,n);l.setAttr("role","alert"),this.$toasts.append(l),l.enter("reveal-right"),setTimeout(()=>l.exit("reveal-right",400,0,!0),r),this.on("open",()=>l.exit("reveal",200,0,!0))}let a=Gh(t,i,{class:n.class,visible:!this.isOpen});this.$chatBody.append(a),this.isOpen&&(a.enter("reveal",300),K(()=>this.$chatBody.scrollTop=this.$chatBody.scrollHeight,200))}showHint(t,i={}){if(Y(t,"correct","incorrect")){let r=t==="correct"?this.correct():this.incorrect(),o=t==="correct"?3e3:5e3;if(this.queue(r,"hint",{class:i.class||t,timeout:o}),Math.random()<.2){let a=t==="correct"?w2():y2(),l="";this.queue(`${l}/images/gifs/${a}.gif`,"img",{timeout:o})}return{text:r}}let n=this.hints[t]||t;if(i.variables)for(let[r,o]of Object.entries(i.variables))n=n.replace(new RegExp("\\$"+r,"g"),o);return!i.force&&this.recentMessages.includes(t)?{text:n}:(this.recentMessages.push(t),setTimeout(()=>this.recentMessages.shift(),1e4),i.store!==!1&&this.$course&&this.$course.saveProgress({hints:[{content:n,kind:"hint"}]}),this.queue(n,"hint",{class:i.class}),{text:n})}askQuestion(t){if(!t)return;this.queue(t,"question"),this.$course&&this.$course.log("Tutor","ask",t);let i=(t.match(v2)||[]).filter(n=>n.length>=3&&!n.match(/^[\s0-9]+$/));if(i.length)try{let n=Ot.parse(i[0],!0),r=Ot.parse("="+n.evaluate());return this.queue(`<span class="math">${n.toMathML()}${r.toMathML()}</span>`)}catch(n){console.log("Parse Error:",i[0])}this.$chatBody.addClass("loading"),ls(this.attr("api"),{query:t}).then(n=>{this.$chatBody.removeClass("loading");let r=JSON.parse(n);for(let o of r)this.queue(o.content,o.kind)}).catch(n=>{this.$chatBody.removeClass("loading"),this.queue(this.hints.serverError),console.error("Tutor Error:",n)})}};ao=N([V("x-tutor",{template:eu})],ao);var su='<div class="left" tabindex="0"><x-icon name="left" size="14"></x-icon></div><div class="content"><slot></slot></div><div class="right" tabindex="0"><x-icon name="right" size="14"></x-icon></div><div class="bubble"><div class="bubble-box"><div class="progress"></div></div><div class="bubble-arrow"></div></div>';var iu=c("div",{class:"var-overlay"},Z),lo=class extends O{constructor(){super(...arguments);this.valueChange=!1}ready(){let t=this.attr("bind");if(!t)return;let[i,n,r]=t.split("|");[this.min,this.max,this.step]=r.split(",").map(h=>+h),this.name=i,this.model=this.getParentModel(),this.$(".content").bindModel(this.model),this.$progress=this.$(".progress"),this.setValue(+n);let o=20*(b.isMobile?1.5:1)/S((this.max-this.min)/this.step/12,1,3),a=0,l=0;for(let h of this.$$(".left, .right")){let d=h.hasClass("left")?-this.step:this.step;h.on("click",()=>{this.setValue(this.value+d),this.trigger("slide-end")})}Fs(this,{start:h=>{a=h.x,l=this.value,this.addClass("on"),this.valueChange=!1,iu.show(),Ut.addClass("grabbing")},move:h=>{let d=(h.x-a)/o;this.setValue(l+Ft(d)*this.step)},end:()=>{this.removeClass("on"),this.valueChange&&this.trigger("slide-end"),iu.hide(),Ut.removeClass("grabbing")}})}setup(t,i){this.one("slide-end",()=>t.score(i))}setValue(t){let i=Ft(S(t,this.min,this.max),2);if(i===this.value)return;this.value=i,this.valueChange=!0,this.model&&(this.model[this.name]=i);let n=this.max-this.min;this.$progress.css("width",116*(i-this.min)/n+"px")}};lo=N([V("x-var",{template:su})],lo);var nu='<button class="play-btn-box" aria-label="Play"><x-icon name="play" size="44"></x-icon></button>';var ho=class extends O{constructor(){super(...arguments);this.visible=!0}ready(){this.on("click",()=>{this.play(),setTimeout(()=>this.trigger("play"),400)})}play(){!this.visible||(this.visible=!1,this.exit("pop",400))}reset(){this.visible||(this.visible=!0,setTimeout(()=>this.enter("pop"),400))}};ho=N([V("x-play-btn",{template:nu})],ho);var co=class extends O{constructor(){super(...arguments);this.playing=!1}ready(){this.$icon=this.$("x-icon"),this.$("button").on("click",()=>this.toggle())}toggle(){this.playing?this.pause():this.play()}play(){this.playing||(this.playing=!0,this.$icon.setAttr("name","pause"),this.trigger("play"))}pause(){!this.playing||(this.playing=!1,this.$icon.setAttr("name","play"),this.trigger("pause"))}};co=N([V("x-play-toggle",{template:'<button class="icon-btn"><x-icon name="play"></x-icon></button>'})],co);var ru='<div class="video-wrap"><video playsinline></video></div><div class="credit"></div><x-play-btn></x-play-btn><div class="controls"><div class="shadow"></div><button class="play-pause-btn" tabindex="0" aria-label="Play video"><div class="play-icon"><x-icon name="play" size="32"></x-icon></div><div class="pause-icon"><x-icon name="pause" size="32"></x-icon></div></button><div class="timeline"><div class="bar"><div class="background"></div><div class="buffer"></div><div class="progress"></div></div><div class="handle"></div></div><div class="timecode"></div></div>';function ou(e){let s=Math.floor(e/60),t=Math.floor(e%60);return s+":"+(t<10?"0":"")+t}var po=class extends O{ready(){let t=this.attr("src"),i=this.$(".video-wrap"),n=this.$("video"),r=this.attr("width"),o=this.attr("height");this.css("width",r+"px"),i.css("padding-bottom",+o/+r*100+"%"),n.setAttr("poster",this.attr("poster")||t.replace(/mp4$/,"jpg")),this.hasAttr("loop")&&(n._el.loop=!0),this.hasAttr("audio")||(n._el.muted=!0),n._el.preload=this.attr("preload")==="no"?"metadata":"auto",c("source",{src:t,type:"video/mp4"},n),this.hasAttr("credit")&&(this.$(".credit").text=this.attr("credit"));let a=this.$(".bar"),l=this.$(".progress"),h=this.$(".buffer"),d=this.$(".timecode"),u=new Ws(this.$(".handle"),{$parent:a,moveY:!1}),f=this.video=n._el,v=this.width-110;b.onResize(()=>v=this.width-110),n.on("canplay",()=>{d.text=ou(+f.duration)}),n.on("timeupdate",()=>{let y=f.currentTime/f.duration;l.css("width",y*100+"%"),d.text=ou(+f.currentTime),u.setPosition(y*v,0),this.trigger("timeupdate",f.currentTime)}),n.on("progress",()=>{if(f.buffered.length<=0||f.duration<=0)return;let C=f.buffered.end(f.buffered.length-1)/f.duration*100;h.css("width",C+"%")}),n.on("ended",()=>{f.pause(),this.removeClass("playing"),this.trigger("end")});let w=()=>f.paused?this.play():this.pause(),g=y=>this.setTime(y/v*f.duration);this.hasAttr("hover")?(n.on("mouseover touchstart",()=>this.play()),n.on("mouseout touchend touchcancel",()=>this.pause())):n.on("click",w),this.hasAttr("controls")&&(this.$(".controls").show(),this.$(".play-pause-btn").on("click",w),u.on("start",()=>this.pause()),u.on("drag",({posn:y})=>g(y.x)),a.on("click",y=>g(y.offsetX)))}setTime(t){this.video.currentTime=t}play(){this.video.play(),this.addClass("playing"),this.trigger("play")}pause(){this.video.pause(),this.removeClass("playing")}};po=N([V("x-video",{template:ru})],po);var uo=class extends O{constructor(){super(...arguments);this.isCompleted=!1;this.isReady=!1}created(){this.userData=window.progressData||JSON.parse(this.$("#userdata").text)||{},this.$steps=this.$$("x-step");for(let t of this.$steps)t.on("score",()=>this.trigger("score"));this.data.audio&&(this.audio=new Vr(this.data.audio))}ready(){this.$footer=this.$("footer"),this.$skipStep=this.$footer.$(".skip-step"),this.$progress=this.$(".sidebar-row.active x-progress"),this.$tutor=this.$("x-tutor"),this.$stepsWrap=this.$(".steps");let t=this.findStep(b.getHash()),i=this.findStep(this.userData.activeStep);this.$activeStep=i||this.$steps[0];for(let r of this.$steps){if(r.show(),r===this.$activeStep)break;r.complete()}if(this.userData.completed||b.getHash()==="full"||this.data.reveal)this.complete();else for(;this.$activeStep&&this.$activeStep.isReady&&!this.isCompleted;)this.nextStep();(t||i&&!this.userData.completed)&&this.goToStep(t||i,!1),this.$(".section-dev")&&this.complete();let n=this.$(".reveal-banner");setTimeout(()=>{this.isCompleted||(n.removeClass("off"),this.on("score complete",()=>n.addClass("off")))},1500),n.$(".complete").one("click",()=>this.complete()),b.onKey("space",r=>{r.preventDefault(),this.nextStep(),n.addClass("off")}),this.$footer.$(".skip").on("click",()=>this.nextStep()),this.$footer.$(".show-all").on("click",()=>this.complete()),this.$footer.show(),this.isReady=!0,setTimeout(()=>this.addClass("ready"))}nextStep(){if(this.isCompleted)return;let t=this.$activeStep,i=this.$stepsWrap.height;do{if(t.complete(),t=this.$steps[this.$steps.indexOf(t)+1],!t)return this.complete(!0);t.show()}while(t.isReady);this.$stepsWrap.animate({height:[i+"px","auto"]},800),this.$activeStep=t,this.saveProgress({activeStep:t.id})}goToStep(t,i=!0){let n=this.$stepsWrap.height;for(let a of this.$steps){if(a.isShown||(this.$activeStep=a),a.show(),t.isShown&&!a.isReady)break;a.complete()}let r=t.positionTop-Math.max(50,(b.height-t.height)/2);i?(this.$stepsWrap.animate({height:[n+"px","auto"]},800),Z.scrollTo(r)):Z.scrollTop=r;let o=_(this.$steps);if(o.isShown&&o.isReady)return this.complete();this.$activeStep&&this.saveProgress({activeStep:this.$activeStep.id})}complete(t=!1){if(this.isCompleted)return;this.isCompleted=!0,this.$steps.forEach(n=>n.complete()),this.$activeStep=void 0;let i=this.$footer.$(".next-section");t?(this.$skipStep.exit("fade",200),i&&i.enter("pop")):(this.$skipStep.hide(),i&&i.show()),this.trigger("complete"),this.saveProgress({completed:!0}),this.log("Course","complete")}findStep(t){for(let i of this.$steps)if(i.id===t)return i}saveProgress(t){if(!this.isReady)return;let n=q(this.$steps.map(r=>r.scores.size))/+this.data.goals||0;this.$progress.setProgress(n),Dd(`/course/${this.id}/${this.data.section}`,t)}log(t,i,n){if(window.ga&&this.isReady){let r=i+(n?":"+n:"");window.ga("send","event",t,r,this.id)}}};uo=N([V("x-course")],uo);var fo=class{constructor(){this.callbacks=[]}add(s){this.callbacks.push(s)}start(s=1e3){return K(i=>{for(let n of this.callbacks)n(i)},s).promise}};function au(e,s){return e.every((t,i)=>P(t,s[i]))}function lu(e,s){e.scale*=s.scale,e.x=e.x*s.scale+s.x,e.y=e.y*s.scale+s.y}function hu(e,s){return P(e.x,s.x)&&P(e.y,s.y)&&P(e.scale,s.scale)}function mo(e,s,t){if(t==="adding"){let i=e.strokeLength,n=s<.5?0:ot("cubic-in",s*2-1);e.css({"stroke-dasharray":i+"px","stroke-dashoffset":i*(1-n)+"px"})}else if(t==="deleting"){let i=e.strokeLength,n=s<.5?ot("cubic-in",2*s):1;e.css({"stroke-dasharray":i+"px","stroke-dashoffset":i*(2-n)+"px"})}}function cu(e,s){let t=[e],i=e.expr;for(;s.startsWith(i);){if(s===i)return t;let n=_(t).next;if(!n)return;t.push(n),i+=n.expr}}function du(e,s,t=1){let i=t*Math.abs(s.x-e.x)/3,n=p.average(e,s).shift(0,i);return function(r){let o=(1-r)**2*e.x+2*r*(1-r)*n.x+r*r*s.x,a=(1-r)**2*e.y+2*r*(1-r)*n.y+r*r*s.y;return{x:o,y:a}}}function Dh(e,s){return Math.max(s*e,.4)/e}function ds(e){return e instanceof Xe&&e.children.length>1||e instanceof ei?`(${e.expr})`:e.expr}function Ye(e,s){return s.length===1&&s[0].type==="mrow"?s[0]:new Xe(s,e)}var qt=class{constructor(s,t,i,n){this.type=s;this.equation=i;this.$element=n;this.children=[];this.status="";this.value="";this.customColor="";this.roundedMotion=!1;this.width=0;this.height=0;this.baseline=0;this.transform={x:0,y:0,scale:1};this.currentDimensions=[0,0,0];this.currentWorldTransform={x:0,y:0,scale:1};this.addChildren(t),n&&i.$row.append(n)}get expr(){return""}get log(){let s=this.children.map(t=>t.log);return`<${this.type}>${s.join("")}</${this.type}>`}get color(){return this.customColor||(this.parent?this.parent.color:"")}static create(s,t){let i=s.nodeName.toLowerCase();if(Y(i,"mn","mi","mo","mtext")){if(s.textContent==="placeholder")return new kn(t);let r=s.getAttribute("mathvariant")||void 0;return new Ms(i,s.textContent||"",t,r)}if(!Y(i,"mrow","mfrac","mfenced","msqrt","mroot","msub","msup","msubsup","munder","mover","munderover","mspace"))return new qh(s,t);if(i==="mfenced"&&s.getAttribute("open")==="["){let r=s.children.length,o=Bt(Array.from(s.children,l=>Array.from(l.children,h=>qt.create(h,t)))),a=new Bh(o,t,r);return new _i([a],t)}let n=Array.from(s.children,r=>qt.create(r,t));switch(i){case"mrow":return new Xe(n,t);case"mfrac":return n=n.map(r=>Ye(t,[r])),new On(n,t);case"mfenced":return n=[Ye(t,n)],new _i(n,t);case"msqrt":return n=[Ye(t,n)],new ii(i,n,t);case"mroot":return n=n.map(r=>Ye(t,[r])),new ii(i,n,t);case"msub":case"msup":case"msubsup":return n=n.map(r=>Ye(t,[r])),new ei(i,n,t);case"munder":case"mover":case"munderover":return n=n.map(r=>Ye(t,[r])),new Hh(i,n,t);case"mspace":return new Vn(t)}throw new Error(`Unknown element type tag ${s.nodeName}`)}get marginLeft(){return .1}get marginRight(){return .1}setTransform(s=0,t=0,i=1){this.transform.x=s,this.transform.y=t,this.transform.scale=i}get worldTransform(){let s=this,t=Object.assign({},this.transform);for(;s=s.parent;)lu(t,s.transform);return t}get index(){return this.parent?this.parent.children.indexOf(this):-1}get next(){if(!this.parent)return;let s=this.parent.children.indexOf(this);return this.parent.children[s+1]}get prev(){if(!this.parent)return;let s=this.parent.children.indexOf(this);return this.parent.children[s-1]}addChildren(s,t=this.children.length){for(let i of this.children)i.type==="placeholder"&&i.deleteFromDom();for(let i of s)i.detach(),i.parent=this;this.children.splice(t,0,...s)}insertAfter(s){let t=this.parent.children.indexOf(this);this.parent.addChildren(s,t+1)}insertBefore(s){let t=this.parent.children.indexOf(this);this.parent.addChildren(s,t)}detach(){if(this.parent){let s=this.parent.children.indexOf(this);s>=0&&this.parent.children.splice(s,1),this.parent=void 0}}deleteFromDom(){this.parent&&this.detach(),this.$element&&this.$element.remove(),this.$element=void 0;for(let s of this.children.slice(0))s.deleteFromDom()}*parents(s=!1){let t=s?this:this.parent;for(;t;)yield t,t=t.parent}hasParent(s,t=!1){return Ve(this.parents(t),s)}hitTest(s){let{x:t,scale:i}=this.worldTransform,n=this.marginLeft*i*this.equation.fontSize,r=this.marginRight*i*this.equation.fontSize;if(st(s.x,t-n,t+this.width*i+n+r))return this.hitTestChildren(s)||this}hitTestChildren(s){for(let t of this.children){let i=t.hitTest(s);if(i)return i}}measure(s=1){for(let t of this.children)t.measure(s)}clean(){for(let s of this.children)s.clean()}setStatus(s){this.status=s;for(let t of this.children)t.setStatus(s)}render(s){for(let l of this.children)l.render(s);if(!this.$element)return;let t=this.currentWorldTransform,i=this.currentWorldTransform=this.worldTransform,n=this.currentDimensions,r=this.currentDimensions=[this.width,this.height,this.baseline];if(hu(t,i)&&au(n,r)&&!this.status)return;if(!s){this.positionElement(i),this.drawElement(1,r[0],r[1],r[2],i.scale);return}this.status==="adding"&&this.positionElement(i);let o=i.y+this.baseline<this.equation.root.baseline?-1:1,a=this.roundedMotion?du(t,i,o):void 0;this.roundedMotion=!1,s.add(l=>{if(!this.$element)return;let h=ot("cubic",l),d=Y(this.status,"adding","deleting"),u=d?r[0]:$t(n[0],r[0],h),f=d?r[1]:$t(n[1],r[1],h),v=d?r[2]:$t(n[2],r[2],h),w=d?i.scale:$t(t.scale,i.scale,h);if(this.drawElement(l,u,f,v,w),!this.status){let g=a?a(h):p.interpolate(t,i,h);this.positionElement({x:g.x,y:g.y,scale:w})}})}positionElement(s){this.$element.setTransform(s,0,s.scale)}drawElement(s,t,i,n,r){}},b2="acegmnopqrsuvwxyz",si=1.1,Di=.2,_h=["=","\u2248","<",">","\u2264","\u2265"],$2=document.createElement("canvas"),pu=$2.getContext("2d"),x2=ue((e,s)=>(pu.font=`${s}px "Source Sans Pro", sans-serif`,pu.measureText(e).width)),Ms=class extends qt{constructor(t,i,n,r){super(t,[],n,c("text",{}));this.variant=r;this.setValue(i)}setValue(t){this.$element.text=this.value=t;let i=this.value.split("").every(r=>b2.includes(r));this.width=x2(t,this.equation.fontSize),this.height=(si-(i?.1:0))*this.equation.fontSize,this.baseline=this.height-Di*this.equation.fontSize;let n=this.type==="mtext"||this.variant==="normal";this.$element.setClass("font-normal",n||ti(this.value))}get expr(){return this.value==="xx"?'"xx"':this.type==="mtext"?`"${this.value}"`:this.value}get log(){return`<${this.type}>${this.value}</${this.type}>`}get marginLeft(){if(this.type==="mo")return _h.includes(this.value)?this.equation.isDisplay?.5:.35:Y(this.value,"\u2221","\u25B3","!","%","\u2019")||Y(this.value,"\u2026","\xB0")&&this.prev&&this.prev.type==="mn"?0:.25;if(this.type==="mi"){if(this.prev&&this.prev.type==="mn")return .1;if(this.prev&&this.prev.type==="mi")return .05;if(this.prev&&this.prev.type==="mfrac")return .15}return 0}get marginRight(){return this.type==="mo"?this.equation.isDisplay&&_h.includes(this.value)?.5:Y(this.value,"\u2221","\u25B3")?0:this.value==="\u2212"&&(!this.prev||_h.includes(this.prev.value))?.1:.25:0}positionElement(t){if(!this.$element)return;let i=(this.equation.fontSize-this.baseline)*t.scale;this.$element.setTransform({x:t.x,y:t.y-i},0,t.scale)}drawElement(t,i,n,r,o){this.status==="adding"?this.$element.setAttr("opacity",t<.5?0:ot("cubic-in",t*2-1)):this.status==="deleting"&&this.$element.setAttr("opacity",t<.5?1-ot("cubic-in",2*t):0),this.$element.css("stroke-width",(1-o)*1.5+"px"),this.$element.css("color",this.color||"currentColor")}},Vn=class extends qt{constructor(s){super("mspace",[],s),this.height=(si-.1)*s.fontSize,this.baseline=this.height-Di*this.equation.fontSize,this.width=s.fontSize*.2}get expr(){return" "}},Xe=class extends qt{constructor(t,i,n,r=0){super("mrow",t,i);this.align=n;this.dx=r}addChildren(t,i=this.children.length){let n=[];for(let r of t)r.type==="mrow"?(n.push(...r.children),r.detach()):n.push(r);super.addChildren(n,i)}get expr(){return this.children.map(t=>t.expr).join(" ").replace(/− /,"\u2212")||"placeholder"}measure(t=1){if(super.measure(t),!this.children.length){this.height=this.width=this.baseline=0;return}this.baseline=Math.max(...this.children.map(n=>n.baseline)),this.height=this.baseline+Math.max(...this.children.map(n=>n.height-n.baseline));let i=0;for(let[n,r]of this.children.entries())r.setTransform(i,this.baseline-r.baseline),i+=r.width,n<this.children.length-1&&(i+=Math.max(r.marginRight,this.children[n+1].marginLeft)*this.equation.fontSize);if(this.align){let n=this.children.find(r=>r.expr===this.align);n&&(this.transform.x=this.dx-n.transform.x-n.width/2)}this.width=i}},kn=class extends qt{constructor(s){let t=s.fontSize,i=`M${.1*t} ${.3*t}h${t/2}v${t/2}h-${t/2}Z`,n=c("path",{class:"placeholder",d:i});super("placeholder",[],s,n),this.width=.7*t,this.height=si*t,this.baseline=this.height-Di*t}get expr(){return"placeholder"}get marginLeft(){return 0}get marginRight(){return 0}},On=class extends qt{constructor(s,t){super("mfrac",s,t,c("line"))}get expr(){return this.children.map(s=>ds(s)).join("/")}measure(s){let t=this.hasParent(a=>a.type==="mfrac"||a.type==="matrix"),i=Dh(s,!this.equation.isDisplay||t?.66:1),n=.1*this.equation.fontSize,[r,o]=this.children;super.measure(s*i),this.width=(Math.max(r.width,o.width)+2*n)*i,this.height=(r.height+o.height)*i,this.baseline=r.height*i+this.equation.fontSize*(si/2-Di),r.setTransform((this.width-r.width*i)/2,0,i),o.setTransform((this.width-o.width*i)/2,r.height*i,i)}drawElement(s,t,i,n){let r=n-this.equation.fontSize*(si/2-Di);this.$element.setLine({x:0,y:r},{x:t,y:r}),this.$element.setAttr("stroke",this.color||"currentColor"),mo(this.$element,s,this.status)}hitTestChildren(s){let{scale:t,y:i}=this.worldTransform,n=this.baseline-this.equation.fontSize*(si/2-Di),r=s.y<=i+n*t,o=this.children[r?0:1];return o.hitTestChildren(s)||o}},ei=class extends qt{get expr(){let s=ds(this.children[0]);return this.type!=="msup"&&(s+="_"+ds(this.children[1])),this.type==="msup"&&(s+="^"+ds(this.children[1])),this.type==="msubsup"&&(s+="^"+ds(this.children[2])),s}measure(s){let[t,i,n]=this.children,r=this.type==="msup"?void 0:i,o=this.type==="msubsup"?n:this.type==="msup"?i:void 0,a=.05*this.equation.fontSize,l=Dh(s,.65);t.measure(s),r&&r.measure(s*l),o&&o.measure(s*l);let h=o?o.height*l-.4*this.equation.fontSize:0,d=r?r.height*l-.5*this.equation.fontSize:0,u=o?o.width:0,f=r?r.width:0;this.width=t.width+a+Math.max(u,f)*l,this.height=t.height+h+d,this.baseline=t.baseline+h,t.setTransform(0,this.baseline-t.baseline),o&&o.setTransform(t.width+a,0,l),r&&r.setTransform(t.width+a,this.height-r.height*l,l)}clean(){if(super.clean(),this.children=this.children.filter(s=>s.type!=="mrow"||s.children.length),this.children.length===0)return this.detach();this.children.length===1&&(this.insertAfter(this.children),this.detach())}},Hh=class extends qt{get expr(){let s=this.children[0].expr;return this.type!=="munder"&&(s+="_"+ds(this.children[1])),this.type==="mover"&&(s+="^"+ds(this.children[1])),this.type==="munderover"&&(s+="^"+ds(this.children[2])),s}measure(s){super.measure(s)}},_i=class extends qt{constructor(s,t){super("mfenced",s,t,c("path"))}get expr(){return`(${this.children.map(s=>s.expr).join()})`}get marginLeft(){return .2}get marginRight(){return .2}measure(s){super.measure(s);let t=this.children[0];this.height=t.height+2,this.baseline=t.baseline+1;let i=1+this.height/this.equation.fontSize,n=.1*this.equation.fontSize;this.width=t.width+2*(i+n),t.setTransform(i+n,1)}drawElement(s,t,i){let n=Math.min(2+i/this.equation.fontSize,5),r=i-4,o=t-n,a=`M${n},2c${-2*n/3},${.15*r},${-n},${.32*r},${-n},${r/2}s${n/3},${.35*r},${n},${r/2}M${o},2c${2*n/3},${.15*r},${n},${.32*r},${n},${r/2}s${-n/3},${.35*r},${-n},${r/2}`;this.$element.setAttr("d",a),this.$element.css("stroke",this.color||"currentColor"),mo(this.$element,s,this.status)}clean(){super.clean(),this.children.length||this.detach()}},ii=class extends qt{constructor(s,t,i){super(s,t,i,c("path"))}get expr(){return`sqrt(${this.children.map(s=>s.expr).join(", ")})`}get marginLeft(){return .2}get marginRight(){return .2}measure(s){super.measure(s);let t=this.children[0];this.height=t.height+2,this.baseline=t.baseline+2;let i=Math.min(16,3+5*this.height/this.equation.fontSize),n=.05*this.equation.fontSize;this.width=t.width+i+2*n,t.setTransform(i+n,2)}drawElement(s,t,i){let n=Math.min(16,3+5*i/this.equation.fontSize),r=i-2,o=`M0,${.55*r}L${.18*n},${.51*r}L${.45*n},${r}L${n},2L${t},2`;this.$element.setAttr("d",o),this.$element.css("stroke",this.color||"currentColor"),mo(this.$element,s,this.status)}clean(){super.clean(),this.children.length||this.detach()}},Bh=class extends qt{constructor(t,i,n){super("matrix",t,i,c("g"));this.rows=n;this.cols=Math.floor(t.length/n)}get expr(){return`${this.children.map(t=>t.expr).join(", ")}`}measure(t){super.measure(t);let i=.6*this.equation.fontSize,n=B(a=>Math.max(...B(l=>this.children[a*this.cols+l].height,this.cols)),this.rows),r=B(a=>Math.max(...B(l=>this.children[l*this.cols+a].width,this.rows)),this.cols);this.height=q(n)+(this.rows-1)*i/2,this.width=q(r)+this.cols*i,this.baseline=(this.height+si*this.equation.fontSize)/2;let o=0;for(let a=0;a<this.rows;++a){let l=i/2;for(let h=0;h<this.cols;++h){let d=this.children[a*this.cols+h],u=l+(r[h]-d.width)/2,f=o+(n[a]-d.height)/2;d.setTransform(u,f),l+=r[h]+i}o+=n[a]+i/2}}},qh=class extends qt{constructor(t,i){var n;super("foreign",[],i,c("g"));this.$body=c("div",{},i.$overlay),this.$body._el.appendChild(t),this.$measure=c("span",{text:".",style:"font-size: 0"},this.$body),this.checkForResize(),this.$body.on("resize",()=>{this.checkForResize()&&this.equation.resize()}),(n=this.$body.$("x-blank, x-blank-mc"))==null||n.on("solve",r=>{Ae(()=>this.replace(r.solution,"#0f82f2"),r.restore?0:200)})}deleteFromDom(){var t;super.deleteFromDom(),(t=this.$body)==null||t.remove(),this.$body=void 0,this.$measure=void 0}replace(t,i){var o;let n=isNaN(+t)?"mtext":"mn",r=new Ms(n,t,this.equation);r.customColor=i,this.insertAfter([r]),(o=this.$body)==null||o.off("resize"),this.deleteFromDom(),this.equation.resize()}checkForResize(){var r,o;let t=this.height,i=this.width,n=this.baseline;return this.height=((r=this.$body)==null?void 0:r.height)||0,this.width=((o=this.$body)==null?void 0:o.width)||0,this.baseline=this.$measure.bounds.top-this.$body.bounds.top,!(P(t,this.height)&&P(i,this.width)&&P(n,this.baseline))}positionElement(t){var i,n;(i=this.$body)==null||i.css({left:t.x+"px",top:t.y+"px"}),P(t.scale,1)||(n=this.$body)==null||n.css("transform",`scale(${t.scale})`)}get expr(){var t;return`"${(t=this.$body)==null?void 0:t.text}"`}get log(){return`<foreign>${this.expr}</foreign>`}};var Te=class extends rs{constructor(t,i,n=0,r="=",o=18,a=!0){super();this.$row=t;this.$overlay=i;this.fontSize=o;this.isDisplay=a;this.isReady=!0;this.deletedNodes=new Set;this.root=new Xe([],this,r,n)}setValue(t){let i=Array.isArray(t)?t.map(n=>qt.create(n,this)):this.parse(t);for(let n of this.root.children)n.deleteFromDom();this.root.addChildren(i),this.updateDescription(),this.resize()}updateDescription(){try{let t=Ot.parse(this.root.expr).toVoice();this.$row.setAttr("aria-label",t)}catch(t){this.$row.setAttr("aria-label","Invalid expression: "+this.root.expr)}}resize(){this.root.measure(),this.root.render()}parse(t){var a;let i=new DOMParser,n=Ot.parse(t).toMathML(),r=i.parseFromString(`<math>${n}</math>`,"text/xml");if(((a=r.firstChild)==null?void 0:a.nodeName)==="parsererror")throw new Error(r.firstChild.textContent);let o=r.firstChild.childNodes;return Array.from(o,l=>qt.create(l,this))}find(t){let[i,n]=t.split("`");i=i.replace(/[–-]/g,"\u2212");let r=+n||1,o=this.root.children.slice(0),a=0;for(;o.length;){let l=o.shift(),h=l instanceof Xe?void 0:cu(l,i);if(h&&(a+=1,a===r))return h;o.unshift(...l.children)}throw new Error(`Can't find element ${i}.`)}animate(t=1200){return R(this,null,function*(){this.isReady=!1,this.root.clean(),this.root.measure();let i=new fo;this.root.render(i),this.trigger("resize",{height:this.root.height});for(let n of this.deletedNodes)n.render(i);yield i.start(t);for(let n of this.deletedNodes)n.deleteFromDom();this.root.setStatus(""),this.deletedNodes.clear(),this.isReady=!0})}addTermAfter(t,i){let n=_(i?this.find(i):this.root.children),r=this.parse(t);n.insertAfter(r);for(let o of r)o.setStatus("adding");this.updateDescription()}addTermBefore(t,i){let n=i?this.find(i)[0]:this.root.children[0],r=this.parse(t);n.insertBefore(r);for(let o of r)o.setStatus("adding");this.updateDescription()}deleteTerm(t){for(let i of this.find(t))i.setStatus("deleting"),i.detach(),this.deletedNodes.add(i);this.updateDescription()}replaceTerm(t,i){let n=this.find(t),r=this.parse(i);n[0].insertBefore(r);for(let o of r)o.setStatus("adding");for(let o of n)o.setStatus("deleting"),o.detach(),this.deletedNodes.add(o);this.updateDescription()}moveTermAfter(t,i){let n=this.find(t);for(let o of n)o.roundedMotion=!0;_(i?this.find(i):this.root.children).insertAfter(n),this.updateDescription()}moveTermBefore(t,i){let n=this.find(t);for(let o of n)o.roundedMotion=!0;(i?this.find(i)[0]:this.root.children[0]).insertBefore(n),this.updateDescription()}moveTermToStart(t){let i=this.find(t);for(let n of i)n.roundedMotion=!0;this.root.children[0].insertBefore(i),this.updateDescription()}wrapTerms(t,...i){let n=i.map(o=>this.find(o));for(let o of n)for(let a of o)a.roundedMotion=!0;let r=this.parse(t);for(let o of r)o.setStatus("adding");n[0][0].insertBefore(r);for(let[o,a]of n.entries()){let l=this.find("$"+(o+1))[0];l.insertAfter(a),l.deleteFromDom()}this.updateDescription()}unwrapTerm(t,i=1){let n=this.find(t),r=n[0],o=1;for(;o<=i;)r=r.parent,r instanceof Xe&&(r=r.parent),o+=1;r.insertAfter(n),r.setStatus("deleting"),r.detach(),this.deletedNodes.add(r),this.updateDescription()}get leftSide(){let t=this.root.children.findIndex(i=>i.expr==="=");return this.root.children.slice(0,t-1)}get rightSide(){let t=this.root.children.findIndex(i=>i.expr==="=");return this.root.children.slice(t+1)}};var uu='<svg class="equation"><g></g></svg><div class="overlay"></div><div class="nav"><div class="btn back hide"><x-icon name="left"></x-icon></div><div class="btn next"><x-icon name="right"></x-icon></div></div><div class="legend-box"><slot></slot></div>';var fu=1200,P2=400,mu=1200,Hi=600,Ln=16,go=class extends O{constructor(){super(...arguments);this.rows=[];this.isReady=!0;this.topOffset=4;this.currentHeight=0;this.currentStep=0;this.nextEvents={};this.backEvents={}}ready(){this.$svg=this.$("svg"),this.$lastRow=this.$svg.$("g"),this.$overlay=this.$(".overlay"),this.$legend=this.$(".legend-box"),this.$steps=this.$legend.$$("li"),this.$back=this.$(".back"),this.$next=this.$(".next");let t=+this.attr("dx")||0;this.equation=new Te(this.$lastRow,this.$overlay,t);let i=this.$(".math"),n=i?Array.from(i._el.children):[];this.equation.setValue(this.attr("expr")||n),this.currentHeight=this.topOffset+this.$lastRow.height+16,this.$svg.css("height",this.currentHeight+"px"),this.equation.on("resize",({height:o})=>{let a=this.topOffset+o+Ln;Math.abs(a-this.currentHeight)<Ln/2||(this.currentHeight=a,this.$svg.animate({height:a+"px"},mu))}),this.$back.on("click",()=>this.goBack()),this.$next.on("click",()=>this.goNext()),this.$steps[0].show(),b.onResize(()=>{let o=this.$svg.width/2;for(let a of[this.$lastRow,this.$overlay])a.css("transform",`translate(${o}px, ${this.topOffset}px)`);for(let a of this.rows)a.$el.css("transform",`translate(${o}px, ${a.top}px)`)});let r=this.$overlay.$$("x-blank, x-blank-mc");r.length&&(this.$next.addClass("hide"),Promise.all(r.map(o=>o.onPromise("solve"))).then(()=>setTimeout(()=>this.goNext(),fu)))}setup(t){this.one("next",({step:i})=>t.score("algebra-flow-"+(i-1)))}newRow(){return R(this,null,function*(){let t=this.$lastRow.copy(!0,!1),i=this.equation.root.height;this.rows.push({$el:t,height:i,top:this.topOffset}),this.$lastRow.insertBefore(t),b.redraw(),this.topOffset+=i+Ln,this.currentHeight=this.topOffset+i+Ln;for(let n of[this.$lastRow,this.$overlay])n.animate({transform:`translate(${this.$svg.width/2}px, ${this.topOffset}px)`},Hi);yield this.$svg.animate({height:this.currentHeight+"px"},Hi).promise})}hideLastRow(){return R(this,null,function*(){if(!this.rows.length)return;let t=this.rows.pop();this.topOffset=t.top;for(let i of[this.$lastRow,this.$overlay])i.animate({transform:`translate(${this.$svg.width/2}px, ${t.top}px)`},Hi);this.currentHeight=t.top+this.$lastRow.height+Ln,this.$svg.animate({height:this.currentHeight+"px"},Hi),yield t.$el.exit("fade",Hi/2,Hi/2).promise,t.$el.remove()})}onNextStep(t){this.nextEvents=t}onBackStep(t){this.backEvents=t}goNext(){return R(this,null,function*(){if(!this.isReady||!this.equation.isReady||this.currentStep>=this.$steps.length-1)return;this.isReady=!1;let t=this.currentStep+1;this.$steps[t].hasClass("new-row")&&(yield this.newRow(),yield ns(P2)),t in this.nextEvents&&(yield this.nextEvents[t](this.equation),yield this.equation.animate(mu),yield ns(fu)),yield this.go(t),this.trigger("next",{step:t}),this.isReady=!0})}goBack(){return R(this,null,function*(){if(!this.isReady||!this.equation.isReady||this.currentStep<=0)return;let t=this.currentStep-1;this.isReady=!1,this.currentStep in this.backEvents&&(yield this.backEvents[this.currentStep](this.equation),yield this.equation.animate()),this.$steps[this.currentStep].hasClass("new-row")&&this.hideLastRow(),yield this.go(t),this.trigger("back",{step:t}),this.isReady=!0})}go(t){return R(this,null,function*(){this.$steps[t].show();let i=this.$steps[t].height+"px";this.$steps[t].hide(),this.$legend.animate({height:i},800).promise.then(()=>this.$legend.css("height","auto"));let n=this.currentStep;this.currentStep=t,this.trigger("step",t),yield this.$steps[n].exit("fade",400).promise,this.$back.setClass("hide",t<=0),this.$next.setClass("hide",t>=this.$steps.length-1),yield this.$steps[t].enter("fade",400).promise})}};go=N([V("x-algebra-flow",{template:uu})],go);var gu='<div class="input"><textarea></textarea></div><div class="math empty"><span class="cursor">&#8203;</span></div><div class="keys"><!-- TODO Make these buttons tabbable--><div class="btn" data-type="+">+</div><div class="btn" data-type="\u2212">\u2212</div><div class="btn" data-type="\xD7">\xD7</div><div class="btn" data-type="\xF7">\xF7</div><div class="btn i" data-type="\u03C0">\u03C0</div><div class="btn" data-type="frac"><x-icon name="fraction"></x-icon></div><div class="btn" data-type="sup"><x-icon name="power"></x-icon></div><div class="btn" data-type="sqrt"><x-icon name="sqrt"></x-icon></div><div class="btn" data-type="brackets"><x-icon name="brackets"></x-icon></div></div><div class="error"><x-icon name="warning"></x-icon></div><div class="error-message"></div>';var Es=ce;function yu(e){let s=e.prev;s&&Y(s.tagName,"MO","MI","MN")?s.insertBefore(e):s?_(s.children).append(e):e.parent.hasClass("math")||(e.parent.prev?e.parent.prev.append(e):e.parent.parent.insertBefore(e))}function S2(e){let s=e.next;if(s&&Y(s.tagName,"MO","MI","MN"))return s.insertAfter(e);s?s.children[0].prepend(e):e.parent.hasClass("math")||(e.parent.next?e.parent.next.prepend(e):e.parent.parent.insertAfter(e))}function T2(e){let s=e.parent;for(;s.parent.tagName!=="MFRAC"||!s.prev;){if(s.hasClass("math"))return;s=s.parent}s.prev.append(e)}function C2(e){let s=e.parent;for(;s.parent.tagName!=="MFRAC"||!s.next;){if(s.hasClass("math"))return;s=s.parent}s.next.prepend(e)}function M2(e){let s=e.prev,t=e.parent;if(s&&Y(s.tagName,"MO","MI","MN"))s.remove(),t.children.length<=1&&t.addClass("empty");else if(!s&&!t.prev&&!t.hasClass("math")){let i=t.parent;i.insertBefore(e);for(let n of i.children)for(let r of n.children)i.insertBefore(r);i.remove(),e.parent.children.length<=1&&e.parent.addClass("empty")}else yu(e)}function ni(e,s){s.insertBefore(e),s.parent.removeClass("empty"),e.children.length&&e.children[0].append(s)}function vu(e,s){"abcdefghijklmnopqrstuvwxyz\u03C0".includes(s)?ni(c("mi",{text:s}),e):"0123456789.".includes(s)?ni(c("mn",{text:s}),e):"+\u2212\xB1\xD7\xF7<>\u2264\u2265=%!".includes(s)?ni(c("mo",{text:s,value:s}),e):s==="frac"?ni(c("mfrac",{html:'<mrow class="empty"></mrow><mrow class="empty"></mrow>'}),e):s==="sqrt"?ni(c("msqrt",{html:'<mrow class="empty"></mrow>'}),e):Y(s,"^","sup")?ni(c("msup",{html:'<mrow class="empty"></mrow>'}),e):s==="brackets"||"([{|".includes(s)?ni(c("mfenced",{html:'<mrow class="empty"></mrow>',type:"("}),e):")]}".includes(s)&&!e.next&&e.parent.parent.tagName==="MFENCED"&&e.parent.parent.insertAfter(e)}function wu(e,s){let t=e.$$(`${s}:first-child, *:not(${s}) + ${s}`);for(let i of t)if(i.parent.tagName!=="MFRAC")for(;i.next&&i.next.tagName===s.toUpperCase();)i.text+=i.next.text,i.next.remove()}var E2="This is not a valid mathematical expression.",A2="Fill in all empty placeholders in the expression.",V2={"+":"addition","\xD7":"multiplication","/":"fractions or division","\u2212":"subtraction",sqrt:"square roots","^":"powers"};function ri(e,s){if(e instanceof Text)return e.textContent||"";if(e.hasClass("cursor"))return"";let t=e.childNodes;return e.tagName==="MI"?e.text+(s?" ":""):e.tagName==="MFENCED"?"("+ri(t[0],s)+")":e.tagName==="MSUP"?"^("+ri(t[0],s)+")":e.tagName==="MFRAC"?`(${ri(t[0],s)})/(${ri(t[1],s)})`:e.tagName==="MSQRT"?"sqrt("+ri(t[0],s)+")":t.map(i=>ri(i,s)).join("")}function k2(e,s){try{return{expr:Ot.parse(e,!0,{variables:s})}}catch(t){return{error:t instanceof tt?t.message:E2}}}function O2(e,s,t){let i=e.variables;if(s.length){let n=i.find(o=>!s.includes(o));if(n){let o=Qc(n,t||s);return o?`Did you mean \u201C<em>${o}</em>\u201D instead of \u201C<em>${n}</em>\u201D?`:`There shouldn\u2019t be a variable called \u201C<em>${n}</em>\u201D.`}let r=s.find(o=>!i.includes(o));if(r)return`Your expression should contain \u201C<em>${r}</em>\u201D.`}}function L2(e,s){if(s.length){let t=e.functions.find(i=>!s.includes(i));if(t)return`This expression should not contain ${V2[t]||"\u201C"+t+"\u201D"}.`}}function R2(e,s,t=.001){try{return P(e.evaluate(),s.evaluate(),t)}catch(i){return!1}}var vo=class extends O{constructor(){super(...arguments);this.isDone=!1;this.shortVar=!1;this.lastAttempt="";this.errorCount=0;this.hints=[];this.fns=[];this.vars=[];this.validate=void 0}ready(){if(this.$math=this.$(".math"),this.$textarea=this.$("textarea"),this.$cursor=this.$(".cursor"),this.$error=this.$(".error-message"),this.solution=Ot.parse(this.attr("solution")),this.hasAttr("numeric")&&(this.numeric=+this.attr("precision")||.01),this.vars=this.hasAttr("vars")?lt(this.attr("vars")):this.solution?this.solution.variables:[],this.hasAttr("fns")&&(this.fns=lt(this.attr("fns"))),this.solution&&this.fns.push(...this.solution.functions),this.fns.includes("/")&&!this.fns.includes("\xD7")&&this.fns.push("\xD7"),this.hasAttr("hints")&&(this.hints=lt(this.attr("hints"))),this.hasAttr("substitutions")){this.substitutions={},this.autocomplete=this.vars.slice(0);for(let n of this.attr("substitutions").split("|"))if(n.trim()){let[r,o]=n.split(":");this.autocomplete.push(r.trim()),this.substitutions[r.trim()]=Ot.parse(o)}}for(let n of["solution","precision","vars","fns","vars-required","substitutions"])this.removeAttr(n);this.shortVar=this.hasAttr("short-var");let t=lt(this.attr("keys")||"+ \u2212 \xD7 \xF7 frac sup sqrt brackets"),i=this.$(".keys");for(let n of i.children)t.includes(n.data.type)?(n.on("pointerdown",r=>r.preventDefault()),n.on("pointerup",()=>{vu(this.$cursor,n.data.type),this.check()})):n.remove();this.on("pointerdown",n=>this.onPointerdown(n)),this.$textarea.on("focus",()=>this.onPointerdown()),this.$textarea.on("blur",()=>this.onBlur()),this.$textarea.on("key",n=>this.onKey(n))}setup(t,i,n){var r;this.$step=t,(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(),this.on("solve",()=>{t.addHint("correct"),t.score(i)})}focus(){this.trigger("pointerdown")}onPointerdown(t){if(this.isDone)return;t&&t.preventDefault&&t.preventDefault(),this.addClass("active"),this.$textarea.focus();let i=t&&t.target?G(t.target):this;if(i.tagName==="X-EQUATION"||i.hasClass("math")){let n=this.$math.children,r=q(n.map(a=>a.outerWidth))/2;(t?Qt(t).x<this.$math.bounds.left+r:!0)?this.$math.prepend(this.$cursor):this.$math.append(this.$cursor)}else if(i.tagName[0]==="M"){let n=Qt(t).x<i.boxCenter.x;i.tagName==="MROW"?n?i.prepend(this.$cursor):i.append(this.$cursor):n?i.insertBefore(this.$cursor):i.insertAfter(this.$cursor)}}onKey(t){if(Y(t.code,Es.enter,Es.escape))this.$textarea.blur();else if(t.code===Es.left)yu(this.$cursor);else if(t.code===Es.right)S2(this.$cursor);else if(t.code===Es.up)T2(this.$cursor);else if(t.code===Es.down)C2(this.$cursor);else if(Y(t.code,Es.backspace,Es.delete))M2(this.$cursor),this.check();else{let i=t.key.replace("*","\xD7").replace("/","\xF7").replace("-","\u2212");vu(this.$cursor,i),this.check()}}onBlur(){if(this.isDone)return;if(!this.value)return this.removeClass("active has-error");if(this.removeClass("active"),this.addClass("has-error"),this.value===this.lastAttempt||(this.lastAttempt=this.value,!this.$step))return;let t=this.error||(this.hints||[]).shift()||"incorrect",i=this.$step.addHint(t,{class:"incorrect"});this.$error.html=(i==null?void 0:i.text)||"",this.errorCount+=1,this.trigger("error",{count:this.errorCount,msg:t}),this.errorCount>=5&&this.$step.addHint(`Hmmm\u2026 maybe try ${this.solution.toMathML()}?`)}check(){if(this.error=void 0,this.value=ri(this.$math,this.shortVar).trim(),!this.value)return;if(this.$math.$(".empty"))return this.error=A2;let t=k2(this.value,this.vars);if(t.error)return this.error=t.error;let i=this.substitutions?t.expr.substitute(this.substitutions):t.expr;if(this.numeric&&R2(this.solution,i,this.numeric))return this.solve();if(this.validate){let o=this.validate(t.expr)||{};if(o.isCorrect)return this.complete(t.expr);if(o.error)return this.error=o.error}if(this.solution&&Ot.numEquals(this.solution,i))return this.complete(t.expr);let n=O2(i,this.vars,this.autocomplete);if(n)return this.error=n;let r=L2(i,this.fns);if(r)return this.error=r}complete(t){this.isDone||(this.isDone=!0,this.removeClass("has-error active"),this.addClass("done"),this.$textarea.blur(),this.shortVar||wu(this.$math,"mi"),wu(this.$math,"mn"),this.trigger("solve",{expr:t}))}solve(){this.$math.removeClass("empty"),this.$math.html=this.solution.toMathML(),this.complete(this.solution)}};vo=N([V("x-equation",{template:gu})],vo);var I2={opacity:[0,1],transform:["translateX(-50px)","none"]},N2={error:"You\u2019ve already had this expression before. Try simplifying it."},G2="You have to fully simplify this expression. The correct solution is $0.",wo=class extends O{constructor(){super(...arguments);this.rowCount=1;this.previousAnswers=[];this.isSolved=!1;this.maxRows=6;this.steps=[];this.hints=[]}created(){this.$table=this.$("table tbody"),this.lastRowContent=this.$table.$("tr:last-child").html}ready(){this.hasAttr("max-rows")&&(this.maxRows=+this.attr("max-rows")),this.hasAttr("steps")&&(this.steps=this.attr("steps").split("|")),this.hasAttr("hints")&&(this.hints=this.attr("hints").split("|")),this.removeAttr("steps"),this.removeAttr("hints"),this.setupEquation(this.$("x-equation"))}setup(t,i,n){var r;this.$step=this.$equation.$step=t,(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(),this.on("solve",()=>{t.addHint("correct"),t.score(i)}),this.on("hint",o=>t.addHint(o))}setupEquation(t){this.$equation=t,this.$equation.$step=this.$step,t.one("solve",i=>this.onSolveRow(i.expr)),t.hints=this.hints,t.validate=i=>{let n=this.previousAnswers.includes(i.toString());return(this.validate?this.validate(i,n):void 0)||(n?N2:{})}}onSolveRow(t){if(this.trigger("solve-row",{expr:t,$math:this.$equation.$math}),this.isFinal&&this.isFinal(t))return this.trigger("solve");if(this.isSolved)return;if(this.rowCount+=1,this.previousAnswers.push(t.toString()),this.rowCount>this.maxRows){let n=this.$equation.solution.toMathML();this.trigger("hint",G2.replace("$0",n)),this.trigger("solve")}let i=c("tr",{html:this.lastRowContent},this.$table);i.animate(I2,400,500),this.setupEquation(i.$("x-equation")),setTimeout(()=>this.$equation.focus(),1200)}solve(){if(this.isSolved=!0,this.steps.length){let t=this.$table.$("tr:last-child"),i=this.lastRowContent.replace(/<x-equation.*<\/x-equation>/,'<span class="math fill"></span>');for(let n of this.steps){let r=c("tr",{html:i},this.$table),o=r.$(".math.fill"),a=Ot.parse(n);o.html=a.toMathML(),t.insertBefore(r),this.trigger("solve-row",{expr:a,$math:o})}}this.$equation.solve()}};wo=N([V("x-equation-system")],wo);var dt=Math.PI/2;function yo(e){if(yt(e))return[e];if(oe(e))return e.points;if(Oe(e))return[e.p1,e.p2];if(ae(e))return yo(e.shape(!0));if(ct(e))return[e.c.shift(e.r,0),e.c.shift(-e.r,0),e.c.shift(0,e.r),e.c.shift(0,-e.r)];if(ze(e)||ne(e)){let s=[e.start,e.end];ze(e)&&s.push(e.c);let t=e.radius;for(let[i,n]of[[t,0],[0,t],[-t,0],[0,-t]]){let r=e.c.shift(i,n);re.prototype.contains.call(e,r)&&s.push(r)}return s}return[]}function we(...e){return x.aroundPoints(function*(){for(let s of e)for(let t of yo(s))yield t}())}function $o(e,s,t=0){if(!e.size&&!s.size)return new kt(0,100,0,100);let i=x.aroundPoints(function*(){for(let n of e.values())if(n.transformed&&!n.hidden)for(let r of yo(n.transformed))yield r;for(let n of s.values())if(n.path)for(let r of yo(n.path))yield r}());return new kt(i.p.x-t,i.p.x+i.w+t,i.p.y-t,i.p.y+i.h+t)}function Bi(e,s,t){if(yt(s))return e.contains(s);if(Pi(s))return M.collision(e.polygon,s);if(vn(s))return s.collision(e);if(Mt(s))return ft(s,e).length>0||e.contains(s.p1);if(ae(s))return Bi(e,s.shape(!0),t);if(ct(s))return t==="geo"?ft(s,e).length>0||e.contains(s.at(0)):s.collision(e);if(ze(s)){let i=new M(s.c,s.start,s.at(.25),s.at(.5),s.at(.75),s.end);return M.collision(e.polygon,i)}return!1}var bo=class{constructor(s){this.$parent=s;this.visible=!1;this.$el=c("div",{class:"tile-error",hidden:!0},s.$html),this.$text=c("span",{},this.$el),this.$button=c("button",{text:"Select Errors"},this.$el),this.$button.on("click",()=>{s.selection.clear(),this.error&&s.selection.select(this.error.locations),this.hide()})}show(s,t){this.visible&&this.error===t||(this.visible=!0,this.$el.setTransform(s),this.$text.html=t.message,this.$button.toggle(!!(t!=null&&t.locations.length)),this.$el.enter("pop",200),this.error=t)}hide(){!this.visible||(this.visible=!1,this.$el.exit("pop",200),this.error=void 0)}},zh=new Map;function E(e){if(!e||!b.theme.isDark)return e;if(zh.has(e))return zh.get(e);let s=F.fromHex(e),t=s.hsl;st(t[2],20,80)||(t[2]=100-t[2]);let i=F.fromHsl(...t);i.a=s.a;let n=i.hex;return zh.set(e,n),n}function bu(e){let s=e==null?void 0:e.items;if(!!(s!=null&&s.length))for(let t=0;t<s.length;++t){if(!s[t].type.startsWith("image/"))continue;let i=s[t].getAsFile();if(i)return i}}var D2=80,_2=[5,2,1];function As(e,s,t,i=.01){let n=e?e.split(","):[];if(n.length===3)return n.map(f=>+f);let r=n.length>0?+n[0]:t?t[0]:0,o=n.length>1?+n[1]:t?t[1]:s;if(P(r,o))return[r-1,o+1,1];i&&(o+=.01*(o-r));let a=Math.floor(Math.abs(s)/D2),l=(o-r)/a,h=Math.floor(Math.log10(l)),d=Math.pow(10,h),u=_2.find(f=>d*f<=l)*d;return o=u*Math.ceil(o/u),r=u*Math.floor(r/u),[r,o,u]}function xo(e,s=4e3){let t=G(`x-alert[key=${e}]`);return t==null?void 0:t.open(s)}function $u(e){var s;if(!["span","div","br"].includes(e.tagName.toLowerCase()))(s=e.parentElement)==null||s.removeChild(e);else{for(let t of Array.from(e.attributes))t.name==="style"?t.value=(t.value||"").replace(/[^\w\s.:;\-%]/g,""):e.removeAttributeNode(t);for(let t of Array.from(e.children))$u(t)}}function xu(e){let t=new DOMParser().parseFromString(e,"text/html").body;for(let i of Array.from(t.children))$u(i);return t.innerHTML}function Fh(e){let s=Math.min(...e.map(i=>Math.min(...i.map(n=>n.y)))),t=Math.max(...e.map(i=>Math.max(...i.map(n=>n.y))));return[s,t]}function Qe(e,s,t){return e.hasAttr(s)?e.attr(s)!=="no":t}function Pu(e){let s=lt(e).map(t=>+t);return s.length===1?[s[0],s[0],s[0],s[0]]:s.length===2?[s[0],s[1],s[0],s[1]]:s.length===3?[s[0],s[1],s[2],s[1]]:s}function Su(e){let s=e.split(",");return[s[0]!=="no",(s.length>1?s[1]:s[0])!=="no"]}var Tu={hasGeoModel:!0,pi:Math.PI,point:(e,s)=>e!==void 0&&s!==void 0?new p(e,s):void 0,angle:(e,s,t)=>e&&s&&t?new Vt(e,s,t):void 0,line:(e,s)=>e&&s&&!e.equals(s)?new wt(e,s):void 0,ray:(e,s)=>e&&s&&!e.equals(s)?new Zl(e,s):void 0,segment:(e,s)=>e&&s&&!e.equals(s)?new it(e,s):void 0,circle:(e,s)=>e&&s?new H(e,s):void 0,arc:(e,s,t)=>e&&s&&t?new re(e,s,t):void 0,sector:(e,s,t)=>e&&s&&t?new qe(e,s,t):void 0,polygon:(...e)=>e.every(s=>s)?new M(...e):void 0,polyline:(...e)=>e.every(s=>s)?new le(...e):void 0,triangle:(e,s,t)=>e&&s&&t?new wn(e,s,t):void 0,rectangle:(e,s,t)=>e?new x(e,s,t):void 0,distance:p.distance,round:(e,s=0)=>Ft(e,s),sqrt:Math.sqrt,floor:Math.floor,ceil:Math.ceil,intersections:ft};function Po(e,s,t){let i=t,n;for(let r of e){let o=s(r);o!==void 0&&o<i&&(i=o,n=r)}return n}function Cu(e,s){s.clear();for(let t of e)if(!(t.isHidden||!t.value))for(let i of e){if(t.isHidden||!i.value||t===i)continue;let n=ft(t.value,i.value);for(let[r,o]of n.entries())s.add({path1:t,path2:i,posn:o,index:r})}}var Mu="M100,50h0l-5.2-4.9L52.6,10.2v-9C52.6.6,51.4,0,50,0s-2.6.6-2.6,1.2v9L5.2,45.1,0,50H0l6.6-3L35,25.9H65L93.4,47ZM38.4,23.5,50,14.8l11.6,8.7Z",Eu="M0,0V8H100V0ZM7,6A2,2,0,1,1,9,4,2,2,0,0,1,7,6Z";function oi(e,s,t,i){return`translate(${e.x}px, ${e.y-s}px) scale(${i/100}) rotate(${t}rad)`}var Au=4,H2=`<marker id="axis-arrow" refX="3" refY="3" markerWidth="6"
    markerHeight="6" orient="auto"><path d="M 0 0 L 6 3 L 0 6 z"/></marker>`,Vs=class extends O{constructor(){super(...arguments);this.labelSuffix=["",""];this.gridSize=[1,1];this.showGrid=!1;this.showXAxis=!1;this.showYAxis=!1;this.showLabels=!1}setupCoordinates(t,i={}){this.$svg=t,t.addClass("canvas"),this.proportional=!!i.proportional,this.padding=Pu(this.attr("padding")||i.padding||"0"),Qe(this,"grid",i.showGrid||!1)&&(this.$grid=c("g",{class:"grid"}),t.prepend(this.$grid),this.showGrid=!0);let n=this.attr("axes")||(i.showAxes?"yes":"no");[this.showXAxis,this.showYAxis]=Su(n),(this.showXAxis||this.showYAxis)&&(c("defs",{html:H2},t),this.$axes=c("g",{class:"axes"}),t.prepend(this.$axes),this.axisNames=(this.attr("axis-names")||",").split(",")),this.$axes&&Qe(this,"labels",!0)&&(this.labelSuffix=(this.attr("label-suffix")||",").split(","),this.showLabels=!0),(this.showLabels||this.axisNames)&&(this.$labels=c("g",{class:"labels"},t)),this.resize()}resize(){this.css("max-width","none");let t=+this.attr("width")||this.width,i=+this.attr("height")||(this.hasAttr("width")?t:this.height);this.css("max-width",t+"px"),this.$svg.setAttr("width",t),this.$svg.setAttr("height",i),this.$svg.setAttr("viewBox",`0 0 ${t} ${i}`);let n=this.padding;this.viewportBounds=new kt(n[3],t-n[1],n[0],i-n[2]),this.updatePlotBounds(),this.positionElements(t,i)}updatePlotBounds(t){let[i,n,r]=As(this.attr("x-axis"),this.viewportBounds.dx,t==null?void 0:t.xRange),[o,a,l]=As(this.attr("y-axis"),this.viewportBounds.dy,t==null?void 0:t.yRange),h=Math.abs(this.viewportBounds.dx/(n-i)),d=Math.abs(this.viewportBounds.dy/(a-o)),u=Math.min(h,d),f=this.proportional?h/u:1,v=this.proportional?d/u:1;this.plotBounds=new kt(f*i,f*n,v*a,v*o),this.plotScale=this.proportional?u:(h+d)/2,this.gridSize=[r,l];let[w,g]=[this.plotBounds,this.viewportBounds];this.plotToViewportMatrix=[[g.dx/w.dx,0,g.xMin-w.xMin/w.dx*g.dx],[0,g.dy/w.dy,g.yMin-w.yMin/w.dy*g.dy]];let y=i>0?f*i:n<0?f*n:0,C=o>0?v*o:a<0?v*a:0;this.plotOrigin=new p(y,C),this.drawAxes()}drawAxes(){let[t,i]=[this.plotBounds,this.viewportBounds],n=this.toViewportCoords(this.plotOrigin),[r,o]=this.gridSize;if(this.$grid&&this.$grid.removeChildren(),this.$axes&&this.$axes.removeChildren(),this.$labels&&this.$labels.removeChildren(),this.showGrid||this.showXAxis){let a=r*Math.trunc(t.xMin/r+.01);for(let l=a;l<t.xMax;l+=r){if(this.showYAxis&&l===this.plotOrigin.x)continue;let h=this.toViewportCoords(new p(l,0)).x;this.showGrid&&c("line",{x1:h,y1:i.yMin,x2:h,y2:i.yMax},this.$grid),this.showLabels&&this.makeLabel(0,l,h,n)}}if(this.showGrid||this.showYAxis){let[a,l]=t.yMin<t.yMax?[t.yMin,t.yMax]:[t.yMax,t.yMin],h=o*Math.trunc(a/o+.01);for(let d=h;d<l;d+=o){if(this.showXAxis&&d===this.plotOrigin.y)continue;let u=this.toViewportCoords(new p(0,d)).y;this.showGrid&&c("line",{x1:i.xMin,y1:u,x2:i.xMax,y2:u},this.$grid),this.showLabels&&this.makeLabel(1,d,u,n)}}this.showXAxis&&(this.$xAxis=c("line",{x1:i.xMin,x2:i.xMax,y1:n.y,y2:n.y},this.$axes)),this.showYAxis&&(this.$yAxis=c("line",{x1:n.x,x2:n.x,y1:i.yMax,y2:i.yMin},this.$axes)),this.showLabels&&this.showXAxis&&this.showYAxis&&(t.xMin===0&&t.yMax===0&&!this.labelSuffix[0]&&!this.labelSuffix[1]?c("text",{text:0,x:n.x-5,y:n.y+15,"text-anchor":"end"},this.$labels):t.yMax===this.plotOrigin.y?this.makeLabel(0,this.plotOrigin.x,n.x,n):this.makeLabel(1,this.plotOrigin.y,n.y,n)),this.axisNames&&(this.axisNames[0]&&c("text",{text:this.axisNames[0],x:this.viewportBounds.xMax-2,y:n.y-12,"text-anchor":"end"},this.$labels),this.axisNames[1]&&c("text",{text:this.axisNames[1],x:n.x+10,y:this.viewportBounds.yMin+5},this.$labels))}makeLabel(t,i,n,r){let o=this.labelSuffix[t],a=o==="i"?new Tt(0,i).toString():nt(i,4)+o;c("text",{text:a,x:t?r.x-8:n,y:t?n+4:r.y+18,"text-anchor":t?"end":"middle"},this.$labels),c("line",{class:"tick",x1:t?r.x:n,y1:t?n:r.y,x2:t?r.x-Au:n,y2:t?n:r.y+Au},this.$axes)}positionElements(t,i){for(let n of this.$$("[data-bounds]")){let r=n.data.bounds.split(","),o=this.toViewportCoords(new p(+r[3],+r[0])),a=this.toViewportCoords(new p(+r[1],+r[2]));n.css({left:`${o.x/t*100}%`,top:`${o.y/i*100}%`,width:`${(a.x-o.x)/t*100}%`,height:`${(a.y-o.y)/i*100}%`})}}toPlotCoords(t){return t.changeCoordinates(this.viewportBounds,this.plotBounds)}toViewportCoords(t){return t.transform(this.plotToViewportMatrix)}};var So=class extends Vs{constructor(){super(...arguments);this.steps=400}ready(){let t=c("svg",{},this),i=c("g",{class:"plot"},t);this.$path=c("path",{},i),this.setupCoordinates(t,{showGrid:!0,showAxes:!0,padding:"20"}),this.clear();let n=this.viewportBounds,r=this.steps/n.dx,o;Fs(t,{start:()=>o=void 0,move:a=>{let l=S(Math.round((a.x-n.xMin)*r),0,this.steps-1);this.points[l]=this.toPlotCoords(new p(n.xMin+l/r,a.y)),o&&this.interpolate(o,l),o=l,this.redraw()},end:()=>this.snap()})}interpolate(t,i){i<t&&([t,i]=[i,t]);let n=this.points[t],r=this.points[i];for(let o=t+1;o<i;++o)this.points[o]=p.interpolate(n,r,(o-t)/(i-t))}redraw(){let t="",i=!0;for(let n of this.points){if(n){let r=this.toViewportCoords(n);t+=(i?"M":"L")+`${r.x},${r.y}`}i=!n}this.$path.setAttr("d",t)}snap(){let t=this.points.filter(n=>n).map(n=>[n.x,n.y]),i=zl.bestPolynomial(t);if(!!i){for(let n=0;n<this.steps;++n){if(!this.points[n])continue;let r=this.plotBounds.xMin+n/this.steps*this.plotBounds.dx;this.points[n]=new p(r,i.fn(r))}this.redraw(),this.trigger("snap",{regression:i})}}clear(){this.points=zt(void 0,this.steps),this.$path.setAttr("d","")}};So=N([V("x-coordinate-sketch")],So);var B2=2,Vu=5e3,To=class extends Vs{constructor(){super(...arguments);this.isAnimated=this.hasAttr("animate");this.crosshairGrid=10;this.getCrosshairPosn=t=>t}ready(){let t=c("svg",{},this);if(this.$plot=c("g",{class:"plot"},t),this.$overlay=c("g",{class:"overlay"},t),this.setupCoordinates(t,{showGrid:!0,showAxes:!0,padding:"20"}),this.hasAttr("fn")){let i=Ot.parse(this.attr("fn"),!0);this.setFunctions(n=>i.evaluate({x:n}))}Qe(this,"crosshairs",!0)&&(this.crosshairGrid=+this.attr("crosshair-grid")||10,this.setupCrosshairs(t))}setPoints(t,i=1){let n=t.map((r,o)=>new p(o+i,r));this.setSeries(n)}setSeries(...t){let i=Math.max(...t.map(o=>_(o).x)),[n,r]=Fh(t);this.updatePlotBounds(new kt(0,i,n,r)),this.$plot.removeChildren();for(let o of t)this.drawLinePlot(o);this.getCrosshairPosn=o=>t[0].reduce((a,l)=>Math.abs(l.x-o.x)<=Math.abs(a.x-o.x)?l:a)}setFunctions(...t){let[i,n]=[this.plotBounds,this.viewportBounds],r=t.map(h=>{let d=[];for(let u=n.xMin;u<n.xMax;u+=B2){let f=this.toPlotCoords(new p(u,0)).x;d.push(new p(f,h(f)))}return d}),[o,a]=Fh(r);this.updatePlotBounds(new kt(i.xMin,i.xMax,o,a)),this.$plot.removeChildren();for(let h of r)this.drawLinePlot(h);let l=this.gridSize[0]/this.crosshairGrid;this.getCrosshairPosn=h=>{let d=ht(S(h.x,i.xMin,i.xMax),l);return new p(d,t[0](d))}}drawLinePlot(t){let i=c("g",{},this.$plot),n=c("path",{},i),r=this.plotBounds;t=t.filter(a=>a.y>=r.yMax&&a.y<=r.yMin);let o=t.map(a=>this.toViewportCoords(a));this.isAnimated?K(a=>{let l=t.findIndex(h=>h.x>r.xMin+a*r.dx);n.points=o.slice(0,l)},Vu):n.points=o}drawPoints(t){let i=c("g",{},this.$plot),n=this.plotBounds;for(let r of t){let o=this.toViewportCoords(r),a=c("circle",{r:4,cx:o.x,cy:o.y},i);if(this.isAnimated){a.hide();let l=Vu*(r.x-n.xMin)/(n.xMax-n.xMin);setTimeout(()=>a.show(),l)}}}setupCrosshairs(t){let i=c("g",{class:"crosshair"},t),n=c("path",{},i),r=c("circle",{r:4},i),o=c("text",{},i),a=0,l=h=>{let d=this.getCrosshairPosn(this.toPlotCoords(h));if(P(d.x,a))return;a=d.x;let u=this.toViewportCoords(d),f=this.toViewportCoords(this.plotOrigin);r.setCenter(u),n.points=[new p(f.x,u.y),u,new p(u.x,f.y)],o.text=`(${nt(d.x,5,!1)}, ${nt(d.y,5,!1)})`;let v=o.width,w=u.x+8+v<this.viewportBounds.dx;o.setAttr("x",w?u.x+5:u.x-v-5),o.setAttr("y",u.y>20?u.y-7:u.y+18)};qd(t,{enter:()=>i.show(),move:h=>l(h),exit:()=>i.hide()})}};To=N([V("x-coordinate-system")],To);var qi=class{constructor(s,t){this.$canvas=s;this.defaultCallbacks=t;this.callbacks=new WeakMap;this.global=[];this.isMoving=!1;this.shiftKey=!1;this.altKey=!1;this.cancelled=!1;setTimeout(()=>{document.addEventListener("keydown",i=>{this.shiftKey=i.shiftKey,this.altKey=i.altKey}),document.addEventListener("keyup",i=>{this.shiftKey=i.shiftKey,this.altKey=i.altKey}),document.addEventListener("visibilitychange",()=>{this.shiftKey=this.altKey=!1})},2e3),s.css("touch-action","none"),s.on("pointerdown",i=>this.startEvent(i)),b.onKey("escape",()=>this.cancel()),t.hover&&s.on("pointermove",i=>{this.isMoving||t.hover({posn:Se(i,s),event:i})})}listen(s,t){this.callbacks.set(s._el,t),s.hasParent(this.$canvas)||(s.css("touch-action","none"),s.on("pointerdown",i=>this.startEvent(i)))}listenAll(s){this.global.push(s)}startEvent(s){var d,u,f;if(s.handled||s.button)return;this.isMoving=!0,this.cancelled=!1,s.preventDefault();let t=s.pointerId,i=this.getCallbacks(s.target);"shiftKey"in s&&(this.shiftKey=s.shiftKey),i.blurInput!==!1&&((d=b.getActiveInput())==null||d.blur());let n=Se(s,this.$canvas),r=n,o=!1,a=v=>{var y,C,A,L;if(v.pointerId&&v.pointerId!==t)return;if(v.preventDefault(),this.cancelled)return l(v);let w=Se(v,this.$canvas);if(p.distance(w,r)<.5)return;if(!o){let k={posn:n,event:v};(y=i.start)==null||y.call(i,k);for(let rt of this.global)(C=rt.start)==null||C.call(rt,k)}let g={posn:w,startPosn:n,lastPosn:r,event:v};(A=i.move)==null||A.call(i,g);for(let k of this.global)(L=k.move)==null||L.call(k,g);!o&&i.cursor!==!1&&Ut.addClass("grabbing"),r=w,o=!0},l=v=>{var g,y,C,A,L,k;if(v.pointerId&&v.pointerId!==t)return;v.preventDefault(),Z.off("pointermove",a),Z.off("pointerstop",l);let w={posn:n,event:v};(g=i.up)==null||g.call(i,w);for(let rt of this.global)(y=rt.up)==null||y.call(rt,w);if(o){let rt={posn:r,lastPosn:r,startPosn:n,event:v,cancelled:this.cancelled};(C=i.end)==null||C.call(i,rt);for(let _t of this.global)(A=_t.end)==null||A.call(_t,rt)}else if(!this.cancelled){let rt={posn:n,event:v};(L=i.click)==null||L.call(i,rt);for(let _t of this.global)(k=_t.click)==null||k.call(_t,rt)}Ut.removeClass("grabbing"),this.isMoving=this.cancelled=!1},h={posn:n,event:s};(u=i.down)==null||u.call(i,h);for(let v of this.global)(f=v.down)==null||f.call(v,h);Z.on("pointermove",a),Z.on("pointerstop",l)}getCallbacks(s){for(;s;){let t=this.callbacks.get(s);if(t&&(!t.checkIfActive||t.checkIfActive()))return t;s=s.parentNode||void 0}return this.defaultCallbacks}cancel(){this.cancelled=!0}};function q2(e,s){if(typeof e=="string"){let t=Pt(e);return i=>{var n;return(n=t(s))==null?void 0:n.equals(i)}}return typeof e=="function"?e:t=>e.equals(t)}function jh(e,s,t){let i=s.map(v=>q2(v,e.model)),n=zt(void 0,s.length),r=vs(),o=[],a=({point:v})=>o.push(v),l=t.maxErrors||4,h=0,d=({path:v})=>{t.onBegin&&t.onBegin(v)},u=()=>{n.every(v=>v)&&(t.onComplete&&t.onComplete(!0),e.off("add:path",f),e.off("begin:path",d),e.off("add:point",a),r.resolve(n))},f=({path:v})=>{let w=v.value;if(!!w){for(let[g,y]of i.entries())if(!n[g]&&y(w))return n[g]=v,t.onCorrect&&t.onCorrect(v,g),h=0,o=[],u();v.delete();for(let g of o)g.delete();if(o=[],!(Mt(w)&&w.length<1))if(h+=1,h>=l){let g=n.findIndex(C=>!C),y=s[g];if(typeof y!="function"){let C=e.drawPath(y,{animated:1e3});n[g]=C,t.onHint&&t.onHint(C,g),h=0,u()}}else t.onIncorrect&&t.onIncorrect(v)}};return e.on("begin:path",d),e.on("add:path",f),e.on("add:point",a),r.promise}function Lu(e,s){return c("text",{target:e.attr("target")||void 0,class:e.attr("label-class")||e.attr("class")||void 0,"data-when":e.data.when,style:s?`color: ${s}`:void 0,"text-anchor":"middle"})}function ku(e,s){let t=[];for(let i of s.paths)i!==e&&i.value&&t.push(i.value.transform(s.plotToViewportMatrix));return t}var z2=new H(new p(0,-9),12);function Ou(e,s,t){for(let i of t)if(s.every(n=>!ft(z2.translate(i),n).length))return i;return t[0]}function Ru(e,s){let t=e.value.transform(s.plotToViewportMatrix),i=e.$el;if(Mt(t)){let n=t.perpendicularVector,r=t.angle;n.y>=0&&(n=n.scale(-1),r+=Math.PI);let o=[];for(let h of[.5,.35,.65])for(let d of[-15,5])o.push(t.at(h).add(n.scale(d)));if(!s.labelPositioning)return[o[0],r];let a=ku(e,s),l=Ou(t,a,o);return i.hasAttr("mark")&&(l=l.add(t.unitVector.scale(12))),[l,r]}if(ze(t))return[t.at(.5).subtract(t.c).scale(.6).add(t.c).shift(0,5)];if(ne(t)){let n=new wt(t.start,t.end),r=n.perpendicularVector.y>=0,o=n.angle+(r?Math.PI:0);return[t.at(.5).add(n.perpendicularVector.scale(r?14:5)),o]}if(ae(t)){let n=(+i.attr("size")||(t.isRight&&!i.hasAttr("round")?20:t.radius))+8;return[t.b.add(t.bisector.unitVector.scale(n+5)).shift(0,3)]}if(yt(t)){let n=i.hasClass("move")?10:8,r=[t.shift(n,-n),t.shift(-n,-n),t.shift(n,10+n),t.shift(-n,10+n)];if(!s.labelPositioning)return[r[0]];let o=ku(e,s);return[Ou(t,o,r)]}return oe(t)?[t.centroid.shift(0,5)]:ct(t)?[t.c.shift(0,5)]:[]}var Co=class{constructor(s,t,i,n){this.$parent=s;this.$el=i;this.color="";this.label="";this.isPending=!1;this.isLocked=!1;this.components=[];this.dependencies=[];this.fixedLabel=!1;this.name=n||s.model.getKey(),s.shapes.set(this.name,this),s.model.watch(r=>{let o=r[this.name];this.$el.css("display",o?"block":"none"),this.$label&&this.$label.css("display",o?"block":"none"),o&&this.redraw(o),s.queueLabelPositioning()}),this.color=i.css("color")||"",this.setValue(t),i.hasAttr("label")&&this.setLabel(i.attr("label"))}get value(){return this.$parent.model[this.name]}get type(){var s;return(s=this.value)==null?void 0:s.type}get locked(){return this.isLocked}get isHidden(){return this.isPending||this.$el.hasAttr("hidden")||this.$el.hasClass("transparent")}setValue(s){s instanceof Function?this.$parent.model.setComputed(this.name,s):this.$parent.model[this.name]=s}setLabel(s,t,i){this.$label||(this.$label=Lu(this.$el,t),this.$parent.$objLabels.append(this.$label));let n=Tr(s);if(this.$parent.model.watch(r=>this.$label.text=n(r)||""),this.fixedLabel=!!i,i){let r=Pt(i);this.$parent.model.watch(o=>{this.$label.setTransform(r(o).shift(0,5))})}this.updateLabelPosition()}setColor(s){this.color=s,this.$el.css("color",s);for(let t of this.dependencies)t.setColor(s);this.$label&&this.$label.css("color",s)}updateLabelPosition(){if(!this.$label||!this.value||this.fixedLabel)return;let[s,t]=Ru(this,this.$parent);this.$label.setTransform(s,t)}select(){this.$el.addClass("selected"),this.$el.parent.append(this.$el);for(let s of this.dependencies)s.select()}deselect(){this.$el.removeClass("selected");for(let s of this.dependencies)s.deselect()}hover(s=!1){if(!s){if(this.$parent.hovering===this)return;this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.hovering=this}this.$el.addClass("hover");for(let t of this.dependencies)t.hover(!0)}unhover(s=!1){if(!s){if(this.$parent.hovering!==this)return;this.$parent.hovering=void 0}this.$el.removeClass("hover");for(let t of this.dependencies)t.unhover(!0)}delete(s=300){return R(this,null,function*(){this.$parent.shapes.delete(this.name);for(let t of this.components)t.deselect();this.$label&&this.$label.exit("fade",s,0,!0),yield this.removeElement(s),this.$parent.model[this.name]=void 0})}},Je=class extends Co{constructor(t,i,n,r,o=!1){r||(r=c("circle",{}));super(t,i,r,n);this.$parent.hidePoints||t.$points.append(this.$el),t.points.add(this),this.projectionId=t.model.getKey(),this.projectionOffset=void 0,t.model.watch(a=>{this.projection=a[this.projectionId],this.projection&&(this.projectionOffset===void 0&&(this.projectionOffset=this.projection.offset(this.$parent.model[this.name])),this.$parent.model[this.name]=this.projection.at(this.projectionOffset))}),this.lock(o)}setValue(t){t instanceof Function?(this.project(void 0),this.$parent.model.setComputed(this.name,t)):(t&&this.projection&&(t=this.projection.project(t),this.projectionOffset=this.projection.offset(t)),this.$parent.model[this.name]=t)}redraw(t){let i=t.transform(this.$parent.plotToViewportMatrix);this.$el.setCenter(i),this.$halo&&this.$halo.setCenter(i),this.$pulse&&this.$pulse.setCenter(i)}removeElement(t){return R(this,null,function*(){this.$parent.points.delete(this),yield this.$el.exit("pop",t,0,!0).promise})}distance(t){return this.value?p.distance(t,this.value):1/0}lock(t=!0){this.isLocked=t,this.$el.setClass("move",!t),t?this.$el.removeAttr("tabindex"):this.$el.setAttr("tabindex",0)}project(t){if(this.projectionOffset=void 0,typeof t=="string"){let i=Pt(t);this.$parent.model.setComputed(this.projectionId,i)}else t?this.$parent.model.setComputed(this.projectionId,()=>t.value):this.$parent.model[this.projectionId]=void 0}makeIntersection({path1:t,path2:i,index:n}){this.setValue(r=>{if(!r[t.name]||!r[i.name])return;let o=ft(r[t.name],r[i.name]);return o[Math.min(n,o.length-1)]}),this.lock()}addHalo(){this.$halo=c("circle",{class:"halo",r:18},this.$parent.$pulses),this.$halo.setCenter(this.$el.center),this.$halo.enter("pop")}removeHalo(){return R(this,null,function*(){!this.$halo||(this.$halo.exit("pop",500,0,!0),this.$halo=void 0)})}pulsate(){this.$pulse=c("circle",{class:"pulse",r:8},this.$parent.$pulses),this.$pulse.setCenter(this.$el.center),this.$el.one("mouseover pointerdown focus",()=>{this.$pulse&&this.$pulse.remove(),this.$pulse=void 0})}},ps=class extends Co{constructor(s,t,i,n){super(s,t,n||c("path"),i),s.$paths.append(this.$el),s.paths.add(this)}get locked(){return this.isLocked||!this.components.length||this.components.every(s=>s.locked)}redraw(s){let t=s.transform(this.$parent.plotToViewportMatrix);this.$el.draw(t,{box:this.$parent.viewportRect})}distance(s){return this.value?p.distance(s,this.value.project(s)):1/0}removeElement(s){return R(this,null,function*(){this.$parent.paths.delete(this),yield this.$el.exit("draw",s,0,!0).promise})}setComponents(s,t){this.components=this.dependencies=s,this.setValue(()=>{let i=s.map(n=>n.value);if(!i.some(n=>n===void 0))return t(...i)})}};var Rn=class{constructor(s){this.$parent=s}enable(){}down(s){}start(s){}move(s,t){}end(s){}hover(s){}click(s){}cancel(){}snapToGrid(s){return this.$parent.snapToGrid?s.round(this.$parent.snapToGrid):s}snapToPoint(s,t){if(this.snapPoint=this.$parent.getPointAt(t),this.snapPoint)return s.$el.setClass("move",!this.snapPoint.locked),s.setValue(this.snapPoint.value);if(this.snapIntersect=this.$parent.getIntersectionAt(t),this.snapIntersect)return s.$el.removeClass("move"),s.setValue(this.snapIntersect.posn);if(!this.$parent.snapToGrid&&(this.snapPath=this.$parent.getPathAt(t),this.snapPath))return s.setValue(this.snapPath.value.project(t));s.$el.addClass("move"),s.setValue(this.snapToGrid(t))}getOrMakePointAt(s){let t=this.$parent.getPointAt(s);if(!t){t=new Je(this.$parent,this.snapToGrid(s));let i=this.$parent.getIntersectionAt(s);if(i)t.makeIntersection(i);else if(!this.$parent.snapToGrid){let n=this.$parent.getPathAt(s);n&&t.project(n)}this.$parent.trigger("add:point",{point:t})}return t}showPendingPointAt(s){var n,r,o;let t=((n=this.$parent.getIntersectionAt(s))==null?void 0:n.posn)||((o=(r=this.$parent.getPathAt(s))==null?void 0:r.value)==null?void 0:o.project(s)),i=!!t;if(this.$parent.$pendingPoint.toggle(i),i){let a=this.$parent.toViewportCoords(t||s);this.$parent.$pendingPoint.setCenter(a)}}},In=class extends Rn{constructor(){super(...arguments);this.isMoving=!1}enable(){}down(t){this.obj=this.$parent.getPointAt(t)||this.$parent.getPathAt(t),this.obj||this.$parent.deselect();let i=this.$parent.selection;i!==this.obj&&(i&&i.components.includes(this.obj)||this.$parent.select(this.obj))}start(){!this.obj||(this.isMoving=!0,this.obj.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("move",{obj:this.obj}))}move(t,i){if(!(!this.obj||this.obj.locked||this.$parent.locked))if(this.obj instanceof ps){let n=t.subtract(i);for(let r of this.obj.components)r.locked||r.setValue(r.value.add(n))}else this.obj instanceof Je&&this.obj.setValue(this.snapToGrid(t))}end(){!this.obj||(this.isMoving=!1,this.obj.isPending=!1,this.snapPoint||(this.snapIntersect?this.obj.makeIntersection(this.snapIntersect):this.snapPath&&this.obj.project(this.snapPath)),this.$parent.trigger("moveEnd",{path:this.obj}),this.obj=void 0,this.$parent.updateIntersections())}hover(t){if(this.isMoving)return;let i=this.$parent.getPointAt(t)||this.$parent.getPathAt(t),n=i&&!this.$parent.locked&&!i.locked,r=i&&this.$parent.canSelect;this.$parent.setCursor(n?"grab":r?"pointer":"default"),n||r?i.hover():this.$parent.hovering&&this.$parent.hovering.unhover()}},Mo=class extends In{down(s){this.$parent.deselect(),this.obj=this.getOrMakePointAt(s),this.$parent.select(this.obj)}hover(s){let t=this.$parent.getPointAt(s);if(t)return this.$parent.setCursor(this.$parent.locked||t.locked?"default":"grab"),this.$parent.$pendingPoint.hide(),t.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(s)}},zi=class extends Rn{enable(){this.$parent.setCursor("crosshair")}down(t){this.$parent.deselect(),this.startPoint=this.getOrMakePointAt(t)}start(t){!this.startPoint||(this.$parent.$pendingPoint.hide(),this.endPoint=new Je(this.$parent,t),this.endPoint.isPending=!0,this.endPoint.$el.addClass("pending"),this.path=new ps(this.$parent,void 0),this.path.setComponents([this.startPoint,this.endPoint],this.expr),this.path.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("begin:path",{path:this.path,start:this.startPoint}))}move(t){if(!this.startPoint||!this.path||!this.endPoint)return;if(p.distance(t,this.startPoint.value)<20/this.$parent.plotScale)return this.endPoint.setValue(this.snapToGrid(t));this.snapToPoint(this.endPoint,t)}end(){if(!this.startPoint||!this.path||!this.endPoint)return;this.path.isPending=!1,this.endPoint.isPending=!1,this.startPoint.value.equals(this.endPoint.value)?(this.endPoint.delete(),this.path.delete(),this.path=this.endPoint=void 0):this.snapPoint?(this.path.setComponents([this.startPoint,this.snapPoint],this.expr),this.endPoint.delete(),this.endPoint=void 0):this.snapIntersect?this.endPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.endPoint.project(this.snapPath),this.endPoint&&(this.$parent.trigger("add:point",{point:this.endPoint}),this.endPoint.$el.removeClass("pending"));let t=this.path;this.startPoint=this.endPoint=this.path=void 0,t&&(this.$parent.trigger("add:path",{path:t}),this.$parent.updateIntersections())}hover(t){let i=this.$parent.getPointAt(t);if(i)return this.$parent.$pendingPoint.hide(),i.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.showPendingPointAt(t)}cancel(){this.endPoint&&this.endPoint.delete(),this.path&&this.path.delete(),this.$parent.$pendingPoint.hide(),this.startPoint=this.endPoint=this.path=void 0}},Eo=class extends zi{expr(s,t){return new it(s,t)}},Ao=class extends zi{expr(s,t){return new H(s,p.distance(s,t))}},Vo=class extends zi{expr(s,t){return new x(s,t.x-s.x,t.y-s.y)}},ko=class extends zi{expr(s,t){return new it(s,t).perpendicularBisector}},Iu=(e,s,t)=>new Vt(e,s,t).bisector,Oo=class extends Rn{enable(){}down(t){if(this.$parent.deselect(),!this.firstPoint)this.firstPoint=this.getOrMakePointAt(t),this.firstPoint&&this.firstPoint.addHalo();else if(this.secondPoint){this.path.isPending=this.thirdPoint.isPending=!1,this.thirdPoint.$el.removeClass("pending"),this.firstPoint.removeHalo(),this.secondPoint.removeHalo(),this.snapPoint?(this.path.setComponents([this.firstPoint,this.secondPoint,this.snapPoint],Iu),this.thirdPoint.delete(),this.thirdPoint=void 0):this.snapIntersect?this.thirdPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.thirdPoint.project(this.snapPath);let i=this.path,n=this.thirdPoint;this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0,n&&this.$parent.trigger("add:point",{point:n}),this.$parent.trigger("add:path",{path:i}),this.$parent.updateIntersections()}else{if(this.secondPoint=this.getOrMakePointAt(t),!this.secondPoint)return;this.secondPoint.addHalo(),this.thirdPoint=new Je(this.$parent,this.secondPoint.value),this.thirdPoint.$el.addClass("pending"),this.path=new ps(this.$parent,void 0),this.path.setComponents([this.firstPoint,this.secondPoint,this.thirdPoint],Iu),this.path.isPending=this.thirdPoint.isPending=!0}}hover(t){if(this.$parent.$pendingPoint.hide(),this.thirdPoint){this.snapToPoint(this.thirdPoint,t),this.$parent.setCursor(this.snapPoint?"pointer":"crosshair");return}let i=this.$parent.getPointAt(t);if(i)return this.$parent.setCursor("pointer"),i.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(t)}cancel(){this.firstPoint&&this.firstPoint.removeHalo(),this.secondPoint&&this.secondPoint.removeHalo(),this.thirdPoint&&this.thirdPoint.delete(),this.path&&this.path.delete(),this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0}};var Nu='<x-select class="tools"><div class="tool" data-tool="move"><x-icon name="hand" size="28"></x-icon></div><div class="tool" data-tool="point"><x-icon name="geo-point" size="28"></x-icon></div><div class="tool" data-tool="line"><x-icon name="geo-line" size="28"></x-icon></div><div class="tool" data-tool="rectangle"><x-icon name="geo-rectangle" size="28"></x-icon></div><div class="tool" data-tool="circle"><x-icon name="geo-circle" size="28"></x-icon></div><div class="tool" data-tool="perpBisector"><x-icon name="geo-perp-bisector" size="28"></x-icon></div><div class="tool" data-tool="angleBisector"><x-icon name="geo-angle-bisector" size="28"></x-icon></div></x-select><slot></slot>';var Lo=class extends Vs{constructor(){super(...arguments);this.shapes=new Map;this.points=new Set;this.paths=new Set;this.intersections=new Set;this.snapToGrid=0;this.locked=!1;this.hidePoints=!1;this.canSelect=!1;this.canIntersect=!1;this.canProject=!0;this.labelPositioning=!1;this.cursor="default"}ready(){let t=this.children.filter(l=>l.tagName==="SVG")[0];if(this.hasAttr("complex")&&(this.setAttr("label-suffix",",i"),this.setAttr("axis-names","Real, Imaginary"),this.setAttr("axes","true"),this.setAttr("grid","true")),!this.hasAttr("x-axis")&&!this.hasAttr("y-axis")){let l=+this.attr("grid"),h=+this.attr("width")||this.width,d=+this.attr("height")||h;this.setAttr("x-axis",l?`-0.5,${h/l-.5},1`:`0,${h},1`),this.setAttr("y-axis",l?`${d/l-.5},-0.5,1`:`${d},0,1`),l&&this.setAttr("snap",1)}this.setupCoordinates(t,{proportional:!0}),this.viewportRect=this.viewportBounds.rect,this.model=this.getParentModel()||mt({}),this.model.hasGeoModel||this.model.assign(Tu),this.$paths=c("g",{class:"paths"},t),this.$pulses=c("g",{class:"pulses"},t),this.$points=c("g",{class:"points"},t),this.$objLabels=c("g",{class:"labels"},t),this.snapToGrid=this.hasAttr("snap")?+this.attr("snap")||1:0,this.hidePoints=this.hasAttr("no-points"),this.canIntersect=Qe(this,"intersections",!1),this.canProject=Qe(this,"projections",!0),this.canSelect=Qe(this,"selectable",!1),this.labelPositioning=Qe(this,"label-positioning",!0),this.hasClass("sticky")&&this.css("top",`calc(50vh - ${this.height/2}px)`),this.queueLabelPositioning=_e(()=>{for(let l of this.shapes.values())l.updateLabelPosition()},0,!0);let i=t.$$("path[x], path[\\:d], circle");for(let l of i){let h=l.hasAttr("x")?Pt(l.attr("x")):void 0,d=l.attr("name");if(l.hasAttr(":d"))this.$paths.append(l),l.bindModel(this.model);else if(l.tagName==="PATH")this.$paths.append(l),new ps(this,h,d,l);else{this.$points.append(l);let u=!l.hasClass("move"),f=h||l.center,v=new Je(this,f,d,l,u);l.hasAttr("project")&&v.project(l.attr("project")),l.hasClass("pulsate")&&v.pulsate()}}this.$pendingPoint=c("circle",{class:"pending"},this.$points),this.$pendingPoint.hide(),this.updateIntersections();let n={move:new In(this),point:new Mo(this),line:new Eo(this),circle:new Ao(this),perpBisector:new ko(this),angleBisector:new Oo(this),rectangle:new Vo(this)};this.$tools=this.$(".tools");let r=n[this.$tools.$active.data.tool];r.enable();let o=()=>this.toolOverride||r;this.$tools.on("change",l=>{o().cancel(),this.toolOverride=void 0,r=n[l.data.tool],this.hovering&&this.hovering.unhover(),this.$pendingPoint.hide(),this.hovering=void 0,this.deselect(),r.enable()});let a=(l,h=!1)=>this.toPlotCoords(h?l.clamp(this.viewportBounds,8):l);new qi(t,{down:l=>o().down(a(l.posn)),start:l=>o().start(a(l.posn)),move:l=>o().move(a(l.posn,!0),a(l.lastPosn,!0)),end:l=>o().end(a(l.posn,!0)),click:l=>o().click(a(l.posn)),hover:l=>o().hover(a(l.posn))}),b.onKey("escape",()=>o().cancel()),b.onKey("backspace delete",()=>this.delete()),document.addEventListener("keydown",l=>{if([37,38,39,40].indexOf(l.keyCode)<0)return;let d=b.getActiveInput();if(!(!d||!d.hasParent(this))){l.preventDefault();for(let u of this.points){if(u.$el!==d||!u.value)continue;let f=15/this.plotScale,v=this.plotBounds.yMin>this.plotBounds.yMax?-1:1,w=l.keyCode===37?-f:l.keyCode===39?f:0,g=l.keyCode===38?-v*f:l.keyCode===40?v*f:0;u.setValue(u.value.shift(w,g));return}}})}switchTool(t){this.$tools.makeActive(this.$(`.tool[data-tool="${t}"]`))}setCursor(t="default"){t!==this.cursor&&(this.cursor=t,this.$svg.css("cursor",t))}select(t){!this.canSelect||(this.deselect(),t&&(this.selection=t,t.select()),this.trigger("select",{shape:t}))}deselect(){!this.selection||(this.selection.deselect(),this.selection=void 0,this.trigger("select",{shape:void 0}))}delete(){this.hovering&&this.hovering.unhover(),this.selection&&this.selection.delete(),this.trigger("select",{shape:void 0})}redraw(){this.resize(),this.viewportRect=this.viewportBounds.rect,this.model.forceUpdate()}getPointAt(t,i=20){if(this.hidePoints)return;let n=r=>r.isHidden?void 0:r.distance(t);return Po(this.points,n,i/this.plotScale)}getPathAt(t,i=10){if(this.hidePoints||!this.canProject)return;let n=r=>r.isHidden?void 0:r.distance(t);return Po(this.paths,n,i/this.plotScale)}getIntersectionAt(t,i=20){if(!this.canIntersect)return;let n=r=>p.distance(t,r.posn);return Po(this.intersections,n,i/this.plotScale)}updateIntersections(){!this.canIntersect||this.hidePoints||Cu(this.paths,this.intersections)}drawPath(t,i={}){typeof t=="string"&&(t=Pt(t));let n=new ps(this,t,i.name);i.classes&&n.$el.addClass(i.classes),i.target&&n.$el.setAttr("target",i.target);let r=n.$el.hasClass("fill")?"fade":"draw";return i.animated&&n.$el.enter(r,i.animated),n}drawPoint(t,i={}){typeof t=="string"&&(t=Pt(t));let n=new Je(this,t,i.name,void 0,i.interactive===!1);return i.classes&&n.$el.addClass(i.classes),i.target&&n.$el.setAttr("target",i.target),i.animated!==0&&n.$el.enter("pop",i.animated||500),n}animatePoint(t,i,n=400){let r=this.shapes.get(t),o=new it(this.model[t],i);return K(a=>r.setValue(o.at(ot("quad",a))),n)}animateConstruction(t,i=2e3){return R(this,null,function*(){let n=this.shapes.get(t),r=n.value;if(ct(r)&&(r=r.arc),Mt(r)){this.$ruler||(this.$ruler=c("path",{d:Eu,class:"sketch"},this.$svg));let o=oi(r.at(-.1),12,r.angle-.3,r.length*1.2),a=oi(r.at(-.1),12,r.angle,r.length*1.2);this.$ruler.show(),n.$el.hide(),yield this.$ruler.animate({opacity:[0,1],transform:[o,a]},500).promise,yield n.$el.enter("draw",i).promise,yield this.$ruler.animate({opacity:[1,0],transform:[a,o]},500).promise}else if(ne(r)){this.$compass||(this.$compass=c("path",{d:Mu,class:"sketch"},this.$svg));let o=oi(r.c,50,r.startAngle,r.radius*1.5),a=oi(r.c,50,r.startAngle,r.radius),l=oi(r.c,50,r.startAngle+r.angle,r.radius),h=oi(r.c,50,r.startAngle+r.angle,r.radius*1.5);this.$compass.show(),n.$el.hide(),yield this.$compass.animate({opacity:[0,1],transform:[o,a]},500).promise,n.$el.enter("draw",i),yield this.$compass.animate({transform:[a,l]},i,0,"linear").promise,yield this.$compass.animate({opacity:[1,0],transform:[l,h]},500).promise}})}showGesture(t,i){this.$gesture||(this.$gesture=c("x-gesture",{},this)),this.$gesture.stop();let n=this.toViewportCoords(Pt(t)(this.model));if(this.$gesture.from=n,i){let r=this.toViewportCoords(Pt(i)(this.model));this.$gesture.start(r.subtract(n))}else this.$gesture.start();this.one("click mouseover pointerdown",()=>this.$gesture.stop())}waitForPoint(){return R(this,null,function*(){return new Promise(t=>{this.one("add:point",({point:i})=>t(i))})})}waitForPath(n){return R(this,arguments,function*(t,i={}){return(yield jh(this,[t],i))[0]})}waitForPaths(t,i={}){return jh(this,t,i)}};Lo=N([V("x-geopad",{template:Nu})],Lo);var Gu='<div class="image"></div><div class="content"><slot></slot></div>';var Ro=class extends O{ready(){let s=this.$(".image"),t=this.positionTop<50,i,n;s.css({"background-image":`url("${this.attr("background")}")`,height:t?"100%":"150%"});let r=({height:a})=>{let l=this.positionTop;i=Math.max(0,l-a),n=l+this.height};function o(a){if(a.top<i||a.top>n)return;let l=(a.top-i)/(n-i)*(t?50:33);s.css("transform",`translateY(${l}%)`)}b.onResize(r),Z.on("scroll",o)}};Ro=N([V("x-parallax",{template:Gu})],Ro);var Du=6,F2="M8.1-1.7l-14-8.8c-0.6-0.4-1.4-0.4-2-0.1c-0.6,0.4-1,1-1,1.7V8.8c0,0.7,0.4,1.4,1,1.7c0.3,0.2,0.6,0.3,1,0.3c0.4,0,0.7-0.1,1.1-0.3l14-8.8C8.6,1.3,9,0.7,9,0S8.6-1.3,8.1-1.7z",Nn=!1;function _u(e){if(!Array.isArray(e))return _u([e,0]);let[s,t]=e;if(s instanceof p)return[[s,t]];if(ct(s)&&(s=new x(s.c.shift(-s.r),2*s.r,2*s.r)),!(s instanceof M)&&!(s instanceof x))return[[$,0]];let i=s.edges.map(n=>[n.midpoint,n.perpendicularBisector.angle]).filter(n=>!P(n[1],1.5*Math.PI));return fn(i,t)}var Io=class{constructor(s,t,i){this.tile=s;this.name=t;this.options={};this.cables=new Set;i&&this.setOptions(i)}get location(){let s=this.options.location;return Array.isArray(s)?s[0]:s}get type(){return(this.location||this.tile.path)instanceof p?"POINT":"REGION"}get points(){let s=this.options.location||this.tile.path||$;return _u(s).map(t=>[this.tile.worldPosn(t[0]),t[1]])}setOptions(s,t=!0){Object.assign(this.options,s),t&&this.redraw()}redraw(){for(let s of this.cables)s.redraw()}},No=class extends Io{sendMessage(s){this.cables.size===0&&this.redraw();for(let t of this.cables.values())t.enqueueMessage(s,!1);Hu()}addCable(s,t=!1){this.cables.add(s),t&&this.tile.$parent.change({changed:[this.tile]}),!s.to&&!s.dragging&&this.cables.size>1&&this.removeCable(s,!1),this.redraw()}removeCable(s,t=!0){this.cables.delete(s),s.delete(),t&&this.redraw()}redraw(){if(Ve(this.cables,s=>s.to))for(let s of this.cables)!s.to&&!s.dragging&&this.removeCable(s);this.cables.size||this.addCable(new Zt(this)),super.redraw()}delete(){for(let s of this.cables)s.delete()}},Go=class extends Io{setOptions(t,i=!0){Object.assign(this.options,t);let n=Array.isArray(t.location)?t.location[0]:t.location;n instanceof p?this.$dot=c("circle",{class:"link-dot persist",r:Du,cx:n.x,cy:n.y},this.tile.$el):this.$dot&&this.$dot.remove(),i&&this.redraw()}addCable(t,i){i&&this.tile.highlight(!0),this.cables.add(t),this.options.connect&&this.options.connect(t)}removeCable(t,i){var n,r;i&&this.tile.highlight(!1),(r=(n=this.options).disconnect)==null||r.call(n,t),this.cables.delete(t)}delete(){for(let t of this.cables)t.from.removeCable(t)}validateConnection(t){return Wh(t,this)}},Zh=[],Uh=!1;function Hu(){var s,t;if(Uh)return;Uh=!0;let e=0;for(;Zh.length;){if(e>=1e4)throw new Error("Queue overflow!");let[i,n]=Zh.shift();(s=i.to)!=null&&s.options.message&&((t=i.to)==null||t.options.message(n,i)),e++}Uh=!1}function Wh(e,s){if(e.tile===s.tile||s.options.max&&[...s.cables].filter(r=>r.from!==e||r.to!==s).length>=s.options.max)return!1;let t=s.options.tileTypes;if(t){let n=e.tile.type;if(!t.includes(n))return!1}let i=e.options.tileTypes;if(i){let n=s.tile.type;if(!i.includes(n))return!1}return!0}var Zt=class{constructor(s,t){this.from=s;this.dragging=!1;let i=this.from.tile.$parent,n=s.options.persistent?"":"dashed";this.$group=c("g",{class:"link-bar",style:"display:none"},s.tile.$el),this.$line=c("path",{style:"pointer-events: none",class:n},this.$group),this.$originDot=c("circle",{class:"link-dot",r:Du},this.$group),this.$handle=c("path",{class:"link-handle",d:F2},this.$group),this.connectTo(t),i.events.listen(this.$handle,{start:()=>{i.selection.add(s.tile,!0),Nn=this.dragging=!0},move:({posn:o})=>{this.connectTo(i.getInputAt(o,this.from),o)},end:()=>{Nn=this.dragging=!1,this.to&&this.to.tile.highlight(!1),this.redraw(),s.addCable(this,!0)},click:()=>{this.connectTo(),s.addCable(this,!0)}});let r;i.events.listen(this.$originDot,{start:()=>{i.selection.add(s.tile,!0),r=new Zt(this.from),Nn=r.dragging=!0,this.from.addCable(r)},move:({posn:o})=>{r.connectTo(i.getInputAt(o,this.from),o)},end:()=>{r.to&&r.to.tile.highlight(!1),r.redraw(),Nn=r.dragging=!1,s.addCable(r,!0),r=void 0}})}connectTo(s,t){this.to&&this.to!==s&&this.to.removeCable(this,!0),s?this.to!==s&&Wh(this.from,s)&&(this.to=s,s.addCable(this,t!==void 0),this.from.options.connect&&this.from.options.connect(this)):this.to=void 0,this.redraw(t)}redraw(s){var w;if(!(this.from.options.persistent||this.from.tile.isActive||((w=this.to)==null?void 0:w.tile.isActive)))return this.$group.hide();if(this.from.tile.$el.append(this.$group),this.$group.show(),!this.to&&!s){let[g,y]=this.from.points[0],C=new H($,20).at(y/(Math.PI*2));this.$handle.setTransform(this.from.tile.relativePosn(g).add(C),y),this.$line.setAttr("d",""),this.$originDot.hide();return}let i=this.to?this.to.points:[[s,0]],n=wi(this.from.points,i),[r,o]=os(n,([g,y])=>p.distance(g[0],y[0])),a=this.from.tile.relativePosn(r[0]),l=o[1]+U((this.to?this.to.tile.rot:180)-this.from.tile.rot),h=this.to?new H($,14).at(l/(Math.PI*2)):$,d=this.from.tile.relativePosn(o[0]).add(h),u=p.distance(a,d),f=a.add(p.fromPolar(r[1],u*.7)),v=d.add(p.fromPolar(l,Math.max(u*.7,40)));this.$line.setAttr("d",`M${d.x} ${d.y}C${v.x} ${v.y},${f.x} ${f.y},${a.x} ${a.y}`),this.$handle.setTransform(d,l+Math.PI,this.to?.8:1),this.$originDot.setTransform(a),this.$originDot.show()}delete(){this.connectTo(),this.$group.remove()}enqueueMessage(s,t=!0){if(Zh.push([this,s]),t&&Hu(),!this.from.options.highlights)return;let n=s.type==="number"&&s.value===1?m.yellow:m.blue;this.$line.setAttr("style",`stroke: ${n}`),this.$handle.setAttr("style",`fill: ${n}`)}serialize(){return this.to?{fromPort:this.from.name,toTileId:this.to.tile.id,toPort:this.to.name}:void 0}static unSerialize(s,t,i){var o,a;let n=i.tiles.get(s),r=i.tiles.get(t.toTileId);if(n&&r){let l=(o=n.outPorts)==null?void 0:o.get(t.fromPort||"main"),h=(a=r.inPorts)==null?void 0:a.get(t.toPort||"main");l&&h&&Wh(l,h)&&l.addCable(new Zt(l,h))}}static get isMoving(){return Nn}};var m={grey:"#cccccc",darkGrey:"#242436",red:"#cd0e66",orange:"#eb4726",yellow:"#fd8c00",lime:"#bfc212",green:"#22ab24",teal:"#009ea6",blue:"#0f82f2",purple:"#6d3bbf"},j2="M12.5,0H0V25H12.5a12.5,12.5,0,0,0,0-25Z",U2="M0,0V12.5a12.5,12.5,0,0,0,25,0V0Z",Z2="M22.1,19.5l-9.2-16a1,1,0,0,0-1.8,0l-9.2,16A1,1,0,0,0,2.7,21H21.3A1,1,0,0,0,22.1,19.5Zm-8.7-11v2.4l-.4,4.4H11.1l-.4-4.4V8.5ZM12,19.4a1.6,1.6,0,0,1-1.6-1.6,1.6,1.6,0,1,1,3.2,0A1.6,1.6,0,0,1,12,19.4Z",Do=new Map,Fi;function I(e){Fi||(Fi=[]),Fi.push(...e)}var T=class{constructor(s,t,i){this.$parent=s;this.options="";this.colour="";this.posn=$;this.rot=0;this.snapPoints=[];this.snapLines=[];this.snapAngles=[0,90];this.canDragToSelect=!0;this.canRotate=!0;this.canMove=!0;this.$el=i||c("g",{class:"tile"},s.$tiles[2]),this.id=t||gs(10),s.tiles.set(this.id,this),Do.set(this.$el._el,this)}makeHandle(s,t,i,n,r){let a=c(s==="c"?"circle":"path",{class:"handle"},this.$el);s==="h"&&a.setAttr("d",j2),s==="v"&&a.setAttr("d",U2),s==="c"&&a.setAttr("r",10);let l="",h;return this.$parent.events.listen(a,{start:()=>{this.$parent.selection.add(this,!0),l=this.options,h=this.size,n==null||n()},move:({posn:d})=>t(this.relativePosn(d),d),click:()=>i==null?void 0:i(),end:()=>{r==null||r(),(this.options!==l||this.size!==h)&&this.$parent.change({changed:[this]})}}),a}is(s){return this.type===s}setColour(s,t){this.colour=s}setSize(s){this.size=s}setOrder(s){s!==this.order&&(this.order=s,this.$container.append(this.$el))}setHandles(s=!1){this.hideHandles=s,this.$el.setClass("no-handles",s)}setLabels(s){this.labels=s}lock(s=!0){s!==!!this.locked&&(this.$el.setClass("locked-tile",s),this.locked=s,this.canSelect||this.$parent.selection.remove(this))}hide(s=!0){s!==!!this.hidden&&(this.$el.setClass("hidden-tile",s),this.hidden=s,this.canSelect||this.$parent.selection.remove(this))}get canSelect(){return this.$parent.state.setupMode||!this.hidden&&!this.locked}flip(s){this.flipped=!this.flipped}click(s){}doubleClick(s){}down(s){}up(s){}format(s){}focus(){this.$parent.focussedTile=this,this.$parent.selection.clear(),this.isFocussed=!0,this.$parent.trigger("change-focus",{tiles:[this]})}blur(){this.isFocussed=!1,this.$parent.focussedTile=void 0,this.$parent.trigger("change-focus",{tiles:[]})}get $container(){let s=this.order==="back"?0:this.order==="front"?2:1;return this.$parent.$tiles[s*2+(this.isActive?1:0)]}select(){this.isActive=!0,this.$el.addClass("active"),this.$container.append(this.$el),this.redrawCables()}deselect(){this.isActive=!1,this.$el.removeClass("active"),this.$container.append(this.$el),this.redrawCables()}redrawCables(){var s,t;for(let i of((s=this.inPorts)==null?void 0:s.values())||[])i.redraw();for(let i of((t=this.outPorts)==null?void 0:t.values())||[])i.redraw()}watchPolypadOptions(s){this.polypadOptionCallbacks||(this.polypadOptionCallbacks=[]),this.polypadOptionCallbacks.push(s),this.$parent.options.watch(s)}moveStart(s=!1){this.startPosn=this.posn}move(s,t){s&&(this.posn=this.startPosn.add(s),this.transform(!0))}showErrorIcon(s){var t;if(this.currentError=s,!s)return(t=this.$errorIcon)==null?void 0:t.detach();this.$errorIcon||(this.$errorIcon=c("g",{style:"cursor: pointer"}),c("circle",{cx:12,cy:12,r:12,fill:"transparent"},this.$errorIcon),c("path",{d:Z2,fill:m.yellow},this.$errorIcon),this.transform(),this.$parent.events.listen(this.$errorIcon,{click:()=>{let i=this.$errorIcon.transformMatrix,n=this.posn.shift(i[0][2],i[1][2]);this.$parent.warningBanner.show(n,this.currentError)}})),this.$el.append(this.$errorIcon)}moveEnd(){this.collision&&this.collide(this.collision)}highlight(s=!0){}findNearby(s,t,i=this.posn){for(let n of this.$parent.getTilesOfType(s))if(n!==this&&p.distance(i,n.posn)<t)return n}setCollision(s){var t;s&&s===this.collision||((t=this.collision)==null||t.highlight(!1),this.collision=s,s==null||s.highlight(!0))}collide(s){}transform(s=!1){var i;let t=U(this.rot);this.$el.setTransform(this.posn,t),this.customTransform(this.posn,t),this.redrawCables(),!s&&this.path&&(this.transformed=this.path.rotate(t).translate(this.posn),this.padding&&(this.transformedPadded=we(this.path).padding(...this.padding).rotate(t).translate(this.posn)),this.snapPoints=this.getSnapPoints().map(n=>n.rotate(t).translate(this.posn)),this.snapLines=this.getSnapLines().map(n=>n.rotate(t).translate(this.posn)),(i=this.$errorIcon)==null||i.setTransform(we(this.path).p.shift(-28,5)))}customTransform(s,t){}setTransform(s,t=this.rot){this.posn=s,this.rot=Ct(t,360),this.transform()}animateTo(s,t=this.posn,i=400){return this.setTransform(s),K(n=>{n=ot("sine",n),this.$el.setTransform(p.interpolate(t,s,n),U(this.rot))},i).promise}static makeThumbnail(s,t,i){}getSnapPoints(){return this.path?yt(this.path)?[this.path]:oe(this.path)?this.path.points:Mt(this.path)?[this.path.p1,this.path.p2]:ct(this.path)?[this.path.c,this.path.c.shift(0,this.path.r),this.path.c.shift(0,-this.path.r),this.path.c.shift(this.path.r,0),this.path.c.shift(-this.path.r,0)]:ze(this.path)?[this.path.c,this.path.start,this.path.end]:ne(this.path)?[this.path.start,this.path.end]:ae(this.path)?[]:[]:[]}getSnapLines(){return[]}delete(){var s,t;for(let i of this.polypadOptionCallbacks||[])this.$parent.options.unwatch(i);this.$parent.selection.remove(this);for(let i of((s=this.inPorts)==null?void 0:s.values())||[])i.delete();for(let i of((t=this.outPorts)==null?void 0:t.values())||[])i.delete();this.$parent.tiles.delete(this.id),this.$parent.mathContext.removeSource(this),Do.delete(this.$el._el),this.$el.remove()}relativePosn(s){return s.subtract(this.posn).rotate(-U(this.rot))}worldPosn(s){return s.rotate(U(this.rot)).add(this.posn)}get center(){return this.path?we(this.path).center:$}get ariaDescription(){return`${this.type}: ${this.options}`}applyChange(s){var t,i,n,r,o,a;if(s.options!==this.options){let l=[...s.cables||this.getCableData("out"),...this.getCableData("in")];this.delete(),s=Object.assign(this.serialize(),s);let h=T.unSerialize(s,this.$parent);for(let d of l)Zt.unSerialize(h.id,d,this.$parent);return}if((s.x!==void 0||s.y!==void 0||s.rot!==void 0)&&this.setTransform(new p((i=(t=s.x)!=null?t:this.posn.x)!=null?i:0,(r=(n=s.y)!=null?n:this.posn.y)!=null?r:0),(a=(o=s.rot)!=null?o:this.rot)!=null?a:0),s.colour&&s.colour!==this.colour&&this.setColour(s.colour),!s.flipped!=!this.flipped&&this.flip(),!s.locked!=!this.locked&&this.lock(!!s.locked),!s.hidden!=!this.hidden&&this.hide(!!s.hidden),!s.hideHandles!=!this.hideHandles&&this.setHandles(!!s.hideHandles),!s.labels!=!this.labels&&this.setLabels(s.labels),this.fixed=!!s.fixed,s.size&&s.size!==this.size&&this.setSize(s.size),s.order!==this.order&&this.setOrder(s.order),s.cables){for(let l of this.getCables("out"))l.from.removeCable(l);for(let l of s.cables)Zt.unSerialize(this.id,l,this.$parent)}this.serialize()}makeInPort(s,t){this.inPorts||(this.inPorts=new Map),this.inPorts.has(s)||this.inPorts.set(s,new Go(this,s));let i=this.inPorts.get(s);return i.setOptions(t,!1),i}makeOutPort(s,t){this.outPorts||(this.outPorts=new Map),this.outPorts.has(s)||this.outPorts.set(s,new No(this,s));let i=this.outPorts.get(s);return i.setOptions(t,!1),i}deleteInPort(s){var t;typeof s=="string"&&(s=(t=this.inPorts)==null?void 0:t.get(s)),!(!s||!this.inPorts)&&(this.inPorts.delete(s.name),s.delete())}deleteOutPort(s){var t;typeof s=="string"&&(s=(t=this.outPorts)==null?void 0:t.get(s)),!(!s||!this.outPorts)&&(this.outPorts.delete(s.name),s.delete())}emitMessage(s,t){var i;typeof s=="string"&&(s=(i=this.outPorts)==null?void 0:i.get(s)),s==null||s.sendMessage(t)}*getCables(s){let t=s==="in"?this.inPorts:this.outPorts;if(!!t)for(let i of t.values())for(let n of i.cables)n.to&&(yield n)}*getCableData(s){for(let t of this.getCables(s))yield t.serialize()}contains(s){let t=this.transformed;return!t||!oe(t)&&!ct(t)&&!ze(t)?!1:t.contains(s)}getClosestPort(s,t,i=10){if(!this.inPorts)return;let n=this.relativePosn(s);for(let a of this.inPorts.values())if(a.location&&yt(a.location)&&p.distance(a.location,n)<=i&&(!t||a.validateConnection(t)))return a;if(!this.contains(s))return;let r=Array.from(this.inPorts.values()).filter(a=>!t||a.validateConnection(t));for(let a of r.filter(l=>l.type==="REGION"))if((a.location||this.path).contains(n))return a;let o=r.filter(a=>a.type==="POINT");return os(o,a=>p.distance(n,a.location))}serialize(){return this.lastSavedData={id:this.id,name:this.type,options:this.options,x:this.posn.x,y:this.posn.y,rot:this.rot,size:this.size||void 0,flipped:this.flipped||void 0,locked:this.locked||void 0,fixed:this.fixed||void 0,labels:this.labels,hidden:this.hidden||void 0,hideHandles:this.hideHandles||void 0,order:this.order,colour:this.colour,cables:Array.from(this.getCableData("out"))}}static unSerialize(s,t,i=!1){if(!(s!=null&&s.name))return;let n=t.newTile(s.name,s.options||"",i?void 0:s.id);return s.flipped&&n.flip(),n.setTransform(new p(s.x,s.y),s.rot),s.colour&&n.setColour(s.colour),s.size&&n.setSize(s.size),n.setOrder(s.order||void 0),s.hidden&&n.hide(!0),s.hideHandles&&n.setHandles(!0),s.labels&&n.setLabels(s.labels),s.fixed&&(n.fixed=!0),s.locked&&n.lock(),n.lastSavedData=s,n}};var X=class{constructor(s=0,t=0,i=0){this.x=s;this.y=t;this.z=i}transform(s){if(s instanceof Gn&&(s=s.matrix),s.length!==4||s[0].length!==4)throw new Error("Must use a 4x4 matrix for 3D transforms!");let[[t],[i],[n],[r]]=At.product(s,[[this.x],[this.y],[this.z],[1]]);return new X(t/r,i/r,n/r)}equals(s){return P(this.x,s.x)&&P(this.y,s.y)&&P(this.z,s.z)}fixFloat(){return new X(P(this.x,0)?0:this.x,P(this.y,0)?0:this.y,P(this.z,0)?0:this.z)}add(s){return this.x+=s.x||0,this.y+=s.y||0,this.z+=s.z||0,this}multiply(s){return this.x*=s.x,this.y*=s.y,this.z*=s.z,this}lerp(s,t){return new X($t(this.x,s.x||0,t),$t(this.y,s.y||0,t),$t(this.z,s.z||0,t))}scale(s){return new X(this.x*s,this.y*s,this.z*s)}get magnitude(){return Math.hypot(this.x,this.y,this.z)}get normalize(){return this.scale(1/this.magnitude)}get asArray(){return[this.x,this.y,this.z]}get inverse(){return new X(-this.x,-this.y,-this.z)}get xy(){return new p(this.x,this.y)}[Symbol.iterator](){return this.asArray.values()}static get zero(){return new X(0,0,0)}static get oneZ(){return new X(0,0,1)}static get one(){return new X(1,1,1)}static all(s){return new X(s,s,s)}static from2D(s){return new X(s.x,s.y,0)}static average(s){return new X(bi(s.map(t=>t.x)),bi(s.map(t=>t.y)),bi(s.map(t=>t.z)))}static dot(s,t){return s.x*t.x+s.y*t.y+s.z*t.z}static cross(s,t){let i=s.y*t.z-s.z*t.y,n=s.z*t.x-s.x*t.z,r=s.x*t.y-s.y*t.x;return new X(i,n,r)}};var pt={translate({x:e,y:s,z:t}){return[[1,0,0,e],[0,1,0,s],[0,0,1,t],[0,0,0,1]]},rotateX(e){let s=Math.cos(e),t=Math.sin(e);return[[1,0,0,0],[0,s,-t,0],[0,t,s,0],[0,0,0,1]]},rotateY(e){let s=Math.cos(e),t=Math.sin(e);return[[s,0,t,0],[0,1,0,0],[-t,0,s,0],[0,0,0,1]]},rotateZ(e){let s=Math.cos(e),t=Math.sin(e);return[[s,-t,0,0],[t,s,0,0],[0,0,1,0],[0,0,0,1]]},rotateAxis({x:e,y:s,z:t},i){let n=Math.hypot(e,s,t);n=1/n,e*=n,s*=n,t*=n;let r=Math.sin(i),o=Math.cos(i),a=1-o;return[[e*e*a+o,e*s*a-t*r,e*t*a+s*r,0],[s*e*a+t*r,s*s*a+o,s*t*a-e*r,0],[t*e*a-s*r,t*s*a+e*r,t*t*a+o,0],[0,0,0,1]]},fromEulerAngles(e,s,t){return At.product(pt.rotateX(e),pt.rotateY(s),pt.rotateZ(t))},scale({x:e,y:s,z:t}){return[[e,0,0,0],[0,s,0,0],[0,0,t,0],[0,0,0,1]]},scaleAll(e){return[[e,0,0,0],[0,e,0,0],[0,0,e,0],[0,0,0,1]]},perspective(e,s,t,i){let n=t*Math.tan(U(e)/2),r=-n,o=n*s,a=-o;return[[2*t/(o-a),0,(o+a)/(o-a),0],[0,2*t/(n-r),(n+r)/(n-r),0],[0,0,-((i+t)/(i-t)),-(2*i*t/(i-t))],[0,0,-1,0]]},transformPoint(e,s){return s instanceof X?s.transform(e):new X(s.x,s.y).transform(e)}},Gn=class{constructor(){this.matrix=At.identity(4)}clear(){return this.matrix=At.identity(4),this}translate(s=0,t=0,i=0){return this.matrix=At.product(this.matrix,pt.translate({x:s,y:t,z:i})),this}rotate(s=0,t=0,i=0){return this.matrix=At.product(this.matrix,pt.rotateZ(i),pt.rotateY(t),pt.rotateX(s)),this}scale(s){return this.matrix=At.product(this.matrix,pt.scale(s)),this}dragToRotate(s,t,i=100){let n=new X(s.x,s.y,i**3/(i**2+s.length**2)).normalize,r=new X(t.x,t.y,i**3/(i**2+t.length**2)).normalize,o=S(X.dot(n,r),-1,1),a=X.cross(n,r),l=pt.rotateAxis(a,2*Math.acos(o));return this.matrix=At.product(l,this.matrix),this}isRotationMatrix(){if(!P(At.determinant(this.matrix),1))return!1;let s=At.transpose(this.matrix);return At.product(this.matrix,s).every((i,n)=>i.every((r,o)=>P(r,n===o?1:0)))}toEulerAngles(){let s=this.matrix,t=Math.sqrt(s[0][0]*s[0][0]+s[1][0]*s[1][0]);if(P(t,0)){let a=Math.atan2(-s[1][2],s[1][1]),l=Math.atan2(-s[2][0],t);return[a,l,0]}let n=Math.atan2(s[2][1],s[2][2]),r=Math.atan2(-s[2][0],t),o=Math.atan2(s[1][0],s[0][0]);return[n,r,o]}};var W2=new F(0,0,0);function K2(e){let s=e.r,t=e.c.x,i=e.c.y,n=.5523*s;return`M${t} ${i-s}C${t+n} ${i-s} ${t+s} ${i-n} ${t+s} ${i}C${t+s} ${i+n} ${t+n} ${i+s} ${t} ${i+s}C${t-n} ${i+s} ${t-s} ${i+n} ${t-s} ${i}C${t-s} ${i-n} ${t-n} ${i-s} ${t} ${i-s}`}var _o=class{constructor(){this.transform=new Gn;this.visible=!0}getTransformed(s){let t=this;do s=s.transform(t.transform);while(t=t.parent);return s}get normal(){return this.getTransformed(X.oneZ).add(this.getTransformed(X.zero).inverse).normalize}project(s,t={fov:120}){if(t.fov===!1)return new p(s.x,s.y);let i=Math.exp(s.z/t.fov);return new p(s.x*i,s.y*i)}*getProjectedVertices(s){for(let t of this.getVertices())yield this.project(t,s)}},ye=class extends _o{constructor(t,i={},n){super();this.children=[];this.sorting=!1;this.$el=c("g",i,n);for(let r of t)this.addChild(r)}addChild(t){return t.parent&&t.parent.removeChild(t),this.children.push(t),this.$el&&t.$el&&this.$el.append(t.$el),t.parent=this,t}removeChild(t){let i=this.children.indexOf(t);i>=0&&this.children.splice(i,1),t.$el&&t.$el.remove(),t.parent=void 0}render(t){if(!!this.visible){if(this.sorting)for(let i of Ds(this.children,n=>n.zIndex))this.$el.append(i.$el);for(let i of this.children)i.render(t)}}*getFaces(){for(let t of this.children)for(let i of t.getFaces())yield i}*getVertices(){for(let t of this.children)for(let i of t.getVertices())yield i}get zIndex(){return bi(this.children.map(t=>t.zIndex))}},fe=class extends _o{constructor(t,i={},n){super();this.shape=t;if(t==null)this.commands=[];else if(typeof t=="string")this.commands=Er(t);else{let o=ct(t)?K2(t):jt(t);this.commands=Er(o)}let r=p.average(...this.commands.filter(o=>o.points.length).map(o=>p.average(...o.points)));this.centroid=new X(r.x,r.y,0),n&&(this.color=n),this.$el=c("path",i)}render(t){if(!this.visible)return;if(t!=null&&t.hideBackface){let n=this.getTransformed(X.zero).z>0;if(this.$el.toggle(n),!n)return}if(this.color){let n=F.mix(this.color,W2,(Math.abs(this.normal.z)+1)/2);this.$el.setAttr("fill",n),this.$el.setAttr("stroke",n)}let i=this.commands.map(n=>{let r=n.points.map(o=>{let a=this.project(this.getTransformed(new X(o.x,o.y)),t);return`${a.x},${a.y}`});return n.type+r.join(",")}).join("");this.$el.setAttr("d",i)}get zIndex(){return this.getTransformed(this.centroid).z}*getFaces(){yield this}*getVertices(){if(!(typeof this.shape=="string"||!oe(this.shape)))for(let t of this.commands)for(let i of t.points)yield this.getTransformed(new X(i.x,i.y))}};var at=M.regular(3),ji=M.regular(4),Ce=M.regular(5),Ho={shape:at,children:[{shape:at,dihedral:70.53,rot:180},{shape:at,dihedral:70.53,parentEdge:1,rot:300},{shape:at,dihedral:70.53,parentEdge:2,rot:60}]},Bo={shape:ji,children:[{shape:ji,dihedral:90,myEdge:2,children:[{shape:ji,dihedral:90,myEdge:2}]},{shape:ji,dihedral:90,parentEdge:1,rot:270},{shape:ji,dihedral:90,parentEdge:2},{shape:ji,dihedral:90,parentEdge:3,rot:90}]},qo={shape:at,children:[{shape:at,dihedral:109.47,rot:180},{shape:at,dihedral:109.47,parentEdge:1,rot:300,children:[{shape:at,dihedral:109.47,parentEdge:1,rot:300}]},{shape:at,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:at,dihedral:109.47,parentEdge:1,rot:300},{shape:at,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:at,dihedral:109.47,parentEdge:1,rot:300}]}]}]},zo={shape:Ce,children:[{shape:Ce,dihedral:116.57,rot:180},{shape:Ce,dihedral:116.57,parentEdge:1,rot:252},{shape:Ce,dihedral:116.57,parentEdge:2,rot:324},{shape:Ce,dihedral:116.57,parentEdge:3,rot:36},{shape:Ce,dihedral:116.57,parentEdge:4,rot:108,children:[{shape:Ce,dihedral:116.57,parentEdge:2,rot:324,children:[{shape:Ce,dihedral:116.57,parentEdge:3,rot:36,children:[{shape:Ce,dihedral:116.57,parentEdge:1,rot:252},{shape:Ce,dihedral:116.57,parentEdge:2,rot:324},{shape:Ce,dihedral:116.57,parentEdge:3,rot:36},{shape:Ce,dihedral:116.57,parentEdge:4,rot:108}]}]}]}]},Fo={shape:at,children:[{shape:at,dihedral:138.19,rot:180},{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60}]},{shape:at,dihedral:138.19,parentEdge:1,rot:300}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:at,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60}]},{shape:at,dihedral:138.19,parentEdge:1,rot:300}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60}]},{shape:at,dihedral:138.19,parentEdge:1,rot:300}]}]},Bu=new M(new p(.587785,.466639),new p(0,.750495),new p(-.587785,.466639),new p(0,-.73981)),us={shape:Bu,dihedral:89.7451,rot:180},qu={shape:Bu,children:[Rt(et({},us),{parentEdge:1,myEdge:1,children:[Rt(et({},us),{children:[Rt(et({},us),{parentEdge:1,myEdge:1,children:[Rt(et({},us),{children:[Rt(et({},us),{parentEdge:1,myEdge:1,children:[Rt(et({},us),{children:[Rt(et({},us),{parentEdge:1,myEdge:1,children:[Rt(et({},us),{children:[Rt(et({},us),{parentEdge:1,myEdge:1})]})]})]})]})]})]})]})]})]};function zu(e,s,t){let i=M.regular(e).scale(s*Wt(e)),n=new x($,s,t).polygon,r=[{shape:i,rot:180,parentEdge:2}],o=B(a=>({shape:n,parentEdge:a,rot:360/e*a,children:a?void 0:r}),e);return{shape:i,children:o}}function Fu(e,s,t){let i=M.regular(e).scale(s*Wt(e)),n=new M(new p(-s/2,0),new p(s/2,0),new p(0,-t)),r=It(Math.acos(s/t/2/Math.tan(Math.PI/e))),o=B(a=>({shape:n,dihedral:r,parentEdge:a,rot:180+360/e*a}),e);return{shape:i,children:o}}var X2=At.identity(4);function ju(e,s,t,i){var v;let n=s.shape.edges[e.parentEdge||0],r=e.shape.edges[e.myEdge||0],o=U(e.dihedral||90),a=i(e);t.addChild(a);let l=X.from2D(n.midpoint),h=X.from2D(r.midpoint),d=X.from2D(n.unitVector),u=e.rot?U(e.rot):0,f=((v=e.children)==null?void 0:v.map(w=>ju(w,e,t,i)))||[];return[a,l,h,d,u,o,f]}function Dn(e,s,t=1){var o;let i=s(e),n=new ye([i]);n.sorting=!0;let r=((o=e.children)==null?void 0:o.map(a=>ju(a,e,n,s)))||[];return Kh(r,n,t),{group:new ye([n]),foldTree:r}}function Uu(e,s,t=X2){let[i,n,r,o,a,l,h]=e,d=$t(Math.PI,l,s),u=pt.rotateAxis(o,Math.PI-d);a&&(u=At.product(u,pt.rotateZ(a)));let f=r.transform(u),v=pt.translate(f.inverse.add(n));i.transform.matrix=At.product(t,v,u);for(let w of h||[])Uu(w,s,i.transform.matrix)}function Kh(e,s,t){s.transform.clear();for(let r of e)Uu(r,t);let i=Array.from(s.getFaces()).map(r=>r.getTransformed(r.centroid)),n=X.average(i).inverse;s.transform.translate(n.x,n.y,n.z)}function Y2(e,s,t){let i=Math.cos(e),n=Math.cos(s),r=Math.cos(t),o=Math.sin(s),a=Math.acos((r-i*n)/(Math.sin(e)*o)),l=Math.acos((i-n*r)/(o*Math.sin(t)));return[a,l]}function Zu(e,s){return Math.asin(Math.cos(e*s)/Math.cos(e/2))}var Q2=[60,90,108],J2=[{internal:[60,90,90,90],dihedral:[144.74,135,135,135]},{internal:[60,60,60,60,90],dihedral:[153.23,153.23,153.23,142.98,142.98]},{internal:[60,90,108,90],dihedral:[159.09,148.28,148.28,159.09]},{internal:[60,60,60,60,108],dihedral:[164.18,164.18,152.93,152.93,152.93]}];function tv(...e){let s=e.length;if(s===3)return Y2(e[0],e[1],e[2]);let t=e.map(n=>Math.round(It(n)));if((s===4||s===5)&&t.includes(60)&&t.every(n=>Q2.includes(n))){for(let n of J2)if(n.internal.length===s){for(let r=0;r<e.length;++r)if(t.every((o,a)=>o===n.internal[(a+r)%s]))return fn(n.dihedral,r).slice(0,s-1).map(o=>U(o))}}if(s===4&&t.filter(n=>n===60).length===3){let n=t.findIndex(h=>h!==60),r=(Math.PI-e[n])/4,o=Math.acos(-1/Math.sqrt(3)*Math.tan(r)),a=Math.acos(1-2/3*((3-Math.tan(r)**2)/4+(Math.sin(3*r)/Math.sin(2*r))**2));return fn([o,a,a,o],4-n).slice(0,s-1)}let i=Math.PI/q(e);return B(n=>{let r=Zu(e[n],i),o=Zu(e[n+1],i);return r+o},e.length-1)}var Xh=(e,s)=>Ct(e+1,s.size),Yh=(e,s)=>Ct(e-1,s.size);function ev(e,s){let t=e.polygon.points[Yh(s,e)],i=e.polygon.points[s],n=e.polygon.points[Xh(s,e)];return new Vt(n,i,t).sup.rad}function sv(e){let s=e.find(a=>a.neighbours.filter(l=>l).length===1),t=Yh(s.neighbours.findIndex(a=>a),s),i=[],n=s,r=t;do{let a=[];for(;a.push({face:n,vertex:r}),!!n.neighbours[r];){let l=n;n=n.neighbours[r],r=Xh(n.neighbours.indexOf(l),n)}r=Xh(r,n),i.push(a)}while(n!==s||r!==t);let o=new Yc(i);for(;;){let a=Math.max(3,...o.array.map(d=>d.val.length)),l=o.array.filter(d=>d.val.length>=a);if(!l.length)break;let h=new Set;for(let d of l){if(h.has(d))continue;let u=d.val.map(v=>ev(v.face,v.vertex)),f=tv(...u);for(let[v,w]of f.entries()){let g=d.val[v],y=d.val[v+1],C=g.vertex,A=Yh(y.vertex,y.face);g.face.dihedral[C]=y.face.dihedral[A]=Math.max(w,g.face.dihedral[C]||0,y.face.dihedral[A]||0)}d.prev.val.push(...d.next.val),h.add(d.next),o.delete(d.next),o.delete(d)}}}function Wu(e,s){return Math.max(...e.neighbours.map(t=>!t||t===s?0:Wu(t,e)))+1}function Ku(e,s){return e.visited?!0:(e.visited=!0,e.neighbours.filter(t=>t&&t!==s).some(t=>Ku(t,e)))}function Xu(e,s,t,i){let n=e.neighbours.map((r,o)=>{if(!(!r||r===t))return Xu(r,s,e,e.dihedral[o])}).filter(r=>r);return{shape:gt(e.polygon.points.map(r=>r.subtract(s))),color:e.tile.colour,children:n.length?n:void 0,dihedral:i?+It(i).toFixed(2):void 0,parentEdge:t?t.neighbours.indexOf(e):void 0,myEdge:t?e.neighbours.indexOf(t):void 0}}function iv(e){let s=e.map(t=>{let i=t.transformed.oriented,n=i.points.length;return{tile:t,polygon:i,size:n,neighbours:zt(void 0,n),dihedral:zt(void 0,n),edges:i.edges,center:i.centroid,radius:i.radius}});if(!s.some(t=>t.size<3)){for(let[t,i]of s.entries())for(let[n,r]of s.entries())if(!(t>=n)&&!(i.radius+r.radius<p.distance(i.center,r.center)-2)){for(let[o,a]of i.edges.entries())for(let[l,h]of r.edges.entries())if(a.equals(h,2)){if(i.neighbours[o]||r.neighbours[l])return;i.joined=r.joined=!0,i.neighbours[o]=r,r.neighbours[l]=i}}if(!s.some(t=>!t.joined)&&!Ku(s[0]))return s}}function Yu(e){let s=iv(e);if(!s)return;sv(s);let t=os(s,n=>Wu(n)),i=t.polygon.centroid;return[i,Xu(t,i)]}function Ju(e){var t;let s=((t=e.c||e.children)==null?void 0:t.map(i=>Ju(i)))||[];return{shape:li(e.shape||e.s),color:e.color||e.a,children:s,dihedral:e.dihedral||e.d,parentEdge:e.parentEdge||e.p,myEdge:e.myEdge||e.m,rot:e.rot||e.r}}function tf(e){var t;let s=(t=e.children)==null?void 0:t.map(i=>tf(i));return s!=null&&s.length||(s=void 0),{s:gt(e.shape.points),a:e.color,children:s,d:e.dihedral,p:e.parentEdge,m:e.myEdge,r:e.rot}}function nv(e){try{let{net:s,angle:t,rotation:i}=JSON.parse(e.replace(/([a-z]):/g,'"$1":')),n;return typeof s=="string"?(n=`"${s}"`,s=_n[s].net||_n.Cube.net):(s=Ju(s),n=JSON.stringify(tf(s)).replace(/"([a-z])":/g,"$1:")),{net:s,serialized:n,angle:t,rotation:i}}catch(s){return{net:_n.Cube.net,serialized:'"Cube"',angle:1}}}function Ui(e,s=1){var i;let t=(i=e.children)==null?void 0:i.map(n=>Ui(n,s));return Object.assign({},e,{children:t,shape:e.shape.scale(s)})}var _n={Tetrahedron:{net:Ui(Ho,Wt(3)*50),scale:1.1},Cube:{net:Ui(Bo,Wt(4)*50),scale:.8},Octahedron:{net:Ui(qo,Wt(3)*50),scale:.95},Dodecahedron:{net:Ui(zo,Wt(5)*50),scale:.42},Icosahedron:{net:Ui(Fo,Wt(3)*50),scale:.67},Pyramid:{net:Fu(6,50,100),scale:.57},Prism:{net:zu(6,50,100),scale:.45}},ai={fov:400},Qu=[1.066,.243,-.088],ks=class extends T{constructor(t,i,n){super(i,n);this.type="polyhedron";this.canRotate=!1;this.options=t,t in _n&&(t=`{"net":"${t}","angle":1,"rotation":${JSON.stringify(Qu)}}`);let r=nv(t);this.net=r.net,this.serialized=r.serialized;let o=Dn(this.net,a=>new fe(a.shape,{class:"polygon-tile"},a.color||Hn(a.shape.points.length)));this.solid=o.group,this.foldTree=o.foldTree,this.$el.append(this.solid.$el),this.$outline=c("path",{class:"outline"},this.$el),this.$moveBar=c("path",{d:"M0 0h30",class:"handle"},this.$el),this.$moveHandle=c("path",{d:"M0 0h14v14h-14Z",class:"handle",style:"cursor: grab"},this.$el),this.solid.$el.css("cursor","move"),this.setRotation(r.rotation||[0,0,0]),this.hinge(r.angle||0),this.solid.render(ai),this.updateOutline(),i.events.listen(this.solid.$el,{start:()=>{i.selection.add(this,!0),this.$el.removeClass("active")},move:({posn:a,lastPosn:l})=>{this.solid.transform.dragToRotate(l.subtract(this.posn),a.subtract(this.posn),100),this.solid.render(ai)},end:()=>{this.rotation=this.solid.transform.toEulerAngles(),this.updateOutline(),this.updateOptions(),i.change({changed:[this]}),this.$el.addClass("active")},click:a=>i.tools.move.down(a),checkIfActive:()=>this.angle>0})}updateOutline(){let t=this.solid.getProjectedVertices(ai);this.path=M.convexHull(...t),this.$outline.draw(this.path),this.transform(),this.$moveBar.translate(this.path.points[0].x-30,this.path.points[0].y),this.$moveHandle.translate(this.path.points[0].x-45,this.path.points[0].y-7)}setRotation(t){this.rotation=t,this.solid.transform.clear().rotate(...t)}updateOptions(){let t=JSON.stringify(this.rotation.map(i=>+i.toFixed(4)));this.options=`{"net":${this.serialized},"angle":${this.angle},"rotation":${t}}`}animateHinges(t,i=!1,n=800){let r=i?this.rotation:[0,0,0],o=this.angle;return K(a=>{this.hinge($t(o,t,a)),i&&this.setRotation(r.map(l=>l*(1-a))),this.solid.render(ai)},n)}hinge(t){this.angle=S(t,0,1);let i=this.solid.transform.matrix;this.solid.transform.clear(),Kh(this.foldTree,this.solid.children[0],-this.angle),this.solid.transform.matrix=i}hingeStart(){this.startRotation=this.rotation,this.startAngle=this.angle,this.$el.removeClass("active")}hingeMove(t){if(!P(t,this.angle)){if(this.hinge(t),this.startRotation&&this.startAngle){let i=S(t/this.startAngle,0,1);this.setRotation(this.startRotation.map(n=>i*n))}this.solid.render(ai)}}hingeEnd(){this.updateOutline(),this.$el.addClass("active"),this.updateOptions()}setColour(t){super.setColour(t);for(let i of this.solid.getFaces())i.color=t;this.solid.render(ai)}static fold(t){let i=Yu(t);if(!i){xo("polyhedron-error");return}let n=JSON.stringify({net:i[1],angle:1}),r=new ks(n,t[0].$parent);r.hinge(0);let o=r.solid.children[0].transform.matrix;r.setTransform(i[0].shift(-o[0][3],-o[1][3])),r.animateHinges(1).promise.then(()=>r.updateOutline());for(let l of t)l.delete();return r}unfold(){return R(this,null,function*(){this.$parent.selection.remove(this),this.angle>0&&(yield this.animateHinges(0,!0).promise);let t=Array.from(this.solid.getFaces()).map(i=>{let n=Array.from(i.getProjectedVertices()),r=new W(gt(n),this.$parent);return r.setColour(this.colour||i.color||Hn(n.length)),r.setTransform(this.posn),r});return this.delete(),t})}static makeThumbnail(t,i){let n=c("svg",{width:70,height:70},i),r=c("g",{transform:"translate(35, 35)"},n),{net:o,scale:a}=_n[t],l=Dn(o,h=>new fe(h.shape,{class:"polygon-tile"},Hn(h.shape.points.length)),-1).group;l.transform.clear().rotate(...Qu).scale({x:a,y:a,z:a}),r.append(l.$el),l.render(ai)}};I([{type:"button",tileTypes:["polyhedron"],label:"Unfold",click:(e,s)=>R(void 0,null,function*(){let t=Bt(yield Promise.all(e.map(i=>i.unfold())));s.change({added:t,deleted:e})})},{type:"slider",tileTypes:["polyhedron"],label:"Unfold",start:e=>e.hingeStart(),move:(e,s)=>e.hingeMove(s),end:e=>e.hingeEnd(),get:e=>e.angle}]);function Wt(e){let s=Math.cos(D/e);return 1/Math.sqrt(2-2*s)}var Bn=e=>Ct(Math.round(It(e.angle)),180),gt=e=>e.map(s=>`${Ft(s.x,2)} ${Ft(s.y,2)}`).join(",");function rf(e,s){let t=new p(-e/2,-s/2);return gt(new x(t,e,s).points)}var z=50,bt=Math.sqrt(3)/4*z,Jh=new wt($,new p(0,1)),ef={"equ-triangle":new M(new p(-z/2,bt),new p(z/2,bt),new p(0,-bt)),square:M.regular(4,z*Wt(4)),"reg-pentagon":M.regular(5,z*Wt(5)),"reg-hexagon":M.regular(6,z*Wt(6)),"reg-heptagon":M.regular(7,z*Wt(7)),"reg-octagon":M.regular(8,z*Wt(8)),"reg-decagon":M.regular(10,z*Wt(10)),"reg-dodecagon":M.regular(12,z*Wt(12)),rectangle:new x(new p(-z,-z/2),2*z,z).polygon,trapezium:new M(new p(-z,bt),new p(z,bt),new p(z/2,-bt),new p(-z/2,-bt)),rhombus:new M(new p(-z*3/4,bt),new p(z/4,bt),new p(z*3/4,-bt),new p(-z/4,-bt)),"right-triangle":new M(new p(-z/2,-z/2),new p(z/2,-z/2),new p(-z/2,z/2)),"rhombus-2":new M(new p(z/2-bt,z/4),new p(-bt-z/2,z/4),new p(bt-z/2,-z/4),new p(bt+z/2,-z/4)),chevron:new M(new p(-.75*z,2*bt),new p(.25*z,2*bt),new p(.75*z,0),new p(.25*z,-2*bt),new p(-.75*z,-2*bt),new p(-.25*z,0)),"right-triangle-2":new M(new p(-2*bt,-z/2),new p(-2*bt,z/2),new p(2*bt,-z/2)),kite:new M(new p(0,-z),new p(2*bt,-z/2),new p(0,z),new p(-2*bt,-z/2)),dart:new M(new p(2*bt,.75*z),new p(0,-.75*z),new p(-2*bt,.75*z),new p(0,.25*z))},Qh=["","","",m.yellow,m.blue,m.green,m.red,m.teal,m.purple],sf={trapezium:m.orange,"right-triangle":m.green,"rhombus-2":m.lime,chevron:m.orange,kite:m.purple,dart:m.teal},nf={"equ-triangle":m.green,square:m.yellow,"reg-pentagon":m.blue,"reg-hexagon":"#ffd615",rectangle:m.yellow,trapezium:"#cc1030",rhombus:m.blue,"rhombus-2":"#e6e2c6",chevron:"#cc1030","right-triangle-2":"#ffd615",kite:"#134791",dart:m.purple};function Hn(e){return Qh[e%Qh.length]||m.yellow}function li(e){if(e in ef)return ef[e];if(e.match(/^[0-9.,\-\s]+$/)){let s=e.split(",").map(t=>new p(...t.split(" ").map(i=>+i)));return new M(...s)}throw new Error("Unknown polygon type.")}var rv=["trapezium","rhombus","rhombus-2","rectangle","right-triangle","right-triangle-2"],ov=["equ-triangle","square","reg-pentagon","reg-hexagon","reg-heptagon","reg-octagon","reg-decagon","reg-dodecagon","rectangle","trapezium","kite","dart"],W=class extends T{constructor(t,i,n){super(i,n);this.type="polygon";this.options=t,this.path=li(t),this.snapAngles=Ht(this.path.edges.map(Bn)),this.symmetric=ov.includes(t);let r=i.options.altColors?nf:sf;this.colour=r[t]||Hn(this.path.points.length);let o=x.aroundPoints(this.path.points),a=new p(o.center.x,o.p.y);this.showSelectionOutline=p.distance(a,this.path.project(a))>5;let l={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=c("path",l,this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}setShape(t){this.path=t,this.$path.draw(t),this.$outline.draw(t),this.transform()}setSize(t){t=S(Ft(t,1),.1,10),super.setSize(t);let i=li(this.options),n=i.centroid;this.path=i.translate(n.inverse).scale(t).translate(n),this.$path.draw(this.path),this.$outline.draw(this.path),this.transform()}static makeThumbnail(t,i,n){let r=rv.includes(t)?30:40,o=li(t),a=Math.max(...o.points.map(d=>d.length));o=o.scale(36/a).shift(40,r);let l=c("svg",{width:80,height:2*r},i),h=c("path",{class:"polygon-tile",path:o},l);n.options.watch(d=>{let u=d.altColors?nf:sf,f=i.data.color||u[t]||Qh[o.points.length];h.setAttr("fill",f)})}setColour(t){super.setColour(t),this.$path.setAttr("fill",E(this.colour))}flip(t){t&&(this.posn=new p(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.flipped=!this.flipped,this.symmetric||(this.path=this.path.reflect(Jh),this.$path.draw(this.path),this.$outline.draw(this.path)),this.transform()}},jo=["polygon","tangram","pentomino","custom-polygon","pentagon","rectangle","reg-polygon"];I([{type:"button",label:"Flip",tileTypes:[...jo,"egg","fractal","garden"],show:e=>e.length>1||!!e[0].rot||!e[0].symmetric,click:(e,s)=>{let t=s.selection.center;for(let i of e)i.flip(t);s.change({changed:e})}},{type:"button",tileTypes:jo,label:"Cut",click:(e,s)=>s.tools.cutPolygon.enable()},{type:"button",label:"Join",tileTypes:jo,show:e=>e.length>1,click:(e,s)=>{let t=e.map(o=>o.transformed),i=M.union(...t),n=e[0].colour,r=i.map(o=>new W(gt(o.points),e[0].$parent));for(let o of r)o.transform(),o.setColour(n);for(let o of e)o.delete();s.selection.select(r,!0),s.change({added:r,deleted:e})}},{type:"button",label:"Fold Net",tileTypes:jo,show:e=>e.length>2,click:(e,s)=>{let t=ks.fold(e);t&&s.change({added:[t],deleted:e})}}]);var av=[[0,-.2],[1.2,-1],[.6,1],[-.6,1],[-1.2,-.2]],of=av.map(e=>new p(e[0]*50,e[1]*50)),Uo=class extends W{constructor(t,i,n){super(t||gt(of),i,n);this.type="custom-polygon";this.$handles=[];this.showSelectionOutline=!0;for(let[o,a]of this.path.points.entries())this.makeVertex(a,o);this.updatePath();let r;this.$parent.events.listen(this.$outline,{down:({posn:o})=>{o=this.relativePosn(o);let a=this.path.edges.findIndex(l=>o.distanceFromLine(l)<5);r=this.makeVertex(o,(a+1)%this.$handles.length),this.updatePath()},move:({posn:o})=>{r&&this.moveVertex(r,o)},end:()=>{r&&this.$parent.change({changed:[this]})}}),this.$outline.css("cursor","crosshair")}makeVertex(t,i){if(this.$handles.length>=24)return;let n=this.makeHandle("c",(r,o)=>this.moveVertex(n,o),()=>this.deleteVertex(n));return n.setCenter(t),n.setAttr("r",8),n.css("cursor","move"),this.$handles.splice(i,0,n),n}deleteVertex(t){t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.updatePath()}moveVertex(t,i){var r;let n=(r=this.$parent.snapping.snap([i]))==null?void 0:r.shift;t.setCenter(this.relativePosn(n?i.add(n):i)),this.updatePath()}updatePath(){let t=this.$handles.map(i=>i.center);this.path=new M(...t),this.$path.draw(this.path),this.$outline.draw(this.path),this.transform(),this.snapAngles=Ht(this.path.edges.map(Bn)),this.options=gt(t),this.$parent.selection.update()}flip(t){t&&(this.posn=new p(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.transform();for(let i of this.$handles)i.setCenter(i.center.reflect(Jh));this.updatePath()}static makeThumbnail(t,i){let n=new M(...of).scale(.5).shift(40),r=c("svg",{width:80,height:80},i);c("path",{class:"polygon-tile",path:n,fill:m.green},r);for(let o of n.points)c("circle",{cx:o.x,cy:o.y,r:3.5,fill:"white"},r)}};I([{type:"button",tileTypes:["custom-polygon"],label:"Fix vertices",click:(e,s)=>{let t=[];for(let i of e){let n=new W(gt(i.path.points),s);n.setColour(i.colour),n.setTransform(i.posn,i.rot),s.selection.add(n),i.delete(),t.push(i)}s.change({added:t,deleted:e})}}]);var tc=25/2,af=[[[0,2],[0,-4],[-2,-4],[-2,4],[2,4],[2,2],[0,2]],[[0,0],[0,-4],[-2,-4],[-2,2],[0,2],[0,4],[2,4],[2,0],[0,0]],[[-5,-1],[5,-1],[5,1],[-5,1]],[[-3,-2],[-3,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2]],[[3,-2],[3,0],[1,0],[1,-2],[-1,-2],[-1,2],[5,2],[5,-2],[3,-2]],[[-1,-3],[-1,-1],[-3,-1],[-3,3],[-1,3],[-1,1],[1,1],[1,-1],[3,-1],[3,-3],[-1,-3]],[[1,1],[1,-3],[-1,-3],[-1,1],[-3,1],[-3,3],[3,3],[3,1],[1,1]],[[1,-1],[1,-3],[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,1],[3,1],[3,-1],[1,-1]],[[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-4,-2],[-4,0],[-2,0],[-2,2],[0,2],[0,0],[4,0],[4,-2],[-4,-2]],[[-1,-3],[-1,1],[-3,1],[-3,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-1,-3],[-1,1],[-5,1],[-5,3],[1,3],[1,-3],[-1,-3]],[[-1,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2],[-3,0],[-1,0]],[[-3,2],[-3,0],[-1,0],[-1,-2],[3,-2],[3,0],[1,0],[1,2]],[[-3,2],[-3,-2],[3,-2],[3,0],[-1,0],[-1,2]],[[-2,2],[2,2],[2,-2],[-2,-2]],[[-4,1],[4,1],[4,-1],[-4,-1]]].map(e=>e.map(s=>new p(s[0]*tc,s[1]*tc))),lv=[[2,4],[4,4],[5,9],[7,2],[7,6],[11,3],[13,7],[15,3],[17,7],[20,2],[21,5],[23,7],[3,2],[7,2],[5,6],[10,4],[8,7]],lf=[...F.rainbow(12).map(e=>e.hex),m.red,m.blue,m.green,m.yellow,m.purple],Zo=class extends W{constructor(t,i,n){super(gt(af[+t]),i,n);this.type="pentomino";this.options=t,this.setColour(lf[+t])}static makeThumbnail(t,i){let n=lv[+t],r=new M(...af[+t]).scale(10/tc);i.draw(r.shift(10*n[0],10*n[1]).shift(1,1)),i.setAttr("fill",lf[+t])}};var hf=[[[-4,-2],[0,2],[4,-2]],[[-4,-2],[0,2],[4,-2]],[[-2,0],[0,-2],[2,0],[0,2]],[[-3,1],[1,1],[3,-1],[-1,-1]],[[0,-1],[2,1],[-2,1]],[[0,-1],[2,1],[-2,1]],[[-2,-2],[2,-2],[2,2]]],cf=[m.red,m.blue,m.green,m.yellow,m.orange,m.teal,m.purple],hv=[[2,4],[4,2],[6,4],[3,7],[7,2],[4,5],[6,6]],df=[-90,0,0,0,-90,0,90],cv=25,Wo=class extends W{constructor(t,i,n){super(gt(hf[+t].map(r=>new p(...r).scale(cv))),i,n);this.type="tangram";this.snapAngles=[0,45,90,135];this.options=t,this.setColour(cf[+t]),this.rot=df[+t],this.transform()}static makeThumbnail(t,i){let n=hv[+t],r=hf[+t].map(a=>new p(...a).rotate(U(df[+t])).shift(...n).scale(18).shift(2,2)),o=new M(...r);i.draw(o),i.setAttr("fill",cf[+t])}getSnapLines(){return this.path.edges}};var mf=25,zn=(1+Math.sqrt(5))/2*mf,Ko=Math.sqrt((5+Math.sqrt(5))/2)*mf,qn=zn*(Math.sqrt(5)-1)/2,pf=[`0 ${-zn},${Ko} ${-qn},0 ${zn},${-Ko} ${-qn}`,`0 ${2*qn-zn},${Ko} ${qn},0 ${-zn},${-Ko} ${qn}`],uf=[["M29.4-30.9C25.3-18.2,13.4-9.5,0-9.5c-13.4,0-25.3-8.6-29.4-21.4","M29.4,0C20.8-6.2,10.6-9.5,0-9.5c-10.6,0-20.8,3.3-29.4,9.5"],["M18.2,15.5C20.1,9.6,19,3.3,15.5-1.7C11.9-6.6,6.1-9.5,0-9.5c-6.1,0-11.9,2.9-15.5,7.9c-3.6,4.9-4.6,11.3-2.7,17.1","M18.2-15.5C12.9-11.6,6.5-9.5,0-9.5c-6.5,0-12.9-2.1-18.2-5.9"]],ff=[m.red,m.blue],Xo=class extends W{constructor(t,i,n){super(pf[+t],i,n);this.type="penrose";this.setColour(ff[+t]),this.options=t;let r=c("g",{class:"penrose-circles"});this.$path.insertAfter(r);for(let o of uf[+t])c("path",{d:o},r)}static makeThumbnail(t,i){let n=+t,r=c("svg",{width:80,height:80,viewBox:"-50 -50 100 100"},i);c("polygon",{points:pf[n],class:"polygon-tile",fill:ff[n]},r);let o=c("g",{class:"penrose-circles"},r);for(let a of uf[n])c("path",{d:a},o)}};var gf=["M13.9-13.9,2.8-25H-2.8L-25-2.8V2.8L-2.8,25H2.8L13.9,13.9C21.6,6.6,21.6-6.6,13.9-13.9Zm-2.8,25L0,22.2-22.2,0,0-22.2,11.1-11.1A15.8,15.8,0,0,1,11.1,11.1Z","M25-2.8,13.9-13.9c-7.3-7.7-20.5-7.7-27.8,0L-25-2.8V2.8l11.1,11.1c7.3,7.7,20.5,7.7,27.8,0L25,2.8ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1a15.8,15.8,0,0,1,22.2,0L22.2,0Z","M-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0s7.6-20.5,0-27.8L2.8-25H-2.8ZM15.7,0a15.9,15.9,0,0,1-4.6,11.1,15.8,15.8,0,0,1-22.2,0L-22.2,0,0-22.2,11.1-11.1A15.9,15.9,0,0,1,15.7,0Z","M-25-2.8V2.8L-2.8,25H2.8L25,2.8V-2.8L2.8-25H-2.8Zm25,25L-22.2,0,0-22.2,22.2,0Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8c-7.6,7.3-7.6,20.5,0,27.8s20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1c-5.8,6.1-16.3,6.1-22.2,0a15.8,15.8,0,0,1,0-22.2,15.8,15.8,0,0,1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8L-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1c5.9-6.1,16.4-6.1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z"],Yo=class extends W{constructor(t,i,n){super("square",i,n);this.type="kolam";this.setColour(m.orange),this.options=t,c("path",{d:gf[+t],fill:"white"},this.$el),c("circle",{r:3,fill:"white"},this.$el),this.$el.append(this.$outline),this.$path.css("stroke-width",".5px")}static makeThumbnail(t,i){let n=c("svg",{width:60,height:60},i);c("rect",{class:"polygon-tile",fill:m.orange,x:5,y:5,width:50,height:50},n),c("path",{d:gf[+t],fill:"white",transform:"translate(30 30)"},n),c("circle",{r:3,cx:30,cy:30,fill:"white"},n)}};var Zi=["M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-42.1,0A288.5,288.5,0,0,0-20.2,110.2a287.6,287.6,0,0,0,62.3,93.3V0Z","M-42.1,0V203.5a289.5,289.5,0,0,0,62.4-93.3A286.5,286.5,0,0,0,42.1,0Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-59.6 59.6L59.6 59.6Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z"],vf=[[66,-17.5,-22.5],[82,-17.5,22.5],[23,-36.5,45],[125,-36.5,-45],[56,47.3,135],[92,47.3,-135],[74,101,180],[41,98,45],[107,98,-45]],dv={0:1,1:1,2:3,3:2,7:8,8:7},wf=[m.lime,m.teal,m.blue,m.red,m.yellow,m.green,m.grey,m.orange,m.purple],Qo=class extends W{constructor(t,i,n){super(gt(js(Zi[+t])),i,n);this.type="egg";this.snapAngles=[0,45,90,135];this.options=t,this.$path.setAttr("d",Zi[+t]),this.$outline.setAttr("d",Zi[+t]),this.setColour(wf[+t]),this.rot=vf[+t][2],this.transform(),+t<=1&&this.snapAngles.push(22.5,67.5,112.5,157.5)}flip(t){super.flip(t);let i=this.flipped?dv[this.options]||this.options:this.options;this.$path.setAttr("d",Zi[+i]),this.$outline.setAttr("d",Zi[+i])}static makeThumbnail(t,i){i.setAttr("d",Zi[+t]);let n=vf[+t];i.css("transform",`translate(${n[0]}px, ${n[1]}px) rotate(${n[2]}deg) scale(0.5)`),i.setAttr("fill",wf[+t]),i.css("stroke-width","2px")}};var ec=1/Math.sqrt(3),pv=50/ec,yf=[m.blue,m.purple,m.red,m.orange,m.yellow],Wi=M.regular(6,pv).rotate(Math.PI/6).points;Wi.splice(3,1);Wi.splice(2,0,new p(2*Wi[1].x,Wi[0].y));var Jo=class extends W{constructor(t,i,n){super(gt(Wi.map(r=>r.scale(ec**+t))),i,n);this.type="fractal";this.setColour(yf[+t]),this.options=t}static makeThumbnail(t,i){let n=new M(...Wi).scale(.6*ec**+t),r=x.aroundPoints(n.points),o=c("svg",{width:20+r.w,height:20+r.h},i);n=n.shift(10-r.center.x+r.w/2,10-r.center.y+r.h/2),c("path",{class:"polygon-tile",path:n,fill:yf[+t]},o)}};var ta=["M-25,34.4a81.3,81.3,0,0,1,50,0h0A81.1,81.1,0,0,0,40.4-13.1h.1A81.5,81.5,0,0,1,0-42.5H0A81.5,81.5,0,0,1-40.5-13.2h.1A81.1,81.1,0,0,0-25,34.4Z","M-15.4-21.3A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3a80.6,80.6,0,0,1,50,0A80.3,80.3,0,0,1,25,8.1,80.4,80.4,0,0,1,40.4,55.7,80.2,80.2,0,0,1,0,26.3,80.2,80.2,0,0,1-40.4,55.7,80.4,80.4,0,0,1-25,8.1,80.3,80.3,0,0,1-65.4-21.3,80.6,80.6,0,0,1-15.4-21.3Z","M65.4-21.3A80.5,80.5,0,0,1,0,12.1,80.5,80.5,0,0,1-65.4-21.3a80.6,80.6,0,0,1,50,0A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3,80.6,80.6,0,0,1,65.4-21.3Z","M80.9-47.5h0A81.5,81.5,0,0,1,40.4-76.9,80.4,80.4,0,0,0,0-47.5,80.2,80.2,0,0,0-40.5-76.9h0A80.8,80.8,0,0,1-80.9-47.6h0A80.3,80.3,0,0,1-65.5,0,80.3,80.3,0,0,1-80.9,47.5h0A80.8,80.8,0,0,1-40.5,76.9h0A80.2,80.2,0,0,0,0,47.5,80.4,80.4,0,0,0,40.4,76.9,81.5,81.5,0,0,1,80.9,47.6h0A80.3,80.3,0,0,1,65.5,0,80.3,80.3,0,0,1,80.9-47.5Z","M0-47.5A80.3,80.3,0,0,1,15.5,0,80.3,80.3,0,0,1,0,47.5,80.3,80.3,0,0,1-15.5,0,80.3,80.3,0,0,1,0-47.5Z","M130.9,153.8a80.5,80.5,0,0,1,15.4-47.5,80.2,80.2,0,0,1-40.4-29.4A80.1,80.1,0,0,1,90.5,29.4a80.6,80.6,0,0,1-50,0A80.6,80.6,0,0,1,0,0,80.3,80.3,0,0,1-40.4,29.4a80.9,80.9,0,0,1-50.1,0,80.8,80.8,0,0,1-15.4,47.5,80.9,80.9,0,0,1-40.5,29.4,79.9,79.9,0,0,1,15.5,47.5,81.3,81.3,0,0,1,50,0A80.9,80.9,0,0,1,0,72.9a80.9,80.9,0,0,1,80.9,80.9A81.3,81.3,0,0,1,130.9,153.8Z","M40.4-13.2A80.4,80.4,0,0,0,0-42.5,80.7,80.7,0,0,0-40.4-13.1,80.9,80.9,0,0,0-25,34.4a80.6,80.6,0,0,0,50,0A81.2,81.2,0,0,0,40.4-13.2Z","M40.4-13.1A82,82,0,0,1,0-42.5,81.1,81.1,0,0,1-40.5-13.2,81.3,81.3,0,0,1-25,34.4a81.3,81.3,0,0,1,50,0A81.6,81.6,0,0,1,40.4-13.1Z"],bf=["M16.2-.3a5.5,5.5,0,0,1-4.4,6.4A5.3,5.3,0,0,1,5.5,1.8,5.4,5.4,0,0,1,9.8-4.6,5.5,5.5,0,0,1,16.2-.3Zm8-8A3.8,3.8,0,0,0,28-4.5a3.7,3.7,0,0,0,3.7-3.8A3.6,3.6,0,0,0,28-12,3.7,3.7,0,0,0,24.2-8.3ZM19,23.4a4.9,4.9,0,0,0,4.8-4.8A4.8,4.8,0,0,0,19,13.9a4.7,4.7,0,0,0-4.7,4.7A4.8,4.8,0,0,0,19,23.4ZM-11.7,6.1A5.3,5.3,0,0,0-5.4,1.8,5.4,5.4,0,0,0-9.7-4.6,5.5,5.5,0,0,0-16.1-.3,5.5,5.5,0,0,0-11.7,6.1ZM-27.9-4.5a3.8,3.8,0,0,0,3.8-3.8A3.7,3.7,0,0,0-27.9-12a3.6,3.6,0,0,0-3.7,3.7A3.7,3.7,0,0,0-27.9-4.5ZM20.9-22A139.9,139.9,0,0,1,3-19.5a1.1,1.1,0,0,1-.1.5L1-15.2V30H-1V-15.2L-2.9-19a1.1,1.1,0,0,1-.1-.5,127,127,0,0,1-17.8-2.6A80.8,80.8,0,0,0,0-41.7,83.3,83.3,0,0,0,20.9-22ZM-3.8-26.7A3.2,3.2,0,0,0-7-30a3.3,3.3,0,0,0-3.3,3.3A3.2,3.2,0,0,0-7-23.5,3.2,3.2,0,0,0-3.8-26.7ZM6.5-30a3.2,3.2,0,0,0-3.2,3.3,3.2,3.2,0,0,0,3.2,3.2,3.2,3.2,0,0,0,3.3-3.2A3.3,3.3,0,0,0,6.5-30ZM-23.7,18.6a4.9,4.9,0,0,0,4.8,4.8,4.8,4.8,0,0,0,4.7-4.8,4.7,4.7,0,0,0-4.7-4.7A4.8,4.8,0,0,0-23.7,18.6Z","M-16.9-4.7l-17.7-6.1a.8.8,0,0,1-.5-.9.8.8,0,0,1,.9-.5L-16.5-6a.7.7,0,0,1,.5.9.7.7,0,0,1-.7.4ZM-24.6-13l9.7,5.4h.3a.9.9,0,0,0,.7-.3.9.9,0,0,0-.3-1l-9.7-5.4a.8.8,0,0,0-1,.2A.8.8,0,0,0-24.6-13ZM-7.8-4.9l5.9,1.2h.5c.2-.1.3-.2.3-.4l.3-1.4a.6.6,0,0,0-.5-.8L-7.2-7.7h-.6l-.3.4-.3,1.4A.8.8,0,0,0-7.8-4.9ZM2.8-2.5a.9.9,0,0,0,.7.6h.2l1.6-.3a1,1,0,0,0,.5-.4.7.7,0,0,0,.1-.5l-1.4-6a.8.8,0,0,0-.9-.6L2-9.4l-.5.3a1.3,1.3,0,0,0-.1.6ZM10.9.4a.7.7,0,0,0-.1-.5L10-1.3a.8.8,0,0,0-1-.2L4,1.9c-.2.1-.3.2-.3.4a.7.7,0,0,0,.1.5L4.6,4a.6.6,0,0,0,.6.3h.4l5-3.4ZM-4.5-1l-1.4-.3a.4.4,0,0,0-.5.1c-.2.1-.3.2-.3.4L-8.2,5.1a.7.7,0,0,0,.5.8l1.4.4h.5a.5.5,0,0,0,.3-.5L-4-.1A.7.7,0,0,0-4.5-1Zm-12.1-.6a.7.7,0,0,0,.7-.6c.1-.4-.2-.7-.6-.8l-11-1.7a.8.8,0,0,0-.8.6c0,.4.2.8.6.8l11,1.7Zm16.1,6H-1c-.2,0-.3.1-.5.3l-.8,1.1a.8.8,0,0,0,.1,1l4.9,3.6.4.2h.1l.4-.3.9-1.1c.2-.4.2-.8-.1-1Zm-9.4,8.8a.7.7,0,0,0-1,.1L-22.2,28.2a.7.7,0,0,0,.1,1l.4.2a.9.9,0,0,0,.6-.3l11.3-15A.6.6,0,0,0-9.9,13.2Zm-11.2,5.6c.2.2.3.3.5.3l.5-.2,8.2-7.6a.7.7,0,0,0,0-1,.8.8,0,0,0-1,0L-21,17.8A.7.7,0,0,0-21.1,18.8Zm14-4.9a.8.8,0,0,0-1,.4L-13,24.2a.6.6,0,0,0,.3.9h.3a.6.6,0,0,0,.6-.4l5-9.9A.8.8,0,0,0-7.1,13.9Zm17.4-.7a.8.8,0,0,0-1-.2.8.8,0,0,0-.2,1L19.9,29.4a.5.5,0,0,0,.5.3h.4a.7.7,0,0,0,.2-1ZM7,14.4A.7.7,0,0,0,6,14a.7.7,0,0,0-.3.9L10.3,25a.8.8,0,0,0,.7.4h.3a.8.8,0,0,0,.3-1Zm4-2.8,7.8,7.8.5.2.5-.2a.7.7,0,0,0,0-1L12,10.6a.7.7,0,0,0-1,1ZM34.4-11.2a.7.7,0,0,0-.8-.5l-18,5.5a.7.7,0,0,0-.4.9.6.6,0,0,0,.6.5c.1,0,.2,0,.2-.1l18-5.4A.7.7,0,0,0,34.4-11.2ZM26.7-4l-11,1.3a.6.6,0,0,0-.6.8.7.7,0,0,0,.7.6h.1l11-1.3c.4,0,.6-.4.6-.8S27.1-4,26.7-4ZM14-7.3h.3l9.8-5.1a.7.7,0,0,0,.3-1,.7.7,0,0,0-.9-.3L13.6-8.6a.8.8,0,0,0-.3,1A.8.8,0,0,0,14-7.3ZM-.5-16.6h0a.7.7,0,0,0,.7-.6L.6-36a.7.7,0,0,0-.7-.7.7.7,0,0,0-.7.7l-.4,18.7A.7.7,0,0,0-.5-16.6Zm3.2,1.2h.2a.7.7,0,0,0,.7-.6L5.7-26.9a.7.7,0,0,0-.5-.8.8.8,0,0,0-.9.6L2.2-16.3A.7.7,0,0,0,2.7-15.4Zm-6.1-.1h.1c.4-.1.7-.5.6-.8l-1.8-11c0-.4-.4-.6-.8-.6a.8.8,0,0,0-.6.8l1.8,11A.9.9,0,0,0-3.4-15.5Z","M60.8-16.2l-3.6-2.5,1.4-3.9-.9-.3-1.3,3.5h0l-9.5,3,2.8-7.8h-1l-3,8.3-9.5,3.1,4.4-11.8H39.5L35-12.5,25.5-9.4l5-14.7H29.4L24.3-9.1l-9.1,3,6-16.3-1.2.3L14-5.7l-1.8.5a50.6,50.6,0,0,0,5.3-16.2l-1.9.6-.4.2L1-9.8v-10L14.4-30.3c0-.4-.1-.8-.1-1.2L1-21.1v-10l11.7-9.1-.3-1.1L1-32.4v-10l8.9-6.9a3,3,0,0,0-.4-1L1-43.7v-10l5.2-4a4.1,4.1,0,0,0-.5-.9l-5.2,4h-1l-5.2-4a4.1,4.1,0,0,0-.5.9l5.2,4v10l-8.5-6.6a3,3,0,0,0-.4,1L-1-42.4v10l-11.4-8.9-.3,1.1L-1-31.1v10L-14.3-31.5c0,.4-.1.8-.1,1.2L-1-19.8v10L-15.2-20.6l-.4-.2-1.9-.6A50.6,50.6,0,0,0-12.2-5.2L-14-5.7l-6-16.4-1.2-.3,6,16.3-9.1-3L-29.4-24h-1.1l5,14.7L-35-12.5l-4.5-12.2h-1.1l4.4,11.8L-45.7-16l-3-8.3h-1l2.8,7.8-9.5-3h0l-1.3-3.5-.9.3,1.4,3.9-3.6,2.5.7.7,3.1-2.2v.2l9.4,3-6.8,4.8.7.7,7.3-5.1,9.6,3.1L-47.3-3.8l.9.6,10.8-7.4,9.5,3.1-13,8.9,1,.5,13.2-9,9.6,3-14.4,10,1.2.4,14.3-9.9h.4l3,1C-9.8-1-8.9.5-7.9,1.9L-18.4,9.4l1.3.3,9.8-7a64.2,64.2,0,0,0,6.6,8H.7a64.2,64.2,0,0,0,6.6-8l9.8,7,1.3-.3L7.9,1.9C8.9.5,9.8-1,10.8-2.6l3-1h.4L28.5,6.3l1.2-.4L15.3-4.1l9.6-3,13.2,9,1-.5-13-8.9,9.5-3.1L46.4-3.2l.9-.6L36.8-11l9.6-3.1L53.7-9l.7-.7-6.8-4.8,9.4-3v-.2l3.1,2.2Zm-76-3.2L-1-8.5V.6l-9.7-7.4A45.9,45.9,0,0,1-15.2-19.4ZM0,8.5A66.6,66.6,0,0,1-9.6-4.7L-1,1.8V6.3a1,1,0,0,0,1,1,1,1,0,0,0,1-1V1.8L9.6-4.7A71,71,0,0,1,0,8.5ZM10.7-6.8,1,.6V-8.5L15.2-19.4A45.9,45.9,0,0,1,10.7-6.8Z","M65-1V1.1A81.6,81.6,0,0,1,40,5c-8.9,0-12.7-.4-20.6-2.9A1,1,0,0,1,18.8.8.9.9,0,0,1,20,.2C27.7,2.7,31.2,3,40,3A79.7,79.7,0,0,0,64.7-.9ZM-64.6,1.1A82.4,82.4,0,0,0-39.4,5c8.8,0,12.6-.4,20.5-2.9A1.2,1.2,0,0,0-18.2.8,1,1,0,0,0-19.5.2C-27.2,2.7-30.7,3-39.4,3A79.9,79.9,0,0,1-64.2-.9H-65V1ZM-45.8,36a6.7,6.7,0,0,1,6.7-6.7A6.7,6.7,0,0,1-32.4,36a6.7,6.7,0,0,1-6.7,6.7A6.7,6.7,0,0,1-45.8,36Zm2,0a4.7,4.7,0,0,0,4.7,4.7A4.7,4.7,0,0,0-34.4,36a4.7,4.7,0,0,0-4.7-4.7A4.7,4.7,0,0,0-43.8,36Zm10.4-71.4a5.7,5.7,0,0,0-5.7-5.7,5.6,5.6,0,0,0-5.7,5.7,5.7,5.7,0,0,0,5.7,5.7A5.8,5.8,0,0,0-33.4-35.4ZM4.9-37.1a2.2,2.2,0,0,0,2.2,2.2,2.2,2.2,0,0,0,2.2-2.2,2.2,2.2,0,0,0-2.2-2.2A2.2,2.2,0,0,0,4.9-37.1ZM38.7,42.7h0A6.8,6.8,0,0,1,32,36a6.7,6.7,0,1,1,6.7,6.7ZM43.4,36a4.7,4.7,0,1,0-4.7,4.7h0A4.7,4.7,0,0,0,43.4,36ZM0,42.9c4.1.7,8.7-9.6,11.4-17.9A78.6,78.6,0,0,0,15.3.3c0-6.7-1.3-13.7-3.2-21.6-.6-1.6-3.4-4.2-5.8-5.1,2.2-2,1.8-2.9,2.3-3.7s.1-3.3,0-3.8c-4.5,1.1-6.3-2.7-4.3-5.5C9-44,19.3-53.3,29-55.2a6.4,6.4,0,0,0,1,1.3,3.1,3.1,0,0,0,1.8.5,2.9,2.9,0,0,0,2.4-1.2h0a3,3,0,0,0-.6-4.2,2.9,2.9,0,0,0-4.2.7,2.6,2.6,0,0,0-.5.9C19-55.4,8.7-46.5,3.6-41.5A33.5,33.5,0,0,1-.2-42.6l-3.7,1.2c-5-4.9-15.3-13.9-25.4-15.8a2.7,2.7,0,0,0-.5-1.1,3,3,0,0,0-4.2-.6,3,3,0,0,0-.6,4.2h0a3,3,0,0,0,2.4,1.2,3.2,3.2,0,0,0,1.8-.6,3.1,3.1,0,0,0,.9-1.1c10.1,2,20.8,11.8,25.2,16.3,1.3,2.5-.4,5.8-4.2,5-.1.6-.5,3,0,4s.6,1.5,2.3,3.5c-2.4.7-6,4-6.3,5.3-1.6,7-3,15.5-3,21.4a78.8,78.8,0,0,0,4,24.7C-8.8,33.3-3.5,43.8,0,42.9Zm-5.2-80a2.2,2.2,0,0,0-2.2-2.2,2.2,2.2,0,0,0-2.2,2.2,2.2,2.2,0,0,0,2.2,2.2A2.2,2.2,0,0,0-5.2-37.1ZM33-35.4a5.8,5.8,0,0,0,5.7,5.7,5.7,5.7,0,0,0,5.7-5.7,5.6,5.6,0,0,0-5.7-5.7A5.7,5.7,0,0,0,33-35.4Z","M.9,33.4v-9l12.7-9.9.3-1.4L.9,23.2v-10l14-10.9V1L.9,12V2L14.5-8.6c0-.3-.1-.7-.1-1.1L.9.8v-10l11.9-9.3a3.6,3.6,0,0,1-.2-1L.9-10.4v-10l9.2-7.1a4.2,4.2,0,0,0-.4-1L.9-21.6v-9.9h0l5.6-4.3L6-36.8.4-32.4H-.4L-6-36.8l-.5.9L-1-31.6a.1.1,0,0,0-.1.1v9.8l-8.6-6.8a4.2,4.2,0,0,0-.4,1l9,7v10l-11.5-9a3.6,3.6,0,0,1-.2,1L-1.1-9.3V.7L-14.4-9.7c0,.4-.1.8-.1,1.1L-1.1,1.9v10L-14.9,1V2.3L-1.1,13.1v10l-12.8-10,.3,1.4,12.5,9.8v9l-9.6-7.5.6,1.8,9,7v4.1a1,1,0,0,0,1,1,.9.9,0,0,0,1-1v-4l9.2-7.1.6-1.7Z","M0,.8A76.2,76.2,0,0,0,7.8,9.9c-1.6,1.9-5.4,7.6-6.6,21.6h-2C-2,17.1-6,11.4-7.6,9.7A72.7,72.7,0,0,0,0,.8ZM124.3,117.2c-6.5,4.7-6.3,16,.5,25.4a30,30,0,0,0,5.8,6,81.7,81.7,0,0,1,8.3-31.1C133.6,114.7,128.1,114.4,124.3,117.2ZM-82.6,86.3A82.8,82.8,0,0,0-104,75l-1.2,1.7A81,81,0,0,1-83.8,87.9a79.9,79.9,0,0,1,17.6,17.7l.3.5,1.3-1.7A81.3,81.3,0,0,0-82.6,86.3Zm47.3-33.1a80,80,0,0,1-3.9-23.7l-1.1.4-.9.2a83.5,83.5,0,0,0,4,23.7A79.9,79.9,0,0,0-25.8,76.6l2-.6-.3-.4A78.4,78.4,0,0,1-35.3,53.2Zm-81,62.7.6-1.9c-11.9-5.1-16.5-10-18.1-12.4a81.4,81.4,0,0,1-11.8,4.9,85.1,85.1,0,0,1,5.8,9.4C-138.6,115.3-132.2,112.1-116.3,115.9ZM-90,30.1a81.7,81.7,0,0,1-.8,11.1c2,.4,8.7,2.3,18.5,13.8l1.7-1.2c-6.9-11.4-7.6-18.1-7.4-20.9A99.4,99.4,0,0,1-90,30.1ZM38,53.8a85.2,85.2,0,0,0,4.1-23.4l-1.8-.5h-.2a81.5,81.5,0,0,1-4,23.4A81.4,81.4,0,0,1,24.6,75.5l-.4.6,2,.7h0A83,83,0,0,0,38,53.8Zm68.4,24.7-.9-1.3-.3-.4a82,82,0,0,1-17.3,17,82,82,0,0,1-22.5,11.3h-.2l1.2,1.7A85.2,85.2,0,0,0,89.1,95.4,81.6,81.6,0,0,0,106.4,78.5ZM70.8,54.6l1.6,1.2c9.9-11.4,16.5-13.4,18.5-13.7a80.8,80.8,0,0,1-.9-12,97.8,97.8,0,0,1-11.9,2.8C78.4,35.1,78.4,42.1,70.8,54.6ZM126.3,152a28,28,0,0,0-3.9-7.7,26.3,26.3,0,0,0-11.9-9.5c-4.6-1.6-8.8-1.3-12,1s-5.5,8.3-4.3,14.4A82.6,82.6,0,0,1,126.3,152Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z"],$f=[m.red,m.blue,m.green,m.yellow,m.green,m.teal,m.orange,m.purple],uv=["-30 -35 60 60","-35 -42 70 70","-35 -60 70 70","-45 -45 90 90","-15 -30 30 60","-75 28 150 100","-30 -35 60 60","-30 -35 60 60"],xf=[.7,.6,.3,.6,.3,.6,.7,.7],ea=class extends W{constructor(t,i,n){super(gt(js(ta[+t])),i,n);this.type="garden";this.options=t;let r=+t;this.$path.setAttr("d",ta[r]),this.$outline.setAttr("d",ta[r]);let o=c("path",{d:bf[r],fill:"black",opacity:xf[r]});this.$path.insertAfter(o),this.symmetric=!0,this.setColour($f[r])}static makeThumbnail(t,i){let n=+t,o=c("svg",{width:n===4?40:n===5?120:80,height:80,viewBox:uv[n]},i),a=c("g",{transform:"scale(0.5)"},o);c("path",{d:ta[n],fill:$f[n],class:"polygon-tile"},a),c("path",{d:bf[n],fill:"black",opacity:xf[n]},a)}};var fv=["M34,0a16,16,0,0,1,6.3-12.7l-9-15.7A34.1,34.1,0,0,0,16,0,34.1,34.1,0,0,0,31.3,28.4l9-15.7A16,16,0,0,1,34,0Z","M-25,9.3a33.7,33.7,0,0,0-15.2,3.6l9,15.7A14.4,14.4,0,0,1-25,27.3a16.1,16.1,0,0,1,15.9,14h18A34,34,0,0,0-25,9.3Z","M-25-9.3a33.7,33.7,0,0,1-15.2-3.6l9-15.7A14.4,14.4,0,0,0-25-27.3a16.1,16.1,0,0,0,15.9-14h18A34,34,0,0,1-25-9.3Z","M-8.9,41.3h18A16.1,16.1,0,0,1,25,27.3a14.4,14.4,0,0,1,6.2,1.3l9-15.7A33.9,33.9,0,0,0-8.9,41.3Z","M-31.3-28.4l-9,15.6A65.9,65.9,0,0,1-9.1,41.3h18A83.7,83.7,0,0,0-31.3-28.4Z","M-8.9,41.3h18A65.9,65.9,0,0,1,40.3-12.8l-9-15.6A83.7,83.7,0,0,0-8.9,41.3Z","M-40.3 12.9L-31.3 28.4L40.3 -12.9L31.3 -28.4Z","M-40.2,12.9l9,15.6A65.7,65.7,0,0,1,0,20.6a65.7,65.7,0,0,1,31.2,7.9l9-15.6A82.6,82.6,0,0,0,0,2.6,82.6,82.6,0,0,0-40.2,12.9Z","M31.3,28.4l9-15.6A65.9,65.9,0,0,1,9.1-41.3h-18A83.7,83.7,0,0,0,31.3,28.4Z"],mv=[[6,3,2],[6,4,8],[7,2,5],[7,5,2],[2,6,3],[8,6,4],[5,7,2],[2,7,5],[3,2,6],[4,8,6],[2,5,7],[5,2,7],[0,1,2],[0,2,1]],Fn="#242436",gv=[m.red,m.green,m.yellow];function Pf(e,s){let t=mv[e].map((i,n)=>[i,n]).sort((i,n)=>n[0]-i[0]);for(let[i,n]of t)c("path",{d:fv[i],class:"tantrix","stroke-width":2.8,stroke:Fn,fill:gv[n]},s)}var sa=class extends W{constructor(t,i,n){super("reg-hexagon",i,n);this.type="tantrix";this.options=t,this.colour=Fn,this.$path.setAttr("fill",Fn);for(let r of this.$el.$$(".tantrix"))r.setAttr("stroke",Fn);Pf(+t,this.$el)}setColour(){}static makeThumbnail(t,i){let n=c("svg",{width:60,height:60,viewBox:"-54 -54 108 108"},i);c("path",{class:"polygon-tile",path:li("reg-hexagon"),fill:Fn},n),Pf(+t,n)}};var Sf=[[[-15.7728,63.1105],[-65.2725,56.0545],[-61.7426,-21.037],[-34.7275,-63.1105],[65.2725,-63.1105]],[[60.6056,14.8729],[-53.4909,57.394],[-80.668,-12.5086],[-20.582,-57.394],[80.668,-57.394]],[[0,-73.612],[50,12.9905],[15,73.612],[-50,12.9905],[-30,-73.612]],[[67.056,-58.248],[67.056,1.752],[-10.5597,58.248],[-67.056,-19.3675],[7.056,-58.248]],[[-74.4415,-47.6314],[35.5585,-47.6314],[74.4415,-8.733],[60.1965,44.3902],[-19.4415,47.6314]],[[47.6215,-81.108],[43.731,-26.2458],[-24.012,81.108],[-47.6215,-43.6179],[-7.3786,-81.108]],[[94.9659,43.7299],[-5.0343,43.7299],[-94.9659,0],[-5.0343,-43.7299],[42.1151,-41.1631]],[[-13.1927,57.1955],[76.8074,57.1955],[76.8257,-32.8045],[-9.8062,-57.1955],[-76.8257,-6.4506]],[[-3.2764,58.8874],[86.2804,29.1016],[26.2804,-43.7514],[-26.2804,-58.8874],[-86.2804,13.9666]],[[51.5265,-55],[58.4735,-14.7198],[9.6458,43.251],[-58.4735,55],[-58.4735,-55]],[[-95.733,-40.991],[53.87,-40.991],[95.733,-15.7718],[1.5099,40.991],[-95.733,-10.4271]],[[-85.642,-51.4515],[12.4961,-51.4515],[85.642,-13.2965],[-38.4855,51.4515],[-85.642,18.5485]],[[-69.99,67.0025],[84.488,2.9975],[84.488,-67.0025],[14.488,-67.0025],[-84.488,32.0117]],[[-15.6401,96.696],[46.9202,6.219],[8.0799,-96.696],[-46.9202,-96.696],[-46.9202,51.458]],[[-46.6683,85],[-46.6683,22.7758],[15.5561,-85],[46.6683,-31.1122],[15.5561,85]],[[0,-46.65],[-43.301,-21.65],[-43.301,46.65],[43.301,46.65],[43.301,-21.65]],[[-25,46.65],[25,46.65],[59.15,-12.5],[0,-46.65],[-59.15,-12.5]],[[0,-64.951],[-50,21.65],[-25,64.951],[25,64.951],[50,21.65]]],Tf=[...F.rainbow(15).map(e=>e.hex),m.red,m.blue,m.yellow],ia=class extends W{constructor(t,i,n){super((Sf[+t-1]||[]).map(r=>r.join(" ")).join(","),i,n);this.type="pentagon";this.options=t,this.setColour(Tf[+t-1])}static makeThumbnail(t,i){let n=c("svg",{width:80,height:80},i),r=new M(...Sf[+t-1].map(a=>new p(a[0],a[1])));r=r.scale(41/r.radius).shift(40);let o=Tf[+t-1];c("path",{path:r,fill:o,class:"polygon-tile"},n)}};var na={point:(e,s)=>e!==void 0&&s!==void 0?new p(e,s):void 0,angle:(e,s,t)=>e&&s&&t?new Vt(e,s,t):void 0,line:(e,s)=>e&&s&&!e.equals(s)?new wt(e,s):void 0,segment:(e,s)=>e&&s&&!e.equals(s)?new it(e,s):void 0,circle:(e,s)=>e&&s?new H(e,s):void 0,arc:(e,s,t)=>e&&s&&t?new re(e,s,t):void 0,polygon:(...e)=>e.every(s=>s)?new M(...e):void 0,polyline:(...e)=>e.every(s=>s)?new le(...e):void 0,triangle:(e,s,t)=>e&&s&&t?new wn(e,s,t):void 0,rectangle:(e,s,t)=>e?new x(e,s,t):void 0,distance:p.distance,intersections:ft},Me=mt({});Me.assign(na);var Os=new Map,jn=new Map,vv=/^_x[0-9]+\.at\([0-9-.e]+\)$/,wv=/^intersections\(|\.midpoint$|\.centroid$/,te=class extends T{constructor(t,i,n){super(i,n,c("path",{class:"geo-path"},i.$geoPaths));this.$parent=i;this.type="geo";this.label="";this.hideSelectionOutline=!0;this.isProjection=!1;this.parentKeys=[];this.deleted=!1;this.onDraw=()=>this.draw();this.$shadow=c("path",{class:"geo-shadow"},i.$geoShadows),this.options=t;let[r,o,a]=t.split("=");o||(o=r,r=Me.getKey()),this.key=r,Os.set(r,this),this.snapPoints=this.snapLines=this.snapAngles=[],this.setExpr(o),Me.watch(this.onDraw),this.setColour(i.state.penColor),a&&this.setLabel(a)}setExpr(t,i=!1){let n=Pt(t);Me.setComputed(this.key,n),!i&&(this.options=`${this.key}=${t}=${this.label}`,this.expr=t,this.setParentKeys(t.match(/_x[0-9]+/g)||[]),this.isProjection=vv.test(t),this.computed=wv.test(t),this.$el.setClass("intersection",this.computed))}draw(){let t=Me[this.key];if(t===this.path)return;this.path=t,this.$el.setAttr("hidden",t?void 0:!0),this.isActive&&!t&&this.$shadow.hide();let i=t==null?void 0:t.type;i!==this.geoType&&(this.$el.setClass("geo-point",i==="point"),this.$el.setClass("geo-path",i!=="point"),(i==="point"?this.$parent.$geoPoints:this.$parent.$geoPaths).append(this.$el),this.geoType=i),t&&(i==="point"&&(t=new H(t,this.computed?3.5:6)),this.$el.setClass("fill",this.geoType==="angle"),this.$el.draw(t,{box:this.$parent.canvasBounds.rect}),this.$shadow.setAttr("d",this.$el.attr("d")),this.transform())}setParentKeys(t){var i;for(let n of this.parentKeys)(i=jn.get(n))==null||i.delete(this.key);this.parentKeys=t;for(let n of t)jn.has(n)||jn.set(n,new Set),jn.get(n).add(this.key)}get parents(){return this.parentKeys.map(t=>Os.get(t)).filter(t=>t)}get children(){let t=jn.get(this.key);return t?Array.from(t).map(i=>Os.get(i)).filter(i=>i):[]}get ariaDescription(){var t;return`${(t=this.path)==null?void 0:t.type} ${this.key}: ${this.expr}`}setLabel(t){if(this.options=`${this.key}=${this.expr}=${t||""}`,!t&&this.$label&&this.$label.detach(),!t)return this.label="";this.$label||(this.$label=c("text",{fill:E(this.colour),class:"geo-label"})),this.label||this.$parent.$geoPoints.append(this.$label),this.label=t,Af(this)}setOrder(){}select(){var t;this.isActive=!0,this.path&&(this.geoType==="angle"?this.$el.addClass("hover"):(this.$shadow.show(),(t=this.$el.parent)==null||t.append(this.$el)))}deselect(){this.isActive=!1,this.$shadow.hide(),this.$el.removeClass("hover")}hover(t=!0){this.isActive||!this.path||(this.geoType==="angle"?this.$el.setClass("hover",t):t?this.$shadow.show():this.$shadow.hide())}transform(){this.transformed=this.path,this.snapPoints=this.pending?[]:this.getSnapPoints(),this.snapLines=this.pending||!this.path||yt(this.path)||ae(this.path)?[]:[this.path],$v()}setTransform(){this.transform()}shift(t){!this.expr.match(/^point\([0-9.-]+,[0-9.-]+\)$/)||this.setExpr(this.path.translate(t).toString())}setColour(t){var i,n,r;this.colour=t,(i=this.$el)==null||i.css("color",E(t)),(n=this.$shadow)==null||n.css("color",E(t)),(r=this.$label)==null||r.setAttr("fill",E(t))}delete(){var t;this.deleted=!0,super.delete(),Me.unwatch(this.onDraw),Me[this.key]=void 0,Os.delete(this.key),this.$shadow.remove(),(t=this.$label)==null||t.remove();for(let i of this.children)i.delete()}setPending(t=!0){this.pending=t,t||this.transform();for(let i of this.children)i.setPending(t)}moveStart(){if(!(this.computed||!this.path)){if(this.isProjection){if(this.$parent.selection.size>1)return;this.setParentKeys([])}this.setPending(!0);for(let t of this.parents)t.moveStart();this.moveStartValue=this.transformed}}move(t,i){if(!(!t||!this.path||!this.moveStartValue))if(yt(this.path))this.snapTarget=i,this.$el.setClass("intersection",this.computed||!!(i!=null&&i.intersection)),Me[this.key]=this.moveStartValue.translate(t);else for(let n of this.parents)n.move(t)}moveEnd(){var t,i,n,r;if(!!this.moveStartValue){for(let o of this.parents)o.moveEnd();if(this.setPending(!1),(t=this.snapTarget)!=null&&t.intersection)this.setExpr(this.snapTarget.intersection);else if(((n=(i=this.snapTarget)==null?void 0:i.tile)==null?void 0:n.type)==="geo"){let o=(r=this.snapTarget)==null?void 0:r.tile;if(o.path&&yt(o.path)){for(let a of this.children)a.setExpr(a.expr.replace(this.key,o.key));return this.$parent.selection.add(o),this.delete()}else if(o.path){let a=o.path.offset(Me[this.key]);this.setExpr(`${o.key}.at(${a})`)}}else this.path&&yt(this.path)&&(this.expr=`point(${this.path.x},${this.path.y})`,this.options=`${this.key}=${this.expr}=${this.label}`,this.isActive||this.$parent.selection.implicitChanges.add(this))}}applyChange(t){let[i,n]=t.options.split("=");n!==this.expr&&this.setExpr(n),t.colour!==this.colour&&this.setColour(t.colour),!t.locked!=!this.locked&&this.lock(t.locked),this.lastSavedData=t}static getInferredShape(t){if(t=t.filter(l=>l.path),!t.length)return;if(t.length===1)return{type:t[0].path.type,expr:t[0].key,value:t[0].path};t=t.filter(l=>l.geoType!=="angle");let i=t.filter(l=>yt(l.path)),n=t.filter(l=>Mt(l.path)||ct(l.path));if(n.length===1&&i.length===t.length-1){let l=n[0].path;if(i.every(h=>l.contains(h.path)))return{type:l.type,expr:n[0].key,value:l}}let r=n.filter(l=>Mt(l.path));if(i.length+r.length!==t.length)return;for(let l of r)if(Oe(l.path)){let h=l.parentKeys.map(d=>Os.get(d));for(let d of h)i.includes(d)||i.push(d)}else if(i.filter(h=>l.path.contains(h.path)).length<2)return;let o=i.map(l=>l.key).join(","),a=i.map(l=>l.path);if(i.length===2){let l=new it(a[0],a[1]);return{type:"segment",expr:`segment(${o})`,value:l}}return i.length===3?{type:"triangle",expr:`triangle(${o})`,value:new wn(...a)}:{type:"polygon",expr:`polygon(${o})`,value:new M(...a)}}static redrawLines(t){for(let i of Os.values())i.path&&Xl(i.path)&&(i.$el.draw(i.path,{box:t}),i.$shadow.setAttr("d",i.$el.attr("d")))}static copy(t,i){return i.replace(/\b_x[0-9]+\b/g,r=>{let o=t.get(r)||Me.getKey();return t.set(r,o),o})}static clearModel(){Me.clear(),Me.assign(na)}},Cf=new WeakMap,Mf=e=>{let s=Cf.get(e);if(s)return s;let t=te.getInferredShape(e);return Cf.set(e,t),t};I([["Midpoint","geo-midpoint","$0.midpoint","segment"],["Perpendicular bisector","geo-perp-bisector","$0.perpendicularBisector","segment"],["Parallel line","geo-parallel","$0.parallel($1)","line","segment"],["Perpendicular line","geo-perpendicular","$0.perpendicular($1)","line","segment"],["Tangent line","geo-tangent","line($0.c,$1).perpendicular($1)","circle"],["Centroid","geo-centroid","$0.centroid","polygon","triangle"],["Circumcircle","geo-circumcircle","$0.circumcircle","triangle"],["Incircle","geo-incircle","$0.incircle","triangle"],["Angle bisector","geo-angle-bisector","$0.bisector","angle"]].map(([e,s,t,...i])=>({type:"button",tileTypes:["geo"],label:e,icon:s,show:n=>{var r;return i.includes(((r=Mf(n))==null?void 0:r.type)||"")},click:(n,r)=>{var l;let o=(l=Mf(n))==null?void 0:l.expr,a=t.replace(/\$0/g,o||"");if(a.includes("$1"))r.tools.geoPending.enable(a);else{let h=new te(a,r);r.selection.add(h,!0);let d=yt(h.path)?"pop":"draw",u=h.$el.enter(d,400);h.$shadow.enter(d,400),r.snapping.updateIntersections(),r.change({added:[h]}),u.promise.then(()=>h.$el.css("display",""))}}})));I([{type:"input",tileTypes:["geo"],label:"Label:",advanced:!0,get:e=>e.label,set:(e,s)=>s.setLabel(e)}]);var Ef=Math.PI/12;function yv(e){return as(e/Ef,.03)?new j(Math.round(e/Ef),12,"\u03C0").simplified.toString():nt(e,4)}function bv(e,s){return Oe(s)?e.replace(/\$l/g,nt(s.length/50,4)):oe(s)||ct(s)?e.replace(/\$[pc]/g,nt(s.circumference/50,4)).replace(/\$a/g,nt(s.area/2500,4)):ae(s)?e.replace(/\$r/g,yv(s.rad)).replace(/\$d/g,nt(s.deg,4)+"\xB0"):e}var $v=_e(()=>{for(let e of Os.values())Af(e)},0,!0);function Af(e){if(!e.label||!e.path)return;e.$label.text=bv(e.label,e.path);let[s,t]=xv(e);e.$label.css("transform",`translate(${s.x}px,${s.y}px) rotate(${t}rad)`)}function xv(e){let s,t=e.$label.width,i=12,n=new x(new p(-t/2-3,-i-3),t+6,i+6);for(let r of Pv(e.path,e,t,i)){s||(s=r);let o=n.rotate(r[1]).translate(r[0]);if(!Ve(Os.values(),a=>{if(!a.path||a.hidden||a===e)return!1;let l=yt(a.path)?new H(a.path,10):a.path;if(ft(l,o).length)return!0}))return r}return s||[$,0]}function*Pv(e,s,t,i){var n;if(yt(e)){let r=s.computed?8:10;yield[e.shift(r+t/2,-r),0],yield[e.shift(-r-t/2,-r),0],yield[e.shift(r+t/2,r+i),0],yield[e.shift(-r-t/2,r+i),0]}else if(Mt(e)){let r=e.perpendicularVector,o=e.angle;r.y>=0&&(r=r.scale(-1),o+=Math.PI);let a=Oe(e)?[.5,.3,.7]:[0,150,-150];for(let l of a)for(let h of[8,-8-i])yield[e.at(l).add(r.scale(h)),o]}else if(oe(e))for(let r of e.edges){let o=r.perpendicularVector.scale(8),a=r.angle;o.y>=0&&(o=o.scale(1+i/8),a+=Math.PI),yield[r.midpoint.add(o),a]}else if(ct(e))yield[e.at(7/8).shift(5+t/2,-5),0],yield[e.at(5/8).shift(-5-t/2,-5),0],yield[e.at(1/8).shift(5+t/2,5+i),0],yield[e.at(3/8).shift(-5-t/2,5+i),0];else if(ae(e)){let r=e.isRight?20*Math.sqrt(2):e.radius,o=((n=e.bisector)==null?void 0:n.unitVector.scale(r+6))||$,a=o.angle();yield[e.b.add(o).shift(t/2*Math.cos(a),i/2*(1+Math.sin(a))),0]}}var Vf=1,Sv=.05,Tv=5;function Cv([e,s],t,i){if(!i)return[Math.min(e,t),Math.max(s,t)];let n=s<e?s+1:s;if(P(n-e,1,.001))return[0,1];if(st(t<e?t+1:t,e,n))return[e,s];let r=Math.abs(e-t),o=Math.abs(s-t);return Math.min(r,1-r)<Math.min(o,1-o)?[t,s]:[e,t]}function Mv(e,s,t){if(P(s,0)&&P(t,1))return e;if(Mt(e))return new it(e.at(s),e.at(t));if(ne(e)){let i=e.angle*Math.abs(t-s);return new re(e.c,e.at(Math.min(s,t)),i)}else if(ct(e)){let i=(t-s+(t<s?1:0))*D;return new re(e.c,e.at(s),i)}else if(Pi(e)){let i=ws(e.edges.map(l=>l.length)),n=_(i),r=i.findIndex(l=>l/n>s)+1,o=i.findIndex(l=>l/n>t)+1,a=s<=t?e.points.slice(r,o):[...e.points.slice(r),...e.points.slice(0,o)];return new le(e.at(s),...a,e.at(t))}return e}function sc(e,s,t,i){let n=Vf,r=-1;for(let o=s+1;o<t;o++){let a=new wt(e[s],e[t]).distanceSquared(e[o]);a>n&&(r=o,n=a)}n>Vf&&(r-s>1&&sc(e,s,r,i),i.push(e[r]),t-r>1&&sc(e,r,t,i))}function Ev(e){if(e.length<=2)return e;let s=[e[0]];return sc(e,0,e.length-1,s),s.push(_(e)),s}function kf(e,s,t,i=!1){let n=s||e,r=t||e,o=Math.atan2(r.y-n.y,r.x-n.x)+(i?Math.PI:0),a=p.distance(n,r)*Sv;return e.shift(Math.cos(o)*a,Math.sin(o)*a)}function Av(e){return e.length<=2?jt(new le(...e)):e.map((s,t)=>{if(t===0)return`M${s.x.toFixed(2)} ${s.y.toFixed(2)}`;if(p.distance(e[t-1],s)<4)return`L${s.x.toFixed(2)},${s.y.toFixed(2)}`;let i=kf(e[t-1],e[t-2],s),n=kf(s,e[t-1],e[t+1],!0);return`C${i.x.toFixed(2)},${i.y.toFixed(2)} ${n.x.toFixed(2)},${n.y.toFixed(2)} ${s.x.toFixed(2)},${s.y.toFixed(2)}`}).join("")}var Re=class{constructor(s,t,i,n,r){this.$parent=s;this.brush=n;this.options="";this.$el=c("path",{class:`stroke ${n}`},s.$strokes),this.id=r||gs(10),this.setColor(i),t&&this.parse(t),s.strokes.set(this.id,this)}setColor(s){this.color=s,this.$el.setAttr("stroke",E(s))}parse(s){if(this.options=s,s.startsWith("M")){let t=js(s);this.path=new le(...t),this.$el.setAttr("d",s)}else this.path=Pt(s)(na),this.path&&(this.snap=!0),this.$el.setAttr("d",this.path?jt(this.path):"")}start(s,t){var i;if(this.brush==="ruler"&&(s=((i=this.$parent.snapping.snap([s]))==null?void 0:i.posn)||s),this.startPoint=s,this.path=new le(s,s.shift(.01)),t&&this.brush!=="ruler"){this.utensil=t;let n=t.offset(s);this.utensilRange=[n,n+.01]}this.$el.draw(this.path)}addPoint(s){if(this.brush==="ruler"){let t=this.$parent.snapping.snap([s]),i=(t==null?void 0:t.posn)||s.snap(this.startPoint,Tv);this.path=new it(this.startPoint,i),this.$el.draw(this.path)}else if(this.utensil){let t=S(this.utensil.offset(s),0,1),i=ct(this.utensil)||Pi(this.utensil);this.utensilRange=Cv(this.utensilRange,t,i),this.path=Mv(this.utensil,...this.utensilRange),this.$el.draw(this.path)}else this.path.points.push(s),this.$el.setAttr("d",this.$el.attr("d")+`L${s.x},${s.y}`)}end(){if(this.utensil||this.brush==="ruler")return this.snap=!0,this.options=this.path.toString().replace(/\.([0-9]{3})[0-9]+/g,(s,t)=>`.${t}`),this.$parent.snapping.addStroke(this);{let s=Ev(this.path.points);this.path=new le(...s),this.options=Av(s),this.$el.setAttr("d",this.options)}this.startPoint=this.utensil=this.utensilRange=void 0}get snapPoints(){if(!!this.snap){if(Oe(this.path))return[this.path.p1,this.path.p2];if(ne(this.path))return[this.path.start,this.path.end]}}hitTest(s,t){if(!this.path)return!1;let i=this.path.project(s);return(s.x-i.x)**2+(s.y-i.y)**2<t**2}delete(){this.$parent.strokes.delete(this.id),this.$el.remove()}serialize(s=1/0){return{points:this.options.slice(0,s),colour:this.color,brush:this.brush,id:this.id}}get lastSavedData(){return this.serialize()}static unSerialize(s,t){return new Re(t,s.points,s.colour||"#000",s.brush||"",s.id)}};var Of='<g class="leg-pin" style="transform-origin:bottom right"><polygon points="0,-21 -7,-21 0,0" fill="#3a3645"></polygon><path d="M-23.9-375H0v354h-7l-17-19v-335H-23.9z" fill="#d6d4db"></path></g><g class="pencil"><rect class="leg-pencil" x="0" y="-375" width="24" height="307" style="transform-box:fill-box;transform-origin:bottom center" fill="#d6d4db"></rect><g><path d="M72-48c-0.5,0-3,5-3,5H39c0,0-2.5-5-3-5v-106h36C72-154,72-48,72-48z"></path><rect x="47" y="-154" width="14" height="111" fill="#000" opacity="0.3"></rect><path d="M37.4-47.3l2.2,2.6c0.4,0.5,1,0.8,1.6,0.8c0.5,0,1-0.2,1.4-0.6l2.8-3.9c0.9-0.8,2.3-0.9,3.3-0.2l3.6,3.2c1,0.8,2.4,0.8,3.4,0l3.6-3.2c1-0.7,2.4-0.6,3.3,0.2l2.8,3.9c0.4,0.4,0.9,0.6,1.4,0.6c0.6,0,1.2-0.3,1.6-0.8l2.2-2.6c0.3-0.4,0.8-0.7,1.4-0.7L61.4-19.6c-4.8-1.9-10-1.9-14.8,0L36-48C36.6-48,37.1-47.7,37.4-47.3z" fill="#f7eecb"></path><path d="M46.6-19.6c4.8-1.9,10-1.9,14.8,0L54,0L46.6-19.6z"></path></g><path d="M81-56H15c-1.7,0-3-1.3-3-3v-18c0-1.7,1.3-3,3-3h66c1.7,0,3,1.3,3,3v18C84-57.3,82.7-56,81-56z" fill="#d6d4db"></path><circle cx="12" cy="-68" r="16" fill="#d6d4db"></circle><circle cx="12" cy="-68" r="9" fill="#3a3645"></circle></g><g class="top"><path d="M19-422H9v-25c0-2.8-2.2-5-5-5h-8c-2.8,0-5,2.2-5,5v25h-10c-2.8,0-5,2.2-5,5l0.1,42l9.2,19.2c0.4,1,1.4,4,4,4h21.7c2.7,0,3.7-3,4.1-4L24-375v-42C24-419.8,21.8-422,19-422z" fill="#3a3645"></path><circle cy="-386" r="9" fill="#d6d4db"></circle></g>';var Gt=50,Lf=100,Xi=class extends T{constructor(t,i,n){super(i,n);this.canRotate=!1;this.canDragToSelect=!1;this.$el.addClass("utensil"),this.options=t,this.width=+t.split(":")[0],this.absoluteEnd=new p(this.width,0),this.setup(),this.$handles=[0,1].map(r=>this.makeHandle("c",(o,a)=>{var d;let l=r?this.posn:this.absoluteEnd,h=(d=this.$parent.snapping.snap([a]))==null?void 0:d.shift;a=h?a.add(h):a.snap(l,10),p.distance(a,l)<Lf&&(a=new H(l,Lf).project(a)),r?this.absoluteEnd=a:this.posn=a,this.rot=It(this.absoluteEnd.angle(this.posn)),this.fixedSize||(this.width=this.absoluteEnd.subtract(this.posn).length),this.update(),this.transform()})),this.update(),this.setOrder("front")}flip(){super.flip(),this.update(),this.transform()}moveEnd(){this.absoluteEnd=new p(this.width,0).rotate(U(this.rot)).add(this.posn)}update(){this.options=""+this.width,this.$handles[1].setCenter({x:this.width,y:0})}getDrawingPath(t){var n;let i=(n=this.transformed)==null?void 0:n.project(t);if(i&&p.distance(t,i)<30)return this.transformed}},Vv=["ruler","protractor","set-triangle","compass"];function If(e){return Vv.includes(e.type)}var kv=2.54,ra=60,Ki=Gt*kv;function*Rf(e,s,t,i){let n=(s+.1)/e;for(let r=0;r<=n;r+=1){let o=i?i.findIndex(l=>!(r%l)):-1,a=r*e;yield[t?s-a:a,o]}}var la=class extends Xi{constructor(){super(...arguments);this.type="ruler";this.padding=[0,20,0,20]}setup(){let[t,i,n]=this.options.split(":");this.units=i||"cm",this.fixedSize=!!n,this.$glass=c("rect",{x:-20,height:ra,class:"glass",rx:5},this.$el),this.$ticks=c("path",{class:"ticks"},this.$el),this.$labelsTop=B(r=>c("text",{text:r},this.$el),31),this.$labelsBottom=B(r=>c("text",{text:r,y:42},this.$el),12)}setOptions(t=this.units,i=this.fixedSize){this.units=t,this.fixedSize=i,this.update(),this.transform()}update(){let t=this.units==="both";this.$glass.setAttr("width",this.width+40),this.path=new x($,this.width,ra);let i="";if(this.units!=="in")for(let[r,o]of Rf(Gt/10,this.width,this.flipped,[10,5]))i+=`M${r} 0v${([20,15][o]||10)*(t?.8:1)}`;if(this.units!=="cm"){let r=t?ra:0;for(let[o,a]of Rf(Ki/16,this.width,this.flipped,[16,8,4]))i+=`M${o} ${r}v${([20,16,12][a]||8)*(t?-.8:1)}`}this.$ticks.setAttr("d",i);let n=this.units==="in"?Ki:Gt;for(let[r,o]of this.$labelsTop.entries())o.toggle(r*n<=this.width+.1),o.setAttr("y",t?26:32),o.setAttr("x",this.flipped?this.width-n*r:n*r);for(let[r,o]of this.$labelsBottom.entries())o.toggle(t&&r*Ki<=this.width+.1),o.setAttr("x",this.flipped?this.width-Ki*r:Ki*r);super.update(),this.options=[this.width,this.units,this.fixedSize?"1":""].join(":")}getSnapPoints(){let t=this.units==="both",i=Ki/2,n=B(o=>new p(this.flipped?this.width-o*Gt:o*Gt,0),this.width/Gt),r=B(o=>new p(this.flipped?this.width-o*i:o*i,t?ra:0),this.width/i);return this.units==="cm"?n:t?[...n,...r]:r}getSnapLines(){let[t,i,n]=this.path.edges;return this.units==="both"?[t,n]:[t]}getDrawingPath(t){if(!this.transformed)return;let[i,n,r]=this.transformed.edges,o=p.distance(t,i.project(t)),a=p.distance(t,r.project(t));return o<30?i:this.units==="both"&&a<30?r:void 0}};function Ov(e){return`M0-${e}A${e},${e},0,0,0-${e},0V3a5,5,0,0,0,5,5H${e-5}a5,5,0,0,0,5-5V0A${e},${e},0,0,0,0-${e}Z`}var ha=class extends Xi{constructor(){super(...arguments);this.type="protractor";this.padding=[0,0,10,0]}setup(){this.$glass=c("path",{d:"",class:"glass"},this.$el),this.$ticks=c("path",{class:"ticks"},this.$el),this.$labels=B(t=>[c("text",{text:t*10},this.$el),c("text",{text:t*10,style:"font-size:9px"},this.$el)],19),this.$labels[9][0].css("font-size","20px"),this.$labels[9][1].hide()}update(){let t=this.width;this.path=new re($,new p(-this.width,0),Math.PI),this.$glass.setAttr("d",Ov(t));let i="",n=this.width<120?5:1;for(let r=0;r<=180;r+=n){let o=!(r%10),a=!o&&!(r%5),l=p.fromPolar(U(-r)),h=t-(o?30:a?23:15);i+=`M${l.x*t} ${l.y*t}L${l.x*h} ${l.y*h}`,o&&(i+=`M${l.x*8} ${l.y*8}L${l.x*(t-60)} ${l.y*(t-60)}`)}this.$ticks.setAttr("d",i);for(let[r,[o,a]]of this.$labels.entries()){if(r===9){o.setAttr("y",52-t);continue}o.toggle(t>160||!(r%3)),a.toggle(t>160),o.setAttr("y",44-t),a.setAttr("y",55-t),o.setAttr("transform",`rotate(${(this.flipped?-1:1)*(90-10*r)})`),a.setAttr("transform",`rotate(${(this.flipped?1:-1)*(90-10*r)})`)}super.update()}getSnapPoints(){return[$,this.path.start,this.path.at(.5),this.path.end]}getSnapLines(){return[]}},ic=234,ca=150;function Lv(e){let s=e<ca?e/(ca/(ic/6)):e<ic?ic/6:e/6,t=s+s*Math.SQRT2;return`M0,0 H${e} L0,${-e} V0 M${s},${-s} H${e-t} L${s},${-e+t} V${s},${-s}`}var da=class extends Xi{constructor(){super(...arguments);this.type="set-triangle"}setup(){this.$glass=c("path",{d:"","fill-rule":"evenodd",class:"glass"},this.$el),this.$ticks=c("path",{class:"ticks"},this.$el),this.$hLabels=B(t=>c("text",{text:t,y:-23},this.$el),31),this.$hLabels[0].hide(),this.$vLabels=B(t=>c("text",{text:t,x:25,"dominant-baseline":"central"},this.$el),31),this.$vLabels[0].hide()}update(){this.path=new M($,new p(this.width,0),new p(0,-this.width)),this.$glass.setAttr("d",Lv(this.width));let t=this.width-50,i="",n=2,r=1;for(let o=0;o<=t;o+=Gt/10){let a=o%Gt?o%(Gt/2)?0:r:n,l=o<10?-10*(o/10):[-10,-15,-20][a];i+=`M${o} 0V${l}`}for(let o=0;o<=t;o+=Gt/10){let a=o%Gt?o%(Gt/2)?0:r:n,l=o<10?10*(o/10):[10,15,20][a];i+=`M0,${-o} H${l}`}this.$ticks.setAttr("d",i);for(let[o,a]of this.$hLabels.entries())o>0&&a.toggle(this.width>=ca&&o<t/Gt),a.setAttr("x",Gt*o);for(let[o,a]of this.$vLabels.entries())o>0&&a.toggle(this.width>=ca&&o<t/Gt),a.setAttr("y",Gt*-o);super.update()}getSnapPoints(){let t=this.width,i=new it($,new p(this.width,0)),n=new it($,new p(0,-this.width)),r=B(a=>i.at(a*Gt/t),t/Gt),o=B(a=>n.at(a*Gt/t),t/Gt);return r.concat(o)}getSnapLines(){return[this.path]}},oa=375,aa=new p(54,68),pa=class extends Xi{constructor(){super(...arguments);this.type="compass"}setup(){this.$el.html=Of,this.$pencil=this.$el.$(".pencil"),this.$top=this.$el.$(".top"),this.$legPin=this.$el.$(".leg-pin"),this.$legPencil=this.$el.$(".leg-pencil"),this.setColour(m.red);let t,i=0;this.$parent.events.listen(this.$pencil.$("g"),{start:n=>{let r=new p(this.width,0).rotate(U(this.rot)).add(this.posn);t=new Re(this.$parent,"",this.colour,"pen"),t.start(r,new H(this.posn,this.width)),i=It(n.posn.angle(this.posn))-this.rot;for(let o of this.$handles)o.setAttr("hidden",!0)},move:n=>{this.rot=It(n.posn.angle(this.posn))-i,this.transform();let r=p.fromPolar(U(this.rot),this.width).add(this.posn);t.addPoint(r)},end:()=>{t.end(),this.$parent.change({added:[t],changed:[this]}),t=void 0;for(let n of this.$handles)n.removeAttr("hidden")}}),this.$parent.events.listen(this.$top,{start:n=>{i=It(n.posn.angle(this.posn))-this.rot;for(let r of this.$handles)r.setAttr("hidden",!0)},move:n=>{this.rot=It(n.posn.angle(this.posn))-i,this.transform()},end:()=>{this.$parent.change({changed:[this]});for(let n of this.$handles)n.removeAttr("hidden")}})}setColour(t){super.setColour(t),this.$pencil.css("fill",this.colour)}update(){this.width>730&&(this.width=730);let t=this.width-aa.x,i=oa-aa.y,n=new H($,oa),r=new H(new p(t,-aa.y),i),o=ft(n,r)[0],a=Math.acos(o.x/oa),l=Math.acos((t-o.x)/i);this.$legPin.css("transform",`rotate(${-a+dt}rad`),this.$legPencil.css("transform",`rotate(${l-dt}rad`),this.$pencil.setTransform({x:this.width-aa.x,y:0}),this.$top.setTransform({x:o.x,y:oa+o.y}),this.path=new it($,new p(this.width,0)),super.update()}getSnapPoints(){return[$,new p(this.width,0)]}getDrawingPath(){}};I([{type:"button",tileTypes:["ruler","protractor"],label:"Flip",click:(e,s)=>{for(let t of e)t.flip();s.change({changed:e})}}]);I([{type:"select",tileTypes:["ruler"],label:"Units:",options:[{label:"Centimeters",key:"cm"},{label:"Inches",key:"in"},{label:"Both",key:"both"}],advanced:!0,get:e=>e.units,set:(e,s)=>s.setOptions(e)},{type:"checkbox",tileTypes:["ruler"],label:"Fixed Length",advanced:!0,get:e=>!!e.fixedSize,set:(e,s)=>s.setOptions(void 0,e)}]);var ua=class extends W{constructor(t,i,n){super("square",i,n);this.type="rectangle";this.$handle=this.makeHandle("c",(a,l)=>{var h;return this.setVertex(this.relativePosn(((h=this.$parent.snapping.snap([l]))==null?void 0:h.posn)||l))}),this.$handle.css("cursor","move");let[r,o]=t.split(":").map(a=>+a||110);this.setVertex({x:r,y:o}),this.symmetric=!0}flip(t){let[i,n]=this.options.split(":");this.setVertex(new p(-+i,+n)),super.flip(t)}setVertex(t){this.path=new x($,t.x,t.y).polygon,this.$path.draw(this.path),this.$outline.draw(this.path),this.$handle.setCenter(t),this.options=`${t.x.toFixed(2)}:${t.y.toFixed(2)}`,this.transform(),this.$parent.selection.update()}static makeThumbnail(t,i){let n=c("svg",{width:80,height:80},i);c("rect",{class:"polygon-tile",x:10,y:20,width:60,height:40,fill:m.blue},n),c("circle",{cx:69,cy:59,r:4,fill:"white"},n)}};var fa=class extends W{constructor(t,i,n){super("reg-hexagon",i,n);this.type="reg-polygon";this.$handle=this.makeHandle("c",r=>{let o=S(Math.round(3+13*(r.length-30)/100),3,16);this.setSides(o)}),this.$handle.css("cursor","move"),this.setSides(+t||6),this.symmetric=!0}setSides(t){t!==+this.options&&(this.options=t.toString(),this.path=M.regular(t,50*Wt(t)),this.$path.draw(this.path),this.$outline.draw(this.path),this.$handle.setCenter(this.path.points[0]),this.snapAngles=Ht(this.path.edges.map(Bn)),this.transform(),this.$parent.selection.update())}static makeThumbnail(t,i){let n=M.regular(+t||6).scale(32).shift(40,40),r=c("svg",{width:80,height:80},i);c("path",{class:"polygon-tile",path:n,fill:m.red},r),c("circle",{cx:n.points[0].x,cy:n.points[0].y,r:4,fill:"white"},r)}};var Et=25,Yi=20,Nf={100:m.yellow,10:m.blue};function Un(e,s,t,i){let n=i.shift(e*t,0),r=n.shift(0,Math.floor(s/e)*t),o=i.shift(0,Math.ceil(s/e)*t),a=o.shift(s%e*t,0),l=a.shift(0,s%e?-t:0);return new M(i,n,r,l,a,o)}var Zn=class extends T{constructor(t,i,n){super(i,n);this.type="number-tile";this.options=t;let[r,o]=t.split(":").map(a=>+a);this.count=o,this.$label=c("g",{class:"outline card-label"},this.$el),this.$body=c("path",{class:"polygon-tile"},this.$el),this.$grid=c("path",{class:"polygon-tile"},this.$el),this.$outline=c("path",{class:"outline"},this.$el),o>1&&(this.$handle=this.makeHandle("h",a=>this.setWidth(Math.round(a.x/Et)))),this.setColour(Nf[o]||m.red),this.setWidth(r,!0)}setWidth(t,i=!1){var a;if(t=S(t,1,this.count),t===this.width)return;this.value=this.count,this.width=t,this.options=`${t}:${this.count}`,this.path=Un(t,this.count,Et,new p(-Et/2,-Et/2)),this.$body.draw(this.path),this.$outline.draw(this.path);let n=Math.ceil(this.count/t),r=t-(t*n-this.count),o="";for(let l=1;l<t;++l)o+=`M${(l-.5)*Et} ${-Et/2}v${(r<l?n-1:n)*Et}`;for(let l=1;l<n;++l)o+=`M${-Et/2} ${(l-.5)*Et}h${t*Et}`;this.$grid.setAttr("d",o),(a=this.$handle)==null||a.setTransform(new p((t-.5)*Et,-Et/2)),this.renderLabel(),this.transform(),i||this.$parent.selection.update()}select(){super.select(),b.isFirefox&&this.renderLabel()}setColour(t){super.setColour(t),this.$body.setAttr("fill",E(t))}renderLabel(){let t=this.count<5||this.labels==="hidden";if(this.padding=[0,25,t?0:Yi,0],this.$label.removeChildren(),t)return;let i=this.width,n=this.count%i,r=(this.count-n)/i;this.$label.setTransform(new p(-Et/2,Et*(Math.ceil(this.count/i)-.5)));let o=c("path",{},this.$label),a=c("text",{x:6,y:15,text:`${i} \xD7 ${r}`},this.$label);n&&c("tspan",{"fill-opacity":.6,dx:6,text:` + ${n}`},a);let l=5,h=a._el.getBBox().width+12;o.setAttr("d",`M0,0 H${h-l}Q${h},0 ${h},${l}V${Yi-l}Q${h},${Yi} ${h-l},${Yi}H${l}Q0,${Yi} 0,${Yi-l}H0Z`)}setLabels(t){super.setLabels(t),this.renderLabel(),this.transform()}static makeThumbnail(t,i){let[n,r]=t.split(":").map(f=>+f);n=Math.min(n,r);let o=Math.ceil(r/n),a=c("svg",{width:r===1?40:80,height:80},i),l=(r===1?20:40)-n/2*7,h=40-o/2*7,d=Nf[r]||m.red,u="";for(let f=1;f<n;++f)u+=`M${l+f*7} ${h}v${o*7}`;for(let f=1;f<o;++f)u+=`M${l} ${h+f*7}h${n*7}`;c("path",{class:"polygon-tile",path:Un(n,r,7,new p(l,h)),fill:d},a),c("path",{class:"polygon-tile",d:u},a)}getSnapPoints(){let t=new p(-Et/2,-Et/2),i=[t];for(let r=1;r<=this.width;++r)i.push(t.shift(r*Et,0));let n=Math.ceil(this.count/this.width);for(let r=1;r<=n;++r)i.push(t.shift(0,r*Et));for(let r=0;r<this.count;++r)i.push(t.shift((r%this.width+1)*Et,Math.floor(r/this.width+1)*Et));return i}split(){if(this.count===1)return[];this.delete();let t=Math.ceil(this.count/this.width);return t===1?B(i=>{let n=this.posn.shift(i*Et,0).rotate(U(this.rot),this.posn);return nc(1,1,this.$parent,n,this.rot,this.colour,this.hideHandles,this.labels)},this.count):B(i=>{let n=this.posn.shift(0,i*Et).rotate(U(this.rot),this.posn),r=i<t-1?this.width:this.count%this.width||this.width;return nc(r,r,this.$parent,n,this.rot,this.colour,this.hideHandles,this.labels)},t)}};I([{type:"button",tileTypes:["number-tile"],label:"Merge tiles",show:e=>e.length>1,click:(e,s)=>{let t=q(e.map(d=>d.count)),i=_(Ds(e,d=>d.count)),n=i.$parent,r=Math.min(...e.map(d=>d.posn.x)),o=Math.min(...e.map(d=>d.posn.y)),a=Math.max(...e.map(d=>Math.ceil((d.posn.x-r)/Et)+d.width)),l=e.every(d=>d.labels==="hidden")?"hidden":void 0,h=nc(t,a,n,new p(r,o),i.rot,i.colour,i.hideHandles,l);for(let d of e)d.delete();n.selection.add(h),s.change({added:[h],deleted:e})}},{type:"button",tileTypes:["number-tile"],label:"Split tiles",show:e=>e.some(s=>s.count>1),click:(e,s)=>{let t=[];for(let i of e)t.push(...i.split());s.selection.select(t),s.change({added:t,deleted:e})}}]);function nc(e,s,t,i,n,r,o,a){let l=new Zn(`${s}:${e}`,t);return l.setColour(r),l.setLabels(a),l.setTransform(i,n),l.setHandles(o),l}var Wn=[m.yellow,"#f15e19","#e1343b",m.red,"#8d2ca1","#4e53d0",m.blue,m.teal,m.green,m.lime],Gf=["#e6e2c6","#cc1030",m.green,m.red,"#ffd615",m.teal,"#181824","#9a2e13",m.blue,m.yellow],Df=25,ma=class extends W{constructor(t,i,n){super(rf(+t*Df,Df),i,n);this.type="number-bar";this.options=t,this.value=+t,this.$text=c("text",{text:t,class:"polygon-label",y:6},this.$el),this.setColour((i.options.altColors?Gf:Wn)[+t-1])}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}setLabels(t){super.setLabels(t),this.$text.toggle(t!=="hidden")}static makeThumbnail(t,i,n){let r=+t,o=new x(new p(1,1),r*20,20),a=c("svg",{width:r*20+2,height:22},i),l=c("path",{class:"polygon-tile",path:o},a);c("text",{html:t,class:"polygon-label",x:r*10+1,y:16},a),n.options.watch(h=>l.setAttr("fill",(h.altColors?Gf:Wn)[r-1]))}};I([{type:"checkbox",tileTypes:["number-bar","number-tile","prime-disk","number-grid","dot-machine","algebra-tile"],advanced:!0,label:"Show labels:",icon:"numbers",get:e=>!e.labels,set:(e,s)=>s.setLabels(e?void 0:"hidden")}]);var Qi=50,ga={1:m.grey,2:m.yellow,3:m.green,5:m.blue,7:m.purple},Rv="M0-xAx,x,0,0,0-x,0,x,x,0,0,0,0,x,x,x,0,0,0,x,0,x,x,0,0,0,0-xZM0,yAz,z,0,0,1-y,0,z,z,0,0,1,0-y,z,z,0,0,1,y,0,z,z,0,0,1,0,yZ";function _f(e,s,t=1){let i=e.y*s.x-e.x*s.y>0?t:1-t;return[e.x,e.y+"A"+e.length,e.length,0,i,t,s.x,s.y].join(",")}function Hf(e,s,t=Qi){if(s===1)return Rv.replace(/x/g,""+t).replace(/y/g,""+.4*t).replace(/z/g,""+(.4*t+.1));let i=D/s,n=-dt-i/2,r=p.fromPolar(n+i*e,t),o=p.fromPolar(n+i*(e+1),t);return`M${_f(r,o)}L${_f(o.scale(.4),r.scale(.4),0)}Z`}function Bf(e){return e===1?[1]:Be(e).reverse()}var Ji=class extends T{constructor(t,i,n){super(i,n);this.type="prime-disk";this.$segments=[];this.factors=[];this.path=new H($,Qi),c("circle",{class:"prime-background",r:Qi},this.$el),this.$segmentWrap=c("g",{},this.$el),this.$label=c("text",{class:"prime-label",y:5},this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el),this.setValue(+t)}setValue(t){t=this.value=S(Math.round(t),1,9999999),this.options=this.$label.text=""+t,this.factors=Bf(t);let i=this.factors.length;for(let n=0;n<i;++n){let r=this.getSegment(n);r.setAttr("fill",ga[this.factors[n]]||m.red),r.setAttr("d",Hf(n,i)),r.show()}for(let n=i;n<this.$segments.length;++n)this.$segments[n].hide()}setLabels(t){super.setLabels(t),this.$label.toggle(t!=="hidden")}multiply(t){this.setValue(+this.options*t)}getSegment(t){if(this.$segments[t])return this.$segments[t];let i=c("path",{class:"polygon-tile"},this.$segmentWrap);return this.$parent.events.listen(i,{down:()=>{this.$parent.selection.add(this,!this.$parent.events.shiftKey)},start:()=>{!this.isActive||(this.$parent.selection.add(this,!0),i.addClass("prime-move"),this.$container.append(i))},move:n=>{!this.isActive||(i.setTransform(this.posn.add(n.posn).subtract(n.startPosn)),this.setCollision(this.findNearby("prime-disk",Qi,n.posn)))},end:n=>{if(!this.isActive)return;i.removeClass("prime-move"),i.setTransform(),this.$segmentWrap.append(i);let r=n.lastPosn.subtract(n.startPosn);if(r.length>Qi){let o=[],a=[this];if(this.collision)this.collision.multiply(this.factors[t]),this.$parent.selection.add(this.collision,!0),a.push(this.collision),this.setCollision();else{let l=new Ji(`${this.factors[t]}`,this.$parent);l.setTransform(this.posn.add(r)),o.push(l),this.$parent.selection.add(l,!0)}this.setValue(+this.options/this.factors[t]),this.$parent.change({changed:a,added:o})}},checkIfActive:()=>this.factors.length>1}),this.$segments[t]=i,i}setColour(t){if(this.colour=t,t)for(let i of this.$segments)i.setAttr("fill",E(this.colour))}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findNearby("prime-disk",Qi))}collide(t){t.highlight(!1),t.multiply(+this.options),this.delete();let i=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:i})}static makeThumbnail(t,i){let n=c("svg",{width:54,height:54},i),r=c("g",{transform:"translate(27 27)"},n),o=a=>{r.removeChildren();let l=Bf(a);for(let h=0;h<l.length;++h){let d=ga[l[h]]||m.red,u=Hf(h,l.length,25);c("path",{fill:d,d:u,class:"polygon-tile"},r),c("text",{text:a,y:4,fill:"white",style:"font-size: 11px; text-anchor: middle"},r)}};i.onAttr("data-options",a=>o(Math.round(+a)))}};var Dt=25,va=class extends T{constructor(t,i,n){super(i,n);this.type="decimal-grid";this.padding=[0,25,25,0];this.$handles=[];this.$tiles=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),this.$handles[0]=this.makeHandle("h",l=>this.setDimensions(l.x/Dt,this.height,this.size)),this.$handles[1]=this.makeHandle("v",l=>this.setDimensions(this.width,l.y/Dt,this.size)),this.$handles[2]=this.makeHandle("c",l=>this.setDimensions(this.width,this.height,(l.x+l.y)/2/Dt)),this.$handles[1].css("cursor","ns-resize"),this.$handles[2].css("cursor","nwse-resize");let[r,o,a]=t.split(":");this.setDimensions(+r,+o,+a)}setDimensions(t,i,n){t=this.width=S(Math.round(t),1,100),i=this.height=S(Math.round(i),1,100),n=this.size=S(Math.round(n),2,Math.max(t,i));let r=[t,i,n].join(":");if(r===this.options)return;this.options=r,this.$tiles.removeChildren();let o=Math.floor(t/n)*n,a=Math.floor(i/n)*n,l=n*Dt;for(let h=0;h<o;h+=n)for(let d=0;d<a;d+=n)this.drawRect(h*Dt,d*Dt,l,l,m.yellow);for(let h=o;h<t;++h)for(let d=0;d<a;d+=n)this.drawRect(h*Dt,d*Dt,Dt,l,m.blue);for(let h=0;h<o;h+=n)for(let d=a;d<i;++d)this.drawRect(h*Dt,d*Dt,l,Dt,m.blue);for(let h=o;h<t;++h)for(let d=a;d<i;++d)this.drawRect(h*Dt,d*Dt,Dt,Dt,m.red);this.$handles[0].setTransform({x:t*Dt,y:0}),this.$handles[1].setTransform({x:0,y:i*Dt}),this.$handles[2].setTransform({x:l,y:l}),this.path=new x($,t*Dt,i*Dt),this.$outline.draw(this.path),this.transform(),this.$parent.selection.update()}drawRect(t,i,n,r,o){c("rect",{x:t,y:i,width:n,height:r,fill:this.colour||o,class:"polygon-tile"},this.$tiles)}setColour(t){this.colour=t;for(let i of this.$tiles.children)i.setAttr("fill",E(t))}static makeThumbnail(t,i){let n=c("svg",{width:140,height:80},i),r=(o,a,l,h,d)=>c("rect",{x:5+o,y:5+a,width:l,height:h,fill:d,class:"polygon-tile"},n);for(let o=0;o<2;++o)r(50*o,0,50,50,m.yellow);for(let o=0;o<3;++o)r(100+10*o,0,10,50,m.blue);for(let o=0;o<2;++o)for(let a=0;a<2;++a)r(50*o,50+a*10,50,10,m.blue);for(let o=0;o<3;++o)for(let a=0;a<2;++a)r(100+o*10,50+a*10,10,10,m.red)}};var wa=class extends T{constructor(t,i,n){super(i,n);this.type="dot-machine";this.canRotate=!1;this.canDragToSelect=!1;this.cells=[];this.isAnimating=!1;let[r,o]=t.split(":").map(a=>+a);this.model=mt({base:r,boxes:o}),this.$outline=c("rect",{class:"outline",rx:12},this.$el),this.model.watch(()=>this.draw(this.model)),this.setColour(m.purple),this.setOrder("back"),this.onMove=()=>{let a=Array.from(i.selection.tiles).filter(l=>l.type==="dot");for(let l of this.cells)l.hover(a.some(h=>l.contains(h.posn)))},this.onMoveEnd=()=>{for(let a of this.cells)a.hover(!1)},i.on("move-selection",this.onMove),i.on("move-end",this.onMoveEnd),this.onChange=()=>this.rearrangeDots(),setTimeout(()=>{this.rearrangeDots(),i.on("change",this.onChange)})}setLabels(t){super.setLabels(t),this.$el.setClass("no-labels",t==="hidden")}delete(){this.$parent.off("move-selection",this.onMove),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}select(){super.select();for(let t of this.cells)t.hover()}deselect(){super.deselect();for(let t of this.cells)t.hover(!1)}draw(t){let i=Math.round(t.base),n=Math.round(t.boxes);if(this.options=`${i}:${n}`,this.cells.length>n){for(let o=n;o<this.cells.length;++o)this.cells[o].delete();this.cells=this.cells.slice(0,n)}else if(this.cells.length<n)for(let o=this.cells.length;o<n;++o){let a=new rc(this,o,this.$parent);this.cells.push(a),a.setColour(this.colour)}for(let o of this.cells)o.setBase(i);let r=150*(n-1)+10;this.path=new x(new p(-r,-10),r+160,170),this.$outline.setRect(this.path),this.transform(),this.$parent.selection.update()}getSnapPoints(){return[]}setColour(t){super.setColour(t.slice(0,7));for(let i of this.cells)i.setColour(this.colour)}moveEnd(){super.moveEnd();for(let t of this.cells)for(let i of[...t.dots,...t.antiDots])i.cell=void 0}rearrangeDots(){if(!this.isAnimating){for(let t of this.cells)t.clear();for(let t of this.$parent.getTilesOfType("dot"))if(!t.deleted)for(let i of this.cells)(t.cell===i||!t.cell&&i.contains(t.posn))&&i.addDot(t);for(let t of this.cells)t.rearrange()}}static makeThumbnail(t,i){let n=c("svg",{width:160,height:60},i);for(let r of[105,55,5])c("rect",{x:r,y:5,width:50,height:50,class:"dot-cell",stroke:"#eee",style:"stroke-width: 6px"},n),c("circle",{cx:r+25,cy:5,r:2},n),c("circle",{cx:r+25,cy:55,r:2},n)}};I([{type:"input",tileTypes:["dot-machine"],label:"Base:",value:"number",range:[2,25],get:e=>e.model.base,set:(e,s)=>s.model.base=+e},{type:"input",tileTypes:["dot-machine"],label:"Boxes:",value:"number",range:[1,10],get:e=>e.model.boxes,set:(e,s)=>s.model.boxes=+e},{type:"button",tileTypes:["dot-machine"],label:"Explode",show:e=>e.some(s=>s.cells.some(t=>t.dots.length||t.antiDots.length)),click:(e,s)=>{let t=e.filter(i=>!i.isAnimating);for(let i of t)i.cells[0].explode();s.change({changed:t})}},{type:"button",tileTypes:["dot-machine"],label:"Annihilate",show:e=>e.some(s=>s.cells.some(t=>t.dots.length&&t.antiDots.length)),click:(e,s)=>{let t=e.filter(i=>!i.isAnimating);for(let i of t)i.cells[0].annihilate();s.change({changed:t})}}]);var rc=class{constructor(s,t=0,i){this.machine=s;this.index=t;this.$doc=i;this.dots=[];this.antiDots=[];let n=-150*t;this.$el=c("rect",{class:"dot-cell",width:150,height:150,x:n}),this.$label=c("text",{class:"dot-label",x:75+n,y:154,"font-size":"12px"},s.$el),this.$value=c("text",{class:"dot-label",x:75+n,y:6,text:0,"font-size":"18px"},s.$el),this.bounds=new x(new p(n,0),150,150),s.$el.prepend(this.$el)}setBase(s){this.$label.text=nt(Math.pow(s,this.index))}delete(){this.$el.remove(),this.$label.remove(),this.$value.remove()}setColour(s){this.$el.setAttr("stroke",s),this.machine.isActive&&this.$el.css("fill",s)}hover(s=!0){this.machine.isActive&&!s||this.$el.css("fill",s?this.machine.colour:"none")}contains(s){return this.bounds.translate(this.machine.posn).contains(s)}clear(){this.dots=[],this.antiDots=[]}addDot(s){(s.options==="1"?this.dots:this.antiDots).push(s),s.cell=this}rearrange(){this.$value.text=nt(this.dots.length-this.antiDots.length);let s=[...this.dots,...this.antiDots];if(!s.length)return;let t=Math.ceil(Math.sqrt(s.length)),i=Math.ceil(s.length/t),n=s.length<=16?30:s.length<=25?25:20,r=this.bounds.center.add(this.machine.posn).shift(-n*(t-1)/2,-n*(i-1)/2),o=B(a=>r.shift(a%t*n,Math.floor(a/t)*n),s.length);return this.animatePoints(s,o)}animatePoints(s,t){let i=s.map(n=>n.posn);for(let[n,r]of s.entries())r.setTransform(t[n]);return K(n=>{var r;for(let[o,a]of s.entries()){let l=p.interpolate(i[o],t[o],ot("quad",n));a.$el.setTransform(l),a.transformed=(r=a.path)==null?void 0:r.translate(l)}this.machine.$parent.selection.update()},240).promise}getDotsToExplode(){let s=this.machine.model.base;if(this.dots.length>=s)return this.dots.splice(0,s);if(this.antiDots.length>=s)return this.antiDots.splice(0,s)}explode(){return R(this,null,function*(){let s=this.machine.cells[this.index+1];if(!s){this.machine.isAnimating=!1,this.machine.$parent.change({changed:this.dots});return}this.machine.isAnimating=!0;let t=this.getDotsToExplode();if(!t)return s.explode();this.$doc.playSound("rise"),s.addDot(t[0]);for(let i of t.slice(1))i.popOut();return s.rearrange(),yield ns(400),this.rearrange(),yield ns(400),this.explode()})}annihilate(){return R(this,null,function*(){this.machine.isAnimating=!0;let s=Math.min(this.dots.length,this.antiDots.length);if(s){let i=this.dots.splice(0,s),n=this.antiDots.splice(0,s);for(let r of[...i,...n])r.popOut();this.$doc.playSound("woosh"),this.rearrange(),yield ns(600)}let t=this.machine.cells[this.index+1];if(t)return t.annihilate();this.machine.isAnimating=!1,this.machine.$parent.change({changed:this.dots})})}};var ya=25/2,tn=class extends T{constructor(t,i,n){super(i,n);this.type="dot";this.deleted=!1;this.options=t,this.$path=c("circle",{r:ya,class:"polygon-tile"},this.$el),this.$outline=c("circle",{r:ya,class:"outline"},this.$el),this.path=new H($,ya),this.setColour(m.blue)}setColour(t){this.colour=t,this.$path.setAttr("fill",this.options==="-1"?m.red:this.colour)}getSnapPoints(){return[]}getCell(){for(let t of this.$parent.getTilesOfType("dot-machine"))if(!t.isActive){for(let i of t.cells)if(i.contains(this.posn))return i}}moveEnd(){let t=this.cell,i=this.cell=this.getCell();if(!t||!i||t===i||t.machine!==i.machine)return;let n=Math.abs(t.index-i.index),r=t.machine.model.base**n;if(t.index<i.index){let o=this.options==="1"?t.dots:t.antiDots;if(o.length<r)return this.cell=t;for(let a of o.filter(l=>!l.isActive).slice(0,r-1))a.popOut()}else for(let o=0;o<r-1;++o){let a=new tn(this.options,this.$parent);a.posn=this.posn,a.cell=i}}static makeThumbnail(t,i){let n=t==="1"?m.blue:m.red,r=c("svg",{width:40,height:40},i);c("circle",{class:"polygon-tile",cx:20,cy:20,r:ya,fill:n},r)}negate(){this.options=this.options==="-1"?"1":"-1",this.setColour(m.blue)}popOut(){return R(this,null,function*(){this.deleted=!0,yield this.$path.exit("pop").promise,this.delete()})}};function qf(e){return e===0?m.grey:e>0?m.blue:m.red}function zf(e){return+e.replace("\u2013","-")}function Ff(e,s,t=0){s=S(Math.round(s),-9999,9999);let i=e.text=nt(s),n=S(40/i.length*2,16,32);return e.css("font-size",n+"px"),e.setAttr("y",.3*n+26+t),s}var ba=class extends T{constructor(t,i,n){super(i,n);this.type="number-card";this.path=new x($,50),this.$path=c("rect",{class:"polygon-tile",rx:6,width:50,height:50},this.$el),this.$label=c("text",{x:25,fill:"white",style:"text-anchor: middle"},this.$el),this.$outline=c("rect",{class:"outline",rx:6,width:50,height:50},this.$el),this.setValue(zf(t))}setValue(t){this.value=Ff(this.$label,t),this.options=""+this.value,this.setColour()}setColour(t){super.setColour(t||qf(this.value)),this.$path.setAttr("fill",E(this.colour))}highlight(t=!0){this.$el.setClass("active",t)}move(t){if(super.move(t),!this.$parent.options.mergeTiles||this.$parent.selection.tiles.size>1)return;let i=this.findNearby("number-card",35);this.setCollision(i&&st(i.value+this.value,-9999,9999)?i:void 0)}collide(t){t.highlight(!1),t.setValue(t.value+this.value),this.$parent.playSound("click"),this.delete();let i=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:i})}negate(){this.setValue(-this.value)}static makeThumbnail(t,i){let n=c("svg",{width:60,height:60},i),r=c("rect",{x:5,y:5,width:50,height:50,class:"polygon-tile",rx:6},n),o=c("text",{fill:"white",x:30,style:"text-anchor: middle"},n);i.onAttr("data-options",a=>{let l=Ff(o,zf(a),5);r.setAttr("fill",qf(l))})}};var Nt=50,hi=14,Iv=`M-${Nt/2} -4.5h${Nt*hi}v-33h9v75h-9v-33h-${Nt*hi}v33h-9v-75h9Z`,$a=class extends T{constructor(t,i,n){super(i,n);this.type="abacus";this.options=t,this.path=new x(new p(-Nt/2-9,-Nt/2-12.5),hi*Nt+18,Nt+25),c("path",{path:this.path,fill:"transparent"},this.$el),c("path",{d:Iv,class:"polygon-tile",fill:"#7e7c86"},this.$el),c("path",{path:this.path,class:"outline"},this.$el),this.positions=t.split(",").map(r=>+r),this.$beads=this.positions.map(r=>c("circle",{cx:r*Nt,r:Nt/2,class:"polygon-tile"},this.$el)),this.$gradients=this.positions.map(r=>c("circle",{cx:r*Nt,r:Nt/2,class:"bead-gradient"},this.$el)),this.count=this.$beads.length;for(let[r,o]of this.$beads.entries())this.setupBead(o,r);this.setColour(m.orange)}setupBead(t,i){let n=0;this.$parent.events.listen(t,{click:()=>{this.locked||this.$parent.selection.add(this,!this.$parent.events.shiftKey)},start:r=>{n=this.positions[i]-this.relativePosn(r.posn).x/Nt},move:r=>{let o=this.positions[i]=S(n+this.relativePosn(r.posn).x/Nt,i,hi-(this.count-i)),a=o;for(let h=i+1;h<this.count;++h)this.positions[h]<a+1&&(this.positions[h]=a+1),a=this.positions[h];let l=o;for(let h=i-1;h>=0;--h)this.positions[h]>l-1&&(this.positions[h]=l-1),l=this.positions[h];for(let[h,d]of this.$beads.entries())d.setAttr("cx",this.positions[h]*Nt),this.$gradients[h].setAttr("cx",this.positions[h]*Nt)},end:()=>{let r=this.options;this.options=this.positions.join(","),r!==this.options&&this.$parent.change({changed:[this]})}})}setColour(t){super.setColour(t.slice(0,7));let i=this.$beads.length/2,n=F.mix("#fff",this.colour,.8);for(let[r,o]of this.$beads.entries())o.setAttr("fill",r<i?this.colour:n)}getSnapPoints(){return[new p(-Nt/2,-25),new p((hi-.5)*Nt,-25),new p(-Nt/2,25),new p((hi-.5)*Nt,25),new p(-Nt/2,50),new p((hi-.5)*Nt,50)]}static makeThumbnail(t,i){let n=c("svg",{width:240,height:40},i);c("line",{x1:5,y1:18,x2:235,y2:20,stroke:"white","stroke-width":"3px"},n),c("line",{x1:4,y1:3,x2:4,y2:37,stroke:"white","stroke-width":"3px"},n),c("line",{x1:236,y1:3,x2:236,y2:37,stroke:"white","stroke-width":"3px"},n);for(let r=0;r<10;++r){let o=r<5?m.orange:F.mix("#fff",m.orange,.7),a={cx:16+20*r,cy:20,r:10,style:"stroke-width: 0.5px"};c("circle",Rt(et({},a),{class:"polygon-tile",fill:o}),n),c("circle",Rt(et({},a),{class:"bead-gradient"}),n)}}};var Nv={1:m.yellow,x:m.green,x2:m.blue,y:m.teal,y2:"#8d2ca1",xy:"#4e53d0"},Kn=25,jf=5.4,Uf=4.7,Gv="#ddd";function xa(e){return e.replace("-","\u2013").replace("2","\xB2")}function oc(e){return e[0]==="-"?m.red:Nv[e]}function ac(e,s,t,i){return e.endsWith("x2")?[t,t]:e.endsWith("y2")?[i,i]:e.endsWith("xy")?[t,i]:e.endsWith("x")?[s,t]:e.endsWith("y")?[s,i]:[s,s]}var en=class extends W{constructor(t,i,n){super("square",i,n);this.type="algebra-tile";this.options=t.toLowerCase(),this.$text=c("text",{text:xa(this.options),class:"polygon-label",y:6},this.$el),this.setColour(oc(this.options)),this.updateSize()}updateSize(){let t=this.$parent.options.algebraXSize*Kn,i=this.$parent.options.algebraYSize*Kn,[n,r]=ac(this.options,Kn,t,i);this.setShape(new x(new p(-n/2,-r/2),n,r).polygon)}setLabels(t){super.setLabels(t),this.$text.toggle(t!=="hidden")}setColour(t=this.colour){super.setColour(t),this.$path.setAttr("fill",E(this.collision?Gv:this.colour)),this.$text.text=this.collision?"0":xa(this.options)}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}getSize(t){let i=!!(this.rot%180);return ac(this.options,"1","x","y")[t===(i?"y":"x")?0:1]}getEdge(t){let i=Ct(t-Math.round(this.rot/90),4);return this.transformed.edges[i]}setCollision(t){this.collision=t,this.setColour()}move(t){if(super.move(t),this.collision){if(p.distance(this.posn,this.collision.posn)<.95*Kn)return;this.collision.setCollision(),this.setCollision()}let i=this.options[0]==="-"?this.options.slice(1):"-"+this.options;for(let n of this.$parent.getTilesOfType("algebra-tile"))if(!(n.collision||n===this||n.options!==i)&&!(p.distance(this.posn,n.posn)>=.95*Kn)){this.setCollision(n),n.setCollision(this);return}}static makeThumbnail(t,i){let[n,r]=ac(t,20,78,64),o=t[0]==="-"?t.slice(1):t,a=o==="y2"?112:["x2","xy"].includes(o)?28:2,l=o==="1"?2:["x","x2"].includes(o)?28:112;i.hasAttr("data-rot")&&([a,l,n,r]=[l,a,r,n]),i.setRect(new x(new p(a,l),n,r)),i.setAttr("fill",oc(t)),i.insertAfter(c("text",{text:xa(t),class:"polygon-label",x:a+n/2,y:l+r/2+5}))}negate(){this.options.startsWith("-")?this.options=this.options.slice(1):this.options="-"+this.options,this.setColour(oc(this.options)),this.$text.text=xa(this.options)}};I([{type:"button",tileTypes:["algebra-tile","dot","number-card"],label:"Negate",click:(e,s)=>{for(let t of e)t.negate();s.change({changed:e})}}]);var Zf="M-125,0l35,252c0,11,40.3,20,90,20s90-9,90-20L125,0Z",Wf=B(e=>new p(e<5?-45:45,65+40*(e%5)),10),Pa=class extends T{constructor(t,i,n){super(i,n);this.type="bucket";this.canRotate=!1;this.canDragToSelect=!1;this.isAnimating=!1;this.tiles=zt(void 0,20);c("path",{class:"polygon-tile bucket",d:Zf,fill:"#ccc"},this.$el),c("ellipse",{class:"polygon-tile bucket",rx:125,ry:28,fill:"#888"},this.$el),this.$text=c("text",{text:0,class:"bucket-label",y:12},this.$el),this.setColour(m.grey),this.path=new M(new p(-125,0),new p(0,-28),new p(125,0),new p(90,252),new p(0,272),new p(-90,252)),this.setOrder("back"),this.onMoveEnd=()=>this.recompute(),i.on("change",this.onMoveEnd)}delete(){this.$parent.off("change",this.onMoveEnd),super.delete()}getSnapPoints(){return[]}recompute(){return R(this,null,function*(){var i;if(this.isAnimating)return;let t=[];for(let[n,r]of this.tiles.entries())r&&!Ve(this.$parent.tiles.values(),o=>o===r)&&(this.tiles[n]=void 0);for(let n of this.$parent.getTilesOfType("algebra-tile")){if(!n.options.endsWith("1"))continue;let r=n.options!=="1",o=(i=this.transformed)==null?void 0:i.contains(n.posn),a=this.tiles.indexOf(n);if(a>=0&&!o&&(this.tiles[a]=void 0),!o)continue;if((r?a>=0&&a<10:a>=10)&&(this.tiles[a]=void 0,a=-1),a<0&&(a=this.tiles.findIndex((h,d)=>!h&&(r?d>=10:d<10))),a<0)return;this.tiles[a]=n;let l=Wf[a%10].shift(r?15:-15,0).add(this.posn);l.equals(n.posn)||t.push({tile:n,from:n.posn,to:l})}if(this.$text.text=nt(q(this.tiles.map((n,r)=>n?r<10?1:-1:0))),t.length){this.isAnimating=!0,yield K(n=>{var o;let r=ot("quad",n);for(let{tile:a,from:l,to:h}of t){let d=p.interpolate(l,h,r);a.posn=d,a.$el.setTransform(d,U(a.rot)),a.transformed=(o=a.path)==null?void 0:o.translate(d)}this.$parent.selection.update()},240).promise;for(let n of t)n.tile.transform(),n.tile.move();this.isAnimating=!1}})}fill(){if(this.isAnimating)return[];let t=[];for(let[i,n]of this.tiles.entries()){if(n)continue;let r=new en(i<10?"1":"-1",this.$parent);r.setTransform(Wf[i%10].shift(i<10?-15:15,0).add(this.posn)),this.tiles[i]=r,t.push(r)}return this.$text.text="0",t}static makeThumbnail(t,i){let n=c("svg",{width:120,height:140,viewBox:"-140 -40 280 320"},i);c("path",{class:"polygon-tile bucket",d:Zf,fill:"#ccc",style:"stroke-width: 2px"},n),c("ellipse",{class:"polygon-tile bucket",rx:125,ry:28,fill:"#888",style:"stroke-width: 2px"},n)}};I([{type:"button",tileTypes:["bucket"],label:"Fill bucket",click:(e,s)=>{let t=[];for(let i of e)t.push(...i.fill());t.length&&s.change({added:t})}}]);var Ee=50,Kf=ue((e,s,t,i,n)=>e==="number"?1+i+n*s:e==="addition"?!i&&!n?"+":!i||!n?i||n:i+n:!i&&!n?"\xD7":!i||!n?i||n:i*n),Dv=ue(e=>F.from(e).brightness<140),_v=ue(e=>F.mix(e,"#000",.7).hex);function Hv(e){return e?new Map(e.split(",").map(s=>s.split("-"))):new Map}function Bv(e){return Array.from(e.entries()).map(s=>s.join("-")).join(",")}var Sa=class extends T{constructor(t,i,n){super(i,n);this.type="number-grid";this.cells=[];this.$handles=[];this.rows=3;this.cols=2;this.selected=new Set;this.padding=[0,25,25,0];this.canRotate=!1;this.$cells=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),i.events.listen(this.$el,{down:h=>this.selectCell(h.posn),move:h=>this.selectCell(h.posn,!0),checkIfActive:()=>!!this.isFocussed}),this.$handles[0]=this.makeHandle("h",h=>this.resize(h.x/Ee,this.rows)),this.$handles[1]=this.makeHandle("v",h=>this.resize(this.cols,h.y/Ee)),this.$handles[1].css("cursor","ns-resize");let[r,o,a,l]=t.split(":");this.gridType=r,this.colour="#ccc",this.colorsStr=l||"",this.colors=Hv(this.colorsStr),this.resize(+o,+a)}resize(t,i){this.cols=S(Math.round(t),2,20),this.rows=S(Math.round(i),2,20);let n=`${this.gridType}:${this.cols}:${this.rows}:${this.colorsStr}`;if(n===this.options)return;this.options=n;let r=this.cols*this.rows;for(let o=this.cells.length;o<r;++o)this.cells.push(this.makeCell());for(let o=r;o<this.cells.length;++o)this.cells[o][0].hide();this.updateCells(),this.path=new x($,this.cols*Ee,this.rows*Ee),this.$outline.draw(this.path),this.$handles[0].setTransform({x:this.path.w,y:0}),this.$handles[1].setTransform({x:0,y:this.path.h}),this.transform(),this.$parent.selection.update()}makeCell(){let t=c("g",{class:"number-grid-cell"},this.$cells),i=c("circle",{r:23,cx:Ee/2,cy:Ee/2},t);return[t,i,c("text",{x:Ee/2,y:Ee/2+8},t)]}updateCells(){for(let t=0;t<this.cols;++t)for(let i=0;i<this.rows;++i){let[n,r,o]=this.cells[t+i*this.cols];n.show(),n.translate(t*Ee,this.flipped?(this.rows-1-i)*Ee:i*Ee),o.text=""+this.getCellValue(t,i)}this.updateColors()}updateColors(){let t=this.gridType==="number",i=E(this.colour),n=_v(i);for(let r=0;r<this.cols;++r)for(let o=0;o<this.rows;++o){let a=r+o*this.cols,l=!t&&(!r||!o),h=this.colors.get(t?`${a}`:`${o}/${r}`)||(l?n:i);this.cells[a][1].setAttr("fill",h),this.cells[a][2].setAttr("fill",Dv(h)?"#fff":"#000")}}setLabels(t){super.setLabels(t),this.$el.setClass("no-labels",t==="hidden")}setColour(t,i){if(this.isFocussed&&i==="picker"){let n=this.gridType==="number",r=E(t);for(let o of this.selected)this.colors.set(n?`${o}`:`${Math.floor(o/this.cols)}/${o%this.cols}`,r);return this.colorsStr=Bv(this.colors),this.options=`${this.gridType}:${this.cols}:${this.rows}:${this.colorsStr}`,this.$parent.change({changed:[this]}),this.updateColors()}i==="picker"&&(this.colors.clear(),this.colorsStr="",this.options=`${this.gridType}:${this.cols}:${this.rows}`),super.setColour(t),this.updateColors()}doubleClick(t){this.focus(),this.selectCell(t.posn)}selectCell(t,i=!1){if(t=this.relativePosn(t).scale(1/Ee).floor(),t.x<0||t.x>=this.cols||t.y<0||t.y>=this.rows)return;let n=t.x+(this.flipped?this.rows-1-t.y:t.y)*this.cols;if(i)this.selected.has(n)||this.addToSelection(n);else if(this.$parent.events.shiftKey)this.selected.has(n)?this.removeFromSelection(n):this.addToSelection(n);else{for(let r of this.selected)this.removeFromSelection(r);this.addToSelection(n)}}addToSelection(t){this.cells[t][0].addClass("active"),this.selected.add(t)}removeFromSelection(t){this.cells[t][0].removeClass("active"),this.selected.delete(t)}getCellValue(t,i){return Kf(this.gridType,this.cols,this.rows,t,i)}blur(){if(!!this.isFocussed){for(let t of this.selected)this.removeFromSelection(t);super.blur()}}flip(){super.flip(),this.updateCells()}selectMultiples(){let t=Array.from(this.selected).map(n=>+this.getCellValue(n%this.cols,Math.floor(n/this.cols))),i=t.length>1?Hs(...t):t[0];for(let n of this.selected)this.removeFromSelection(n);for(let n=0;n<this.cols;++n)for(let r=0;r<this.rows;++r)+this.getCellValue(n,r)%i===0&&this.addToSelection(n+r*this.cols)}static makeThumbnail(t,i){let n=t.split(":")[0],r=n==="number"?5:4,o=c("svg",{width:10+25*r,height:10+25*r,"text-anchor":"middle","font-size":"14"},i),a=(l,h,d,u)=>{c("circle",{cx:l+17.5,cy:h+17.5,r:12,fill:d},o),c("text",{x:l+17.5,y:h+22,text:u,fill:"white"},o)};for(let l=0;l<r;++l)for(let h=0;h<r;++h){let d=n==="number"||l&&h?"#ffffff44":"#ffffff88";a(25*l,25*h,d,Kf(n,r,r,l,h))}}};I([{type:"button",tileTypes:["number-grid"],label:"Switch direction",click:(e,s)=>{for(let t of e)t.flip();s.change({changed:e})}},{type:"button",tileTypes:["number-grid"],focus:"show",label:"Select all multiples",click:e=>{e[0].selectMultiples()}}]);var Yf=25;function qv(e){let s=+e,t=Math.ceil(s/2);return gt(Un(t,s,Yf,$).points)}function Xf(e,s,t,i=0,n=0){let r=Math.ceil(e/2);for(let o=0;o<e;++o){let a=(o%r+.5)*s+i,l=(.5+(o<r?0:1))*s+n;c("circle",{fill:"white",cx:a,cy:l,r:s*.2},t)}}var Ta=class extends W{constructor(t,i,n){super(qv(t),i,n);this.type="number-frame";this.options=t,this.value=+t,this.setColour(Wn[this.value-1]),Xf(this.value,Yf,this.$el)}static makeThumbnail(t,i){let n=+t,r=Math.ceil(n/2),o=Un(r,n,20,new p(5,5)),a=c("svg",{width:r*20+10,height:50},i);c("path",{path:o,fill:Wn[n-1],class:"polygon-tile"},a),Xf(n,20,a,5,5)}};var be=50,Ca=class extends T{constructor(t,i,n){super(i,n);this.type="ten-frame";this.canRotate=!1;this.canDragToSelect=!1;this.padding=[0,25,25,0];this.$handles=[];this.rows=2;this.cols=5;this.$border=c("rect",{"stroke-width":4,fill:"transparent"},this.$el),this.$minorGuides=c("path",{"stroke-width":3},this.$el),this.$majorGuides=c("path",{"stroke-width":2,opacity:.4},this.$el),this.$outline=c("rect",{class:"outline"},this.$el),this.$handles[0]=this.makeHandle("h",a=>this.resize(a.x/be,this.rows)),this.$handles[1]=this.makeHandle("v",a=>this.resize(this.cols,a.y/be)),this.$handles[1].css("cursor","ns-resize");let[r,o]=t.split(":");this.resize(+r,+o),this.setColour("#000000"),this.setOrder("back")}resize(t,i){this.cols=S(Math.round(t),1,25),this.rows=S(Math.round(i),1,20);let n=`${this.cols}:${this.rows}`;if(n===this.options)return;this.options=n,this.path=new x($,this.cols*be,this.rows*be),this.$outline.setRect(this.path),this.$border.setRect(this.path);let r=["",""];for(let o=1;o<this.rows;++o)r[o%2?1:0]+=`M0,${be*o}h${be*this.cols}`;for(let o=1;o<this.cols;++o)r[o%5?1:0]+=`M${be*o},0v${be*this.rows}`;this.$minorGuides.setAttr("d",r[0]),this.$majorGuides.setAttr("d",r[1]),this.$handles[0].setTransform({x:this.path.w,y:0}),this.$handles[1].setTransform({x:0,y:this.path.h}),this.transform(),this.$parent.selection.update()}*counters(){for(let t of this.$parent.getTilesOfType("ten-frame-counter"))this.transformed.contains(t.posn)&&(yield t)}moveStart(t=!1){if(super.moveStart(),!t)for(let i of this.counters())this.$parent.selection.add(i)}setColour(t){super.setColour(t);let i=E(t);for(let n of[this.$border,this.$minorGuides,this.$majorGuides])n.setAttr("stroke",i)}getSnapPoints(){return Bt(cr((t,i)=>new p(.5+t,.5+i).scale(be),this.cols+1,this.rows+1))}fill(){let t=[],i=Array.from(this.$parent.getTilesOfType("ten-frame-counter")).map(n=>n.posn);for(let n=0;n<this.rows;n++)for(let r=0;r<this.cols;r++){let o=this.worldPosn(new p(be*(r+.5),be*(n+.5)));if(i.some(l=>l.equals(o,10)))continue;let a=new Xn("1",this.$parent);a.setTransform(o),t.push(a)}return t}static makeThumbnail(t,i){let[n,r]=t.split(":").map(l=>+l),o=c("svg",{width:n*25+4,height:r*25+4},i);c("rect",{x:2,y:2,width:n*25,height:r*25,fill:"none",stroke:"white","stroke-width":3},o);let a="";for(let l=1;l<r;++l)a+=`M2,${2+25*l}h${25*n}`;for(let l=1;l<n;++l)a+=`M${2+25*l},2v${25*r}`;c("path",{d:a,stroke:"white","stroke-width":1},o)}},Xn=class extends T{constructor(t,i,n){super(i,n);this.type="ten-frame-counter";this.options=t,this.$path=c("circle",{r:20,class:"polygon-tile"},this.$el),this.$outline=c("circle",{r:20,class:"outline"},this.$el),this.path=new H($,20),this.setColour(t==="1"?m.yellow:m.red)}moveEnd(){let t=this.$parent.getTileAt(this.posn,["ten-frame"]);if(!t)return;let i=t.relativePosn(this.posn),n=t.worldPosn(i.scale(1/be).shift(-.5).round().shift(.5).scale(be));this.animateTo(n,this.posn,50)}flip(){this.options=this.options==="1"?"0":"1",this.setColour(this.options==="1"?m.yellow:m.red)}doubleClick(){this.flip(),this.$parent.change({changed:[this]})}setColour(t){this.colour=t,this.$path.setAttr("fill",this.colour)}getSnapPoints(){return[$]}static makeThumbnail(t,i){let n=c("svg",{width:40,height:40},i),r=t==="1"?m.yellow:m.red;c("circle",{cx:20,cy:20,r:18,fill:r},n)}static action(t,i){return R(this,null,function*(){if(t==="flip"){for(let n of i)n.flip();i[0].$parent.change({changed:i})}})}};I([{type:"button",tileTypes:["ten-frame-counter"],label:"Flip",click:(e,s)=>{for(let t of e)t.flip();s.change({changed:e})}}]);I([{type:"button",tileTypes:["ten-frame"],label:"Fill",click:(e,s)=>{let t=Bt(e.map(i=>i.fill()));s.change({added:t})}}]);var Jf=4,tm=6,ci=6;function Qf(e){return e===1?[1]:Be(e)}var zv=ue((e,s)=>{if(e===2)return 2*s+1.5*ci;let t=2*s+ci,i=2*s+ci;e===3&&(i/=Math.sqrt(3)),e===4&&(i/=Math.sqrt(2)),e>3&&e%2&&(e-=1);let r=Math.ceil((Math.sqrt(e*8/tm+1)-1)/2);return i+(r-1)*t+s+ci});function lc(e){return e.reduceRight((s,t)=>zv(t,s),Jf)}function Fv(e,s){if(e===1)return[];if(e===2)return[$.shift(-s-ci/2,0),$.shift(s+ci/2,0)];let t=[],i=2*s+ci,n=i;e===3&&(n/=Math.sqrt(3)),e===4&&(n/=Math.sqrt(2)),e>3&&e%2&&(t.push($),e-=1);let r=1;for(;e;){let o=Math.min(tm*r,e);t.push(...M.regular(o,n).points),e-=o,n+=i,r+=1}return t}function hc(e,s,t,i=$){if(e.length<1)return[];let n=c("g",{class:"tile","data-n":e.join("-")},t),r=ga[e[0]]||m.red;c("circle",{r:s,cx:i.x,cy:i.y,fill:r,class:"polygon-tile"},n);let o=e.slice(1),a=lc(o),l=Fv(e[0],a);if(o.length){let h=[n];for(let d of l)h.push(...hc(o,a,n,i.add(d)));return h}else{for(let h of l){let d=i.add(h);c("circle",{r:Jf,cx:d.x,cy:d.y,fill:"white"},n)}return[n]}}var sn=class extends T{constructor(t,i){super(i);this.type="number-dot";this.factors=[];this.$body=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),t.startsWith(">")?(this.options=t,this.factors=t.slice(1).split("-").map(n=>+n),this.value=this.factors.reduce((n,r)=>n*r,1),this.count=this.factors.length,this.buildTile()):this.setValue(+t)}setValue(t){t=this.value=S(Math.round(t),1,999),this.factors=Qf(t),this.count=this.factors.length,this.options=">"+this.factors.join("-"),this.buildTile()}add(t){this.setValue(this.value+t)}buildTile(){this.$body.removeChildren(),this.radius=lc(this.factors);let t=hc(this.factors,this.radius,this.$body);if(this.factors.length>1)for(let i of t.slice(1))this.setupListeners(i);this.path=new H($,this.radius),this.$outline.draw(this.path),this.transform()}setupListeners(t){let n=t.attr("data-n").split("-").reduce((a,l)=>a*+l,1),r=t.parent,o=t.children[0];this.$parent.events.listen(t,{down:()=>this.$parent.selection.add(this,!this.$parent.events.shiftKey),start:()=>{!this.isActive||(this.$parent.selection.add(this,!0),o.addClass("prime-move"),this.$container.append(t))},move:a=>{!this.isActive||(t.setTransform(this.posn.add(a.posn).subtract(a.startPosn)),this.setCollision(this.findCollision(a.posn)))},end:a=>{if(!!this.isActive)if(a.lastPosn.subtract(this.posn).length<=this.radius)t.setTransform(),o.removeClass("prime-move"),r.append(t);else if(this.collision)t.remove(),this.collision.add(n),this.add(-n),this.$parent.selection.add(this.collision,!0),this.$parent.change({changed:[this,this.collision]}),this.setCollision();else{t.remove();let l=new sn(`${n}`,this.$parent);l.setTransform(this.posn.add(a.lastPosn).subtract(a.startPosn)),this.add(-n),this.$parent.change({added:[l],changed:[this]})}}})}findCollision(t){for(let i of this.$parent.getTilesOfType("number-dot"))if(i!==this&&p.distance(t,i.posn)<i.radius)return i}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findCollision(this.posn))}collide(t){t.highlight(!1),t.add(this.value);let i=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:i}),this.delete()}reorder(){this.factors.push(this.factors.shift()),this.options=`>${this.factors.join("-")}`,this.buildTile()}shrink(){this.factors.length<=1||(this.factors.push(this.factors.pop()*this.factors.pop()),this.count=this.factors.length,this.options=`>${this.factors.join("-")}`,this.buildTile())}grow(){let t=this.factors.length-1-this.factors.slice(0).reverse().findIndex(r=>!gn(r));if(t<0||!this.factors[t])return;let i=Be(this.factors[t])[0],n=Math.round(this.factors[t]/i);this.factors.splice(t,1,i,n),this.count=this.factors.length,this.options=`>${this.factors.join("-")}`,this.buildTile()}static makeThumbnail(t,i){let n=c("svg",{width:54,height:54},i),r=o=>{n.removeChildren();let a=Qf(o);for(let l=0;l<a.length;++l){let h=lc(a);hc(a,h,n)[0].css("transform",`translate(27px, 27px) scale(${25/h})`)}};i.onAttr("data-options",o=>r(Math.round(+o)))}};I([{type:"button",tileTypes:["number-dot"],label:"Combine factors",icon:"combine-dots",show:e=>e.some(s=>s.factors.length>1),click:(e,s)=>{e=e.filter(t=>t.factors.length);for(let t of e)t.shrink();s.change({changed:e})}},{type:"button",tileTypes:["number-dot"],label:"Split factors",icon:"split-dots",click:(e,s)=>{for(let t of e)t.grow();s.change({changed:e})}},{type:"button",tileTypes:["number-dot"],label:"Reorder",show:e=>e.some(s=>s.factors.length>1),click:(e,s)=>{e=e.filter(t=>t.factors.length);for(let t of e)t.reorder();s.change({changed:e})}}]);var Yn=25,Ma=class extends T{constructor(t,i,n){super(i,n);this.type="number-line";this.padding=[0,25,20,25];this.$el.addClass("number-line"),this.$fill=c("path",{fill:"transparent"},this.$el),this.$lines=c("path",{class:"number-line-ticks"},this.$el),this.$labels=c("g",{},this.$el),this.setColour(m.darkGrey);let[r,o,a,l,h]=t.split(":"),d=this.model=mt({start:j.fromString(r)||new j(0),step:j.fromString(o)||new j(1),width:+a,size:+l,minor:+h});this.$start=this.makeHandle("h",u=>{let f=S(Math.round(u.x/Yn/d.size),d.width-100,d.width-1);!f||(this.setTransform(this.posn.rotate(-U(this.rot)).shift(f*Yn*d.size,0).rotate(U(this.rot))),d.width-=f,d.start=d.start.add(d.step.multiply(f)))}),this.$start.css("transform",`translate(${-Yn}px, ${-2.5}px) rotate(${Math.PI}rad)`),this.$end=this.makeHandle("h",u=>{let f=u.x/Yn/d.size;d.width=S(Math.round(f),1,100)}),d.watch(()=>this.setDimensions(d))}setDimensions({start:t,step:i,width:n,size:r,minor:o}){let a=`${t}:${i}:${n}:${r}:${o}`;if(a===this.options)return;this.options=a,this.$labels.removeChildren(),r*=Yn;let l=`M0 10L${n*r} 10`;for(let h=0;h<=n*o;h+=1){let d=h*r/o,u=!(h%o);if(l+=`M${d} ${u?0:5}L${d} ${u?20:15}`,u){let f=t.add(i.multiply(h/o)).toString();if(f.includes("/")){let v=c("g",{},this.$labels),w=c("g",{class:"equation"},v),g=new Te(w,void 0,0,"",18,!1);g.setValue(f),w.css("transform",`translate(${d-g.root.width/2}px, ${35-g.root.height/2}px)`)}else c("text",{text:f,class:"number-line-label",x:d,y:40},this.$labels)}}this.$lines.setAttr("d",l),this.$end.setTransform({x:n*r,y:-2.5}),this.linePoints=B(h=>new p(h*r/o,10),n*o+1),this.line=new it(new p(0,10),new p(n*r,10)),this.path=new x(new p(0,-2.5),n*r,25),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update()}getSnapPoints(){return this.linePoints}getSnapLines(){return[this.line]}customTransform(){if(!b.isSafari)for(let t of this.$labels.children)t.css("transform",`rotate(${-this.rot}deg)`)}setLabels(t){super.setLabels(t),this.$labels.toggle(t!=="hidden"),this.$labels.css("transform",t==="above"?"translate(0,-49px)":"")}setColour(t){super.setColour(t),this.$lines.setAttr("stroke",E(t)),this.$labels.setAttr("fill",E(t)),this.$labels.css("color",E(t))}static makeThumbnail(t,i){let n=c("svg",{width:240,height:40},i),r="M20 10L220 10";for(let o=0;o<=10;o+=1){let a=20+o*20;r+=`M${a} 5L${a} 15`,c("text",{text:o,x:a,y:30,class:"number-line-label"},n)}c("path",{d:r,class:"number-line-ticks"},n)}};I([{type:"input",tileTypes:["number-line"],label:"Start:",get:e=>e.model.start.toString(),set:(e,s)=>s.model.start=j.fromString(e)||new j(0)},{type:"input",tileTypes:["number-line"],label:"Step:",range:[0,void 0],get:e=>e.model.step.toString(),set:(e,s)=>s.model.step=j.fromString(e)||new j(1)},{type:"input",tileTypes:["number-line"],label:"Width:",value:"number",range:[1,25],advanced:!0,get:e=>e.model.size,set:(e,s)=>s.model.size=Math.round(+e)},{type:"input",tileTypes:["number-line"],label:"Divisions:",value:"number",range:[1,25],advanced:!0,get:e=>e.model.minor,set:(e,s)=>s.model.minor=Math.round(+e)},{type:"select",tileTypes:["number-line"],options:[{key:"below",label:"Below"},{key:"above",label:"Above"},{key:"hidden",label:"None"}],advanced:!0,label:"Labels:",icon:"numbers",get:e=>e.labels||"below",set:(e,s)=>s.setLabels(e||"below")}]);var jv=20,Uv=25,Zv=500,em=new M(new p(-4,0),new p(3,4),new p(3,-4)),Ea=class extends T{constructor(t,i,n){super(i,n);this.type="multi-jump";this.canRotate=!1;this.$selectionArea=c("rect",{fill:"transparent"},this.$el),this.$line=c("path",{fill:"none",class:"number-line-ticks"},this.$el),this.$arrows=c("path",{class:"number-line-ticks"},this.$el),this.$sizeHandle=this.makeHandle("c",a=>{var h;a=this.worldPosn(new p(a.x,0));let l=(h=this.$parent.snapping.snap([a]))==null?void 0:h.shift;this.update(this.relativePosn(l?a.add(l):a).x,this.jumps)}),this.$jumpsHandle=this.makeHandle("c",a=>{this.update(this.jumpSize,a.x/this.jumpSize)});let[r,o]=t.split(":");this.setColour(m.yellow),this.update(+r,+o)}update(t,i){t=this.jumpSize=S(Math.round(t),Uv,Zv),i=this.jumps=S(Math.round(i),1,jv);let n=`${t}:${i}`;if(n===this.options)return;this.options=n;let r=t>=150?100:.4*t+40,o=new p(-t/4,-r).unitVector.scale(12),a="",l="";for(let d=0;d<i;d++){let u=d*t,f=new p(u+t,0).add(o);a+=`M${u},0 C${u+t/4},${-r} ${u+3/4*t},${-r} ${f.x},${f.y}`,l+=jt(new H(new p(u,0),3)),l+=jt(em.rotate(o.angle()).shift(u+t,0).translate(o))}this.$line.setAttr("d",a),this.$arrows.setAttr("d",l);let h=.8*r;this.path=new x(new p(0,-h),i*t,h),this.$selectionArea.setRect(this.path),this.$sizeHandle.setCenter({x:t,y:0}),this.$jumpsHandle.setCenter({x:i*t,y:0}),this.setColour(this.colour),this.transform(),this.$parent.selection.update()}getSnapPoints(){return B(t=>new p(t*this.jumpSize,0),this.jumps+1)}setColour(t){super.setColour(t),this.$line.setAttr("stroke",E(this.colour)),this.$arrows.setAttr("stroke",E(this.colour)),this.$arrows.setAttr("fill",E(this.colour))}static makeThumbnail(t,i){let n=c("svg",{width:200,height:50,viewBox:"-6 -44 200 50"},i),r=64,o=50,a=new p(-r/4,-o).unitVector.scale(9),l="",h="";for(let d=0;d<3;d++){let u=d*r,f=new p(u+r,0).add(a);l+=`M${u},0 C${u+r/4},${-o} ${u+3/4*r},${-o} ${f.x},${f.y}`,h+=jt(new H(new p(u,0),2)),h+=jt(em.scale(.6).rotate(a.angle()).shift(u+r,0).translate(a))}c("path",{d:l,fill:"none",stroke:m.yellow,"stroke-width":2.4},n),c("path",{d:h,fill:m.yellow,stroke:m.yellow,"stroke-width":2.4},n)}};var Kt=50,Ls=[m.yellow,"#f15e19","#e1343b",m.red,"#8d2ca1","#4e53d0",m.blue,"#0595bf","#0ba27b",m.green,"#7dc410","#ebc000"];function di(...e){if(!!b.isSafari){for(let s of e)s==null||s.css("transform-box","view-box");setTimeout(()=>{for(let s of e)s==null||s.css("transform-box","fill-box")})}}function Wv(e,s){return e==="fraction"?`"1"/"${s}"`:e==="decimal"?`"${Ft(1/s,2)}"`:`"${Ft(1/s*100,1)}%"`}function Aa(e,s,t,i,n,r=1){let o=c("g",{class:"fraction"},n);if(e!=="fraction"&&s>12)return o;let a=s>24?10:s>20?12:s>16?14:18,l=c("g",{style:`font-size: ${a}px`,class:"equation"},o),h=new Te(l,void 0,0,"",a,!0);h.setValue(Wv(e||"fraction",s));let d=h.root.width*r/2,u=h.root.height*r/2;return l.css("transform",`translate(${t-d}px, ${i-u}px)`+(r!==1?` scale(${r})`:"")),o}function sm(e,s,t,i,n,r,o,a="fraction",l=1){let h=c("rect",{x:e,y:s,width:t,height:i,fill:o,class:"polygon-tile"},r);return a==="hidden"?[h]:[h,Aa(a,n,e+t/2,s+i/2,r,l)]}var pi=class extends T{constructor(t,i,n){super(i,n);this.type="fraction-bar";this.count=0;this.$parts=[];this.options=t;let[r,o,a]=t.split(":").map(l=>+l);this.denominator=r,this.tileWidth=10*Kt/r,this.$fraction=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),this.$handle=this.makeHandle("h",l=>this.setCount(Math.round((l.x+Kt/2)/this.tileWidth))),this.$dark=this.makeHandle("h",l=>this.setCount(this.count,Math.round((l.x+Kt/2)/this.tileWidth))),this.setCount(o,a!=null?a:o),this.setColour(Ls[(r-1)%Ls.length])}setCount(t,i){t=S(t,1,40),i=S(i!=null?i:this.dark===this.count?t:this.dark,0,t),!(t===this.count&&i===this.dark)&&(this.count=t,this.dark=i,this.value=i/this.denominator,this.options=`${this.denominator}:${t}:${i}`,this.draw(),this.path=new x(new p(-Kt/2,-Kt/2),t*this.tileWidth,Kt),this.$outline.draw(this.path),this.$handle.setTransform(new p(t*this.tileWidth-Kt/2,-Kt/2)),this.$dark.setTransform(new p(this.dark*this.tileWidth-Kt/2,Kt/2)),this.$dark.setAttr("d",`M0 0V20L${this.dark?-20:20} 0Z`),this.transform(),this.$parent.selection.update())}setLabels(t){super.setLabels(t),this.draw()}select(){super.select(),di(...this.$parts.map(t=>t[1]))}deselect(){super.deselect(),di(...this.$parts.map(t=>t[1]))}setColour(t){super.setColour(t);let i=E(t),n=F.mix("#fff",i,.8).hex;for(let[r,o]of this.$parts.entries())o[0].setAttr("fill",r<this.dark?i:n);this.$fraction.css("color",F.from(i).brightness<220?"#fff":"#000")}draw(){this.$fraction.removeChildren(),this.$parts=[];let t=F.mix("#fff",this.colour,.8).hex;for(let i=0;i<this.count;i+=1){let n=i<this.dark?this.colour:t;this.$parts.push(sm(i*this.tileWidth-Kt/2,-Kt/2,this.tileWidth,Kt,this.denominator,this.$fraction,n,this.labels))}this.customTransform(),di(...this.$parts.map(i=>i[1]))}customTransform(){var t;for(let i of this.$parts)(t=i[1])==null||t.css("transform",`rotate(${-this.rot}deg)`)}static makeThumbnail(t,i){let[n,r]=t.split(":").map(h=>+h),o=c("svg",{width:222,height:24},i),a=Ls[n-1],l=220/n;i.onAttr("data-labels",h=>{o.removeChildren();let d=h!=="fraction"&&n>10?.44:.5;for(let u=0;u<r;++u)sm(1+u*l,1,l,22,n,o,a,h,d)})}changeDenominator(t){for(let i=this.denominator+t;t>0?i<=32:i>=1;i+=t){let n=Math.round(this.count/this.denominator*i);if(!P(n,this.count/this.denominator*i))continue;let r=Math.round(this.dark/this.denominator*i);if(!!P(r,this.dark/this.denominator*i)){this.denominator=i,this.tileWidth=10*Kt/i,this.setCount(n,r),this.setColour(Ls[(i-1)%Ls.length]);return}}}getSnapPoints(){let t=[];for(let i=0;i<=this.count;i+=1)t.push(new p(i*this.tileWidth-Kt/2,-Kt/2)),t.push(new p(i*this.tileWidth-Kt/2,Kt/2));return t}split(){if(this.count===1)return[];let t=B(i=>{let n=this.posn.shift(i*this.tileWidth,0).rotate(U(this.rot),this.posn),r=new pi(`${this.denominator}:${1}`,this.$parent);return r.setTransform(n,this.rot),r.setColour(this.colour),r.setLabels(this.labels),r},this.count);return this.$parent.selection.select(t),this.delete(),t}};I([{type:"button",tileTypes:["fraction-bar"],label:"Merge tiles",show:e=>e.length>1&&e.every(s=>s.denominator===e[0].denominator),click:(e,s)=>{let t=Math.min(...e.map(a=>a.posn.x)),i=Math.min(...e.map(a=>a.posn.y)),n=e.map(a=>a.count),r=q(n),o=new pi(`${e[0].denominator}:${r}`,e[0].$parent);o.setColour(F.mixMany(e.map(a=>F.from(a.colour)),n).hex),o.setTransform(new p(t,i),e[0].rot),o.setLabels(e[0].labels);for(let a of e)a.delete();s.selection.add(o),s.change({added:[o],deleted:e})}},{type:"button",tileTypes:["fraction-bar"],label:"Split tiles",show:e=>e.some(s=>s.count>1),click:(e,s)=>{let t=[];for(let n of e)t.push(...n.split());let i=e.filter(n=>n.count>1);s.change({added:t,deleted:i})}},{type:"button",tileTypes:["fraction-bar"],label:"Rename",icon:"fraction-up",click:(e,s)=>{for(let t of e)t.changeDenominator(1);s.change({changed:e})}},{type:"button",tileTypes:["fraction-bar"],label:"Rename",icon:"fraction-down",click:(e,s)=>{for(let t of e)t.changeDenominator(-1);s.change({changed:e})}}]);I([{type:"select",tileTypes:["fraction-bar","fraction-circle"],advanced:!0,label:"Labels:",options:[{key:"fraction",label:"Fractions"},{key:"percentage",label:"Percentage"},{key:"decimal",label:"Decimal"},{key:"hidden",label:"None"}],get:e=>e.labels||"fraction",set:(e,s)=>s.setLabels(e)}]);var cc=100,Va=class extends T{constructor(t,i,n){super(i,n);this.type="fraction-circle";this.rotateAroundOrigin=!0;this.options=t;let r={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=c("path",r,this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el);let o=this.denominator=+t;if(this.value=1/o,o>1){let a=new p(0,-cc).rotate(-Math.PI/o),l=this.path=new qe($,a,D/o);this.snapAngles=[0,It(bs(a)),It(bs(l.end))]}else this.path=new H($,cc);this.$path.draw(this.path),this.$outline.draw(this.path),this.draw(),o===1&&this.setOrder("back"),this.setColour(Ls[o-1]),this.$path.setAttr("fill",this.colour)}setLabels(t){super.setLabels(t),this.draw()}draw(){var i;if((i=this.$label)==null||i.remove(),this.denominator===1||this.labels==="hidden")return;let t=2-cc/2-(this.denominator-2)*3;this.$label=Aa(this.labels||"fraction",this.denominator,0,t,this.$el),this.customTransform(),di(this.$label)}customTransform(){var t;(t=this.$label)==null||t.css("transform",`rotate(${-this.rot}deg)`)}select(){super.select(),di(this.$label)}deselect(){super.deselect(),di(this.$label)}setColour(t){super.setColour(t),this.$path.setAttr("fill",E(t)),this.$el.css("color",F.from(E(t)).brightness<220?"#fff":"#000")}static makeThumbnail(t,i){let n=+t,r=c("svg",{width:80,height:44},i),o=c("path",{class:"polygon-tile"},r),a=new p(40,2).rotate(-Math.PI/n,new p(40,42)),l=n>1?new qe(new p(40,42),a,D/n):new H(new p(40,22),20);if(o.draw(l),o.setAttr("fill",Ls[n-1]),n===1)return;let h;i.onAttr("data-labels",d=>{h==null||h.remove();let u=26-(d==="fraction"?1.2:1.4)*n;d!=="hidden"&&(h=Aa(d,n,40,u,r,.6-n/80))})}};var fs=25;function dc(e,s,t,i,n){return new M(new p(-n,-n),new p(-n,e),new p(n,e),new p(n,-n),new p(s,-n),new p(s,n),new p(n,n),new p(n,t),new p(-n,t),new p(-n,n),new p(i,n),new p(i,-n))}var ka=class extends T{constructor(t,i,n){super(i,n);this.type="grid";this.showSelectionOutline=!0;this.canDragToSelect=!1;this.options=t,this.dimensions=new p,this.$axes=B(()=>c("line",{class:"grid-axis",stroke:"#777"},this.$el),2),this.$fill=c("path",{fill:"transparent"},this.$el),this.$handles=[0,1].map(o=>this.makeHandle("c",a=>{let l=o?this.dimensions.x:Math.round(a.x/fs-1),h=o?Math.round(a.y/fs-1):this.dimensions.y;this.setDimensions(l,h)})),this.$handles[1].css("cursor","ns-resize");let r=t.split(":");this.setDimensions(+r[0],+r[1])}setDimensions(t,i){t=S(t,1,100),i=S(i,1,100),!(t===this.dimensions.x&&i===this.dimensions.y)&&(this.dimensions=new p(t,i),this.options=`${t}:${i}`,this.path=dc(-1.5,t+1,i+1,-1.5,.5).scale(fs),this.$axes[0].setLine({x:-1.5*fs,y:0},{x:(t+1)*fs,y:0}),this.$axes[1].setLine({x:0,y:-1.5*fs},{x:0,y:(i+1)*fs}),this.$handles[0].setCenter({x:(t+1)*fs,y:0}),this.$handles[1].setCenter({x:0,y:(i+1)*fs}),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update())}setColour(t){this.colour=t;for(let i of this.$axes)i.setAttr("stroke",E(t))}static makeThumbnail(t,i){let n=c("svg",{width:80,height:80},i);c("line",{x1:20,y1:0,x2:20,y2:80,stroke:"white","stroke-width":2},n),c("line",{x1:0,y1:20,x2:80,y2:20,stroke:"white","stroke-width":2},n)}};function pc(e,s){var n,r,o;if(s.value!==void 0)return["",s.value,0,s.value,0];if(s.is("algebra-tile")){let a=s.options.startsWith("-")?-1:1,l=a<0?s.options.slice(1):s.options,h=(n=e.tileWeights.get("x"))!=null?n:5,d=(r=e.tileWeights.get("y"))!=null?r:4;switch(l){case"1":return["",a,0,a,0];case"x":return["x",a,0,a*h,h];case"x2":return["x",0,a,a*h*h,h];case"y":return["y",a,0,a*d,d];case"y2":return["y",0,a,a*d*d,d];case"xy":return["x",a*d,0,a*d*h,h]}}let t=btoa(s.type+s.options+s.colour).replace(/=/g,""),i=(o=e.tileWeights.get(t))!=null?o:1;return[t,1,0,i,i]}function Kv(e,s,t){let i={},n=0,r=(f,v=1)=>{let[w,g,y,C,A]=pc(e,f);n+=v*C,w&&(i[w]||(i[w]=[0,0,0]),i[w][0]+=v*g,i[w][1]+=v*y,i[w][2]=A)};for(let f of s)r(f,1);for(let f of t)r(f,-1);if(P(n,0))return;let o=Object.keys(i).filter(f=>i[f][0]||i[f][1]),a=o.filter(f=>!e.tileWeights.has(f))[0]||_(o);if(!a)return!0;let[l,h,d]=i[a],u=P(h,0)?d-n/l:Math.max(...ql(h,l,n-l*d-h*d*d));e.tileWeights.set(a,u),e.options.tileWeights=Array.from(e.tileWeights.entries()).map(f=>f.join("=")).join(",")}function am(e,s){e.tileWeights.clear();for(let t of s.split(",")){let[i,n]=t.split("=");i&&e.tileWeights.set(i,+n||0)}}var im="M0,26A18.1,18.1,0,0,0-18,44V72H18V44A18.1,18.1,0,0,0,0,26Z",nm=["text","grid","number-line","spinner","decimal-grid","axes","custom-spinner","ruler","protractor","compass","geo","dot-machine","abacus","balance","chess-board","multi-jump","set-triangle","bucket","table","number-grid","ten-frame","chart","pie-chart","box-whisker"],Qn=15,Yt=40,rm=180;function Oa(e){let s=e/2;return`M${s},0C${s},16,66.3,20,0,20S${-s},16${-s},0Z`}function om(e,s){var i;let t=e.posn.shift(0,s);e.$el.setTransform(t,U(e.rot)),e.transformed=(i=e.path)==null?void 0:i.rotate(e.rot).translate(t)}var La=class extends T{constructor(t,i,n){super(i,n);this.type="balance";this.canRotate=!1;this.canDragToSelect=!0;this.level=0;this.left=[];this.right=[];this.isAnimating=!1;let[r,o]=t.split(":");this.level=+r||0,this.plateSize=+o||240,this.$beam=c("path",{class:"balance-beam"},this.$el),this.$left=c("path",{class:"balance"},this.$el),this.$right=c("path",{class:"balance"},this.$el),this.$base=c("path",{d:im,class:"balance"},this.$el),this.$leftRect=c("rect",{class:"balance-target"},this.$el),this.$rightRect=c("rect",{class:"balance-target"},this.$el),this.$handle=this.makeHandle("c",l=>{this.plateSize=S(ht(l.x-Yt,20),120,800),this.options=`${this.level}:${this.plateSize}`,this.resize(),this.draw(),this.transform()},void 0,()=>this.showTargets(),()=>this.hideTargets()),this.setColour("#bbb"),this.customTransform(),this.resize(),this.draw();let a=[];this.onMoveStart=()=>{a=Array.from(i.selection.tiles).filter(l=>!nm.includes(l.type)),this.isActive&&this.showTargets()},this.onMove=()=>{if(this.isActive||!a.length)return;for(let d of a)d.transform();let[l,h]=this.checkTileOverlaps(a);this.$leftRect.toggle(!!l.length),this.$rightRect.toggle(!!h.length)},this.onMoveEnd=()=>{this.hideTargets(),a=[]},this.onChange=l=>{l.action==="change"&&([this.left,this.right]=this.checkTileOverlaps(this.$parent.tiles.values()),this.rebalance(400,l))},i.on("move-start",this.onMoveStart),i.on("move-selection",this.onMove),i.on("move-end",this.onMoveEnd),setTimeout(()=>i.on("change",this.onChange))}delete(){this.$parent.off("move-start",this.onMoveStart),this.$parent.off("move-selection",this.onMove),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}showTargets(){this.$leftRect.show(),this.$rightRect.show()}hideTargets(){this.$leftRect.hide(),this.$rightRect.hide()}targetAreas(){let t=new x(new p(0,-rm),this.plateSize,rm),i=t.shift(-this.plateSize-Yt,this.level*Qn),n=t.shift(Yt,-this.level*Qn);return[i,n]}checkTileOverlaps(t){let[i,n]=this.targetAreas().map(a=>a.translate(this.posn)),r=[],o=[];for(let a of t)!a.transformed||a.type==="balance"||nm.includes(a.type)||(Bi(i,a.transformed)?r.push(a):Bi(n,a.transformed)&&o.push(a));return[r,o]}resize(){this.$left.setAttr("d",Oa(this.plateSize)),this.$right.setAttr("d",Oa(this.plateSize))}draw(t=this.level){let i=this.plateSize/2+Yt,n=new p(-i,t*15),r=new p(i,-t*15);this.$beam.draw(new le(n.shift(0,10),n.shift(0,44),r.shift(0,44),r.shift(0,10))),this.$left.setTransform(n),this.$right.setTransform(r),this.$handle.setCenter({x:this.plateSize+Yt,y:-t*15});let[o,a]=this.targetAreas();this.$leftRect.setRect(o),this.$rightRect.setRect(a)}rebalance(t=400,i){return R(this,null,function*(){let n=q(this.left.map(h=>pc(this.$parent,h)[3])),r=q(this.right.map(h=>pc(this.$parent,h)[3])),o=P(n,r)?0:n<r?-1:1;if(o===this.level||this.isAnimating)return;let a=this.level,l=(o-a)*Qn;this.level=o;for(let h of this.left)h.setTransform(h.posn.shift(0,l));for(let h of this.right)h.setTransform(h.posn.shift(0,-l));if(i!=null&&i.data){let h=i.data.changed=i.data.changed||[],d=[...i.data.added||[],...i.data.deleted||[]];for(let u of[this,...this.left,...this.right])!h.includes(u)&&!d.includes(u)&&h.push(u)}this.options=`${o}:${this.plateSize}`,this.isAnimating=!0,yield K(h=>{this.draw($t(a,o,h));for(let d of this.left)om(d,(h-1)*l);for(let d of this.right)om(d,(1-h)*l);this.$parent.selection.update()},t).promise,this.isAnimating=!1,this.transform(),this.$parent.selection.update()})}customTransform(){let t=this.level*Qn,i=this.plateSize+Yt;this.path=new M(new p(-i,t),new p(-Yt,t),new p(-Yt,25),new p(Yt,25),new p(Yt,-t),new p(i,-t),new p(i,-t+48),new p(Yt,-t+48),new p(Yt,72),new p(-Yt,72),new p(-Yt,t+48),new p(-i,t+48))}getSnapPoints(){let t=this.level*Qn,i=this.plateSize+Yt;return[new p(-i,t),new p(-Yt,t),new p(Yt,-t),new p(i,-t)]}getSnapLines(){let[t,i,n,r]=this.getSnapPoints();return[new it(t,i),new it(n,r)]}setColour(t){this.colour=t,this.$beam.css("stroke",t);for(let i of[this.$base,this.$left,this.$right])i.css("fill",E(t))}balance(){if(Kv(this.$parent,this.left,this.right))return xo("balance-error");let i=new Set;for(let n of this.$parent.getTilesOfType("balance")){n.rebalance();for(let r of[n,...n.left,...n.right])i.add(r)}}static makeThumbnail(t,i){let n=c("svg",{width:250,height:50,viewBox:"-290 -10 580 82",class:"scale"},i);c("path",{d:"M-160 10v34h320v-34",fill:"transparent",stroke:"#bbb","stroke-width":10},n),c("path",{d:Oa(240),transform:"translate(-160 0)",fill:"#bbb"},n),c("path",{d:Oa(240),transform:"translate(160 0)",fill:"#bbb"},n),c("path",{d:im,fill:"#bbb"},n)}};I([{type:"button",tileTypes:["balance"],label:"Balance",show:e=>e.length===1&&!!e[0].level,click:(e,s)=>{e[0].balance(),s.change({changed:e})}}]);var uc={circle:"M -25 0a25,25 0 1 0 50 0a25 25 0 1 0 -50 0",square:"M0 -25L25 0L0 25L-25 0Z",cross:"M25 -9L9 -9L9 -25L-9 -25L-9 -9L-25 -9L-25 9L-9 9L-9 25L9 25L9 9L25 9L25 -9Z",weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1ZM0-11a4,4,0,0,1-4-4,4,4,0,0,1,4-4,4,4,0,0,1,4,4A4,4,0,0,1,0-11Z",star:"M0 15.7L15.5 23.8L12.5 6.6L25 -5.6L7.7 -8.1L0 -23.8L-7.7 -8.1L-25 -5.6L-12.5 6.6L-15.5 23.8L0 15.7Z",heart:"M3.4,20.8a4.9,4.9,0,0,1-6.7-.1l-.3-.2C-16.7,8.6-25.3.8-25-8.9a13.7,13.7,0,0,1,5.9-10.7A14.4,14.4,0,0,1,0-16.8a14.4,14.4,0,0,1,19.1-2.8A13.7,13.7,0,0,1,25-8.9C25.3.8,16.7,8.6,3.6,20.5Z"},Xv={weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1Z"},lm={circle:m.orange,square:m.purple,cross:m.green,weight:m.blue,star:m.yellow,heart:m.red},Ra=class extends W{constructor(t,i,n){super("square",i,n);this.type="token";this.options=t,this.$path.setAttr("d",uc[t]),this.$outline.setAttr("d",Xv[t]||uc[t]),this.setColour(lm[t])}static makeThumbnail(t,i){let n=c("svg",{width:36,height:36},i),r=c("path",{d:uc[t],class:"polygon-tile"},n);r.setTransform({x:18,y:18},0,.6),r.setAttr("fill",lm[t])}};var Yv=["x","y","\u03B8","r"];function nn(e){if(e instanceof Xt&&e.fn==="="){let[s,t]=e.args;if(s instanceof Gi&&!Yv.includes(s.i))return[s.i,t]}return[void 0,e]}var Ia=class{constructor(){this.assignments=new Map;this.callbackDeps=new Map;this.updatedNames=new Set}findFirstAssigner(s){var t;return(t=this.assignments.get(s))==null?void 0:t.keys().next().value}findDependants(s,t=[]){let i=[];for(let[r,o]of this.assignments.entries())o.size===1&&r!==s&&!t.includes(r)&&pr(o.values()).unknowns.filter(l=>!t.includes(l)).includes(s)&&i.push(r);let n=[...vi(i,r=>this.findDependants(r,i))];return i.concat(n)}validate(s){let t=new Set,i=(n,r=[])=>{if(!this.assignments.has(n)){t.add(n);return}if(r.includes(n))return{message:`The variable <em>${n}</em> is defined recursively.`,locations:r.splice(r.indexOf(n)).map(a=>this.findFirstAssigner(a))};let o=this.assignments.get(n);if(o.size===1){let a=pr(o.values());for(let l of a.unknowns){let h=i(l,[...r,n]);if(h)return h}}else return{message:`You have defined <em>${n}</em> in multiple places.`,locations:Array.from(o.keys())}};for(let n of s.unknowns){let r=i(n);if(r)return{error:r,dependsOn:[],unknowns:[]}}return{dependsOn:[],unknowns:Array.from(t)}}evaluate(s){let{error:t,unknowns:i}=this.validate(s);if(t||i.length)return{error:t,value:NaN};try{return{value:s.evaluate(this.evalContext)}}catch(n){return{value:NaN}}}get evalContext(){let s={};for(let[t,i]of this.assignments.entries())i.size===1&&(s[t]=pr(i.values()));return s}get serializedEvalContext(){let s={};for(let[t,i]of Object.entries(this.evalContext))s[t]=i.toString();return s}substituteAssignments(s){let[t,i]=nn(s);return t?new Xt("=",[new Gi(t),i.recursiveSubstitute(this.evalContext)]):s.recursiveSubstitute(this.evalContext)}markUpdated(s){this.updatedNames.add(s);for(let t of this.findDependants(s))this.updatedNames.add(t)}flushChanges(){for(let[t,i]of this.callbackDeps.entries())i.some(n=>this.updatedNames.has(n))&&t();let s=Array.from(this.updatedNames);return this.updatedNames.clear(),s}updateSource(s,t,i,n=!0){this.removeSource(s,!1),this.assignments.has(t)||this.assignments.set(t,new Map),this.assignments.get(t).set(s,i),this.markUpdated(t),n&&this.flushChanges()}attemptUpdateSource(s,t,i=!0){if(typeof t=="string")try{t=Ot.parse(t).collapse()}catch(o){return}let[n,r]=nn(t);return n?this.updateSource(s,n,r,i):this.removeSource(s),r}removeSource(s,t=!0){for(let[i,n]of this.assignments.entries())n.has(s)&&this.markUpdated(i),n.delete(s),n.size===0&&this.assignments.delete(i);t&&this.flushChanges()}watch(s,t,i=!1){this.callbackDeps.set(t,s),i&&t()}unwatch(s){s&&this.callbackDeps.delete(s)}};var Lt=50;function hm(e,s){for(let t of e)if(s(t))return t}var mc=class{constructor(s){this.promises=new Map;this.latestPromises=new Map;this.worker=new Worker(s),this.worker.onmessage=t=>{if(!t.data)return;let i=t.data[0],n=this.promises.get(t.data[0]);this.promises.delete(i),!(!n||this.latestPromises.get(n[0])!==i)&&n[1](t.data[1])}}draw(s,t,i,{xMin:n,xMax:r,yMin:o,yMax:a},[l,h]){let d=gs();return this.latestPromises.set(s,d),this.worker.postMessage(["plot",t,i,d,n,r,l,o,a,h,Lt]),new Promise(u=>this.promises.set(d,[s,u]))}},fc,rn=class extends T{constructor(t,i,n){super(i,n);this.type="axes";this.showSelectionOutline=!0;this.canDragToSelect=!1;this.functions=new Map;this.scatterPlots=new Map;this.steps=[1,1];this.watchers=new Map;this.$fill=c("path",{fill:"transparent"},this.$el),this.$grid=c("path",{class:"axis-gridlines"},this.$el),this.$content=c("g",{},this.$el),this.$axes=c("path",{class:"grid-axis"},this.$el),this.$labels=c("g",{class:"axis-labels"},this.$el),this.$scatter=c("g",{},this.$el),this.$outline=c("rect",{class:"outline active",hidden:!0},this.$el),this.setColour(m.darkGrey),this.watchPolypadOptions(f=>this.$grid.toggle(f.grid==="none"));let[r,o,a,l,h,d]=t.split(":"),u=this.model=mt({xMin:+r,xMax:+a,xStep:o,yMin:+l,yMax:+d,yStep:h});this.$handles=[this.makeHandle("c",f=>u.xMin=S(Math.round(f.x/Lt),-20,0)),this.makeHandle("c",f=>u.xMax=S(Math.round(f.x/Lt),0,20)),this.makeHandle("c",f=>u.yMin=S(Math.round(-f.y/Lt),-20,0)),this.makeHandle("c",f=>u.yMax=S(Math.round(-f.y/Lt),0,20))];for(let f of[2,3])this.$handles[f].css("cursor","ns-resize");i.events.listen(this.$el,{click:f=>this.setAndDrawFocus(f),blurInput:!1,checkIfActive:()=>this.$focusSource!==void 0}),this.makeInPort("main",{connect:f=>{f.from.tile.is("equation")?this.functions.set(f,c("path",{class:"geo-path"},this.$content)):f.from.tile.is("table")&&this.scatterPlots.set(f,[c("g",{},this.$scatter),[]])},message:(f,v)=>{if(v.from.tile.is("equation")){let w=this.functions.get(v);w.css("color",E(v.from.tile.colour)),this.drawEquation(v.from.tile,w)}else if(f.type==="table"){let w=this.scatterPlots.get(v),g=v.from.tile.colour==="#bbb"?"#666":v.from.tile.colour;w[0].setAttr("fill",E(g)),w[1]=f.table,this.drawScatterPoints(w[0],f.table)}},disconnect:f=>{var v,w;f.from.tile.is("equation")?((v=this.functions.get(f))==null||v.remove(),this.functions.delete(f),this.$parent.mathContext.unwatch(this.watchers.get(f.from.tile))):f.from.tile.is("table")&&((w=this.scatterPlots.get(f))==null||w[0].remove(),this.scatterPlots.delete(f))},tileTypes:["table","equation"]}),u.watch(()=>this.setSizes(u))}highlight(t=!0){var i;(i=this.$outline)==null||i.toggle(t)}setSizes({xMin:t,xMax:i,yMin:n,yMax:r,xStep:o,yStep:a}){var w;let l=`${t}:${o}:${i}:${n}:${a}:${r}`;if(l===this.options)return;this.options=l;let h=Lt;this.$handles[0].setCenter({x:t*h,y:0}),this.$handles[1].setCenter({x:i*h,y:0}),this.$handles[2].setCenter({x:0,y:-n*h}),this.$handles[3].setCenter({x:0,y:-r*h}),this.$labels.removeChildren();let d="",u=`M${t*h} 0L${i*h} 0M0 ${-n*h}L0 ${-r*h}`;u+=`M0 ${-r*h-3}l5 8h-10ZM${i*h+3} 0l-8 5v-10Z`;let f=j.fromString(o),v=j.fromString(a);this.steps=[(f==null?void 0:f.value)||1,(v==null?void 0:v.value)||1];for(let g=t+1;g<i;++g)!g||(u+=`M${g*h} 0L${g*h} 5`,d+=`M${g*h} ${-n*h}L${g*h} ${-r*h}`,c("text",{text:(f==null?void 0:f.multiply(g).toString())||"",x:g*h,y:21,"text-anchor":"middle"},this.$labels));for(let g=n+1;g<r;++g)!g||(u+=`M0 ${-g*h}L-5 ${-g*h}`,d+=`M${t*h} ${-g*h}L${i*h} ${-g*h}`,c("text",{text:(v==null?void 0:v.multiply(g).toString())||"",x:-10,y:-g*h+5,"text-anchor":"end"},this.$labels));this.$axes.setAttr("d",u),this.$grid.setAttr("d",d),this.$fill.draw(dc(-r*Lt,i*Lt,-n*Lt,t*Lt,15)),this.path=new x(new p(t*Lt,-r*Lt),(i-t)*Lt,(r-n)*Lt),(w=this.$outline)==null||w.setRect(this.path);for(let[g,y]of this.functions.entries())this.drawEquation(g.from.tile,y);for(let[g,y]of this.scatterPlots.values())this.drawScatterPoints(g,y);this.transform(),this.$parent.selection.update()}getSnapPoints(){let{xMin:t,xMax:i,yMin:n,yMax:r}=this.model,o=[];for(let a=t;a<=i;++a)for(let l=n;l<=r;++l)o.push(new p(a*Lt,-l*Lt));return o}getSnapLines(){let{xMin:t,xMax:i,yMin:n,yMax:r}=this.model;return[new it(new p(t*Lt,0),new p(i*Lt,0)),new it(new p(0,-n*Lt),new p(0,-r*Lt))]}setColour(t){var i;if(this.$focusSource)this.$focusSource.from.tile.setColour(t),(i=this.$focusShadow)==null||i.css("stroke",E(this.colour)),this.$parent.change({changed:[this.$focusSource.from.tile]});else{super.setColour(t.slice(0,7));for(let n of[this.$axes,this.$labels])n.setAttr("fill",E(this.colour));for(let n of[this.$axes,this.$grid])n.setAttr("stroke",E(this.colour))}}getX(t){return t/this.steps[0]*Lt}getY(t){return t/this.steps[1]*Lt}drawEquation(t,i){let n=Ot.parse(t.options).collapse(),r=this.$parent.mathContext;r.unwatch(this.watchers.get(t));let o=()=>R(this,null,function*(){let[a,l]=nn(n),{error:h,unknowns:d}=r.validate(l);if(this.showErrorIcon(h),h)i.setAttr("d","");else if(d.length>2)this.showErrorIcon({message:"An equation has too many degrees of freedom.",locations:[t]}),i.setAttr("d","");else{fc||(fc=new mc(this.$parent.attr("worker")));let u=yield fc.draw(t,n.toString(),r.serializedEvalContext,this.model,this.steps);i.setAttr("d",u.startsWith("[Error]")?"":u)}});this.watchers.set(t,o),r.watch(n.unknowns,o,!0)}drawScatterPoints(t,i){let n=t.children;for(let r of n)r.hide();for(let r=1;r<i.length;++r){if(i[r].length<2)continue;let o=+i[r][0],a=+i[r][1];if(!st(o/this.steps[0],this.model.xMin,this.model.xMax,-1e-5)||!st(a/this.steps[1],this.model.yMin,this.model.yMax,-1e-5))continue;let l=n[r]||c("circle",{r:6},t);l.setAttr("cx",this.getX(o)),l.setAttr("cy",-this.getY(a)),l.show()}}select(){this.$focusSource&&this.blur(),super.select()}blur(){var t;!this.$focusSource||((t=this.$focusShadow)==null||t.hide(),this.$focusSource=void 0,super.blur())}doubleClick(t){this.setAndDrawFocus(t)}setAndDrawFocus(t){var r,o,a;let i=G(t.event.target);if(i.tagName==="CIRCLE"){let l=i.parent;this.$focusSource=(r=hm(this.scatterPlots.entries(),([h,[d]])=>l===d))==null?void 0:r[0]}else if(i.hasClass("geo-path"))this.$focusSource=(o=hm(this.functions.entries(),([l,h])=>h===i))==null?void 0:o[0];else return this.$parent.selection.add(this);this.focus(),this.$focusShadow||(this.$focusShadow=c("path",{class:"chart-shadow"})),this.$el.prepend(this.$focusShadow);let n="";if(this.$focusSource.from.tile.is("equation"))n=this.functions.get(this.$focusSource).attr("d")||"";else if(this.$focusSource.from.tile.is("table")){let l=this.scatterPlots.get(this.$focusSource)[0].children;for(let h of l)n+=jt(new H(h.center,7))}this.$focusShadow.css("stroke",E((a=this.$focusSource)==null?void 0:a.from.tile.colour)),this.$focusShadow.setAttr("d",n),this.$focusShadow.show()}static makeThumbnail(t,i){let n=c("svg",{width:120,height:120},i);c("path",{d:"M20 4v112M40 4v112M80 4v112M100 4v112M4 20h112M4 40h112M4 80h112M4 100h112",class:"axis-gridlines",stroke:"white"},n),c("path",{d:"M5 60h112M60 4v112M60 2l4 6h-8ZM118 60l-6 4v-8Z",class:"grid-axis",fill:"white"},n)}};I([{type:"input",tileTypes:["axes"],label:"X axis:",range:[0,void 0],increment:!0,get:e=>e.model.xStep,set:(e,s)=>{var t;return s.model.xStep=((t=j.fromString(e))==null?void 0:t.clamp(.01).toString())||"1"}},{type:"input",tileTypes:["axes"],label:"Y axis:",range:[0,void 0],increment:!0,get:e=>e.model.yStep,set:(e,s)=>{var t;return s.model.yStep=((t=j.fromString(e))==null?void 0:t.clamp(.01).toString())||"1"}}]);var Na=200,Ga=75,ts=20,Qv='<tspan style="font-style:italic"></tspan> &nbsp;=&nbsp; <tspan></tspan>',cm="M8,6.8V17.2a.9.9,0,0,0,1.5.8l8.2-5.2a1,1,0,0,0,0-1.7L9.5,6A1,1,0,0,0,8,6.8Z",Jv="M8 19a2 2 0 0 0 2-2v-10a2 2 0 0 0 -2-2 2 2 0 0 0 -2 2v10a2 2 0 0 0 2 2zm6-12v10a2 2 0 0 0 2 2 2 2 0 0 0 2-2v-10a2 2 0 0 0 -2-2 2 2 0 0 0 -2 2z";function tw(e,s,t){let i=(Date.now()-e)/1e3;if(t==="once")return i/s;if(t==="loop")return i/s%1;let n=i/(s*2)%1;return n<.5?n*2:1-(n-.5)*2}var Da=class extends T{constructor(t,i,n){super(i,n);this.type="slider";this.path=new x($,Na,Ga);this.options=t,this.$body=c("rect",{class:"polygon-tile",rx:10},this.$el),this.$outline=c("rect",{class:"outline",rx:10},this.$el),this.$body.setRect(this.path),this.$outline.setRect(this.path),this.$expr=c("text",{x:ts,y:30,html:Qv},this.$el),[this.$exprName,this.$exprValue]=this.$expr.$$("tspan"),this.$bar=c("line",{x1:ts,x2:Na-ts,y1:Ga-ts,y2:Ga-ts,opacity:.5,style:"stroke-width: 4"},this.$el);let r=c("g",{transform:"translate(162 12)",style:"cursor: pointer"},this.$el);c("rect",{x:-4,y:-4,width:32,height:32,fill:"transparent"},r),this.$playIcon=c("path",{d:cm},r),i.events.listen(r,{click:()=>this.play()}),this.$handle=this.makeHandle("c",v=>{let w=$t(this.model.min,this.model.max,(v.x-ts)/(Na-2*ts));this.setValue(w),this.updateOptions()}),this.$handle.addClass("persistent");let[o,a,l,h,d,u,f]=this.options.split(":");this.variable=o,this.model=mt({name:o,min:l===void 0?-5:+l,max:h===void 0?5:+h,step:+d||.1,type:u||"bounce",duration:+f||2}),this.model.watchAll((v,w)=>{this.animation&&this.stopAnimating(),this.setValue(w?+a||0:this.value)})}play(){if(this.animation){this.stopAnimating(),this.$parent.change({changed:[this]});return}this.$playIcon.setAttr("d",Jv);let{min:t,max:i,type:n,duration:r}=this.model,o=Date.now(),a=o+r*1e3;this.animation=K(()=>{let l=tw(o,r,n);this.setValue($t(t,i,l)),n==="once"&&Date.now()>=a&&this.stopAnimating()})}stopAnimating(){var t;(t=this.animation)==null||t.cancel(),this.animation=void 0,this.$playIcon.setAttr("d",cm),this.updateOptions()}delete(){this.animation&&this.stopAnimating(),super.delete()}setValue(t){if(t=S(ht(t,this.model.step),this.model.min,this.model.max),this.model.name!==this.variable)this.model.name=this.model.name.replace(/[^A-Za-z]/g,""),this.$parent.mathContext.removeSource(this),this.variable=this.model.name;else if(this.value!==void 0&&P(t,this.value))return;this.value=t;let i=$t(ts,Na-ts,(t-this.model.min)/(this.model.max-this.model.min));this.$handle.setTransform(new p(i,Ga-ts)),this.$exprName.text=this.variable,this.$exprValue.text=nt(t,5),this.$parent.mathContext.updateSource(this,this.variable,new cs(t))}setColour(t){super.setColour(t);let i=E(t),n=F.from(i).brightness<180?"#fff":"#000";this.$body.setAttr("fill",i);for(let r of[this.$expr,this.$playIcon])r.setAttr("fill",n);this.$handle.css("fill",n),this.$bar.setAttr("stroke",n)}updateOptions(){this.options=[this.variable,this.value,this.model.min,this.model.max,this.model.step,this.model.type,this.model.duration].join(":")}static makeThumbnail(t,i){let r=t.split(":")[0],o=c("svg",{width:104,height:54},i);c("rect",{x:2,y:2,width:100,height:50,fill:i.data.colour,rx:5},o),c("rect",{x:10,y:40,width:84,height:3,fill:"white",rx:2,opacity:.5},o),c("circle",{cx:32,cy:41.5,r:6,fill:"white"},o),c("text",{x:52,y:28,fill:"white",style:"font-size:24;font-style:italic;text-anchor:middle",text:r},o)}};I([{type:"input",tileTypes:["slider"],label:"Name:",style:"font-style:italic",get:e=>e.model.name,set:(e,s)=>s.model.name=e},{type:"input",tileTypes:["slider"],label:"Range:",value:"number",noDivider:!0,get:e=>e.model.min,set:(e,s)=>s.model.min=+e},{type:"input",tileTypes:["slider"],label:"",value:"number",get:e=>e.model.max,set:(e,s)=>s.model.max=+e},{type:"input",tileTypes:["slider"],label:"Increment:",value:"number",advanced:!0,get:e=>e.model.step,set:(e,s)=>s.model.step=+e},{type:"input",tileTypes:["slider"],label:"Duration:",value:"number",range:[.1,10],advanced:!0,get:e=>e.model.duration,set:(e,s)=>s.model.duration=+e},{type:"select",tileTypes:["slider"],label:"Motion:",options:[{label:"Bounce",key:"bounce"},{label:"Loop",key:"loop"},{label:"Once",key:"once"}],advanced:!0,get:e=>e.model.type,set:(e,s)=>s.model.type=e}]);var dm=e=>50*Math.log(e)/Math.log(2),_a=class extends W{constructor(t,i,n){super(gt(new x(new p(-25,-20),50,dm(+t)).points),i,n);this.type="log-bar";this.fill=m.blue;this.options=t;let r=ws(Be(+t).map(o=>dm(o)));r.pop();for(let o of r)c("line",{x1:-25,x2:25,y1:o-20,y2:o-20,class:"polygon-tile",opacity:.3},this.$el);this.$el.append(this.$outline),c("text",{text:t,class:"polygon-label",y:6},this.$el)}static makeThumbnail(t,i){i.setAttr("width",21),i.setAttr("fill",m.blue);let n=c("text",{class:"polygon-label",x:+i.attr("x")+10.5,y:+i.attr("y")+16},i.parent);i.onAttr("data-options",r=>{i.setAttr("height",Math.min(21*Math.log(+r)/Math.log(2),100)),n.text=r,n.css("font-size",+r<99?"":"11px")})}};var gc=/(,|^[^.\-0-9]+|[^.\-0-9]+$)/g,pm=[m.red,m.blue,m.green,m.yellow,m.purple,m.orange,m.lime],Rs=class extends T{constructor(t,i,n){super(i,n);this.focussedSeries=-1;this.default=!0;this.seriesLabels=[];this.chartOptions=mt({}),t&&Object.assign(this.chartOptions,Gs(t)),this.chartColors=this.chartOptions.colours||[],this.chartOptions.watchAll(()=>this.options=JSON.stringify(this.chartOptions)),this.$series=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),i.events.listen(this.$el,{click:r=>this.focusOnSeries(r),checkIfActive:()=>this.focussedSeries>=0})}setColour(t,i){let n=this.focussedSeries;if(n>=0&&i==="picker"){if(this.chartColors[n]===t)return;this.chartColors[n]=t,this.colorSeries(E(t),n),this.chartOptions.colours=this.chartColors.slice(0),this.$parent.change({changed:[this]})}else i==="theme"||super.setColour(t)}getSeriesColor(t){if(this.default)return m.grey;let i=this.seriesLabels[t],n=this.chartColors[t]||(i!=null&&i.startsWith("#")?i:pm[t%pm.length]);return E(n)}doubleClick(t){this.focussedSeries>=0||(this.focusOnSeries(t),!(this.focussedSeries<0)&&(super.focus(),this.$el.addClass("chart-focussed")))}focusOnSeries(t){let i=t.event.target.getAttribute("series-idx")||this.findClosestElement(t);!i||(this.focussedSeries=+i,this.focusSeries(+i))}findClosestElement(t){return""}blur(){this.focussedSeries<0||(this.focussedSeries=-1,this.$el.removeClass("chart-focussed"),super.blur())}};function Jn(e){e=e.filter((t,i)=>!i||t.some(n=>n));let s=e[0].map((t,i)=>e.some((n,r)=>r>0&&n[i]));return e.map(t=>t.filter((i,n)=>s[n]))}function um(e){if(e=Jn(e),!e.length||!e[0].length)return[[],[]];e[0].length===1&&(e=e.map((n,r)=>[`${r}`,n[0]]));let s=e.slice(1),t=s.map(n=>n[0]),i=e[0].slice(1).map((n,r)=>({label:n,data:s.map(o=>+o[r+1].replace(gc,"")||0)}));return[t,i]}function fm(e,s,t=!0){let i=e[0].data.length,n=[];for(let r=0;r<i;++r){let o=[];if(s==="grouped")for(let a of e)o.push([0,a.data[r]]);else if(t){let a=0,l=0,h=e.map(u=>u.data[r]),d=s==="percentage"?99.99/q(h):1;for(let u of h)u<0?(o.push([a,a+u*d]),a+=u*d):(o.push([l,l+u*d]),l+=u*d)}else{let a=0,l=e.map(d=>d.data[r]),h=s==="percentage"?99.99/q(l):1;for(let d of l)o.push([a,a+d*h]),a+=d*h}n.push(o)}return n}var Ie=class{constructor(s){this.makeNew=s;this.stack=[]}get(s){return this.stack[s]||(this.stack[s]=this.makeNew()),this.stack[s]}};var ew=[2,4,5],on=class extends Rs{constructor(t,i,n){super(t,i,n);this.type="pie-chart";this.series=[];this.$sectors=new Ie(()=>c("path",{class:"polygon-tile"}));this.$focussedOutline=c("path",{class:"chart-outline"},this.$el),this.$handle=this.makeHandle("c",r=>{this.chartOptions.width=S(ht(r.length,25),50,300)}),this.$handle.css("cursor","ew-resize"),this.chartOptions.watch(({type:r,width:o})=>{this.updateOutline(o),this.drawChart(r||"pie",o)}),this.makeInPort("main",{tileTypes:["table"],max:1,message:r=>{if(r.type!=="table")return;let o=Jn(r.table).slice(1);if(o.length===0)this.series=[];else{let a=o[0].length>1?1:0;this.series=o.map(l=>Math.abs(+l[a].replace(gc,"")||0)),this.seriesLabels=o.map(l=>l[0])}this.drawChart(this.chartOptions.type,this.chartOptions.width)},disconnect:()=>{this.series=[],this.drawChart(this.chartOptions.type,this.chartOptions.width)}})}updateOutline(t=100){this.path=new H($,t),this.$outline.draw(this.path),this.$handle.setTransform({x:t,y:0}),this.transform(),this.$parent.selection.update()}drawChart(t,i=100){var l,h;this.default=!this.series.length||this.series.every(d=>d===0);let n=this.default?ew:this.series,r=q(n),o=n.map(d=>d/r*D);this.$series.removeChildren();let a=-dt;for(let[d,u]of o.entries()){if(u===0)continue;P(u,D)&&(u=D-.001);let f=this.$sectors.get(d);this.$series.append(f),f.setAttr("fill",this.getSeriesColor(d)),f.setAttr("series-idx",d),f.draw(new qe($,p.fromPolar(a,i),u)),a+=u}t==="donut"&&!this.$donutHole&&(this.$donutHole=c("circle",{class:"donut-hole"},this.$el)),(l=this.$donutHole)==null||l.setAttr("r",i/2),(h=this.$donutHole)==null||h.toggle(t==="donut")}colorSeries(t,i){!this.series.length||this.$sectors.get(i).setAttr("fill",t)}focusSeries(t){this.$focussedOutline.setAttr("d",this.$sectors.get(t).attr("d")),this.$focussedOutline.show()}blur(){super.blur(),this.$focussedOutline.hide()}};I([{type:"select",tileTypes:["pie-chart"],radio:!0,label:"Chart type",options:[{label:"Pie chart",key:"pie",icon:"pie-chart"},{label:"Donut chart",key:"donut",icon:"donut-chart"}],get:e=>e.chartOptions.type||"pie",set:(e,s)=>s.chartOptions.type=e}]);var sw=["A","B","C"],iw=[[10,20,30],[30,10,40],[20,25,10]].map(e=>({label:"",data:e})),ui=class extends Rs{constructor(t,i,n){super(t,i,n);this.type="chart";this.colour=m.darkGrey;this.padding=[0,0,25,30];this.tables=[];this.categories=[];this.series=[];this.$rects=new Ie(()=>c("rect",{class:"polygon-tile"}));this.$areas=new Ie(()=>c("polygon",{opacity:.5}));this.$lines=new Ie(()=>c("polyline",{class:"chart-line"}));this.$points=new Ie(()=>c("circle",{r:5}));this.$background=c("path",{fill:"transparent"},this.$el),this.$el.prepend(this.$background),this.$axes=c("path",{class:"grid-axis",stroke:E(m.darkGrey)},this.$el),this.$labels=c("g",{class:"axis-labels",fill:E(m.darkGrey)},this.$el),this.$foreground=c("g",{},this.$el),this.$handle=this.makeHandle("c",r=>{this.chartOptions.height=Math.max(ht(-r.y,25),100),this.chartOptions.width=Math.max(ht(r.x,25),100)}),this.$handle.css("cursor","nesw-resize"),this.chartOptions.watch(({type:r,layout:o,width:a,height:l})=>{this.updateOutline(a,l),this.drawChart(r,o)}),this.makeInPort("main",{tileTypes:["table"],message:(r,o)=>{if(r.type!=="table")return;let[a,l]=um(r.table),h=this.tables.find(d=>d.cable===o);h?Object.assign(h,{categories:a,series:l}):this.tables.push({cable:o,categories:a,series:l}),this.reconcileSeries(),this.drawChart(this.chartOptions.type,this.chartOptions.layout)},disconnect:r=>{this.tables=this.tables.filter(o=>o.cable!==r),this.reconcileSeries(),this.drawChart(this.chartOptions.type,this.chartOptions.layout)}})}reconcileSeries(){var t,i;this.categories=((t=this.tables[0])==null?void 0:t.categories.slice(0))||[],this.series=((i=this.tables[0])==null?void 0:i.series.map(n=>({label:n.label,data:n.data.slice(0)})))||[];for(let n of this.tables.slice(1)){let r=this.categories.length,o=this.series.length;for(let a of n.series)this.series.push({label:a.label,data:zt(0,r)});for(let[a,l]of n.categories.entries()){let h=this.categories.indexOf(l);if(h<0){this.categories.push(l);for(let d of this.series)d.data.push(0);h=this.categories.length-1}for(let[d,u]of n.series.entries())this.series[o+d].data[h]=u.data[a]}}this.seriesLabels=this.series.map(n=>n.label)}updateOutline(t=400,i=250){this.path=new x($.shift(0,-i),t,i),this.$background.draw(this.path),this.$outline.draw(this.path),this.$handle.setCenter({x:t,y:-i}),this.transform(),this.$parent.selection.update()}getX(t){return(t-this.bounds.xMin)/this.bounds.dx*this.path.w}getY(t){return(t-this.bounds.yMin)/this.bounds.dy*this.path.h}drawChart(t="column",i="grouped"){this.$series.removeChildren(),this.$foreground.removeChildren();let n=["line","area"].includes(t);this.default=!this.series.length;let r=this.default?iw:this.series,o=this.default?sw:this.categories,a=fm(r,i,!n),l=Math.min(0,...a.map(g=>Math.min(...g.map(y=>y[1])))),h=Math.max(0,...a.map(g=>Math.max(...g.map(y=>y[1])))),d=t==="row"?this.path.w:this.path.h,u=As("",d,[l,h],0),f=[0,o.length-1,1],v=n&&!o.some(g=>isNaN(+g)),w=v?o.map(g=>+g):void 0;if(v){let g=Math.min(...w),y=Math.max(...w);f=As("",this.path.w,[g,y],0)}t==="row"&&([u,f]=[f,u]),this.bounds=new kt(f[0],f[1],u[0],u[1]),t==="column"?this.drawColumnChart(a,i):t==="row"?this.drawRowChart(a,i):(w&&([a,w]=this.getSortedData(a,w)),t==="area"&&this.drawAreas(a,w),this.drawLines(a,w),t==="line"&&this.drawPoints(a,w)),this.drawAxes(t,this.path.w,this.path.h,f[2],u[2],v?void 0:o)}getSortedData(t,i){let n=He(i.length).sort((r,o)=>i[r]-i[o]);return[n.map(r=>t[r]),n.map(r=>i[r])]}drawAxes(t,i,n,r,o,a){var d;this.$labels.removeChildren();let l=`M0 0v${-n}M0 0h${i}`;st(0,this.bounds.yMin,this.bounds.yMax)&&(l+=`M0 ${-this.getY(0)}h${i}`),st(0,this.bounds.xMin,this.bounds.xMax)&&(l+=`M${this.getX(0)} 0 v${-n}`);let h=u=>u!=null&&u.startsWith("#")?["\u25C9",u]:[u,""];if(t==="column"&&a){let u=a.length?i/a.length:0;for(let f=0;f<=a.length;++f){let v=f*u;l+=`M${v} 0L${v} 5`;let[w,g]=h(a[f]);c("text",{text:w,fill:g,x:v+u/2,y:21,"text-anchor":"middle"},this.$labels)}}else for(let u=this.bounds.xMin;u<=this.bounds.xMax;u+=r){let f=this.getX(u);l+=`M${f},0v5`;let v=t==="row"?nt(u,4):(d=a==null?void 0:a[u])!=null?d:nt(u,4),[w,g]=h(v);c("text",{text:w,fill:g,x:f,y:21,"text-anchor":"middle"},this.$labels)}if(t==="row"&&a){let u=a.length?n/a.length:0;for(let f=0;f<=a.length;++f){let v=-f*u;l+=`M0 ${v}h-5`;let[w,g]=h(a[f]);c("text",{text:w,fill:g,x:-12,y:v-u/2+5,"text-anchor":"end"},this.$labels)}}else for(let u=this.bounds.yMin;u<=this.bounds.yMax;u+=o){let f=this.getY(u);l+=`M0 ${-f}h-5`;let v=nt(u,4);c("text",{text:v,x:-10,y:-f+5,"text-anchor":"end"},this.$labels)}this.$axes.setAttr("d",l)}drawColumnChart(t,i){let n=t.length,r=t[0].length,o=this.path.w/n,a=o/4,l=o-a,h=i==="grouped";h&&(l/=r);for(let d=0;d<r;++d)for(let u=0;u<n;++u){let f=t[u][d],v=u*o+a/2+(h?d*l:0),w=[-this.getY(f[0]),-this.getY(f[1])],g=Math.abs(w[1]-w[0]);this.drawRect(d*n+u,d,v,Math.min(...w),l,g)}}drawRowChart(t,i){let n=t.length,r=t[0].length,o=this.path.h/n,a=o/4,l=o-a,h=i==="grouped";h&&(l/=r);for(let d=0;d<r;++d)for(let u=0;u<n;++u){let f=t[u][d],v=u*o+a/2+(h?d*l:0),w=[this.getX(f[0]),this.getX(f[1])],g=Math.abs(w[1]-w[0]);this.drawRect(d*n+u,d,Math.min(...w),-(v+l),g,l)}}drawRect(t,i,n,r,o,a){let l=this.$rects.get(t);this.$series.append(l),l.setAttr("fill",this.getSeriesColor(i)),l.setAttr("x",n),l.setAttr("y",r),l.setAttr("width",o),l.setAttr("height",a),l.setAttr("series-idx",i)}drawLines(t,i){let n=t[0].length;for(let r=0;r<n;++r){let o=t.map((l,h)=>{var d;return`${this.getX((d=i==null?void 0:i[h])!=null?d:h)} ${-this.getY(l[r][1])}`}).join(" "),a=this.$lines.get(r);a.setAttr("stroke",this.getSeriesColor(r)),a.setAttr("points",o),a.setAttr("series-idx",r),this.$series.append(a)}}drawPoints(t,i){var o;let n=t[0].length,r=t.length;for(let a=0;a<n;++a)for(let l=0;l<r;++l){let h=this.$points.get(a*r+l);h.setCenter({x:this.getX((o=i==null?void 0:i[l])!=null?o:l),y:-this.getY(t[l][a][1])}),h.setAttr("fill",this.getSeriesColor(a)),h.setAttr("series-idx",a),this.$foreground.append(h)}}drawAreas(t,i){let n=t[0].length;for(let r=0;r<n;++r){let o=t.map((h,d)=>{var u;return`${this.getX((u=i==null?void 0:i[d])!=null?u:d)} ${-this.getY(h[r][1])}`}).join(" "),a=t.map((h,d)=>{var u;return`${this.getX((u=i==null?void 0:i[d])!=null?u:d)} ${-this.getY(h[r][0])}`}).reverse().join(" "),l=this.$areas.get(r);l.setAttr("fill",this.getSeriesColor(r)),l.setAttr("points",o+" "+a),l.setAttr("series-idx",r),this.$series.append(l)}}setColour(t,i){super.setColour(t,i),this.focussedSeries<0&&(this.$labels.setAttr("fill",E(t)),this.$axes.setAttr("stroke",E(t)))}colorSeries(t,i){var n,r,o,a;if(!!this.series.length){(n=this.$lines.stack[i])==null||n.setAttr("stroke",t),(r=this.$areas.stack[i])==null||r.setAttr("stroke",t),(o=this.$areas.stack[i])==null||o.setAttr("fill",t),i===this.focussedSeries&&((a=this.$focussedLine)==null||a.setAttr("stroke",t));for(let l of this.$series.$$(`rect[series-idx="${i}"]`))l.setAttr("fill",t);for(let l of this.$foreground.$$(`circle[series-idx="${i}"]`))l.setAttr("fill",t)}}focusSeries(t){if(this.chartOptions.type==="line"){this.$focussedLine||(this.$focussedLine=c("polyline",{class:"chart-shadow"}),this.$background.insertAfter(this.$focussedLine)),this.$focussedLine.setAttr("points",this.$lines.get(t).attr("points")),this.$focussedLine.setAttr("stroke",this.getSeriesColor(t)),this.$focussedLine.show();return}if(this.$focussedOutline||(this.$focussedOutline=c("path",{class:"chart-outline"},this.$el)),this.chartOptions.type==="area"){let i=gi(this.$areas.get(t).attr("points").split(" "),2),n="M"+i.map(r=>r.join(" ")).join("L")+"Z";this.$focussedOutline.setAttr("d",n)}else{let i=this.$rects.stack.filter(r=>+r.attr("series-idx")===t&&r.css("display")),n="";for(let r of i){let o=+r.attr("height");if(P(0,o))continue;let a=r.attr("width");n+=`M${r.attr("x")} ${r.attr("y")}h${a}v${o}h${-a}Z`}this.$focussedOutline.setAttr("d",n)}this.$focussedOutline.show()}blur(){var t,i;super.blur(),(t=this.$focussedOutline)==null||t.hide(),(i=this.$focussedLine)==null||i.hide()}findClosestElement(t){var r;if(this.chartOptions.type!=="line"&&this.chartOptions.type!=="area")return"";let i=this.relativePosn(t.posn),n=this.$lines.stack.slice(0,this.series.length);return((r=os(n,o=>{let a=gi(o.attr("points").split(" "),2).map(([h,d])=>new p(+h,+d)),l=new le(...a);return p.distance(i,l.project(i))}))==null?void 0:r.attr("series-idx"))||""}};I([{type:"select",tileTypes:["chart"],radio:!0,label:"Chart type",options:[{label:"Column chart",key:"column",icon:"column-chart"},{label:"Row chart",key:"row",icon:"row-chart"},{label:"Line chart",key:"line",icon:"line-chart"},{label:"Area chart",key:"area",icon:"area-chart"}],get:e=>e.chartOptions.type||"column",set:(e,s)=>s.chartOptions.type=e},{type:"select",tileTypes:["chart"],radio:!0,label:"Chart layout",options:[{label:"Grouped",key:"grouped",icon:"chart-grouped"},{label:"Stacked",key:"stacked",icon:"chart-stacked"},{label:"Percentage",key:"percentage",icon:"chart-percentage"}],show:e=>e.some(s=>s.series.length>1),get:e=>e.chartOptions.layout||"grouped",set:(e,s)=>s.chartOptions.layout=e}]);var vc=new Set,es=50,nw=["chart","pie-chart","box-whisker","axes"],pe=class extends T{constructor(t,i,n){super(i,n);this.type="table";this.padding=[0,25,25,0];this.data=[["x","y"],["",""],[""],[""]];this.$handles=[];this.$cells=[];this.aggregation="replace";this.rows=3;this.cols=2;this.columnWidths=[];this.selection={startRow:0,startCol:0,endRow:0,endCol:0};this.options=t,t&&this.initializeData(),this.$foreignObject=c("foreignObject",{x:this.posn.x,y:this.posn.y,width:1,height:1,overflow:"visible"},this.$el),this.$table=c("div",{xmlns:"http://www.w3.org/1999/xhtml",class:"table-tile"},this.$foreignObject),this.$outline=c("path",{class:"outline"},this.$el),this.$selectionOutline=c("rect",{class:"table-selection",hidden:!0,rx:2},this.$el),i.events.listen(this.$el,{down:r=>{this.findSelection(this.relativePosn(r.posn)),this.$hidden.focus()},move:r=>{let o=this.relativePosn(r.startPosn),a=this.relativePosn(r.posn);this.findSelection(o,a)},click:r=>this.focusCell(this.findCellAt(this.relativePosn(r.posn))),blurInput:!1,checkIfActive:()=>!!this.isFocussed}),this.$hidden=c("textarea",{class:"table-hidden"},this.$parent),this.$hidden.on("blur",r=>{var o;(o=G(r.relatedTarget))!=null&&o.hasClass("table-cell")||this.blur()}),this.$hidden.on("paste",r=>{var o;r.preventDefault(),this.paste(((o=r.clipboardData)==null?void 0:o.getData("text").trim())||"")}),this.$hidden.on("cut copy",r=>{var a;let o=this.getSelectionContents();o&&((a=window.navigator.clipboard)==null||a.writeText(o)),r.type==="cut"&&this.removeSelectionContents()}),this.$hidden.onKeyDown("escape",r=>{r.stopPropagation(),this.$hidden.blur(),this.$parent.selection.add(this)}),this.$hidden.onKeyDown("enter",r=>{r.preventDefault(),this.moveDown(!0)}),this.$hidden.onKeyDown("tab",r=>{r.preventDefault(),this.moveRight()}),this.$hidden.onKeyDown("backspace delete",r=>{r.stopPropagation(),this.removeSelectionContents()}),this.linkedTiles&&vc.add(this),this.$handles[0]=this.makeHandle("h",r=>this.updateCols(r.x)),this.$handles[1]=this.makeHandle("v",r=>this.updateRows(r.y)),this.$handles[1].css("cursor","ns-resize"),this.setColour("#bbb"),this.buildTable()}delete(){super.delete(),this.linkedTiles&&vc.delete(this)}setColour(t){this.colour=t,this.$table.css("border-color",t);for(let n of this.$cells)n.css("border-color",t);let i=F.mix(t,"#fff",.6);this.$table.css("background",i.rgb),this.$table.setClass("contrast",i.brightness<128),this.emitMessage("main",{type:"table",table:this.rawData})}hasData(t=1){if(this.cols<t)return!1;let i=He(t);return this.data.some((n,r)=>r>0&&i.every(o=>n[o]))}transpose(){for(let t=0;t<this.data.length;t++)for(let i=0;i<t;i++)[this.data[t][i],this.data[i][t]]=[this.data[i][t],this.data[t][i]];[this.rows,this.cols]=[this.cols,this.rows],this.updateData(),this.buildTable()}updateOutline(){let t=_(this.columnWidths),i=this.rows*es;this.$foreignObject.setAttr("width",t||1),this.$foreignObject.setAttr("height",i||1);let n=new x($,t,i);this.$outline.draw(n),this.path=n.shift(.5),this.$handles[0].setTransform({x:t,y:0}),this.$handles[1].setTransform({x:0,y:i})}initializeData(){let t=Gs(this.options,{});Array.isArray(t)&&(t={data:t}),this.data=t.data||[["",""]],this.linkedTiles=t.links||[],this.linkedTiles&&(this.aggregation=t.aggregation||"replace"),this.rows=this.data.length,this.cols=this.data[0].length}updateCols(t){let i=_(this.columnWidths),n=this.columnWidths[this.columnWidths.length-2]||0;t>i+es?(this.cols+=1,this.buildTable()):this.cols>1&&t<n+es&&(this.cols-=1,this.buildTable())}updateRows(t){let i=S(Math.round(t/es),1,100);i!==this.rows&&(this.rows=i,this.buildTable())}resizeColumns(){this.columnWidths=ws(B(t=>this.$cells[t].width,this.cols)),this.drawSelection()}makeCell(){let t=this.$cells.length,i=c("div",{class:"table-cell",contenteditable:!0,"cell-index":t},this.$table);i.css("border-color",this.colour),this.$cells.push(i);let n=!1;i.on("focus",()=>n=!0),i.on("pointerdown",o=>{n&&o.stopPropagation()}),i.on("blur",o=>{n=!1,this.data[this.cellPosn(i)[0]][this.cellPosn(i)[1]]=i.text,this.updateData();let a=G(o.relatedTarget);!(a!=null&&a.hasClass("table-cell"))&&!(a!=null&&a.hasClass("table-hidden"))&&this.blur()});let r=i.width;i.on("change keyup input",()=>{let o=r;r=i.width,o!==r&&this.resizeColumns()}),i.on("paste",o=>{var l;let a=((l=o.clipboardData)==null?void 0:l.getData("text").trim())||"";(a.includes(`
`)||a.includes("	"))&&(o.preventDefault(),this.paste(a))}),i.onKeyDown("escape",o=>{o.stopPropagation(),i.blur(),this.$parent.selection.add(this)}),i.onKeyDown("enter",o=>{o.preventDefault(),this.$parent.events.shiftKey?this.moveUp():this.moveDown(!0)}),i.onKeyDown("tab",o=>{o.preventDefault(),this.$parent.events.shiftKey?this.moveLeft():this.moveRight()})}cellPosn(t){let i=parseInt(t.attr("cell-index"));return[Math.floor(i/this.cols),i%this.cols]}buildTable(){this.$table.css("grid-template-columns",`repeat(${this.cols}, max-content)`);let t=this.cols*this.rows;for(let i=this.$cells.length;i<t;++i)this.makeCell();for(let i=t;i<this.$cells.length;++i)this.$cells[i].hide();for(let i=0;i<this.rows;++i)for(let n=0;n<this.cols;++n){this.data[i]||(this.data[i]=[]),this.data[i][n]||(this.data[i][n]="");let r=this.$cells[i*this.cols+n];r.show();let o=this.data[i][n];o.startsWith("#")?r.html=`<span class="table-color" style="background:${o}"></span>`:r.text=o,r.setClass("header",!i)}this.resizeColumns(),this.updateOutline(),this.makeOutPort("main",{tileTypes:nw,location:new p(_(this.columnWidths),this.rows*es/2),connect:i=>i.enqueueMessage({type:"table",table:this.rawData})}),this.updateData(),this.transform(),this.$parent.selection.update()}paste(t){let[i,n]=[this.selection.startRow,this.selection.startCol],r=t.trim().split(`
`).map(o=>o.split("	"));this.rows=Math.max(this.rows,i+r.length),this.cols=Math.max(this.cols,n+Math.max(...r.map(o=>o.length)));for(let o=0;o<r.length;++o)for(let a=0;a<r[o].length;++a)this.data[i+o]||(this.data[i+o]=[]),this.data[i+o][n+a]=r[o][a];this.updateSelection(n,i,n+r[0].length-1,i+r.length-1),this.buildTable()}moveLeft(){let[t,i]=[this.selection.startRow,this.selection.startCol];this.focusCell(this.$cells[t*this.cols+i-1]||this.$cells[this.$cells.length-1])}moveRight(){let[t,i]=[this.selection.startRow,this.selection.startCol];this.focusCell(this.$cells[t*this.cols+i+1]||this.$cells[0])}moveUp(){let[t,i]=[this.selection.startRow,this.selection.startCol],n=t===0?this.rows:t;this.focusCell(this.$cells[(n-1)*this.cols+i])}moveDown(t=!0){let[i,n]=[this.selection.startRow,this.selection.startCol];t&&this.rows<=i+1&&(this.data[i][n]=this.$cells[i*this.cols+n].text,this.rows+=1,this.buildTable()),this.focusCell(this.$cells[(i+1)*this.cols+n])}doubleClick(t){this.focus(),this.focusCell(this.findCellAt(this.relativePosn(t.posn)))}focus(){this.isFocussed||(super.focus(),this.initialOptions=this.options,this.$table.addClass("active"),this.$selectionOutline.show())}findCellAt(t){let i=this.columnWidths.findIndex(r=>r>t.x),n=Math.floor(t.y/es);return this.$cells[this.cols*n+i]}focusCell(t){var o,a;let[i,n]=this.cellPosn(t);if(this.data[i][n].startsWith("#"))return;this.updateSelection(n,i),t.focus();let r=document.createRange();r.selectNodeContents(t._el),(o=document.getSelection())==null||o.removeAllRanges(),(a=document.getSelection())==null||a.addRange(r)}blur(){!this.isFocussed||(super.blur(),this.updateData(),this.updateOutline(),this.transform(),this.$table.removeClass("active"),this.$selectionOutline.hide(),this.$parent.selection.add(this),this.initialOptions!==this.options&&this.$parent.change({changed:[this]}))}get rawData(){return this.data.slice(0,this.rows).map(t=>t.slice(0,this.cols))}updateData(){let t=this.rawData;this.options=JSON.stringify({data:t,links:this.linkedTiles,aggregation:this.aggregation}),this.initialOptions!==this.options&&this.emitMessage("main",{type:"table",table:t})}findSelection(t,i=t){let n=Math.floor(Math.min(t.y,i.y)/es),r=Math.ceil(Math.max(t.y,i.y)/es)-1,o=this.columnWidths.findIndex(l=>l>Math.min(t.x,i.x)),a=this.columnWidths.findIndex(l=>l>Math.max(t.x,i.x));a<0&&(a=this.cols),this.updateSelection(o,n,a,r)}updateSelection(t,i,n=t,r=i){var o,a,l,h;t=S(t,0,this.cols-1),n=S(n,t,this.cols-1),i=S(i,0,this.rows-1),r=S(r,i,this.rows-1),!(((o=this.selection)==null?void 0:o.startRow)===i&&((a=this.selection)==null?void 0:a.endRow)===r&&((l=this.selection)==null?void 0:l.startCol)===t&&((h=this.selection)==null?void 0:h.endCol)===n)&&(this.selection={startCol:t,startRow:i,endCol:n,endRow:r},this.drawSelection())}drawSelection(){if(!this.selection)return;let t=this.columnWidths[this.selection.startCol-1]||0,i=new p(t,this.selection.startRow*es),n=this.columnWidths[this.selection.endCol]-t||0,r=(this.selection.endRow+1-this.selection.startRow)*es;this.$selectionOutline.setRect(new x(i,n+1,r+1))}getSelectionContents(){let t="",i=this.selection;if(!i)return t;for(let n=i.startRow;n<=i.endRow;++n){for(let r=i.startCol;r<=i.endCol;++r)r>i.startCol&&(t+="	"),t+=this.data[n][r];t+=`
`}return t}removeSelectionContents(){let t=this.selection;if(!!t)for(let i=t.startRow;i<=t.endRow;++i)for(let n=t.startCol;n<=t.endCol;++n)this.data[i][n]="",this.$cells[i*this.cols+n].text=""}linkToChart(t){let i=t.inPorts.get("main"),n=this.outPorts.get("main"),r=new Zt(n,i);n.addCable(r)}static*updateAggregations(t){for(let i of vc){let n=t.filter(r=>{var o;return(o=i.linkedTiles)==null?void 0:o.includes(r)});!n.length||(i.updateAggregation(n),yield i)}}static getAggregationData(t,i){let n=t.map(o=>i.tiles.get(o)).filter(o=>o),r=new Map;for(let o of n){let a=o.aggregationCategories.map(h=>h.toString());for(let h of a)r.has(h)||r.set(h,0);let l=o.aggregationCategory.toString();r.set(l,(r.get(l)||0)+1)}return r}static aggregateReplace(t,i){let n=pe.getAggregationData(t,i),r=[["Value","Count"]];for(let[o,a]of n.entries())r.push([o,a.toString()]);return r}aggregateCumulative(t){let i=t||this.linkedTiles,n=pe.getAggregationData(i,this.$parent),r=this.data.length?this.data:[["Value","Count"]],o=r.map(a=>a[0]);for(let[a,l]of n.entries()){let h=o.indexOf(a);h>0?r[h][1]=(+r[h][1]+l).toString():r.push([a,l.toString()])}return r}aggregateTimeSeries(){let t=pe.getAggregationData(this.linkedTiles,this.$parent),i=this.data.length?this.data:[["Time"]],n=i[0].map((r,o)=>o?"0":i.length.toString());for(let[r,o]of t.entries()){let a=i[0].indexOf(r);a>0?n[a]=(+n[a]+o).toString():(i[0].push(r),n.push(o.toString()))}return i.push(n),i}updateAggregation(t){this.data=this.aggregation==="replace"?pe.aggregateReplace(this.linkedTiles,this.$parent):this.aggregation==="cumulative"?this.aggregateCumulative(t):this.aggregateTimeSeries(),this.rows=this.data.length,this.cols=this.data[0].length,this.buildTable()}static makeThumbnail(t,i){let n=c("svg",{width:110,height:85},i),r=(o,a,l,h,d,u="")=>{c("rect",{x:5+o,y:5+a,width:l,height:h,fill:d,class:"polygon-tile"},n),u&&c("text",{x:25+5/2+o,y:25-5/2+a,text:u,fill:"white"},n)};for(let o=0;o<2;++o)for(let a=0;a<3;++a)r(50*o,25*a,50,25,a?"#ffffff33":"#ffffff66",a?"":o?"y":"x")}};function Ha(e,s){for(let n of e)n.linkToChart(s);let t=we(...e.map(n=>n.transformed)),i=vn(s.path)?s.path.p:s.path.c.shift(-s.path.r);s.setTransform(t.p.subtract(i).shift(t.w+100,0)),s.$parent.change({added:[s],changed:e})}I([{type:"button",tileTypes:["table"],label:"Scatter Plot",icon:"scatter",show:e=>e.some(s=>s.hasData(2)),click:(e,s)=>{let t=Math.min(...e.map(l=>Math.min(...l.data.map((h,d)=>d&&+h[0]||0)))),i=Math.max(...e.map(l=>Math.max(...l.data.map((h,d)=>d&&+h[0]||0)))),n=Math.min(...e.map(l=>Math.min(...l.data.map((h,d)=>d&&+h[1]||0)))),r=Math.max(...e.map(l=>Math.max(...l.data.map((h,d)=>d&&+h[1]||0)))),o=Math.ceil((Math.max(-t,i)+1)/5),a=Math.ceil((Math.max(-n,r)+1)/5);Ha(e,new rn(`${t<0?-5:0}:${o}:5:${n<0?-5:0}:${a}:5`,s))}},{type:"button",tileTypes:["table"],label:"Column Chart",icon:"column-chart",show:e=>e.some(s=>s.hasData()),click:(e,s)=>Ha(e,new ui("",s))},{type:"button",tileTypes:["table"],label:"Area Chart",icon:"area-chart",show:e=>e.some(s=>s.hasData()),click:(e,s)=>Ha(e,new ui('{"type":"area"}',s))},{type:"button",tileTypes:["table"],label:"Pie Chart",icon:"pie-chart",show:e=>e.length===1&&e[0].hasData(),click:(e,s)=>Ha(e,new on("",s))},{type:"button",tileTypes:["table"],label:"Transpose",click:(e,s)=>{for(let t of e)t.transpose();s.change({changed:e})}},{type:"select",tileTypes:["table"],label:"Aggregation",advanced:!0,show:e=>e.every(s=>s.linkedTiles),options:[{label:"Replace",key:"replace"},{label:"Cumulative",key:"cumulative"},{label:"Time series",key:"timeseries"}],get:e=>e.aggregation,set:(e,s)=>{s.aggregation=e,s.data=[],s.updateAggregation(),s.$parent.change({changed:[s]})}}]);var $e=19,tr=[[],[[0,0]],[[-.9,-.9],[.9,.9]],[[-1,-1],[0,0],[1,1]],[[-.9,-.9],[.9,-.9],[.9,.9],[-.9,.9]],[[-1,-1],[1,-1],[1,1],[-1,1],[0,0]],[[-.9,-1.1],[-.9,0],[-.9,1.1],[.9,-1.1],[.9,0],[.9,1.1]],[[0,-1.2],[0,0],[0,1.2],[1,-.6],[1,.6],[-1,-.6],[-1,.6]],[[0,-1.1],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]],[[0,-1.1],[0,0],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]]],rw=new x(new p(-$e,-$e),2*$e,2*$e),Ba=[[0,0],[0,dt],[dt,0],[-dt,0],[0,-dt],[Math.PI,0]],wc=["#656073",m.teal,m.blue,m.purple,m.red,m.orange,m.yellow,m.lime,m.green,m.teal],ee=class extends T{constructor(t,i,n){super(i,n);this.type="dice";this.isAnimating=!1;this.options=t;let[r,o]=t.split(":");this.faces=(o||"1,2,3,4,5,6").split(",").map(l=>+l);let a=this.faces.map(l=>{let h=new fe(rw,{class:"dice-face",fill:wc[l],stroke:wc[l]}),d=tr[+l].map(u=>new fe(new H(new p(u[0]*$e/2,u[1]*$e/2),4),{class:"dice-dot"}));for(let u of d)u.transform.translate(0,0,2);return new ye([h,...d])});a[0].transform.translate(0,0,$e),a[1].transform.translate(-$e,0,0).rotate(0,-dt),a[2].transform.translate(0,$e,0).rotate(-dt,0),a[3].transform.translate(0,-$e,0).rotate(dt,0),a[4].transform.translate($e,0,0).rotate(0,dt),a[5].transform.translate(0,0,-$e).rotate(0,Math.PI),this.die=new ye(a,{},this.$el),this.die.sorting=!0,this.setValue(+r||J.integer(1,6)),this.path=new x(new p(-25,-25),50,50),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}get aggregationCategory(){return this.value}get aggregationCategories(){return this.faces}setColour(t){this.colour=t==="#000"||t==="#000000"?"":t.slice(0,7);for(let i of this.die.children)i.children[0].color=E(this.colour);this.die.render()}setValue(t){this.side!==t&&(this.side=t,this.value=this.faces[t-1],this.options=`${t}:${this.faces}`,this.die.transform.clear().rotate(...Ba[t-1]),this.die.render())}roll(t=2e3){return R(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("roll");let i=J.integer(1,6),n=Ba[this.side-1],r=4*Math.PI+Ba[i-1][0]-n[0],o=4*Math.PI+Ba[i-1][1]-n[1];yield K(a=>{let l=ot("sine",a);this.die.transform.clear().translate(0,0,4*l*(1-l)*$e/2).rotate(n[0]+l*r,n[1]+l*o),this.die.render()},t).promise,this.setValue(i),this.isAnimating=!1})}static makeThumbnail(t,i){if(i.data.thumb==="net"){let n=c("svg",{width:58,height:76},i),r=t.split(":")[1].split(",").map(l=>+l),o=i.data.colour,a=[new p(20,2),new p(20,20),new p(20,38),new p(20,56),new p(2,20),new p(38,20)];for(let[l,h]of a.entries()){let d=o||wc[+r[l]];c("path",{path:new x(h,18,18),class:"polygon-tile",fill:d},n);for(let u of tr[r[l]])c("circle",{cx:h.x+9+u[0]*4.5,cy:h.y+9+u[1]*4.5,r:1.8,class:"dice-dot"},n)}}else{let n=c("svg",{width:60,height:60},i);c("rect",{x:6,y:6,width:48,height:48,rx:6,class:"polygon-tile",fill:m.orange},n);for(let r of tr[5])c("circle",{cx:30+r[0]*12,cy:30+r[1]*12,r:5,class:"dice-dot"},n)}}doubleClick(){ee.roll([this],this.$parent)}static roll(t,i){return R(this,null,function*(){i.selection.clear(),yield Promise.all(t.map(r=>r.roll())),i.selection.tiles.size||i.selection.select(t);let n=pe.updateAggregations(t.map(r=>r.id));i.change({changed:[...t,...n]})})}};I([{type:"button",tileTypes:["dice","coin","spinner","custom-spinner","polyhedral-dice","random"],label:"Randomize",labelFn:(e,s)=>ur(s,t=>t==="coin")?"Flip":ur(s,t=>t.endsWith("dice"))?"Roll":ur(s,t=>t.endsWith("spinner"))?"Spin":"Randomize",click:(e,s)=>ee.roll(e,s)}]);I([{type:"button",tileTypes:["dice","coin","spinner","custom-spinner","random","polyhedral-dice"],label:"Tabulate",click:(e,s)=>{let t=e.map(a=>a.id),i=pe.aggregateReplace(t,s),n=JSON.stringify({data:i,links:t}),r=new pe(n,s),o=we(...e.map(a=>a.transformed));r.setTransform(o.p.shift(o.w+50,0)),s.change({added:[r]})}}]);var ow={1:"M-1.92 3.18V2.24H-0.5V-1.94H-1.67V-2.66C-1.15-2.74-0.65-2.92-0.2-3.18H0.66V2.24H1.91V3.18Z",2:"M-2.13 3.24V2.57C-1.04 1.37 0.53 0.37 0.75-1.23 0.78-2.65-0.89-2.56-1.53-1.62L-2.18-2.26C-1.23-3.5 1.07-3.69 1.72-2.09 2.36-0.32 0.62 1.1-0.44 2.33 0.43 2.26 1.3 2.24 2.18 2.26V3.24Z",3:"M-0.04 3.3C-0.86 3.34-1.65 3.01-2.2 2.4L-1.65 1.66C0.56 3.88 2.73 0.26-0.84 0.32V-0.52C2.13-0.44 0.64-3.74-1.4-1.79L-1.99-2.5C-1-3.49 1.1-3.71 1.83-2.34 2.03-1.92 2.04-1.45 1.85-1.03 1.67-0.61 1.31-0.29 0.87-0.16V-0.12C3.22 0.57 2.17 3.46-0.04 3.3Z",4:"M0.46 3.18V1.54H-2.34V0.76L0.18-3.18H1.55V0.65H2.35V1.54H1.55V3.18ZM-1.21 0.65H0.46C0.47-0.13 0.45-1.34 0.51-2.11H0.47C0.31-1.77 0.14-1.46-0.05-1.12Z",5:"M-0.03 3.24C-0.84 3.26-1.63 2.94-2.2 2.36L-1.67 1.62C-0.91 2.53 1.08 2.63 1.05 1.08 1.11-0.14-0.33-0.42-1.14 0.25L-1.69-0.1-1.5-3.24H1.9V-2.27H-0.5L-0.63-0.73C2.69-2.07 3.34 3.22-0.03 3.24Z",6:"M-0.78 3.3C-3.49 3.25-3.6-0.85-2.32-2.48-1.9-2.98-1.28-3.28-0.63-3.3 0.03-3.32 0.66-3.06 1.11-2.58L0.49-1.88C-0.96-3.24-2.1-1.59-2.02-0.01-1.71-0.43-1.23-0.7-0.72-0.75-0.2-0.8 0.32-0.63 0.71-0.28 1.85 0.94 1.02 3.38-0.78 3.3ZM-0.8 2.42C0.17 2.46 0.41 0.95-0.11 0.36-0.41 0.13-0.79 0.04-1.16 0.13-1.52 0.22-1.83 0.47-1.99 0.81-1.88 1.7-1.63 2.37-0.8 2.42ZM2.38 3.3C1.97 3.27 1.64 2.93 1.64 2.52 1.64 2.1 1.97 1.76 2.38 1.74 3.35 1.7 3.35 3.33 2.38 3.3Z",7:"M-0.89 3.18C-0.9 1.24-0.28-0.65 0.87-2.21H-2.13V-3.18H2.13V-2.48C0.84-0.89 0.17 1.13 0.28 3.18Z",8:"M0.01 3.3C-2.15 3.38-3.04 0.92-1.01-0.08V-0.12C-1.71-0.52-2.04-1.36-1.79-2.14-1.54-2.91-0.77-3.4 0.03-3.3 0.83-3.37 1.57-2.88 1.82-2.12 2.06-1.36 1.75-0.53 1.05-0.12V-0.08C3.03 0.9 2.12 3.43 0.01 3.3ZM0.03 2.48C0.38 2.52 0.72 2.36 0.91 2.06 1.11 1.77 1.13 1.39 0.96 1.08 0.57 0.68 0.08 0.38-0.46 0.24-1.49 0.87-1.34 2.51 0.02 2.48ZM0.43-0.41C1.17-1 1.18-2.49 0.02-2.48-0.3-2.49-0.59-2.33-0.75-2.06-0.9-1.79-0.91-1.46-0.75-1.19-0.46-0.81-0.04-0.54 0.42-0.41Z",9:"M-1.33 3.3C-1.97 3.31-2.59 3.05-3.03 2.58L-2.41 1.88C-0.96 3.23 0.2 1.59 0.11 0.01-0.27 0.53-0.9 0.81-1.55 0.74-2.19 0.66-2.74 0.25-2.99-0.35-3.27-0.99-3.21-1.72-2.84-2.31-2.46-2.9-1.83-3.27-1.13-3.3 2.17-3.26 1.88 3.36-1.33 3.3ZM-1.06-0.08C-0.58-0.12-0.15-0.39 0.08-0.82 0.07-1.94-0.89-2.96-1.79-2.11-2.32-1.48-2.12 0.01-1.06-0.08ZM2.41 3.3C2 3.28 1.67 2.94 1.67 2.52 1.67 2.11 2 1.76 2.41 1.74 3.38 1.71 3.38 3.33 2.41 3.3Z",10:"M-4.48 3.18V2.24H-3.06V-1.94H-4.23V-2.66C-3.71-2.74-3.21-2.92-2.76-3.18H-1.9V2.24H-0.65V3.18ZM2.27 3.3C-0.66 3.38-0.69-3.4 2.27-3.3 5.23-3.39 5.2 3.38 2.27 3.3ZM2.27 2.4C3.71 2.54 3.74-2.56 2.27-2.4 0.8-2.56 0.83 2.53 2.27 2.4Z",11:"M-4.38 3.18V2.24H-2.96V-1.94H-4.13V-2.66C-3.61-2.74-3.11-2.92-2.66-3.18H-1.8V2.24H-0.55V3.18ZM0.55 3.18V2.24H1.97V-1.94H0.8V-2.66C1.32-2.74 1.82-2.92 2.27-3.18H3.13V2.24H4.38V3.18Z",12:"M-4.43 3.24V2.3H-3.01V-1.88H-4.18V-2.6C-3.67-2.68-3.17-2.86-2.71-3.12H-1.85V2.3H-0.6V3.24ZM0.13 3.24V2.57C1.22 1.37 2.79 0.37 3.01-1.23 3.04-2.65 1.37-2.56 0.73-1.62L0.09-2.26C1.03-3.5 3.33-3.69 3.98-2.09 4.62-0.32 2.88 1.1 1.82 2.33 2.69 2.26 3.56 2.24 4.43 2.26V3.24Z",13:"M-4.41 3.18V2.24H-2.99V-1.94H-4.16V-2.66C-3.65-2.74-3.15-2.92-2.69-3.18H-1.83V2.24H-0.58V3.18ZM2.18 3.3C1.36 3.34 0.57 3.01 0.02 2.4L0.57 1.66C2.78 3.88 4.94 0.26 1.38 0.32V-0.52C4.34-0.44 2.86-3.74 0.82-1.79L0.23-2.5C1.21-3.49 3.31-3.71 4.04-2.34 4.24-1.92 4.25-1.45 4.07-1.03 3.88-0.61 3.53-0.29 3.09-0.16V-0.12C5.43 0.57 4.38 3.46 2.18 3.3Z",14:"M-4.53 3.18V2.24H-3.11V-1.94H-4.28V-2.66C-3.76-2.74-3.26-2.92-2.81-3.18H-1.95V2.24H-0.7V3.18ZM2.65 3.18V1.54H-0.16V0.76L2.36-3.18H3.73V0.65H4.53V1.54H3.73V3.18ZM0.98 0.65H2.65C2.65-0.13 2.64-1.34 2.7-2.11H2.66C2.5-1.77 2.32-1.46 2.14-1.12Z",15:"M-4.41 3.12V2.18H-2.99V-2H-4.16V-2.72C-3.65-2.8-3.15-2.98-2.69-3.24H-1.83V2.18H-0.58V3.12ZM2.19 3.24C1.37 3.26 0.59 2.94 0.02 2.36L0.55 1.62C1.3 2.53 3.29 2.63 3.27 1.08 3.33-0.14 1.88-0.42 1.07 0.25L0.52-0.1 0.71-3.24H4.11V-2.27H1.72L1.59-0.73C4.9-2.06 5.56 3.22 2.18 3.24Z",16:"M-4.47 3.18V2.24H-3.05V-1.94H-4.22V-2.66C-3.71-2.74-3.21-2.92-2.75-3.18H-1.89V2.24H-0.64V3.18ZM2.46 3.3C-0.24 3.25-0.35-0.85 0.92-2.48 1.34-2.98 1.96-3.28 2.61-3.3 3.27-3.32 3.9-3.06 4.35-2.58L3.73-1.88C2.29-3.24 1.14-1.59 1.22-0.01 1.54-0.43 2.01-0.7 2.53-0.75 3.05-0.8 3.56-0.63 3.95-0.28 5.09 0.94 4.26 3.39 2.46 3.3ZM2.44 2.42C3.41 2.46 3.65 0.95 3.13 0.36 2.84 0.13 2.45 0.04 2.09 0.13 1.72 0.22 1.41 0.47 1.25 0.81 1.36 1.7 1.61 2.37 2.45 2.42Z",17:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM1.42 3.18C1.42 1.24 2.04-0.65 3.19-2.21H0.18V-3.18H4.45V-2.48C3.15-0.89 2.49 1.13 2.59 3.18Z",18:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM2.31 3.3C0.16 3.38-0.74 0.92 1.3-0.08V-0.12C0.59-0.52 0.26-1.36 0.51-2.14 0.77-2.91 1.53-3.4 2.34-3.3 3.14-3.37 3.88-2.88 4.12-2.12 4.37-1.36 4.05-0.53 3.36-0.12V-0.08C5.33 0.9 4.42 3.43 2.31 3.3ZM2.33 2.48C2.68 2.52 3.02 2.36 3.22 2.06 3.41 1.77 3.43 1.39 3.26 1.08 2.88 0.68 2.39 0.38 1.85 0.24 0.82 0.87 0.96 2.51 2.33 2.48ZM2.73-0.41C3.47-1 3.48-2.49 2.32-2.48 2.01-2.49 1.72-2.33 1.56-2.06 1.4-1.79 1.39-1.46 1.55-1.19 1.85-0.81 2.26-0.54 2.73-0.41Z",19:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM1.91 3.3C1.27 3.31 0.65 3.05 0.21 2.58L0.83 1.88C2.28 3.23 3.44 1.59 3.35 0.01 2.97 0.53 2.33 0.81 1.69 0.74 1.05 0.66 0.5 0.25 0.24-0.35-0.03-0.99 0.03-1.73 0.4-2.31 0.77-2.9 1.41-3.27 2.11-3.3 5.4-3.26 5.12 3.36 1.91 3.3ZM2.18-0.08C2.66-0.12 3.09-0.39 3.32-0.82 3.3-1.94 2.35-2.96 1.45-2.11 0.91-1.48 1.12 0.01 2.18-0.08Z",20:"M-4.63 3.18V2.51C-3.54 1.31-1.98 0.31-1.75-1.29-1.73-2.71-3.4-2.62-4.04-1.68L-4.68-2.32C-3.74-3.56-1.44-3.75-0.79-2.15-0.15-0.38-1.88 1.04-2.95 2.27-2.08 2.2-1.21 2.18-0.33 2.2V3.18ZM2.48 3.3C-0.45 3.38-0.48-3.4 2.48-3.3 5.43-3.39 5.4 3.38 2.48 3.3ZM2.48 2.4C3.92 2.54 3.95-2.56 2.48-2.4 1.01-2.56 1.03 2.53 2.48 2.4Z"},yc=40,bc={4:{net:Ho,meshScale:.9,numberScale:.08,colour:m.red,thumbnailY:8,renderOptions:{fov:180,hideBackface:!0}},6:{net:Bo,meshScale:.744,numberScale:.1,colour:m.yellow,renderOptions:{fov:120,hideBackface:!0}},8:{net:qo,meshScale:.85,numberScale:.07,colour:m.green,thumbnailY:3,renderOptions:{fov:180,hideBackface:!0}},10:{net:qu,meshScale:1,numberScale:.06,numberShift:2,colour:m.teal,renderOptions:{fov:180}},12:{net:zo,meshScale:.6,numberScale:.1,colour:m.blue,renderOptions:{fov:!1,hideBackface:!0}},20:{net:Fo,meshScale:.6,numberScale:.06,colour:m.purple,renderOptions:{fov:!1,hideBackface:!0}}};function mm(e,s){let t=bc[e],i=[],n=Dn(t.net,o=>{let a=new fe(o.shape,{class:"polygon-tile",style:"stroke-width: 0.5"});a.color=E(t.colour),i.push(a);let l=new fe(ow[i.length],{class:"dice-dot"});return l.transform.scale(X.all(t.numberScale)),t.numberShift&&l.transform.translate(0,t.numberShift,0),new ye([a,l])}).group,r=n.children[0].children.map(o=>{let a=o.getTransformed(X.zero).fixFloat(),l=0;(a.x!==0||a.z!==0)&&(l=Math.atan2(a.z,a.x)-dt);let h=a.transform(pt.rotateY(l)),d=0;(h.y!==0||h.z!==0)&&(d=Math.atan2(h.y,h.z));let u=At.product(pt.rotateX(d),pt.rotateY(l)),f=o.getTransformed(new X(1,0,0)).transform(u).fixFloat().xy,v=Math.atan2(-f.y,f.x);return new X(d,l,v)});return s.append(n.$el),{die:n,faces:i,rotationOptions:r}}var qa=class extends T{constructor(t,i,n){super(i,n);this.type="polyhedral-dice";this.isAnimating=!1;this.options=t;let[r,o]=t.split(":").map(h=>+h);this.faceCount=o,this.definition=bc[o];let a=mm(o,this.$el);this.faces=a.faces,this.die=a.die,this.rotationOptions=a.rotationOptions,r>o&&(r=1),this.setValue(+r||J.integer(1,o));let l=this.die.getProjectedVertices(this.definition.renderOptions);this.path=M.convexHull(...l),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}setColour(t){super.setColour(t);for(let i of this.faces)i.color=E(this.colour);this.die.render(this.definition.renderOptions)}setValue(t){if(this.value===t)return;this.value=t,this.options=`${t}:${this.faceCount}`;let i=this.rotationOptions[this.value-1];this.die.transform.matrix=At.product(pt.rotateZ(i.z),pt.rotateX(i.x),pt.rotateY(i.y),pt.scaleAll(this.definition.meshScale*yc)),this.die.render(this.definition.renderOptions)}get aggregationCategory(){return this.value}get aggregationCategories(){return B(t=>t+1,this.faceCount)}roll(t=2e3){return R(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("roll");let i=Math.floor(Math.random()*this.faceCount),n=this.rotationOptions[this.value-1],r=this.rotationOptions[i];yield K(o=>{o=ot("sine",o),this.die.transform.matrix=At.product(pt.translate(new X(0,0,4*o*(1-o)*yc/2)),pt.rotateZ(n.z+(r.z-n.z)*o),pt.rotateX(n.x+(r.x-n.x+4*Math.PI)*o),pt.rotateY(n.y+(r.y-n.y+4*Math.PI)*o),pt.scaleAll(this.definition.meshScale*yc)),this.die.render(this.definition.renderOptions)},t).promise,this.setValue(i+1),this.isAnimating=!1})}doubleClick(){ee.roll([this],this.$parent)}static makeThumbnail(t,i){let n=+t.split(":")[1],r=bc[n],o=c("svg",{width:70,height:70},i),a=c("g",{transform:`translate(35, ${35+(r.thumbnailY||0)})`},o),l=mm(n,a),h=l.rotationOptions[l.rotationOptions.length-1];l.die.transform.matrix=At.product(pt.rotateZ(h.z),pt.rotateX(h.x),pt.rotateY(h.y),pt.scaleAll(r.meshScale*32)),l.die.render()}};var aw="M0 7.4L8.6 12L7 2.4L13.9 -4.4L4.3 -5.8L0 -14.5L-4.3 -5.8L-13.9 -4.4L-7 2.4L-8.6 12L0 7.4",vm="M12.9,9.7C13.9,3,4,5.3,4,1.2H4C9.4-3.7,7.6-14,.1-14.3S-9.3-3.9-4,1.3c-.1,3.8-9.8,1.9-8.9,8.4h0C-5.5,13.2,5.2,13.2,12.9,9.7Z",gm=23,lw=[m.red,m.blue],hw=[aw,vm],za=class extends T{constructor(t,i,n){super(i,n);this.type="coin";this.isAnimating=!1;let r=new H($,gm),o=lw.map((a,l)=>{let h=new fe(r,{class:"dice-face",fill:a,stroke:a}),d=new fe(hw[l],{class:"dice-dot"});return d.transform.translate(0,0,1),new ye([h,d])});o[0].transform.translate(0,0,.5),o[1].transform.rotate(Math.PI,0,0).translate(0,0,-.5),this.coin=new ye(o,{},this.$el),this.coin.sorting=!0,this.setValue(t?+t:J.integer(0,1)),this.path=new H($,25),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}get aggregationCategory(){return this.value===1?"Heads":"Tails"}get aggregationCategories(){return["Heads","Tails"]}setValue(t){this.value!==t&&(this.value=t,this.options=""+t,this.coin.transform.clear().rotate(t?Math.PI:0,0,0),this.coin.render())}setColour(t){this.colour=t.slice(0,7)}roll(t=2e3){return R(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("coinToss");let i=J.integer(0,1),n=this.value?Math.PI:0,r=6*Math.PI+(i?Math.PI:0)-n;yield K(o=>{let a=ot("sine",o);this.coin.transform.clear().translate(0,0,4*a*(1-a)*gm).rotate(n+a*r,.4*Math.sin(a*8*Math.PI),0),this.coin.render()},t).promise,this.setValue(i),this.isAnimating=!1})}doubleClick(){ee.roll([this],this.$parent)}static makeThumbnail(t,i){let n=c("svg",{width:60,height:60},i);c("circle",{cx:30,cy:30,r:28,class:"polygon-tile",fill:m.blue},n),c("path",{d:vm,class:"dice-dot"},n).setTransform({x:30,y:30},0,1.2)}};var $c=75,Fa="M9.8-39.1,0-63-9.8-39.1-3-43V60a2.9,2.9,0,0,0,3,3,2.9,2.9,0,0,0,3-3V-43Z";function er(e,s,t,i=$c,n=$){let r=t?F.shades(t,s.length):F.rainbow(s.length);e.removeChildren();for(let[o,a]of s.entries()){let l=s[o+1]?s[o+1]-a:D-a+s[0],h=new qe(n,p.fromPolar(a-dt,i).add(n),l),d=r[o].hex;c("path",{path:h,class:"polygon-tile",fill:d},e)}}var an=class extends T{constructor(t,i,n){super(i,n);this.type="spinner";this.angle=0;this.isAnimating=!1;this.path=new H($,$c),this.$sectors=c("g",{},this.$el),this.$arrow=c("path",{d:Fa,class:"spinner"},this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el),this.setupHandles(),c("circle",{r:4,class:"spinner"},this.$el),i.events.listen(this.$arrow,{move:({posn:a})=>{let l=this.relativePosn(a).angle()+dt;this.$arrow.css("transform",`rotate(${l}rad)`)},end:({lastPosn:a})=>{let l=this.relativePosn(a).angle()+dt;this.setValue(It(l));let h=pe.updateAggregations([this.id]);i.change({changed:[this,...h]})},click:()=>ee.roll([this],this.$parent)}),this.$arrow.css("cursor","pointer");let[r,o]=t.split(":");this.drawSectors(+o),this.setValue(+r||0)}setupHandles(){this.$handle=this.makeHandle("c",t=>{let i=(t.angle()+dt)%D;this.drawSectors(D/i)}),this.$handle.css("cursor","move")}drawSectors(t){let i=S(Math.round(t),2,16);if(i===this.sectors)return;this.sectors=i,this.options=`${this.angle}:${i}`;let n=D/i;er(this.$sectors,B(r=>n*r,i),this.colour),this.$handle.setCenter(p.fromPolar(n-dt,$c))}get aggregationCategory(){let t=Math.floor(this.angle*this.sectors/360);return this.$sectors.children[t].attr("fill")}get aggregationCategories(){return this.$sectors.children.map(t=>t.attr("fill"))}setColour(t){this.colour=t;let i=this.$sectors.children,n=F.shades(t,i.length);for(let[r,o]of i.entries())o.setAttr("fill",n[r].hex)}setValue(t){t=Ct(Math.round(t),360),this.angle!==t&&(this.angle=t,this.options=`${t}:${this.sectors}`,this.$arrow.css("transform",`rotate(${this.angle}deg)`))}roll(t=2e3){return R(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("spin");let i=this.angle,n=(4+Math.random())*360;yield K(r=>{let o=$t(i,n,ot("sine",r));this.$arrow.css("transform",`rotate(${o}deg)`)},t).promise,this.setValue(n),this.isAnimating=!1})}doubleClick(){ee.roll([this],this.$parent)}static makeThumbnail(t,i){let n=c("svg",{width:80,height:80},i),r=new p(40,40);er(n,B(a=>D/5*a,5),"",36,r),c("path",{d:Fa,class:"spinner"},n).css("transform","translate(40px, 40px) rotate(-0.8rad) scale(0.5)")}};var xc=75,ja=class extends an{constructor(t,i,n){super(`${t.split(":")[0]}:1`,i,n);this.type="custom-spinner";this.$handles=[];for(let r of t.split(":")[1].split(","))this.makeVertex(p.fromPolar(U(+r)-dt,xc))}setupHandles(){let t;this.$parent.events.listen(this.$outline,{down:({posn:i})=>t=this.makeVertex(this.relativePosn(i)),move:({posn:i})=>this.moveVertex(this.relativePosn(i),t),end:()=>this.$parent.change({changed:[this]})}),this.$outline.css("cursor","crosshair")}drawSectors(){if(!this.$handles||this.$handles.length<2)return;this.sectors=this.$handles.map(i=>(i.center.angle()+dt)%D).sort().map(i=>Math.round(It(i)));let t=`${this.angle}:${this.sectors}`;t!==this.options&&(this.options=t,er(this.$sectors,this.sectors.map(i=>U(i)),this.colour))}get aggregationCategory(){let t=this.sectors,i=t.findIndex(n=>n>=this.angle)-1;return i=i<0?t.length-1:i,this.$sectors.children[i].attr("fill")}makeVertex(t){if(this.$handles.length>=24)return;let i=this.makeHandle("c",n=>{!i||(n.length>2*xc?(this.deleteVertex(i),i=void 0):this.moveVertex(n,i))},()=>{i&&this.deleteVertex(i)});return i.setAttr("r",8),i.css("cursor","move"),this.$handles.push(i),this.moveVertex(t,i),i}deleteVertex(t){this.$handles.length<=2||(t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.drawSectors())}moveVertex(t,i){if(!i)return;let n=U(ht(It(t.angle()),10));i.setCenter(p.fromPolar(n,xc)),this.drawSectors()}static makeThumbnail(t,i){let n=c("svg",{width:80,height:80},i),r=new p(40,40),o=t.split(":")[1].split(",").map(l=>U(+l));er(n,o,"",36,r),c("path",{d:Fa,class:"spinner"},n).css("transform","translate(40px, 40px) rotate(0.4rad) scale(0.5)");for(let l of o){let h=p.fromPolar(l-dt,36).add(r);c("circle",{cx:h.x,cy:h.y,r:3,fill:"white"},n)}}};var Ne=50;function Ua(e,s,t,i=0,n=0){for(let r of tr[s]){let o=r[0]*.23*t+t/2+i,a=r[1]*.23*t+t/2+n;c("circle",{cx:o,cy:a,r:t/10,class:"dice-dot"},e)}}var Za=class extends T{constructor(t,i,n){super(i,n);this.type="domino";this.options=t,this.path=new x($,Ne,Ne*2),this.$mainShape=c("rect",{class:"polygon-tile",rx:5},this.$el),c("line",{x1:0,y1:Ne,x2:Ne,y2:Ne,class:"polygon-tile"},this.$el);let[r,o]=t.split(":").map(a=>+a);Ua(this.$el,r,Ne,0,0),Ua(this.$el,o,Ne,0,Ne),this.value=r+o,this.$outline=c("rect",{class:"outline",rx:5},this.$el),this.$mainShape.setRect(this.path),this.$outline.setRect(this.path),this.transform(),this.setColour(m.teal)}getSnapPoints(){return[...super.getSnapPoints(),new p(0,Ne),new p(Ne,Ne)]}setColour(t){super.setColour(t),this.$mainShape.setAttr("fill",E(t))}static makeThumbnail(t,i){let r=c("svg",{width:34,height:64},i);c("rect",{x:2,y:2,width:30,height:30*2,rx:2,class:"polygon-tile",fill:m.teal},r),c("line",{x1:2,y1:30+2,x2:30+2,y2:30+2,class:"polygon-tile"},r);let[o,a]=t.split(":").map(l=>+l);Ua(r,o,30,2,2),Ua(r,a,30,2,2+30)}};var cw=[[0,0]],ym=[[0,-39],[0,39]],dw=[...ym,[0,0]],Wa=[[-18,-39],[18,-39],[-18,39],[18,39]],pw=[...Wa,[0,0]],bm=[...Wa,[-18,0],[18,0]],uw=[...bm,[0,-19]],Pc=[...Wa,[-18,-13],[18,-13],[-18,13],[18,13]],fw=[...Pc,[0,0]],mw=[...Pc,[0,-26],[0,26]],gw={C:"#333",S:"#333",H:m.orange,D:m.orange},vw={A:cw,2:ym,3:dw,4:Wa,5:pw,6:bm,7:uw,8:Pc,9:fw,10:mw},ww="AH:2H:3H:4H:5H:6H:7H:8H:9H:0H:JH:QH:KH:AC:2C:3C:4C:5C:6C:7C:8C:9C:0C:JC:QC:KC:KD:QD:JD:0D:9D:8D:7D:6D:5D:4D:3D:2D:AD:KS:QS:JS:0S:9S:8S:7S:6S:5S:4S:3S:2S:AS".split(":").map(e=>e+"f").join(":"),yw={A:1,J:11,Q:12,K:13,0:10};function wm(e,s){e.removeChildren();let[t,i,n]=s.split("");if(s==="deck"||n)return c("rect",{x:-39,y:-57,width:78,height:114,rx:2,fill:"url(#card-bg)"},e);t==="0"&&(t="10"),e.setAttr("fill",gw[i]);let r=`#suit-${i.toLowerCase()}`;if(i==="J")c("image",{href:"/polypad/assets/cards/joker.svg",style:"transform: translate(-35px, -53px)",width:70},e),t="Joker";else if(["K","Q","J"].includes(t))c("use",{href:r,style:"transform: translate(-35px, -36px) scale(0.6)",width:24,height:24},e),c("use",{href:r,style:"transform: rotate(180deg) translate(-35px, -36px) scale(0.6)",width:24,height:24},e),c("image",{href:`/polypad/assets/cards/${s.toLowerCase()}.svg`,style:"transform: translate(-35px, -53px)",width:70},e);else{let a=t==="A"?" scale(1.7)":"";for(let l of vw[t]||[]){let h=l[1]>0?" rotate(180deg)":"";c("use",{href:r,style:`transform: translate(${l[0]}px, ${l[1]}px)`+h+a,width:24,height:24},e)}}let o={text:t,x:-40,y:-45,style:"font-size: 16px; letter-spacing: -1px;"};c("text",o,e),c("text",Rt(et({},o),{style:"transform: rotate(180deg)"}),e)}var fi=class extends T{constructor(t,i,n){super(i,n);this.type="card";this.padding=[0,0,20,0];this.count=0;this.$label=c("g",{class:"outline card-label"},this.$el),this.$labelRect=c("rect",{width:30,height:35,rx:5},this.$label),this.$labelText=c("text",{x:6,y:30},this.$label),this.$stack=c("rect",{class:"polygon-tile",fill:"url(#card-gradient)",rx:10},this.$el),this.$path=c("rect",{class:"polygon-tile",fill:"#eee",rx:10},this.$el),this.$body=c("g",{transform:"scale(1.4)"},this.$el),this.$outline=c("rect",{class:"outline",rx:10},this.$el),this.$path.setRect(new x(new p(-125/2,-175/2),125,175)),this.setOptions(t==="deck"?ww:t)}setOptions(t){if(t===this.options)return;this.options=t;let i=t.split(":");this.count=i.length,this.value=q(i.map(o=>+(yw[o[0]]||o[0])));let n=Math.sqrt(this.count-1)*3;this.path=new x(new p(-125/2,-175/2),125,175+n);for(let o of[this.$stack,this.$outline])o.setRect(this.path);this.transform(),this.$label.setAttr("hidden",this.count<=1?!0:void 0),this.$label.setTransform({x:-125/2,y:175/2-15+n}),this.$labelRect.setAttr("width",46+this.count.toFixed().length*8),this.$labelText.text=`${this.count} cards`;let r=_(i);r!==this.top&&wm(this.$body,r),this.top=r}setColour(t){super.setColour(t||m.blue)}addCards(t){this.setOptions(this.options+":"+t)}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findNearby("card",75))}collide(t){t.highlight(!1),t.addCards(this.options),this.delete();let i=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:i})}doubleClick(){let t=this.draw();t&&this.$parent.change({added:[t],changed:[this]})}flip(){this.$parent.playSound("click");let t=this.options.split(":").reverse();this.setOptions(t.map(i=>i.length>2?i.slice(0,2):i+"f").join(":"))}draw(){if(this.count<=1)return;this.$parent.playSound("draw"),this.$parent.selection.clear();let t=this.options.split(":"),i=t.pop();this.setOptions(t.join(":"));let n=new fi(i,this.$parent);return n.rot=this.rot,n.animateTo(this.posn.shift(150,0),this.posn),n}shuffle(){this.count<=1||(this.$parent.playSound("shuffle"),this.setOptions(J.shuffle(this.options.split(":")).join(":")))}static makeThumbnail(t,i){let n=c("svg",{width:60,height:74},i);c("rect",{x:5,y:2,width:50,height:70,fill:"white",rx:4},n);let r=c("g",{style:"transform: translate(30px, 37px) scale(0.55)"},n);i.onAttr("data-options",o=>wm(r,o))}};I([{type:"button",tileTypes:["card"],label:"Turn over",click:(e,s)=>{for(let t of e)t.flip();s.change({changed:e})}},{type:"button",tileTypes:["card"],label:"Stack",show:e=>e.length>1,click:(e,s)=>{let t=e.map(n=>n.options).join(":"),i=new fi(t,e[0].$parent);i.setTransform(p.average(...e.map(n=>n.posn)));for(let n of e)n.delete();s.selection.add(i),s.change({added:[i],deleted:e})}},{type:"button",tileTypes:["card"],label:"Draw",show:e=>e.length===1&&e[0].count>1,click:(e,s)=>{let t=e[0].draw();s.change({added:[t],changed:e})}},{type:"button",tileTypes:["card"],label:"Shuffle",show:e=>e.some(s=>s.count>1),click:(e,s)=>{for(let t of e)t.shuffle();s.change({changed:e})}}]);var Ka=[{key:"discrete",label:"Discrete Uniform",params:[{label:"Min:",int:!0},{label:"Max:",int:!0}],defaults:[1,10],get:(e,s)=>J.integer(e,s)},{key:"bernoulli",label:"Bernoulli",params:[{label:"p",range:[0,1]}],defaults:[.5],get:e=>J.bernoulli(e)},{key:"binomial",label:"Binomial",params:[{label:"p",range:[0,1]},{label:"n",range:[1,void 0],int:!0}],defaults:[.5,10],get:(e,s)=>J.binomial(s,e)},{key:"poisson",label:"Poisson",params:[{label:"\u03BB",range:[0,void 0]}],defaults:[1,10],get:e=>J.poisson(e)},{key:"geometric",label:"Geometric",params:[{label:"p",range:[0,1]}],defaults:[.5],get:e=>J.geometric(e)||0},{key:"continuous",label:"Continuous Uniform",params:[{label:"Min:"},{label:"Max:"}],defaults:[0,1],get:(e,s)=>J.uniform(e,s)},{key:"normal",label:"Normal",params:[{label:"\u03BC"},{label:"\u03C3\xB2",range:[0,void 0]}],defaults:[0,1],get:(e,s)=>J.normal(e,s)},{key:"exponential",label:"Exponential",params:[{label:"\u03BB"}],defaults:[1],get:e=>J.exponential(e)},{key:"cauchy",label:"Cauchy",params:[],defaults:[],get:()=>J.cauchy()}],Xa=class extends T{constructor(t,i,n){super(i,n);this.type="random";this.path=new x($,75,50);this.$body=c("rect",{class:"polygon-tile",rx:6,width:75,height:50},this.$el),c("rect",{class:"polygon-tile",fill:"none",opacity:.7,style:"stroke-width:2px;stroke-dasharray:2px 4px",x:3.5,y:3.5,rx:3,width:68,height:43},this.$el),this.$text=c("text",{x:75/2,fill:"white",style:"text-anchor: middle"},this.$el),this.$outline=c("rect",{class:"outline",rx:6,width:75,height:50},this.$el);let[r,o,...a]=t.split(",");this.setDistribution(o,a.length?a.map(l=>+l):void 0),r?this.setValue(+r):this.roll(),this.setColour(m.green)}setColour(t){super.setColour(t),this.$body.setAttr("fill",t)}setDistribution(t,i){this.distribution=Ka.find(n=>n.key===t)||Ka[0],this.params=i||this.distribution.defaults.slice(0),this.roll()}setValue(t){this.value=t,this.options=`${this.value},${this.distribution.key},${this.params.join(",")}`;let i=this.$text.text=nt(t,6),n=S(65/i.length*2,16,32);this.$text.css("font-size",n+"px"),this.$text.setAttr("y",.3*n+26)}get aggregationCategory(){return this.value}get aggregationCategories(){return[]}roll(){this.setValue(this.distribution.get(...this.params))}doubleClick(){ee.roll([this],this.$parent)}static makeThumbnail(t,i){let n=c("svg",{width:85,height:60},i);c("rect",{x:5,y:5,width:75,height:50,class:"polygon-tile",rx:6,fill:m.green},n),c("rect",{class:"polygon-tile",fill:"none",opacity:.7,style:"stroke-width:2px;stroke-dasharray:2px 4px",x:8.5,y:8.5,rx:3,width:68,height:43},n),c("text",{fill:"white",x:42.5,y:41,style:"font-size:32px;text-anchor: middle",text:"?"},n)}},bw=Bt(Ka.map(e=>e.params.map((s,t)=>({type:"input",tileTypes:["random"],label:s.label,value:"number",advanced:!0,range:s.range,show:i=>i.every(n=>n.distribution===e),get:i=>i.params[t],set:(i,n)=>{n.params[t]=s.int?Math.round(+i):+i,n.roll()}}))));I([{type:"select",tileTypes:["random"],options:Ka,label:"Distribution:",advanced:!0,get:e=>e.distribution.key,set:(e,s)=>s.setDistribution(e)},...bw]);var $w=[[1,2,3,4,5]].map(e=>({label:"",data:e}));function xw(e,s=!1){let t=$i(e,.25),i=$i(e,.75),n=1.5*(i-t),r=s?e.filter(h=>st(h,t-n,i+n)):e,o=Math.min(...r);t=$i(r,.25);let a=$i(r,.5);i=$i(r,.75);let l=Math.max(...r);return[o,t,a,i,l]}var Ya=class extends Rs{constructor(t,i,n){super(t,i,n);this.type="box-whisker";this.colour=m.darkGrey;this.padding=[0,0,25,0];this.$boxPlots=new Ie(()=>c("path",{class:"chart-line"}));this.range=[0,5];this.series=[];this.tables=new Map;this.$background=c("path",{fill:"transparent"}),this.$el.prepend(this.$background),this.$axis=c("path",{class:"grid-axis",stroke:m.darkGrey},this.$el),this.$labels=c("g",{class:"axis-labels"},this.$el),this.$focussedOutline=c("path",{class:"chart-shadow"},this.$el),this.$handle=this.makeHandle("h",r=>{this.chartOptions.width=Math.max(ht(r.x,25),100)}),this.chartOptions.watch(({width:r})=>{this.updateOutline(r),this.drawChart()}),this.makeInPort("main",{tileTypes:["table"],message:(r,o)=>{r.type==="table"&&(this.tables.set(o,r.table),this.redraw())},disconnect:r=>{this.tables.delete(r),this.redraw()}})}drawChart(){this.default=!this.series.length;let t=this.default?$w:this.series;this.$series.removeChildren(),this.range[0]=Math.min(...t.map(i=>Math.min(...i.data))),this.range[1]=Math.max(...t.map(i=>Math.max(...i.data))),t.forEach((i,n)=>this.drawBoxWhiskerPlot(i.data,n,-25-50*(t.length-1-n))),this.drawAxes(t)}drawBoxWhiskerPlot(t,i,n){let r=this.$boxPlots.get(i),o=this.chartOptions.layout==="outliers",[a,l,h,d,u]=xw(t,o).map(g=>this.getX(g)),f=16,v=10,w=`M${a} ${n+v}V${n-v}M${a} ${n}H${l}V${n+f}H${d}V${n-f}H${l}V${n}M${h} ${n+f}V${n-f}M${d} ${n}H${u}M${u} ${n+v}V${n-v}`;if(o){let g=t.map(y=>this.getX(y)).filter(y=>y<a||y>u);for(let y of g)w+=jt(new H(new p(y,n),4))}r.setAttr("d",w),r.setAttr("series-idx",i),r.setAttr("stroke",this.getSeriesColor(i)),this.$series.append(r)}drawAxes(t){this.$labels.removeChildren();let i=As("",this.path.w,this.range,0),n=`M 0 0 h ${this.path.w}`;for(let r=this.range[0];r<=this.range[1]+.001;r+=i[2]){let o=this.getX(r);n+=`M${o},0v5`,c("text",{text:nt(r,4),x:o,y:21,"text-anchor":"middle"},this.$labels)}this.$axis.setAttr("d",n),t.forEach((r,o)=>{let a=-25-50*(t.length-1-o),l=r.label;c("text",{text:l,x:-14,y:a,"text-anchor":"end"},this.$labels)})}updateOutline(t=this.chartOptions.width||300){let i=(this.series.length||1)*50;this.path=new x($.shift(0,-i),t,i),this.$outline.draw(this.path),this.$background.draw(this.path),this.$handle.translate(t,-i),this.transform(),this.$parent.selection.update()}colorSeries(t,i){this.$boxPlots.get(i).setAttr("stroke",t),this.$focussedOutline.setAttr("stroke",t)}getX(t){return(t-this.range[0])/(this.range[1]-this.range[0])*this.path.w}setColour(t,i){super.setColour(t,i),this.focussedSeries<0&&(this.$labels.setAttr("fill",E(t)),this.$axis.setAttr("stroke",E(t)))}redraw(){this.buildSeries(),this.drawChart(),this.updateOutline()}buildSeries(){this.series=[];for(let t of this.tables.values()){let i=Jn(t).slice(1);if(!!i.length)for(let n=0;n<i[0].length;n++){let r=i.map(o=>parseInt(o[n])).filter(o=>!Number.isNaN(o));r.length&&this.series.push({label:t[0][n],data:r})}}}focusSeries(t){this.$focussedOutline.setAttr("d",this.$boxPlots.get(t).attr("d")),this.$focussedOutline.setAttr("stroke",this.getSeriesColor(t)),this.$focussedOutline.show()}blur(){super.blur(),this.$focussedOutline.hide()}findClosestElement(t){let i=Math.round((this.relativePosn(t.posn).y+25)/50);return""+S(-i,0,this.series.length-1)}static makeThumbnail(t,i){let[n,r]=[180,45],[o,a,l,h,d]=[0,1,2,3,4].map(C=>5+C/4*170),[u,f,v]=[r/2,14,8],w=c("svg",{width:n,height:r},i),g=c("path",{class:"chart-line",stroke:"white",style:"stroke-width: 2px"},w),y=`M${o} ${u-v} V ${u+v}M${o} ${u} H ${a}V${u-f}H${h} V ${u+f}H${a} V ${u}M${l} ${u-f} V ${u+f}M${h} ${u}H${d}M${d} ${u-v}V${u+v}`;g.setAttr("d",y)}};I([{type:"checkbox",tileTypes:["box-whisker"],label:"Outliers:",get:e=>e.chartOptions.layout==="outliers",set:(e,s)=>s.chartOptions.layout=e?"outliers":void 0}]);var xm=["hours","minutes","seconds"],Pw={hours:"M-3,0-4-29l4-5,4,5L3,0Z",minutes:"M-2,0-3-47l3-5,3,5L2,0",seconds:"M-1,-52L1,-52L1,0L-1,0Z"};function $m(e,s=75){let t=s-5,i="";for(let a=0;a<60;++a){let l=p.fromPolar(a/30*Math.PI),h=t-(a%5?3:8);i+=`M${l.x*h} ${l.y*h}L${l.x*t} ${l.y*t}`}let n=c("circle",{r:s,class:"polygon-tile"},e);c("circle",{r:t,class:"clock-face"},e);let r=c("path",{d:i,class:"clock-ticks"},e);for(let a=1;a<=12;++a){let l=p.fromPolar((a-3)/6*Math.PI).scale(53).shift(0,5);c("text",{text:a,x:l.x,y:l.y,class:"clock-label"},e)}let o=xm.map(a=>c("path",{class:"clock-handle",d:Pw[a],opacity:a==="hours"?.8:void 0},e));return c("circle",{r:4,class:"spinner"},e),[n,r,...o]}var Qa=class extends T{constructor(t,i,n){super(i,n);this.type="clock";this.showSeconds=!0;this.prevAngle=0;this.currentAngle=0;this.seconds=0;this.time=[0,0,0];this.options=t;let r=75;this.path=new H($,r),[this.$border,this.$ticks,...this.$hands]=$m(this.$el,r),this.$outline=c("circle",{class:"outline",r},this.$el);let o=this.options;for(let[d,u]of this.$hands.entries())i.events.listen(u,{start:({posn:f})=>{o=this.options,this.prevAngle=this.getPointerAngle(f)%D},move:({posn:f})=>this.handleMoveHand(xm[d],f),end:()=>{this.updateOptions(),this.options!==o&&i.change({changed:[this]})}});let[a,l,...h]=this.options.split(":");if(+l||this.$hands[2].hide(),a==="l"){this.clockType="live";let d=new Date().getTimezoneOffset()*60,u=-1;this.animation=K(()=>{let f=Math.round(Date.now()/1e3-d);f!==u&&(u=f,this.setTime(f))});for(let f of this.$hands)f.css("pointer-events","none")}else a==="g"?(this.clockType="geared",this.setTime(+h[0]||0)):(this.clockType="free",this.setHands(+h[0]||0,+h[1]||0,+h[2]||0))}setTime(t){this.seconds=t;let i=t%60,n=t/60%60,r=t/3600%12;this.setHands(r,n,i)}setHands(t,i,n){this.time=[t%12,i%60,n%60],this.$hands[2].setTransform(void 0,Math.round(n)/60*D),this.$hands[1].setTransform(void 0,i/60*D),this.$hands[0].setTransform(void 0,t/12*D),this.value=Ct(t,12)+Ct(i,60)/60+Ct(n,60)/3600}updateOptions(){let t=this.showSeconds?"1":"0";this.clockType==="live"?this.options=`l:${t}`:this.clockType==="geared"?this.options=`g:${t}:${this.seconds}`:this.options=`f:${t}:${this.time[0]}:${this.time[1]}:${this.time[2]}`}delete(){var t;(t=this.animation)==null||t.cancel,super.delete()}getPointerAngle(t){return this.relativePosn(t).angle()+dt}handleMoveHand(t,i){this.currentAngle=this.getPointerAngle(i)%D,this.prevAngle/D>.75?this.currentAngle/D<.25&&(this.currentAngle+=D):this.prevAngle/D<.25&&this.currentAngle/D>.75&&(this.currentAngle-=D);let n=(this.currentAngle-this.prevAngle)/D;if(this.clockType==="geared"){let r=n*(t==="hours"?43200:t==="minutes"?3600:60);this.setTime(this.seconds+r)}else if(this.clockType==="free"){let[r,o,a]=this.time;t==="hours"?r+=n*12:t==="minutes"?o+=n*60:a+=n*60,this.setHands(r,o,a)}this.currentAngle>=D?this.currentAngle-=D:this.currentAngle<0&&(this.currentAngle+=D),this.prevAngle=this.currentAngle}setColour(t){super.setColour(t),this.$border.setAttr("fill",E(t)),this.$ticks.setAttr("stroke",E(t)),this.$hands[2].css("fill",E(t))}static makeThumbnail(t,i){let n=c("svg",{width:80,height:80,viewBox:"-80 -80 160 160"},i),r=i.data.colour,[o,a,...l]=$m(n,75);o.removeClass("polygon-tile"),o.setAttr("fill",r),a.setAttr("stroke",r),l[2].css("fill",r),l[2].setTransform(void 0,57/60*D),l[1].setTransform(void 0,37/60*D),l[0].setTransform(void 0,2.62/12*D)}};I([{type:"checkbox",tileTypes:["clock"],label:"Seconds:",get:e=>e.showSeconds,set:(e,s)=>{s.$hands[2].toggle(e),s.showSeconds=e,s.updateOptions()}}]);var se=50,Pm="#585",Sm=["r","n","b","q","k","b","n","r"],Tm={k:"M25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37ZM34.3,16.6a13.8,13.8,0,0,0-6.1,1.3l-.9-4h3.8c1.2,0,1.7-1.5,1.7-2.6s-.5-2.6-1.7-2.6H27.8v-3c0-.9-1.7-1.4-2.8-1.4s-2.8.5-2.8,1.4v3H18.9c-1.2,0-1.7,1.6-1.7,2.6s.5,2.6,1.7,2.6h3.8l-.9,4a13.8,13.8,0,0,0-6.1-1.3c-9.8,0-14.3,11.5-3.2,19.1l.8,2.8C16.1,37,23,37,25,37s8.9,0,11.7,1.5l.8-2.8C48.6,28.1,44.1,16.6,34.3,16.6ZM22,30.9s-3.6.2-5.3.5c-2.8-1.7-5.4-4.8-4.6-6.7,1.2-3.8,9.9.3,9.9.3Zm11.3.5c-1.7-.3-5.3-.5-5.3-.5V25c1.6-1.8,8.7-4.1,9.9-.3C38.7,26.6,36.1,29.7,33.3,31.4Z",q:"M25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37ZM40,13.6a4,4,0,0,0-3.4,6.2l-4.9,3.4V14.4c4.5-1.2,3.6-7.8-1.1-7.8a3.9,3.9,0,0,0-2.3,7.2L25,21.9l-3.3-8.1a3.9,3.9,0,0,0-2.3-7.2c-4.7,0-5.6,6.6-1.1,7.8v8.8l-4.9-3.4A4,4,0,0,0,10,13.6a4,4,0,1,0,.6,7.9l6.3,16A55,55,0,0,1,25,37a55,55,0,0,1,8.1.5l6.3-16a4,4,0,1,0,.6-7.9Z",r:"M17.8,20.7a53.4,53.4,0,0,1,14.4,0c2.6-.1,4.8-2,3.8-10.9l-3.7-.5L31.2,13H28l-.5-3.8h-5L22,12.9H18.8L17.7,9.3,14,9.8C13,18.7,15.2,20.6,17.8,20.7ZM25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37ZM25,37c1.7,0,7,0,10.3,1L32.2,20.7a53.4,53.4,0,0,0-14.4,0L14.7,38C18,37,23.3,37,25,37Z",b:"M16.9,37.5A55,55,0,0,1,25,37a53.2,53.2,0,0,1,8,.5,17.4,17.4,0,0,0,1-18.2l-4.6,6.3a2.4,2.4,0,0,1-3.9-2.8L31,15a27.6,27.6,0,0,0-3.8-3.9l1.5-2.6c0-1.1-1.7-2-3.7-2s-3.8.9-3.8,2l1.5,2.6C8.6,23.4,15.3,35.1,16.9,37.5ZM25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37Z",n:"M25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37ZM14.8,26.1c3-2.6,5.5-2.1,9.2-3.7,1.9,3.1-11.9,9.3-9.4,15.6,3.2-1,8.7-1,10.4-1s8.2,0,11.2,1.3c-5.9-8.9,9.4-23.2-10.5-29.5a7.9,7.9,0,0,0-5.2-2.7V9.4L8.4,21.9C11.1,26.9,14.8,26.1,14.8,26.1ZM20.7,15c.1-.5.4-1.4,1.1-1.4h0a2.9,2.9,0,0,1,1,.3.4.4,0,0,1,.1.3,1.9,1.9,0,0,1-.9,1.2l-1.2.2h-.1Z",p:"M25,10.8a6,6,0,0,0-4.1,10.5c-4,1.7-3.7,2.3-3.3,6.5h3.8c-1.6,8.3-9.1,6.4-8.9,15.7h25c.2-9.3-7.3-7.3-8.9-15.7h3.8c.4-4.2.7-4.8-3.3-6.5A6,6,0,0,0,25,10.8Z"};function Cm(e,s,t){let{x:i,y:n,tile:r}=s,o=(f,v)=>f>=0&&v>=0&&f<8&&v<8,a=(f,v)=>e.pieces.filter(w=>w.x===f&&w.y===v),l=(f,v,w=!1)=>{let g=e.pieces.filter(y=>y.tile.dark===s.tile.dark||y.x!==f||y.y!==v).map(y=>y.x===s.x&&y.y===s.y&&y.tile.dark===s.tile.dark?Rt(et({},y),{x:f,y:v,justJumped:y.justJumped||w}):et({},y));return{newX:f,newY:v,isJump:w,newState:{pieces:g}}};if(r.piece==="n")return[[1,-2],[2,-1],[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2]].map(([f,v])=>[i+f,n+v]).filter(([f,v])=>o(f,v)&&!a(f,v).some(w=>w.tile.dark===r.dark)).map(([f,v])=>l(f,v));let h=[],d=r.dark?1:-1;if(r.piece==="p"){let f=[[i-1,n+d],[i+1,n+d]].filter(([v,w])=>{let g=a(v,w)[0];return o(v,w)&&g&&g.tile.dark!==r.dark});if(n===(r.dark?4:3)){let v=a(i-1,n)[0];v&&v.tile.dark!==r.dark&&v.tile.piece==="p"&&v.justJumped&&f.push([i-1,n+d]);let w=a(i+1,n)[0];w&&w.tile.dark!==r.dark&&w.tile.piece==="p"&&w.justJumped&&f.push([i+1,n+d])}if(h.push(...f.map(([v,w])=>l(v,w))),t)return h}let u=[];["k","q","r"].includes(r.piece)&&u.push([-1,0],[0,1],[1,0],[0,-1]),["k","q","b"].includes(r.piece)&&u.push([-1,-1],[1,1],[1,-1],[-1,1]),r.piece==="p"&&u.push([0,d]);for(let f of u){let{x:v,y:w}=s,g=7;r.piece==="k"&&(g=1),r.piece==="p"&&(w===(r.dark?1:6)?g=2:g=1);for(let y=0;y<g&&(v+=f[0],w+=f[1],!!o(v,w));y++){let C=a(v,w)[0];if(C){C.tile.dark!==r.dark&&r.piece!=="p"&&h.push(l(v,w));break}h.push(l(v,w,r.piece==="p"&&y===1))}}return h}var ln=class extends T{constructor(t,i,n){super(i,n);this.type="chess-board";this.canDragToSelect=!1;this.canRotate=!1;this.$cells=[];this.$dots=[];for(let r=0;r<8;r++)for(let o=0;o<8;o++){let a=(r*8+o+r)%2?Pm:"#ccc";this.$cells.push(c("rect",{x:o*se,y:r*se,width:se,height:se,fill:a},this.$el)),this.$dots.push(c("circle",{cx:(o+.5)*se,cy:(r+.5)*se,r:16,opacity:.7},this.$el))}this.options=t||"off",this.path=new x($,se*8,se*8),this.$outline=c("rect",{class:"outline"},this.$el),this.$outline.setRect(this.path),this.hideDots(),this.setOrder("back")}getPiecePosition(t){let i=this.relativePosn(t.posn).scale(1/se).floor();return i.x>=0&&i.x<=7&&i.y>=0&&i.y<=7?i:void 0}getCurrentState(){let t=[];for(let i of this.$parent.getTilesOfType("chess-piece")){let n=this.getPiecePosition(i);n&&t.push({x:n.x,y:n.y,tile:i,justJumped:i.justJumped})}return{pieces:t}}moveStart(t=!1){if(super.moveStart(),!t)for(let i of this.getCurrentState().pieces)this.$parent.selection.add(i.tile)}showDots(t){if(this.options==="off")return;let i=this.getCurrentState(),n=i.pieces.find(o=>o.tile===t),r=Cm(i,n,!1);for(let o=0;o<8;o++)for(let a=0;a<8;a++){let l=this.$dots[o*8+a];l.hide();let h=r.find(d=>d.newX===a&&d.newY===o);if(h&&(l.show(),this.options==="moves"&&l.setAttr("fill",m.yellow),this.options==="danger")){let d=!1;for(let u of h.newState.pieces){if(u.tile.dark===n.tile.dark)continue;let f=Cm(h.newState,u,!0);d||(d=f.some(v=>{if(v.newX===a&&v.newY===o)return!0;let w=n.tile.dark?1:-1;if(h.isJump&&v.newX===a&&v.newY===o-w)return!0}))}l.setAttr("fill",d?m.red:m.blue)}}}hideDots(){for(let t of this.$dots)t.hide()}completeMove(t,i){let n=this.getCurrentState(),r=n.pieces.find(a=>a.tile===t);if(!r||r.x===i.x&&r.y===i.y)return;let o=n.pieces.filter(a=>a.tile.dark!==r.tile.dark&&a.x===r.x&&a.y===r.y&&a!==r);for(let a of o)a.tile.delete();for(let a of n.pieces)a.tile.justJumped=!1;(i.y===6&&r.y===4||i.y===1&&r.y===3)&&r.tile.piece==="p"&&(r.tile.justJumped=!0),this.$parent.change({changed:[t],deleted:o.map(a=>a.tile)})}getSnapPoints(){let t=[];for(let i=0;i<=8;i++)for(let n=0;n<=8;n++)t.push(new p(i*se,n*se));return t}reset(t=!1){let i=[],n=[];for(let a of this.getCurrentState().pieces)n.push(a.tile),a.tile.delete();let r=(a,l,h,d)=>{let u=new sr(h+(d?"d":"l"),this.$parent);u.setTransform(this.posn.add(new p(a+.5,l+.5).scale(se))),i.push(u)},o=a=>a==="k"?"k":t?J.find(["q","r","b","n","p"]):a;for(let a=0;a<8;++a)r(a,0,o(Sm[a]),!0),r(a,1,o("p"),!0),r(a,6,o("p"),!1),r(a,7,o(Sm[a]),!1);return{added:i,deleted:n}}static makeThumbnail(t,i){let n=c("svg",{width:124,height:124},i),r=120/8;for(let o=0;o<8;o++)for(let a=0;a<8;a++){let l=(a*8+o+a)%2?Pm:"#ccc";c("rect",{width:r,height:r,x:2+o*r,y:2+a*r,fill:l},n)}}static reset(t,i,n=!1){let r=[],o=[];for(let a of t){let l=a.reset(n);r=r.concat(l.added),o=o.concat(l.deleted)}i.change({added:r,deleted:o})}};I([{type:"select",label:"Hints:",tileTypes:["chess-board"],options:[{label:"None",key:"off"},{label:"Moves",key:"moves"},{label:"Danger",key:"danger"}],get:e=>e.options,set:(e,s)=>s.options=e},{type:"button",label:"Reset",tileTypes:["chess-board"],click:(e,s)=>ln.reset(e,s)},{type:"button",label:"Randomise",tileTypes:["chess-board"],click:(e,s)=>ln.reset(e,s,!0)}]);var sr=class extends T{constructor(t,i,n){super(i,n);this.type="chess-piece";this.canRotate=!1;this.justJumped=!1;this.options=t,this.piece=t[0],this.dark=t[1]==="d",this.path=new x(new p(-se/2,-se/2),se,se),c("path",{path:this.path,fill:"transparent"},this.$el),this.$piece=c("path",{d:Tm[this.piece],style:"transform: translate(-25px, -25px)"},this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el),this.setColour(this.dark?"#333":"#eee")}setColour(t){super.setColour(t),this.$piece.setAttr("fill",t),this.$piece.setAttr("stroke",this.dark?"white":"#181824")}get board(){return this.$parent.getTileAt(this.posn,["chess-board"])}down(){var t,i;this.$parent.selection.size>1||(this.startCell=(t=this.board)==null?void 0:t.getPiecePosition(this),(i=this.board)==null||i.showDots(this))}up(){var t;(t=this.board)==null||t.hideDots()}moveEnd(){if(this.$parent.selection.size>1)return;let t=this.board;t&&this.startCell&&(t.completeMove(this,this.startCell),this.$parent.selection.tiles.delete(this),setTimeout(()=>this.$parent.selection.tiles.add(this))),this.startCell=void 0}static makeThumbnail(t,i){let n=c("svg",{width:40,height:40,viewBox:"0 0 50 50"},i),r=Tm[t[0]],o=t[1]==="d"?"#333":"#ddd",a=t[1]==="d"?"#fff":"#181824";c("path",{d:r,fill:o,stroke:a},n)}};var ss=["logic-gate","logic-button","logic-switch","logic-bulb","logic-display","logic-speaker","logic-metronome"],Ja={and:"M37.3,9H18V41H37.3C47.6,41,56,33.8,56,25S47.6,9,37.3,9Z",buffer:"M25 9L25 41L55 25Z",xor:"M23,41a30.2,30.2,0,0,0,4.6-16A30.2,30.2,0,0,0,23,9h1c13.2,0,26.4,5.1,32,16C50.4,35.9,37.2,41,24,41Zm-2.5,0a26.8,26.8,0,0,0,5.1-16A26.8,26.8,0,0,0,20.5,9H18a25,25,0,0,1,5.6,16A25,25,0,0,1,18,41Z",or:"M24,9H18a25,25,0,0,1,5.6,16A25,25,0,0,1,18,41h6c13.2,0,26.4-5.1,32-16C50.4,14.1,37.2,9,24,9Z"},Sw={buffer:[1,([e])=>e],not:[1,([e])=>!e],or:[2,([e,s])=>e||s],nor:[2,([e,s])=>!(e||s)],and:[2,([e,s])=>e&&s],nand:[2,([e,s])=>!(e&&s)],xor:[2,([e,s])=>e?!s:s],xnor:[2,([e,s])=>e?s:!s],t:[1,(e,[s],t)=>s===-1?!t:t],sr:[2,([e,s],t,i)=>e===s?i:e],d:[2,([e],[s,t],i)=>t===1?e:i],jk:[3,([e,s,t],[i,n,r],o)=>n!==1?o:e!==t?e:e?!o:o]};function Mm(e,s){let t=Ja[e]||Ja[e.slice(1)];if(e==="not"&&(t=Ja.buffer),e==="xnor"&&(t=Ja.xor),!t){s.addClass("logic-gate");let l=e==="sr"?"Latch":"Flip-flop",h={"font-weight":"bold","text-anchor":"middle",fill:"white"};c("text",et({text:e.toUpperCase(),x:38,y:35,"font-size":24},h),s),c("text",et({text:l,x:38,y:55,"font-size":14},h),s);return}c("path",{d:t,fill:"white"},s);let i={stroke:"white","stroke-width":2},n=e[0]==="n"||e==="xnor",r=e.startsWith("x"),o=n?63:50,a=r?22:25;e==="buffer"||e==="not"?(c("line",et({x1:10,y1:25,x2:a,y2:25},i),s),c("line",et({x1:o,y1:25,x2:66,y2:a},i),s),n&&c("circle",et({r:4,cx:58,cy:25,fill:"transparent"},i),s)):(c("line",et({x1:10,y1:16,x2:a,y2:16},i),s),c("line",et({x1:10,y1:34,x2:a,y2:34},i),s),c("line",et({x1:o,y1:25,x2:68,y2:25},i),s),n&&c("circle",et({r:4,cx:59,cy:25,fill:"transparent"},i),s))}var tl=class extends T{constructor(t,i,n){super(i,n);this.type="logic-gate";this.options=t;let r=["t","sr","d","jk"].includes(t),o=r?75:50;this.path=new x($,75,o),this.$rect=c("rect",{width:75,height:o,rx:5},this.$el),this.$outline=c("rect",{class:"outline",width:75,height:o,rx:5},this.$el),Mm(t,this.$el);let[a,l]=Sw[t],h=zt(a,0),d=0;this.makeOutPort("main",{connect:v=>v.enqueueMessage({type:"number",value:d}),location:new p(75,o/2),persistent:!0,highlights:!0,tileTypes:ss});let u=(v,w)=>{let g=h.map((C,A)=>A!==v||C===w?0:w?1:-1);h[v]=w;let y=d;d=l(h.map(C=>!!C),g,!!d)?1:0,d!==y&&this.emitMessage("main",{type:"number",value:d})},f=a===1?[0]:a===2?[-.2,.2]:[-.25,0,.25];for(let v=0;v<a;v++)this.makeInPort("in-"+v,{message:w=>{w.type==="number"&&u(v,w.value)},location:[new p(0,o*(.5+f[v])),Math.PI],disconnect:()=>u(v,0),max:1,tileTypes:ss}),u(v,0);this.setColour(r?m.teal:m.green)}setColour(t,i){super.setColour(t,i),this.$rect.setAttr("fill",t)}static makeThumbnail(t,i){let n=["t","sr","d","jk"].includes(t),r=c("svg",{width:55,height:n?55:39,viewBox:`0 0 75 ${n?75:53}`},i),o=n?m.teal:m.green;c("rect",{fill:o,rx:5,width:75,height:n?75:50},r),Mm(t,r)}};var vt=50,el=class extends T{constructor(t,i,n){super(i,n);this.type="logic-button";this.path=new x($,vt,vt),this.$path=c("rect",{rx:5,width:vt,height:vt},this.$el),this.$outline=c("rect",{class:"outline",rx:5,width:vt,height:vt},this.$el),this.$circle=c("circle",{fill:"#0005",cx:vt/2,cy:vt/2,r:8},this.$el),this.makeOutPort("main",{persistent:!0,highlights:!0,tileTypes:ss,location:[new p(vt,vt/2),0]}),this.setColour(m.red)}setColour(t){super.setColour(t),this.$path.setAttr("fill",t)}down(){this.$circle.setAttr("fill","white"),this.emitMessage("main",{type:"number",value:1})}up(){this.$circle.setAttr("fill","#0005"),this.emitMessage("main",{type:"number",value:0})}static makeThumbnail(t,i){let n=c("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},i);c("rect",{fill:m.red,rx:5,width:50,height:50},n),c("circle",{cx:25,cy:25,r:8,fill:"white"},n)}},Em="M30,16H20a9,9,0,0,0,0,18H30a9,9,0,0,0,0-18Z",sl=class extends T{constructor(t,i,n){super(i,n);this.type="logic-switch";this.path=new x($,vt,vt),this.$body=c("rect",{rx:5,width:vt,height:vt},this.$el),this.$outline=c("rect",{class:"outline",rx:5,width:vt,height:vt},this.$el),this.$toggle=c("path",{d:Em,fill:"none","stroke-width":3,style:"transition: stroke .1s"},this.$el),this.$circle=c("circle",{cx:20,cy:vt/2,r:5,style:"transition: transform .1s, fill .1s"},this.$el),this.makeOutPort("main",{connect:r=>r.enqueueMessage({type:"number",value:this.value||0}),location:[new p(vt,vt/2),0],persistent:!0,highlights:!0,tileTypes:ss}),this.setColour(m.red),this.setState(t==="true")}setState(t=!1){this.value=t?1:0,this.options=t?"true":"",this.$toggle.css("stroke",t?"white":"#0005"),this.$circle.css("fill",t?"white":"#0005"),this.$circle.css("transform",t?"translate(10px)":""),this.$parent.change({changed:[this]}),this.emitMessage("main",{type:"number",value:this.value})}click(){this.setState(!this.value)}setColour(t){super.setColour(t),this.$body.setAttr("fill",t)}static makeThumbnail(t,i){let n=c("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},i);c("rect",{fill:m.red,rx:5,width:50,height:50},n),c("path",{d:Em,fill:"none","stroke-width":3,stroke:"white"},n),c("circle",{cx:30,cy:vt/2,r:5,fill:"white"},n)}},Am="M28,11a3,3,0,1,1-3-3A2.9,2.9,0,0,1,28,11ZM25,36a3,3,0,1,0,3,3A2.9,2.9,0,0,0,25,36ZM8,25a3,3,0,1,0,3-3A2.9,2.9,0,0,0,8,25Zm28,0a3,3,0,1,0,3-3A2.9,2.9,0,0,0,36,25Zm1-7.8A3,3,0,0,1,32.8,13,3,3,0,0,1,37,17.2ZM17.2,32.8a3,3,0,1,0,0,4.2A2.9,2.9,0,0,0,17.2,32.8ZM13,13a3,3,0,0,0,4.2,4.2A3,3,0,0,0,13,13ZM32.8,32.8a3,3,0,1,0,4.2,0A2.9,2.9,0,0,0,32.8,32.8Z",il=class extends T{constructor(t,i,n){super(i,n);this.type="logic-bulb";this.colour=m.yellow;this.value=0;this.path=new x($,vt,vt),this.$path=c("rect",{fill:m.grey,rx:5,width:vt,height:vt},this.$el),this.$outline=c("rect",{class:"outline",rx:5,width:vt,height:vt},this.$el),c("circle",{cx:25,cy:25,r:8,fill:"white"},this.$el),this.$lights=c("path",{d:Am,fill:"white",hidden:!0},this.$el),this.makeInPort("main",{message:r=>{r.type==="number"&&this.setState(!!r.value)},disconnect:()=>this.setState(!1),location:[new p(0,vt/2),Math.PI],max:1,tileTypes:ss}),this.setState(!1)}setState(t=!1){this.value=t?1:0,this.setColour(this.colour),this.$lights.toggle(t)}setColour(t){super.setColour(t),this.$path.css("fill",this.value?t:m.grey)}static makeThumbnail(t,i){let n=c("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},i);c("rect",{fill:m.yellow,rx:5,width:50,height:50},n),c("circle",{cx:25,cy:25,r:8,fill:"white"},n),c("path",{d:Am,fill:"white"},n)}},nl=class extends T{constructor(t,i,n){super(i,n);this.type="logic-display";this.path=new x($,100,100);let r={x:0,y:0,width:100,height:100,rx:10};this.$path=c("rect",et({},r),this.$el),this.$outline=c("rect",Rt(et({},r),{class:"outline"}),this.$el),this.$number=c("text",{x:50,y:56,fill:"#fff","text-anchor":"middle","font-size":58},this.$el),this.$binary=c("text",{x:50,y:82,fill:"#fff","text-anchor":"middle","font-size":20,"font-weight":600},this.$el);let o=[0,0,0,0],a=()=>{this.$number.textStr=q(o.map((l,h)=>l*2**h)),this.$binary.text=[...o].reverse().join(" ")};for(let l=0;l<4;l++)this.makeInPort(`bit-${l}`,{location:[new p(0,20+l*20),Math.PI],tileTypes:ss,persistent:!0,max:1,disconnect(){o[l]=0,a()},message(h){h.type==="number"&&(o[l]=h.value,a())}});a(),this.setColour(m.orange)}setColour(t){super.setColour(t),this.$path.setAttr("fill",E(t))}static makeThumbnail(t,i){let n=c("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},i);c("rect",{fill:m.orange,rx:5,width:50,height:50},n),c("text",{x:25,y:35,fill:"#fff","text-anchor":"middle","font-size":30,text:"15"},n)}};var Tc=3.5,Vm=1.5,hn={USD:[{value:1,width:19.05},{value:5,width:21.21},{value:10,width:17.91},{value:25,width:24.26},{value:100,width:26.49}],EUR:[{value:1,width:16.25},{value:2,width:18.75},{value:5,width:21.25},{value:10,width:19.75},{value:20,width:22.25},{value:50,width:24.25},{value:100,width:23.25},{value:200,width:25.75}],GBP:[{value:1,width:20.3},{value:2,width:25.9},{value:5,width:18},{value:10,width:24.5},{value:20,width:21.2},{value:50,width:27.3},{value:100,width:22.4},{value:200,width:28.4}]},Lm=hn.EUR[0].width*Tc,Tw=Lm-2;function rl(e){return Object.keys(hn).map(s=>e.filter(t=>t.currency===s)).filter(s=>s.length)}var Cw=ue((e,s)=>{let t=hn[e].map(o=>o.value).filter(o=>o<s),i=[],n=t.length-1,r=0;for(;r<s&&n>=0;)r+t[n]<=s?(r+=t[n],i.push(t[n])):n-=1;return i});function km(e){let s=e[0].currency,t=e.map(l=>l.value),i=q(t),n=hn[s].map(l=>l.value).filter(l=>l<=i),r=[],o=n.length-1,a=0;for(;a<i&&o>=0;)a+n[o]<=i?(a+=n[o],r.push(n[o])):o-=1;if(!(a!==i||r.sort().join("")===t.sort().join("")))return r}function Om(e,s=!1){s&&(e=e.sort((f,v)=>v-f));let t=e.length,i={};for(let f of e)i[f]=(i[f]||0)+1;let n=Object.values(i),r=n.filter(f=>f>=4).length>1||n.filter(f=>f>=3).length>2||n.some(f=>f>=8)||n.some(f=>f>=5)&&t>10||n.some(f=>f>=4)&&t>12,o=10,a=0,l=-1,h=e.map((f,v)=>{if(!r)return[v%o,Math.floor(v/o)];let w=v>0&&(l+1>=o||f!==e[v-1]);return l=w?0:l+1,a=w?a+1:a,[l,a]}),d=Math.max(...h.map(f=>f[0])),u=Math.max(...h.map(f=>f[1]));return h.map(([f,v],w)=>({value:e[w],posn:new p(f-d/2,v-u/2).scale(Tw)}))}function Sc(e,s){let t=`/polypad/assets/currency/coins-${s.value}-${e.toLowerCase()}.svg`;return c("image",{width:s.width,height:s.height||s.width,href:t})}function Mw(e,s){let t=D/(e===5?4.5:e),i=Math.PI*Math.random(),n=s*.5;return B(r=>{if(e===5&&r===4)return $;let o=t*(Math.random()-.5)/2,a=Math.random()*s*(e===3?.33:.1);return p.fromPolar(t*r+i+o,n+a)},e)}var mi=class extends T{constructor(t,i,n){super(i,n);this.type="currency";this.options=t;let[r,o]=t.split(":");this.value=+r,this.currency=o,this.change=Cw(this.currency,this.value);let a=hn[this.currency].find(d=>d.value===+this.value);if(!a.height){let d=a.width*Tc/2,u=Sc(this.currency,a);u.css("transform",`translate(${-a.width/2}px,${-a.width/2}px) scale(${Tc})`),this.$el.append(u),this.$outline=c("circle",{r:d,class:"outline"},this.$el),this.path=new H($,d);return}this.$el.append(Sc(this.currency,a));let l=a.width*Vm,h=a.height*Vm;this.$outline=c("rect",{width:l,height:h,class:"outline"},this.$el),this.path=new x($,l,h)}split(){let t=Mw(this.change.length,Lm);return this.change.map((i,n)=>{let r=new mi(`${i}:${this.currency}`,this.$parent);return r.setTransform(this.posn.add(t[n]),this.rot),r})}static makeThumbnail(t,i){let[n,r]=t.split(":"),o=hn[r].find(d=>d.value===+n),a=!o.height,l=`-1 -1 ${o.width+2} ${(o.height||o.width)+2}`;c("svg",{width:a?60:120,height:60,viewBox:l},i).append(Sc(r,o))}};I([{type:"button",tileTypes:["currency"],label:"Make change",show:e=>st(q(e.map(s=>s.change.length)),1,201),click:(e,s)=>{let t=[],i=[];for(let n of e)!n.change.length||(t.push(...n.split()),n.delete(),i.push(n));s.selection.select(t),s.playSound("splitCoins"),s.change({added:t,deleted:i})}},{type:"button",tileTypes:["currency"],label:"Cash in",show:e=>e.length>1&&rl(e).some(s=>km(s)),click:(e,s)=>{let t=[],i=[];for(let n of rl(e)){let r=km(n);if(r){let o=n[0].currency,a=x.aroundPoints(n.map(l=>l.posn)).center;for(let l of n)l.delete();i.push(...n);for(let{value:l,posn:h}of Om(r,!0)){let d=new mi(`${l}:${o}`,s);d.setTransform(a.add(h)),t.push(d)}}}s.selection.select(t),s.playSound("mergeCoins"),s.change({deleted:i,added:t})}},{type:"button",tileTypes:["currency"],label:"Organize",show:e=>e.length>1&&rl(e).some(s=>s.length>1),click:(e,s)=>{for(let t of rl(e)){if(t.length<=1)return;let i=x.aroundPoints(t.map(o=>o.posn)).center,n=[...t].sort((o,a)=>a.value-o.value||o.posn.y-a.posn.y||o.posn.x-a.posn.x),r=Om(n.map(o=>o.value));for(let[o,a]of n.entries())a.select(),s.selection.tiles.delete(a),s.selection.tiles.add(a),a.animateTo(i.add(r[o].posn))}s.change({changed:e})}}]);var Ew="M7,4,2.3-.3,6.6-5a1.2,1.2,0,0,0,0-1.5l-.4-.3a1,1,0,0,0-1.4,0L0-2.5-4.8-6.8a1,1,0,0,0-1.4,0l-.4.3A1.2,1.2,0,0,0-6.6-5L-2.3-.3-7,4a1.1,1.1,0,0,0-.1,1.4l1.5,1.4a.9.9,0,0,0,1.3,0L0,2.1,4.3,6.8a.9.9,0,0,0,1.3,0L7.1,5.4A1.1,1.1,0,0,0,7,4Z",Im="M7.7-5.7l-.2-.4-.3-.2c-.1-.1-.3,0-.4,0A36.6,36.6,0,0,0-3,2.1,36.1,36.1,0,0,0-7.8-.8h-.5l-1,.9a.4.4,0,0,0-.1.3c0,.2,0,.3.1.4a72.1,72.1,0,0,1,6.6,7h.4l.4-.2C1.9,1,3.8-1.8,7.5-5.2,7.7-5.3,7.7-5.5,7.7-5.7Z",Rm={fill:"none",style:"touch-action: none",stroke:m.green},Cc=class{constructor(s){this.$el=c("g",{});this.$ring=c("circle",et({opacity:.6},Rm),this.$el);this.$burst=c("path",Rm,this.$el);this.$mark=c("g",{class:"problem-marker"},this.$el);this.$circle=c("circle",{r:13},this.$mark);this.$cross=c("path",{d:Ew,fill:"white"},this.$mark);this.$check=c("path",{d:Im,fill:"white"},this.$mark);this.isAnimating=!1;s.append(this.$el)}show(s=!1,t=!0){this.$cross.toggle(!s),this.$check.toggle(s),this.$circle.setAttr("fill",s?m.green:m.red),this.$mark.addClass("show"),t&&s&&this.burst()}hide(){this.$mark.removeClass("show")}burst(s=1e3,t=60,i=20){return R(this,null,function*(){this.isAnimating||(this.isAnimating=!0,yield K(n=>{let r=ot("sine-out",n);this.$ring.setAttr("r",.6*r*t),this.$ring.setAttr("stroke-width",.25*(1-r)*t);let o=ot("exp-out",n),a=(.4+.6*o)*t,l=(.1+.9*o)*t,h="";for(let d=0;d<i;++d){let u=Math.cos(D*d/i),f=Math.sin(D*d/i);h+=`M${u*l} ${f*l}L${u*a} ${f*a}`}this.$burst.setAttr("d",h)},s).promise,this.isAnimating=!1)})}},cn=class extends T{constructor(t,i,n){super(i,n);this.type="question-blank";this.size=100;this.canRotate=!1;this.solution="";this.submitted="";this.attempts=0;this.correct=!1;this.options=t||"Pw::0";let[r,o,a]=this.options.split(":");this.solution=atob(r),this.submitted=o,this.attempts=+a||0,this.$box=c("rect",{class:"problem-box",rx:6},this.$el),this.$text=c("text",{class:"problem-text",text:this.text,y:36},this.$el),this.mark=new Cc(this.$el),this.$input=c("input",{class:"problem-text"},i.$html),this.$input.onKeyDown("enter",()=>this.$input.blur()),this.$input.on("blur",()=>this.blur()),this.$parent.canEditQuestions?(this.$handle=this.makeHandle("c",l=>this.setSize(l.x)),this.$handle.css("cursor","ew-resize")):(this.$input.setInputPattern(this.solution),this.checkAnswer(!1),this.canMove=!1,this.hideActionBar=!0),this.setSize(100),this.setOrder("front")}setSize(t){var i;super.setSize(ht(S(t,50,400),25)),this.path=new x($,this.size,50),this.$input.css({width:this.size+"px",height:"50px"}),this.$box.setRect(this.path),this.$text.setAttr("x",this.size/2),this.mark.$el.setTransform({x:this.size,y:0}),(i=this.$handle)==null||i.setCenter({x:this.size,y:50}),this.transform()}hideForThumbnail(t){this.$text.text=t?this.text:"?"}delete(){this.hideActionBar||(super.delete(),this.$input.remove())}get text(){return(this.$parent.canEditQuestions?this.solution:this.submitted)||"?"}click(){this.isFocussed||this.$parent.events.shiftKey||this.correct&&!this.$parent.canEditQuestions||(this.isFocussed=!0,this.$parent.selection.add(this,!0),setTimeout(()=>{this.$el.removeClass("correct incorrect"),this.mark.hide()}),this.$input.css({top:this.posn.y+"px",left:this.posn.x+"px"}),this.$input.value=this.text,this.$text.hide(),this.$input.show(),this.$input.focus(),document.execCommand("selectAll",!1))}blur(){if(!this.isFocussed)return;this.isFocussed=!1,this.$input.hide(),this.$text.show();let t=this.text,i=this.$input.value.trim();this.$parent.canEditQuestions?(this.solution=i.replace(":",""),this.options=`${btoa(i)}::0`):(i&&i!==this.submitted&&(this.attempts+=1),this.submitted=i==="?"?"":i.replace(":",""),this.options=`${btoa(this.solution)}:${i}:${this.attempts}`,setTimeout(()=>{this.checkAnswer(),cn.gradeWorksheet(this.$parent)})),this.$text.text=this.text,this.text!==t&&this.$parent.change({changed:[this]})}isCorrect(){if(!this.submitted||!this.solution)return!1;if(this.submitted.toLowerCase()===this.solution.toLowerCase())return!0;let t=mn(this.solution),i=mn(this.submitted);return P(i,t)||yi(t)===this.submitted||this.solution===yi(i)}checkAnswer(t=!0){this.correct=this.isCorrect(),this.submitted&&this.mark.show(this.correct,t),this.$el.setClass("correct",this.correct),this.$el.setClass("incorrect",!!this.submitted&&!this.correct)}static gradeWorksheet(t){let i=[0,0,0,0];for(let n of t.getTilesOfType("question-blank"))i[0]+=1,n.submitted&&(i[n.correct?n.attempts<=1?1:2:3]+=1);i[0]===i[1]+i[2]&&Zs()}static makeThumbnail(t,i){let n=c("svg",{width:130,height:70},i);c("rect",{x:15,y:15,width:100,height:50,class:"problem-box",rx:6},n),c("text",{x:65,y:50,text:"?",class:"problem-text"},n),c("circle",{cx:115,cy:15,r:13,fill:m.blue},n),c("path",{d:Im,fill:"white",transform:"translate(115 15)"},n)}};var Nm=ue(Sr),ol=class extends T{constructor(t,i,n){super(i,n);this.type="image";this.path=new x($,0,0);this.aspectRatio=1;this.options=t,this.$image=c("image",{href:t,crossorigin:"anonymous"},this.$el),this.$outline=c("path",{class:"outline"},this.$el),Nm(t).then(r=>{this.aspectRatio=r.height/r.width,this.setSize(this.size||r.width)}),this.$handle=this.makeHandle("c",r=>this.setSize(r.x)),this.$handle.css("cursor","nwse-resize")}setHref(t){this.options=t,this.$image.setAttr("href",t),Nm(t)}setSize(t){let i=Math.max(50,50*this.aspectRatio),n=Math.min(1e3,1e3/this.aspectRatio);this.size=S(t,i,n),this.$image.setAttr("width",this.size),this.$image.setAttr("height",this.aspectRatio*this.size),this.path=new x($,this.size,this.aspectRatio*this.size),this.$outline.draw(this.path),this.$handle.setCenter({x:this.size,y:this.aspectRatio*this.size}),this.transform(),this.$parent.selection.update()}};var Aw={bold:"font-weight",italic:"font-style",underline:"text-decoration",colour:"color"};function Gm(e,s){return e.style.getPropertyValue(s)||""}function Dm(e,s,t){e.style.setProperty(s,t)}function Vw(e,s){s==="font-weight"||s==="font-style"?e.style.setProperty(s,"normal"):s==="text-decoration"?e.style.setProperty(s,"none"):e.style.removeProperty(s)}var al=class extends T{constructor(t,i,n){super(i,n);this.type="text";this.size=0;this.creating=!1;this.$box=c("rect",{fill:"transparent"},this.$el),this.$foreignObject=c("foreignObject",{x:this.posn.x,y:this.posn.y,width:1,height:1,overflow:"visible"},this.$el),this.$text=c("div",{class:"text-edit",style:"pointer-events: none",xmlns:"http://www.w3.org/1999/xhtml"},this.$foreignObject),this.$outline=c("path",{class:"outline"},this.$el),this.options=this.$text.html=xu(t)||"Text",this.setColour(i.state.penColor),this.setOrder("front"),this.updateOutline(),this.$text.on("pointerdown",r=>r.handled=!0),this.$text.on("keydown",r=>this.interceptKeys(r)),this.$text.on("blur",()=>this.blur())}setSize(t){super.setSize(S(t,-5,10)),this.$text.css("font-size",20*1.2**this.size+"px"),this.updateOutline()}setColour(t){if(this.isFocussed)return this.formatFont("color",t);this.colour=t,this.$text.css("color",E(this.colour))}getSnapPoints(){return[]}updateOutline(){let t=this.$text.width,i=this.$text.height;this.$foreignObject.setAttr("width",t||1),this.$foreignObject.setAttr("height",i||1),this.path=new x($,t,i),this.$box.setRect(this.path),this.$outline.draw(this.path),this.transform()}selectAll(){let t=this.selection,i=document.createRange();i.selectNodeContents(this.$text._el),t==null||t.removeAllRanges(),t==null||t.addRange(i)}format(t){this.formatFont(Aw[t]||"",t),this.cleanupElements(this.$text._el.children),this.updateOutline(),this.options=this.$text.html}get selection(){var i,n;return(((n=(i=this.$el._el).getRootNode)==null?void 0:n.call(i))||document).getSelection()}formatFont(t,i){if(!this.isFocussed){let o=new Range,a=this.$text._el.childNodes;return o.setStartBefore(a[0]),o.setEndAfter(a[a.length-1]),this.formatRange(o,t,i)}let n=this.selection;if(!n)return;let r=[];for(let o=0;o<n.rangeCount;++o){let a=n.getRangeAt(o);this.formatRange(a,t,i),r.push(n.getRangeAt(o))}n.removeAllRanges();for(let o=0;o<r.length;++o)n.addRange(r[o])}formatRange(t,i,n){let r=t==null?void 0:t.extractContents().childNodes;if(!r)return;let o=t.commonAncestorContainer;(o==null?void 0:o.nodeName)==="#text"&&o.parentNode&&(o=o.parentNode),this.removeEmptyTextNodes(r),this.wrapChildrenInSpans(o,r,i),this.updateRangeChildren(r,i,n);for(let a=r.length-1;a>=0;--a)t.insertNode(r[a])}removeEmptyTextNodes(t){for(let i=0;i<t.length;i++){let n=t[i];n.nodeName==="#text"&&!n.nodeValue&&n.remove()}}wrapChildrenInSpans(t,i,n){for(let r=0;r<i.length;++r){let o=i[r];if(o.nodeName==="#text"){let a=document.createElement("span");t.nodeName==="SPAN"&&Dm(a,n,Gm(t,n)),a.appendChild(document.createTextNode(o.nodeValue||"")),o.replaceWith(a)}}}updateRangeChildren(t,i,n){if(n==="smaller"||n==="larger"){let r=t[0],o=parseFloat(r.style.fontSize)||100,a=(n==="smaller"?1/1.2:1.2)*o;this.setChildrenStyles(t,"font-size",a+"%")}else this.allChildrenHaveStyle(t,i,n)?this.unsetChildrenStyles(t,i):this.setChildrenStyles(t,i,n)}allChildrenHaveStyle(t,i,n){for(let r=0;r<t.length;++r){let o=t[r];if(Gm(o,i)!==n||!this.allChildrenHaveStyle(o.children,i,n))return!1}return!0}unsetChildrenStyles(t,i){for(let n=0;n<t.length;++n){let r=t[n];Vw(r,i),this.unsetChildrenStyles(r.children,i)}}setChildrenStyles(t,i,n){for(let r=0;r<t.length;++r){let o=t[r];Dm(o,i,n),this.clearChildrenStyles(o.children,i)}}clearChildrenStyles(t,i){for(let n=0;n<t.length;++n){let r=t[n];r.style.removeProperty(i),this.clearChildrenStyles(r.children,i)}}cleanupElements(t){for(let i=0;i<t.length;++i)this.cleanupElements(t[i].children);for(let i=0;i<t.length;++i)t[i].textContent||t[i].remove();for(let i=0;i<t.length;++i)t[i].getAttribute("style")||t[i].replaceWith(...Array.from(t[i].childNodes))}doubleClick(){this.focus()}focus(t=!1){this.isFocussed||(super.focus(),this.creating=t,this.$text.css("pointer-events","all"),this.$text.setAttr("contenteditable",!0),this.$text.focus(),this.selectAll())}blur(){var n;if(!this.isFocussed)return;super.blur(),this.$text.css("pointer-events","none"),this.$text.removeAttr("contenteditable");let t=this.$text.html,i=this.options!==t;if(t){this.$text.show(),this.options=t,this.updateOutline();let r=this.creating?"added":"changed";(this.creating||i)&&this.$parent.change({[r]:[this]})}else this.delete(),this.creating||this.$parent.change({deleted:[this]});(n=this.selection)==null||n.removeAllRanges()}interceptKeys(t){if(t.key==="Escape"){this.$text.blur(),setTimeout(()=>this.$parent.selection.add(this));return}if(this.path=new x($,this.$text.width,this.$text.height),this.transform(),this.$parent.trigger("change-focus",{tiles:[this]}),!(t.ctrlKey||t.metaKey))return;let n={b:"bold",i:"italic",u:"underline"}[t.key];n&&(t.stopPropagation(),t.preventDefault(),this.format(n))}};I([["Bold","bold"],["Italic","italic"],["Underline","underline"]].map(([e,s])=>({type:"button",label:e,icon:s,tileTypes:["text"],focus:"showAlways",noDivider:s!=="underline",click:(t,i,n)=>{for(let r of t)r.format(s);n||i.change({changed:t})}})));I(["Grow","Shrink"].map((e,s)=>({type:"button",label:e,icon:s?"font-shrink":"font-grow",tileTypes:["text","equation"],focus:"showAlways",noDivider:!s,show:(t,i)=>!i||t.every(n=>n.is("text")),click:(t,i,n)=>{if(n)for(let r of t)r.format(s?"smaller":"larger");else{for(let r of t){let o=r.path.h;r.setSize(r.size+(s?-1:1));let a=r.path.h;r.setTransform(r.posn.shift(0,o-a))}i.change({changed:t})}}})));function ie(e){return!!e.setValue}function _m(e,s){let t=e;for(let i of e.parents()){if(i.type in s&&i.children.indexOf(t)===s[i.type])return i;t=i}}function kw(e,s){for(let t of e.parents(!0))for(let i of s.parents(!0))if(t===i)return i}function Hm(e,s,t=!1){let i=t?e.children.slice(0).reverse():e.children,n=s.parent;return i.findIndex((r,o)=>n.hasParent(a=>a===r)||ie(n)&&n===r||e===n&&(t?i.length-o:o)===s.offset)}var ll=class{constructor(s){this.equation=s;this.offset=0;this.$el=c("line",{class:"cursor",hidden:!0},s.$row),this.$range=c("rect",{class:"range",hidden:!0}),s.$row.prepend(this.$range),this.parent=s.root}redraw(){let s=this.getRangeRect();if(this.$el.toggle(!s),this.$range.toggle(!!s),s)this.$range.setRect(s);else{this.selected=void 0;let t=this.getCursorLine();t&&this.$el.setLine(...t),this.$el.restartAnimation()}}hide(){this.$el.hide(),this.$range.hide(),this.clearRange()}startRange(){this.start={parent:this.parent,offset:this.offset}}clearRange(){this.selected=void 0,this.start=void 0}moveToPoint(s){let t=this.equation.root.hitTest(s)||this.equation.root,i=t.worldTransform,n=(s.x-i.x)/(t.width*i.scale);ie(t)?this.moveInto(t,Math.round(n*t.value.length)):n<.5?this.moveBefore(t):this.moveAfter(t)}getRangeRect(){if(!this.start||this.start.parent===this.parent&&this.start.offset===this.offset)return;let s=kw(this.parent,this.start.parent),t=[s];if(s.children.length){let i=Hm(s,this.start),n=Hm(s,this);n<i&&([i,n]=[n,i]),(i>0||n<s.children.length-1)&&(t=s.children.slice(i,n+1)),t.length||(t=[s]),(i<0||n<0)&&s.type==="mrow"&&s.parent&&(t=[s.parent]),t.length===1&&t[0].type==="mrow"&&(t=t[0].children.slice(0))}return this.selected=t,x.aroundPoints(vi(t,i=>{let n=i.worldTransform;return[n,{x:n.x+i.width*n.scale,y:n.y+i.height*n.scale}]}))}getCursorLine(){let s=ie(this.parent)?this.parent:this.prev||this.next;if(!s)return;let t=s.worldTransform,i=s.height*t.scale,n=-1;return ie(this.parent)?n=s.width*t.scale*this.offset/s.value.length:this.prev&&(n=this.prev.width*t.scale+1),[{x:t.x+n,y:t.y+2},{x:t.x+n,y:t.y+i-2}]}moveAfter(s){if(s.type==="mrow")return this.moveAfter(_(s.children));if(!s.parent)throw new Error("Move cursor to unattached node");this.parent=s.parent,this.offset=this.parent.children.indexOf(s)+1}moveBefore(s){if(s.type==="mrow")return this.moveBefore(s.children[0]);if(!s.parent)throw new Error("Move cursor to unattached node");this.parent=s.parent,this.offset=this.parent.children.indexOf(s)}moveInto(s,t){if(ie(s)){if(t<=0)return this.moveBefore(s);if(t>=s.value.length)return this.moveAfter(s)}this.parent=s,this.offset=t}get prev(){return this.parent.children[this.offset-1]}get next(){return this.parent.children[this.offset]}handleShift(s,t=!1){if(s&&!this.selected)this.startRange();else if(!s&&this.selected)return t?this.moveBefore(this.selected[0]):this.moveAfter(_(this.selected)),this.clearRange(),!0;this.selected&&this.parent!==this.selected[0].parent&&this.moveAfter(_(this.selected))}left(s){if(this.handleShift(s,!0))return;if(this.selected)return this.offset-=1;if(ie(this.parent))return this.moveInto(this.parent,this.offset-1);let t=this.prev;if(t)return ie(t)?this.moveInto(t,t.value.length-1):t.children.length?this.moveAfter(_(t.children)):this.moveBefore(t);let i=this.parent,n=(i==null?void 0:i.type)==="mrow";if(n&&(i==null?void 0:i.prev))return this.moveAfter(i.prev);let r=n?i.parent:i;r&&this.moveBefore(r)}right(s){if(this.handleShift(s))return;if(this.selected)return this.offset+=1;if(ie(this.parent))return this.moveInto(this.parent,this.offset+1);let t=this.next;if(t)return ie(t)?this.moveInto(t,1):t.children.length?this.moveBefore(t.children[0]):this.moveAfter(t);let i=this.parent,n=(i==null?void 0:i.type)==="mrow";if(n&&(i==null?void 0:i.next))return this.moveBefore(i.next);let r=n?i.parent:i;r&&this.moveAfter(r)}up(s){this.selected&&this.clearRange();let t=_m(this.parent,{mfrac:1,msub:1,msup:0});(t==null?void 0:t.type)==="mfrac"&&this.moveAfter(_(t.children[0].children)),(t==null?void 0:t.type)==="msub"&&this.moveAfter(_(t.children[0].children)),(t==null?void 0:t.type)==="msup"&&this.moveBefore(t.children[1].children[0])}down(s){this.selected&&this.clearRange();let t=_m(this.parent,{mfrac:0,msub:0,msup:1});(t==null?void 0:t.type)==="mfrac"&&this.moveBefore(t.children[1].children[0]),(t==null?void 0:t.type)==="msub"&&this.moveBefore(t.children[1].children[0]),(t==null?void 0:t.type)==="msup"&&this.moveAfter(_(t.children[0].children))}backspace(){var r;if(this.selected){this.moveBefore(this.selected[0]);for(let o of this.selected)o.deleteFromDom();this.clearRange(),this.parent.children.length||this.parent.addChildren([this.placeholder]);return}if(ie(this.parent)){let o=this.parent.value;return this.setText(o.slice(0,this.offset-1)+o.slice(this.offset)),this.moveInto(this.parent,this.offset-1)}let s=this.prev;if(s)return ie(s)&&s.value.length>1?s.setValue(s.value.slice(0,s.value.length-1)):s.type==="placeholder"||s.children.length?this.left():(s.deleteFromDom(),this.parent.children.length||this.parent.addChildren([this.placeholder]),this.moveInto(this.parent,this.offset-1));let t=this.parent,i=t.children,n=0;t.type==="mrow"&&t.parent&&(n=((r=t.prev)==null?void 0:r.children.filter(o=>o.type!=="placeholder").length)||0,t=t.parent,i=Bt((t==null?void 0:t.children.map(o=>o.children))||[])),t!=null&&t.parent&&(this.moveInto(t.parent,t.index+n),t.insertAfter(i.filter(o=>o.type!=="placeholder")),t.deleteFromDom(),this.parent.children.length||this.parent.addChildren([this.placeholder]))}get placeholder(){return new kn(this.equation)}setText(s,t){if(!t&&ie(this.parent)&&(t=this.parent),!!t){if(s in Ts&&(s=Ts[s]),s==="sqrt"){let i=this.createNode("msqrt");return t.insertAfter([i]),t.deleteFromDom(),this.moveBefore(i.children[0].children[0])}t.setValue(s)}}createNode(s,t){let i=Ye(this.equation,t||[this.placeholder]);if(s==="mfenced")return new _i([i],this.equation);if(s==="msqrt")return new ii(s,[i],this.equation);let n=Ye(this.equation,[this.placeholder]);if(s==="mfrac")return new On([i,n],this.equation);if(s==="mroot")return new ii(s,[i,n],this.equation);if(s==="msub"||s==="msup")return new ei(s,[i,n],this.equation)}splitTextNode(){let s=this.parent,t=s.value.slice(this.offset);s.setValue(s.value.slice(0,this.offset)),s.insertAfter([new Ms(s.type,t,this.equation)]),this.moveAfter(s)}insert(s,t){var n,r,o,a,l;let i=((n=this.prev)==null?void 0:n.type)==="placeholder";if(ie(this.parent)&&!this.start&&!this.selected){let h=this.parent.value;((r=this.parent)==null?void 0:r.type)===s?(this.setText(h.slice(0,this.offset)+t+h.slice(this.offset)),this.moveInto(this.parent,this.offset+1)):(this.splitTextNode(),this.insert(s,t))}else if(s==="mi"||s==="mn"||s==="mtext")this.selected&&this.backspace(),((o=this.prev)==null?void 0:o.type)===s?this.setText(this.prev.value+t,this.prev):((a=this.next)==null?void 0:a.type)===s?(this.setText(t+this.next.value,this.next),this.moveInto(this.next,1)):(this.parent.addChildren([new Ms(s,t,this.equation)],this.offset),i||(this.offset+=1));else if(s==="mo"||s==="mspace"){this.selected&&this.backspace();let h=s==="mo"?new Ms("mo",t,this.equation):new Vn(this.equation);this.parent.addChildren([h],this.offset),i||(this.offset+=1)}else{let h=s==="msub"||s==="msup"||s==="mfrac"&&((l=this.prev)==null?void 0:l.type)!=="mo",d=this.selected||(h&&this.prev?[this.prev]:void 0);d&&this.moveBefore(d[0]),this.selected&&this.clearRange();let u=this.createNode(s,d);this.parent.addChildren([u],this.offset),this.moveBefore(u.children[d&&u.children.length>1?1:0].children[0])}}toSubSup(s){let t=this.placeholder,i=s.type==="msub"?2:1;s.addChildren([Ye(this.equation,[t])],i),s.type="msubsup",this.moveBefore(t)}type(s){var t,i,n,r,o,a;if(s=s.replace("*","\xD7").replace("-","\u2212"),s.match(/^[A-Za-zπ]$/))this.insert("mi",s);else if("0123456789.".includes(s))this.insert("mn",s);else if("+\u2212\xB1\xD7\xF7<>\u2264\u2265=%!".includes(s))this.insert("mo",s);else if(s===" "){let l=(t=this.prev)==null?void 0:t.type,h=(i=this.next)==null?void 0:i.type;if(l==="placeholder"||l==="mspace"||h==="placeholder"||h==="mspace"||!ie(this.parent)&&l!=="mi"&&h!=="mi")return;this.insert("mspace")}else if(s==="frac"||s==="/")this.insert("mfrac",s);else if(s==="sqrt")this.insert("msqrt",s);else if(s==="^"||s==="sup"){if(((n=this.prev)==null?void 0:n.type)==="msub")return this.toSubSup(this.prev);this.insert("msup",s)}else if(s==="_"||s==="sub"){if(((r=this.prev)==null?void 0:r.type)==="msup")return this.toSubSup(this.prev);this.insert("msub",s)}else if(s==="brackets"||"([{|".includes(s))this.insert("mfenced",s);else if(")]}".includes(s))if(((a=(o=this.parent)==null?void 0:o.parent)==null?void 0:a.type)==="mfenced")this.moveAfter(this.parent.parent);else{let l=this.prev;this.parent.addChildren([this.createNode("mfenced",l?[l]:void 0)],this.offset),l||(this.offset+=1)}}copy(){return this.selected?this.selected.map(s=>s.expr).join(""):""}paste(s){try{let t=this.equation.parse(s);if(this.selected&&this.backspace(),t.length===1&&ie(t[0]))return this.insert(t[0].type,t[0].value),t[0].deleteFromDom();ie(this.parent)&&this.splitTextNode(),this.parent.addChildren(t,this.offset),this.moveAfter(_(t))}catch(t){}}};var Mc=class{constructor(s,t,i=!0){this.$el=c("g",{class:"equation","font-size":"20px"},s),this.equation=new Te(this.$el,void 0,0,"",20,i);try{this.equation.setValue(t)}catch(n){console.warn("Parsing error",t,n.message)}}get expr(){return Ot.parse(this.equation.root.expr).collapse()}get width(){return this.equation.root.width}get height(){return this.equation.root.height}},Ec=class extends Mc{constructor(t,i,n,r=!0){super(i,n,r);this.tile=t;this.cursor=new ll(this.equation),this.$textarea=c("textarea",{class:"hidden-input",tabindex:-1},t.$parent),this.$textarea.on("key",o=>this.handleKey(o)),this.$textarea.on("blur",()=>t.blur()),this.$textarea.on("cut copy",o=>{var a;(a=window.navigator.clipboard)==null||a.writeText(this.cursor.copy()),o.type==="cut"&&(this.cursor.backspace(),this.redraw())}),this.$textarea.on("paste",()=>R(this,null,function*(){var a;let o=yield(a=window.navigator.clipboard)==null?void 0:a.readText();!o||(this.cursor.paste(o),this.redraw())}))}redraw(){this.equation.resize(),this.tile.transform(),this.cursor.redraw(),this.tile.$parent.trigger("change-focus",{tiles:[this.tile]})}bindSlideEvents(t,i){this.tile.$parent.events.listen(this.tile.$el,{down:n=>{n.event.preventDefault(),this.cursor.clearRange(),this.moveCursor(t(n))},start:()=>this.cursor.startRange(),move:n=>this.moveCursor(t(n)),blurInput:!1,checkIfActive:i})}handleKey(t){var i;if(!((i=this.excludedChars)!=null&&i.includes(t.char))){if(t.code===ce.enter||t.code===ce.escape){this.$textarea.blur(),setTimeout(()=>this.tile.$parent.selection.add(this.tile,!0));return}else if(t.code===ce.left)this.cursor.left(t.shift);else if(t.code===ce.right)this.cursor.right(t.shift);else if(t.code===ce.up)this.cursor.up(t.shift);else if(t.code===ce.down)this.cursor.down(t.shift);else return t.code===ce.backspace||t.code===ce.delete?(this.cursor.backspace(),this.redraw()):(this.cursor.type(t.char),this.redraw());this.cursor.redraw()}}moveCursor(t){this.cursor.moveToPoint(t||$),this.cursor.redraw()}focus(){this.$textarea.show(),this.$textarea.focus()}blur(){return this.cursor.hide(),this.$textarea.hide(),this.equation.updateDescription(),this.equation.root.expr}delete(){this.$el.remove(),this.$textarea.remove()}},hl=class extends T{constructor(t,i,n){super(i,n);this.type="equation";this.size=0;this.linkTypes=["axes"];this.creating=!1;this.options=t||"placeholder",this.$box=c("rect",{fill:"transparent"},this.$el),this.$outline=c("rect",{class:"outline"},this.$el),this.$resultText=c("text",{opacity:.5,style:"font-size: 13px"},this.$el),this.watchPolypadOptions(r=>{var o;this.$resultText.toggle(r.evalEquations),(o=this.watcher)==null||o.call(this)}),this.equationArea=new Ec(this,this.$el,this.options),this.equationArea.bindSlideEvents(r=>this.getCursorOffset(r),()=>!!this.isFocussed),this.setOrder("front"),this.makeOutPort("main",{tileTypes:["axes"],connect:r=>r.enqueueMessage({type:"equation",text:this.options})}),this.transform(),this.setColour(i.state.penColor),this.updateMath()}setSize(t){super.setSize(S(t,-5,10)),this.equationArea.$el.css("transform",this.size?`scale(${this.scale})`:""),this.$resultText.css("font-size",13*this.scale+"px"),this.transform()}get scale(){return 1.2**this.size}doubleClick(t){this.focus(!1,t)}customTransform(){let t=this.equationArea.width*this.scale+16,i=this.equationArea.height*this.scale+12;this.path=new x($.shift(-8,-6),t,i);for(let n of[this.$box,this.$outline])n.setRect(this.path);this.$resultText.setTransform({x:0,y:i+10*this.scale-6})}setColour(t){super.setColour(t),this.equationArea.$el.css("color",E(this.colour)),this.$resultText.setAttr("fill",E(this.colour)),this.emitMessage("main",{type:"equation",text:this.options})}delete(){super.delete(),this.equationArea.delete()}getSnapPoints(){return[]}focus(t=!1,i){this.isFocussed||(super.focus(),this.creating=t,this.showErrorIcon(void 0),this.$el.css("cursor","text"),this.equationArea.focus(),this.equationArea.moveCursor(this.getCursorOffset(i)))}blur(){if(!this.isFocussed)return;super.blur(),this.$el.css("cursor","grab");let t=this.options;if(this.options=this.equationArea.blur(),this.updateMath(),this.creating||t!==this.options){let i=this.creating?"added":"changed";this.$parent.change({[i]:[this]}),this.emitMessage("main",{type:"equation",text:this.options})}}updateMath(){let t=this.$parent.mathContext;this.watcher&&t.unwatch(this.watcher);let i=t.attemptUpdateSource(this,this.options);if(!i){this.watcher=void 0,this.value=0;return}let n=nn(i)[1]instanceof cs,r=()=>{let{error:o,value:a}=t.evaluate(i);if(this.showErrorIcon(this.$parent.options.evalEquations?o:void 0),this.value=a||0,n||isNaN(a))return this.$resultText.textStr="";this.$resultText.textStr=`= ${nt(a,8)}`};this.watcher=r,t.watch(i.unknowns,r,!0)}getCursorOffset(t){return t?this.relativePosn(t.posn).scale(1/this.scale):$}};I([["Fraction","fraction","frac"],["Exponent","power","sup"],["Square Root","sqrt","sqrt"]].map(([e,s,t])=>({type:"button",label:e,icon:s,tileTypes:["equation"],focus:"show",click:i=>i[0].equationArea.handleKey({char:t})})));var Ns,ir=new Map;function Ow(e){return R(this,null,function*(){if(Ns||(Ns=new AudioContext),ir.has(e))return ir.get(e);let s=yield fetch(e).then(i=>i.arrayBuffer()),t=yield Ns.decodeAudioData(s);return ir.set(e,t),t})}function Lw(e,s=.2){return R(this,null,function*(){if(!Ns)return;yield Ns.resume();let t=Ns.createBufferSource();t.buffer=e;let i=Ns.createGain();i.gain.value=s,t.connect(i).connect(Ns.destination),t.start()})}var Is="/polypad/assets/audio/instruments",Ac={perc:{name:"Perc",url:`${Is}/perc.mp3`},snare:{name:"Snare",url:`${Is}/snare.mp3`},clap:{name:"Clap",url:`${Is}/clap.mp3`},kick:{name:"Kick",url:`${Is}/kick.mp3`},openHat:{name:"Open Hat",url:`${Is}/open.mp3`},closedHat:{name:"Closed Hat",url:`${Is}/closed.mp3`},tomHigh:{name:"High Tom",url:`${Is}/tom-high.mp3`},tomLow:{name:"Low Tom",url:`${Is}/tom-low.mp3`}},nr=50,cl=class extends T{constructor(t,i,n){super(i,n);this.type="logic-speaker";this.model=mt({soundName:"kick"});this.path=new x($,nr,nr),this.$body=c("rect",{rx:5},this.$el),this.$body.setRect(this.path),this.$outline=c("rect",{class:"outline",rx:5},this.$el),this.$outline.setRect(this.path);let r=c("use",{href:"/icons.svg#audio",fill:"#fff",width:36,height:36,x:9,y:7},this.$el);this.setColour(m.yellow),this.model.soundName=t||"kick",this.model.watch(()=>R(this,null,function*(){this.options=this.model.soundName,Ow(Ac[this.model.soundName].url)}));let o=()=>{let l=Ac[this.model.soundName].url;r.effect("speaker-move"),ir.has(l)&&Lw(ir.get(l))},a=0;this.makeInPort("main",{location:[new p(0,nr/2),Math.PI],message:l=>{l.type==="number"&&(l.value===1&&!a&&o(),a=l.value)},disconnect:()=>a=0,max:1,tileTypes:ss})}setColour(t,i){super.setColour(t,i),this.$body.setAttr("fill",t)}static makeThumbnail(t,i){let n=c("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},i);c("rect",{fill:m.yellow,rx:5,width:50,height:50},n),c("use",{href:"/icons.svg#audio",fill:"#fff",width:36,height:36,x:7,y:7},n)}};I([{type:"select",tileTypes:["logic-speaker"],label:"Sound:",options:Object.entries(Ac).map(([e,s])=>({key:e,label:s.name})),get:e=>e.model.soundName,set:(e,s)=>s.model.soundName=e}]);var Bm="M37.9,37.8,30.5,9.5,25,8,19.5,9.5,12.1,37.8s-.1.6-.1.8A3.3,3.3,0,0,0,15.2,42H34.8A3.3,3.3,0,0,0,38,38.6C38,38.4,37.9,37.8,37.9,37.8ZM16.7,32,22,11.9l3-.8,3,.8L33.3,32Z",dl=class extends T{constructor(t,i,n){super(i,n);this.type="logic-metronome";this.path=new x($,nr,nr);this.$body=c("rect",{rx:5},this.$el),this.$body.setRect(this.path),this.$outline=c("rect",{class:"outline",rx:5},this.$el),this.$outline.setRect(this.path),c("path",{d:Bm,fill:"white"},this.$el),this.$handle=c("rect",{fill:"white",x:22.5,y:14,width:5,height:22,rx:3,"stroke-width":2,style:"transform-origin:center 100%;transform-box:fill-box;"},this.$el),c("rect",{fill:"white",x:18,y:32,width:14,height:10},this.$el),this.makeOutPort("main",{highlights:!0,location:this.path,persistent:!0,tileTypes:ss}),this.setColour(m.purple),this.options=t||'{"bpm":120}',this.model=mt(JSON.parse(this.options)),this.model.running=!1;let r=()=>this.emitMessage("main",{type:"number",value:1}),o=()=>this.emitMessage("main",{type:"number",value:0}),a,l=Date.now(),h,d=()=>{!this.model.running||(Date.now()>=h*1e3+l&&(l=Date.now(),r(),window.setTimeout(o,50),a=window.setTimeout(d,h*1e3)),requestAnimationFrame(d))};this.model.watchAll(()=>{this.options=JSON.stringify(this.model),a&&clearTimeout(a),h=60/(this.model.bpm||120),o(),this.model.running&&d(),this.$handle.css("animation",this.model.running?`metronome infinite ${h}s ease-in-out`:"")})}setColour(t,i){super.setColour(t,i),this.$body.setAttr("fill",t),this.$handle.setAttr("stroke",t)}static makeThumbnail(t,i){let n=c("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},i);c("rect",{fill:m.purple,rx:5,width:50,height:50},n),c("path",{d:Bm,fill:"white"},n),c("rect",{fill:"white",x:22.5,y:14,width:5,height:22,rx:3,"stroke-width":2,stroke:m.purple},n),c("rect",{fill:"white",x:18,y:32,width:14,height:10},n)}};I([{type:"button",icon:"play",label:"Play",tileTypes:["logic-metronome"],show:e=>e.every(s=>!s.model.running),click:e=>{for(let s of e)s.model.running=!0}},{type:"button",icon:"pause",label:"Pause",tileTypes:["logic-metronome"],show:e=>e.some(s=>s.model.running),click:e=>{for(let s of e)s.model.running=!1}},{type:"input",value:"number",label:"BPM:",tileTypes:["logic-metronome"],range:[10,200],get:e=>e.model.bpm,set:(e,s)=>s.model.bpm=S(Math.round(+e),1,240)}]);var qm={"number-bar":ma,"number-tile":Zn,polygon:W,pentomino:Zo,tangram:Wo,"fraction-bar":pi,"fraction-circle":Va,text:al,"algebra-tile":en,"log-bar":_a,grid:ka,"custom-polygon":Uo,image:ol,dice:ee,"polyhedral-dice":qa,coin:za,"number-line":Ma,"multi-jump":Ea,penrose:Xo,kolam:Yo,"prime-disk":Ji,balance:La,"decimal-grid":va,spinner:an,"custom-spinner":ja,token:Ra,egg:Qo,geo:te,fractal:Jo,ruler:la,protractor:ha,compass:pa,"set-triangle":da,"dot-machine":wa,dot:tn,garden:ea,tantrix:sa,axes:rn,"question-blank":cn,equation:hl,"number-card":ba,card:fi,abacus:$a,bucket:Pa,table:pe,pentagon:ia,domino:Za,slider:Da,"number-grid":Sa,"number-frame":Ta,"ten-frame":Ca,"ten-frame-counter":Xn,"number-dot":sn,polyhedron:ks,chart:ui,"pie-chart":on,clock:Qa,rectangle:ua,random:Xa,"reg-polygon":fa,"box-whisker":Ya,"logic-bulb":il,"logic-button":el,"logic-switch":sl,"logic-gate":tl,"chess-board":ln,"chess-piece":sr,currency:mi,"logic-display":nl,"logic-speaker":cl,"logic-metronome":dl};function Vc(e){if(!(e in qm))throw new Error(`Unknown tile type: ${e}`);return qm[e]}var zm,Fm,pl=new Set,kc=new Set;function Rw(e,s,t){let i=Ct(e-s,t);return i>t/2?i-t:i}var ul=class{constructor(s){this.$parent=s;this.angle=0;this.startAngle=0;this.hasChanged=!1;this.showTools=!1;this.isMoving=!1;this.tiles=new Set;this.implicitChanges=new Set;this.$tools=s.$(".transform-tools"),this.$shadow=s.$(".group-shadow"),this.$rect=this.$tools.$(".group-outline"),this.$rotateBar=this.$tools.$(".rotate-bar"),this.$rotateCircle=this.$tools.$(".rotate-circle");let t=s.$(".rotate-label");t.hide(),s.events.listen(this.$rotateCircle,{start:()=>{this.startAngle=this.angle,this.rotateStart(),t.show()},move:({startPosn:i,posn:n,event:r})=>{this.rotate(this.startAngle-new Vt(n,this.center,i).deg);let o=Qt(r).subtract(s.topLeftPosition);t.setTransform(o.shift(b.isMobile?-15:5,b.isMobile?-100:-40)),t.text=Ct(Ft(this.angle,1),360)+"\u2009\xB0"},end:()=>{this.rotateEnd(),t.hide()}}),b.onKey("up down left right r R",(i,n)=>{if(!(i.metaKey||i.ctrlKey||!this.tiles.size)){if(n==="r"||n==="R"){if(Array.from(this.tiles).some(r=>r.fixed||!r.canRotate))return;this.rotateStart(),this.rotate(this.angle+(n==="R"?-15:15)),this.rotateEnd()}else{let r=$,o=i.shiftKey?5:25,a=n==="left"?-o:n==="right"?o:0,l=n==="up"?-o:n==="down"?o:0,h=r.shift(a,l);this.moveStart(),this.move({posn:h,startPosn:r}),this.moveEnd()}s.trigger("shift-selection")}}),b.onKey("escape",()=>this.clear())}get size(){return this.tiles.size}add(s,t=!1,i=!1){t&&this.clear(),!s.isActive&&this.$parent.tiles.has(s.id)&&this.select([s],i)}select(s,t=!1){var i;(i=this.$parent.focussedTile)==null||i.blur();for(let n of s)n.isActive||!this.$parent.tiles.has(n.id)||(this.tiles.add(n),n.select(),this.hasChanged=!0);t||this.update(!0)}remove(s,t=!1){!s.isActive||(s.deselect(),this.hasChanged=!0,this.tiles.delete(s),t||this.update(!0))}clear(){if(!this.isMoving){for(let s of this.tiles)s.deselect();this.tiles.size&&(this.hasChanged=!0),this.tiles.clear(),this.update(!0)}}getTileProperty(s){if(!this.size)return;let t=Array.from(this.tiles),i=s(t[0]);return t.slice(1).some(r=>s(r)!==i)?void 0:i}update(s=!1){if(s&&!this.hasChanged)return;if(this.hasChanged=!1,this.implicitChanges.clear(),!this.size){for(let l of[this.$shadow,this.$tools])l.hide();this.$parent.trigger("change-selection",{tiles:[],color:void 0});return}let t=Array.from(this.tiles).filter(l=>l.transformed);this.angle=this.getTileProperty(l=>l.rot)||0;let i=we(...t.map(l=>l.transformed.rotate(-U(this.angle)))),n=i.p.shift(i.w/2,i.h/2).rotate(U(this.angle)).shift(-i.w/2,-i.h/2);this.rect=new x(n,i.w,i.h),this.center=this.rect.center;let r=!this.$parent.options.noRotating&&t.every(l=>l.canRotate&&!l.fixed);if(t.length===1&&ct(t[0].transformed)&&(r=!1),r&&this.getTileProperty(l=>l.rotateAroundOrigin)){let l=t[0].posn;t.slice(1).every(h=>h.posn.equals(l))&&(this.center=l,this.angle&&t.length===1&&(this.rect=we(t[0].transformed.rotate(-U(this.angle),l))))}this.$rotateBar.toggle(r),this.$rotateCircle.toggle(r);let o=this.size>1||t[0].showSelectionOutline;this.$rect.toggle(o),this.showTools=!this.getTileProperty(l=>l.hideSelectionOutline),this.$tools.toggle(this.showTools),this.$shadow.toggle(o&&this.showTools),(!r||!this.showTools)&&(this.rotateHandle=void 0),(this.size===1?t[0].$container:this.$parent.$svg).append(this.$tools),this.positionTools();let a=this.getTileProperty(l=>l.colour);this.$parent.trigger("change-selection",{tiles:t,color:a})}positionTools(){if(!this.showTools)return;let s=this.bounds;for(let n of[this.$shadow,this.$rect])n.draw(s);let t=new p(this.center.x,this.rect.p.y),i=new it(t,t.shift(0,-28)).rotate(U(this.angle),this.center);this.$rotateBar.setLine(i.p1,i.p2),this.$rotateCircle.setCenter(i.p2),this.rotateHandle=i.p2}get bounds(){return this.rect.rotate(U(this.angle),this.center)}moveStart(s=!1){for(let t of this.tiles)if(t.fixed||!t.canMove)return;this.isMoving=!0;for(let t of this.tiles)t.moveStart(s);this.startSnapPoints=[];for(let t of this.tiles)for(let i of t.snapPoints)this.startSnapPoints.some(n=>i.equals(n))||this.startSnapPoints.push(i);Fm=this.rect,zm=this.center,this.$parent.newTileShift=0,this.$parent.trigger("move-start")}move({posn:s,startPosn:t}){if(!this.isMoving)return;let i=s.subtract(t),n=this.startSnapPoints.map(a=>a.add(i)),r=this.$parent.snapping.snap(n);r&&(i=i.add(r.shift));let o=this.tiles.size===1?r:void 0;for(let a of this.tiles)a.move(i,o);this.rect=Fm.translate(i),this.center=zm.add(i),this.positionTools(),this.$parent.trigger("move-selection")}moveEnd(s=!1){if(!this.isMoving)return;for(let i of this.tiles)i.transform(),i.moveEnd();if(Ve(this.tiles,i=>i.type==="geo")&&this.$parent.snapping.updateIntersections(),this.$parent.trigger("move-end"),this.isMoving=!1,!this.tiles.size)return;let t=[...Array.from(this.tiles),...Array.from(this.implicitChanges)];this.$parent.change({[s?"added":"changed"]:t}),this.implicitChanges.clear()}rotateStart(){kc.clear();for(let s of this.tiles)for(let t of s.snapAngles)kc.add(Ct(t+s.rot,180));pl.clear(),pl.add(0);for(let s of this.$parent.tiles.values())if(!s.isActive&&!!Ve(this.tiles,t=>p.distance(t.posn,s.posn)<140))for(let t of s.snapAngles)pl.add(Ct(t+s.rot,180));this.$parent.newTileShift=0,this.$parent.trigger("rotate-start")}rotate(s){if(s=ht(s,3),s===this.angle)return;let t=1/0;for(let n of kc)for(let r of pl){let o=Rw(r,n+s-this.startAngle,180);Math.abs(o)<Math.abs(t)&&(t=o)}if(Math.abs(t)<8&&(s+=t),s===this.angle)return;let i=s-this.angle;this.angle=s;for(let n of this.tiles)n.posn=n.posn.rotate(U(i),this.center),n.rot=Ct(n.rot+i,360),n.transform(!0);this.positionTools(),this.$parent.trigger("rotate-selection")}rotateEnd(){for(let s of this.tiles)s.transform();this.$parent.change({changed:Array.from(this.tiles)}),this.$parent.trigger("rotate-end")}copy(){if(this.isMoving||!this.tiles.size||Zt.isMoving)return[];let s=Array.from(this.tiles).map(i=>i.serialize()),t=new Set;for(let i of this.tiles)if(i.is("geo")){for(let n of i.parents)if(!this.tiles.has(n)&&!t.has(n)&&n.geoType==="point"){let r=n.serialize(),o=n.path;r.options=`${n.key}=point(${o.x},${o.y})=${n.label}`,s.push(r),t.add(n)}}return s}delete(){var i;if(this.isMoving||this.$parent.options.noDeleting||Zt.isMoving)return;let s=Array.from(this.tiles).filter(n=>!n.fixed);if(!s.length)return;let t=new Set;for(let n of s){for(let r of vi(((i=n.inPorts)==null?void 0:i.values())||[],o=>o.cables))t.add(r.from.tile);n.delete()}s.some(n=>n.type==="geo")&&this.$parent.snapping.updateIntersections(),this.$parent.change({deleted:s,changed:Array.from(t).filter(n=>!s.includes(n))}),this.$parent.newTileShift=0}};var ms=class{constructor(s){this.$parent=s}getTileAt(s){let t=this.$parent.snapping.snapGeo(s.posn);if((t==null?void 0:t.tile)&&t.tile.canSelect)return t.tile;let i=s.event.target;for(;i;){let n=Do.get(i);if(n&&n.canSelect&&n.type!=="geo")return n;if(i=i.parentNode||void 0,i===this.$parent._el)return}}hoverGeoTile(s){var t;this.hoveringTile!==s&&((t=this.hoveringTile)==null||t.hover(!1)),s==null||s.hover(),this.hoveringTile=s}down(s){}start(s){}move(s){}up(s){}end(s){}click(s){}hover(s){}cancel(){}},fl=class extends ms{constructor(){super(...arguments);this.clickTimeout=0}down(t){var n;let i=this.activeTile=this.getTileAt(t);this.previousSelection=void 0,(n=this.$parent.focussedTile)==null||n.blur(),this.$parent.warningBanner.hide(),i?(i.isActive&&this.$parent.events.shiftKey?this.$parent.selection.remove(i):(this.$parent.events.shiftKey||!i.isActive)&&this.$parent.selection.add(i,!this.$parent.events.shiftKey),i.down(t),Ut.addClass("grabbing")):this.$parent.events.shiftKey?this.previousSelection=new Set(this.$parent.selection.tiles):this.$parent.selection.clear()}up(t){var i;(i=this.activeTile)==null||i.up(t)}start(){this.activeTile?(this.$parent.events.altKey&&this.$parent.paste(this.$parent.selection.copy(),$),this.$parent.selection.moveStart()):this.$parent.$selection.show()}move(t){var n;if(this.activeTile){this.$parent.selection.move(t);return}let i=x.aroundPoints([t.startPosn,t.posn]);this.$parent.$selection.setRect(i);for(let r of this.$parent.tiles.values()){if(!r.canSelect||!r.canDragToSelect||!r.transformed)continue;let o=Bi(i,r.transformed,r.type);(this.$parent.events.shiftKey&&((n=this.previousSelection)==null?void 0:n.has(r))?!o:o)?this.$parent.selection.add(r,!1,!0):this.$parent.selection.remove(r,!0)}this.$parent.selection.update(!0)}end(){this.activeTile?this.$parent.selection.moveEnd():this.$parent.$selection.hide(),Ut.removeClass("grabbing")}click(t){if(this.activeTile){this.activeTile.click(t);let i=Date.now();i-this.clickTimeout<500&&this.activeTile.doubleClick(t),this.clickTimeout=i}}hover(t){let i=this.getTileAt(t);this.hoverGeoTile(i!=null&&i.is("geo")?i:void 0),this.$parent.$svg.css("cursor",i?"grab":"")}},ml=class extends ms{constructor(){super(...arguments);this.erased=[]}down({posn:t}){this.erase(t)}move({posn:t,lastPosn:i}){let n=p.distance(t,i)/4;for(let r=0;r<n;++r)this.erase(p.interpolate(t,i,r/n))}shouldErase(t,i,n){return yt(i)?p.distance(i,t)<10:Mt(i)?i.distanceSquared(t)<100:yr(i)?i.edges.some(r=>r.distanceSquared(t)<100):ct(i)&&n==="geo"?Math.abs(p.distance(t,i.c)-i.r)<10:i.contains(t)}erase(t){for(let i of this.$parent.tiles.values())if(!(!i.transformed||!i.canDragToSelect||!i.canSelect)&&this.shouldErase(t,i.transformed,i.type)){i.delete(),this.erased.push(i);return}for(let i of this.$parent.strokes.values())if(i.hitTest(t,10)){i.delete(),this.erased.push(i);return}}end(){this.erased.length&&(this.$parent.change({deleted:this.erased}),this.$parent.snapping.updateIntersections()),this.erased=[]}click(){this.end()}},gl=class extends ms{constructor(){super(...arguments);this.options="text"}down({posn:t}){let i=this.$parent.newTile(this.options,"");i.setTransform(t.shift(-10,-15)),this.$parent.trigger("add-tile",{tile:i}),this.$parent.setActiveTool("move"),i.focus(!0)}},vl=class extends ms{enable(){this.previousTool=this.$parent.state.tool,this.$parent.setActiveTool("pan")}down(t){this.initialOrigin=this.$parent.origin,this.startPosn=Qt(t.event)}move(t){let i=Qt(t.event).subtract(this.startPosn),n=this.initialOrigin.subtract(i.scale(1/this.$parent.zoom));this.$parent.setViewport(n,this.$parent.zoom)}disable(){this.$parent.setActiveTool(this.previousTool)}},wl=class extends ms{constructor(){super(...arguments);this.options="pen"}getUtensil(t){for(let i of this.$parent.tiles.values()){let n=If(i)?i.getDrawingPath(t):void 0;if(n)return n}}down({posn:t}){this.stroke=new Re(this.$parent,"",this.$parent.state.penColor,this.options),this.stroke.start(t,this.getUtensil(t))}move({posn:t}){this.stroke.addPoint(t)}click(){this.$parent.change({added:[this.stroke]}),this.stroke=void 0}end(t){this.stroke.end(),this.click()}},rr=class extends ms{constructor(){super(...arguments);this.options="line";this.angleIndex=0}expr(t,i){var n;switch(this.options){case"line":return`segment(${t},${i})`;case"circle":return`circle(${t},distance(${t},${i}))`;case"rect":return`rectangle(${t},${i}.x-${t}.x,${i}.y-${t}.y)`;case"angle":return`angle(${i},${(n=this.midPoint)==null?void 0:n.key},${t})`}}snapPoint(t){var o;let i=this.$parent.snapping.snap([t]);i&&(t=t.add(i.shift));let n="",r=((o=i==null?void 0:i.tile)==null?void 0:o.type)==="geo"?i==null?void 0:i.tile:void 0;return(r==null?void 0:r.path)&&yt(r.path)&&(n=r.key),i!=null&&i.intersection&&(n=i.intersection),{point:t,tile:r,expr:n||`point(${t.x},${t.y})`}}getOrMakePointTile(t){var n,r;if(((n=t==null?void 0:t.tile)==null?void 0:n.path)&&yt(t.tile.path))return t.tile;if((r=t==null?void 0:t.tile)!=null&&r.path){let o=t.tile.path.offset(t.point),a=new te(`${t.tile.key}.at(${o})`,this.$parent);return this.$parent.trigger("add-tile",{tile:a}),a}let i=new te(t.expr,this.$parent);return this.$parent.trigger("add-tile",{tile:i}),i}drawPendingPoint(t){var r,o;let i=((o=(r=t.tile)==null?void 0:r.path)==null?void 0:o.type)==="point",n=t.expr.startsWith("intersection");this.$parent.$pendingPoint.toggle(!i),i||(this.$parent.$pendingPoint.setCenter(t.point),this.$parent.$pendingPoint.setClass("intersection",n),this.$parent.$pendingPoint.setAttr("r",n?3.5:6))}down({posn:t}){var r;let i=this.snapPoint(t),n=this.getOrMakePointTile(i);this.createdNewStart=((r=i.tile)==null?void 0:r.geoType)!=="point",this.options==="angle"?this.angleIndex===0?(this.startPoint=n,this.angleIndex=1,this.createdNewStart&&this.$parent.change({added:[n]})):this.angleIndex===1?(this.midPoint=n,this.angleIndex=2,this.path=new te(this.expr(this.startPoint.key,n.key),this.$parent),this.createdNewStart&&this.$parent.change({added:[n]})):(this.path.setExpr(this.expr(this.startPoint.key,n.key)),this.$parent.change({added:this.createdNewStart?[n,this.path]:[this.path]}),this.angleIndex=0,this.path=this.startPoint=this.midPoint=this.createdNewStart=void 0):this.startPoint=n}start(){var t;this.options!=="angle"&&(this.path=new te("",this.$parent),this.startPoint.pending=this.path.pending=!0,(t=this.$parent.$pendingPoint)==null||t.show(),this.hoverGeoTile(void 0))}move({posn:t}){var i;this.options!=="angle"&&(this.endSnap=this.snapPoint(t),this.path.setExpr(this.expr(this.startPoint.key,this.endSnap.expr),!0),this.drawPendingPoint(this.endSnap),this.hoverGeoTile((i=this.endSnap)==null?void 0:i.tile))}end(){var n,r,o;if(this.options==="angle")return;let t=p.distance(this.startPoint.path,this.endSnap.point)<8,i;if(t?this.path.delete():(i=this.getOrMakePointTile(this.endSnap),this.path.setExpr(this.expr(this.startPoint.key,i.key)),this.path.setPending(!1),this.$parent.trigger("add-tile",{tile:this.path})),this.startPoint.setPending(!1),(n=this.$parent.$pendingPoint)==null||n.hide(),this.hoverGeoTile(void 0),this.$parent.snapping.updateIntersections(),this.createdNewStart||!t){let a=[];this.createdNewStart&&a.push(this.startPoint),this.path&&a.push(this.path),i&&((o=(r=this.endSnap)==null?void 0:r.tile)==null?void 0:o.geoType)!=="point"&&a.push(i),this.$parent.change({added:a})}this.startPoint=this.path=this.endSnap=void 0}click(){this.options!=="angle"&&this.createdNewStart&&this.$parent.change({added:[this.startPoint]})}hover(t){var n;let i=this.snapPoint(t.posn);this.drawPendingPoint(i),this.hoverGeoTile(((n=i==null?void 0:i.tile)==null?void 0:n.type)==="geo"?i.tile:void 0),this.options==="angle"&&this.angleIndex===2&&this.path.setExpr(this.expr(this.startPoint.key,i.expr))}cancel(){this.$parent.$pendingPoint.hide(),this.path&&this.path.delete(),this.startPoint=this.path=this.endSnap=void 0,this.angleIndex=0}},yl=class extends rr{constructor(){super(...arguments);this.startId="";this.expression=""}enable(t){var i;this.expression=t,this.$parent.selection.clear(),this.$parent.setActiveTool("geoPending"),(i=window.event)!=null&&i.clientX&&this.hover({posn:Se(window.event,this.$parent.$svg)})}makePath(){return this.path=new te("",this.$parent),this.path.$el.css("opacity",.5),this.path.pending=!0,this.path}down(t){if(!this.expression)return;super.down(t);let i=this.path||this.makePath();i.$el.css("opacity",1),i.setExpr(this.expression.replace(/\$1/g,this.startPoint.key)),i.pending=!1,this.path=void 0,this.$parent.selection.add(i,!0);let n=this.createdNewStart?[this.startPoint]:[];this.$parent.change({added:[...n,i]}),this.$parent.snapping.updateIntersections(),this.$parent.trigger("add-tile",{tile:i}),this.$parent.setActiveTool("move")}hover({posn:t}){var n;if(!this.expression)return;let i=this.snapPoint(t);this.drawPendingPoint(i),this.hoverGeoTile(((n=i==null?void 0:i.tile)==null?void 0:n.type)==="geo"?i.tile:void 0),this.path||this.makePath(),this.path.setExpr(this.expression.replace(/\$1/g,i.expr))}cancel(){super.cancel(),this.expression=""}},bl=class extends ms{enable(){if(this.tiles=Array.from(this.$parent.selection.tiles).filter(t=>!t.fixed),!this.tiles.length)return this.cancel();this.$parent.selection.clear(),this.$parent.setActiveTool("cutPolygon");for(let t of this.tiles)t.$el.addClass("active")}down(){}start({posn:t}){var i;!this.tiles||(this.startPoint=((i=this.$parent.snapping.snap([t]))==null?void 0:i.posn)||t,this.$stroke=c("line",{class:"stroke cut"},this.$parent.$strokes))}move({posn:t}){var i,n;!this.tiles||(this.endPoint=((i=this.$parent.snapping.snap([t]))==null?void 0:i.posn)||t.snap(this.startPoint,5),(n=this.$stroke)==null||n.setLine(this.startPoint,this.endPoint))}end(t){var a;if(!this.tiles)return;if(t.cancelled)return this.cancel();let i=new wt(this.startPoint,this.endPoint),n=!1,r=[],o=[];for(let l of this.tiles||[]){let d=l.transformed.cut(i);if(d.length>1){for(let u of d){let f=new W(gt(u.points),this.$parent);f.setColour(l.colour),f.transform(),r.push(f)}l.delete(),o.push(l),n=!0}else l.$el.removeClass("active")}n&&this.$parent.change({added:r,deleted:o}),(a=this.$stroke)==null||a.remove(),this.$stroke=this.tiles=this.startPoint=this.endPoint=void 0,this.$parent.setActiveTool("move")}click(){this.cancel()}cancel(){var t;for(let i of this.tiles||[])i.$el.removeClass("active");(t=this.$stroke)==null||t.remove(),this.$stroke=this.tiles=this.startPoint=this.endPoint=void 0,setTimeout(()=>this.$parent.setActiveTool("move"))}};var jm='<x-icon class="bg-icon" name="eye-off" size="360"></x-icon><svg class="canvas" tabindex="0"><defs><pattern class="grid-pattern" id="square2-grid" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="50" height="50" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="square-dots" x="-4" y="-4" width="25" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="4" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="square-grid" x="0" y="0" width="125" height="125" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="25" y1="0" x2="25" y2="125"></line><line x1="0" y1="25" x2="125" y2="25"></line><line x1="50" y1="0" x2="50" y2="125"></line><line x1="0" y1="50" x2="125" y2="50"></line><line x1="75" y1="0" x2="75" y2="125"></line><line x1="0" y1="75" x2="125" y2="75"></line><line x1="100" y1="0" x2="100" y2="125"></line><line x1="0" y1="100" x2="125" y2="100"></line></g><rect x="0" y="0" width="125" height="125" opacity="0.5"></rect></pattern><pattern class="grid-pattern" id="tri-dots" x="0" y="-4" width="25" height="43.302" patternUnits="userSpaceOnUse"><circle cx="0" cy="4" r="2" opacity="0.3"></circle><circle cx="25" cy="4" r="2" opacity="0.3"></circle><circle cx="12.5" cy="25.651" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri-grid" x="0" y="0" width="25" height="43.302" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="25" y2="0"></line><line x1="0" y1="21.651" x2="25" y2="21.651"></line><line x1="0" y1="43.302" x2="25" y2="43.302"></line><line x1="0" y1="0" x2="25" y2="43.302"></line><line x1="25" y1="0" x2="0" y2="43.302"></line></g></pattern><pattern class="grid-pattern" id="tri2-dots" x="-4" y="0" width="43.302" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="0" r="2" opacity="0.3"></circle><circle cx="4" cy="25" r="2" opacity="0.3"></circle><circle cx="25.651" cy="12.5" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri2-grid" x="0" y="0" width="43.302" height="25" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="0" y2="25"></line><line x1="21.651" y1="0" x2="21.651" y2="25"></line><line x1="43.302" y1="0" x2="43.302" y2="25"></line><line x1="0" y1="0" x2="43.302" y2="25"></line><line x1="0" y1="25" x2="43.302" y2="0"></line></g></pattern><pattern class="grid-pattern" id="square-checked" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect class="filled" x="0" y="0" width="25" height="25" opacity="0.2"></rect><rect class="filled" x="25" y="25" width="25" height="25" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="rainbow-grid" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="10" y1="-10" x2="-110" y2="110" style="stroke:#cd0e66" stroke-width="17.678"></line><line x1="35" y1="-10" x2="-85" y2="110" style="stroke:#fd8c00" stroke-width="17.678"></line><line x1="60" y1="-10" x2="-60" y2="110" style="stroke:#22ab24" stroke-width="17.678"></line><line x1="85" y1="-10" x2="-35" y2="110" style="stroke:#0f82f2" stroke-width="17.678"></line><line x1="110" y1="-10" x2="-10" y2="110" style="stroke:#cd0e66" stroke-width="17.678"></line><line x1="135" y1="-10" x2="15" y2="110" style="stroke:#fd8c00" stroke-width="17.678"></line><line x1="160" y1="-10" x2="40" y2="110" style="stroke:#22ab24" stroke-width="17.678"></line><line x1="185" y1="-10" x2="65" y2="110" style="stroke:#0f82f2" stroke-width="17.678"></line><line x1="210" y1="-10" x2="90" y2="110" style="stroke:#cd0e66" stroke-width="17.678"></line></g></pattern><radialGradient id="sphere-gradient" cx="65%" cy="35%" r="65%"><stop offset="0" stop-color="white" stop-opacity="0.3"></stop><stop offset="0.32" stop-color="white" stop-opacity="0"></stop><stop offset="0.33" stop-opacity="0"></stop><stop offset="1" stop-opacity="0.2"></stop></radialGradient><linearGradient id="card-gradient"><stop offset="0" stop-color="#999"></stop><stop offset="0.08" stop-color="#bbb"></stop><stop offset="0.92" stop-color="#bbb"></stop><stop offset="1" stop-color="#999"></stop></linearGradient><filter id="handdrawn" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" basefrequency="0.004 0.004" numoctaves="26" stitchtiles="stitch" result="turbulence"></feTurbulence><feDisplacementMap in="SourceGraphic" in2="turbulence" scale="20" xchannelselector="R" ychannelselector="G" result="displacementMap"></feDisplacementMap></filter><filter id="pencil" x="-10%" y="-10%" width="110%" height="110%" filterUnits="objectBoundingBox"><feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="3" result="noise"></feTurbulence><feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="2" in="SourceGraphic" result="newSource"></feDisplacementMap></filter><symbol id="suit-c" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c2.3.1 4.2 1.9 4.3 4.2 0 1.6-.9 3-2.3 3.8.8-.3 1.6-.5 2.5-.5 2.4-.1 4.4 1.7 4.5 4.1v.2c0 2.3-1.9 4.2-4.2 4.2-.1 0-.2 0-.3 0-1.2-.1-2.4-.4-3.5-1 0 0-.3 2 2 5h-6c2.3-3 2-5 2-5-1.1.6-2.3.9-3.5 1-2.3.2-4.3-1.6-4.5-3.9 0-.1 0-.2 0-.3 0-2.4 1.9-4.3 4.3-4.3h.2c.9 0 1.7.2 2.5.5-1.4-.8-2.3-2.2-2.3-3.8.1-2.3 2-4.1 4.3-4.2z"></path></symbol><symbol id="suit-s" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c-3 5-8 7-8 12 .1 2.1 1.9 3.9 4 4 1.1.1 2.2-.2 3-1 0 0 .3 2-2 5h6c-2-3-2-5-2-5 .8.8 1.9 1.1 3 1 2.1-.1 3.9-1.9 4-4 0-5-5-7-8-12z"></path></symbol><symbol id="suit-h" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0 8.5-1.3-1.3c-4.6-4.1-7.7-6.9-7.7-10.3-.1-2.7 2.1-4.9 4.8-5h.2c1.5 0 3.1.7 4 1.9 1-1.2 2.5-1.9 4-1.9 2.8-.1 4.9 2.1 5 4.8v.2c0 3.4-3.1 6.2-7.7 10.3z"></path></symbol><symbol id="suit-d" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m7 0-7 10-7-10 7-10"></path></symbol><pattern id="card-bg" width="6" height="8" patternUnits="userSpaceOnUse"><rect width="6" height="8" fill="#0f82f2"></rect><line x2="6" y2="8" stroke="#eee" stroke-width="1"></line><line x1="6" y2="8" stroke="#eee" stroke-width="1"></line></pattern></defs><rect class="grid"></rect><path class="group-shadow"></path><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="strokes"></g><g class="geo-shadows"></g><g class="geo-paths"></g><g class="geo-points"></g><g class="tiles"></g><g class="tiles"></g><rect class="selection"></rect><g class="transform-tools" hidden><path class="group-outline"></path><line class="rotate-bar"></line><circle class="rotate-circle" r="10"></circle></g></svg><div class="html-overlay"></div><div class="rotate-label"></div><slot></slot>';var Ge="https://static.mathigon.org/polypad/audio",Um={roll:new Pe(`${Ge}/roll.mp3`,.6,!1),spin:new Pe(`${Ge}/spin.mp3`,.5,!1),coinToss:new Pe(`${Ge}/coin-toss.mp3`,.3,!1),shuffle:new Pe(`${Ge}/shuffle.mp3`,.3,!1),draw:new Pe(`${Ge}/card-draw.mp3`,.2,!1),click:new Pe(`${Ge}/click.mp3`,.3,!1),woosh:new Pe(`${Ge}/woosh.mp3`,.2,!1),rise:new Pe(`${Ge}/rise.mp3`,.3,!1),fall:new Pe(`${Ge}/fall.mp3`,.3,!1),splitCoins:new Pe(`${Ge}/split-coins.mp3`,.175,!1),mergeCoins:new Pe(`${Ge}/merge-coins.mp3`,.3,!1)};var is=25,Oc=is*Math.sqrt(3)/2,Iw=Math.sqrt(2*is**2)/2;function dn(e,s,t){let i,n,r;t:for(let o of t)for(let a of s){let l=o.posn||o.path.project(a),h=l.subtract(a),d=h.length;if(d<e&&(e=d,i=l,n=h,r=o,d<1))break t}return n?Rt(et({},r),{posn:i,shift:n}):void 0}function*Lc(e){for(let[s,t]of e){let i=ft(s.path,t.path);for(let[n,r]of i.entries())yield{posn:r,intersection:`intersections(${s.key},${t.key||t.path})[${n}]`}}}var $l=class{constructor(s){this.$parent=s;this.geoIntersections=new Set;this.strokeIntersections=new Set}*getGeoPoints(){for(let s of this.$parent.getTilesOfType("geo"))s.isActive||s.pending||s.hidden||s.path&&yt(s.path)&&(yield{posn:s.path,tile:s});for(let s of this.geoIntersections)yield s}*getVertices(){for(let s of this.$parent.tiles.values())if(!(s.isActive||s.pending||s.type==="geo"))for(let t of s.snapPoints)yield{posn:t,tile:s};for(let s of this.$parent.strokes.values())for(let t of s.snapPoints||[])yield{posn:t};for(let s of this.strokeIntersections)yield s}*getGridPoints(s){if(!this.$parent.options.grid||this.$parent.options.grid==="none")return;let t=this.$parent.options.grid.split("-")[0],i=x.aroundPoints(s),n=new kt(i.p.x-is,i.p.x+i.w+2*is,i.p.y-is,i.p.y+i.h+2*is);if(t.startsWith("square")){let r=(t==="square2"?2:1)*is,o=ht(n.xMin,r);for(let a=ht(n.yMin,r);a<n.yMax;a+=r)for(let l=o;l<n.xMax;l+=r)yield{posn:new p(l,a)}}else if(t.startsWith("tri")){let r=t==="tri2";r&&(n=n.flip);let o=ht(n.xMin,is);for(let a=Math.floor(n.yMin/Oc);a*Oc<n.yMax;++a)for(let l=o+(a%2?is/2:0);l<n.xMax;l+=is){let h=new p(l,a*Oc);yield{posn:r?h.flip:h}}}}*getSnapLines(){for(let s of this.$parent.tiles.values())if(!(s.isActive||s.pending))for(let t of s.snapLines)yield{path:t,tile:s};for(let s of this.$parent.strokes.values())s.snap&&(yield{path:s.path})}snap(s){if(!this.$parent.options.noSnapping)return dn(12,s,this.getGeoPoints())||dn(8,s,this.getVertices())||dn(Iw,s,this.getGridPoints(s))||dn(6,s,this.getSnapLines())}*getGeoEls(s=!0){for(let t of this.$parent.getTilesOfType("geo"))!t.canSelect||!t.transformed||(s&&yt(t.transformed)&&(yield{posn:t.transformed,tile:t}),!s&&!yt(t.transformed)&&(yield{path:t.transformed,tile:t}))}snapGeo(s){if(!this.$parent.options.noSnapping)return dn(12,[s],this.getGeoEls(!0))||dn(6,[s],this.getGeoEls(!1))}*geoTiles(){for(let s of this.$parent.getTilesOfType("geo"))s.path&&!s.hidden&&!yt(s.path)&&(yield s)}*strokes(){for(let s of this.$parent.strokes.values())s.snap&&(yield s)}updateIntersections(){this.geoIntersections.clear(),this.strokeIntersections.clear();let s=Array.from(this.geoTiles()),t=Array.from(this.strokes());for(let i of Lc(Dl(s)))this.geoIntersections.add(i);for(let i of Lc(wi(s,t)))this.geoIntersections.add(i);for(let[i,n]of Dl(t))for(let r of ft(i.path,n.path))this.strokeIntersections.add({posn:r})}addStroke(s){if(!!s.snap){for(let t of this.strokes())if(t!==s)for(let i of ft(t.path,s.path))this.strokeIntersections.add({posn:i});for(let t of Lc(wi(this.geoTiles(),[s])))this.geoIntersections.add(t)}}};var Rc=[{type:"checkbox",tileTypes:["axes","balance","grid","fraction-bar","decimal-grid","multi-jump","number-line","ten-frame","number-tile","image","spinner","custom-spinner","box-whisker","chart","pie-chart","table","rectangle","reg-polygon","custom-polygon"],label:"Show handles:",icon:"handles",advanced:!0,get:e=>!e.hideHandles,set:(e,s)=>s.setHandles(!e)},{type:"button",tileTypes:["all"],label:"Copy",icon:"copy",show:e=>!e[0].$parent.options.noCopyPaste,click:(e,s)=>s.paste(s.selection.copy(),new p(25,25))},{type:"button",tileTypes:["all"],label:"Delete",icon:"delete",show:e=>!e[0].$parent.options.noDeleting&&e.every(s=>!s.fixed),click:(e,s)=>s.selection.delete()},{type:"checkbox",tileTypes:["all"],label:"Keep on top:",icon:"layer-front",advanced:!0,get:e=>e.order==="front",set:(e,s)=>s.setOrder(e?"front":void 0)},{type:"checkbox",tileTypes:["all"],label:"Keep at back:",icon:"layer-back",advanced:!0,get:e=>e.order==="back",set:(e,s)=>s.setOrder(e?"back":void 0)},{type:"checkbox",tileTypes:["all"],label:"Lock position:",icon:"move-off",advanced:!0,get:e=>!!e.fixed,set:(e,s)=>s.fixed=e},{type:"checkbox",tileTypes:["all"],label:"Lock tile:",icon:"lock",advanced:!0,get:e=>!!e.locked,set:(e,s)=>s.lock(e)},{type:"checkbox",tileTypes:["all"],label:"Invisible:",icon:"eye-off",advanced:!0,get:e=>!!e.hidden,set:(e,s)=>s.hide(e)}];var Zm=e=>e.toLowerCase().replace(":","").replace(/\s/g,"-"),Nw=["polygons","polyominoes","tangram","penrose","pentagons","solids","measuring","patterns","number-tiles","number-bars","number-frames","number-cards","number-line","primes","number-dots","number-grid","number-tools","fraction-bars","fraction-circles","algebra-tiles","balance","axes","sliders","random","charts","playing-cards","polyhedral-dice","non-trans-dice","logic","chess","currency","clocks","dominoes"],Gw=["move","pen","geo","text","equation","eraser","image","color"],Dw=Ht([...Rc,...Fi].map(e=>Zm(e.label))).sort(),Pl=[["toolbar",Gw],["sidebar",Nw],["actionbar",Dw]],Ic=["mergeTiles","evalEquations","altColors","largeUI"],Nc=["noCopyPaste","noDeleting","noRotating","noUndoRedo","noPinchPan","noSnapping","noAudio"],_w=["fullscreen","grid"],Wm=[...Pl.map(e=>e[0]),...Ic,...Nc,"settings"],Km={advanced:{mergeTiles:!0,evalEquations:!0},common:{actionbar:Ht([...Rc,...Fi].filter(e=>!e.advanced).map(e=>Zm(e.label))).join(","),mergeTiles:!0,evalEquations:!0},simple:{sidebar:"polygons,polyominoes,tangram,solids,measuring,number-tiles,number-bars,number-frames,number-cards,number-line,fraction-bars,fraction-circles,algebra,balance,probability,playing-cards,polyhedral-dice,clocks,dominoes",toolbar:"move,pen,text,eraser,color",actionbar:"copy,delete,unfold,hinges,flip,cut,fold-net,turn-over,draw,shuffle,merge-tiles,split-tiles,start,step,width,divisions,rename,balance,randomize,seconds",settings:"grid",mergeTiles:!0,largeUI:!0,noPinchPan:!0}};function Xm(){let e={};for(let s of Wm)e[s]=Km.advanced[s];return e}function Hw(e,s,t,i){let n=c("label",{text:" "+t},e),r=c("input",{type:"checkbox"});n.prepend(r),r.bindVariable(i,s)}function Bw(e){return e.replace(/(^|-)(\w)/g,(s,t,i)=>` ${i.toUpperCase()}`)}var xl=class extends O{bindPolypad(t){this.options=t.options}ready(){this.$modal=this.parents("x-modal")[0],this.$modal.on("open",()=>this.load(this.options)),this.setup()}setup(){let t=mt({preset:r=>this.load(Km[r]||{}),cancel:()=>this.$modal.close(),save:()=>this.save()});this.bindModel(t);let i=this.$$(".ui-columns").slice(1),n=this.$$("button.switch");for(let[r,[o,a]]of Pl.entries()){for(let l of a)Hw(i[r],`${o}-${l}`,Bw(l),t);n[r].on("click",()=>{let l=a.some(h=>t[`${o}-${h}`]);for(let h of a)t[`${o}-${h}`]=!l}),this.model[o]=!0}}load(t){var n;for(let[r,o]of Pl){let a=t[r]||"";this.model[r]=a!=="hidden";let l=a.split(",");for(let h of o)this.model[`${r}-${h}`]=!a||l.includes(h)}let i=(n=t.settings)==null?void 0:n.split(",");for(let r of _w)this.model[r]=!i||i.includes(r);for(let r of Ic)this.model[r]=!!t[r];for(let r of Nc)this.model[r]=!t[r]}save(){for(let[t,i]of Pl)this.model[t]?i.every(n=>this.model[`${t}-${n}`])?this.options[t]=void 0:this.options[t]=i.filter(n=>this.model[`${t}-${n}`]).join(","):this.options[t]="hidden";this.options.settings=this.model.fullscreen&&this.model.grid?void 0:this.model.fullscreen?"fullscreen":this.model.grid?"grid":"other";for(let t of Ic)this.options[t]=!!this.model[t]||void 0;for(let t of Nc)this.options[t]=!this.model[t]||void 0;for(let t of Wm)b.setStorage(`polypad.options.${t}`,this.options[t]);this.$modal.close()}};xl=N([V("x-polypad-customise")],xl);var Gc=3,qw=new kt(-2e3,4e3,-2e3,4e3),Sl=e=>`${e.xMin} ${e.yMin} ${e.dx} ${e.dy}`,Dc=e=>!!e.name,Tl=class extends O{constructor(){super(...arguments);this.tiles=new Map;this.strokes=new Map;this.options=mt({});this.state=mt({tool:"move",changeCount:0,penColor:"#242436"});this.mathContext=new Ia;this.snapping=new $l(this);this.tools={move:new fl(this),pen:new wl(this),geo:new rr(this),geoPending:new yl(this),eraser:new ml(this),text:new gl(this),pan:new vl(this),cutPolygon:new bl(this)};this.initial={};this.margins=[20,20,20,20];this.origin=$;this.zoom=1;this.newTileShift=0;this.tileWeights=new Map;this.setup=!1;this.undoStack=[];this.redoStack=[]}ready(){this.$svg=this.$("svg.canvas"),this.$tiles=this.$svg.$$(".tiles"),this.$selection=this.$svg.$(".selection"),this.$strokes=this.$svg.$(".strokes"),this.$grid=this.$svg.$(".grid"),this.$html=this.$(".html-overlay"),this.$geoShadows=this.$svg.$(".geo-shadows"),this.$geoPaths=this.$svg.$(".geo-paths"),this.$geoPoints=this.$svg.$(".geo-points"),this.$pendingPoint=c("circle",{class:"geo-point pending",hidden:!0},this.$geoPoints),this.setAttr("data-tool","move"),this.events=new qi(this.$svg,{down:t=>this.tools[this.state.tool].down(t),up:t=>this.tools[this.state.tool].up(t),start:t=>this.tools[this.state.tool].start(t),move:t=>this.tools[this.state.tool].move(t),end:t=>this.tools[this.state.tool].end(t),click:t=>this.tools[this.state.tool].click(t),hover:t=>this.tools[this.state.tool].hover(t),cursor:!1}),this.selection=new ul(this),this.warningBanner=new bo(this),this.setViewport($,1),this.options.watch(t=>{this.$grid.setAttr("fill",t.grid&&t.grid!=="none"?`url(#${t.grid})`:"none"),this.$grid.setRect(this.canvasBounds.rect)}),this.$svg.on("contextmenu",t=>{this.focussedTile||t.preventDefault()}),this.enablePinchPan(),this.enableAccessibility(),b.onThemeChange(()=>{for(let t of this.tiles.values())t.colour&&t.setColour(t.colour,"theme");for(let t of this.strokes.values())t.setColor(t.color)}),this.state.watch(t=>this.setClass("high-contrast",!!t.highContrast)),this.state.watch(t=>this.setClass("handdrawn",!!t.handdrawn)),this.state.watch(t=>{this.setClass("setup-mode",!!t.setupMode);for(let i of this.selection.tiles)i.canSelect||this.selection.remove(i);this.selection.update()})}playSound(t){this.options.noAudio||Um[t].play()}getTileAt(t,i){for(let n of this.tiles.values())if(!(i&&!i.includes(n.type))&&n.contains(t))return n}getInputAt(t,i){for(let n of this.tiles.values()){let r=n.getClosestPort(t,i);if(r)return r}}*getTilesOfType(t){for(let i of this.tiles.values())i.is(t)&&(yield i)}enablePinchPan(){this.on("wheel",n=>{if(!this.options.noPinchPan)if(n.preventDefault(),n.ctrlKey){let r=this.zoom*(1-n.deltaY/100);this.setViewport(this.origin,r,Se(n,this.$svg))}else{let r=this.origin.shift(n.deltaX/this.zoom,n.deltaY/this.zoom);this.setViewport(r,this.zoom)}});let t=0,i=this.origin;this.on("gesturestart",n=>{this.options.noPinchPan||(n.preventDefault(),i=new p(n.pageX,n.pageY).subtract(this.origin),t=this.zoom,this.events.cancel())}),this.on("gesturechange",n=>{if(this.options.noPinchPan)return;n.preventDefault();let r=t*n.scale,o=new p(n.pageX,n.pageY).subtract(i);this.setViewport(o,r,Se(n,this.$svg))}),this.on("gestureend",n=>{this.options.noPinchPan||n.preventDefault()})}enableImageDrop(t,i){let n=c("div",{class:"image-drop"},this);this.imageUploadCallback=t,this.on("dragenter dragover dragleave drop",o=>o.preventDefault()),this.on("dragenter dragover",()=>n.show()),this.on("dragleave drop",()=>n.hide());let r=(o,a)=>R(this,null,function*(){let h=Array.from((o==null?void 0:o.files)||[]).slice(0,10).map((u,f)=>this.newImage(u,a.shift(f*25),t)),d=yield Promise.all(h);this.change({added:d}),this.trigger("paste")});this.on("drop",o=>r(o.dataTransfer,Se(o,this.$svg))),i==null||i.on("change",()=>R(this,null,function*(){yield r(i._el,this.canvasBounds.center),i.value=""}))}enableHotkeys(){b.onKey("backspace delete",()=>this.selection.delete()),b.onKey("z",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),t.shiftKey?this.redo():this.undo())}),b.onKey("y",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.redo())}),b.onKey("c",t=>{if(t.ctrlKey||t.metaKey||this.options.noCopyPaste)return;let i=this.selection.copy();this.paste(i,new p(25,25))}),b.onKey("a",t=>{var i;!(t.ctrlKey||t.metaKey)||(i=G("x-modal"))!=null&&i.getOpenModal()||(t.preventDefault(),this.selection.select(Array.from(this.tiles.values())))}),Z.on("cut copy",t=>{var n,r;if(!this.selection.tiles.size||this.options.noCopyPaste||(n=b.getActiveInput())!=null&&n.is("input, textarea, [contenteditable]"))return;let i=this.selection.copy();(r=window.navigator.clipboard)==null||r.writeText(JSON.stringify(i)),t.type==="cut"&&this.selection.delete()}),Z.on("paste",t=>R(this,null,function*(){var r,o;if(this.options.noCopyPaste||(r=b.getActiveInput())!=null&&r.is("input, textarea, [contenteditable]"))return;let i=bu(t.clipboardData);if(i&&this.imageUploadCallback){let a=yield this.newImage(i,this.center.shift(-50),this.imageUploadCallback);return this.trigger("paste"),this.change({added:[a]})}let n=yield(o=window.navigator.clipboard)==null?void 0:o.readText();if(!!n)try{let a=JSON.parse(n);if(!a.length)return;this.paste(a)}catch(a){let l=this.newTile("text",n);l.setTransform(this.canvasBounds.center.subtract(l.center)),this.selection.add(l,!0),this.change({added:[l]}),this.trigger("paste"),this.selection.select([l])}}))}enableAccessibility(){let t,i=r=>{this.focussedTile||(t=r,this.$svg.setAttr("aria-description",r?r.ariaDescription:"Empty Canvas"),r&&this.selection.add(r,!0))},n=!1;this.$svg.on("focusin",()=>{if(!n)return;let r=Array.from(this.tiles.values());i(this.events.shiftKey?_(r):r[0])}),this.$svg.on("focusout",()=>t=void 0),Z.on("keydown",r=>{if(n=!0,r.keyCode!==9||!t)return;let o=Array.from(this.tiles.values());i(o[o.indexOf(t)+(r.shiftKey?-1:1)]),t&&r.preventDefault()}),Z.on("pointerdown",()=>n=!1)}newImage(t,i,n){return R(this,null,function*(){let r=new FileReader;r.readAsDataURL(t),yield new Promise(a=>r.onloadend=a);let o=this.newTile("image",(r.result||"").toString());return o.setTransform(i),this.selection.add(o,!0),yield n==null?void 0:n(t,o),o})}newTile(t,i,n){return new(Vc(t))(i,this,n)}setViewport(t,i=1,n){if(i=S(i,1/Gc,Gc),n){let l=this.zoom/i;t=n.subtract(n.subtract(this.origin).scale(l))}let r=this.width/i,o=this.height/i;this.zoom=i,this.origin=t.clamp(qw.resize(-r,-o)),this.canvasBounds=new kt(this.origin.x,this.origin.x+r,this.origin.y,this.origin.y+o),this.$svg.setAttr("viewBox",this.attr("viewBox")||Sl(this.canvasBounds)),this.$html.setTransform(this.origin.inverse.scale(this.zoom),0,this.zoom);let a=this.canvasBounds.rect;this.options.grid!=="none"&&this.$grid.setRect(a),te.redrawLines(a),this.newTileShift=0,this.trigger("viewport")}resetViewport(){if(!this.tiles.size&&!this.strokes.size)return this.setViewport($,1);let t=$o(this.tiles,this.strokes,0),[i,n,r,o]=this.margins,a=(this.width-o-n)/t.dx,l=(this.height-i-r)/t.dy,h=S(Math.min(a,l),1/Gc,1),d=new p(this.width+o-n,this.height+i-r),u=t.center.subtract(d.scale(1/2/h));this.setViewport(u,h)}setZoom(t){let i=this.canvasBounds.center;this.setViewport(this.origin,this.zoom*t,i)}bindSource(t,i,n,r){Vc(i).makeThumbnail(n,t,this);let o,a=r==null?void 0:r.$(".tiles"),l=+t.attr("data-rot")||0,h=()=>{o=this.newTile(i,t.data.options||n),t.data.colour&&o.setColour(t.data.colour),t.data.labels&&o.setLabels(t.data.labels)};this.events.listen(t,{down:()=>this.trigger("add-tile-start"),start:({posn:d})=>{h(),o.setTransform(d.subtract(o.center),l),this.selection.add(o,!0),this.selection.moveStart(!0),r&&r.setAttr("viewBox",Sl(this.canvasBounds)),(a||o.$container).append(o.$el),this.trigger("add-tile",{tile:o})},move:d=>this.selection.move(d),end:()=>{o.$container.append(o.$el),this.selection.moveEnd(!0)},click:()=>{h(),o.setTransform(this.center.subtract(o.center).shift(this.newTileShift*25),l),this.selection.add(o,!0),o.moveEnd(),this.trigger("add-tile",{tile:o}),this.change({added:[o]}),this.newTileShift+=1}})}get center(){let[t,i,n,r]=this.margins;return this.canvasBounds.center.shift((r-i)/this.zoom/2,(t-n)/this.zoom/2)}setActiveTool(t,i){this.tools[this.state.tool].cancel(),this.warningBanner.hide(),this.selection.clear(),this.state.assign({tool:t,toolOptions:i}),i&&(this.tools[this.state.tool].options=i),this.setAttr("data-tool",t)}clear(t=!0){this.selection.clear();let i=[...Array.from(this.tiles.values()),...Array.from(this.strokes.values())];for(let n of i)n.delete();t&&this.setViewport($,1),i.length&&this.change({deleted:i})}thumbnail(t,i,n="jpg"){return R(this,null,function*(){let r=this.canEditQuestions?Array.from(this.getTilesOfType("question-blank")):[];for(let l of r)l.hideForThumbnail();let o=$o(this.tiles,this.strokes,50),a=yield this.$svg.image(n,t,i,Sl(o));for(let l of r)l.hideForThumbnail(!0);return a})}paste(t,i){let n=new Map,r=new Map,o=t.map(l=>{l.name==="geo"&&(l.options=te.copy(r,l.options));let h=T.unSerialize(l,this,!0);return h!=null&&h.fixed&&(h.fixed=!1),h&&n.set(l.id,h.id),h}).filter(l=>l);for(let l of t)for(let h of l.cables||[])Zt.unSerialize(n.get(l.id),{fromPort:h.fromPort,toPort:h.toPort,toTileId:n.get(h.toTileId)},this);let a=we(...o.map(l=>l.transformed)).center;i===void 0&&(i=this.center.subtract(a).shift(this.newTileShift*25));for(let l of o)l.is("geo")?l.shift(i):l.setTransform(l.posn.add(i));this.newTileShift+=1,this.change({added:o}),this.trigger("paste"),this.selection.select(o)}downloadImage(t="png",i){var o;this.selection.clear();let n=i||((o=this.state.title)==null?void 0:o.replace(/\s+/g,"-").replace(/[^\w-]/g,"").toLowerCase())||"polypad",r=$o(this.tiles,this.strokes,50);this.$svg.downloadImage(`${n}.${t}`,r.dx,r.dy,Sl(r))}check(t){let i=!1;return new Promise(n=>{this.on("change",()=>{!i&&t(Array.from(this.tiles.values()))&&(i=!0,n())})})}change(t){var i,n,r;this.setup||this.options.noUndoRedo||(this.trigger("change",{action:"change",data:t}),this.undoStack.push({added:(i=t.added)==null?void 0:i.map(o=>o.serialize()),changed:(n=t.changed)==null?void 0:n.map(o=>[o.lastSavedData,o.serialize()]),deleted:(r=t.deleted)==null?void 0:r.map(o=>o.lastSavedData)}),this.undoStack.length>50&&this.undoStack.shift(),this.redoStack=[],this.state.canUndo=!0,this.state.canRedo=!1,this.state.changeCount+=1)}undo(){!this.undoStack.length||(this.applyChange(_(this.undoStack),!0),this.redoStack.push(this.undoStack.pop()),this.state.canUndo=!!this.undoStack.length,this.state.canRedo=!0,this.state.changeCount-=1,this.selection.update(),this.trigger("change",{action:"undo"}))}redo(){!this.redoStack.length||(this.applyChange(_(this.redoStack)),this.undoStack.push(this.redoStack.pop()),this.state.canUndo=!0,this.state.canRedo=!!this.redoStack.length,this.state.changeCount+=1,this.selection.update(),this.trigger("change",{action:"redo"}))}applyChange(t,i=!1){var n,r;for(let o of(i?t.deleted:t.added)||[])(Dc(o)?T:Re).unSerialize(o,this);for(let o of(i?t.added:t.deleted)||[])(n=(Dc(o)?this.tiles:this.strokes).get(o.id))==null||n.delete();for(let[o,a]of t.changed||[])(r=this.tiles.get(o.id))==null||r.applyChange(i?o:a);for(let o of(i?t.deleted:t.added)||[])if(Dc(o)&&o.cables)for(let a of o.cables)Zt.unSerialize(o.id,a,this)}serialize(t=2e3,i=1e3,n=16e3){var r;return{title:(r=this.state.title)==null?void 0:r.slice(0,30),tiles:Array.from(this.tiles.values()).slice(0,t).map(o=>o.serialize()),strokes:Array.from(this.strokes.values()).slice(0,i).map(o=>o.serialize(n)),options:this.options.copy()}}load(t){var r;this.setup=!0,this.clear(!1),te.clearModel(),this.initial=t,this.state.assign({title:t.title,canUndo:!1,canRedo:!1,changeCount:0}),this.undoStack=this.redoStack=[];let i=this.attr("user-type")==="teacher";this.canEditQuestions=i,t.options||(t.options=Xm()),t.options.grid||(t.options.grid="none"),t.options.algebraXSize||(t.options.algebraXSize=jf),t.options.algebraYSize||(t.options.algebraYSize=Uf),this.options.assign(t.options,!0),this.options.forceUpdate(),am(this,((r=t.options)==null?void 0:r.tileWeights)||"");for(let o of t.tiles||[])T.unSerialize(o,this);for(let o of t.strokes||[])Re.unSerialize(o,this);for(let o of t.tiles||[])for(let a of o.cables||[])Zt.unSerialize(o.id,a,this);for(let o of this.tiles.values())o.move();this.snapping.updateIntersections(),this.resetViewport(),this.setActiveTool("move"),this.setup=!1}};Tl=N([V("x-polypad",{template:jm})],Tl);var Ym=`<div class="factris-panel-left"><div class="keys-play"><button @click="app.reset()" title="Restart Game"><x-icon name="restart" size="36"></x-icon></button><button @click="app.toggle()" :title="playing ? 'Pause' : 'Play'"><span :show="playing"><x-icon name="pause" size="36"></x-icon></span><span :show="!playing"><x-icon name="play" size="36"></x-icon></span></button><button class="highscore-btn" @click="app.showHighscore()" title="Highscore"><x-icon name="trophy" size="36"></x-icon></button></div><div class="panel-item"><div class="text-large" :class="points &gt; 999999 ? 'narrow' : ''">\${numberFormat(points)}</div><div class="text-small">Points</div></div><div class="panel-item"><div class="text-large margin"><span :show="min(time)" data-display="inline">\${min(time)}m</span> \${time % 60}s</div><div class="text-small">Time</div></div><hr :show="highscore.length"><div class="highscore-panel" :show="highscore.length"><div class="highscore-title">Highscore</div><table><tr><td>\${highscore[0].name.slice(0, 4)}</td><td>\${numberFormat(highscore[0].score)}</td></tr><tr><td>\${highscore[1].name.slice(0, 4)}</td><td>\${numberFormat(highscore[1].score)}</td></tr><tr><td>\${highscore[2].name.slice(0, 4)}</td><td>\${numberFormat(highscore[2].score)}</td></tr><tr><td>\${highscore[3].name.slice(0, 4)}</td><td>\${numberFormat(highscore[3].score)}</td></tr><tr><td colspan="2"><a @click="app.showHighscore()">View more\u2026</a></td></tr></table></div><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V5A12,12,0,0,1,12,17h1V0Z"></path><path d="M0,0V1A12,12,0,0,1,12,13v4h1V0Z"></path></svg></div></div><div class="factris-panel-right"><div class="panel-item"><div class="text-small">Next blocks:</div><div class="text-large">\${next[0]}</div><div class="text-large">\${next[1]}</div><div class="text-large">\${next[2]}</div><div class="text-large">\${next[3]}</div><div class="text-large">\${next[4]}</div></div><hr><div class="text-small discharge-label">Discharge:</div><button class="discharge" :show="!discardCounter" data-display="inline-block" @click="app.discharge()" title="Discard Tile"><x-icon name="delete" size="36"></x-icon></button><svg class="discharge-count" :show="discardCounter" data-display="inline-block" width="74" height="74" viewBox="0 0 74 74"><circle cx="37" cy="37" r="32" style="strokeDashoffset:\${201*discardCounter/5}px"></circle><text class="large" x="37" y="38">\${discardCounter}</text><text class="small" x="37" y="51">needed</text></svg><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V17H1A12,12,0,0,1,13,5V0Z"></path><path d="M0,0V17H1V13A12,12,0,0,1,13,1V0Z"></path></svg></div></div><div class="factris-body"><svg class="factris-board" :show="(playing || lost) &amp;&amp; !showHighscore &amp;&amp; !initial" data-display="visibility"><defs><linearGradient id="shadow" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color: white; stop-opacity: 0.2"></stop><stop offset="100%" style="stop-color: white; stop-opacity: 0.05"></stop></linearGradient></defs><rect class="shadow" fill="url(#shadow)"></rect><g class="tiles"></g><g class="grid"><g class="faint-grid"></g></g><g class="scores"></g></svg><div class="logo" :class="initial &amp;&amp; !showHighscore ? 'show' : ''"><svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg"><g fill="#ffffff"><path d="m1.5039 59.1143v-57.9034h24.7227v7.8077h-16.4278v17.5659h14.313v7.8071h-14.313v24.7227z"/><path d="m23.7871 59.1143 12.9307-57.9034h6.9122l12.931 57.9034h-8.2954l-2.4394-12.4429h-11.3042l-2.44 12.4429zm20.4937-20.25-4.066-20.9815h-.1626l-4.0664 20.9815z"/><path d="m86.9766 42.6055v3.5781a12.9 12.9 0 0 1 -1.0166 5.083 14.0881 14.0881 0 0 1 -2.8057 4.27 13.5323 13.5323 0 0 1 -4.1885 2.9683 12.2636 12.2636 0 0 1 -5.164 1.0977 18.5964 18.5964 0 0 1 -4.7984-.65 11.3307 11.3307 0 0 1 -4.3911-2.2774 12.5723 12.5723 0 0 1 -3.2123-4.1889 14.814 14.814 0 0 1 -1.2608-6.5463v-31.8795a14.0993 14.0993 0 0 1 .976-5.2861 12.4357 12.4357 0 0 1 2.7648-4.229 12.863 12.863 0 0 1 4.27-2.8054 14.35 14.35 0 0 1 5.4892-1.0169 12.5807 12.5807 0 0 1 9.5151 3.8223 13.6266 13.6266 0 0 1 2.8057 4.4321 14.9842 14.9842 0 0 1 1.0166 5.5708v3.253h-8.2954v-2.7652a6.7153 6.7153 0 0 0 -1.3824-4.2285 4.4819 4.4819 0 0 0 -3.7412-1.789q-3.0915 0-4.1064 1.9111a10.23 10.23 0 0 0 -1.0166 4.8384v29.6025a7.6635 7.6635 0 0 0 1.0976 4.2285q1.098 1.7081 3.9444 1.708a6.0109 6.0109 0 0 0 1.7485-.2846 5.2115 5.2115 0 0 0 1.7485-.9351 4.953 4.953 0 0 0 1.22-1.79 7.2474 7.2474 0 0 0 .4878-2.8462v-2.8457z"/><path d="m99.1748 59.1143v-50.0957h-9.5967v-7.8077h27.4878v7.8077h-9.5959v50.0957z"/><path d="m120.7246 59.1143v-57.9034h13.3369q14.6385 0 14.6385 16.9971a21.4218 21.4218 0 0 1 -1.5859 8.7017 12.2983 12.2983 0 0 1 -5.5708 5.7739l8.9458 26.4307h-8.7832l-7.7256-24.7227h-4.9603v24.7227zm8.2954-50.0957v18.0537h4.7168a8.348 8.348 0 0 0 3.4971-.61 4.7555 4.7555 0 0 0 2.0332-1.7485 7.9534 7.9534 0 0 0 .8945-2.8057 26.9748 26.9748 0 0 0 .2437-3.8628 26.99 26.99 0 0 0 -.2437-3.8628 7.7387 7.7387 0 0 0 -.976-2.8872q-1.5467-2.2753-5.8556-2.2767z"/><path d="m155.6123 59.1143v-57.9034h8.2954v57.9034z"/><path d="m198.7954 17.8828h-8.2949v-1.8706a8.8535 8.8535 0 0 0 -1.3423-4.92 4.962 4.962 0 0 0 -4.5132-2.0737 5.2227 5.2227 0 0 0 -2.7651.65 5.4612 5.4612 0 0 0 -1.708 1.6265 6.8624 6.8624 0 0 0 -.8946 2.3989 15.6706 15.6706 0 0 0 -.2436 2.8057 27.5758 27.5758 0 0 0 .1216 2.8467 5.3954 5.3954 0 0 0 .61 2.0332 4.5014 4.5014 0 0 0 1.4229 1.5449 12.9606 12.9606 0 0 0 2.562 1.3013l6.3433 2.521a15.7628 15.7628 0 0 1 4.4726 2.48 10.7272 10.7272 0 0 1 2.6839 3.2943 15.4228 15.4228 0 0 1 1.22 4.4321 44.0689 44.0689 0 0 1 .3252 5.6524 29.8066 29.8066 0 0 1 -.7319 6.7905 14.3039 14.3039 0 0 1 -2.3584 5.3267 11.699 11.699 0 0 1 -4.4727 3.5781 15.7942 15.7942 0 0 1 -6.75 1.3013 14.7745 14.7745 0 0 1 -5.6113-1.0572 13.31 13.31 0 0 1 -4.4732-2.9277 14.2235 14.2235 0 0 1 -2.9682-4.3506 13.2116 13.2116 0 0 1 -1.0982-5.4082v-3.09h8.2955v2.6025a6.7761 6.7761 0 0 0 1.3418 4.1069q1.3418 1.83 4.5136 1.83a7.2794 7.2794 0 0 0 3.2935-.61 4.3859 4.3859 0 0 0 1.83-1.7486 6.4244 6.4244 0 0 0 .7729-2.7246q.1216-1.5856.1221-3.5376a35.0565 35.0565 0 0 0 -.1631-3.7407 6.4528 6.4528 0 0 0 -.65-2.3584 4.59 4.59 0 0 0 -1.5044-1.4639 19.57 19.57 0 0 0 -2.4805-1.22l-5.9365-2.44q-5.3679-2.1958-7.1972-5.8145a19.9948 19.9948 0 0 1 -1.83-9.0679 21.0112 21.0112 0 0 1 .8945-6.1806 14.0506 14.0506 0 0 1 2.6841-5.042 12.3042 12.3042 0 0 1 4.3506-3.375 14.5257 14.5257 0 0 1 6.3018-1.2609 13.7661 13.7661 0 0 1 5.6519 1.1387 14.5927 14.5927 0 0 1 4.4326 3.0088 12.5712 12.5712 0 0 1 3.7407 8.9458z"/></g></svg></div><x-icon class="play" :class="initial &amp;&amp; !showHighscore ? 'show' : ''" @click="app.play()" name="play" size="80"></x-icon><div class="overlay lost" :class="lost &amp;&amp; !showHighscore ? 'show' : ''">Game over!</div><div class="overlay paused" :class="playing || lost || initial || showHighscore ? '' : 'show'">Paused</div><div class="highscore" :show="showHighscore"><div class="text-large"><x-icon name="trophy" size="36"></x-icon> Highscore</div><table><tr><td>\${highscore[0].name}</td><td>\${numberFormat(highscore[0].score)}</td></tr><tr><td>\${highscore[1].name}</td><td>\${numberFormat(highscore[1].score)}</td></tr><tr><td>\${highscore[2].name}</td><td>\${numberFormat(highscore[2].score)}</td></tr><tr><td>\${highscore[3].name}</td><td>\${numberFormat(highscore[3].score)}</td></tr><tr><td>\${highscore[4].name}</td><td>\${numberFormat(highscore[4].score)}</td></tr><tr><td>\${highscore[5].name}</td><td>\${numberFormat(highscore[5].score)}</td></tr><tr><td>\${highscore[6].name}</td><td>\${numberFormat(highscore[6].score)}</td></tr><tr><td>\${highscore[7].name}</td><td>\${numberFormat(highscore[7].score)}</td></tr><tr><td>\${highscore[8].name}</td><td>\${numberFormat(highscore[8].score)}</td></tr><tr><td>\${highscore[9].name}</td><td>\${numberFormat(highscore[9].score)}</td></tr><tr><td>\${highscore[10].name}</td><td>\${numberFormat(highscore[10].score)}</td></tr></table></div></div><div class="factris-keys"><button class="key-left" :class="key === 'left' ? 'active' : ''" title="Left" @pointerdown="app.keyPress('left')"><x-icon name="left" size="36"></x-icon></button><div class="keys-center"><button class="key-up" :class="key === 'up' ? 'active' : ''" title="Resize" @pointerdown="app.keyPress('up')"><svg class="icon" width="54" height="36" viewBox="0 0 54 36" xmlns="http://www.w3.org/2000/svg"><path d="m41.1973 11 1.5975-1.635a.75.75 0 0 1 1.2751.5325v.495a6 6 0 0 1 5.2501 5.8575.75.75 0 0 1 -1.5 0 4.5 4.5 0 0 0 -3.75-4.3426v1.1475a.75.75 0 0 1 -1.2751.5326l-1.5975-1.56a.7676.7676 0 0 1 -.0001-1.0275z"/><path d="m12.8027 11-1.5975-1.635a.75.75 0 0 0 -1.2752.5324v.495a6 6 0 0 0 -5.25 5.8576.75.75 0 0 0 1.5 0 4.5 4.5 0 0 1 3.75-4.3426v1.1475a.75.75 0 0 0 1.2751.5326l1.5975-1.56a.7676.7676 0 0 0 .0001-1.0275z"/><rect height="11" rx="2" width="11" x="15" y="6"/><rect height="11" rx="2" width="11" x="28" y="6"/><rect height="11" rx="2" width="11" x="15" y="19"/><rect height="11" rx="2" width="11" x="28" y="19"/><path d="m50 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/><path d="m11 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/></svg>
</button><button class="key-down" :class="key === 'down' ? 'active' : ''" title="Down" @pointerdown="app.keyPress('down')"><x-icon name="down" size="36"></x-icon></button></div><button class="key-right" :class="key === 'right' ? 'active' : ''" title="Right" @pointerdown="app.keyPress('right')"><x-icon name="right" size="36"></x-icon></button></div><div class="factris-panel-top" :class="showHighscore ? 'hide' : ''"><div class="text-small">Block size:</div><div class="text-large">\${active[0] || '?' } = \${active[2]|| '?'} \xD7 \${active[1]|| '?'}</div><div class="corner left"><svg width="13" height="13"><path d="M12,0A12,12,0,0,1,0,12v1H13V0Z"></path></svg></div><div class="corner right"><svg width="13" height="13"><path d="M1,0A12,12,0,0,0,13,12v1H0V0Z"></path></svg></div></div>`;var zw=1e3,ut=S(+nh(location.search).size||16,8,24),Fw=5,pn=Math.ceil(ut/2),Ml=ut+pn,El=[];for(let e=2;e<=ut*1.5;e+=1){let s=gn(e);s&&e>.75*ut||e>ut&&rd(e)[0]>ut/2||(s&&e>ut/2||e>1.25*ut?El.push(e):El.push(e,e))}var or=()=>El[J.integer(El.length)],jw=He(1,ut),Uw=ut*10,Qm=B(e=>Uw*2**e,ut),_c=class{constructor(s,t,i){this.$el=c("rect",{width:20,height:20},i),this.setPosition(s,t)}setPosition(s,t){this.x=s,this.y=t,this.$el.setTransform({x:10+20*this.x,y:10+20*this.y})}go(s,t,i){this.setPosition(this.x+i-t,this.y+s)}canSet(s,t,i){return!i.find(n=>n.x===s&&n.y===t)}canGo(s,t,i,n){let r=this.x+i-t,o=this.y+s;return o>=Ml||r<0||r>=ut?!1:this.canSet(r,o,n)}canGoDown(s){return this.canGo(1,0,0,s)}goDown(s=1){if(s!==0)return this.go(s,0,0)}},Cl=class extends O{constructor(){super(...arguments);this.interval=void 0;this.tiles=[];this.activeTiles=[];this.activeSize=[0,0,0];this.activeFactors=[];this.isDown=!1;this.keyLock=!1;this.requestQueue=Promise.resolve("");this.highscore=!0}ready(){this.$svg=this.$(".factris-board"),this.$tiles=this.$svg.$(".tiles"),this.$shadow=this.$svg.$(".shadow"),this.attr("highscore")==="no"&&(this.highscore=!1);let t=this.$svg.$(".scores");this.$scores=Qm.map((i,n)=>{let r=c("g",{},t);return c("text",{text:"+"+i,class:`s${n+1}`},r),r}),this.bindModel(mt({time:0,points:0,playing:!1,lost:!1,initial:!0,key:void 0,discardCounter:0,next:[],active:[],highscore:[],showHighscore:!1,min:i=>Math.floor(i/60),numberFormat:nt,app:this}));for(let i of this.$$("button, .play"))i.on("contextmenu",n=>n.preventDefault());b.onKey("left up right down",(i,n)=>{!this.model.playing||(i.preventDefault(),this.isDown=!0,this.model.key=n,this.keyPress(n))}),b.onKey("left up right down",()=>{!this.model.playing||(this.isDown=this.keyLock=!1,this.model.key=void 0)},!0),this.setupSVG(),this.updateHighscore()}setupSVG(){this.$svg.setAttr("viewBox",`0 0 ${(ut+1)*20} ${(Ml+1)*20}`);let t=this.$svg.$(".grid"),i=t.$(".faint-grid");for(let n=0;n<=ut;n+=1){let r=10+n*20,o=10+(pn+n)*20,a=!(n%4)||n===ut?t:i,l=!(n%2)||n===ut?"thick":"";c("line",{x1:10,y1:o,x2:10+ut*20,y2:o,class:l},a),c("line",{x1:r,y1:10+pn*20,x2:r,y2:Ml*20+10,class:l},a)}}drawShadow(){!this.activeTiles.length||(this.$shadow.setAttr("x",10+20*this.activeSize[0]),this.$shadow.setAttr("y",10+20*this.activeSize[1]),this.$shadow.setAttr("width",20*this.activeSize[2]),this.$shadow.setAttr("height",20*(Ml-this.activeSize[1])))}newRect(){let t=this.getNewTileSize();this.activeFactors=jw.filter(r=>t%r===0);let i=this.activeFactors.pop(),n=Math.floor((ut-i)/2);this.activeTiles=B(r=>new _c(n+r%i,Math.floor(r/i),this.$tiles),t),this.model.active=[t,i,t/i],this.activeSize=[n,t/i,i],this.drawShadow(),this.isDown&&(this.keyLock=!0)}reset(){this.pause(),this.model.time=0,this.model.points=0,this.model.discardCounter=0,this.model.showHighscore=!1,this.model.lost=!1,this.model.next=[or(),or(),or(),or()];for(let t of this.tiles)t.$el.remove();for(let t of this.activeTiles)t.$el.remove();this.tiles=[],this.newRect(),this.play(),this.requestQueue=Promise.resolve("")}toggle(){this.model.lost?this.reset():this.model.playing?this.pause():this.play()}pause(){this.model.playing=!1,clearInterval(this.interval)}play(){var t,i;if(this.model.showHighscore=!1,(t=window.ga)==null||t.call(window,"send","event","Factris","play"),(i=window.gtag)==null||i.call(window,"event","factris",{action:"play"}),this.model.initial||this.model.lost)return this.model.initial=!1,this.reset();this.model.playing=!0,this.interval=window.setInterval(()=>this.tick(),zw)}getNewTileSize(){let t=ut*ut-this.tiles.length;if(this.model.next[0]>t)return t>ut?t-ut:ut;this.model.discardCounter>0&&(this.model.discardCounter-=1);let i=this.model.next[0];return this.model.next=[...this.model.next.slice(1),or()],i}tick(){if(this.model.time+=1,this.activeTiles.every(o=>o.canGoDown(this.tiles))){for(let o of this.activeTiles)o.goDown();this.activeSize[1]+=1,this.drawShadow();return}this.tiles.push(...this.activeTiles);for(let o of this.activeTiles)o.$el.addClass("fixed");if(this.tiles.some(o=>o.y<pn))return this.gameOver();this.activeTiles=[];let i=this.getFullRows();if(!i.length)return this.newRect();this.model.points+=q(Qm.slice(0,i.length)),i.length>=6&&Zs(10,150*i.length/ut),this.removeRows(i);let n=this.model.points,r=(n+ut)%13+(n-ut)%87;this.requestQueue=this.requestQueue.then(o=>ls("/factris-verify",{token:o,size:ut,score:n,check:r})),this.trigger("score",{points:n})}getFullRows(){return B(t=>this.tiles.filter(i=>i.y===t+pn),ut).filter(t=>t.length===ut)}removeRows(t){let i=Bt(t);this.tiles=this.tiles.filter(o=>!i.includes(o)),this.$tiles.addClass("animated"),b.redraw();for(let o of i)o.$el.addClass("removing");let n=t.map(o=>o[0].y);for(let o of this.tiles)o.goDown(n.filter(a=>a>o.y).length);let r=400/t.length;for(let[o,a]of n.reverse().entries())this.$scores[o].setTransform({x:10+pn*20,y:27+a*20}),Ae(()=>this.$scores[o].addClass("visible"),o*r);return setTimeout(()=>{for(let o of this.$scores)o.removeClass("visible")},600),setTimeout(()=>{for(let o of i)o.$el.remove();this.$tiles.removeClass("animated"),this.newRect()},1e3),!1}gameOver(){this.model.lost=!0;for(let t of this.activeTiles)t.$el.addClass("error");this.pause(),this.requestQueue.then(t=>{t&&this.trigger("game-over",{token:t,points:this.model.points})})}discharge(){if(!!this.model.playing){for(let t of this.activeTiles)t.$el.remove();this.newRect(),this.model.discardCounter=Fw}}keyPress(t,i=!0){if(!!this.model.playing&&!this.keyLock){if(t==="up"){if(!this.activeFactors.length)return;let n=this.activeFactors.pop(),r=this.activeSize[0]+Math.floor((this.activeSize[2]-n)/2),o=this.activeSize[1];if(this.activeTiles.some((h,d)=>!h.canSet(r+d%n,o-1-Math.floor(d/n),this.tiles)))return;for(let[h,d]of this.activeTiles.entries())d.setPosition(r+h%n,o-1-Math.floor(h/n));let l=this.model.active[0];this.model.active=[l,n,l/n],this.activeSize=[r,o,n]}else{let n=t==="down"?1:0,r=t==="left"?1:0,o=t==="right"?1:0;if(this.activeTiles.every(a=>a.canGo(n,r,o,this.tiles))){for(let a of this.activeTiles)a.go(n,r,o);this.activeSize[0]+=o-r,this.activeSize[1]+=n}i&&t==="down"&&setTimeout(()=>this.keyPress("down",!1),100)}this.drawShadow()}}showHighscore(){!this.highscore||(this.pause(),this.model.showHighscore=!0)}updateHighscore(){return R(this,null,function*(){if(!this.highscore)return;let t=yield fetch(`/factris-highscore?size=${ut}`);this.model.highscore=yield t.json()})}};Cl=N([V("x-factris",{template:Ym})],Cl);var Al=class extends O{ready(){let s=Array.from(this._el.children);this.removeChildren();let t=c("svg",{class:"equation"},this),i=c("g",{transform:"translate(2 0)"},t),n=c("div",{class:"overlay"},this),r=parseFloat(this.css("font-size")),o=this.parents(".text-center").length||this.hasClass("display"),a=new Te(i,n,0,"",r,!!o);a.setValue(this.attr("expr")||s),this.css({width:a.root.width+4+"px",height:a.root.height+"px","vertical-align":`-${a.root.height-a.root.baseline}px`})}};Al=N([V("x-math")],Al);window.$=G;window.$$=Fe;window.Browser=b;var Vl=G("x-modal#privacy");Vl&&Vl.$("form").on("submit",e=>{e.preventDefault();let s=Vl.$('input[name="newsletter"]');ls("/settings/privacy",{policies:"on",newsletter:s.checked?"on":"off"}),Vl.close()});var Jm="";function Bc(){return fetch("/joke").then(e=>e.text()).then(e=>Jm=e),Jm}var Hc=G(".error-box");Hc&&Hc.on("click",()=>Hc.html=Bc());Bc();window.tellMeAJoke=function(){return Bc().replace(/<p>/g,"").replace(/<\/p>/g,`
`).trim()};console.log(`%cWelcome to Mathigon!
%cYou can see our source code at https://github.com/mathigon
%cIf you want to contribute, visit https://mathigon.io
%cJust here for fun? Run tellMeAJoke()`,"color: #cd0e66; font-weight: bold; font-size: 18px;","color: #0f82f2; font-weight: bold;","color: #22ab24; font-weight: bold;","color: #fd8c00; font-weight: bold;");var t0=[38,38,40,40,37,39,37,39,66,65],ar=0;document.addEventListener("keydown",e=>{e.keyCode===t0[ar]?(ar+=1,ar===t0.length&&(Zs(),ar=0)):ar=0});})();
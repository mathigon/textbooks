"use strict";/* (c) Mathigon, generated by Mathigon Studio */
(()=>{var th=Object.defineProperty,Jp=Object.defineProperties,td=Object.getOwnPropertyDescriptor,ed=Object.getOwnPropertyDescriptors;var Qa=Object.getOwnPropertySymbols;var sd=Object.prototype.hasOwnProperty,id=Object.prototype.propertyIsEnumerable;var Ja=(t,s,e)=>s in t?th(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e,zt=(t,s)=>{for(var e in s||(s={}))sd.call(s,e)&&Ja(t,e,s[e]);if(Qa)for(var e of Qa(s))id.call(s,e)&&Ja(t,e,s[e]);return t},Ft=(t,s)=>Jp(t,ed(s));var $=(t,s,e,i)=>{for(var n=i>1?void 0:i?td(s,e):s,r=t.length-1,o;r>=0;r--)(o=t[r])&&(n=(i?o(s,e,n):o(n))||n);return i&&n&&th(s,e,n),n};var O=(t,s,e)=>new Promise((i,n)=>{var r=h=>{try{a(e.next(h))}catch(l){n(l)}},o=h=>{try{a(e.throw(h))}catch(l){n(l)}},a=h=>h.done?i(h.value):Promise.resolve(h.value).then(r,o);a((e=e.apply(t,s)).next())});function ds(t=10){return Math.random().toString(36).substr(2,t)}function _(t,...s){return s.includes(t)}var nd=(t,s)=>t.concat(s);function Qr(t,s,e=nd){for(let i of Object.keys(s))i in t&&Array.isArray(t[i])&&Array.isArray(s[i])?t[i]=e(t[i],s[i]):i in t&&t[i]instanceof Object&&s[i]instanceof Object?Qr(t[i],s[i]):t[i]=s[i]}function oe(t,s=0){return s?+setTimeout(t,s):(t(),0)}function ei(t){return new Promise(s=>setTimeout(s,t))}function Ne(){let t=()=>{},s=()=>{},e=new Promise((i,n)=>{t=i,s=n});return e.catch(i=>i),{promise:e,resolve:t,reject:s}}var eh=class extends Error{constructor(t){super("[Cache Error]"),this.data=t}};function us(t){let s=new Map;return function(...e){let i=e.join("--");if(!s.has(i))try{s.set(i,t(...e))}catch(r){s.set(i,new eh(r))}let n=s.get(i);if(n instanceof eh)throw n.data;return n}}function ue(t,s=0,e=!1){let i=!1,n=!1;return(...r)=>{i?n=!0:(e?n=!0:t(...r),i=!0,setTimeout(()=>{n&&t(...r),i=n=!1},s))}}function rd(t){return function(s,e){if(!s||Array.isArray(this)||t.includes(s))return e}}function fe(t,s,e){if(!t)return s;try{return JSON.parse(t,e?rd(e):void 0)||s}catch(i){return s}}function Zt(t,s){return new Array(s).fill(t)}function Jr(t,s,e){let i=[];for(let n=0;n<s;++n)i.push(Zt(t,e));return i}function H(t,s){let e=[];for(let i=0;i<s;++i)e.push(t(i));return e}function nh(t,s,e){let i=[];for(let n=0;n<s;++n){let r=[];for(let o=0;o<e;++o)r.push(t(n,o));i.push(r)}return i}function fs(t,s,e=1){let i=[];if(s===void 0&&t>=0)for(let n=0;n<t;n+=e)i.push(n);else if(s===void 0)for(let n=0;n>t;n-=e)i.push(n);else if(t<=s)for(let n=t;n<=s;n+=e)i.push(n);else for(let n=t;n>=s;n-=e)i.push(n);return i}function L(t,s=0){return t[t.length-1-s]}function D(t){return t.reduce((s,e)=>s+e,0)}function si(t,s,e=!1){return t.slice(0).sort((i,n)=>{let r=s(i),o=s(n);return r<o?e?1:-1:r>o?e?-1:1:0})}function Ke(t){let s=0;return()=>t[s++%t.length]}function Pt(t){return t.filter((s,e)=>t.indexOf(s)===e)}function Qt(t){return t.reduce((s,e)=>s.concat(Array.isArray(e)?Qt(e):e),[])}function Bi(t){let s=0;return t.map(e=>s+=e)}function to(t,s){let e=[];for(let i=0;i<t.length;i+=s)e.push(t.slice(i,i+s));return e}function ii(t,s=1){let e=t.length;s=(s%e+e)%e;let i=t.slice(0,s);return t.slice(s).concat(i)}function rh(...t){return t.reduce((s,e)=>s.concat(e),[])}var oh=class{constructor(t){let s=t.length,e=t.map(i=>({val:i}));for(let[i,n]of e.entries())n.next=e[(i+1)%s],n.prev=e[(i-1+s)%s];this.root=e[0]}*traverse(){let t=this.root;for(;t;)if(yield t,t=t.next,t===this.root)return}get array(){return Array.from(this.traverse())}delete(t){if(t===this.root){if(t.next===t)return this.root=void 0;this.root=t.next}t.prev.next=t.next,t.next.prev=t.prev}};function K(t,s=/\s+/){return t?t.trim().split(s):[]}function qi(t){return t.toLowerCase().replace(/^-/,"").replace(/-(.)/g,(s,e)=>e.toUpperCase())}function od(t,s,e=!1){let i=Jr(0,t.length+1,s.length+1);for(let n=0;n<=t.length;n++)i[n][0]=n;for(let n=0;n<=s.length;n++)i[0][n]=n;for(let n=1;n<=t.length;n++)for(let r=1;r<=s.length;r++)i[n][r]=Math.min(i[n-1][r-1]+(t.charAt(n-1)===s.charAt(r-1)?0:1),i[n-1][r]+1,i[n][r-1]+1);return e?Math.min(...i[t.length]):i[t.length][s.length]}function ah(t,s){let e=t.length/2,i=s.map(r=>({w:r,d:od(t,r)})).filter(({d:r})=>r<e),n=si(i,r=>r.d)[0];return n?n.w:void 0}var Me=class{constructor(){this.events=new Map}on(t,s){for(let e of K(t))this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(s)}one(t,s){let e=i=>{this.off(t,e),s(i)};this.on(t,e)}off(t,s){for(let e of K(t))this.events.has(e)&&this.events.set(e,this.events.get(e).filter(i=>i!==s))}trigger(t,s){for(let e of K(t))if(this.events.has(e))for(let i of this.events.get(e))i(s)}},ad=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,hd=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i,ld=/rgba?\(([0-9.]+), ?([0-9.]+), ?([0-9.]+)(, ?([0-9.]+))?\)/,cd=["#22ab24","#009ea6","#0f82f2","#6d3bbf","#cd0e66","#eb4726","#fd8c00"];function sh(t){return t.length===1?`0${t}`:t}function ih(t,s){if(s<=0)return J.from(t[0]);if(s>=1)return J.from(L(t));let e=Math.floor(s*(t.length-1)),i=s*(t.length-1)-e;return J.mix(t[e+1],t[e],i)}function Zr(t,s,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?t+(s-t)*6*e:e<1/2?s:e<2/3?t+(s-t)*(2/3-e)*6:t}var J=class{constructor(t,s,e,i=1){this.r=t,this.g=s,this.b=e,this.a=i}get hex(){let t=[this.r,this.g,this.b].map(e=>sh(Math.round(e).toString(16))),s=this.a>=1?"":sh(Math.round(this.a*255).toString(16));return`#${t.join("")}${s}`}get rgb(){return`rgba(${[this.r,this.g,this.b].map(s=>Math.round(s)).join(",")},${this.a})`}get brightness(){return(this.r*299+this.g*587+this.g*114)/1e3}get hsl(){let t=this.r/255,s=this.g/255,e=this.b/255,i=Math.max(t,s,e),n=Math.min(t,s,e),r=(n+i)/2,o=i-n;if(i===n)return[0,0,Math.round(r*100)];let a=t===i?(s-e)/o:s===i?2+(e-t)/o:4+(t-s)/o;a=Math.min(a*60,360),a<0&&(a+=360);let h=r<=.5?o/(i+n):o/(2-i-n);return[Math.round(a),Math.round(h*100),Math.round(r*100)]}get chroma(){return Math.max(this.r,this.g,this.b)-Math.min(this.r,this.g,this.b)}toString(){return this.rgb}copy(){return new J(this.r,this.g,this.b,this.a)}static from(t){return typeof t!="string"?t:t.startsWith("#")?J.fromHex(t):J.fromRgb(t)}static fromRgb(t){let s=t.match(ld);if(!s)return new J(0,0,0);let e=s[4]?+s[5]||0:1;return new J(+s[1],+s[2],+s[3],e)}static fromHex(t){t=t.replace(ad,(e,i,n,r)=>i+i+n+n+r+r);let s=hd.exec(t);return s?new J(parseInt(s[1],16),parseInt(s[2],16),parseInt(s[3],16),s[4]?parseInt(s[4],16)/255:1):new J(0,0,0)}static fromHsl(t,s,e){if(t/=360,s/=100,e/=100,s===0){let h=Math.round(e*255);return new J(h,h,h)}let i=e<.5?e*(1+s):e+s-e*s,n=2*e-i,r=Zr(n,i,t+1/3),o=Zr(n,i,t),a=Zr(n,i,t-1/3);return new J(Math.round(r*255),Math.round(o*255),Math.round(a*255))}static rainbow(t){return H(s=>ih(cd,s/(t-1)),t)}static gradient(t,s){return H(e=>ih(t,e/(s-1)),s)}static shades(t,s,e=.5){let i=J.mix("#fff",t,e),n=J.mix("#000",t,e);return J.gradient([i,t,n],s)}static mix(t,s,e=.5){return t=J.from(t),s=J.from(s),new J(e*t.r+(1-e)*s.r,e*t.g+(1-e)*s.g,e*t.b+(1-e)*s.b,e*t.a+(1-e)*s.a)}static mixMany(t,s){s||(s=t.map(()=>1));let e=D(s),i=t.map(u=>u.hsl),n=i.map(u=>u[0]),r=n.map(u=>u<180?u+360:u),o=s.map((u,v)=>u*Math.sqrt(t[v].chroma)),a=D(o),h=D(n.map((u,v)=>u*o[v]))/a,l=D(r.map((u,v)=>u*o[v]))/a,p=D(n.map((u,v)=>Math.abs(u-h)*o[v])),f=D(r.map((u,v)=>Math.abs(u-l)*o[v])),m=p<=f?h:l%360,g=D(i.map((u,v)=>s[v]*u[1]))/e,x=D(i.map((u,v)=>s[v]*u[2]))/e;return J.fromHsl(m,g,x)}};function zi(t){return t[Symbol.iterator]().next().value}function me(t,s){for(let e of t)if(s(e))return!0;return!1}function*Fi(t,s){for(let e of t)for(let i of s(e))yield i}function*ms(t,s){for(let e of t)for(let i of s)yield[e,i]}function*eo(t){let s=t.length;for(let e=0;e<s;++e)for(let i=e+1;i<s;++i)yield[t[e],t[i]]}function Xe(t,s,e=1/0,i){let n,r=e;for(let o of t){let a=s(o);if(a<r&&(n=o,r=a,i!==void 0&&r<i))return n}return n}var Gi=class{constructor(...t){this.values=t}map(t){let s=this.values;return new Gi(function*(){let e=0;for(let i of s)for(let n of i)yield t(n,e),e+=1}())}every(t){let s=0;for(let e of this.values)for(let i of e){if(!t(i,s))return!1;s+=1}return!0}some(t){let s=0;for(let e of this.values)for(let i of e){if(t(i,s))return!0;s+=1}return!1}slice(t,s){let e=this.values;return new Gi(function*(){let i=0;for(let n of e)for(let r of n)i<t||s!==void 0&&i>t+s||(yield r,i+=1)}())}filter(t){let s=this.values;return new Gi(function*(){let e=0;for(let i of s)for(let n of i)t(n,e)&&(yield n),e+=1}())}concat(t){this.values.push(t)}[Symbol.iterator](){let t=this.values;return function*(){for(let s of t)for(let e of s)yield e}()}static make(t,s){return new Gi(function*(){let e=0;for(;s===void 0||e<s;)yield t(e),e+=1}())}};var pd=Object.defineProperty,no=(t,s)=>{for(var e in s)pd(t,e,{get:s[e],enumerable:!0})},ro=1e-6;function y(t,s,e=ro){return isNaN(t)||isNaN(s)?!1:Math.abs(t-s)<e}function Ce(t,s=ro){return y(t%1,0,s)}function ct(t,s,e,i=ro){return s>e&&([s,e]=[e,s]),t>s+i&&t<e-i}var hh=/(\d+)(\d{3})/,dd=["","k","m","b","t","q"];function ud(t){let[s,e]=t.split(".");for(;hh.test(s);)s=s.replace(hh,"$1,$2");return s+(e?`.${e}`:"")}function fd(t,s=6){if(!s)return`${t}`;let e=`${Math.abs(Math.floor(t))}`.length,i=t<0?1:0;if(e<=s-i)return`${ae(t,s-e-i-1)}`;let n=Math.floor(Math.log10(Math.abs(t))/3);return ae(t/Math.pow(10,3*n),s-(e%3||3)-i-1)+dd[n]}function It(t,s=0,e=!0){let i=fd(t,s).replace("-","\u2013");return e?ud(i):i}var md=/^-?0,[0-9]+$/,gd=/^-?([0-9]+(,[0-9]{3})*)?\.?[0-9]*$/,vd=/^-?[0-9]+(\.[0-9]{3})*,?[0-9]*$/;function dh(t){return t=t.replace(/^–/,"-").trim(),!t||t.match(/[^0-9.,-]/)?NaN:md.test(t)?parseFloat(t.replace(/,/,".")):gd.test(t)?parseFloat(t.replace(/,/g,"")):vd.test(t)?parseFloat(t.replace(/\./g,"").replace(/,/,".")):NaN}var so=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],lh=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],wd=[""," thousand"," million"," billion"," trillion"," quadrillion"," quintillion"," sextillion"];function yd(t){let[s,e,i]=t.split(""),n=s==="0"?"":` ${so[+s]} hundred`;return e+i==="00"?n:+e<2?`${n} ${so[+(e+i)]}`:i==="0"?`${n} ${lh[+e]}`:`${n} ${lh[+e]}-${so[+i]}`}function oo(t){if(t===0)return"zero";let s=Math.round(Math.abs(t)).toString(),e=Math.ceil(s.length/3),i=s.padStart(3*e,"0"),n="";for(let r=0;r<e;r+=1){let o=i.substr(r*3,3);o!=="000"&&(n+=yd(o)+wd[e-1-r])}return n.trim()}function ae(t,s=0){let e=Math.pow(10,s);return Math.round(t*e)/e}function vt(t,s=1){return Math.round(t/s)*s}function G(t,s=-1/0,e=1/0){return Math.min(e,Math.max(s,t))}function wt(t,s,e=.5){return t+(s-t)*e}function jt(t){return t*t}function Mt(t,s){return(t%s+s)%s}function ao(t,s,e){if(y(t,0)&&y(s,0))return[];if(y(t,0))return[-e/s];let i=-s/2/t,n=Math.sqrt(s*s-4*t*e)/2/t;return[i+n,i-n]}function uh(t,s=0){let e=t.slice(0),i=fh(e);return s?i.filter(n=>n.length===s):i}function fh(t){if(t.length===1)return[[],t];let s=t.pop(),e=fh(t),i=[];for(let n of e)i.push(n,[...n,s]);return i}var Hi=(t,s)=>{let e=t<0?"\u2013":"";return Math.abs(t)===1&&s?e+s:e+Math.abs(t)+(s||"")},lt=class{constructor(t=0,s=0){this.re=t,this.im=s}get modulus(){return Math.sqrt(this.re*this.re+this.im*this.im)}get argument(){return Math.atan2(this.im,this.re)}get conjugate(){return new lt(this.re,-this.im)}root(t,s=0){let e=Math.pow(this.modulus,1/t),i=(this.argument+s*2*Math.PI)/t;return new lt(e*Math.cos(i),e*Math.sin(i))}toString(t=2){let s=ae(this.re,t),e=ae(this.im,t);return e===0?Hi(s):s===0?Hi(e,"i"):[Hi(s),e<0?"\u2013":"+",Hi(Math.abs(e),"i")].join(" ")}add(t){return lt.sum(this,t)}subtract(t){return lt.difference(this,t)}multiply(t){return lt.product(this,t)}divide(t){return lt.quotient(this,t)}static sum(t,s){return typeof t=="number"&&(t=new lt(t,0)),typeof s=="number"&&(s=new lt(s,0)),new lt(t.re+s.re,t.im+s.im)}static difference(t,s){return typeof t=="number"&&(t=new lt(t,0)),typeof s=="number"&&(s=new lt(s,0)),new lt(t.re-s.re,t.im-s.im)}static product(t,s){typeof t=="number"&&(t=new lt(t,0)),typeof s=="number"&&(s=new lt(s,0));let e=t.re*s.re-t.im*s.im,i=t.im*s.re+t.re*s.im;return new lt(e,i)}static quotient(t,s){if(typeof t=="number"&&(t=new lt(t,0)),typeof s=="number"&&(s=new lt(s,0)),Math.abs(s.re)<Number.EPSILON||Math.abs(s.im)<Number.EPSILON)return new lt(1/0,1/0);let e=s.re*s.re+s.im*s.im,i=(t.re*s.re+t.im*s.im)/e,n=(t.im*s.re-t.re*s.im)/e;return new lt(i,n)}static exp(t){typeof t=="number"&&(t=new lt(t,0));let s=Math.exp(t.re);return new lt(s*Math.cos(t.im),s*Math.sin(t.im))}};function De(...t){let[s,...e]=t;if(e.length>1)return De(s,De(...e));let i=Math.abs(s),n=Math.abs(e[0]);for(;n;)[i,n]=[n,i%n];return i}function ni(...t){let[s,...e]=t;return e.length>1?ni(s,ni(...e)):Math.abs(s*e[0])/De(s,e[0])}function ho(t){if(t%1!==0||t<2)return!1;if(t%2===0)return t===2;if(t%3===0)return t===3;let s=Math.sqrt(t);for(let e=5;e<=s;e+=6)if(t%e===0||t%(e+2)===0)return!1;return!0}function io(t){if(t===1)return[];if(ho(t))return[t];let s=Math.sqrt(t);for(let e=2;e<=s;++e)if(t%e===0)return io(e).concat(io(t/e));return[]}function mh(t){return Pt(io(t))}var xd=/^([0-9\-.]*)([%πkmbtq]?)(\/([0-9\-.]+))?([%π]?)$/,z=class{constructor(t,s,e){this.unit=e,this.num=s!==void 0&&s<0?-t:t,s!==void 0&&Math.abs(s)!==1&&t!==0&&(this.den=Math.abs(s))}valueOf(){return this.value}toString(t=4){let s=It(this.num,t),e=this.unit||"",i=this.den?`/${It(this.den,t)}`:"";return s==="0"&&(e=""),e==="\u03C0"&&!this.den&&(s==="1"||s==="\u20131")&&(s=s.replace("1","")),`${s}${i}${e}`}toMathML(){let t=`<mn>${this.num}</mn>`;return this.den!==void 0&&(t=`<mfrac>${t}<mn>${this.den}</mn></mfrac>`),this.unit&&(t+=this.unit==="\u03C0"?"<mi>\u03C0</mi>":"<mo>%</mo>"),t}get value(){let t=this.unit==="%"?.01:this.unit==="\u03C0"?Math.PI:1;return this.num*t/(this.den||1)}get sign(){return Math.sign(this.num)}get simplified(){if(!this.den)return this;let t=De(Math.abs(this.num),this.den);return new z(this.num/t,this.den/t,this.unit)}get inverse(){return this.den?new z(1/this.num,void 0,this.unit):new z(this.den,this.num)}get negative(){return new z(-this.num,this.den,this.unit)}static fromString(t){t=t.toLowerCase().replace(/[\s,]/g,"").replace("\u2013","-").replace("pi","\u03C0");let s=t.match(xd);if(!s)return;let e=s[2]||s[5]||void 0,i=s[1]?+s[1]:void 0,n=s[4]?+s[4]:void 0;if(e==="\u03C0"&&(!s[1]||s[1]==="-")&&(i=s[1]?-1:1),i===void 0||isNaN(i))return;let r=e?"kmbtq".indexOf(e):-1;if(r>=0&&(i*=1e3**(r+1),e=void 0),n===void 0)return new z(i,void 0,e);if(!(isNaN(n)||y(n,0)))return!Ce(i)||!Ce(n)?new z(i/n,void 0,e):new z(i,n,e)}static fractionFromDecimal(t,s=100){let e=Math.sign(t),i=Math.floor(Math.abs(t));t=Math.abs(t)-i;let n=0,r=1,o=1,a=1;for(;r<=s&&a<=s;){let h=(n+o)/(r+a);if(t===h)return r+a<=s?new z(e*(i*(r+a)+n+o),r+a):a>r?new z(e*(i*a+o),a):new z(e*(i*r+n),r);t>h?[n,r]=[n+o,r+a]:[o,a]=[n+o,r+a]}return r>s?new z(e*(i*a+o),a):new z(e*(i*r+n),r)}clamp(t,s){let e=this.value;return t!==void 0&&e<t?new z(t):s!==void 0&&e>s?new z(s):this}add(t){return z.sum(this,t)}subtract(t){return z.difference(this,t)}multiply(t){return z.product(this,t)}divide(t){return z.quotient(this,t)}static sum(t,s){return typeof s=="number"&&(s=new z(s)),t.num===0?s:t.unit!==s.unit?new z(t.value+s.value):!t.den&&!s.den?new z(t.num+s.num,void 0,t.unit):(t.den||([t,s]=[s,t]),Ce(s.num)?new z(t.num*(s.den||1)+s.num*t.den,t.den*(s.den||1),t.unit).simplified:new z(t.value+s.value,void 0,t.unit))}static difference(t,s){return typeof s=="number"&&(s=new z(s)),z.sum(t,s.negative)}static product(t,s){if(typeof s=="number"&&(s=new z(s)),!t.unit&&!t.den&&Ce(t.num))return new z(t.num*s.num,s.den,s.unit).simplified;if(!s.unit&&!s.den&&Ce(s.num))return new z(t.num*s.num,t.den,t.unit).simplified;if(t.unit==="\u03C0"||s.unit==="\u03C0"||!Ce(t.num)||!Ce(s.num))return new z(t.value*s.value);let e=(t.unit==="%"?100:1)*(s.unit==="%"?100:1);return new z(t.num*s.num,(t.den||1)*(s.den||1)*e)}static quotient(t,s){return typeof s=="number"&&(s=new z(s)),z.product(t,s.inverse)}},Et={};no(Et,{determinant:()=>Td,fill:()=>gh,identity:()=>vh,inverse:()=>xh,product:()=>Ui,reflection:()=>Pd,rotation:()=>bd,scalarProduct:()=>Ed,shear:()=>$d,sum:()=>wh,transpose:()=>yh});function gh(t,s,e){return Jr(t,s,e)}function vh(t=2){let s=gh(0,t,t);for(let e=0;e<t;++e)s[e][e]=1;return s}function bd(t){let s=Math.sin(t),e=Math.cos(t);return[[e,-s],[s,e]]}function $d(t){return[[1,t],[0,1]]}function Pd(t){let s=Math.sin(2*t),e=Math.cos(2*t);return[[e,s],[s,-e]]}function wh(...t){let[s,...e]=t,i=e.length>1?wh(...e):e[0];if(s.length!==i.length||s[0].length!==i[0].length)throw new Error("Matrix sizes don\u2019t match");let n=[];for(let r=0;r<s.length;++r){let o=[];for(let a=0;a<s[r].length;++a)o.push(s[r][a]+i[r][a]);n.push(o)}return n}function Ed(t,s){return t.map(e=>e.map(i=>i*s))}function Ui(...t){let[s,...e]=t,i=e.length>1?Ui(...e):e[0];if(s[0].length!==i.length)throw new Error("Matrix sizes don\u2019t match.");let n=[];for(let r=0;r<s.length;++r){let o=[];for(let a=0;a<i[0].length;++a){let h=0;for(let l=0;l<i.length;++l)h+=s[r][l]*i[l][a];o.push(h)}n.push(o)}return n}function yh(t){let s=[];for(let e=0;e<t[0].length;++e){let i=[];for(let n=0;n<t.length;++n)i.push(t[n][e]);s.push(i)}return s}function Td(t){if(t.length!==t[0].length)throw new Error("Not a square matrix.");let s=t.length;if(s===1)return t[0][0];if(s===2)return t[0][0]*t[1][1]-t[0][1]*t[1][0];let e=0;for(let i=0;i<s;++i){let n=t[0][i],r=t[0][i];for(let o=1;o<s;++o)r*=t[o][(i+o)%s],n*=t[o][(i-o+s)%s];e+=r-n}return e}function xh(t){let s=t.length;if(s!==t[0].length)throw new Error("Not a square matrix.");let e=vh(s),i=nh((n,r)=>t[n][r],s,s);for(let n=0;n<s;++n){let r=i[n][n];if(y(r,0)){for(let o=n+1;o<s;++o)if(i[o][n]!==0){for(let a=0;a<s;++a)[i[o][a],i[n][a]]=[i[n][a],i[o][a]],[e[o][a],e[n][a]]=[e[n][a],e[o][a]];break}if(r=i[n][n],y(r,0))throw new Error("Matrix not invertible.")}for(let o=0;o<s;++o)i[n][o]=i[n][o]/r,e[n][o]=e[n][o]/r;for(let o=0;o<s;++o){if(o===n)continue;let a=i[o][n];for(let h=0;h<s;++h)i[o][h]-=a*i[n][h],e[o][h]-=a*e[n][h]}}return e}var Ot={};no(Ot,{bernoulli:()=>$h,binomial:()=>Ad,cauchy:()=>_d,chiCDF:()=>Dd,exponential:()=>Rd,find:()=>Cd,geometric:()=>Ld,integer:()=>Md,integrate:()=>Eh,normal:()=>Od,normalPDF:()=>Nd,poisson:()=>Vd,shuffle:()=>Sd,smart:()=>kd,uniform:()=>Id,weighted:()=>bh});function Sd(t){t=t.slice(0);for(let s=t.length-1;s>0;--s){let e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}return t}function Md(t,s){let e=s===void 0?0:t,i=s===void 0?t:s-t+1;return e+Math.floor(i*Math.random())}function bh(t){let s=Math.random()*D(t),e=0;return t.findIndex(i=>(e+=i)>=s)}function Cd(t){return t[Math.floor(t.length*Math.random())]}var ji=new Map;function kd(t,s){s||(s=ds()),ji.has(s)||ji.set(s,Zt(1,t));let e=ji.get(s),i=bh(e.map(n=>n*n));return e[i]-=1,e[i]<=0&&ji.set(s,e.map(n=>n+1)),i}function $h(t=.5){return Math.random()<t?1:0}function Ad(t=1,s=.5){let e=0;for(let i=0;i<t;++i)e+=$h(s);return e}function Vd(t=1){if(t<=0)return 0;let s=Math.exp(-t),e=1,i=0;for(;e>s;++i)e*=Math.random();return i-1}function Id(t=0,s=1){return t+(s-t)*Math.random()}function Od(t=0,s=1){let e=Math.random(),i=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*i)*Math.sqrt(s)+t}function Rd(t=1){return t<=0?0:-Math.log(Math.random())/t}function Ld(t=.5){if(!(t<=0||t>1))return Math.floor(Math.log(Math.random())/Math.log(1-t))}function _d(){let t,s,e;do s=2*Math.random()-1,e=2*Math.random()-1,t=s*s+e*e;while(t>=1);return s/e}function Nd(t,s=1,e=0){return Math.exp(-((t-s)**2)/(2*e))/Math.sqrt(2*Math.PI*e)}var ch=7,ph=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23];function Ph(t){if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*Ph(1-t));t-=1;let s=ph[0];for(let i=1;i<ch+2;i++)s+=ph[i]/(t+i);let e=t+ch+.5;return Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*s}function Eh(t,s,e,i=1){let n=0;for(let r=s;r<e;r+=i)n+=t(r)*i||0;return n}function Dd(t,s){let e=Eh(i=>Math.pow(i,(s-2)/2)*Math.exp(-i/2),0,t);return 1-e/Math.pow(2,s/2)/Ph(s/2)}var lo={};no(lo,{bestPolynomial:()=>Hd,coefficient:()=>Sh,exponential:()=>qd,linear:()=>Bd,logarithmic:()=>zd,polynomial:()=>Th,power:()=>Fd});function Gd(t,s){let e=1,i=t[0];for(let n=1;n<t.length;++n)e*=s,i+=e*t[n];return i}function Bd(t,s=!1){let e=0,i=0,n=0,r=0,o=t.length;for(let l=0;l<o;l++)e+=t[l][0],i+=t[l][1],n+=t[l][0]*t[l][0],r+=t[l][0]*t[l][1];if(s){let l=r/n;return[0,l]}let a=(o*r-e*i)/(o*n-e*e);return[i/o-a*e/o,a]}function qd(t){let s=[0,0,0,0,0,0];for(let r of t)s[0]+=r[0],s[1]+=r[1],s[2]+=r[0]*r[0]*r[1],s[3]+=r[1]*Math.log(r[1]),s[4]+=r[0]*r[1]*Math.log(r[1]),s[5]+=r[0]*r[1];let e=s[1]*s[2]-s[5]*s[5],i=Math.exp((s[2]*s[3]-s[5]*s[4])/e),n=(s[1]*s[4]-s[5]*s[3])/e;return[i,n]}function zd(t){let s=[0,0,0,0],e=t.length;for(let r of t)s[0]+=Math.log(r[0]),s[1]+=r[1]*Math.log(r[0]),s[2]+=r[1],s[3]+=Math.pow(Math.log(r[0]),2);let i=(e*s[1]-s[2]*s[0])/(e*s[3]-s[0]*s[0]);return[(s[2]-i*s[0])/e,i]}function Fd(t){let s=[0,0,0,0],e=t.length;for(let r of t)s[0]+=Math.log(r[0]),s[1]+=Math.log(r[1])*Math.log(r[0]),s[2]+=Math.log(r[1]),s[3]+=Math.pow(Math.log(r[0]),2);let i=(e*s[1]-s[2]*s[0])/(e*s[3]-s[0]*s[0]);return[Math.exp((s[2]-i*s[0])/e),i]}function Th(t,s=2){let e=t.map(h=>fs(s+1).map(l=>Math.pow(h[0],l))),i=yh(e),n=t.map(h=>[h[1]]),r=Ui(i,e),o=xh(r);return Ui(o,i,n).map(h=>h[0])}function Sh(t,s){let i=t.reduce((o,a)=>o+a[1],0)/t.length,n=t.reduce((o,a)=>o+(a[1]-i)**2,0),r=t.reduce((o,a)=>o+(a[1]-s(a[0]))**2,0);return 1-r/n}function Hd(t,s=.85,e=8){if(!(t.length<=1))for(let i=1;i<e;++i){let n=Th(t,i),r=a=>Gd(n,a);if(Sh(t,r)>=s)return{order:i,coefficients:n,fn:r}}}function gs(t){return t.length?D(t)/t.length:0}var yt=2*Math.PI;function ri(t,s){let e=Math.atan2(t.y-(s?s.y:0),t.x-(s?s.x:0));return Mt(e,yt)}function Mh(t,s){let e,i=1/0,n=-1;for(let[r,o]of s.entries()){let a=o.project(t),h=c.distance(t,a);h<i&&(e=a,i=h,n=r)}return e?[e,n]:void 0}var c=class{constructor(t=0,s=0){this.x=t,this.y=s,this.type="point"}get unitVector(){return y(this.length,0)?new c(1,0):this.scale(1/this.length)}get length(){return Math.sqrt(this.x**2+this.y**2)}get inverse(){return new c(-this.x,-this.y)}get flip(){return new c(this.y,this.x)}get perpendicular(){return new c(-this.y,this.x)}get array(){return[this.x,this.y]}distanceFromLine(t){return c.distance(this,t.project(this))}clamp(t,s=0){let e=G(this.x,t.xMin+s,t.xMax-s),i=G(this.y,t.yMin+s,t.yMax-s);return new c(e,i)}changeCoordinates(t,s){let e=s.xMin+(this.x-t.xMin)/t.dx*s.dx,i=s.yMin+(this.y-t.yMin)/t.dy*s.dy;return new c(e,i)}add(t){return c.sum(this,t)}subtract(t){return c.difference(this,t)}round(t=1){return new c(vt(this.x,t),vt(this.y,t))}floor(){return new c(Math.floor(this.x),Math.floor(this.y))}mod(t,s=t){return new c(this.x%t,this.y%s)}angle(t=I){return ri(this,t)}snap(t,s=5){return y(this.x,t.x,s)?new c(t.x,this.y):y(this.y,t.y,s)?new c(this.x,t.y):this}static average(...t){let s=D(t.map(i=>i.x))/t.length,e=D(t.map(i=>i.y))/t.length;return new c(s,e)}static dot(t,s){return t.x*s.x+t.y*s.y}static sum(t,s){return new c(t.x+s.x,t.y+s.y)}static difference(t,s){return new c(t.x-s.x,t.y-s.y)}static distance(t,s){return Math.sqrt(jt(t.x-s.x)+jt(t.y-s.y))}static manhattan(t,s){return Math.abs(t.x-s.x)+Math.abs(t.y-s.y)}static interpolate(t,s,e=.5){return new c(wt(t.x,s.x,e),wt(t.y,s.y,e))}static interpolateList(t,s=.5){let e=t.length-1,i=Math.floor(G(s,0,1)*e);return c.interpolate(t[i],t[i+1],e*s-i)}static fromPolar(t,s=1){return new c(s*Math.cos(t),s*Math.sin(t))}static random(t){let s=Ot.uniform(t.xMin,t.xMax),e=Ot.uniform(t.yMin,t.yMax);return new c(s,e)}static equals(t,s,e){return y(t.x,s.x,e)&&y(t.y,s.y,e)}static colinear(t,s,e,i){let n=t.x-s.x,r=t.y-s.y,o=s.x-e.x,a=s.y-e.y;return y(n*a,o*r,i)}transform(t){let s=t[0][0]*this.x+t[0][1]*this.y+t[0][2],e=t[1][0]*this.x+t[1][1]*this.y+t[1][2];return new c(s,e)}rotate(t,s=I){if(y(t,0))return this;let e=this.x-s.x,i=this.y-s.y,n=Math.cos(t),r=Math.sin(t),o=e*n-i*r+s.x,a=e*r+i*n+s.y;return new c(o,a)}reflect(t){let s=t.p2.x-t.p1.x,e=t.p2.y-t.p1.y,i=this.x-t.p1.x,n=this.y-t.p1.y,r=(s*n-e*i)/(s*s+e*e),o=this.x+2*r*e,a=this.y-2*r*s;return new c(o,a)}scale(t,s=t){return new c(this.x*t,this.y*s)}shift(t,s=t){return new c(this.x+t,this.y+s)}translate(t){return this.shift(t.x,t.y)}equals(t,s){return c.equals(this,t,s)}toString(){return`point(${this.x},${this.y})`}},I=new c(0,0),st=class{constructor(t,s){this.p1=t,this.p2=s,this.type="line"}make(t,s){return new st(t,s)}get length(){return c.distance(this.p1,this.p2)}get lengthSquared(){return(this.p1.x-this.p2.x)**2+(this.p1.y-this.p2.y)**2}get midpoint(){return c.average(this.p1,this.p2)}get slope(){return(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x)}get intercept(){return this.p1.y-this.slope*this.p1.x}get angle(){return ri(this.p2,this.p1)}get unitVector(){return this.p2.subtract(this.p1).unitVector}get perpendicularVector(){return new c(this.p2.y-this.p1.y,this.p1.x-this.p2.x).unitVector}parallel(t){let s=c.sum(t,c.difference(this.p2,this.p1));return new st(t,s)}perpendicular(t){return new st(t,c.sum(t,this.perpendicularVector))}get perpendicularBisector(){return this.perpendicular(this.midpoint)}distanceSquared(t){let s=this.project(t);return(t.x-s.x)**2+(t.y-s.y)**2}offset(t){let s=c.difference(this.p2,this.p1),e=c.difference(t,this.p1);return c.dot(s,e)/this.lengthSquared}project(t){return this.at(this.offset(t))}side(t,s){let e=c.difference(this.p2,this.p1),i=c.difference(t,this.p1),n=i.x*e.y-i.y*e.x;return y(n,0,s)?0:Math.sign(n)}contains(t,s){return this.side(t,s)===0}at(t){return c.interpolate(this.p1,this.p2,t)}transform(t){return new this.constructor(this.p1.transform(t),this.p2.transform(t))}rotate(t,s=I){return y(t,0)?this:new this.constructor(this.p1.rotate(t,s),this.p2.rotate(t,s))}reflect(t){return new this.constructor(this.p1.reflect(t),this.p2.reflect(t))}scale(t,s=t){return this.make(this.p1.scale(t,s),this.p2.scale(t,s))}shift(t,s=t){return this.make(this.p1.shift(t,s),this.p2.shift(t,s))}translate(t){return this.shift(t.x,t.y)}equals(t,s){return this.contains(t.p1,s)&&this.contains(t.p2,s)}toString(){return`line(${this.p1},${this.p2})`}},fo=class extends st{constructor(){super(...arguments),this.type="ray"}make(t,s){return new fo(t,s)}equals(t,s){return t.type!=="ray"?!1:this.p1.equals(t.p1,s)&&this.contains(t.p2,s)}contains(t,s){if(!st.prototype.contains.call(this,t,s))return!1;let e=this.offset(t);return y(e,0,s)||e>0}toString(){return`ray(${this.p1},${this.p2})`}},X=class extends st{constructor(){super(...arguments),this.type="segment"}contains(t,s){return st.prototype.contains.call(this,t,s)?this.p1.equals(t,s)||this.p2.equals(t,s)?!0:y(this.p1.x,this.p2.x,s)?ct(t.y,this.p1.y,this.p2.y):ct(t.x,this.p1.x,this.p2.x):!1}make(t,s){return new X(t,s)}project(t){let s=c.difference(this.p2,this.p1),e=c.difference(t,this.p1),i=G(c.dot(s,e)/this.lengthSquared,0,1);return c.sum(this.p1,s.scale(i))}contract(t){return new X(this.at(t),this.at(1-t))}equals(t,s,e=!1){return t.type!=="segment"?!1:this.p1.equals(t.p1,s)&&this.p2.equals(t.p2,s)||!e&&this.p1.equals(t.p2,s)&&this.p2.equals(t.p1,s)}toString(){return`segment(${this.p1},${this.p2})`}},et=class{constructor(t=I,s=1){this.c=t,this.r=s,this.type="circle"}get circumference(){return yt*this.r}get area(){return Math.PI*this.r**2}get arc(){let t=this.c.shift(this.r,0);return new Lt(this.c,t,yt)}tangentAt(t){let s=this.at(t),e=this.c.rotate(Math.PI/2,s);return new st(s,e)}collision(t){let s=this.c.x<t.p.x?t.p.x:this.c.x>t.p.x+t.w?t.p.x+t.w:this.c.x,e=this.c.y<t.p.y?t.p.y:this.c.y>t.p.y+t.h?t.p.y+t.h:this.c.y;return c.distance(this.c,new c(s,e))<=this.r}project(t){let s=t.subtract(this.c).unitVector.scale(this.r);return c.sum(this.c,s)}at(t){let s=yt*t;return this.c.shift(this.r*Math.cos(s),this.r*Math.sin(s))}offset(t){return ri(t,this.c)/yt}contains(t){return c.distance(t,this.c)<=this.r}transform(t){let s=Math.abs(t[0][0])+Math.abs(t[1][1]);return new et(this.c.transform(t),this.r*s/2)}rotate(t,s=I){return y(t,0)?this:new et(this.c.rotate(t,s),this.r)}reflect(t){return new et(this.c.reflect(t),this.r)}scale(t,s=t){return new et(this.c.scale(t,s),this.r*(t+s)/2)}shift(t,s=t){return new et(this.c.shift(t,s),this.r)}translate(t){return this.shift(t.x,t.y)}equals(t,s){return y(this.r,t.r,s)&&this.c.equals(t.c,s)}toString(){return`circle(${this.c},${this.r})`}},Lt=class{constructor(t,s,e){this.c=t,this.start=s,this.angle=e,this.type="arc"}get circle(){return new et(this.c,this.radius)}get radius(){return c.distance(this.c,this.start)}get end(){return this.start.rotate(this.angle,this.c)}get startAngle(){return ri(this.start,this.c)}contract(t){return new this.constructor(this.c,this.at(t/2),this.angle*(1-t))}get minor(){return this.angle<=Math.PI?this:new this.constructor(this.c,this.end,yt-this.angle)}get major(){return this.angle>=Math.PI?this:new this.constructor(this.c,this.end,yt-this.angle)}get center(){return this.at(.5)}project(t){let s=this.startAngle,e=s+this.angle,i=ri(t,this.c);return e>yt&&i<e-yt&&(i+=yt),i=G(i,s,e),this.c.shift(this.radius,0).rotate(i,this.c)}at(t){return this.start.rotate(this.angle*t,this.c)}offset(t){return new pt(this.start,this.c,t).rad/this.angle}contains(t){return t.equals(this.project(t))}transform(t){return new this.constructor(this.c.transform(t),this.start.transform(t),this.angle)}rotate(t,s=I){return y(t,0)?this:new this.constructor(this.c.rotate(t,s),this.start.rotate(t,s),this.angle)}reflect(t){return new this.constructor(this.c.reflect(t),this.start.reflect(t),this.angle)}scale(t,s=t){return new this.constructor(this.c.scale(t,s),this.start.scale(t,s),this.angle)}shift(t,s=t){return new this.constructor(this.c.shift(t,s),this.start.shift(t,s),this.angle)}translate(t){return this.shift(t.x,t.y)}equals(){return!1}toString(){return`arc(${this.c},${this.start},${this.angle})`}},mo=class extends Lt{constructor(){super(...arguments),this.type="sector"}contains(t){return c.distance(t,this.c)<=this.radius&&new pt(this.start,this.c,t).rad<=this.angle}toString(){return`sector(${this.c},${this.start},${this.angle})`}},Ye=1e-6;function po(t,s,e){let i=(e.x-s.x)*(t.y-s.y),n=(e.y-s.y)*(t.x-s.x);return i-n>=-Ye}function Ch(t,s,e){let i=t.y-s.y,n=e.x-s.x,r=t.x-s.x,o=e.y-s.y,a=r*n+i*o;if(a<Ye)return!1;let h=n*n+o*o;return a-h<=-Ye}function Rh(t,s){return y(t.x,s.x)?y(t.y,s.y)?0:t.y<s.y?-1:1:t.x<s.x?-1:1}function kh(t){return t<=-Ye?-2:t<Ye?-1:t-1<=-Ye?0:t-1<Ye?1:2}function jd(t,s,e,i){let n=s.x-t.x,r=s.y-t.y,o=i.x-e.x,a=i.y-e.y,h=n*a-r*o;if(y(h,0))return!1;let l=t.x-e.x,p=t.y-e.y,f=(o*p-a*l)/h,m=(n*p-r*l)/h,g=new c(t.x+f*n,t.y+f*r);return{alongA:kh(f),alongB:kh(m),pt:g}}var vs=class{constructor(){this.root={root:!0,next:void 0}}exists(t){return t!==void 0&&t!==this.root}get head(){return this.root.next}insertBefore(t,s){let e=this.root,i=this.root.next;for(;i;){if(s(i)){t.prev=i.prev,t.next=i,i.prev.next=t,i.prev=t;return}e=i,i=i.next}e.next=t,t.prev=e,t.next=void 0}findTransition(t){let s=this.root,e=this.root.next;for(;e&&!t(e);)s=e,e=e.next;return{before:s===this.root?void 0:s,after:e,insert:i=>(i.prev=s,i.next=e,s.next=i,e&&(e.prev=i),i)}}static node(t){let s=t;return s.remove=()=>{s.prev&&(s.prev.next=s.next),s.next&&(s.next.prev=s.prev),s.prev=s.next=void 0},s}};function uo(t,s,e){let i={above:e.myFill.above,below:e.myFill.below};return{start:t,end:s,myFill:i}}function Ud(t,s,e,i,n,r){let o=Rh(s,n);return o!==0?o:c.equals(e,r)?0:t!==i?t?1:-1:po(e,i?n:r,i?r:n)?1:-1}function go(t,s,e){t.insertBefore(s,i=>Ud(!!s.isStart,s.pt,e,!!i.isStart,i.pt,i.other.pt)<0)}function Wd(t,s,e){let i=vs.node({isStart:!0,pt:s.start,seg:s,primary:e});return go(t,i,s.end),i}function Kd(t,s,e,i){let n=vs.node({pt:e.end,seg:e,primary:i,other:s});s.other=n,go(t,n,s.pt)}function Wi(t,s,e){let i=Wd(t,s,e);return Kd(t,i,s,e),i}function Xd(t,s,e){s.other.remove(),s.seg.end=e,s.other.pt=e,go(t,s.other,s.pt)}function he(t,s,e){let i=uo(e,s.seg.end,s.seg);return Xd(t,s,e),Wi(t,i,!!s.primary)}function Yd(t,s){let e=t.seg.start,i=t.seg.end,n=s.seg.start,r=s.seg.end;return c.colinear(e,n,r)?c.colinear(i,n,r)||po(i,n,r)?1:-1:po(e,n,r)?1:-1}function co(t,s,e){let i=s.seg,n=e.seg,r=i.start,o=i.end,a=n.start,h=n.end,l=jd(r,o,a,h);if(l===!1){if(!c.colinear(r,o,a)||c.equals(r,h)||c.equals(o,a))return!1;let p=c.equals(r,a),f=c.equals(o,h);if(p&&f)return e;let m=!p&&Ch(r,a,h),g=!f&&Ch(o,a,h);if(p)return g?he(t,e,o):he(t,s,h),e;m&&(f||(g?he(t,e,o):he(t,s,h)),he(t,e,r))}else l.alongA===0&&(l.alongB===-1?he(t,s,a):l.alongB===0?he(t,s,l.pt):l.alongB===1&&he(t,s,h)),l.alongB===0&&(l.alongA===-1?he(t,e,r):l.alongA===0?he(t,e,l.pt):l.alongA===1&&he(t,e,o));return!1}function Lh(t,s){var e,i;let n=new vs,r=[];for(;t.head;){let a=t.head;if(a.isStart){let h=function(){if(p){let g=co(t,a,p);if(g)return g}return f?co(t,a,f):!1};var o=h;let l=n.findTransition(g=>Yd(a,g.ev)>0),p=(e=l.before)==null?void 0:e.ev,f=(i=l.after)==null?void 0:i.ev,m=h();if(m&&(s?(!a.seg.myFill.below||a.seg.myFill.above!==a.seg.myFill.below)&&(m.seg.myFill.above=!m.seg.myFill.above):m.seg.otherFill=a.seg.myFill,a.other.remove(),a.remove()),t.head!==a)continue;if(s){let g=a.seg.myFill.below?a.seg.myFill.above!==a.seg.myFill.below:!0;a.seg.myFill.below=f?f.seg.myFill.above:!1,a.seg.myFill.above=g?!a.seg.myFill.below:a.seg.myFill.below}else if(a.seg.otherFill===void 0){let g=f?a.primary===f.primary?f.seg.otherFill.above:f.seg.myFill.above:!1;a.seg.otherFill={above:g,below:g}}a.other.status=l.insert(vs.node({ev:a}))}else{let h=a.status;if(h===void 0)throw new Error("[Euclid.js] Zero-length segment detected!");if(n.exists(h.prev)&&n.exists(h.next)&&co(t,h.prev.ev,h.next.ev),h.remove(),!a.primary){let l=a.seg.myFill;a.seg.myFill=a.seg.otherFill,a.seg.otherFill=l}r.push(a.seg)}t.head.remove()}return r}function Zd(t){let s=[],e=[];return t.forEach(i=>{let n=i.start,r=i.end;if(c.equals(n,r))return;let o={index:0,matchesHead:!1,matchesPt1:!1},a={index:0,matchesHead:!1,matchesPt1:!1},h=o;function l(u,v,b){h.index=u,h.matchesHead=v,h.matchesPt1=b;let E=h===o;return h=E?a:void 0,!E}for(let u=0;u<s.length;u++){let v=s[u],b=v[0],E=L(v);if(c.equals(b,n)){if(l(u,!0,!0))break}else if(c.equals(b,r)){if(l(u,!0,!1))break}else if(c.equals(E,n)){if(l(u,!1,!0))break}else if(c.equals(E,r)&&l(u,!1,!1))break}if(h===o){s.push([n,r]);return}if(h===a){let u=o.index,v=o.matchesPt1?r:n,b=o.matchesHead,E=s[u],M=b?E[0]:E[E.length-1],T=b?E[1]:E[E.length-2],F=b?E[E.length-1]:E[0],mt=b?E[E.length-2]:E[1];if(c.colinear(T,M,v)&&(b?E.shift():E.pop(),M=T),c.equals(F,v)){s.splice(u,1),c.colinear(mt,F,M)&&(b?E.pop():E.shift()),e.push(E);return}b?E.unshift(v):E.push(v);return}function p(u){s[u].reverse()}function f(u,v){let b=s[u],E=s[v],M=b[b.length-1],T=b[b.length-2],F=E[0],mt=E[1];c.colinear(T,M,F)&&(b.pop(),M=T),c.colinear(M,F,mt)&&E.shift(),s[u]=b.concat(E),s.splice(v,1)}let m=o.index,g=a.index,x=s[m].length<s[g].length;o.matchesHead?a.matchesHead?x?(p(m),f(m,g)):(p(g),f(g,m)):f(g,m):a.matchesHead?f(m,g):x?(p(m),f(g,m)):(p(g),f(m,g))}),e}function Qd(t,s){let e=[];for(let i of t){let n=(i.myFill.above?8:0)+(i.myFill.below?4:0)+(i.otherFill&&i.otherFill.above?2:0)+(i.otherFill&&i.otherFill.below?1:0);s[n]!==0&&e.push({start:i.start,end:i.end,myFill:{above:s[n]===1,below:s[n]===2}})}return e}function Ah(t){let s=new vs;for(let e of t)for(let i=0;i<e.length;i++){let n=i?e[i-1]:L(e),r=e[i],o=Rh(n,r);if(o===0)continue;let a=o<0?n:r,h=o<0?r:n;Wi(s,{start:a,end:h,myFill:{}},!0)}return Lh(s,!0)}function vo(t,s,e){let i=new vs;for(let r of Ah(t))Wi(i,uo(r.start,r.end,r),!0);for(let r of Ah(s))Wi(i,uo(r.start,r.end,r),!1);let n=Qd(Lh(i,!1),e);return Zd(n)}var Jd=[0,2,1,0,2,2,0,0,1,0,1,0,0,0,0,0],tu=[0,0,0,0,0,2,0,2,0,0,1,1,0,2,1,0],eu=[0,0,0,0,2,0,2,0,1,1,0,0,0,1,2,0];var su=(t,s)=>vo(t,s,Jd),iu=(t,s)=>vo(t,s,tu),nu=(t,s)=>vo(t,s,eu);function _t(t){return["polygon","polyline","rectangle","triangle"].includes(t.type)}function ws(t){return["polygon","triangle"].includes(t.type)}function Xi(t){return t.type==="polyline"}function wo(t){return t.type==="rectangle"}function ot(t){return["line","ray","segment"].includes(t.type)}function yo(t){return t.type==="line"}function xo(t){return t.type==="ray"}function le(t){return t.type==="segment"}function j(t){return t.type==="circle"}function ru(t){return t.type==="ellipse"}function Rt(t){return t.type==="arc"}function ge(t){return t.type==="sector"}function Nt(t){return t.type==="angle"}function it(t){return t.type==="point"}function ou(t,s){return y(t.p1.x,t.p2.x)?ct(s.y,t.p1.y,t.p2.y):ct(s.x,t.p1.x,t.p2.x)}function au(t,s){return y(t.p1.x,t.p2.x)?(s.y-t.p1.y)/(t.p2.y-t.p1.y)>0:(s.x-t.p1.x)/(t.p2.x-t.p1.x)>0}function hu(t,s){return ct(t.offset(s),0,1)}function lu(t,s){let e=t.p1.x-t.p2.x,i=t.p1.y-t.p2.y,n=s.p1.x-s.p2.x,r=s.p1.y-s.p2.y,o=e*r-i*n;if(y(o,0))return[];let a=t.p1.x*t.p2.y-t.p1.y*t.p2.x,h=s.p1.x*s.p2.y-s.p1.y*s.p2.x,l=a*n-e*h,p=a*r-i*h;return[new c(l/o,p/o)]}function cu(t,s){let e=c.distance(t.c,s.c);if(e>t.r+s.r)return[];if(e<Math.abs(t.r-s.r))return[];if(y(e,0)&&y(t.r,s.r))return[];if(y(e,t.r+s.r))return[new st(t.c,s.c).midpoint];let i=(jt(t.r)-jt(s.r)+jt(e))/(2*e),n=Math.sqrt(jt(t.r)-jt(i)),r=(s.c.x-t.c.x)*i/e+(s.c.y-t.c.y)*n/e+t.c.x,o=(s.c.y-t.c.y)*i/e-(s.c.x-t.c.x)*n/e+t.c.y,a=(s.c.x-t.c.x)*i/e-(s.c.y-t.c.y)*n/e+t.c.x,h=(s.c.y-t.c.y)*i/e+(s.c.x-t.c.x)*n/e+t.c.y;return[new c(r,o),new c(a,h)]}function Vh(t,s){let e=t.p2.x-t.p1.x,i=t.p2.y-t.p1.y,n=jt(e)+jt(i),r=s.c.x,o=s.c.y,a=(t.p1.x-r)*(t.p2.y-o)-(t.p2.x-r)*(t.p1.y-o),h=jt(s.r)*n-jt(a);if(h<0)return[];let l=a*i/n,p=-a*e/n;if(y(h,0))return[s.c.shift(l,p)];let f=e*(i<0?-1:1)*Math.sqrt(h)/n,m=Math.abs(i)*Math.sqrt(h)/n;return[s.c.shift(l+f,p+m),s.c.shift(l-f,p-m)]}function pu(t,s){let e=[],i=Rt(t)?t.circle:t,n=Rt(s)?s.circle:s;ot(t)&&ot(s)?e=lu(t,s):ot(i)&&j(n)?e=Vh(i,n):j(i)&&ot(n)?e=Vh(n,i):j(i)&&j(n)&&(e=cu(i,n));for(let r of[t,s])le(r)&&(e=e.filter(o=>ou(r,o))),xo(r)&&(e=e.filter(o=>au(r,o))),Rt(r)&&(e=e.filter(o=>hu(r,o)));return e}function Z(...t){if(t.length<2)return[];if(t.length>2)return Qt(uh(t,2).map(i=>Z(...i)));let[s,e]=t;if(Nt(s)&&(s=s.shape(!0)),Nt(e)&&(e=e.shape(!0)),_t(e)&&([s,e]=[e,s]),_t(s)){let i=ot(e)?s.points.filter(n=>e.contains(n)):[];for(let n of s.edges)i.push(...Z(n,e));return i}return pu(s,e)}var C=class{constructor(...t){this.type="polygon",this.points=t}get circumference(){if(this.points.length<=1)return 0;let t=c.distance(this.points[0],L(this.points));for(let s=1;s<this.points.length;++s)t+=c.distance(this.points[s-1],this.points[s]);return t}get signedArea(){let t=this.points,s=t.length,e=t[s-1].x*t[0].y-t[0].x*t[s-1].y;for(let i=1;i<s;++i)e+=t[i-1].x*t[i].y-t[i].x*t[i-1].y;return e/2}get area(){return Math.abs(this.signedArea)}get centroid(){let t=this.points,s=t.length,e=0;for(let n=0;n<s;++n)e+=t[n].x;let i=0;for(let n=0;n<s;++n)i+=t[n].y;return new c(e/s,i/s)}get edges(){let t=this.points.length,s=[];for(let e=0;e<t;++e)s.push(new X(this.points[e],this.points[(e+1)%t]));return s}get radius(){let t=this.centroid,s=this.points.map(e=>c.distance(e,t));return Math.max(...s)}get oriented(){if(this.signedArea>=0)return this;let t=[...this.points].reverse();return new this.constructor(...t)}cut(t){let s=this.radius/t.length*10,e=t.at(-s),i=t.at(s),n=t.perpendicularVector.scale(t.length*s),r=[e,i,i.add(n),e.add(n)],o=iu([this.points],[r]),a=nu([this.points],[r]);return[...o,...a].map(h=>new C(...h))}static collision(t,s){if(t.points.some(e=>s.contains(e))||s.points.some(e=>t.contains(e)))return!0;for(let e of t.edges)for(let i of s.edges)if(Z(e,i)[0])return!0;return!1}static union(...t){let[s,...e]=t;if(!e.length)return[s];let i=[s.points],n=e.length>1?C.union(...e).map(r=>r.points):[t[1].points];return su(i,n).map(r=>new C(...r))}static regular(t,s=1){let e=yt/t,i=Math.PI/2-e/2,n=H(r=>c.fromPolar(i+e*r,s),t);return new C(...n)}static interpolate(t,s,e=.5){let i=t.points.map((n,r)=>c.interpolate(n,s.points[r],e));return new C(...i)}static convexHull(...t){if(t.length<=3)return new C(...t);let s=t.sort((r,o)=>r.x!==o.x?r.x-o.x:r.y-o.y),e=s.slice(0).reverse(),i=[],n=[];for(let[r,o]of[[s,i],[e,n]]){for(let a of r){for(;o.length>=2;){let h=o[o.length-1],l=o[o.length-2];if((h.x-l.x)*(a.y-l.y)>=(a.x-l.x)*(h.y-l.y))o.pop();else break}o.push(a)}o.pop()}return new C(...i.concat(n))}contains(t){let s=!1;for(let e of this.edges){if(e.p1.equals(t)||e.contains(t))return!1;if(e.p1.y>t.y==e.p2.y>t.y)continue;let i=(e.p2.x-e.p1.x)/(e.p2.y-e.p1.y);t.x<i*(t.y-e.p1.y)+e.p1.x&&(s=!s)}return s}at(t){t<0&&(t+=Math.floor(t));let s=t*this.circumference,e=0;for(let i of this.edges){let n=i.length;if(e+n>s)return i.at((s-e)/n);e+=n}return this.points[0]}offset(t){let s=this.edges,e=Mh(t,this.edges)||[this.points[0],0],i=0;for(let n=0;n<e[1];++n)i+=s[n].length;return i+=s[e[1]].offset(t)*s[e[1]].length,i/this.circumference}project(t){let s=Mh(t,this.edges);return s?s[0]:this.points[0]}centerAt(t=I){return this.translate(t.subtract(this.centroid))}transform(t){return new this.constructor(...this.points.map(s=>s.transform(t)))}rotate(t,s=I){if(y(t,0))return this;let e=this.points.map(i=>i.rotate(t,s));return new this.constructor(...e)}reflect(t){let s=this.points.map(e=>e.reflect(t));return new this.constructor(...s)}scale(t,s=t){let e=this.points.map(i=>i.scale(t,s));return new this.constructor(...e)}shift(t,s=t){let e=this.points.map(i=>i.shift(t,s));return new this.constructor(...e)}translate(t){return this.shift(t.x,t.y)}equals(t,s,e){let i=this.points.length;if(i!==t.points.length)return!1;let n=e?this:this.oriented,r=e?t:t.oriented;for(let o=0;o<i;++o)if(n.points.every((a,h)=>a.equals(r.points[(h+o)%i],s)))return!0;return!1}toString(){return`polygon(${this.points.join(",")})`}},Wt=class extends C{constructor(){super(...arguments),this.type="polyline"}get circumference(){return this.length}get length(){let t=0;for(let s=1;s<this.points.length;++s)t+=c.distance(this.points[s-1],this.points[s]);return t}get edges(){let t=[];for(let s=0;s<this.points.length-1;++s)t.push(new X(this.points[s],this.points[s+1]));return t}toString(){return`polyline(${this.points.join(",")})`}},oi=class extends C{constructor(){super(...arguments),this.type="triangle"}get circumcircle(){let[t,s,e]=this.points,i=2*(t.x*(s.y-e.y)+s.x*(e.y-t.y)+e.x*(t.y-s.y)),n=(t.x**2+t.y**2)*(s.y-e.y)+(s.x**2+s.y**2)*(e.y-t.y)+(e.x**2+e.y**2)*(t.y-s.y),r=(t.x**2+t.y**2)*(e.x-s.x)+(s.x**2+s.y**2)*(t.x-e.x)+(e.x**2+e.y**2)*(s.x-t.x),o=new c(n/i,r/i),a=c.distance(o,this.points[0]);if(!(isNaN(a)||a>Number.MAX_SAFE_INTEGER))return new et(o,a)}get incircle(){let t=this.edges,s=t.map(p=>p.length),e=s[0]+s[1]+s[2],[i,n,r]=this.points,o=s[1]*i.x+s[2]*n.x+s[0]*r.x,a=s[1]*i.y+s[2]*n.y+s[0]*r.y,h=new c(o/e,a/e),l=h.distanceFromLine(t[0]);return isNaN(l)?void 0:new et(h,l)}get orthocenter(){let[t,s,e]=this.points,i=new st(t,s).perpendicular(e),n=new st(t,e).perpendicular(s);return Z(i,n)[0]}},du=180/Math.PI,uu=Math.PI/180;function Kt(t){return t*du}function Q(t){return t*uu}var pt=class{constructor(t,s,e){this.a=t,this.b=s,this.c=e,this.type="angle"}static fromDegrees(t){return pt.fromRadians(t*(Math.PI/180))}static fromRadians(t){let s=new c(1,0),e=s.rotate(t);return new pt(s,I,e)}static equals(t,s,e=Math.PI/360){return y(t.rad,s.rad,e)}get rad(){let t=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),e=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x)-t;return e<0&&(e+=yt),e}get deg(){return this.rad*180/Math.PI}get isRight(){return y(this.rad,Math.PI/2,Math.PI/360)}get bisector(){if(this.b.equals(this.a)||this.b.equals(this.c))return;let t=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),s=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x),e=(t+s)/2;t>s&&(e+=Math.PI);let i=Math.cos(e)+this.b.x,n=Math.sin(e)+this.b.y;return new st(this.b,new c(i,n))}get sup(){return this.rad<Math.PI?this:new pt(this.c,this.b,this.a)}get arc(){return new Lt(this.b,this.a,this.rad)}get radius(){return 24+20*(1-G(this.rad,0,Math.PI)/Math.PI)}shape(t=!0,s,e){if(this.a.equals(this.b)||this.c.equals(this.b))return new C(I);let i=this.isRight&&!e;s||(s=i?20:this.radius);let n=new X(this.b,this.a),r=n.at(s/n.length);if(i){let o=c.difference(this.c,this.b).unitVector.scale(s);return t?new C(this.b,r,r.add(o),this.b.add(o)):new Wt(r,r.add(o),this.b.add(o))}return t?new mo(this.b,r,this.rad):new Lt(this.b,r,this.rad)}project(t){return this.contains(t)?t:this.shape(!0).project(t)}at(){return this.c}offset(){return 0}contains(t){return this.shape(!0).contains(t)}transform(t){return new pt(this.a.transform(t),this.b.transform(t),this.c.transform(t))}rotate(t,s){return y(t,0)?this:new pt(this.a.rotate(t,s),this.b.rotate(t,s),this.c.rotate(t,s))}reflect(t){return new pt(this.a.reflect(t),this.b.reflect(t),this.c.reflect(t))}scale(t,s=t){return new pt(this.a.scale(t,s),this.b.scale(t,s),this.c.scale(t,s))}shift(t,s=t){return new pt(this.a.shift(t,s),this.b.shift(t,s),this.c.shift(t,s))}translate(t){return new pt(this.a.translate(t),this.b.translate(t),this.c.translate(t))}equals(t,s){return pt.equals(t,this,s)}toString(){return`angle(${this.a},${this.b},${this.c})`}},R=class{constructor(t,s=1,e=s){this.p=t,this.w=s,this.h=e,this.type="rectangle"}static aroundPoints(t){let s=1/0,e=-1/0,i=1/0,n=-1/0;for(let r of t)s=s<r.x?s:r.x,e=e>r.x?e:r.x,i=i<r.y?i:r.y,n=n>r.y?n:r.y;return new R(new c(s,i),e-s,n-i)}get center(){return new c(this.p.x+this.w/2,this.p.y+this.h/2)}get centroid(){return this.center}get circumference(){return 2*Math.abs(this.w)+2*Math.abs(this.h)}get area(){return Math.abs(this.w*this.h)}get edges(){return this.polygon.edges}get points(){return this.polygon.points}get polygon(){let t=new c(this.p.x+this.w,this.p.y),s=new c(this.p.x+this.w,this.p.y+this.h),e=new c(this.p.x,this.p.y+this.h);return new C(this.p,t,s,e)}collision(t){return this.p.x<t.p.x+t.w&&this.p.x+this.w>t.p.x&&this.p.y<t.p.y+t.h&&this.p.y+this.h>t.p.y}padding(t,s,e,i){return new R(this.p.shift(-i,-t),this.w+i+s,this.h+t+e)}contains(t,s){return ct(t.x,this.p.x,this.p.x+this.w,s)&&ct(t.y,this.p.y,this.p.y+this.h,s)}project(t){let s;for(let e of this.edges){let i=e.project(t);(!s||c.distance(t,i)<c.distance(t,s))&&(s=i)}return s}at(t){return this.polygon.at(t)}offset(t){return this.polygon.offset(t)}transform(t){return this.polygon.transform(t)}rotate(t,s=I){return y(t,0)?this:this.polygon.rotate(t,s)}reflect(t){return this.polygon.reflect(t)}scale(t,s=t){return new R(this.p.scale(t,s),this.w*t,this.h*s)}shift(t,s=t){return new R(this.p.shift(t,s),this.w,this.h)}translate(t){return this.shift(t.x,t.y)}equals(t){return!1}toString(){return`rectangle(${this.p},${this.w},${this.h})`}},ut=class{constructor(t,s,e,i){this.xMin=t,this.xMax=s,this.yMin=e,this.yMax=i}contains(t){return this.containsX(t)&&this.containsY(t)}containsX(t){return ct(t.x,this.xMin,this.xMax)}containsY(t){return ct(t.y,this.yMin,this.yMax)}resize(t,s){return new ut(this.xMin,this.xMax+t,this.yMin,this.yMax+s)}get dx(){return this.xMax-this.xMin}get dy(){return this.yMax-this.yMin}get xRange(){return[this.xMin,this.xMax]}get yRange(){return[this.yMin,this.yMax]}get rect(){return new R(new c(this.xMin,this.yMin),this.dx,this.dy)}get center(){return new c(this.xMin+this.dx/2,this.yMin+this.dy/2)}get flip(){return new ut(this.yMin,this.yMax,this.xMin,this.xMax)}};function bo(t,s,e={}){if(Nt(s))return bo(t,s.shape(!!e.fill),e);if(e.fill&&(t.fillStyle=e.fill),e.opacity&&(t.globalAlpha=e.opacity),e.stroke&&(t.strokeStyle=e.stroke,t.lineWidth=e.strokeWidth||1,e.lineCap&&(t.lineCap=e.lineCap),e.lineJoin&&(t.lineJoin=e.lineJoin)),t.beginPath(),le(s))t.moveTo(s.p1.x,s.p1.y),t.lineTo(s.p2.x,s.p2.y);else if(ot(s)){if(!e.box)return;let[i,n]=Z(s,e.box);if(xo(s)&&(n=s.p1),!i||!n)return;t.moveTo(i.x,i.y),t.lineTo(n.x,n.y)}else if(j(s))t.arc(s.c.x,s.c.y,s.r,0,yt);else if(_t(s)){let i=s.points;t.moveTo(i[0].x,i[0].y);for(let n of i.slice(1))t.lineTo(n.x,n.y);t.closePath()}else if(Xi(s)){t.moveTo(s.points[0].x,s.points[0].y);for(let i of s.points.slice(1))t.lineTo(i.x,i.y)}else ru(s)&&t.ellipse(s.c.x,s.c.y,s.a,s.b,s.angle,0,yt);e.fill&&t.fill(),e.stroke&&t.stroke()}function Ih(t,s,e){let n=s.x*(e.y-t.y)+t.x*(s.y-e.y)+e.x*(t.y-s.y)>0?1:0,r=c.distance(s,t);return[t.x,`${t.y}A${r}`,r,0,n,1,e.x,e.y].join(",")}function Ut(...t){return`M${t.map(s=>`${s.x},${s.y}`).join("L")}`}function Oh(t,s){let e=t.perpendicularVector.scale(6),i=t.unitVector.scale(3),n=t.midpoint;switch(s){case"bar":return Ut(n.add(e),n.add(e.inverse));case"bar2":return Ut(n.add(i).add(e),n.add(i).add(e.inverse))+Ut(n.add(i.inverse).add(e),n.add(i.inverse).add(e.inverse));case"arrow":return Ut(n.add(i.inverse).add(e),n.add(i),n.add(i.inverse).add(e.inverse));case"arrow2":return Ut(n.add(i.scale(-2)).add(e),n,n.add(i.scale(-2)).add(e.inverse))+Ut(n.add(e),n.add(i.scale(2)),n.add(e.inverse));default:return""}}function Ki(t,s){if(!t||!s)return"";let e=s.perpendicular,i=t.add(s.scale(9)).add(e.scale(9)),n=t.add(s.scale(9)).add(e.scale(-9));return Ut(i,t,n)}function fu(t,s){let e="";return _(s,"start","both")&&(e+=Ki(t.p1,t.unitVector)),_(s,"end","both")&&(e+=Ki(t.p2,t.unitVector.inverse)),e}function mu(t,s){let e="";if(_(s,"start","both")){let i=new st(t.c,t.start).perpendicularVector.inverse;e+=Ki(t.start,i)}if(_(s,"end","both")){let i=new st(t.c,t.end).perpendicularVector;e+=Ki(t.end,i)}return e}function ke(t,s={}){if(Nt(t)){let e=t.shape(!!s.fill,s.size,s.round);return ke(e,s)}if(le(t)){if(t.p1.equals(t.p2))return"";let e=Ut(t.p1,t.p2);return s.mark&&(e+=Oh(t,s.mark)),s.arrows&&(e+=fu(t,s.arrows)),e}if(xo(t)){if(!s.box)return"";let e=Z(t,s.box)[0];return e?Ut(t.p1,e):""}if(yo(t)){if(!s.box)return"";let e=Z(t,s.box);if(e.length<2)return"";let i=Ut(e[0],e[1]);return s.mark&&(i+=Oh(t,s.mark)),i}if(j(t))return`M ${t.c.x-t.r} ${t.c.y} a ${t.r},${t.r} 0 1 0 ${2*t.r} 0 a ${t.r} ${t.r} 0 1 0 ${-2*t.r} 0`;if(Rt(t)){let e=`M${Ih(t.start,t.c,t.end)}`;return s.arrows&&(e+=mu(t,s.arrows)),e}return ge(t)?`M ${t.c.x} ${t.c.y} L ${Ih(t.start,t.c,t.end)} Z`:Xi(t)?Ut(...t.points):ws(t)?`${Ut(...t.points)}Z`:wo(t)?`${Ut(...t.polygon.points)}Z`:""}var te=(t,s,e)=>new Promise((i,n)=>{var r=h=>{try{a(e.next(h))}catch(l){n(l)}},o=h=>{try{a(e.throw(h))}catch(l){n(l)}},a=h=>h.done?i(h.value):Promise.resolve(h.value).then(r,o);a((e=e.apply(t,s)).next())}),Yi="_M",ys=window.navigator.userAgent.toLowerCase(),gu=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i,_h=/iphone|ipad|ipod/i,vu=/^((?!chrome|android).)*safari/i,Nh,wu=class{constructor(){this.isMobile=gu.test(ys),this.isRetina=(window.devicePixelRatio||1)>1,this.isTouch=!!window.Touch||"ontouchstart"in window,this.isChrome=!!window.chrome,this.isFirefox=ys.indexOf("firefox")>=0,this.isAndroid=ys.indexOf("android")>=0,this.isIOS=_h.test(ys),this.isSafari=_h.test(ys)||vu.test(ys),this.loadQueue=[],this.loaded=!1,this.width=window.innerWidth,this.height=window.innerHeight,this.resizeCallbacks=[],this.theme={name:"light",isDark:!1},this.themeChangedCallbacks=[],this.themeOverride="",this.darkQuery=(Nh=window.matchMedia)==null?void 0:Nh.call(window,"(prefers-color-scheme: dark)");var t,s;window.onload=()=>this.afterLoad(),document.addEventListener("DOMContentLoaded",()=>this.afterLoad());let e=ue(()=>this.applyResize());window.addEventListener("resize",e);try{(t=this.darkQuery)==null||t.addEventListener("change",()=>this.applyThemeChange())}catch(n){(s=this.darkQuery)==null||s.addListener(()=>this.applyThemeChange())}let i=this.getCookie("theme");i&&this.setTheme(i);try{this.localStorage=window.localStorage}catch(n){console.warn("Unable to access Local Storage in this context.")}}afterLoad(){if(!this.loaded){this.loaded=!0;for(let t of this.loadQueue)t();setTimeout(()=>this.resize())}}ready(t){this.loaded?t():this.loadQueue.push(t)}redraw(){document.body.offsetHeight}applyResize(){let t=window.innerWidth,s=window.innerHeight;if(!(this.width===t&&this.height===s)){this.width=t,this.height=s;for(let e of this.resizeCallbacks)e({width:this.width,height:this.height});A.trigger("scroll",{top:A.scrollTop})}}onResize(t){t({width:this.width,height:this.height}),this.resizeCallbacks.push(t)}offResize(t){let s=this.resizeCallbacks.indexOf(t);s>=0&&this.resizeCallbacks.splice(s,1)}resize(){this.applyResize()}applyThemeChange(){let t=this.theme.name,s=t==="dark"||t==="auto"&&this.darkQuery.matches;if(s!==this.theme.isDark){this.theme.isDark=s;for(let e of this.themeChangedCallbacks)e(this.theme);setTimeout(()=>xt.setAttr("theme",this.themeOverride||(s?"dark":"light")))}}setTheme(t){t!==this.theme.name&&(this.theme.name=t,this.setCookie("theme",t),this.applyThemeChange())}onThemeChange(t){this.themeChangedCallbacks.push(t)}getHash(){return window.location.hash.slice(1)}setHash(t){let s=document.body.scrollTop;window.location.hash=t,document.body.scrollTop=s}setURL(t,s=""){window.history.replaceState({},s,t),s&&(window.document.title=s)}getCookies(){let t=document.cookie.split(";"),s={};for(let e=0,i=t.length;e<i;++e){let n=t[e].split("=");s[decodeURIComponent(n[0]).trim()]=decodeURIComponent(n[1])}return s}getCookie(t){let s=document.cookie.match(new RegExp(`(^|;) ?${t}=([^;]*)(;|$)`));return s?s[2]:void 0}setCookie(t,s,e=60*60*24*365){let i=window.location.hostname.replace(/^[a-z]{2}\./,"");document.cookie=`${t}=${s};path=/;max-age=${e};domain=${i}`}deleteCookie(t){this.setCookie(t,"",-1)}setStorage(t,s){var e,i;let n=(t||"").split("."),r=fe(((e=this.localStorage)==null?void 0:e.getItem(Yi))||void 0,{}),o=r;for(let a=0;a<n.length-1;++a)o[n[a]]===void 0&&(o[n[a]]={}),o=o[n[a]];o[n[n.length-1]]=s,(i=this.localStorage)==null||i.setItem(Yi,JSON.stringify(r))}getStorage(t){var s;let e=fe((s=this.localStorage)==null?void 0:s.getItem(Yi),{});if(!t)return e;let i=(t||"").split("."),n=i.pop();for(let r of i){if(!(r in e))return;e=e[r]}return e[n]}deleteStorage(t){var s;t?this.setStorage(t,void 0):(s=this.localStorage)==null||s.setItem(Yi,"")}getActiveInput(){let t=document.activeElement;return t!=null&&t.shadowRoot&&(t=t.shadowRoot.activeElement),t===document.body?void 0:k(t)}get formIsActive(){var t;return!!((t=this.getActiveInput())!=null&&t.is("input, textarea, [contenteditable]"))}},w=window.BoostBrowser||new wu;window.BoostBrowser=w;var yu=/\bTrident\/[567]\b|\bMSIE (?:9|10)\.0\b/,xu=/\bAppleWebKit\/(\d+)\b/,bu=/\bEdge\/12\.(\d+)\b/,$u=yu.test(navigator.userAgent)||+(navigator.userAgent.match(bu)||[])[1]<10547||+(navigator.userAgent.match(xu)||[])[1]<537,$o={};function Pu(){if(!$u)return;Array.from(document.querySelectorAll("svg > use")).forEach(function(s){let e=s.getAttribute("xlink:href"),[i,n]=e.split("#");if(!i.length||!n)return;let r=s.parentNode;r.removeChild(s),i in $o||($o[i]=fetch(i).then(a=>a.text())),$o[i].then(a=>{let h=document.implementation.createHTMLDocument("");h.documentElement.innerHTML=a;let p=h.getElementById(n).cloneNode(!0),f=document.createDocumentFragment();for(;p.childNodes.length;)f.appendChild(p.firstChild);r.appendChild(f)})})}var Eu=new Map(Object.entries({" ":"Space",Spacebar:"Space",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Down:"ArrowDown",Up:"ArrowUp"}));function li(t){return Eu.get(t.key)||t.key}function Hh(t){(t||document).addEventListener("keydown",s=>{if(li(s)==="Enter"||li(s)==="Space"){let e=w.getActiveInput();e&&e.hasAttr("tabindex")&&e.tagName!=="TEXTAREA"&&(s.preventDefault(),e.trigger("pointerdown",s),e.trigger("pointerstop",s),A.trigger("pointerstop",s),e.trigger("click",s))}})}var nn=!1;setTimeout(()=>nn=!0);var Tu="cubic-bezier(0.175, 0.885, 0.32, 1.275)",Su="cubic-bezier(0.68, -0.275, 0.825, 0.115)",Qe={cancel:()=>{},promise:Promise.resolve()};function dt(t,s){if(s===0)return t(1,0,()=>{}),Qe;let e=Date.now(),i=Ne(),n=0,r=!0,o=()=>{r=!1,i.reject()};function a(){r&&(!s||n<=s)&&window.requestAnimationFrame(a);let h=Date.now()-e;t(s?Math.min(1,h/s):h,h-n,o),s&&h>=s&&i.resolve(),n=h}return a(),{cancel:o,promise:i.promise}}function Zi(t,s=0,e=0){switch(t){case"quad":return s**2;case"cubic":return s**3;case"quart":return s**4;case"quint":return s**5;case"circ":return 1-Math.sqrt(1-s**2);case"sine":return 1-Math.cos(s*Math.PI/2);case"exp":return s<=0?0:Math.pow(2,10*(s-1));case"back":return e||(e=1.70158),s*s*((e+1)*s-e);case"elastic":return e||(e=.3),-Math.pow(2,10*(s-1))*Math.sin(((s-1)*2/e-.5)*Math.PI);case"swing":return .5-Math.cos(s*Math.PI)/2;case"spring":return 1-Math.cos(s*4.5*Math.PI)*Math.exp(-s*6);case"bounce":return s<1/11?1/64-7.5625*(.5/11-s)*(.5/11-s):s<3/11?1/16-7.5625*(2/11-s)*(2/11-s):s<7/11?1/4-7.5625*(5/11-s)*(5/11-s):1-7.5625*(1-s)*(1-s);default:return s}}function bt(t,s=0,e=0){if(s===0)return 0;if(s===1)return 1;let[i,n]=t.split("-");return n==="in"?Zi(i,s,e):n==="out"?1-Zi(i,1-s,e):s<=.5?Zi(i,2*s,e)/2:1-Zi(i,2*(1-s),e)/2}function Dt(t,s,e=400,i=0,n="ease-in-out"){if(!nn)return Object.keys(s).forEach(u=>{let v=s[u];t.css(u,Array.isArray(v)?v[1]:v)}),Qe;n==="bounce-in"&&(n=Tu),n==="bounce-out"&&(n=Su);let r="";w.isSafari&&(r=t._el.style.transition,t.css("transition","none"),w.redraw());let o=t._data.animation;o&&o.cancel();let a={},h={},l=Ne(),p=window.getComputedStyle(t._el);Object.keys(s).forEach(u=>{let v=s[u],b=qi(u);h[b]=Array.isArray(v)?v[0]:p.getPropertyValue(u),a[b]=Array.isArray(v)?v[1]:v,i&&t.css(u,h[b])});let f=a.height;if(a.height==="auto"){let u=t.children.filter(v=>v.css("position")!=="absolute");a.height=`${D(u.map(v=>v.outerHeight))}px`}let m,g=!1;oe(()=>{g||(m=t._el.animate([h,a],{duration:e,easing:n,fill:"forwards"}),m.onfinish=()=>{t._el&&Object.keys(s).forEach(u=>t.css(u,u==="height"?f:a[u])),w.isSafari&&t.css("transition",r),l.resolve(),m.cancel()})},i);let x={cancel(){g=!0,t._el&&Object.keys(s).forEach(u=>t.css(u,t.css(u))),m&&m.cancel()},promise:l.promise};return setTimeout(()=>t._data.animation=x),x}var Mu=/matrix\([0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,([0-9.\-\s]+),([0-9.\-\s]+)\)/;function Cu(t,s="fade",e=500,i=0){if(t.show(),!nn)return Qe;let n=+t.css("opacity")||1;if(s==="fade")return Dt(t,{opacity:[0,n]},e,i);if(s==="pop"){let r=t.transform.replace(/scale\([0-9.]*\)/,"").replace(Mu,"translate($1px,$2px)");return Dt(t,{opacity:[0,n]},e,i),Dt(t,{transform:[`${r} scale(0.5)`,`${r} scale(1)`]},e,i,"bounce-in")}else{if(s==="descend")return Dt(t,{opacity:[0,1],transform:["translateY(-50%)","none"]},e,i);if(s.startsWith("draw")){let r=t.strokeLength;t.css("stroke-dasharray",`${r}px`),t.css("opacity")||t.css("opacity",1);let o=s==="draw-reverse"?`${2*r}px`:0,a={"stroke-dashoffset":[`${r}px`,o]},h=Dt(t,a,e,i,"linear");return h.promise.then(()=>t.css("stroke-dasharray","")),h}else if(s.startsWith("slide")){let r={opacity:[0,n],transform:["translateY(50px)","none"]};return s.includes("down")&&(r.transform[0]="translateY(-50px)"),s.includes("right")&&(r.transform[0]="translateX(-50px)"),s.includes("left")&&(r.transform[0]="translateX(50px)"),Dt(t,r,e,i)}else if(s.startsWith("reveal")){let r={opacity:[0,n],height:[0,"auto"]};return s.includes("left")&&(r.transform=["translateX(-50%)","none"]),s.includes("right")&&(r.transform=["translateX(50%)","none"]),Dt(t,r,e,i)}}return Qe}function ku(t,s="fade",e=400,i=0,n=!1){if(!t._el)return Qe;if(!nn)return t.hide(),Qe;if(t.css("display")==="none")return Qe;let r;if(s==="fade")r=Dt(t,{opacity:[1,0]},e,i);else if(s==="pop"){let o=t.transform.replace(/scale\([0-9.]*\)/,"");Dt(t,{opacity:[1,0]},e,i),r=Dt(t,{transform:[`${o} scale(1)`,`${o} scale(0.5)`]},e,i,"bounce-out")}else if(s==="ascend")r=Dt(t,{opacity:[1,0],transform:["none","translateY(-50%)"]},e,i);else if(s.startsWith("draw")){let o=t.strokeLength;t.css("stroke-dasharray",o);let h={"stroke-dashoffset":[s==="draw-reverse"?`${2*o}px`:0,`${o}px`]};r=Dt(t,h,e,i,"linear")}else if(s.startsWith("slide")){let o={opacity:0,transform:"translateY(50px)"};s.includes("up")&&(o.transform="translateY(-50px)"),r=Dt(t,o,e,i)}else if(s.startsWith("reveal")){let o={opacity:0,height:0};s.includes("left")&&(o.transform="translateX(-50%)"),s.includes("right")&&(o.transform="translateX(50%)"),r=Dt(t,o,e,i)}return r.promise.then(()=>n?t.remove():t.hide()),r}var jh={"===":(t,s)=>t===s,"!==":(t,s)=>t!==s,"||":(t,s)=>t||s,"&&":(t,s)=>t&&s,"==":(t,s)=>t==s,"!=":(t,s)=>t!=s,"<=":(t,s)=>t<=s,">=":(t,s)=>t>=s,"**":(t,s)=>t**s,"<":(t,s)=>t<s,">":(t,s)=>t>s,"+":(t,s)=>t+s,"-":(t,s)=>t-s,"*":(t,s)=>t*s,"/":(t,s)=>t/s,"%":(t,s)=>t%s},Uh={"-":t=>-t,"+":t=>+t,"!":t=>!t},Dh={"||":1,"&&":2,"==":3,"!=":3,"===":3,"!==":3,"<":4,">":4,"<=":4,">=":4,"+":5,"-":5,"*":6,"/":6,"%":6,"**":7},Gh={true:!0,false:!1,undefined:void 0},Au=/\s/,Po=/[0-9]/,Eo=/[a-zA-Zα-ωΑ-Ω$_]/,Vu=/[0-9a-zA-Zα-ωΑ-Ω$_]/;function Iu(t){let s=t.length,e=0;function i(u){throw new Error(`${u} at character ${e} of "${t}"`)}function n(){for(;Au.test(t[e]);)e+=1}function r(){let u="";for(;Po.test(t[e]);)u+=t[e++];if(t[e]===".")for(u+=t[e++];Po.test(t[e]);)u+=t[e++];let v=t[e];if(v&&Eo.test(v)){let b=u+t[e];i(`Variable names cannot start with a number (${b})`)}else v==="."&&i("Unexpected period");return{type:5,value:parseFloat(u)}}function o(){let u=t[e];e+=1;let v=!1,b="";for(;e<s;){let E=t[e++];if(E===u){v=!0;break}b+=E}return v||i(`Unclosed quote after "${b}"`),{type:5,value:b}}function a(){let u=t[e];for(Eo.test(t[e])||i(`Unexpected ${u}`),e+=1;e<s&&Vu.test(t[e]);)u+=t[e++];return u in Gh?{type:5,value:Gh[u]}:{type:4,name:u}}function h(u){let v=[],b=!1,E;for(;e<s;)if(t[e]===u){E&&v.push(E),b=!0,e+=1;break}else t[e]===","?(v.push(E||{type:5,value:void 0}),e+=1):E=g();return b||i(`Expected ${u}`),v}function l(){let u;if(t[e]==="("){if(e+=1,u=g(),n(),t[e]===")")return e+=1,u;i("Unclosed (")}else u=a();for(n();".[(".includes(t[e]);)t[e]==="."?(e++,n(),u={type:6,object:u,computed:!1,property:a()}):t[e]==="["?(e++,u={type:6,object:u,computed:!0,property:g()},n(),t[e]!=="]"&&i("Unclosed ["),e++):t[e]==="("&&(e++,u={type:2,args:h(")"),callee:u}),n();return u}function p(){n();for(let u of[3,2,1]){let v=t.substr(e,u);if(v in jh)return e+=u,v}}function f(){n();let u=t[e];if(Po.test(u)||u===".")return r();if(u==="'"||u==='"')return o();if(u==="[")return e+=1,{type:0,elements:h("]")};if(u in Uh)return e+=1,{type:7,operator:u,argument:f()};if(Eo.test(u)||u==="(")return l();i("Expression parsing error")}function m(){let u=f(),v=p();if(!v)return u;let b=f();b||i(`Expected expression after ${v}`);let E,M=[u,v,b];for(;v=p();){let F=Dh[v],mt=v;for(;M.length>2&&F<=Dh[M[M.length-2]];)b=M.pop(),v=M.pop(),u=M.pop(),E={type:1,operator:v,left:u,right:b},M.push(E);E=f(),E||i(`Expected expression after ${mt}`),M.push(mt,E)}let T=M.length-1;for(E=M[T];T>1;)E={type:1,operator:M[T-1],left:M[T-2],right:E},T-=2;return E}function g(){let u=m();if(n(),u&&t[e]==="?"){e+=1;let v=g();if(v||i("Expected expression"),n(),t[e]===":"){e++;let b=g();return b||i("Expected expression"),{type:3,test:u,consequent:v,alternate:b}}else i("Expected :")}else return u}let x=g();return e<t.length&&i(`Unexpected "${t[e]}"`),x}var Qi=[void 0,void 0];function Jt(t,s,e){switch(t.type){case 0:let i=t.elements.map(x=>Jt(x,s,e)[0]);return i.some(x=>x===void 0)?Qi:[i,void 0];case 1:let n=Jt(t.left,s,e)[0],r=Jt(t.right,s,e)[0];return"+-**/%".includes(t.operator)&&(n===void 0||r===void 0)?Qi:[jh[t.operator](n,r),void 0];case 2:let[o,a]=Jt(t.callee,s,e),h=t.args.map(x=>Jt(x,s,e)[0]);return h.some(x=>x===void 0)||typeof o!="function"?Qi:[o.apply(a,h),void 0];case 3:let l=Jt(t.consequent,s,e),p=Jt(t.alternate,s,e);return Jt(t.test,s,e)[0]?l:p;case 4:return[e[t.name]||s[t.name],void 0];case 5:return[t.value,void 0];case 6:let f=Jt(t.object,s,e)[0],m=t.computed?Jt(t.property,s,e)[0]:t.property.name;return f?[f[m],f]:[void 0,void 0];case 7:let g=Jt(t.argument,s,e)[0];return g===void 0&&t.operator!=="!"?Qi:[Uh[t.operator](g),void 0]}}function at(t){let s=Iu(t);return s?(e={},i={})=>Jt(s,e,i)[0]:(e={})=>{}}var Ou=/\${([^}]+)}/g;function tn(t){let s=t.split(Ou),e=s.map((i,n)=>n%2?at(i.replace(/×/g,"*")):void 0);return i=>s.map((n,r)=>{if(!(r%2))return n;let o=e[r](i);return typeof o=="number"&&o<0?`\u2013${-o}`:o}).join("")}var ai="ontouchstart"in window,xs="onpointerdown"in window;function Ct(t){if(t.touches){let s=t.targetTouches.length?t.targetTouches:t.changedTouches;return new c(s[0].clientX,s[0].clientY)}else return new c(t.clientX||0,t.clientY||0)}function Ru(t){return t.touches||[]}function ee(t,s){return Ct(t).transform(s.inverseTransformMatrix)}function Wh(t,s){let e=Ct(t),i=s.bounds,n=(e.x-i.left)*s.canvasWidth/i.width,r=(e.y-i.top)*s.canvasHeight/i.height;return new c(n,r)}function Lu(t){if(t instanceof PointerEvent&&t.pointerType==="mouse")return k(t.target);let s=Ct(t);return k(document.elementFromPoint(s.x,s.y)||void 0)}function _u(t){if(t._data.tapEvent)return;t._data.tapEvent=!0;let s;t.on("pointerdown",e=>s=Ct(e)),t.on("pointerup",e=>{if(!s)return;let i=Ct(e);c.distance(s,i)<6&&t.trigger("tap",e),s=void 0}),t.on("pointercancel",()=>s=void 0)}function Nu(t){t._data.clickOutsideEvent||(t._data.clickOutsideEvent=!0,A.on("pointerdown",s=>{var e,i;let n=s.target,r=(i=(e=t._el).getRootNode)==null?void 0:i.call(e),o=Ct(s);r!=null&&r.host&&(n=r.elementFromPoint(o.x,o.y)),!(!n||t._el===n||t._el.contains(n))&&t.trigger("clickOutside",s)}))}function Je(t,s){let e=s.$box||t,i=Ct;e.type==="svg"?i=m=>ee(m,e.$ownerSVG):e.type==="canvas"&&(i=m=>Wh(m,e));let n=s.justInside?t:A,r,o,a=!1,h=0;t.css("touch-action")==="auto"&&t.css("touch-action","none"),t.addClass("noselect");function l(m){m.handled||Ru(m).length>1||(m.preventDefault(),a=!1,h=m.pointerId||0,n.on("pointermove",p),n.on("pointerstop",f),r=o=i(m),s.down&&s.down(r))}function p(m){if(!r||h&&m.pointerId!==h)return;m.preventDefault();let g=i(m);c.distance(g,o)<.5||(!a&&s.start&&s.start(r),s.move&&s.move(g,r,o),o=g,a=!0)}function f(m,g=!1){!r||h&&m.pointerId!==h||(m.preventDefault(),n.off("pointermove",p),n.off("pointerstop",f),s.up&&s.up(o,r),a&&s.end&&s.end(o,r),!a&&s.click&&!g&&s.click(r),r=void 0)}A.onKey("Escape",()=>{if(!r)return;a&&s.move&&s.move(r,r,o),o=r;let m=document.createEvent("MouseEvent");m.pointerId=h,f(m,!0)}),t.on("pointerdown",l),s.justInside&&t.on("mouseleave",f),s.accessible&&(t.setAttr("tabindex","0"),document.addEventListener("keydown",m=>{if(![37,38,39,40].includes(m.keyCode)||t!==w.getActiveInput())return;let g=t.boxCenter,x=i({clientX:g.x,clientY:g.y}),u=m.keyCode===37?-25:m.keyCode===39?25:0,v=m.keyCode===38?-25:m.keyCode===40?25:0,b=x.shift(u,v);s.down&&s.down(x),s.start&&s.start(x),s.move&&s.move(b,x,x),s.end&&s.end(b,x)}))}function Kh(t,s){let e=Ct;t.type==="svg"?e=n=>ee(n,t.$ownerSVG):t.type==="canvas"&&(e=n=>Wh(n,t));let i=!1;t.on("touchstart mouseenter",n=>{!i&&s.enter&&s.enter(),s.move&&s.move(e(n)),i=!0},{passive:!0}),t.on("pointermove",n=>{i&&s.move&&s.move(e(n))}),t.on("touchend mouseleave",()=>{i&&s.exit&&s.exit(),i=!1},{passive:!0})}function Du(t){if(t._data.scrollEvents)return;t._data.scrollEvents=!0;let s=!1,e;function i(){let h=t.scrollTop;if(h===e){s=!1;return}e=h,t.trigger("scroll",{top:e}),window.requestAnimationFrame(i)}function n(){s||window.requestAnimationFrame(i),s=!0}(t.type==="window"?window:t._el).addEventListener("scroll",n);function o(){window.addEventListener("touchmove",n),window.addEventListener("touchend",a)}function a(){window.removeEventListener("touchmove",n),window.removeEventListener("touchend",a)}t._el.addEventListener("touchstart",function(h){h.handled||o()})}function bs(t,s){let e=s.$clickTarget||t,i=0,n=!1,r=!1,o=!1;function a(){n||(s.enter&&s.enter(),n=!0)}function h(){!n||(clearTimeout(i),s.exit&&s.exit(),n=!1)}t.on("mouseover",()=>{s.preventMouseover&&s.preventMouseover()||(clearTimeout(i),i=oe(()=>{a(),r=!0},s.delay))}),t.on("mouseout",()=>{!r||(clearTimeout(i),i=oe(h,s.exitDelay||s.delay))}),e.on("focus",()=>{n||s.preventMouseover&&s.preventMouseover()||(clearTimeout(i),a(),o=!0)});let l=()=>{!o||(s.canFocusWithin?setTimeout(()=>{let p=w.getActiveInput();p&&p.hasParent(t)?p.one("blur",l):h()}):h())};e.on("blur",l),e.on("click",()=>{n&&!r?h():n||(a(),r=!1)}),t.on("clickOutside",h)}var To;function Gu(t){for(let s of t){let e=s.isIntersecting?"enterViewport":"exitViewport";setTimeout(()=>k(s.target).trigger(e))}}function Bh(t){if(!t._data.intersectionEvents){if(t._data.intersectionEvents=!0,!window.IntersectionObserver){let s=!1;A.on("scroll",()=>{let e=t.isInViewport;s&&!e?(t.trigger("exitViewport"),s=!1):e&&!s&&(t.trigger("enterViewport"),s=!0)});return}To||(To=new IntersectionObserver(Gu)),To.observe(t._el)}}function Bu(t,s=!1){if(s&&(t._data.resizeObserver&&t._data.resizeObserver.disconnect(),t._data.resizeObserver=void 0),!t._data.resizeObserver){if(window.ResizeObserver){let e=new window.ResizeObserver(()=>t.trigger("resize"));e.observe(t._el),t._data.resizeObserver=e}else if(window.MutationObserver){let e=new MutationObserver(()=>t.trigger("resize"));e.observe(t._el,{attributes:!0,childList:!0,characterData:!0,subtree:!0}),t._data.resizeObserver=e}}}function qh(t){if(t._data.pointerPositionEvents)return;t._data.pointerPositionEvents=!0;let s=t.parent,e;s.on("pointerend",()=>e=void 0),s.on("pointermove",i=>{let n=e,r=Lu(i);e=r.equals(t)||r.hasParent(t),n!==void 0&&e&&!n&&t.trigger("pointerenter",i),!e&&n&&t.trigger("pointerleave",i)})}function So(t,s){s._data[`_${t}`]||(s._data[`_${t}`]=!0,xs?s.on(t.replace("mouse","pointer"),e=>{e.pointerType==="mouse"&&s.trigger(t,e)}):ai||s._el.addEventListener(t,e=>s.trigger(t,e)))}function qu(t){t.on("keydown",s=>{if(s.metaKey||s.ctrlKey||w.isAndroid&&s.keyCode===229)return;let e=s.key||String.fromCharCode(s.which),i=e.toLowerCase(),n=!!s.shiftKey;t.trigger("key",{code:s.keyCode,key:i,char:e,shift:n})}),w.isAndroid&&t.type==="input"&&t.on("input",s=>{let e=s.data[s.data.length-1],i=e.toLowerCase();t.trigger("key",{code:void 0,key:i,char:e}),t.value=""})}var en={scrollwheel:"DOMMouseScroll mousewheel",pointerdown:xs?"pointerdown":ai?"touchstart":"mousedown",pointermove:xs?"pointermove":ai?"touchmove":"mousemove",pointerup:xs?"pointerup":ai?"touchend":"mouseup",pointercancel:xs?"pointercancel":"touchcancel",pointerstop:xs?"pointerup pointercancel":ai?"touchend touchcancel":"mouseup"},sn={scroll:Du,tap:_u,clickOutside:Nu,key:qu,mousedown:So.bind(void 0,"mousedown"),mousemove:So.bind(void 0,"mousemove"),mouseup:So.bind(void 0,"mouseup"),pointerenter:qh,pointerleave:qh,enterViewport:Bh,exitViewport:Bh,resize:Bu};function zu(t,s,e,i){if(s in sn)sn[s](t,!1);else if(s in en){let n=K(en[s]);for(let r of n)t._el.addEventListener(r,e,i)}else t._el.addEventListener(s,e,i)}function Fu(t,s,e){if(s in sn)(!t._events[s]||!t._events[s].length)&&sn[s](t,!0);else if(e&&s in en){let i=K(en[s]);for(let n of i)t._el.removeEventListener(n,e)}else e&&t._el.removeEventListener(s,e)}var Ji=0,Mo=new Map;function zh(t,s){Mo.set(t,s)}function Hu(t){if(Ji++,t(),Ji--,Ji===0){for(let[s,e]of Mo.entries())s(e);Mo.clear()}}function Ht(t,s){let e=new Map,i=new Map,n=new Set,r,o=0;function a(M){r=M;let T=M(E,!0);return r=void 0,T}function h(M){for(let T of e.values())T.has(M)&&T.delete(M);n.delete(M)}function l(M,T){return n.add(M),T?void 0:M(E,!0)}function p(M,T){i.has(M)&&h(i.get(M));let F=()=>{t[M]=T(E),r===F&&(r=void 0),f(M)};i.set(M,F),a(F)}function f(M){if(Ji>0){for(let T of e.get(M)||[])zh(T,t);for(let T of n)zh(T,t)}else{for(let T of e.get(M)||[])T(t);for(let T of n)T(t)}}function m(){for(let M of e.values())for(let T of M)T(t);for(let M of n)M(t)}function g(M,T){T&&(t={}),Hu(()=>{for(let[F,mt]of Object.entries(M))E[F]=mt})}function x(){for(o+=1;`_x${o}`in t;)o+=1;return`_x${o}`}function u(){t={},e.clear(),i.clear(),o=0}function v(){return Object.assign({},t)}function b(M){!s||s.watch(()=>E[M]=s[M])}let E=new Proxy(t,{get(M,T){return T==="watch"?a:T==="unwatch"?h:T==="watchAll"?l:T==="setComputed"?p:T==="forceUpdate"?m:T==="assign"?g:T==="getKey"?x:T==="clear"?u:T==="copy"?v:T==="_internal"?[t,e]:(r&&(e.has(T)||e.set(T,new Set),e.get(T).add(r)),T in t||b(T),t[T])},set(M,T,F){return t[T]===F||(t[T]=F,i.has(T)&&(h(i.get(T)),i.delete(T)),f(T)),!0},deleteProperty(M,T){return delete t[T],e.delete(T),i.delete(T),!0}});return E}var ju={A:7,C:6,H:1,L:2,M:2,Q:4,S:4,T:2,V:1,Z:0},Uu=/[astvzqmhlc]([^astvzqmhlc]*)/ig,Wu=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function rn(t){let s=[],e;for(let i of t.match(Uu)||[]){let n=i[0].toUpperCase();if(n==="Z"){s.push({type:"Z",points:[]});continue}let r=(i.slice(1).match(Wu)||[]).map(a=>+a),o=n===i[0];for(let[a,h]of to(r,ju[n]).entries()){let l=[],p=n==="M"&&a>0?"L":n,f;n==="H"?(p="L",l=[new c(h[0],o&&(e==null?void 0:e.y)||0)]):n==="V"?(p="L",l=[new c(o&&(e==null?void 0:e.x)||0,h[0])]):n==="A"?(p="A",l=[new c(h[5],h[6])],f=h.slice(0,5)):"MLCSQT".includes(n)&&(l=to(h,2).map(m=>new c(m[0],m[1]))),!o&&e&&(l=l.map(m=>m.translate(e))),e=L(l),s.push({type:p,points:l,options:f})}}return s}function Co(t){return t?rn(t).map(e=>L(e.points)).filter(e=>!!e):[]}var Ku=["font-family","font-size","font-style","font-weight","letter-spacing","text-decoration","color","display","visibility","alignment-baseline","baseline-shift","opacity","text-anchor","clip","clip-path","clip-rule","mask","filter","transform","transform-origin","white-space","line-height"],Xu=["fill","fill-rule","marker","marker-start","marker-mid","marker-end","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-width","text-rendering","dominant-baseline","transform-box","paint-order"],Yu=["padding","min-width","max-width","height","border-width","border-style","border-color","box-sizing","background","width","grid-template-columns","text-align"],Zu=["class","tabindex","contenteditable"],Qu=new Set(["opacity","transform-box","transform-origin","border-width","border-style","border-color"]),Ju={"font-style":"normal","font-weight":"400","letter-spacing":"normal","text-decoration":"none",display:"block",visibility:"visible","alignment-baseline":"auto","baseline-shift":"0px","text-anchor":"start",clip:"auto","clip-path":"none","clip-rule":"nonzero",mask:"none",opacity:"1",filter:"none",fill:"rgb(0, 0, 0)","fill-rule":"nonzero",marker:"none",stroke:"none","stroke-dasharray":"none","stroke-dashoffset":"0px","stroke-linecap":"butt","stroke-linejoin":"miter","stroke-width":"1px","text-rendering":"auto",transform:"none","dominant-baseline":"auto","transform-origin":"0px 0px","transform-box":"view-box","paint-order":"normal"};function Xh(t){var s,e;if(t.getAttribute("hidden")||t.style.opacity==="0"||t.style.display==="none")(s=t.parentNode)==null||s.removeChild(t);else{for(let i of Array.from(t.children))Xh(i);if(t.tagName==="g"&&t.childElementCount===0)(e=t.parentNode)==null||e.removeChild(t);else for(let i of Zu)t.hasAttribute(i)&&t.removeAttribute(i)}}function tf(t,s){let e=t.parentElement;for(;e;){let i=e.style.getPropertyValue(s);if(i)return i;e=e.parentElement}}function Yh(t,s,e=!1){let i=window.getComputedStyle(t);s.removeAttribute("style");let n=e||t.tagName==="foreignObject",r=[...Ku,...n?Yu:Xu];for(let h of r){let l=i.getPropertyValue(h),p=tf(s,h);l===Ju[h]&&!p||!Qu.has(h)&&l===p||s.style.setProperty(h,l)}let o=t.children,a=s.children;for(let h=0;h<a.length;++h)Yh(o[h],a[h],n)}var Zh=class{constructor(t){this._el=t,this._data={},this._events={},this.type="default",t._view=this}get id(){return this._el.id}get data(){return this._el.dataset}get tagName(){return this._el.tagName.toUpperCase()}equals(t){return this._el===t._el}addClass(t){for(let s of K(t))this._el.classList.add(s)}removeClass(t){for(let s of K(t))this._el.classList.remove(s)}hasClass(t){return this._el.classList.contains(t)}toggleClass(t){return this._el.classList.toggle(t)}setClass(t,s){s?this.addClass(t):this.removeClass(t)}attr(t){return this._el.getAttribute(t)||""}hasAttr(t){return this._el.hasAttribute(t)}setAttr(t,s){s===void 0?this.removeAttr(t):this._el.setAttribute(t,s.toString())}removeAttr(t){this._el.removeAttribute(t)}get attributes(){return Array.from(this._el.attributes||[])}get html(){return this._el.innerHTML||""}set html(t){this._el.innerHTML=t}get text(){return this._el.textContent||""}set text(t){this._el.textContent=t}set textStr(t){this._el.textContent=`${t}`}blur(){this._el.blur()}focus(){this._el.focus()}getParentModel(){let t=this.parent;return t?t.model||t.getParentModel():void 0}bindModel(t,s=!0){var e;if(!this.model){if(this.model=t,this.hasAttr(":for"))return this.makeDynamicList(t);for(let{name:i,value:n}of this.attributes)this.makeDynamicAttribute(i,n,t);for(let i of this.childNodes)if(i instanceof Text){if((e=i.textContent)!=null&&e.includes("${")){let n=tn(i.textContent);t.watch(()=>i.textContent=n(t)||"")}}else s&&i.bindModel(t)}}bindVariable(t,s){}toggleDOM(t=!0){t!==!!this._el.parentNode&&(this.$placeholder||(this.$placeholder=k(document.createComment("")),this.insertBefore(this.$placeholder)),t?this.$placeholder.insertBefore(this):this.detach())}makeDynamicAttribute(t,s,e){if(t.startsWith("@")){let i=t.slice(1),n=at(s);this.on(i,r=>n(e,{$event:r}))}else if(t===":show"){let i=at(s);e.watch(()=>this.toggle(!!i(e)))}else if(t===":if"){let i=at(s);e.watch(()=>this.toggleDOM(!!i(e)))}else if(t===":html"){let i=at(s);e.watch(()=>this.html=i(e)||"")}else if(t===":draw"){let i=at(s);e.watch(()=>this.draw(i(e)))}else if(t===":class"){let i=at(s),n=`${this.attr("class")} `;e.watch(()=>this.setAttr("class",n+i(e)))}else if(t===":bind")this.bindVariable(e,s);else if(t.startsWith(":")){let i=at(s),n=t.slice(1);e.watch(()=>this.setAttr(n,i(e)))}else if(s.includes("${")){let i=tn(s);e.watch(()=>this.setAttr(t,i(e)||""))}(t.startsWith("@")||t.startsWith(":"))&&this.removeAttr(t)}makeDynamicList(t){let[s,e]=this.attr(":for").split(" in ");this.removeAttr(":for");let i=at(e),n=k(document.createComment(""));this.insertBefore(n),this.detach();let r=[],o=0;t.watch(()=>{let a=i(t);Array.isArray(a)||(a=[]);for(let h=a.length;h<o;++h)r[h].detach();for(let h=o;h<r.length;++h)n.insertBefore(r[h]);for(let h=r.length;h<a.length;++h){let l=this.copy(!0);l.bindModel(Ht({[s]:void 0},t)),n.insertBefore(l),r.push(l)}o=a.length;for(let h=0;h<o;++h)r[h].model[s]=a[h]})}get bounds(){return this._el.getBoundingClientRect()}get boundsRect(){let t=this.bounds;return new R(new c(t.x,t.y),t.width,t.height)}contains(t){return this.boundsRect.contains(t)}get isInViewport(){if(this.height===0)return!1;let t=this.bounds;return ct(t.top,-t.height,w.height)}get topLeftPosition(){let t=this.bounds;return new c(t.left,t.top)}get boxCenter(){let t=this.bounds;return new c(t.left+t.width/2,t.top+t.height/2)}get scrollWidth(){return this._el.scrollWidth}get scrollHeight(){return this._el.scrollHeight}get scrollTop(){return this._el.scrollTop}set scrollTop(t){this._el.scrollTop=t,this.trigger("scroll",{top:t,left:this.scrollLeft})}get scrollLeft(){return this._el.scrollLeft}set scrollLeft(t){this._el.scrollLeft=t,this.trigger("scroll",{top:this.scrollTop,left:t})}scrollTo(t,s=1e3,e="cubic"){t<0&&(t=0);let i=this.scrollTop,n=t-i;this._data.scrollAnimation&&this._data.scrollAnimation.cancel(),this._data.scrollAnimation=dt(r=>{let o=i+n*bt(e,r);this.scrollTop=o,this.trigger("scroll",{top:o})},s)}scrollBy(t,s=1e3,e="cubic"){!t||this.scrollTo(this.scrollTop+t,s,e)}css(t,s){if(s===void 0){if(typeof t=="string")return window.getComputedStyle(this._el).getPropertyValue(t);{let e=Object.keys(t);for(let i of e)this._el.style.setProperty(i,`${t[i]}`)}}else typeof t=="string"&&this._el.style.setProperty(t,`${s}`)}get transform(){return this.css("transform").replace("none","")}get transformMatrix(){let t=this.transform;if(!t)return[[1,0,0],[0,1,0]];let s=t.match(/matrix\(([0-9,.\s-]*)\)/);if(!s||!s[1])return[[1,0,0],[0,1,0]];let e=s[1].split(",");return[[+e[0],+e[2],+e[4]],[+e[1],+e[3],+e[5]]]}get scale(){let t=this.transformMatrix;return[t[0][0],t[1][1]]}setTransform(t,s=0,e=1){let i="";t&&(i+=`translate(${vt(t.x,.1)}px,${vt(t.y,.1)}px)`),s&&(i+=` rotate(${s}rad)`),e&&(i+=` scale(${e})`),this._el.style.transform=i}translate(t,s){this.setTransform(new c(t,s))}show(){this.hasAttr("hidden")&&this.removeAttr("hidden"),this.data.display==="visibility"?this._el.style.visibility="visible":this._el.style.display=this.data.display||"block"}hide(){this.data.display==="visibility"?this._el.style.visibility="hidden":this._el.style.display="none"}toggle(t){t?this.show():this.hide()}is(t){return this._el.matches?this._el.matches(t):Array.from(document.querySelectorAll(t)).includes(this._el)}index(){let t=0,s=this._el;for(;(s=s.previousSibling||void 0)!==void 0;)++t;return t}prepend(t){let s=this._el.childNodes;s.length?this._el.insertBefore(t._el,s[0]):this._el.appendChild(t._el)}append(t){this._el.appendChild(t instanceof Text?t:t._el)}insertBefore(t){this.parent._el.insertBefore(t._el,this._el)}insertAfter(t){let s=this._el.nextSibling;s?this.parent._el.insertBefore(t._el,s):this.parent._el.appendChild(t._el)}get next(){return k(this._el.nextSibling)}get prev(){return k(this._el.previousSibling)}$(t){return k(t,this)}$$(t){return ve(t,this)}get parent(){return k(this._el.parentElement||void 0)}parents(t){let s=[],e=this.parent;for(;e;)(!t||e.is(t))&&s.push(e),e=e.parent;return s}hasParent(...t){let s=t.map(i=>i._el),e=this._el.parentNode;for(;e;){if(_(e,...s))return!0;e=e.parentNode}return!1}get children(){return Array.from(this._el.children||[],t=>k(t))}get childNodes(){return Array.from(this._el.childNodes,t=>{if(!(t instanceof Comment))return t instanceof Text?t:k(t)}).filter(t=>t)}restartAnimation(){let t=this.next,s=this.parent;this.detach(),t?t.insertBefore(this):s.append(this)}detach(){this._el&&this._el.parentNode&&this._el.parentNode.removeChild(this._el)}remove(){this.detach()}removeChildren(){for(;this._el.firstChild;)this._el.removeChild(this._el.firstChild)}copy(t=!0){return k(this._el.cloneNode(t))}on(t,s,e){for(let i of K(t))i in this._events?this._events[i].includes(s)||this._events[i].push(s):this._events[i]=[s],zu(this,i,s,e)}one(t,s,e){let i=n=>{this.off(t,i),s(n)};this.on(t,i,e)}off(t,s){for(let e of K(t))e in this._events&&(this._events[e]=s?this._events[e].filter(i=>i!==s):[]),Fu(this,e,s)}trigger(t,s={}){for(let e of K(t)){if(!this._events[e])return;for(let i of this._events[e])i.call(this,s)}}onKey(t,s,e){t=t.replace("AllArrows","ArrowUp ArrowDown ArrowLeft ArrowRight");let i=new Set(K(t)),n=e!=null&&e.up?"keyup":"keydown";(this._el===document.body?document:this._el).addEventListener(n,o=>{let a=li(o);(e!=null&&e.meta?!o.ctrlKey&&!o.metaKey:o.ctrlKey||o.metaKey)||!a||!i.has(a)||!(e!=null&&e.skipChecks)&&w.formIsActive||s(o,a)})}onAttr(t,s){new MutationObserver(i=>{for(let n of i)n.type==="attributes"&&n.attributeName===t&&s(this.attr(t))}).observe(this._el,{attributes:!0}),s(this.attr(t),!0)}onPromise(t,s=!1){return s?Promise.resolve():new Promise(e=>this.one("solve",()=>e()))}animate(t,s=400,e=0,i="ease-in-out"){return Dt(this,t,s,e,i)}enter(t="fade",s=500,e=0){return Cu(this,t,s,e)}exit(t="fade",s=500,e=0,i=!1){return ku(this,t,s,e,i)}effect(t){this.one("animationend",()=>this.removeClass(`effects-${t}`)),this.addClass(`effects-${t}`)}},ts=class extends Zh{get offsetTop(){return this._el.offsetTop}get offsetLeft(){return this._el.offsetLeft}get offsetParent(){return k(this._el.offsetParent||void 0)}get width(){return this._el.offsetWidth}get height(){return this._el.offsetHeight}get innerWidth(){let t=parseFloat(this.css("padding-left")),s=parseFloat(this.css("padding-right"));return this._el.clientWidth-t-s}get innerHeight(){let t=parseFloat(this.css("padding-bottom")),s=parseFloat(this.css("padding-top"));return this._el.clientHeight-t-s}get outerWidth(){let t=parseFloat(this.css("margin-left")),s=parseFloat(this.css("margin-right"));return this.width+t+s||0}get outerHeight(){let t=parseFloat(this.css("margin-bottom")),s=parseFloat(this.css("margin-top"));return this.height+t+s||0}get positionTop(){let t=this._el,s=0;for(;t;)s+=t.offsetTop,t=t.offsetParent;return s}get positionLeft(){let t=this._el,s=0;for(;t;)s+=t.offsetLeft,t=t.offsetParent;return s}offset(t){if(t._el===this._el.offsetParent){let s=this.offsetTop+t._el.clientTop,e=this.offsetLeft+t._el.clientLeft,i=s+this.height,n=e+this.width;return{top:s,left:e,bottom:i,right:n}}else{let s=t._el.getBoundingClientRect(),e=this._el.getBoundingClientRect();return{top:e.top-s.top,left:e.left-s.left,bottom:e.bottom-s.top,right:e.right-s.left}}}},Qh=class extends Zh{constructor(){super(...arguments),this.type="svg"}get $ownerSVG(){return k(this._el.ownerSVGElement||void 0)}get width(){return this.bounds.width}get height(){return this.bounds.height}get positionLeft(){let t=this._el.getBBox().x+this._el.getCTM().e;return this.$ownerSVG.positionLeft+t}get positionTop(){let t=this._el.getBBox().y+this._el.getCTM().f;return this.$ownerSVG.positionTop+t}get inverseTransformMatrix(){let t=this._el.getScreenCTM().inverse(),s=[[t.a,t.c,t.e],[t.b,t.d,t.f]];if(w.isFirefox){let e=this.transformMatrix;s[0][2]-=e[0][2],s[1][2]-=e[1][2]}return s}setTransform(t,s=0,e=1){let i=t?`translate(${vt(t.x,.1)} ${vt(t.y,.1)})`:"",n=y(s,0)?"":`rotate(${s*180/Math.PI})`,r=y(e,1)?"":`scale(${e})`;this.setAttr("transform",[i,n,r].join(" "))}get strokeLength(){if(this._el instanceof SVGGeometryElement)return this._el.getTotalLength();{let t=this.bounds;return 2*t.height+2*t.width}}getPointAtLength(t){if(this._el instanceof SVGGeometryElement){let s=this._el.getPointAtLength(t);return new c(s.x,s.y)}else return new c(0,0)}getPointAt(t){return this.getPointAtLength(t*this.strokeLength)}get points(){return Co(this.attr("d"))}set points(t){let s=t.length?`M${t.map(e=>`${e.x},${e.y}`).join("L")}`:"";this.setAttr("d",s)}addPoint(t){let s=`${this.attr("d")} L ${t.x},${t.y}`;this.setAttr("d",s)}get center(){let t=+this.attr(this.tagName==="TEXT"?"x":"cx"),s=+this.attr(this.tagName==="TEXT"?"y":"cy");return new c(t,s)}setCenter(t){this.setAttr(this.tagName==="TEXT"?"x":"cx",t.x),this.setAttr(this.tagName==="TEXT"?"y":"cy",t.y)}setLine(t,s){this.setAttr("x1",t.x),this.setAttr("y1",t.y),this.setAttr("x2",s.x),this.setAttr("y2",s.y)}setRect(t){this.setAttr("x",t.p.x),this.setAttr("y",t.p.y),this.setAttr("width",t.w),this.setAttr("height",t.h)}draw(t,s={}){if(!t)return this.setAttr("d","");let e={mark:this.attr("mark"),arrows:this.attr("arrows"),size:+this.attr("size")||void 0,fill:this.hasClass("fill"),round:this.hasAttr("round")};this.setAttr("d",ke(t,Object.assign(s,e)))}},ef=class extends Qh{get viewBox(){return this._el.viewBox.baseVal||{width:0,height:0}}get $ownerSVG(){return this}get positionLeft(){return parseInt(this.css("margin-left"))+this.parent.positionLeft}get positionTop(){return parseInt(this.css("margin-top"))+this.parent.positionTop}get svgWidth(){return this.viewBox.width||this.width}get svgHeight(){return this.viewBox.height||this.height}drawPath(t,s={},e={}){let i=d("path",s,this);return i.draw(t,e),i}image(t,s,e,i){return te(this,null,function*(){let n=this.copy(!0);Yh(this._el,n._el),t==="svg"&&Xh(n._el),e||(e=s||this.svgHeight),s||(s=this.svgWidth),n.setAttr("width",s),n.setAttr("height",e),n.setAttr("viewBox",i||this.attr("viewBox")||`0 0 ${this.svgWidth} ${this.svgHeight}`),n.setAttr("xmlns","http://www.w3.org/2000/svg");let r=n.$$("image");if(t==="svg")for(let p of r)p.setAttr("href",new URL(p.attr("href"),location.href));else yield Promise.all(r.map(p=>te(this,null,function*(){p.setAttr("href",yield hf(p.attr("href")))})));let o=new XMLSerializer().serializeToString(n._el),a=`data:image/svg+xml;utf8,${encodeURIComponent(o)}`;if(t==="svg")return a;let h=d("canvas",{width:s,height:e});t==="jpg"&&(h.ctx.fillStyle="white",h.ctx.fillRect(0,0,s,e));let l=yield el(a);return h.ctx.drawImage(l,0,0,s,e),h.image(t)})}downloadImage(t,s,e,i){let n=w.isIOS?window.open("","_blank"):void 0,r=w.theme.isDark;r&&w.setTheme("light");let o=t.endsWith(".jpg")?"jpg":t.endsWith(".svg")?"svg":"png",a=this.image(o,s,e,i);r&&w.setTheme("dark"),a.then(h=>{if(n)return n.location.href=h;d("a",{download:t,href:h,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))})}},Jh=class extends ts{constructor(){super(...arguments),this.type="window"}get width(){return window.innerWidth}get height(){return window.innerHeight}get innerWidth(){return window.innerWidth}get innerHeight(){return window.innerHeight}get outerWidth(){return window.outerWidth}get outerHeight(){return window.outerHeight}get scrollWidth(){return document.body.scrollWidth}get scrollHeight(){return document.body.scrollHeight}get scrollTop(){return window.pageYOffset}set scrollTop(t){document.body.scrollTop=document.documentElement.scrollTop=t,this.trigger("scroll",{top:t,left:this.scrollLeft})}get scrollLeft(){return window.pageXOffset}set scrollLeft(t){document.body.scrollLeft=document.documentElement.scrollLeft=t,this.trigger("scroll",{top:this.scrollTop,left:t})}},sf=class extends ts{constructor(){super(...arguments),this.type="form"}get action(){return this._el.action}get formData(){let t={};for(let s of Array.from(this._el.elements)){let e=s.name||s.id;e&&(t[e]=s.value)}return t}get isValid(){return this._el.checkValidity()}},nf=class extends ts{constructor(){super(...arguments),this.type="input"}get checked(){return this._el.checked||!1}set checked(t){this._el.checked=t}get value(){return this._el.value}set value(t){this._el.value=t}bindVariable(t,s){let e=this._el.type==="number",i=this._el.type==="checkbox";if(s in t?i?this.checked=t[s]:this.value=t[s]:this.value&&(i?t[s]=this.checked:t[s]=this.value),e){let n=this.hasAttr("min")?+this.attr("min"):-1/0,r=this.hasAttr("max")?+this.attr("max"):1/0;this.change(o=>t[s]=G(+o,n,r)),this.on("blur",()=>this.value=t[s])}else i?this.on("change",()=>t[s]=this.checked):this.change(n=>t[s]=n);t.watch(()=>{i?this.checked=t[s]:this.value=t[s],this.trigger("model-change",{defaultPrevented:!0})})}setInputPattern(t){if(isNaN(+t))return;let s=t.match(/^[0-9]+$/);this.setAttr("inputmode",s?"numeric":"decimal"),s&&this.setAttr("pattern","[0-9]*")}change(t){let s=this.value||"";this.on("change keyup input paste model-change",e=>{this.value!==s&&(s=this.value.trim(),e.defaultPrevented||t(s))})}validate(t){this.change(s=>this.setValidity(t(s)))}setValidity(t){this._el.setCustomValidity(t)}get isValid(){return this._el.checkValidity()}},rf=class extends ts{constructor(){super(...arguments),this.type="canvas"}getContext(t="2d",s={}){return this._el.getContext(t,s)}image(t="png"){return this._el.toDataURL(t==="png"?"image/png":"image/jpeg")}get canvasWidth(){return this._el.width}get canvasHeight(){return this._el.height}get ctx(){return this._ctx||(this._ctx=this.getContext()),this._ctx}draw(t,s={}){this.ctx.save(),bo(this.ctx,t,s),this.ctx.restore()}clear(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}fill(t){this.ctx.save(),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.restore()}clearCircle(t,s){this.ctx.save(),this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,s,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.restore()}downloadImage(t){let s=this.image(t.endsWith(".jpg")?"jpg":"png");d("a",{download:t,href:s,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))}},of=class extends ts{play(){return this._el.play()||Promise.resolve()}pause(){return this._el.pause()}},tl=["path","rect","circle","ellipse","polygon","polyline","g","defs","marker","line","text","tspan","pattern","mask","svg","foreignObject","image","use","clipPath"];function k(t,s){if(!t)return;let e=s?s._el:document.documentElement,i=typeof t=="string"?e.querySelector(t):t;if(!i)return;if(i._view)return i._view;let n=(i.tagName||"").toLowerCase();return n==="svg"?new ef(i):n==="canvas"?new rf(i):n==="form"?new sf(i):n==="input"||n==="select"||n==="textarea"?new nf(i):n==="video"||n==="audio"?new of(i):tl.includes(n)?new Qh(i):new ts(i)}function ve(t,s){let e=s?s._el:document.documentElement,i=t?e.querySelectorAll(t):[];return Array.from(i,n=>k(n))}function d(t,s={},e){let i=tl.includes(t)?document.createElementNS("http://www.w3.org/2000/svg",t):document.createElement(t);for(let[r,o]of Object.entries(s))o!==void 0&&(r==="id"?i.id=o:r==="html"?i.innerHTML=o:r==="text"?i.textContent=o:r==="path"?i.setAttribute("d",ke(o)):i.setAttribute(r,o));let n=k(i);return e&&e.append(n),n}var A=new Jh(document.body),xt=new Jh(document.documentElement);function af(t){let s=[];for(let e of Object.keys(t)){let i=t[e];if(e=encodeURIComponent(e),i==null){s.push(e);continue}i=Array.isArray(i)?i.join(","):`${i}`,i=i.replace(/(\r)?\n/g,`\r
`),i=encodeURIComponent(i),i=i.replace(/%20/g,"+"),s.push(`${e}=${i}`)}return s.join("&")}function ko(t){t=t.replace(/^[?,&]/,"");let s=decodeURIComponent(t).split("&"),e={};return s.forEach(i=>{let n=i.split("=");e[n[0]]=n[1]}),e}function Ae(t,s){return te(this,null,function*(){let e=s instanceof FormData,i={method:"POST",body:e?s:s?af(s):void 0,headers:{"X-CSRF-Token":window.csrfToken||""}};e||(i.headers["Content-Type"]="application/x-www-form-urlencoded");let n=t.includes("?")?"&xhr=1":"?xhr=1",r=yield fetch(t+n,i);if(!r.ok)throw new Error(`Fetch error ${r.status}: ${t}`);return r.text()})}function el(t,s=!1){return new Promise(e=>{let i=new Image;s||(i.crossOrigin="Anonymous"),i.onload=()=>e(i),i.src=t})}var hf=us(t=>te(void 0,null,function*(){let s=yield el(t),e=d("canvas",{width:s.width,height:s.height});return e.ctx.drawImage(s,0,0,s.width,s.height),e.image("png")})),hi=new Map;function sl(t,s){hi.has(t)?Qr(hi.get(t),s,(e,i)=>Pt(e.concat(i))):hi.set(t,s)}function il(){if(!!window.navigator.onLine)for(let[t,s]of hi)hi.delete(t),Ae(t,{data:JSON.stringify(s)}).catch(e=>{console.error("Failed to send POST request:",e),sl(t,s)})}var nl=ue(il,5e3);window.addEventListener("online",nl);window.onbeforeunload=il;function rl(t,s){sl(t,s),nl()}var se=class{constructor(t,s=1,e=!0){this.src=t,this.defaultVolume=s,this.player=new Audio,this.player.src=t,e&&(this.player.preload="auto")}play(t){this.player.currentTime=0,this.player.volume=t||this.defaultVolume,this.player.play()}},lf=Ke(["#cd0e66","#0f82f2","#22ab24","#fd8c00"]),cf=class{constructor(t){this.index=t,this.color=lf(),this.tilt=Math.floor(Math.random()*10)-10,this.tiltAngleIncrement=Math.random()*.07+.05,this.tiltAngle=0,this.x=Math.random()*w.width,this.y=(Math.random()-1)*w.height,this.r=Ot.uniform(10,30)}draw(t){t.beginPath(),t.lineWidth=this.r/2,t.strokeStyle=this.color,t.moveTo(this.x+this.tilt+this.r/4,this.y),t.lineTo(this.x+this.tilt,this.y+this.tilt+this.r/4),t.stroke()}update(t,s){this.tiltAngle+=this.tiltAngleIncrement,this.y+=(Math.cos(t)+3+this.r/2)/2,this.x+=Math.sin(t),this.tilt=Math.sin(this.tiltAngle-this.index/3)*15,this.x<-20?(this.x=-20,this.y=Math.random()*w.height,this.tilt=Math.floor(Math.random()*10)-20):this.x>w.width+20?(this.x=w.width+20,this.y=Math.random()*w.height,this.tilt=Math.floor(Math.random()*10)-20):s&&this.y>w.height&&(this.x=Math.random()*w.width,this.y=-10,this.tilt=Math.floor(Math.random()*10)-20)}},pf="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999",Ze=void 0;function ci(t=2e3,s=150){Ze||(Ze=d("canvas",{style:pf},A)),Ze.setAttr("width",w.width),Ze.setAttr("height",w.height),Ze.show();let e=Ze.ctx,i=H(r=>new cf(r),s),n=dt(r=>{e.clearRect(0,0,w.width,w.height);let o=r<t,a=0;for(let h of i)h.draw(e),h.update(r,o),h.y<w.height&&(a+=1);a||(n.cancel(),Ze.hide())})}var es=class extends Me{constructor(t,s={}){super(),this.$el=t,this.startPos=new c(0,0),this.position=new c(0,0),this.disabled=!1,this.options=Object.assign({moveX:!0,moveY:!0,withinBounds:!0},s),w.onResize(()=>this.updateBounds()),Je(t,{start:()=>{this.disabled||(this.startPos=this.position,this.trigger("start"),xt.addClass("grabbing"))},move:(e,i)=>{this.disabled||(this.setPosition(this.startPos.x+e.x-i.x,this.startPos.y+e.y-i.y),this.trigger("drag",{posn:this.position,pointerPosn:e}),this.checkTarget(e))},end:(e,i)=>{this.disabled||(this.trigger(e.equals(i)?"click":"end",{$target:this.$over}),this.options.$targets&&!this.$over&&this.options.resetOnMiss&&this.resetPosition(),this.$over=void 0,xt.removeClass("grabbing"))},click:()=>this.trigger("click"),accessible:!0})}addTarget(t){var s;this.options.$targets||(this.options.$targets=[]),(s=this.options.$targets)==null||s.push(t)}removeTarget(t){var s,e;this.options.$targets=(s=this.options.$targets)==null?void 0:s.filter(i=>i!==t),(e=this.options.$targets)!=null&&e.length||(this.options.$targets=void 0)}checkTarget(t){if(!this.options.$targets)return;let s=this.options.$targets.find(e=>e.boundsRect.contains(t));s!==this.$over&&(this.$over&&this.trigger("exit-target",{$target:this.$over}),s&&this.trigger("enter-target",{$target:s}),this.$over=s)}updateBounds(){if(!this.options.withinBounds)return this.bounds=void 0;if(this.options.bounds)return this.bounds=this.options.bounds;let t=this.bounds,s=this.options.$parent||this.$el.parent,e=s.type==="svg"?s.svgWidth:s.width,i=s.type==="svg"?s.svgHeight:s.height;this.bounds=new ut(0,e,0,i),!e&&!i&&setTimeout(()=>this.updateBounds()),t&&this.setPosition(this.position.x*this.bounds.dx/t.dx||0,this.position.y*this.bounds.dy/t.dy||0)}setPosition(t,s){var e;let i=new c(this.options.moveX?t:0,this.options.moveY?s:0);this.bounds&&(i=i.clamp(this.bounds,(e=this.options.margin)!=null?e:0)),i=i.round(this.options.snap||1),this.options.round&&(i=this.options.round(i)),!i.equals(this.position)&&(this.position=i,this.options.useTransform?this.$el.translate(i.x,i.y):(this.options.moveX&&this.$el.css("left",`${i.x}px`),this.options.moveY&&this.$el.css("top",`${i.y}px`)),this.trigger("move",{posn:i}))}resetPosition(t=250){return te(this,null,function*(){let s=this.position;this.$el.css({"pointer-events":"none"}),yield dt(e=>{let i=c.interpolate(s,this.startPos,e);this.setPosition(i.x,i.y)},t).promise,this.$el.css({"pointer-events":"initial"})})}},df="position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #0f82f2; pointer-events: none; z-index: 9999; will-change: transform;";function Fh(t,s){let e=s.regex.exec(t);if(e){e.shift();let i={};for(let[n,r]of s.params.entries())i[r]=e[n];return i}else return}function uf(t,s,e){return te(this,null,function*(){return t.template?typeof t.template=="string"?t.template:t.template(s):(yield fetch(e+(e.indexOf("?")>=0?"&xhr=1":"?xhr=1"))).text()})}var ol=document.readyState==="complete";window.addEventListener("load",()=>setTimeout(()=>ol=!0));"scrollRestoration"in window.history&&(window.history.scrollRestoration="manual");var ff=class extends Me{constructor(){super(...arguments),this.$viewport=A,this.views=[],this.active={path:"",hash:""},this.preloaded=!1,this.transition=!1,this.noLoad=!1,this.initialise=()=>{}}setup(t={}){t.$viewport&&(this.$viewport=t.$viewport),t.initialise&&(this.initialise=t.initialise),t.preloaded&&(this.preloaded=t.preloaded),t.transition&&(this.transition=t.transition),t.noLoad&&(this.noLoad=t.noLoad),t.click&&A.on("click",s=>this.onLinkClick(s)),t.history&&window.addEventListener("popstate",s=>te(this,null,function*(){var e;if(!ol||!((e=s.state)!=null&&e.path))return;(yield this.load(s.state.path,s.state.hash))||window.history.pushState(this.active,"",this.active.path+this.active.hash)}))}view(t,{enter:s,exit:e,template:i}={}){let n=(t.match(/:\w+/g)||[]).map(f=>f.substr(1)),r=`${t.replace(/:\w+/g,"([\\w-]+)").replace("/","\\/")}\\/?`,o=t.includes("?")?"":"(\\?.*)?",h={regex:new RegExp(`^${r}${o}$`,"i"),params:n,enter:s,exit:e,template:i};this.views.push(h);let l=window.location.pathname+window.location.search,p=Fh(l,h);!p||(this.active={path:l,hash:window.location.hash},window.history.replaceState(this.active,"",this.active.path+this.active.hash),w.ready(()=>{setTimeout(()=>{this.preloaded?(this.initialise(this.$viewport,p),h.enter&&h.enter(this.$viewport,p)):this.loadView(h,p)})}))}paths(...t){for(let s of t)this.view(s)}getView(t){for(let s of this.views){let e=Fh(t,s);if(e)return{view:s,params:e}}}load(t,s){return te(this,null,function*(){if(t===this.active.path&&s!==this.active.hash)return this.trigger("hashChange",s.slice(1)),this.trigger("change",t+s),this.active={path:t,hash:s},!0;let e=this.getView(t);return!e||this.beforeChange&&!(yield this.beforeChange())?!1:(this.active={path:t,hash:s},this.trigger("change",t+s),window.ga&&window.ga("send","pageview",t+s),this.noLoad?e.view.enter&&e.view.enter(this.$viewport,e.params):this.loadView(e.view,e.params),!0)})}loadView(t){return te(this,arguments,function*(s,e={}){this.showLoadingBar();let i=this.active.path,n=yield uf(s,e,i);if(this.active.path!==i)return;yield this.$viewport.animate({opacity:0},200).promise,this.$viewport.removeChildren(),A.scrollTop=0,this.$viewport.html=n,w.resize(),Pu(),this.$viewport.animate({opacity:1},200),this.hideLoadingBar();let r=this.$viewport.$("title");r&&(document.title=r.text),this.initialise(this.$viewport,e),s.enter&&s.enter(this.$viewport,e),this.trigger("afterChange",{$viewport:this.$viewport})})}onLinkClick(t){if(t.metaKey||t.ctrlKey||t.shiftKey||t.defaultPrevented)return;let s=t.target;for(;s&&s.nodeName!=="A";)s=s.parentNode;if(!s||s.nodeName!=="A")return;let e=s;if(e.target||e.origin!==window.location.origin||e.hasAttribute("download")||e.getAttribute("rel")==="external")return;let i=e.getAttribute("href");i&&i.indexOf("mailto:")>-1||this.getView(e.pathname+e.search)&&(t.preventDefault(),this.goTo(e.pathname+e.search,e.hash))}goTo(t,s=""){return te(this,null,function*(){let e=this.active.path+this.active.hash;(yield this.load(t,s))&&e!==this.active.path+this.active.hash&&window.history.pushState(this.active,"",t+s)})}replace(t,s=""){this.active={path:t,hash:s},window.history.replaceState(this.active,"",t+s)}back(){window.history.back()}forward(){window.history.forward()}showLoadingBar(){this.$loadingBar||(this.$loadingBar=d("div",{style:df},A)),this.$loadingBar.css({transform:"translateX(-100%)",opacity:1}),this.$loadingBar.show(),this.animation=dt(t=>{this.$loadingBar.css("transform",`translateX(-${10+90*Math.exp(-4*t)}%)`)},3e3)}hideLoadingBar(){return te(this,null,function*(){var t,s,e;(t=this.animation)==null||t.cancel(),yield(s=this.$loadingBar)==null?void 0:s.animate({transform:"none",opacity:0}).promise,(e=this.$loadingBar)==null||e.hide()})}},pi=new ff;function mf(t,s){let e=Array.from(t.childNodes);t.innerHTML=s;let i={};for(let n of Array.from(t.querySelectorAll("slot")))i[n.getAttribute("name")||""]=n;for(let n of e){let r=n.getAttribute&&n.getAttribute("slot")||"",o=i[r]||i[""];o&&o.parentNode.insertBefore(n,o)}for(let n of Object.values(i))n.parentNode.removeChild(n)}function al(t){let s=[];for(let e of Array.from(t.children))e.tagName.startsWith("X-")?s.push(e):s.push(...al(e));return s}var hl=new Map,gf=class extends HTMLElement{constructor(){super(...arguments),this.wasConnected=!1,this.isReady=!1}connectedCallback(){return te(this,null,function*(){if(this.wasConnected){this._view.trigger("connected");return}this.wasConnected=!0,this.isReady=!1,this._view.created();let t=hl.get(this._view.tagName)||{};t.template&&mf(this,t.template);let s=al(this).filter(e=>!e.isReady).map(e=>new Promise(i=>e.addEventListener("ready",i)));yield Promise.all(s),this._view.ready(),this.dispatchEvent(new CustomEvent("ready")),this.isReady=!0})}disconnectedCallback(){this._view.trigger("disconnected")}},S=class extends ts{created(){}ready(){}},vf=new Map;function P(t,s={}){return function(e){if(window.customElements.get(t)){console.warn(`Trying to declare the custom element ${t} twice!`);return}class i extends gf{constructor(){super(),this._view=new e(this)}}vf.set(t,e),hl.set(t.toUpperCase(),s),window.customElements.define(t,i)}}var on=class{constructor(s){this.clipEndTime=0;this.player=new Audio(s),this.player.preload="true",this.player.addEventListener("timeupdate",()=>{this.player.currentTime>=this.clipEndTime&&this.triggerCallback(!0)}),window.addEventListener("beforeunload",()=>this.player.pause())}playClip(s,e,i){this.triggerCallback(!1),this.player.currentTime=s,this.clipEndTime=e,this.clipCallback=i,this.player.play()}triggerCallback(s){if(!this.clipCallback)return;let e=this.clipCallback;this.clipCallback=void 0,this.player.pause(),e({ended:s})}pause(){this.triggerCallback(!1)}get isPlaying(){return!!this.clipCallback}},Vo=!1,Ao,an=class{constructor(s,e){this.audio=s;this.paragraphs=[];this.paragraphs=e.$$(".voice").map(i=>new Io(i,s));for(let[i,n]of this.paragraphs.entries())n.on("end",()=>{var r;if(this.paragraphs[i+1])this.paragraphs[i+1].play();else{let o=e.nextStep;o&&o.isShown&&((r=o.narration)==null||r.play())}})}play(){var s;this.audio.isPlaying||!Vo||(s=this.paragraphs[0])==null||s.play()}},Io=class extends Me{constructor(e,i){super();this.$p=e;this.audio=i;this.playing=void 0;this.sentences=e.$$(".sentence[data-timings]").map(n=>new Oo(n,i)),this.$button=d("button",{class:"playback-btn",title:"Play Narration"}),this.$button.on("click",()=>{this.playing?this.audio.pause():this.play(),Vo=!Vo,Ao=void 0}),e.prepend(this.$button),e.addClass("sentence-wrap");for(let[n,r]of this.sentences.entries())r.on("end",o=>{this.playing=void 0,o&&this.sentences[n+1]?setTimeout(()=>this.play(this.sentences[n+1]),200):(this.$button.removeClass("active"),o&&setTimeout(()=>this.trigger("end"),400))})}play(e){let i=e||this.sentences[0],n=i.$reveal;if(n&&n.css("visibility")==="hidden"){this.$button.removeClass("active"),Ao=n,n.one("reveal",()=>{Ao===n&&!this.audio.isPlaying&&this.play(i)});return}this.playing=i,this.playing.play(),this.$button.addClass("active");let r=this.$p.parents("x-tabbox .tab")[0];if(r){let h=r.parents("x-tabbox")[0];h.makeActive(r.index());let l=h.active;h.one("change",p=>{this.playing&&p!==l&&this.audio.pause()})}let o=this.$p.bounds,a=o.top+o.height-w.height+20;a>0&&A.scrollBy(a+100),setTimeout(()=>this.$button.focus(),800)}},Oo=class extends Me{constructor(e,i){super();this.$el=e;this.audio=i;let n=e.attr("data-timings").split("-");this.start=+n[0]/1e3,this.end=(+n[1]-200)/1e3}play(){this.$el.addClass("playing"),this.audio.playClip(this.start,this.end,({ended:e})=>{this.$el.removeClass("playing"),this.trigger("end",e)})}get $reveal(){return this.$el.parents(".reveal")[0]}};var wf=Object.defineProperty,yf=Object.getOwnPropertyDescriptor,di=(t,s,e,i)=>{for(var n=i>1?void 0:i?yf(s,e):s,r=t.length-1,o;r>=0;r--)(o=t[r])&&(n=(i?o(s,e,n):o(n))||n);return i&&n&&wf(s,e,n),n},ll=(t,s,e)=>new Promise((i,n)=>{var r=h=>{try{a(e.next(h))}catch(l){n(l)}},o=h=>{try{a(e.throw(h))}catch(l){n(l)}},a=h=>h.done?i(h.value):Promise.resolve(h.value).then(r,o);a((e=e.apply(t,s)).next())}),$s,xf=d("div",{class:"snackbar"},A),cl=class extends S{ready(){var t;xf.append(this),(t=this.$("button"))==null||t.on("click",()=>this.close())}open(t=2e3){return ll(this,null,function*(){$s!==this&&($s&&(yield $s.close()),$s=this,yield this.enter("pop",300).promise,this.setAttr("role","alert"),t&&setTimeout(()=>this.close(),t))})}close(){return ll(this,null,function*(){$s===this&&($s=void 0,this.removeAttr("role"),yield this.exit("pop",300).promise)})}};cl=di([P("x-alert")],cl);var pl=class extends S{ready(){if(this.children.length)return;let t=d("svg",{viewBox:"0 0 24 24"},this),s=d("use",{},t),e=+this.attr("size")||24;for(let i of[this,t])i.css({width:`${e}px`,height:`${e}px`});this.onAttr("name",i=>s.setAttr("href",`/icons.49ab7f4a.svg#${i}`))}};pl=di([P("x-icon")],pl);var ss=d("div",{class:"modal-background"},A),Ro,we=void 0,Lo=void 0;function _o(){we&&we.canClose&&we.close()}ss.on("click",_o);A.onKey("Escape",_o);pi.on("change",_o);ss.on("scrollwheel touchmove",t=>{t.preventDefault(),t.stopPropagation()});A.onKey("Space ArrowUp ArrowDown PageDown PageUp",t=>{we&&(t.preventDefault(),t.stopPropagation())});var dl=class extends S{constructor(){super(...arguments),this.isOpen=!1,this.canClose=!0}ready(){this.canClose=!this.hasAttr("no-close"),this.$iframe=this.$("iframe[data-src]"),this.$video=this.$("video");let t=ve(`[data-modal=${this.id}]`);for(let e of t)e.on("click",()=>this.open());pi.on("afterChange",({$viewport:e})=>{let i=e.$$(`[data-modal=${this.id}]`);for(let n of i)n.on("click",()=>this.open())}),(this.hasClass("open")||w.getHash()===this.id)&&!we&&this.open(!0),this.$("input")&&this.addClass("interactive");let s=this.$(".close");s&&s.on("click",()=>this.close());for(let e of this.$$(".btn"))e.on("click",()=>this.trigger("btn-click",e))}open(t=!1){var s,e;if(this.isOpen)return;ss.setClass("light",this.hasClass("light")),we?we.close(!0):t?ss.show():ss.css("display")==="block"?Ro==null||Ro.cancel():ss.enter("fade",250),this.isOpen=!0,we=this,this.$iframe&&this.$iframe.setAttr("src",this.$iframe.data.src),this.$video&&this.$video.play(),t?this.show():this.enter("pop",250).promise.then(()=>this.css("transform","")),this.setAttr("role","dialog"),this.trigger("open"),Lo=document.activeElement;let i=this.$('input, a, button, textarea, [tabindex="0"]');i&&i.focus(),(s=window.ga)==null||s.call(window,"send","event","Modal",this.id),(e=window.gtag)==null||e.call(window,"event","modal",{action:this.id})}close(t=!1,s=!1){!this.isOpen||(this.isOpen=!1,this.removeAttr("role"),we=void 0,this.$iframe&&this.$iframe.setAttr("src",""),this.$video&&this.$video.pause(),t||(Ro=ss.exit("fade",250)),this.exit("pop",250).promise.then(()=>this.css("transform","")),s||this.trigger("close"),Lo&&Lo.focus())}getOpenModal(){return we}};dl=di([P("x-modal")],dl);var ul=class extends S{constructor(){super(...arguments),this.isOpen=!1}ready(){this.animation=this.attr("animation")||"pop",this.$bubble=this.$(".popup-body"),this.$bubble.hide(),this.$(".popup-target").on("click",()=>this.toggle()),this.on("clickOutside",()=>this.close());for(let s of this.$bubble.$$("a"))s.on("click",()=>this.close());A.onKey("Escape",()=>this.close())}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen||(this.isOpen=!0,this.addClass("active"),this.$bubble.enter(this.animation,150),this.$bubble.setAttr("role","dialog"),this.$bubble.focus())}close(){!this.isOpen||(this.isOpen=!1,this.removeClass("active"),this.$bubble.exit(this.animation,150),this.$bubble.removeAttr("role"))}};ul=di([P("x-popup")],ul);var fl=class extends S{constructor(){super(...arguments),this.$options={}}ready(){let t=this.children;this.$active=this.$(".active")||t[0],this.$active.addClass("active");for(let[s,e]of t.entries())!_(e.tagName,"A","BUTTON")&&!e.hasAttr("tabindex")&&e.setAttr("tabindex",0),e.on("click",()=>this.makeActive(e)),this.$options[e.attr("value")||s]=e;this.trigger("change",this.$active)}makeActive(t){t!==this.$active&&(this.$active.removeClass("active"),this.$active=t,t.addClass("active"),this.trigger("change",t))}bindVariable(t,s){t[s]===void 0&&(t[s]=this.$active.attr("value")),this.on("change",e=>t[s]=e.attr("value")),t.watch(()=>{let e=this.$options[t[s]];e&&this.makeActive(e)})}};fl=di([P("x-select")],fl);var No=12;function bf(t){return`M${t},${t/2}a${t/2},${t/2},0,0,1,0,${t}A${t/2},${t/2},0,0,1,${t},${t/2}`}function $f(t){return`M ${t},0 C ${t/2},0,0,${t/2},0,${t}  s ${t/2},${t},${t},${t} s ${t}-${t/2},${t}-${t}     S ${t*1.5},0,${t},0 z M ${t*44.6/50},${t*76.1/50} L ${t*19.2/50},${t*48.8/50} l ${t*4/50}-${t*4.2/50}     l ${t*19.8/50},${t*11.9/50} l ${t*34.2/50}-${t*32.6/50} l ${t*3.5/50},${t*3.5/50} L ${t*44.6/50},${t*76.1/50} z`}var hn=class extends S{constructor(){super(...arguments);this.completed=!1}ready(){this.r=+this.attr("r")||10,this.r1=this.r+No,this.$svg=d("svg",{width:2*this.r1,height:2*this.r1},this),this.$progress=d("path",{class:"pie",d:bf(this.r),"stroke-width":this.r},this.$svg),this.onAttr("p",e=>this.setProgress(+e,!1))}setProgress(e,i=!0){if(e>.99)return this.complete(i);let n=Math.PI*this.r;this.$progress.css("stroke",e?"currentColor":"none"),this.$progress.css("stroke-dasharray",`${e*n} ${n}`)}complete(e=!0){if(this.completed||(this.completed=!0,this.$progress.css("stroke","none"),this.$progress.css("fill","currentColor"),this.$progress.setAttr("d",$f(this.r)),!e))return;let i=`translate(${this.r1} ${this.r1})`,n=d("g",{transform:i},this.$svg),r=H(()=>d("line",{},n),18);dt(o=>{let a=this.r+No*bt("quint-out",o),h=this.r+No*o;for(let l=0;l<18;++l){let p=Math.cos(Math.PI*2*l/18),f=Math.sin(Math.PI*2*l/18);r[l].setLine({x:p*a,y:f*a},{x:p*h,y:f*h})}},800).promise.then(()=>n.remove())}};hn=$([P("x-progress")],hn);var ml="2.4.1",Do="i5iSjo",gl="_av",Go="_au",Bo="(not set)";var ln=[],Xt=class{static add(s,e,i){vl(s,e).add(i)}static remove(s,e,i){vl(s,e).remove(i)}constructor(s,e){this.context=s,this.methodName=e,this.isTask=/Task$/.test(e),this.originalMethodReference=this.isTask?s.get(e):s[e],this.methodChain=[],this.boundMethodChain=[],this.wrappedMethod=(...i)=>{let n=this.boundMethodChain[this.boundMethodChain.length-1];return n(...i)},this.isTask?s.set(e,this.wrappedMethod):s[e]=this.wrappedMethod}add(s){this.methodChain.push(s),this.rebindMethodChain()}remove(s){let e=this.methodChain.indexOf(s);e>-1&&(this.methodChain.splice(e,1),this.methodChain.length>0?this.rebindMethodChain():this.destroy())}rebindMethodChain(){this.boundMethodChain=[];for(let s,e=0;s=this.methodChain[e];e++){let i=this.boundMethodChain[e-1]||this.originalMethodReference.bind(this.context);this.boundMethodChain.push(s(i))}}destroy(){let s=ln.indexOf(this);s>-1&&(ln.splice(s,1),this.isTask?this.context.set(this.methodName,this.originalMethodReference):this.context[this.methodName]=this.originalMethodReference)}};function vl(t,s){let e=ln.filter(i=>i.context==t&&i.methodName==s)[0];return e||(e=new Xt(t,s),ln.push(e)),e}var Ps=window.Element.prototype,Hv=Ps.matches||Ps.matchesSelector||Ps.webkitMatchesSelector||Ps.mozMatchesSelector||Ps.msMatchesSelector||Ps.oMatchesSelector;var Tf="80",Sf="443",ew=RegExp(":("+Tf+"|"+Sf+")$"),sw=document.createElement("a");function cn(t,s,e=void 0,i=void 0,n=void 0,r=void 0){if(typeof i=="function"){let o=e.get("buildHitTask");return{buildHitTask:a=>{a.set(t,null,!0),a.set(s,null,!0),i(a,n,r),o(a)}}}else return Ge({},t,s)}var qo={};function yl(t,s){let e=t.get("trackingId"),i=qo[e]=qo[e]||{},n=()=>{clearTimeout(i.timeout),i.send&&Xt.remove(t,"send",i.send),delete qo[e],i.queue.forEach(r=>r())};clearTimeout(i.timeout),i.timeout=setTimeout(n,0),i.queue=i.queue||[],i.queue.push(s),i.send||(i.send=r=>(...o)=>{n(),r(...o)},Xt.add(t,"send",i.send))}var Ge=Object.assign||function(t,...s){for(let e=0,i=s.length;e<i;e++){let n=Object(s[e]);for(let r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t};function xl(t){return t.charAt(0).toUpperCase()+t.slice(1)}function bl(t){return typeof t=="object"&&t!==null}function Be(){return+new Date}var ui=function t(s){return s?(s^Math.random()*16>>s/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t)};function zo(t,s){let e=window.GoogleAnalyticsObject||"ga";window[e]=window[e]||function(...i){(window[e].q=window[e].q||[]).push(i)},window.gaDevIds=window.gaDevIds||[],window.gaDevIds.indexOf(Do)<0&&window.gaDevIds.push(Do),window[e]("provide",t,s),window.gaplugins=window.gaplugins||{},window.gaplugins[xl(t)]=s}var fi=class{constructor(){this.registry_={}}on(s,e){this.getRegistry_(s).push(e)}off(s=void 0,e=void 0){if(s&&e){let i=this.getRegistry_(s),n=i.indexOf(e);n>-1&&i.splice(n,1)}else this.registry_={}}emit(s,...e){this.getRegistry_(s).forEach(i=>i(...e))}getEventCount(){let s=0;return Object.keys(this.registry_).forEach(e=>{s+=this.getRegistry_(e).length}),s}getRegistry_(s){return this.registry_[s]=this.registry_[s]||[]}};var pn="autotrack",Es={},Ho=!1,mi,Gt=class extends fi{static getOrCreate(s,e,i){let n=[pn,s,e].join(":");return Es[n]||(Es[n]=new Gt(n,i),Ho||Cf()),Es[n]}static isSupported_(){if(mi!=null)return mi;try{window.localStorage.setItem(pn,pn),window.localStorage.removeItem(pn),mi=!0}catch(s){mi=!1}return mi}static get_(s){return window.localStorage.getItem(s)}static set_(s,e){window.localStorage.setItem(s,e)}static clear_(s){window.localStorage.removeItem(s)}constructor(s,e={}){super(),this.key_=s,this.defaults_=e,this.cache_=null}get(){if(this.cache_)return this.cache_;if(Gt.isSupported_())try{this.cache_=Fo(Gt.get_(this.key_))}catch(s){}return this.cache_=Ge({},this.defaults_,this.cache_)}set(s){if(this.cache_=Ge({},this.defaults_,this.cache_,s),Gt.isSupported_())try{Gt.set_(this.key_,JSON.stringify(this.cache_))}catch(e){}}clear(){if(this.cache_={},Gt.isSupported_())try{Gt.clear_(this.key_)}catch(s){}}destroy(){delete Es[this.key_],Object.keys(Es).length||kf()}};function Cf(){window.addEventListener("storage",$l),Ho=!0}function kf(){window.removeEventListener("storage",$l),Ho=!1}function $l(t){let s=Es[t.key];if(s){let e=Ge({},s.defaults_,Fo(t.oldValue)),i=Ge({},s.defaults_,Fo(t.newValue));s.cache_=i,s.emit("externalSet",i,e)}}function Fo(t){let s={};if(t)try{s=JSON.parse(t)}catch(e){}return s}var Af=1e3,Vf=60*Af,dn={},ye=class{static getOrCreate(s,e,i){let n=s.get("trackingId");return dn[n]?dn[n]:dn[n]=new ye(s,e,i)}constructor(s,e,i){this.tracker=s,this.timeout=e||ye.DEFAULT_TIMEOUT,this.timeZone=i,this.sendHitTaskOverride=this.sendHitTaskOverride.bind(this),Xt.add(s,"sendHitTask",this.sendHitTaskOverride);try{this.dateTimeFormatter=new Intl.DateTimeFormat("en-US",{timeZone:this.timeZone})}catch(r){}let n={hitTime:0,isExpired:!1};this.store=Gt.getOrCreate(s.get("trackingId"),"session",n),this.store.get().id||this.store.set({id:ui()})}getId(){return this.store.get().id}isExpired(s=this.getId()){if(s!=this.getId())return!0;let e=this.store.get();if(e.isExpired)return!0;let i=e.hitTime;if(i){let n=new Date,r=new Date(i);if(n-r>this.timeout*Vf||this.datesAreDifferentInTimezone(n,r))return!0}return!1}datesAreDifferentInTimezone(s,e){return this.dateTimeFormatter?this.dateTimeFormatter.format(s)!=this.dateTimeFormatter.format(e):!1}sendHitTaskOverride(s){return e=>{s(e);let i=e.get("sessionControl"),n=i=="start"||this.isExpired(),r=i=="end",o=this.store.get();o.hitTime=Be(),n&&(o.isExpired=!1,o.id=ui()),r&&(o.isExpired=!0),this.store.set(o)}}destroy(){Xt.remove(this.tracker,"sendHitTask",this.sendHitTaskOverride),this.store.destroy(),delete dn[this.tracker.get("trackingId")]}};ye.DEFAULT_TIMEOUT=30;var jo={CLEAN_URL_TRACKER:1,EVENT_TRACKER:2,IMPRESSION_TRACKER:3,MEDIA_QUERY_TRACKER:4,OUTBOUND_FORM_TRACKER:5,OUTBOUND_LINK_TRACKER:6,PAGE_VISIBILITY_TRACKER:7,SOCIAL_WIDGET_TRACKER:8,URL_CHANGE_TRACKER:9,MAX_SCROLL_TRACKER:10},Pl=Object.keys(jo).length;function El(t,s){Nf(t),_f(t,s)}function If(t){return parseInt(t||"0",16).toString(2)}function Of(t){return parseInt(t||"0",2).toString(16)}function Rf(t,s){if(t.length<s){let e=s-t.length;for(;e;)t="0"+t,e--}return t}function Lf(t,s){return t.substr(0,s)+1+t.substr(s+1)}function _f(t,s){let e=t.get("&"+Go),i=Rf(If(e),Pl);i=Lf(i,Pl-s),t.set("&"+Go,Of(i))}function Nf(t){t.set("&"+gl,ml)}var gi="hidden",xe="visible",Ts=ui(),Tl=1e3,Uo=class{constructor(s,e){if(El(s,jo.PAGE_VISIBILITY_TRACKER),!document.visibilityState)return;let i={sessionTimeout:ye.DEFAULT_TIMEOUT,visibleThreshold:5*Tl,sendInitialPageview:!1,fieldsObj:{}};this.opts=Ge(i,e),this.tracker=s,this.lastPageState=document.visibilityState,this.visibleThresholdTimeout_=null,this.isInitialPageviewSent_=!1,this.trackerSetOverride=this.trackerSetOverride.bind(this),this.handleChange=this.handleChange.bind(this),this.handleWindowUnload=this.handleWindowUnload.bind(this),this.handleExternalStoreSet=this.handleExternalStoreSet.bind(this),this.store=Gt.getOrCreate(s.get("trackingId"),"plugins/page-visibility-tracker"),this.store.on("externalSet",this.handleExternalStoreSet),this.session=ye.getOrCreate(s,this.opts.sessionTimeout,this.opts.timeZone),Xt.add(s,"set",this.trackerSetOverride),window.addEventListener("unload",this.handleWindowUnload),document.addEventListener("visibilitychange",this.handleChange),yl(this.tracker,()=>{document.visibilityState==xe?(this.opts.sendInitialPageview&&(this.sendPageview({isPageLoad:!0}),this.isInitialPageviewSent_=!0),this.store.set({time:Be(),state:xe,pageId:Ts,sessionId:this.session.getId()})):this.opts.sendInitialPageview&&this.opts.pageLoadsMetricIndex&&this.sendPageLoad()})}handleChange(){if(!(document.visibilityState==xe||document.visibilityState==gi))return;let s=this.getAndValidateChangeData(),e={time:Be(),state:document.visibilityState,pageId:Ts,sessionId:this.session.getId()};document.visibilityState==xe&&this.opts.sendInitialPageview&&!this.isInitialPageviewSent_&&(this.sendPageview(),this.isInitialPageviewSent_=!0),document.visibilityState==gi&&this.visibleThresholdTimeout_&&clearTimeout(this.visibleThresholdTimeout_),this.session.isExpired(s.sessionId)?(this.store.clear(),this.lastPageState==gi&&document.visibilityState==xe&&(clearTimeout(this.visibleThresholdTimeout_),this.visibleThresholdTimeout_=setTimeout(()=>{this.store.set(e),this.sendPageview({hitTime:e.time})},this.opts.visibleThreshold))):(s.pageId==Ts&&s.state==xe&&this.sendPageVisibilityEvent(s),this.store.set(e)),this.lastPageState=document.visibilityState}getAndValidateChangeData(){let s=this.store.get();return this.lastPageState==xe&&s.state==gi&&s.pageId!=Ts&&(s.state=xe,s.pageId=Ts,this.store.set(s)),s}sendPageVisibilityEvent(s,{hitTime:e}={}){let i=this.getTimeSinceLastStoredChange(s,{hitTime:e});if(i&&i>=this.opts.visibleThreshold){let n=Math.round(i/Tl),r={transport:"beacon",nonInteraction:!0,eventCategory:"Page Visibility",eventAction:"track",eventValue:n,eventLabel:Bo};e&&(r.queueTime=Be()-e),this.opts.visibleMetricIndex&&(r["metric"+this.opts.visibleMetricIndex]=n),this.tracker.send("event",cn(r,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}}sendPageLoad(){let s={transport:"beacon",eventCategory:"Page Visibility",eventAction:"page load",eventLabel:Bo,["metric"+this.opts.pageLoadsMetricIndex]:1,nonInteraction:!0};this.tracker.send("event",cn(s,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}sendPageview({hitTime:s,isPageLoad:e}={}){let i={transport:"beacon"};s&&(i.queueTime=Be()-s),e&&this.opts.pageLoadsMetricIndex&&(i["metric"+this.opts.pageLoadsMetricIndex]=1),this.tracker.send("pageview",cn(i,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}trackerSetOverride(s){return(e,i)=>{let n=bl(e)?e:{[e]:i};n.page&&n.page!==this.tracker.get("page")&&this.lastPageState==xe&&this.handleChange(),s(e,i)}}getTimeSinceLastStoredChange(s,{hitTime:e}={}){return s.time?(e||Be())-s.time:0}handleExternalStoreSet(s,e){s.time!=e.time&&e.pageId==Ts&&e.state==xe&&!this.session.isExpired(e.sessionId)&&this.sendPageVisibilityEvent(e,{hitTime:s.time})}handleWindowUnload(){this.lastPageState!=gi&&this.handleChange()}remove(){this.store.destroy(),this.session.destroy(),Xt.remove(this.tracker,"set",this.trackerSetOverride),window.removeEventListener("unload",this.handleWindowUnload),document.removeEventListener("visibilitychange",this.handleChange)}};zo("pageVisibilityTracker",Uo);Hh();xt.addClass((w.isMobile?"is":"not")+"-mobile");w.isSafari&&xt.addClass("is-safari");setTimeout(()=>xt.addClass("ready"));window.addEventListener("keydown",t=>{t.keyCode===9&&xt.addClass("is-tabbing")});window.addEventListener("mousedown",()=>{xt.removeClass("is-tabbing")});var Sl=k(".cookie-warning");Sl&&k("#yes-to-cookies").on("click",function(){Sl.exit("pop",300),w.setCookie("cookie_consent",1)});var Wo=k("x-modal#privacy");Wo&&Wo.$("form").on("submit",t=>{t.preventDefault(),fetch("/profile/accept-policies",{method:"POST"}),Wo.close()});var Cl;(Cl=navigator.serviceWorker)==null||Cl.register("/service_worker.js",{scope:"/"}).catch(()=>console.warn("Unable to register Service Worker."));window.addEventListener("beforeinstallprompt",t=>{t.prompt()});var kl;(kl=k("#skip-nav"))==null||kl.on("click",()=>{var s;(s=(k("article")||k(".panel.active")||k(".body")||A).$("input, button, a, textarea, [contenteditable], [tabindex]"))==null||s.focus()});var Ko=k("nav x-popup");if(Ko){let t=Ko.$$(".popup-body a, .popup-body button");for(let s of t)s.on("click",()=>Ko.close())}var Df=ve("#language .locale-link");pi.on("change",t=>{for(let s of Df)s.setAttr("href",s.data.host+t)});var un=k("#dark-mode");un&&(un.checked=w.theme.isDark,un.on("change",()=>w.setTheme(un.checked?"dark":"light")));var vi={},is=k("#search"),qe=is==null?void 0:is.$(".form-field input"),fn=is==null?void 0:is.$(".search-body");vi[""]=(fn==null?void 0:fn.html)||"";function Gf(t){return t=t.trim().replace(/\s+/," ").toLowerCase().slice(0,50),t==="pi"||t.length>=3?t:""}function Bf(t){return O(this,null,function*(){if(t=encodeURIComponent(Gf(t)),t in vi)return vi[t];let s=yield fetch(`/api/search?q=${t}`);return s.ok?vi[t]=yield s.text():vi[t]=""})}var qf=0,Ml=0;function Al(t){return O(this,null,function*(){let s=qf+=1,e=yield Bf(t);s<=Ml||(Ml=s,fn.html=e)})}qe==null||qe.change(t=>{w.setCookie("search",t,60*60*24),setTimeout(()=>{qe.value===t&&Al(t)},300)});qe!=null&&qe.value&&is.one("open",()=>Al(qe.value));var Vl='<label class="target"><input maxlength="15" autocomplete="off" aria-label="Fill in this blank"></label>';function Il(t){if(t.match("^[0-9]+/[0-9]+$")){let s=t.split("/");return+s[0]/+s[1]}else return dh(t)}var mn=class extends S{constructor(){super(...arguments);this.solution="";this.solutionNum=NaN;this.solutionDisplay="";this.range=0;this.input="";this.hint="";this.attempts=0;this.placeholder="???";this.done=!1}ready(){if(this.$input=this.$("input"),this.$target=this.$(".target"),this.solution=this.attr("solution"),this.solution.indexOf("\xB1")>=0){let e=this.solution.split("\xB1");this.solution=e[0].trim(),this.range=+e[1]}this.solutionNum=Il(this.solution),this.solutionDisplay=this.solution,this.hint=this.attr("hint"),this.removeAttr("solution"),this.removeAttr("hint"),this.$input.setInputPattern(this.solution),this.hasAttr("placeholder")&&(this.placeholder=this.attr("placeholder")),this.$input.setAttr("placeholder",this.placeholder),this.removeAttr("placeholder"),this.$input.change(e=>{this.input=e,this.isCorrect&&(this.solve(),this.trigger("valid",e),this.moveCursor())}),this.$input.onKey("Enter",()=>this.$input.blur()),this.$input.on("focus",()=>{this.addClass("on"),this.removeClass("invalid"),this.$input.setAttr("placeholder"," ")}),this.$input.on("blur",()=>{if(this.removeClass("on"),this.setClass("invalid",!!this.input&&!this.done),this.$input.setAttr("placeholder",this.placeholder),this.input&&!this.done){this.attempts+=1;let e=this.attempts>=(this.hint?4:3)?`Hmmm\u2026 maybe try ${this.solution}?`:this.attempts>=2?this.hint:void 0;this.trigger("invalid",{hint:e})}})}setup(e,i,n){var r;this.goal=i,this.$step=e,(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(!0),this.one("valid",()=>{e.addHint("correct"),e.score(this.solvedBlank?this.solvedBlank.goal:i)}),this.on("invalid",o=>e.addHint(o.hint||"incorrect",{class:"incorrect"}))}get isCorrect(){if(this.done)return!0;if(this.linkedBlanks){let e=this.linkedBlanks.map(i=>i.solvedBlank);return this.solvedBlank=this.linkedBlanks.find(i=>{if(i.done&&!i.solvedBlank||e.includes(i))return!1;if(i.checkAnswer(this.input))return!0}),this.solvedBlank&&(this.solutionDisplay=this.solvedBlank.solution),!!this.solvedBlank}return this.checkAnswer(this.input)}checkAnswer(e){let i=Il(e);return e.toLowerCase()===this.solution.toLowerCase()?!0:this.range&&Math.abs(i-this.solutionNum)<=this.range?(this.solutionDisplay=e,!0):y(i,this.solutionNum)||oo(i)===this.solution||e===oo(this.solutionNum)}moveCursor(){if(!this.$step)return;let e=this.$step.$blanks[this.$step.$blanks.indexOf(this)+1];!e||e.done||e.tagName==="X-BLANK-MC"||e.css("visibility")==="hidden"||!e.bounds.width||e.focus()}solve(e=!1){this.done=!0,this.$input.remove(),this.$target.html=this.solutionDisplay,this.addClass("done"),this.trigger("solve",{solution:this.solutionDisplay,restore:e})}focus(){this.$input.focus()}blur(){this.$input.blur()}};mn=$([P("x-blank",{template:Vl})],mn);var Ol='<span class="target" slot="target" tabindex="0" aria-label="Fill in this blank">???</span><div class="popup"><slot></slot></div>';var gn=class extends S{constructor(){super(...arguments);this.done=!1}ready(){this.$target=this.$(".target"),this.$popup=this.$(".popup");let e=this.$popup.$$(".choice");this.solution=e[0].html,Ot.shuffle(fs(e.length)).forEach(r=>{this.$popup.append(e[r]),e[r].on("click",()=>{this.removeClass("on"),e[r].blur(),r?(this.$target.html=e[r].html,this.addClass("invalid"),this.trigger("invalid")):(this.solve(),this.trigger("valid",this.solution))})});let n=this.$target.bounds.left+this.$popup.width>w.width-15;this.setClass("left",n),bs(this,{enter:()=>{if(this.done)return;this.addClass("on");let r=this.$target.bounds,o=this.$popup.width,a=this.$popup.height,h=w.width-10-r.left,l=o<h,p=r.right-o>10,f=r.top+r.height+a>w.height-10;this.setClass("left",p&&!l),this.setClass("top",f),this.$popup.css("max-width",!p&&!l?`${h}px`:"none")},exit:()=>{this.removeClass("on")},delay:100,exitDelay:400,$clickTarget:this.$target})}setup(e,i,n){var r;(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(!0),this.one("valid",()=>{e.addHint("correct"),e.score(i)}),this.on("invalid",o=>e.addHint(o.hint||"incorrect",{class:"incorrect"}))}solve(e=!1){this.done=!0,this.$target.html=this.solution,this.removeClass("on invalid"),this.addClass("done"),this.trigger("solve",{solution:this.solution,restore:e}),setTimeout(()=>this.$popup.remove(),250),this.$target.removeAttr("tabindex")}};gn=$([P("x-blank-mc",{template:Ol})],gn);var Rl='<div class="text-area" contenteditable="true"></div><div class="toolbar"><button class="command" data-command="bold"><x-icon name="bold" size="20"></x-icon></button><button class="command" data-command="italic"><x-icon name="italic" size="20"></x-icon></button><button class="command" data-command="underline"><x-icon name="underline" size="20"></x-icon></button><div class="space"></div><button class="btn btn-green submit"><x-icon name="check"></x-icon> Done</button></div>';var Ll=40,_l="free-text",vn=class extends S{setup(s,e,i){var l,p;let n=this.$(".text-area"),r=this.$(".toolbar .submit"),o=((l=i==null?void 0:i.data)==null?void 0:l[_l])||"";o&&(n.html=o);for(let f of this.$$(".toolbar .command")){let m=f.data.command.split(":");f.on("click",()=>document.execCommand(m[0],!1,m[1]))}let a=o,h=ue(()=>{a!==o&&s.storeData(_l,o),a=o},5e3);n.on("change keyup input paste",()=>{o=n.html.replace(/&nbsp;/g," ").trim().slice(0,500).trim(),r.setClass("invisible",o.length<Ll),h()}),(p=i==null?void 0:i.scores)!=null&&p.includes(e)?r.remove():(r.setClass("invisible",o.length<Ll),r.on("click",()=>{h(),s.score(e),r.exit("pop"),this.trigger("submit")}))}};vn=$([P("x-free-text",{template:Rl})],vn);var Nl='<div class="wrapper"><div class="panel"><slot></slot></div></div><div class="nav"><button class="btn back" aria-label="Previous Step"><x-icon name="left"></x-icon></button><button class="btn next" aria-label="Next Step"><x-icon name="right"></x-icon></button><div class="dots"></div></div>';var wn=class extends S{ready(){let s=this.$(".wrapper"),e=this.$(".panel"),i=e.children,n=this.$(".next"),r=this.$(".back"),o=this.$(".dots"),a=i.map(()=>d("div",{class:"dot"},o)),h=i.length,l=+this.attr("slide-width")||void 0,p=this.width,f=1,m=p,g=0,x=0,u=ht=>{x=ht,e.translate(ht,0),this.trigger("move",ht)},v=ht=>{g=ht;for(let[de,ti]of a.entries())ti.setClass("on",de>=ht&&de<ht+f);n.setClass("disabled",ht===h-f),r.setClass("disabled",ht===0),this.trigger("change",ht)};w.onResize(()=>{p=this.width,f=l?Math.ceil(p/l):1,m=p/f;for(let ht of i)ht.css("width",m+"px");e.css("width",h*m+"px"),u(-g*m),v(g)});let b="quad",E=500,M,T,F,mt,Wr=!1,Ya=()=>{M=Date.now()-mt,u(T+F*bt(b,M/E)),!Wr&&M<E?requestAnimationFrame(Ya):this.trigger("slide-end")},Kr=ht=>{Wr=!1,M=0,T=x,F=-ht*m-x,mt=Date.now(),v(ht),Ya()};n.on("click",()=>{b="quad",g<h-f&&Kr(g+1)}),r.on("click",()=>{b="quad",g>0&&Kr(g-1)});let Za,Xr,Yr,Di;Je(s,{start:ht=>{Wr=!0,Za=x,Xr=ht.x,Di=Yr=Xr},move:ht=>{Yr=Di,Di=ht.x;let de=Za-Xr+ht.x,ti=-(h-f)*m,Qp=de>0?de/4:de<ti?ti+(de-ti)/4:de;u(Qp),this.css("pointer-events","none")},end:()=>{let ht=Di-Yr,de=ht>12?1:ht<-12?-1:0;b="quad-out",Kr(G(Math.round(-x/m-de),0,h-f)),setTimeout(()=>this.css("pointer-events","auto"))}})}};wn=$([P("x-gallery",{template:Nl})],wn);var Dl='<svg width="70" height="80"><path d="M20.5,7.4,27.2,24c-1.9-4.7,6-7.1,8-2.3l1.4,3.6c-1.9-4.8,6.1-7.1,8-2.3l1.3,3.1c-2-4.7,5.7-6.5,7.7-1.8,3.3,7.8,5.8,13.6,9,21.3S60.8,56.2,65,66.7L44.9,75A13.9,13.9,0,0,0,36,66.9c-7.7-2.2-11.4-8.3-18.4-14.3a44.2,44.2,0,0,0-9.5-6.5c-2.6-1.5-4.2-3.4-2.2-5.7,3.5-4.1,9.3-1.3,13.1,1.5,1.6,1.2,4.4,4.1,5.9,3.8s1.7-.8,1-2.6L12.8,10.5c-1.9-4.7,5.8-7.9,7.7-3.1Z"></path></svg>';function Xo(t,s){let e=s.positionLeft-t.positionLeft+s.width/2,i=s.positionTop-t.positionTop+s.height/2;return new c(e,i)}function Gl(t){return t?new c(...t.split(",").map(s=>+s)):void 0}var yn=class extends S{constructor(){super(...arguments);this.doAnimation=!1}created(){this.slide=Gl(this.attr("slide")),this.shift=Gl(this.attr("offset"))}ready(){this.$target=k(this.attr("target")),this.$target&&(this.$target.on("click pointerdown focus",()=>this.stop()),this.hasAttr("start")&&this.start())}setTarget(e,i,n){this.$target=typeof e=="string"?k(e):e,i&&(this.slide=i),n&&(this.slide=n)}start(e){this.doAnimation||!this.from&&!this.$target||(this.doAnimation=!0,e&&(this.slide=e),this.slide||this.$end?this.runSlideAnimation():this.runClickAnimation())}startSlide(e,i){this.$target=e,this.$end=i,this.start()}stop(){this.doAnimation=!1}runSlideAnimation(){return O(this,null,function*(){this.show();let e=this.from||Xo(this,this.$target);this.shift&&(e=e.add(this.shift));let i=this.slide?e.add(this.slide):Xo(this,this.$end),n=`translate(${e.x-15}px,${e.y-10}px)`,r=`translate(${i.x-15}px,${i.y-10}px)`;yield this.animate({transform:[n+" scale(2)",n],opacity:[0,1]},300).promise,yield this.animate({transform:[n,r]},1e3).promise,yield this.animate({transform:[r,r+" scale(2)"],opacity:[1,0]},300).promise,this.hide(),setTimeout(()=>{this.doAnimation&&this.runSlideAnimation()},1e3)})}runClickAnimation(){return O(this,null,function*(){this.show();let e=this.from||Xo(this,this.$target);this.shift&&(e=e.add(this.shift));let i=`translate(${e.x-15}px,${e.y-10}px)`;yield this.animate({transform:[i+" scale(2)",i],opacity:[0,1]},500).promise,yield this.animate({transform:[i,i+" scale(2)"],opacity:[1,0]},500,200).promise,this.hide(),setTimeout(()=>{this.doAnimation&&this.runClickAnimation()},1e3)})}};yn=$([P("x-gesture",{template:Dl})],yn);var Yo='<span class="target" tabindex="0"><slot></slot></span><div class="popup"></div>';var zf=JSON.parse(k("#glossary").text),Ff=JSON.parse(k("#bios").text),Zo=600,bn;w.onResize(()=>{bn&&bn.hide()});var wi=class extends S{ready(){this.xid=this.attr("xid"),this.$target=this.$(".target"),this.$popup=this.$(".popup"),this.$popup.html=this.body()||"",this.setClass("left",w.width>Zo&&this.$target.bounds.left+this.$popup.width>w.width-15),bs(this,{enter:()=>this.show(),exit:()=>this.hide(),delay:100,exitDelay:200,$clickTarget:this.$target,canFocusWithin:!0,preventMouseover:()=>w.width<=Zo})}show(){if(bn=this,this.addClass("on"),w.width<=Zo){let a=k("#glossary-modal");return a.$(".modal-body").html=this.body(),a.open()}let e=this.$target.bounds,i=this.$popup.width,n=this.$popup.height,r=e.top+e.height+n<w.height-10,o=e.top-n>54;this.setClass("top",o&&!r),this.setClass("left",e.left+i>w.width-15)}hide(){bn=void 0,this.removeClass("on")}body(){let e=zf[this.xid];if(!e)return console.warn("missing gloss:",this.xid);let i=e.text;return e.image&&(i+=`<img class="gloss-img" alt="" src="/content/shared/glossary/${e.image}"/>`),e.link&&(location.pathname===e.link.split("#")[0]||(i+=`<p><a href="${e.link}" class="btn btn-white btn-small">Learn more\u2026</a></p>`)),i}};wi=$([P("x-gloss",{template:Yo})],wi);var xn=class extends wi{body(){let s=Ff[this.xid];if(!s)return console.warn("missing bio:",this.xid);let e=`<img class="bio-img" alt="" src="/content/shared/bios/${this.xid}.jpg"/>`,i=s.born?`<p><a href="/timeline/${this.xid}" class="btn btn-white btn-small" target="_blank">Timeline</a></p>`:"";return(s.image===!1?"":e)+s.bio+i}};xn=$([P("x-bio",{template:Yo})],xn);var Bl='<div class="wrap"><img alt=""><div class="credit"></div><button class="zoom"><x-icon name="fullscreen" size="24"></x-icon></button><slot></slot></div>';var Hf=document.createElement("a").relList.supports("ar"),Pn=!1,Qo={x:0,y:0,s:1},ql,ns=d("div",{class:"lightbox-overlay"},A),Ve=d("div",{class:"lightbox-img"},ns);function jf(t,s,e){Pn=!0,ql=t,ns.show(),Ve.show();let i=t.bounds,n=Ve.bounds,r=i.left+i.width/2-n.left-n.width/2,o=i.top+i.height/2-n.top-n.height/2,a=Math.max(i.width/n.width,i.height/n.height);Qo={x:r,y:o,s:a},Ve.css("background-image",`url(${e}), url(${s})`),Ve.css("transform",`translate(${r}px, ${o}px) scale(${a})`),w.redraw(),Ve.addClass("transitions"),w.redraw(),t.css("visibility","hidden"),ns.addClass("on"),Ve.css("transform","scale(1) translate(0,0)")}function zl(){!Pn||(Pn=!1,ns.removeClass("on"),Ve.setTransform(Qo,0,Qo.s),setTimeout(()=>{ql.css("visibility","visible"),ns.css("display","none"),Ve.css("transform","none"),Ve.removeClass("transitions")},400))}ns.on("click touchmove",zl);A.onKey("Escape",zl);ns.on("scrollwheel touchmove",t=>{t.preventDefault(),t.stopPropagation()});A.onKey("Space AllArrows PageDown PageUp",t=>{Pn&&(t.preventDefault(),t.stopPropagation())});var $n=class extends S{ready(){let s=this.attr("src"),e=this.$(".wrap"),i=this.attr("width"),n=this.attr("height");this.css("width",i+"px"),e.css("padding-bottom",+n/+i*100+"%");let r=e.$("img");r.setAttr("src",s),r.setAttr("alt",this.attr("alt")||""),r.setAttr("width",i),r.setAttr("height",n),s.endsWith(".gif")&&r.on("click",()=>r.setAttr("src",s));let o=e.$(".credit"),a=this.attr("credit");a?o.text=a:o.remove();let h=e.$(".zoom");if(this.hasAttr("lightbox")){this.addClass("interactive");let l=s.replace(/\.(?=[^.]*$)/,"-large.");this.on("click",()=>jf(this,s,l))}else h.remove();if(Hf&&this.hasAttr("ar")){let l=d("a",{href:this.attr("ar"),rel:"ar"});e.prepend(l),l.append(r)}}};$n=$([P("x-img",{template:Bl})],$n);var En=class extends S{constructor(){super(...arguments);this.correctCount=0;this.solvedCount=0;this.isSolved=!1}setup(e,i,n){var h;let r=this.children,o=r.map(()=>!1);for(let[l,p]of r.entries()){let f=p.data.error,m=f?"incorrect":"correct";f||(this.correctCount+=1),p.one("click",()=>{o[l]||this.isSolved||(e.addHint(f||"correct",{class:m}),p.addClass(m),f||(this.solvedCount+=1,e.score("picker-"+l),this.checkSolved()))})}let a=((h=n==null?void 0:n.scores)==null?void 0:h.filter(l=>l.startsWith("picker-")))||[];for(let l of a){let p=+l.slice(7);o[p]=!0,r[p].addClass("correct")}this.solvedCount=a.length,this.checkSolved()}checkSolved(){this.solvedCount<this.correctCount||(this.addClass("solved"),this.isSolved=!0)}};En=$([P("x-picker")],En);var Fl='<button class="play" aria-label="Play Slider"><x-icon name="play" size="32"></x-icon></button><div class="bar"><div class="knob"></div></div>';var Tn=class extends S{constructor(){super(...arguments);this.current=0}ready(){this.onAttr("steps",a=>this.steps=+a),this.speed=+this.attr("speed")||1;let e=this.$(".bar"),i=this.$(".knob"),n=this.$(".play");this.hasAttr("no-play")?n.remove():n.on("click",()=>this.play());let r=this.hasAttr("continuous"),o=this.hasAttr("snap")?e.width/this.steps:.001;this.drag=new es(i,{moveY:!1,snap:o}),this.drag.on("start",()=>{this.animation&&this.animation.cancel(),this.animation=void 0}),this.drag.on("move",({posn:a})=>{let h=a.x/this.drag.bounds.dx*this.steps;r||(h=Math.round(h)),!y(h,this.current)&&(this.current=h,this.trigger("move",h))}),this.drag.on("end",()=>this.trigger("slide-end"))}setup(e,i){this.bindModel(e.model),this.one("slide-end",()=>e.score(i))}set(e){y(e,this.current)||this.drag.setPosition(e*this.drag.bounds.dx/this.steps,0)}play(){return O(this,null,function*(){this.current>=this.steps&&this.set(0);let e=(1-this.current/this.steps)*3e3/this.speed;this.moveTo(this.steps,e)})}moveTo(e,i=600){return O(this,null,function*(){if(this.animation||e===this.current)return;let n=this.current;this.animation=dt(r=>{this.set(n+(e-n)*bt("quad",r))},i),yield this.animation.promise,this.animation=void 0,this.trigger("slide-end")})}bindVariable(e,i){e[i]=0,this.on("move",n=>e[i]=n),e.watch(()=>this.set(e[i]))}};Tn=$([P("x-slider",{template:Fl})],Tn);var Hl='<slot name="stage"></slot><div class="nav"><button class="btn back disabled" aria-label="Previous Step"><x-icon name="left" size="24"></x-icon></button><button class="btn next" aria-label="Next Step"><x-icon name="right" size="24"></x-icon></button><div class="dots"></div></div><div class="legend-box"><slot></slot></div>';function Uf(t){let s=t.$$("x-blank, x-blank-mc");if(!s.length)return Promise.resolve();let e=0;return new Promise(i=>{for(let n of s)n.on("solve",()=>{e+=1,e>=s.length&&i()})})}var Sn=class extends S{constructor(){super(...arguments);this.length=0;this.current=0;this.locked=!1}ready(){this.$legend=this.$(".legend-box"),this.$steps=this.$legend.children,this.$back=this.$(".back"),this.$next=this.$(".next");let e=this.$(".dots");this.$dots=this.$steps.map(()=>d("div",{class:"dot"},e)),this.length=this.$steps.length,this.current=0,this.$back.on("click",()=>this.goBack()),this.$next.on("click",()=>this.goNext()),this.blanks=this.$steps.map(i=>Uf(i)),this.reveals=this.$$("[slide]").map(i=>{let n=i.attr("slide").split("-"),r=n.length>1?[+n[0]||0,+n[1]||this.length]:[+n[0],+n[0]],o=[i.data.animation||"fade",+i.data.duration||400];return i.data.display="visibility",r[0]>=0&&!i.hasClass("reveal")&&i.hide(),[i,r,o]}),this.autoAdvance=this.attr("step")==="auto",this.$steps[0].show(),this.$dots[0].addClass("on"),this.setupSlide(0)}setup(e,i,n){var o;let r=(o=n==null?void 0:n.scores)==null?void 0:o.filter(a=>a.startsWith("slide-")).length;if(r&&r<this.$steps.length-1){this.go(r);for(let a=1;a<=r;++a)this.trigger("next",a)}this.on("next",a=>e.score("slide-"+(a-1)))}go(e){if(this.locked||e<0||e>this.length-1||e===this.current)return;this.locked=!0,setTimeout(()=>this.locked=!1,600),this.$back.setClass("disabled",e===0),this.$next.setClass("disabled",e===this.length-1),this.$dots[this.current].removeClass("on"),this.$dots[e].addClass("on"),this.$steps[e].show();let i=this.$steps[e].height+"px";this.$steps[e].hide(),this.$steps[this.current].exit("fade",300).promise.then(()=>this.$steps[e].enter("fade",300)),this.$legend.animate({height:i},600).promise.then(()=>this.$legend.css("height","auto")),this.setupSlide(e),this.current=e,this.trigger("step",e)}setupSlide(e){this.$next.setAttr("disabled","true"),this.blanks[e].then(()=>this.$next.removeAttr("disabled"));for(let[i,n,r]of this.reveals){if(i.hasClass("reveal"))continue;let o=i.css("visibility")!=="hidden",a=e>=n[0]&&e<=n[1];a&&!o&&i.enter(...r,300),!a&&o&&i.exit(...r)}}goNext(){this.locked||(this.go(this.current+1),this.trigger("next",this.current))}goBack(){this.locked||(this.go(this.current-1),this.trigger("back",this.current))}};Sn=$([P("x-slideshow",{template:Hl})],Sn);var Mn=class extends S{ready(){var g,x;(g=k(".sidebar-toggle"))==null||g.on("click",()=>this.addClass("open")),(x=k(".sidebar-shadow"))==null||x.on("pointerdown",()=>this.removeClass("open"));let s=k("#feedback form"),e=k("#feedback button"),i=k("#feedback .error"),n=k("#feedback-success"),r=k('#feedback textarea[name="message"]'),o=k("x-course").id;s==null||s.on("submit",u=>{u.preventDefault(),e.setAttr("disabled","true"),i.hide(),Ae(`/course/${o}/feedback`,s.formData).then(()=>{n.open(),r.value=""}).catch(()=>i.show()).then(()=>e.removeAttr("disabled"))});let a=JSON.parse(k("#glossary").text),h=k("#glossary-search"),l=h.$(".gloss-body"),p=h.$(".gloss-list"),f=h.$(".gloss-search input"),m;for(let u of Object.keys(a).sort()){let v=a[u],b=d("div",{class:"gloss-item",html:v.title,tabindex:0},p);b.on("click",()=>{m&&m.removeClass("on"),m=b,b.addClass("on"),l.html=v.text});let E=v.title.toLowerCase();f.change(M=>b.setClass("hidden",!!M&&E.indexOf(M.toLowerCase())<0))}}};Mn=$([P("x-course-sidebar")],Mn);function Jo(t,s){let e=Bi(t.map(i=>i.h+10));for(let[i,n]of t.entries())n.drag.bounds=new ut(0,0,0,L(e)),n!==s&&n.drag.setPosition(0,e[i-1]||0)}function Wf(t){return t.every((s,e)=>s.index===e)||t.every((s,e)=>s.index===t.length-e-1)}var Cn=class extends S{ready(){this.items=this.children.map(e=>({drag:new es(e,{moveX:!1,useTransform:!0}),index:+e.data.index,h:0}));for(let e of this.children)e.removeAttr("data-index");for(let e of this.items)e.drag.on("drag",()=>{this.items=si(this.items,i=>i.drag.position.y-(i===e?10:0)),Jo(this.items,e)}),e.drag.on("end",()=>{Jo(this.items),Wf(this.items)&&this.solve()});w.onResize(()=>{for(let i of this.items)i.h=i.drag.$el.height;let e=D(this.items.map(i=>i.h));this.css("height",e+this.items.length*10-10+"px"),Jo(this.items)})}setup(e,i,n){var r;(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(),this.one("solve",()=>{e.addHint("correct"),e.score(i)})}solve(){this.trigger("solve"),this.addClass("solved");for(let e of this.items)e.drag.disabled=!0}};Cn=$([P("x-sortable")],Cn);function jl(t,s=!1){return O(this,null,function*(){if(t.css("visibility")==="visible")return;t.data.display="visibility";let e=+t.data.duration||400,i=(s?0:600)+(+t.data.delay||0);yield t.enter(t.data.animation||"fade",e,i).promise,t.css({opacity:"",transform:""}),t.trigger("reveal"),t.removeClass("reveal")})}var kn=class extends S{constructor(){super(...arguments);this.model=Ht({});this.isShown=!1;this.isCompleted=!1;this.scores=new Set}ready(){var i,n,r,o;this.$course=this.parents("x-course")[0],this.$blanks=this.$$("x-blank, x-blank-mc"),this.$components=this.$$("[goal]"),this.userData=(r=(n=(i=this.$course)==null?void 0:i.userData)==null?void 0:n.steps)==null?void 0:r[this.id],this.goals=K(this.attr("goals")),this.$reveals=this.$$(".reveal");let e=this.$$(".check[data-when]");for(let a of[...this.$reveals,...e])this.onScore(a.data.when,()=>jl(a));this.$nextBtn=this.$$(".next-step");for(let[a,h]of this.$nextBtn.entries())this.onScore("next-"+a,()=>h.exit("pop")),h.one("click",()=>this.score("next-"+a));for(let a of this.$$(".step-target"))a.tagName!=="X-TARGET"&&bs(a,{enter:()=>{let h=this.$$('[target~="'+a.data.to+'"]');for(let l of h)l.addClass("focus");this.addClass("focus"),this.trigger("target-focus",{$targets:h})},exit:()=>{for(let h of this.$$(".focus"))h.removeClass("focus");this.removeClass("focus")}});for(let a of this.$$(".var, .var-action"))a.bindModel(this.model);(o=this.$course)!=null&&o.audio&&(this.narration=new an(this.$course.audio,this))}show(){var n,r,o;if(this.isShown)return;this.isShown=!0,(n=StepFunctions==null?void 0:StepFunctions[qi(this.id)])==null||n.call(StepFunctions,this);for(let a of this.$components)a.setup(this,a.attr("goal"),this.userData);let e=((r=this.userData)==null?void 0:r.scores)||[];for(let a of e)this.score(a,!1);let i=this.$$("x-gesture[target]");setTimeout(()=>{if(!this.isReady)for(let a of i)a.start()},2e3),(o=this.$course)==null||o.log("Step","show",this.id),this.trigger("show"),this.addClass("on"),this.narration&&setTimeout(()=>this.narration.play(),400)}complete(){if(!this.isCompleted){this.isShown||this.show(),this.isCompleted=!0;for(let e=0;e<this.$nextBtn.length;++e)this.score("next-"+e);for(let e of this.$reveals)e.parents("svg").length||jl(e,!0);this.trigger("complete")}}get isReady(){return this.goals.every(e=>this.scores.has(e))}get isPageLoaded(){return this.$course?this.$course.isReady:!0}score(e,i=!0){this.scores.has(e)||(this.scores.add(e),this.trigger("score-"+e),this.trigger("score"),this.$course&&(this.$course.trigger("score"),this.$course.saveProgress({steps:{[this.id]:{scores:[e]}}}),this.$course.log("Step","score",this.id+"/"+e)),i&&this.isReady&&this.$course&&this.$course.isReady&&setTimeout(()=>{this.$course.$activeStep===this&&this.$course.nextStep()},1200))}storeData(e,i){var n;(n=this.$course)==null||n.saveProgress({steps:{[this.id]:{data:{[e]:i}}}})}onScore(e,i){let n=K(e);if(n.every(a=>this.scores.has(a)))return i&&i(),Promise.resolve();let r=Ne(),o=()=>{!n.every(a=>this.scores.has(a))||(i&&i(),r.resolve(),this.off("score",o))};return this.on("score",o),r.promise}addHint(e,i={}){var n,r,o;return this.trigger("hint",e),(n=this.$course)!=null&&n.isReady?this.isInViewport?(r=this.$course.$tutor)==null?void 0:r.showHint(e,i):(this.one("enterViewport",()=>{var a;return(a=this.$course.$tutor)==null?void 0:a.showHint(e,i)}),{text:((o=this.$course.$tutor)==null?void 0:o.hints[e])||e}):{text:e}}delayedHint(e,i=1e4){let n=setTimeout(e,i);this.on("score",()=>{clearTimeout(n),this.isCompleted||(n=setTimeout(e,i))}),this.on("complete",()=>clearTimeout(n))}get nextStep(){if(!this.$course)return;let e=this.$course.$steps.indexOf(this);return this.$course.$steps[e+1]}groupBlanks(...e){let i=e.map(n=>this.$blanks[n]);for(let n of i)n.linkedBlanks=i}};kn=$([P("x-step")],kn);var Kf='<div class="titles"></div><div class="body"><slot></slot></div>',An=class extends S{constructor(){super(...arguments);this.$titles=[];this.active=0}ready(){let e=this.$(".titles");this.$body=this.$(".body"),this.$tabs=this.$$(".tab");for(let i=0;i<this.$tabs.length;++i){let n=this.$tabs[i].$("h3")||d("h3");n.setAttr("tabindex","0"),e.append(n),this.$titles.push(n),n.on("click",()=>this.makeActive(i))}this.$titles[0].addClass("active"),this.$tabs[0].show()}makeActive(e){if(this.active===e)return;this.$titles[this.active].removeClass("active"),this.$titles[e].addClass("active"),this.$tabs[e].show();let i=this.$tabs[e].outerHeight+"px";this.$tabs[e].hide(),this.$tabs[this.active].exit("fade",300).promise.then(()=>this.$tabs[e].enter("fade",300)),this.$body.animate({height:i},600).promise.then(()=>this.$body.css("height","auto")),this.active=e,this.trigger("change",e)}};An=$([P("x-tabbox",{template:Kf})],An);var Ul='<defs><mask id="masking"><rect width="100%" height="100%" fill="white"></rect></mask></defs><marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><rect x="0" y="0" width="100%" height="100%" mask="url(#masking)" opacity="0.8"></rect><path class="target-arrow" stroke-width="5" marker-end="url(#arrow)" opacity="0.4" stroke-linecap="round"></path>';function Xf(t,s,e,i){let n=new c(t.left-15,t.top+e-15),r=new R(n,t.width+30,t.height+30),o=new c(s.left-15,s.top+i-15),a=new R(o,s.width+30,s.height+30),h=new X(r.center,a.center);return[Z(h,r)[0],Z(h,a)[0]]}function Yf(t,s){return Math.abs(t[0]-s[0])+Math.abs(t[1]-s[1])}var Wl=ve("header, x-tutor, .sidebar"),Ms=d("svg",{class:"target-body",html:Ul},A),Zf=Ms.$("mask"),Qf=Ms.$(".target-arrow"),Ss=!1,Kl=[],Vn=class extends S{ready(){this.setAttr("tabindex",0);let s=this.attr("to").replace(/_/g," "),e=this.hasClass("no-margins"),i,n,r,o,a=()=>{Ss=!0;let f=ve(s);if(!f.length)return;let m=f[0].hasParent(...Wl);i===void 0&&(i=this.hasParent(...Wl));let g=this.bounds,x=f.map(u=>u.bounds).filter(u=>u.width||u.height);if(r=0,!m){let u=Math.min(...x.map(M=>M.top)),v=Math.max(...x.map(M=>M.top+M.height)),b=w.height-12-v,E=56-u;r=b<0?b:E>0?E:0}for(let u of Kl)u.remove();Kl=[g,...x].map((u,v)=>{let b=!v||e?4:10;return d("rect",{x:u.left-b,y:u.top-b+(v||!i?r:0),width:u.width+2*b,height:u.height+2*b,rx:v?4:18,ry:v?4:18},Zf)}),Qf.points=Xf(g,x[0],i?0:r,m?0:r)},h=()=>{r&&A.scrollBy(-r,300),Ms.css("display","block"),w.redraw(),oe(function(){Ms.css("opacity",1)},r?300:0)},l=f=>{!Ss||f&&_(f.type,"mousemove","pointermove")&&Yf(n,[f.clientX,f.clientY])<40||(clearTimeout(o),Ss=!1,Ms.css("opacity",0),setTimeout(()=>{Ss||Ms.css("display","none")},300),A.off("mousewheel mousemove touchend touchmove",l),this.off("mouseleave blur",l))},p=()=>{r&&!i?A.on("mousemove",l):this.on("mouseleave",l),A.on("mousewheel touchend touchmove",l),this.on("blur",l)};this.on("mouseenter touchstart focus",f=>{n=[f.clientX,f.clientY],a(),o=window.setTimeout(h,r?50:30),p()}),this.on("click",f=>{Ss?(f.handled=!0,l(),setTimeout(()=>k(s).trigger("click mousedown"))):(Ss=!0,r=0,h(),p())})}};Vn=$([P("x-target")],Vn);var B=class extends Error{constructor(t,s){super(s),this.name=t}static undefinedVariable(t){return new B("EvalError",`Undefined variable \u201C${t}\u201D.`)}static undefinedFunction(t){return new B("EvalError",`Undefined function \u201C${t}\u201D.`)}static uncallableExpression(t){return new B("EvalError",`Cannot call \u201C${t}\u201D.`)}static evalLoop(t){return new B("EvalError",`Loop in nested evaluation \u201C${t}\u201D.`)}static invalidCharacter(t){return new B("SyntaxError",`Unknown symbol \u201C${t}\u201D.`)}static conflictingBrackets(t){return new B("SyntaxError",`Conflicting brackets \u201C${t}\u201D.`)}static unclosedBracket(t){return new B("SyntaxError",`Unclosed bracket \u201C${t}\u201D.`)}static startOperator(t){return new B("SyntaxError",`A term cannot start with a \u201C${t}\u201D.`)}static endOperator(t){return new B("SyntaxError",`A term cannot end with a \u201C${t}\u201D.`)}static consecutiveOperators(t,s){return new B("SyntaxError",`A \u201C${t}\u201D cannot be followed by a \u201C${s}\u201D.`)}static invalidExpression(){return new B("SyntaxError","This expression is invalid.")}},aa={pi:Math.PI,\u03C0:Math.PI,e:Math.E},ia={"(":")","[":"]","{":"}"},As={"*":"\xB7","**":"\u2217","//":"//","+-":"\xB1","\u2013":"\u2212","-":"\u2212",xx:"\xD7",sum:"\u2211",prod:"\u220F",int:"\u222B",del:"\u2202",grad:"\u2207",aleph:"\u2135",not:"\xAC",AA:"\u2200",EE:"\u2203","'":"\u2019","!=":"\u2260","<=":"\u2264",">=":"\u2265",in:"\u2208","!in":"\u2209","==":"\u2261","~=":"\u2245","~~":"\u2248",sub:"\u2282",sube:"\u2286",prop:"\u221D",oo:"\u221E",cap:"\u2229",cup:"\u222A","<-":"\u2190","->":"\u2192","=>":"\u21D2","<=>":"\u21D4","|->":"\u21A6",uarr:"\u2191",darr:"\u2193",lArr:"\u21D0"},xi={Gamma:"\u0393",Delta:"\u0394",Theta:"\u0398",Lambda:"\u039B",Xi:"\u039E",Pi:"\u03A0",Sigma:"\u03A3",Phi:"\u03A6",Psi:"\u03A8",Omega:"\u03A9",alpha:"\u03B1",beta:"\u03B2",gamma:"\u03B3",delta:"\u03B4",epsilon:"\u025B",zeta:"\u03B6",eta:"\u03B7",theta:"\u03B8",iota:"\u03B9",kappa:"\u03BA",lambda:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",pi:"\u03C0",rho:"\u03C1",sigma:"\u03C3",tau:"\u03C4",upsilon:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",omega:"\u03C9",CC:"\u2102",NN:"\u2115",QQ:"\u211A",RR:"\u211D",ZZ:"\u2124"},ic="abcdefghijklmnopqrstuvwxyz",Jf=ic.split(""),tm=ic.toUpperCase().split(""),em=Object.values(xi),sm=[...Jf,...tm,...em,"$"],im="|()[]{}\xF7,!<>=*/+-\u2013\u2212~^_\u2026\xB0\u2022\u2225\u22A5'\u2220:%\u223C\u25B3",nm=Object.values(As),rm=[...im,...nm],om={_:"sub","^":"sup","//":"/","\xF7":"/"},Xl={"<":"&lt;",">":"&gt;"};function nc(t){return t in Xl?Xl[t]:t}var am=["abs","round","floor","ceil","max","min","mod","lcm","gcd","gcf","log","exp","ln","sqrt","root","sin","cos","tan","sec","csc","cot","cosec","cotan","arcsin","arccos","arctan","sinh","cosh","tanh","sech","csch","coth","cosech"];function as(t){return am.includes(t)}var Vs={"+":"plus","\u2212":"minus","\xB7":"times","\xD7":"times","/":"over","//":"divided by","%":"percent","!":"factorial","\xB1":"plus-minus","=":"equals","\u2260":"does not equal","<":"is less than",">":"is greater than","\u2264":"is less than or equal to","\u2265":"is greater than or equal to",\u03C0:"pi","\u2245":"is congruent to","\u2225":"is parallel to","\u22A5":"is perpendicular to"};for(let t of Object.keys(xi))Vs[xi[t]]=t;var rc=t=>typeof t=="number"?t:t[0],oc=t=>typeof t=="number"?[t,t]:t,Fe=class{evaluate(t={},s){return NaN}interval(t={},s){return oc(this.evaluate(t))}substitute(t={}){return this}recursiveSubstitute(t){let s=Object.keys(t);return this.unknowns.filter(e=>s.includes(e)).length?this.substitute(t).recursiveSubstitute(t):this}get simplified(){return this}get unknowns(){return this.variables.filter(t=>!Object.prototype.hasOwnProperty.call(aa,t))}get variables(){return[]}get functions(){return[]}collapse(){return this}toString(){return""}toVoice(t={}){return""}toMathML(t={}){return""}},ta=new Set;function na(t,s,e=!1){var i;let n=(i=s[t])!=null?i:aa[t];if(n===void 0)throw B.undefinedVariable(t);if(typeof n=="string"||n instanceof Fe){if(e||ta.clear(),ta.has(t))throw B.evalLoop(t);return ta.add(t),typeof n=="string"&&(n=$t.parse(n)),n.evaluate(s,!0)}else return typeof n=="function"?n():n}var bi=class extends Fe{constructor(t){super(),this.n=t}evaluate(){return this.n}toString(){return`${this.n}`}toVoice(){return`${this.n}`}toMathML(){return`<mn>${this.n}</mn>`}},Is=class extends Fe{constructor(t){super(),this.i=t}evaluate(t={},s){return rc(na(this.i,t,s))}interval(t={},s){return oc(na(this.i,t,s))}toMathML(){return`<mi${as(this.i)?' mathvariant="normal"':""}>${this.i}</mi>`}substitute(t={}){return t[this.i]||this}get variables(){return[this.i]}toString(){return this.i}toVoice(){return this.i in Vs?Vs[this.i]:this.i.length===1?`_${this.i}_`:this.i}},hm=class extends Fe{constructor(t){super(),this.s=t}evaluate(t={},s){return rc(na(this.s,t,s))}toString(){return`"${this.s}"`}toVoice(){return this.s}toMathML(){return`<mtext>${this.s}</mtext>`}},ac=class extends Fe{toString(){return" "}toMathML(){return"<mspace></mspace>"}},$e=class extends Fe{constructor(t){super(),this.o=t}toString(){return this.o.replace("//","/")}toVoice(){return Vs[this.o]||this.o}get functions(){return[this.o]}toMathML(){let t=nc(this.toString());return`<mo value="${t}">${t}</mo>`}},Yl=[-1/0,1/0],ks=[NaN,NaN],rs=Math.PI/2,ra=Math.PI*2,rt=(t,s)=>[t-Number.EPSILON,s+Number.EPSILON],os=(...t)=>rt(Math.min(...t),Math.max(...t)),lm=t=>Math.abs(t[1]-t[0]);var Cs=t=>isNaN(t[0])||isNaN(t[1]),Zl=t=>!isFinite(t[0])&&t[0]===t[1],cm=(t,s)=>ct(s,t[0]-Number.EPSILON,t[1]+Number.EPSILON),Rn=t=>cm(t,0),be={add:(...t)=>t.reduce((s,e)=>s+e,0),sub:(...t)=>t.length>1?t[0]-t[1]:-t[0],mul:(...t)=>t.reduce((s,e)=>s*e,1),div:(t,s)=>t/s,abs:t=>Math.abs(t),round:t=>Math.round(t),floor:t=>Math.floor(t),ceil:t=>Math.ceil(t),max:(...t)=>Math.max(...t),min:(...t)=>Math.min(...t),mod:(t,s)=>t%s,lcm:(...t)=>ni(...t),gcd:(...t)=>De(...t),gcf:(...t)=>De(...t),sup:(t,s)=>Math.pow(t,s),log:(t,s)=>Math.log(t)/(s===void 0?1:Math.log(s)),exp:t=>Math.exp(t),ln:t=>Math.log(t),sqrt:t=>Math.sqrt(t),root:(t,s)=>Math.pow(t,1/s),sin:t=>Math.sin(t),cos:t=>Math.cos(t),tan:t=>Math.tan(t),sec:t=>1/Math.cos(t),csc:t=>1/Math.sin(t),cot:t=>1/Math.tan(t),cosec:t=>be.csc(t),cotan:t=>be.cot(t),arcsin:t=>Math.asin(t),arccos:t=>Math.acos(t),arctan:t=>Math.atan(t),sinh:t=>Math.sinh(t),cosh:t=>Math.cosh(t),tanh:t=>Math.tanh(t),sech:t=>1/Math.cosh(t),csch:t=>1/Math.sinh(t),coth:t=>1/Math.tanh(t),cosech:t=>be.csch(t)};function In(t,s){if(t[0]>0)return s[0]>=0?rt(t[0]**s[0],t[1]**s[1]):os(t[0]**s[0],t[0]**s[1],t[1]**s[0],t[1]**s[1]);let e=s[0];return Number.isInteger(e)&&e===s[1]?e===0?[Rn(t)?0:1,1]:e%2?rt(t[0]**e,t[1]**e):Rn(t)?[0,Math.max(t[0]**e,t[1]**e)]:os(t[1]**e,t[0]**e):ks}function Ql(t,s=ra){let e=Math.floor(t[0]/s)*s;return[t[0]-e,t[1]-e]}var N={add:(...t)=>rt(D(t.map(s=>s[0])),D(t.map(s=>s[1]))),sub:(t,s)=>s!==void 0?rt(t[0]-s[1],t[1]-s[0]):rt(-t[1],-t[0]),mul:(t,...s)=>(s.length>1&&(s=[N.mul(...s)]),os(t[0]*s[0][0],t[0]*s[0][1],t[1]*s[0][0],t[1]*s[0][1])),div:(t,s)=>Rn(s)?Yl:os(t[0]/s[0],t[0]/s[1],t[1]/s[0],t[1]/s[1]),abs:t=>Rn(t)?rt(0,Math.max(-t[0],t[1])):os(Math.abs(t[0]),Math.abs(t[1])),round:t=>rt(Math.round(t[0]),Math.round(t[1])),floor:t=>rt(Math.floor(t[0]),Math.floor(t[1])),ceil:t=>rt(Math.ceil(t[0]),Math.ceil(t[1])),max:(...t)=>rt(Math.max(...t.map(s=>s[0])),Math.max(...t.map(s=>s[1]))),min:(...t)=>rt(Math.min(...t.map(s=>s[0])),Math.min(...t.map(s=>s[1]))),mod:(t,s)=>{if(Cs(t)||Cs(s))return ks;let e=t[0]/(t[0]<0?s[0]:s[1]);return e=e<0?Math.ceil(e):Math.floor(e),N.sub(t,N.mul(s,[e,e]))},lcm:(...t)=>os(ni(...t.map(s=>s[0]))),gcd:(...t)=>os(De(...t.map(s=>s[0]))),gcf:(...t)=>N.gcd(...t),sup:(t,s)=>In(t,s),log:(t,s)=>(s!==void 0&&N.div(N.log(t),N.log(s)),rt(t[0]<=0?-1/0:Math.log(t[0]),Math.log(t[1]))),exp:t=>In([Math.E,Math.E],t),ln:t=>N.log(t),sqrt:t=>In(t,[.5,.5]),root:(t,s)=>In(t,N.div([1,1],s)),sin:t=>N.cos(N.sub(t,[rs,rs])),cos:t=>Cs(t)||Zl(t)?ks:lm(t)>=ra-Number.EPSILON?[-1,1]:(t=Ql(t),t[0]>Math.PI+Number.EPSILON?N.sub(N.cos(N.sub(t,[Math.PI,Math.PI]))):t[1]<Math.PI-Number.EPSILON?rt(Math.cos(t[1]),Math.cos(t[0])):t[1]<ra-Number.EPSILON?rt(-1,Math.max(Math.cos(t[1]),Math.cos(t[0]))):rt(-1,1)),tan:t=>Cs(t)||Zl(t)?ks:(t=Ql(t,Math.PI),t[0]>rs+Number.EPSILON&&(t=N.sub(t,[Math.PI,Math.PI])),t[0]<-rs+Number.EPSILON||t[1]>rs-Number.EPSILON?Yl:rt(Math.tan(t[0]),Math.tan(t[1]))),sec:t=>N.div([1,1],N.cos(t)),csc:t=>N.div([1,1],N.sin(t)),cot:t=>N.div([1,1],N.tan(t)),cosec:t=>N.csc(t),cotan:t=>N.cot(t),arcsin:t=>Cs(t)||t[1]<-1||t[0]>1?ks:rt(t[0]<=-1?-rs:Math.asin(t[0]),t[1]>=1?rs:Math.asin(t[1])),arccos:t=>Cs(t)||t[1]<-1||t[0]>1?ks:rt(t[1]>=1?0:Math.acos(t[1]),t[0]<=-1?Math.PI:Math.acos(t[0])),arctan:t=>rt(Math.atan(t[0]),Math.atan(t[1])),sinh:t=>rt(Math.sinh(t[0]),Math.sinh(t[1])),cosh:t=>t[1]<0?rt(Math.cosh(t[1]),Math.cosh(t[0])):t[0]>0?rt(Math.cosh(t[0]),Math.cosh(t[1])):rt(1,Math.cosh(Math.max(-t[0],t[1]))),tanh:t=>rt(Math.tanh(t[0]),Math.tanh(t[1])),sech:t=>N.div([1,1],N.cosh(t)),csch:t=>N.div([1,1],N.sinh(t)),coth:t=>N.div([1,1],N.tanh(t)),cosech:t=>N.csch(t)},On=K("+ \u2212 * \xD7 \xB7 / \xF7 // sup sub subsup"),Jl=K("sub sup subsup"),ea='<mo value="," lspace="0">,</mo>';function hc(t,s){return On.includes(s)?t instanceof Ln?!0:!(t instanceof Tt)||!On.includes(t.fn)?!1:Jl.includes(t.fn)&&Jl.includes(s)?!0:On.indexOf(s)>On.indexOf(t.fn):!1}function pm(t,s,e){return hc(t,s)?`<mfenced>${e}</mfenced>`:e}function ze(t,s){return t instanceof Ln||t instanceof Tt?`<mrow>${s}</mrow>`:s}function tc(t){return t==="2"?"squared":t==="3"?"cubed":`to the power of ${t}`}var Tt=class extends Fe{constructor(t,s=[]){super(),this.fn=t,this.args=s}evaluate(t={}){let s=this.args.map(e=>e.evaluate(t));if(this.fn in t){let e=t[this.fn];if(typeof e=="function")return e(...s);if(typeof e=="number"&&s.length===1)return be.mul(e,s[0]);throw B.uncallableExpression(this.fn)}if(this.fn==="+")return be.add(...s);if(this.fn==="\u2212")return be.sub(...s);if(["*","\xB7","\xD7"].includes(this.fn))return be.mul(...s);if(this.fn==="/")return be.div(...s);if(this.fn==="sup")return be.sup(...s);if(as(this.fn))return be[this.fn](...s);if(this.fn==="(")return s[0];throw B.undefinedFunction(this.fn)}interval(t={}){let s=this.args.map(e=>e.interval(t));if(this.fn in t){let e=t[this.fn];if(typeof e=="function")return Zt(e(...s.map(i=>i[0])),2);if(typeof e=="number"&&s.length===1)return N.mul([e,e],s[0]);if(Array.isArray(e)&&s.length===1)return N.mul(e,s[0]);throw B.uncallableExpression(this.fn)}if(this.fn==="+")return N.add(...s);if(this.fn==="\u2212")return N.sub(...s);if(["*","\xB7","\xD7"].includes(this.fn))return N.mul(...s);if(this.fn==="/")return N.div(...s);if(this.fn==="sup")return N.sup(...s);if(as(this.fn))return N[this.fn](...s);if(this.fn==="(")return s[0];throw B.undefinedFunction(this.fn)}substitute(t={}){return new Tt(this.fn,this.args.map(s=>s.substitute(t)))}collapse(){return this.fn==="("?this.args[0].collapse():new Tt(this.fn,this.args.map(t=>t.collapse()))}get simplified(){return this}get variables(){return Pt(Qt(this.args.map(t=>t.variables)))}get functions(){return Pt([this.fn,...Qt(this.args.map(t=>t.functions))])}toString(){let t=this.args.map(s=>hc(s,this.fn)?`(${s.toString()})`:s.toString());return this.fn==="\u2212"?t.length>1?t.join(" \u2212 "):`\u2212${t[0]}`:this.fn==="sup"?t.join("^"):this.fn==="sub"?t.join("_"):this.fn==="subsup"?`${t[0]}_${t[1]}^${t[2]}`:K("+ * \xD7 \xB7 / = < > \u2264 \u2265 \u2248").includes(this.fn)?t.join(` ${this.fn} `):_(this.fn,"(","[","{")?this.fn+this.args.join(", ")+ia[this.fn]:_(this.fn,"!","%")?t[0]+this.fn:`${this.fn}(${t.join(", ")})`}toMathML(t={}){let s=this.args.map(n=>n.toMathML(t)),e=this.args.map((n,r)=>pm(n,this.fn,s[r]));if(this.fn in t){let n=s.map((r,o)=>({toString:()=>r,val:this.args[o]}));return t[this.fn](...n)}if(this.fn==="\u2212")return e.length>1?e.join('<mo value="\u2212">\u2212</mo>'):`<mo rspace="0" value="\u2212">\u2212</mo>${e[0]}`;if(_(this.fn,"+","=","<",">","\u2264","\u2265","\u2248")){let n=nc(this.fn);return e.join(`<mo value="${n}">${n}</mo>`)}if(_(this.fn,"*","\xD7","\xB7")){let n=e[0];for(let r=1;r<e.length-1;++r)n+=(this.args[0]instanceof bi&&this.args[1]instanceof bi?'<mo value="\xD7">\xD7</mo>':"")+e[1];return n}if(this.fn==="//")return e.join('<mo value="/">/</mo>');if(this.fn==="sqrt")return`<msqrt>${e[0]}</msqrt>`;if(_(this.fn,"/","root")){let n=this.fn==="/"?"mfrac":"mroot",r=this.args.map((o,a)=>ze(o,s[a]));return`<${n}>${r.join("")}</${n}>`}if(_(this.fn,"sup","sub")){let n=[ze(this.args[0],e[0]),ze(this.args[1],s[1])];return`<m${this.fn}>${n.join("")}</m${this.fn}>`}return this.fn==="subsup"?`<msubsup>${[ze(this.args[0],e[0]),ze(this.args[1],s[1]),ze(this.args[2],s[2])].join("")}</msubsup>`:_(this.fn,"(","[","{")?`<mfenced open="${this.fn}" close="${ia[this.fn]}">${e.join(ea)}</mfenced>`:_(this.fn,"!","%")?`${e[0]}<mo value="${this.fn}" lspace="0">${this.fn}</mo>`:this.fn==="abs"?`<mfenced open="|" close="|">${e.join(ea)}</mfenced>`:this.fn==="bar"?`<mover>${ze(this.args[0],e[0])}<mo value="\u203E">\u203E</mo></mover>`:this.fn==="vec"?`<mover>${ze(this.args[0],e[0])}<mo value="\u2192">\u2192</mo></mover>`:`<mi${as(this.fn)?' mathvariant="normal"':""}>${this.fn}</mi><mfenced>${e.join(ea)}</mfenced>`}toVoice(t={}){let s=this.args.map(i=>i.toVoice(t)),e=s.join(" ");if(this.fn in t){let i=s.map((n,r)=>({toString:()=>n,val:this.args[r]}));return t[this.fn](...i)}return _(this.fn,"(","[","{")?e:this.fn==="sqrt"?`square root of ${e}`:this.fn==="%"?`${e} percent`:this.fn==="!"?`${e} factorial`:this.fn==="/"?`${s[0]} over ${s[1]}`:this.fn==="//"?`${s[0]} divided by ${s[1]}`:this.fn==="sub"?e:this.fn==="subsup"?`${s[0]} ${s[1]} ${tc(s[2])}`:this.fn==="sup"?`${s[0]} ${tc(s[1])}`:Vs[this.fn]?s.join(` ${Vs[this.fn]} `):as(this.fn)?`${this.fn} ${e}`:`${this.fn} of ${e}`}},Ln=class extends Fe{constructor(t){super(),this.items=t}evaluate(t={}){return this.collapse().evaluate(t)}interval(t={}){return this.collapse().interval(t)}substitute(t={}){return this.collapse().substitute(t)}get simplified(){return this.collapse().simplified}get variables(){return Pt(rh(...this.items.map(t=>t.variables)))}get functions(){return this.collapse().functions}toString(){return this.items.map(t=>t.toString()).join(" ")}toMathML(t={}){return this.items.map(s=>s.toMathML(t)).join("")}toVoice(t={}){return this.items.map(s=>s.toVoice(t)).join(" ")}collapse(){return oa(this.items).collapse()}};function sa(t,s){if(s===2)return new hm(t);if(!(!t||!s)){if(s===1&&t.length>1)return new ac;if(s===3){if(isNaN(+t))throw B.invalidExpression();return new bi(+t)}if(s===4)return t in xi?new Is(xi[t]):t in As?new $e(As[t]):new Is(t);if(s===5)return t in As?new $e(As[t]):new $e(t)}}function dm(t){let s=[],e="",i=0;for(let r of t){if(r==='"'){let a=i===2?0:2,h=sa(e,i);h&&s.push(h),e="",i=a;continue}else if(i===2){e+=r;continue}let o=r.match(/[0-9.]/)?3:sm.includes(r)?4:rm.includes(r)?5:r.match(/\s/)?1:0;if(!o)throw B.invalidCharacter(r);if(!i||i===3&&o!==3||i===4&&o!==4&&o!==3||i===5&&!(e+r in As)||i===1&&o!==1){let a=sa(e,i);a&&s.push(a),e="",i=o}e+=r}let n=sa(e,i);return n&&s.push(n),s}function um(t){return t.length>1?new Ln(t):t[0]instanceof $e?new Ln(t):t[0]}function fm(t,s){let e=[[]];for(let i of t)s(i)?e.push([]):L(e).push(i);return e}function kt(t,s){return t instanceof $e&&K(s).includes(t.o)}function yi(t){return t instanceof Tt&&t.fn==="("?t.args[0]:t}function _n(t,s){if(kt(t[0],s))throw B.startOperator(t[0]);if(kt(L(t),s))throw B.endOperator(L(t));for(let e=1;e<t.length-1;++e){if(!kt(t[e],s))continue;let i=t[e],n=t[e-1],r=t[e+1];if(n instanceof $e)throw B.consecutiveOperators(n.o,i.o);if(r instanceof $e)throw B.consecutiveOperators(i.o,r.o);let o=t[e+2];if(s==="^ _"&&kt(i,"_ ^")&&kt(o,"_ ^")&&i.o!==o.o){let a=t[e+3];if(a instanceof $e)throw B.consecutiveOperators(o.o,a.o);let h=[yi(n),yi(r),yi(a)];i.o==="^"&&([h[1],h[2]]=[h[2],h[1]]),t.splice(e-1,5,new Tt("subsup",h)),e-=4}else{let a=om[i.o]||i.o,h=[yi(n),yi(r)];t.splice(e-1,3,new Tt(a,h)),e-=2}}}function ec(t){return _n(t,"^ _"),_n(t,"/"),um(t)}function mm(t,s){let e=[[]],i=["\u03C0",...(s==null?void 0:s.variables)||[]];for(let n of t){let r=L(e).length?L(e)[0].o:void 0;if(kt(n,") ] }")){if(!kt(n,ia[r]))throw B.conflictingBrackets(n.o);let o=e.pop(),a=L(e),h=L(a),p=kt(n,")")&&h instanceof Is&&!i.includes(h.i)?a.pop().i:o[0].o,f=fm(o.slice(1),m=>kt(m,","));a.push(new Tt(p,f.map(ec)))}else kt(n,"( [ {")?e.push([n]):L(e).push(n)}if(e.length>1)throw B.unclosedBracket(L(e)[0].o);return ec(e[0])}function sc(t,s,e=!1){let i=[],n=[],r=!1;function o(){if(r)throw B.invalidExpression();!n.length||(i.push(n.length>1?new Tt(s[0],n):n[0]),n=[])}for(let a of t)if(kt(a,s)){if(r||!n.length)throw B.invalidExpression();r=!0}else if(a instanceof $e)o(),i.push(a),r=!1;else{let h=!e||a instanceof bi;if(n.length&&!r&&h)throw B.invalidExpression();n.push(a),r=!1}return o(),i}function oa(t){if(t=t.filter(e=>!(e instanceof ac)),!t.length)throw B.invalidExpression();let s=t.findIndex(e=>kt(e,"= < > \u2264 \u2265"));if(s===0)throw B.startOperator(t[0]);if(s===t.length-1)throw B.endOperator(t[0]);if(s>0){let e=oa(t.slice(0,s)),i=oa(t.slice(s+1));return new Tt(t[s].o,[e,i])}if(kt(t[0],"%!"))throw B.startOperator(t[0]);for(let e=0;e<t.length;++e)!kt(t[e],"%!")||(t.splice(e-1,2,new Tt(t[e].o,[t[e-1]])),e-=1);_n(t,"// \xF7");for(let e=1;e<t.length;++e){let i=t[e];if(i instanceof Tt&&i.fn==="/"){let n=t[e-1];if(n instanceof bi)t.splice(e-1,2,new Tt("+",[n,i])),e-=1;else if(!(n instanceof $e))throw B.consecutiveOperators(n.toString(),i.toString())}}if(t=sc(t,"\xD7 * \xB7",!0),kt(t[0],"\u2212 \xB1")&&t.splice(0,2,new Tt(t[0].o,[t[1]])),_n(t,"\u2212 \xB1"),kt(t[0],"+")&&(t=t.slice(1)),t=sc(t,"+"),t.length>1)throw B.invalidExpression();return t[0]}function gm(t,s=!1,e){let i=mm(dm(t),e);return s?i.collapse():i}function vm(t,s){try{let e=Pt([...t.variables,...s.variables]),i=t.collapse(),n=s.collapse(),r=0;for(let o=0;o<5;++o){let a={};for(let p of e)a[p]=aa[p]||Math.random()*5;let h=i.evaluate(a),l=n.evaluate(a);if(!(isNaN(h)||isNaN(l))){if(!y(h,l))return!1;r+=1}}return!!r}catch(e){return!1}}var $t={numEquals:vm,parse:us(gm)};var lc='<div class="toasts"><div class="msg-wrap"><button class="msg archie" aria-label="Virtual Tutor"><slot name="icon"></slot></button></div></div><div class="chat" data-display="flex"><div class="chat-header"><slot name="header"></slot><button class="close"><x-icon name="close" size="24"></x-icon></button></div><div class="chat-body"></div><div class="chat-footer"><div class="input" contenteditable></div><button class="hint"><x-icon name="lightbulb" size="24"></x-icon></button></div></div>';var wm=/[0-9+\-*/()^\s]+/g,ym=Ke(Ot.shuffle(["happy","spongebob","sloth","party","robot","excited","cute","highfive1","applause","highfive2"])),xm=Ke(Ot.shuffle(["minions","panther","dog","snape","what","door","horrible"]));function ha(t,s,e={}){let i=d("div",{class:"msg-wrap","data-display":"flex"}),n=d("div",{class:"msg "+s},i);return e.class&&n.addClass(e.class),e.visible||i.hide(),_(s,"hint","question")?n.html=t:s==="img"?n.css("background-image",`url(${t})`):s==="video"&&d("iframe",{src:t,allowfullscreen:!0},n),i}var Nn=class extends S{constructor(){super(...arguments);this.recentMessages=[];this.isOpen=!1;this.queuePromise=Promise.resolve()}ready(){var r;this.$course=this.parents("x-course")[0],this.hints=this.$course?JSON.parse(this.$course.$("#hints").text):{};let e=window.user;this.correct=Ke(Ot.shuffle(this.hints.correct||[])),this.incorrect=Ke(Ot.shuffle(this.hints.incorrect||[])),this.$toasts=this.$(".toasts"),this.$chat=this.$(".chat"),this.$chatBody=this.$(".chat-body"),this.$toasts.on("click",o=>{o.handled||this.open()}),this.$(".close").on("click",()=>this.close());let i=this.$(".chat-footer");if(this.$query=i.$(".input"),this.$query.onKey("Enter",o=>{o.preventDefault(),this.askQuestion(this.$query.text.trim()),this.$query.text=""}),this.$query.on("focus",()=>i.addClass("focus")),this.$query.on("blur",()=>i.removeClass("focus")),this.$(".hint").on("click",()=>{this.queue(this.hints.tutorial1),this.queue(e?this.hints.tutorial2:this.hints.account)}),this.$course&&((r=this.$course.userData)==null?void 0:r.messages))for(let o of this.$course.userData.messages)this.$chatBody.append(ha(o.content,o.kind||"hint",{visible:!0}));if(!w.getCookie("sessionWelcome")&&this.$course){w.setCookie("sessionWelcome",1,60*60*4);let o=new Date().getHours(),a=o<12?"Morning":o<18?"Afternoon":"Evening";e?setTimeout(()=>this.showHint(`welcome${a}Named`,{variables:{name:e.shortName}}),3e3):w.getCookie("welcome")?(setTimeout(()=>this.showHint(`welcome${a}`),3e3),setTimeout(()=>this.queue(this.hints.account),4500)):(w.setCookie("welcome",1),setTimeout(()=>this.queue(this.hints.welcome),3e3),setTimeout(()=>this.queue(this.hints.tutorial1),4500))}}open(){this.isOpen||(this.isOpen=!0,this.$chat.enter("slide-up",200),this.$chatBody.scrollTop=this.$chatBody.scrollHeight,this.trigger("open"))}close(){!this.isOpen||(this.isOpen=!1,this.$query.blur(),this.trigger("close"),this.$chat.exit("slide-down",200))}queue(e,i="hint",n={}){this.queuePromise=this.queuePromise.then(()=>(this.display(e,i,n),ei(500)))}display(e,i="hint",n={}){let r=n.timeout||8e3;if(w.width<640&&(r*=.7),(n.toast==null?!0:n.toast)&&!this.isOpen){let h=ha(e,i,n);h.setAttr("role","alert"),this.$toasts.append(h),h.enter("reveal-right"),setTimeout(()=>h.exit("reveal-right",400,0,!0),r),this.on("open",()=>h.exit("reveal",200,0,!0))}let a=ha(e,i,{class:n.class,visible:!this.isOpen});this.$chatBody.append(a),this.isOpen&&(a.enter("reveal",300),dt(()=>this.$chatBody.scrollTop=this.$chatBody.scrollHeight,200))}showHint(e,i={}){if(_(e,"correct","incorrect")){let r=e==="correct"?this.correct():this.incorrect(),o=e==="correct"?3e3:5e3;if(this.queue(r,"hint",{class:i.class||e,timeout:o}),Math.random()<.2){let a=e==="correct"?ym():xm(),h="";this.queue(`${h}/images/gifs/${a}.gif`,"img",{timeout:o})}return{text:r}}let n=this.hints[e]||e;if(i.variables)for(let[r,o]of Object.entries(i.variables))n=n.replace(new RegExp("\\$"+r,"g"),o);return!i.force&&this.recentMessages.includes(e)?{text:n}:(this.recentMessages.push(e),setTimeout(()=>this.recentMessages.shift(),1e4),i.store!==!1&&this.$course&&this.$course.saveProgress({hints:[{content:n,kind:"hint"}]}),this.queue(n,"hint",{class:i.class}),{text:n})}askQuestion(e){if(!e)return;this.queue(e,"question"),this.$course&&this.$course.log("Tutor","ask",e);let i=(e.match(wm)||[]).filter(n=>n.length>=3&&!n.match(/^[\s0-9]+$/));if(i.length)try{let n=$t.parse(i[0],!0),r=$t.parse("="+n.evaluate());return this.queue(`<span class="math">${n.toMathML()}${r.toMathML()}</span>`)}catch(n){console.log("Parse Error:",i[0])}this.$chatBody.addClass("loading"),Ae(this.attr("api"),{query:e}).then(n=>{this.$chatBody.removeClass("loading");let r=JSON.parse(n);for(let o of r)this.queue(o.content,o.kind)}).catch(n=>{this.$chatBody.removeClass("loading"),this.queue(this.hints.serverError),console.error("Tutor Error:",n)})}};Nn=$([P("x-tutor",{template:lc})],Nn);var cc='<div class="left" tabindex="0"><x-icon name="left" size="14"></x-icon></div><div class="content"><slot></slot></div><div class="right" tabindex="0"><x-icon name="right" size="14"></x-icon></div><div class="bubble"><div class="bubble-box"><div class="progress"></div></div><div class="bubble-arrow"></div></div>';var pc=d("div",{class:"var-overlay"},A),Dn=class extends S{constructor(){super(...arguments);this.valueChange=!1}ready(){let e=this.attr("bind");if(!e)return;let[i,n,r]=e.split("|");[this.min,this.max,this.step]=r.split(",").map(l=>+l),this.name=i,this.model=this.getParentModel(),this.$(".content").bindModel(this.model),this.$progress=this.$(".progress"),this.setValue(+n);let o=20*(w.isMobile?1.5:1)/G((this.max-this.min)/this.step/12,1,3),a=0,h=0;for(let l of this.$$(".left, .right")){let p=l.hasClass("left")?-this.step:this.step;l.on("click",()=>{this.setValue(this.value+p),this.trigger("slide-end")})}Je(this,{start:l=>{a=l.x,h=this.value,this.addClass("on"),this.valueChange=!1,pc.show(),xt.addClass("grabbing")},move:l=>{let p=(l.x-a)/o;this.setValue(h+ae(p)*this.step)},end:()=>{this.removeClass("on"),this.valueChange&&this.trigger("slide-end"),pc.hide(),xt.removeClass("grabbing")}})}setup(e,i){this.one("slide-end",()=>e.score(i))}setValue(e){let i=ae(G(e,this.min,this.max),2);if(i===this.value)return;this.value=i,this.valueChange=!0,this.model&&(this.model[this.name]=i);let n=this.max-this.min;this.$progress.css("width",116*(i-this.min)/n+"px")}};Dn=$([P("x-var",{template:cc})],Dn);var dc='<button class="play-btn-box" aria-label="Play"><x-icon name="play" size="44"></x-icon></button>';var Gn=class extends S{constructor(){super(...arguments);this.visible=!0}ready(){this.on("click",()=>{this.play(),setTimeout(()=>this.trigger("play"),400)})}play(){!this.visible||(this.visible=!1,this.exit("pop",400))}reset(){this.visible||(this.visible=!0,setTimeout(()=>this.enter("pop"),400))}};Gn=$([P("x-play-btn",{template:dc})],Gn);var Bn=class extends S{constructor(){super(...arguments);this.playing=!1}ready(){this.$icon=this.$("x-icon"),this.$("button").on("click",()=>this.toggle())}toggle(){this.playing?this.pause():this.play()}play(){this.playing||(this.playing=!0,this.$icon.setAttr("name","pause"),this.trigger("play"))}pause(){!this.playing||(this.playing=!1,this.$icon.setAttr("name","play"),this.trigger("pause"))}};Bn=$([P("x-play-toggle",{template:'<button class="icon-btn"><x-icon name="play"></x-icon></button>'})],Bn);var uc='<div class="video-wrap"><video playsinline></video></div><div class="credit"></div><x-play-btn></x-play-btn><div class="controls"><div class="shadow"></div><button class="play-pause-btn" tabindex="0" aria-label="Play video"><div class="play-icon"><x-icon name="play" size="32"></x-icon></div><div class="pause-icon"><x-icon name="pause" size="32"></x-icon></div></button><div class="timeline"><div class="bar"><div class="background"></div><div class="buffer"></div><div class="progress"></div></div><div class="handle"></div></div><div class="timecode"></div></div>';function fc(t){let s=Math.floor(t/60),e=Math.floor(t%60);return s+":"+(e<10?"0":"")+e}var qn=class extends S{ready(){let e=this.attr("src"),i=this.$(".video-wrap"),n=this.$("video"),r=this.attr("width"),o=this.attr("height");this.css("width",r+"px"),i.css("padding-bottom",+o/+r*100+"%"),n.setAttr("poster",this.attr("poster")||e.replace(/mp4$/,"jpg")),this.hasAttr("loop")&&(n._el.loop=!0),this.hasAttr("audio")||(n._el.muted=!0),n._el.preload=this.attr("preload")==="no"?"metadata":"auto",d("source",{src:e,type:"video/mp4"},n),this.hasAttr("credit")&&(this.$(".credit").text=this.attr("credit"));let a=this.$(".bar"),h=this.$(".progress"),l=this.$(".buffer"),p=this.$(".timecode"),f=new es(this.$(".handle"),{$parent:a,moveY:!1}),m=this.video=n._el,g=this.width-110;w.onResize(()=>g=this.width-110),n.on("canplay",()=>{p.text=fc(+m.duration)}),n.on("timeupdate",()=>{let v=m.currentTime/m.duration;h.css("width",v*100+"%"),p.text=fc(+m.currentTime),f.setPosition(v*g,0),this.trigger("timeupdate",m.currentTime)}),n.on("progress",()=>{if(m.buffered.length<=0||m.duration<=0)return;let b=m.buffered.end(m.buffered.length-1)/m.duration*100;l.css("width",b+"%")}),n.on("ended",()=>{m.pause(),this.removeClass("playing"),this.trigger("end")});let x=()=>m.paused?this.play():this.pause(),u=v=>this.setTime(v/g*m.duration);this.hasAttr("hover")?(n.on("mouseover touchstart",()=>this.play()),n.on("mouseout touchend touchcancel",()=>this.pause())):n.on("click",x),this.hasAttr("controls")&&(this.$(".controls").show(),this.$(".play-pause-btn").on("click",x),f.on("start",()=>this.pause()),f.on("drag",({posn:v})=>u(v.x)),a.on("click",v=>u(v.offsetX)))}setTime(e){this.video.currentTime=e}play(){this.video.play(),this.addClass("playing"),this.trigger("play")}pause(){this.video.pause(),this.removeClass("playing")}};qn=$([P("x-video",{template:uc})],qn);var zn=class extends S{constructor(){super(...arguments);this.isCompleted=!1;this.isReady=!1}created(){this.userData=window.progressData||JSON.parse(this.$("#userdata").text)||{},this.$steps=this.$$("x-step");for(let e of this.$steps)e.on("score",()=>this.trigger("score"));this.data.audio&&(this.audio=new on(this.data.audio))}ready(){this.$footer=this.$("footer"),this.$skipStep=this.$footer.$(".skip-step"),this.$progress=this.$(".sidebar-row.active x-progress"),this.$tutor=this.$("x-tutor"),this.$stepsWrap=this.$(".steps");let e=this.findStep(w.getHash()),i=this.findStep(this.userData.activeStep);this.$activeStep=i||this.$steps[0];for(let r of this.$steps){if(r.show(),r===this.$activeStep)break;r.complete()}if(this.userData.completed||w.getHash()==="full"||this.data.reveal)this.complete();else for(;this.$activeStep&&this.$activeStep.isReady&&!this.isCompleted;)this.nextStep();(e||i&&!this.userData.completed)&&this.goToStep(e||i,!1),this.$(".section-dev")&&this.complete();let n=this.$(".reveal-banner");setTimeout(()=>{this.isCompleted||(n.removeClass("off"),this.on("score complete",()=>n.addClass("off")))},1500),n.$(".complete").one("click",()=>this.complete()),A.onKey("Space",r=>{r.preventDefault(),this.nextStep(),n.addClass("off")}),this.$footer.$(".skip").on("click",()=>this.nextStep()),this.$footer.$(".show-all").on("click",()=>this.complete()),this.$footer.show(),this.isReady=!0,setTimeout(()=>this.addClass("ready"))}nextStep(){if(this.isCompleted)return;let e=this.$activeStep,i=this.$stepsWrap.height;do{if(e.complete(),e=this.$steps[this.$steps.indexOf(e)+1],!e)return this.complete(!0);e.show()}while(e.isReady);this.$stepsWrap.animate({height:[i+"px","auto"]},800),this.$activeStep=e,this.saveProgress({activeStep:e.id})}goToStep(e,i=!0){let n=this.$stepsWrap.height;for(let a of this.$steps){if(a.isShown||(this.$activeStep=a),a.show(),e.isShown&&!a.isReady)break;a.complete()}let r=e.positionTop-Math.max(50,(w.height-e.height)/2);i?(this.$stepsWrap.animate({height:[n+"px","auto"]},800),A.scrollTo(r)):A.scrollTop=r;let o=L(this.$steps);if(o.isShown&&o.isReady)return this.complete();this.$activeStep&&this.saveProgress({activeStep:this.$activeStep.id})}complete(e=!1){if(this.isCompleted)return;this.isCompleted=!0,this.$steps.forEach(n=>n.complete()),this.$activeStep=void 0;let i=this.$footer.$(".next-section");e?(this.$skipStep.exit("fade",200),i&&i.enter("pop")):(this.$skipStep.hide(),i&&i.show()),this.trigger("complete"),this.saveProgress({completed:!0}),this.log("Course","complete")}findStep(e){for(let i of this.$steps)if(i.id===e)return i}saveProgress(e){if(!this.isReady)return;let n=D(this.$steps.map(r=>r.scores.size))/+this.data.goals||0;this.$progress.setProgress(n),rl(`/course/${this.id}/${this.data.section}`,e)}log(e,i,n){if(window.ga&&this.isReady){let r=i+(n?":"+n:"");window.ga("send","event",e,r,this.id)}}};zn=$([P("x-course")],zn);var Fn=class{constructor(){this.callbacks=[]}add(s){this.callbacks.push(s)}start(s=1e3){return dt(i=>{for(let n of this.callbacks)n(i)},s).promise}};function mc(t,s){return t.every((e,i)=>y(e,s[i]))}function gc(t,s){t.scale*=s.scale,t.x=t.x*s.scale+s.x,t.y=t.y*s.scale+s.y}function vc(t,s){return y(t.x,s.x)&&y(t.y,s.y)&&y(t.scale,s.scale)}function Hn(t,s,e){if(e==="adding"){let i=t.strokeLength,n=s<.5?0:bt("cubic-in",s*2-1);t.css({"stroke-dasharray":i+"px","stroke-dashoffset":i*(1-n)+"px"})}else if(e==="deleting"){let i=t.strokeLength,n=s<.5?bt("cubic-in",2*s):1;t.css({"stroke-dasharray":i+"px","stroke-dashoffset":i*(2-n)+"px"})}}function wc(t,s){let e=[t],i=t.expr;for(;s.startsWith(i);){if(s===i)return e;let n=L(e).next;if(!n)return;e.push(n),i+=n.expr}}function yc(t,s,e=1){let i=e*Math.abs(s.x-t.x)/3,n=c.average(t,s).shift(0,i);return function(r){let o=(1-r)**2*t.x+2*r*(1-r)*n.x+r*r*s.x,a=(1-r)**2*t.y+2*r*(1-r)*n.y+r*r*s.y;return{x:o,y:a}}}function la(t,s){return Math.max(s*t,.4)/t}function Ie(t){return t instanceof Pe&&t.children.length>1||t instanceof $i?`(${t.expr})`:t.expr}function Os(t,s){return s.length===1&&s[0].type==="mrow"?s[0]:new Pe(s,t)}var gt=class{constructor(s,e,i,n){this.type=s;this.equation=i;this.$element=n;this.children=[];this.status="";this.value="";this.customColor="";this.roundedMotion=!1;this.width=0;this.height=0;this.baseline=0;this.transform={x:0,y:0,scale:1};this.currentDimensions=[0,0,0];this.currentWorldTransform={x:0,y:0,scale:1};this.addChildren(e),n&&i.$row.append(n)}get expr(){return""}get log(){let s=this.children.map(e=>e.log);return`<${this.type}>${s.join("")}</${this.type}>`}get color(){return this.customColor||(this.parent?this.parent.color:"")}static create(s,e){let i=s.nodeName.toLowerCase();if(_(i,"mn","mi","mo","mtext")){if(s.textContent==="placeholder")return new da(e);let r=s.getAttribute("mathvariant")||void 0;return new jn(i,s.textContent||"",e,r)}if(!_(i,"mrow","mfrac","mfenced","msqrt","mroot","msub","msup","msubsup","munder","mover","munderover","mspace"))return new ga(s,e);if(i==="mfenced"&&s.getAttribute("open")==="["){let r=s.children.length,o=Qt(Array.from(s.children,h=>Array.from(h.children,l=>gt.create(l,e)))),a=new ma(o,e,r);return new Un([a],e)}let n=Array.from(s.children,r=>gt.create(r,e));switch(i){case"mrow":return new Pe(n,e);case"mfrac":return n=n.map(r=>Os(e,[r])),new ua(n,e);case"mfenced":return n=[Os(e,n)],new Un(n,e);case"msqrt":return n=[Os(e,n)],new Wn(i,n,e);case"mroot":return n=n.map(r=>Os(e,[r])),new Wn(i,n,e);case"msub":case"msup":case"msubsup":return n=n.map(r=>Os(e,[r])),new $i(i,n,e);case"munder":case"mover":case"munderover":return n=n.map(r=>Os(e,[r])),new fa(i,n,e);case"mspace":return new pa(e)}throw new Error(`Unknown element type tag ${s.nodeName}`)}get marginLeft(){return .1}get marginRight(){return .1}setTransform(s=0,e=0,i=1){this.transform.x=s,this.transform.y=e,this.transform.scale=i}get worldTransform(){let s=this,e=Object.assign({},this.transform);for(;s=s.parent;)gc(e,s.transform);return e}get index(){return this.parent?this.parent.children.indexOf(this):-1}get next(){if(!this.parent)return;let s=this.parent.children.indexOf(this);return this.parent.children[s+1]}get prev(){if(!this.parent)return;let s=this.parent.children.indexOf(this);return this.parent.children[s-1]}addChildren(s,e=this.children.length){for(let i of this.children)i.type==="placeholder"&&i.deleteFromDom();for(let i of s)i.detach(),i.parent=this;this.children.splice(e,0,...s)}insertAfter(s){let e=this.parent.children.indexOf(this);this.parent.addChildren(s,e+1)}insertBefore(s){let e=this.parent.children.indexOf(this);this.parent.addChildren(s,e)}detach(){if(this.parent){let s=this.parent.children.indexOf(this);s>=0&&this.parent.children.splice(s,1),this.parent=void 0}}deleteFromDom(){this.parent&&this.detach(),this.$element&&this.$element.remove(),this.$element=void 0;for(let s of this.children.slice(0))s.deleteFromDom()}*parents(s=!1){let e=s?this:this.parent;for(;e;)yield e,e=e.parent}hasParent(s,e=!1){return me(this.parents(e),s)}hitTest(s){let{x:e,scale:i}=this.worldTransform,n=this.marginLeft*i*this.equation.fontSize,r=this.marginRight*i*this.equation.fontSize;if(ct(s.x,e-n,e+this.width*i+n+r))return this.hitTestChildren(s)||this}hitTestChildren(s){for(let e of this.children){let i=e.hitTest(s);if(i)return i}}measure(s=1){for(let e of this.children)e.measure(s)}clean(){for(let s of this.children)s.clean()}setStatus(s){this.status=s;for(let e of this.children)e.setStatus(s)}render(s){for(let h of this.children)h.render(s);if(!this.$element)return;let e=this.currentWorldTransform,i=this.currentWorldTransform=this.worldTransform,n=this.currentDimensions,r=this.currentDimensions=[this.width,this.height,this.baseline];if(vc(e,i)&&mc(n,r)&&!this.status)return;if(!s){this.positionElement(i),this.drawElement(1,r[0],r[1],r[2],i.scale);return}this.status==="adding"&&this.positionElement(i);let o=i.y+this.baseline<this.equation.root.baseline?-1:1,a=this.roundedMotion?yc(e,i,o):void 0;this.roundedMotion=!1,s.add(h=>{if(!this.$element)return;let l=bt("cubic",h),p=_(this.status,"adding","deleting"),f=p?r[0]:wt(n[0],r[0],l),m=p?r[1]:wt(n[1],r[1],l),g=p?r[2]:wt(n[2],r[2],l),x=p?i.scale:wt(e.scale,i.scale,l);if(this.drawElement(h,f,m,g,x),!this.status){let u=a?a(l):c.interpolate(e,i,l);this.positionElement({x:u.x,y:u.y,scale:x})}})}positionElement(s){this.$element.setTransform(s,0,s.scale)}drawElement(s,e,i,n,r){}},bm="acegmnopqrsuvwxyz",hs=1.1,Rs=.2,ca=new Set(["=","\u2248","<",">","\u2264","\u2265"]),$m=document.createElement("canvas"),xc=$m.getContext("2d"),Pm=us((t,s)=>(xc.font=`${s}px "Source Sans Pro", sans-serif`,xc.measureText(t).width)),jn=class extends gt{constructor(e,i,n,r){super(e,[],n,d("text",{}));this.variant=r;this.setValue(i)}setValue(e){this.$element.text=this.value=e;let i=this.value.split("").every(r=>bm.includes(r));this.width=Pm(e,this.equation.fontSize),this.height=(hs-(i?.1:0))*this.equation.fontSize,this.baseline=this.height-Rs*this.equation.fontSize;let n=this.type==="mtext"||this.variant==="normal";this.$element.setClass("font-normal",n||as(this.value))}get expr(){return this.value==="xx"?'"xx"':this.type==="mtext"?`"${this.value}"`:this.value}get log(){return`<${this.type}>${this.value}</${this.type}>`}get marginLeft(){if(this.type==="mo")return ca.has(this.value)?this.equation.isDisplay?.5:.35:_(this.value,"\u2221","\u25B3","!","%","\u2019")||_(this.value,"\u2026","\xB0")&&this.prev&&this.prev.type==="mn"?0:.25;if(this.type==="mi"){if(this.prev&&this.prev.type==="mn")return .1;if(this.prev&&this.prev.type==="mi")return .05;if(this.prev&&this.prev.type==="mfrac")return .15}return 0}get marginRight(){return this.type==="mo"?this.equation.isDisplay&&ca.has(this.value)?.5:_(this.value,"\u2221","\u25B3")?0:this.value==="\u2212"&&(!this.prev||ca.has(this.prev.value))?.1:.25:0}positionElement(e){if(!this.$element)return;let i=(this.equation.fontSize-this.baseline)*e.scale;this.$element.setTransform({x:e.x,y:e.y-i},0,e.scale)}drawElement(e,i,n,r,o){this.status==="adding"?this.$element.setAttr("opacity",e<.5?0:bt("cubic-in",e*2-1)):this.status==="deleting"&&this.$element.setAttr("opacity",e<.5?1-bt("cubic-in",2*e):0),this.$element.css("stroke-width",(1-o)*1.5+"px"),this.$element.css("color",this.color||"currentColor")}},pa=class extends gt{constructor(s){super("mspace",[],s),this.height=(hs-.1)*s.fontSize,this.baseline=this.height-Rs*this.equation.fontSize,this.width=s.fontSize*.2}get expr(){return" "}},Pe=class extends gt{constructor(e,i,n,r=0){super("mrow",e,i);this.align=n;this.dx=r}addChildren(e,i=this.children.length){let n=[];for(let r of e)r.type==="mrow"?(n.push(...r.children),r.detach()):n.push(r);super.addChildren(n,i)}get expr(){return this.children.map(e=>e.expr).join(" ").replace(/− /,"\u2212")||"placeholder"}measure(e=1){if(super.measure(e),!this.children.length){this.height=this.width=this.baseline=0;return}this.baseline=Math.max(...this.children.map(n=>n.baseline)),this.height=this.baseline+Math.max(...this.children.map(n=>n.height-n.baseline));let i=0;for(let[n,r]of this.children.entries())r.setTransform(i,this.baseline-r.baseline),i+=r.width,n<this.children.length-1&&(i+=Math.max(r.marginRight,this.children[n+1].marginLeft)*this.equation.fontSize);if(this.align){let n=this.children.find(r=>r.expr===this.align);n&&(this.transform.x=this.dx-n.transform.x-n.width/2)}this.width=i}},da=class extends gt{constructor(s){let e=s.fontSize,i=`M${.1*e} ${.3*e}h${e/2}v${e/2}h-${e/2}Z`,n=d("path",{class:"placeholder",d:i});super("placeholder",[],s,n),this.width=.7*e,this.height=hs*e,this.baseline=this.height-Rs*e}get expr(){return"placeholder"}get marginLeft(){return 0}get marginRight(){return 0}},ua=class extends gt{constructor(s,e){super("mfrac",s,e,d("line"))}get expr(){return this.children.map(s=>Ie(s)).join("/")}measure(s){let e=this.hasParent(a=>a.type==="mfrac"||a.type==="matrix"),i=la(s,!this.equation.isDisplay||e?.66:1),n=.1*this.equation.fontSize,[r,o]=this.children;super.measure(s*i),this.width=(Math.max(r.width,o.width)+2*n)*i,this.height=(r.height+o.height)*i,this.baseline=r.height*i+this.equation.fontSize*(hs/2-Rs),r.setTransform((this.width-r.width*i)/2,0,i),o.setTransform((this.width-o.width*i)/2,r.height*i,i)}drawElement(s,e,i,n){let r=n-this.equation.fontSize*(hs/2-Rs);this.$element.setLine({x:0,y:r},{x:e,y:r}),this.$element.setAttr("stroke",this.color||"currentColor"),Hn(this.$element,s,this.status)}hitTestChildren(s){let{scale:e,y:i}=this.worldTransform,n=this.baseline-this.equation.fontSize*(hs/2-Rs),r=s.y<=i+n*e,o=this.children[r?0:1];return o.hitTestChildren(s)||o}},$i=class extends gt{get expr(){let s=Ie(this.children[0]);return this.type!=="msup"&&(s+="_"+Ie(this.children[1])),this.type==="msup"&&(s+="^"+Ie(this.children[1])),this.type==="msubsup"&&(s+="^"+Ie(this.children[2])),s}measure(s){let[e,i,n]=this.children,r=this.type==="msup"?void 0:i,o=this.type==="msubsup"?n:this.type==="msup"?i:void 0,a=.05*this.equation.fontSize,h=la(s,.65);e.measure(s),r&&r.measure(s*h),o&&o.measure(s*h);let l=o?o.height*h-.4*this.equation.fontSize:0,p=r?r.height*h-.5*this.equation.fontSize:0,f=o?o.width:0,m=r?r.width:0;this.width=e.width+a+Math.max(f,m)*h,this.height=e.height+l+p,this.baseline=e.baseline+l,e.setTransform(0,this.baseline-e.baseline),o&&o.setTransform(e.width+a,0,h),r&&r.setTransform(e.width+a,this.height-r.height*h,h)}clean(){if(super.clean(),this.children=this.children.filter(s=>s.type!=="mrow"||s.children.length),this.children.length===0)return this.detach();this.children.length===1&&(this.insertAfter(this.children),this.detach())}},fa=class extends gt{get expr(){let s=this.children[0].expr;return this.type!=="munder"&&(s+="_"+Ie(this.children[1])),this.type==="mover"&&(s+="^"+Ie(this.children[1])),this.type==="munderover"&&(s+="^"+Ie(this.children[2])),s}measure(s){super.measure(s)}},Un=class extends gt{constructor(s,e){super("mfenced",s,e,d("path"))}get expr(){return`(${this.children.map(s=>s.expr).join(",")})`}get marginLeft(){return .2}get marginRight(){return .2}measure(s){super.measure(s);let e=this.children[0];this.height=e.height+2,this.baseline=e.baseline+1;let i=1+this.height/this.equation.fontSize,n=.1*this.equation.fontSize;this.width=e.width+2*(i+n),e.setTransform(i+n,1)}drawElement(s,e,i){let n=Math.min(2+i/this.equation.fontSize,5),r=i-4,o=e-n,a=`M${n},2c${-2*n/3},${.15*r},${-n},${.32*r},${-n},${r/2}s${n/3},${.35*r},${n},${r/2}M${o},2c${2*n/3},${.15*r},${n},${.32*r},${n},${r/2}s${-n/3},${.35*r},${-n},${r/2}`;this.$element.setAttr("d",a),this.$element.css("stroke",this.color||"currentColor"),Hn(this.$element,s,this.status)}clean(){super.clean(),this.children.length||this.detach()}},Wn=class extends gt{constructor(s,e,i){super(s,e,i,d("path"))}get expr(){return`sqrt(${this.children.map(s=>s.expr).join(", ")})`}get marginLeft(){return .2}get marginRight(){return .2}measure(s){super.measure(s);let e=this.children[0];this.height=e.height+2,this.baseline=e.baseline+2;let i=Math.min(16,3+5*this.height/this.equation.fontSize),n=.05*this.equation.fontSize;this.width=e.width+i+2*n,e.setTransform(i+n,2)}drawElement(s,e,i){let n=Math.min(16,3+5*i/this.equation.fontSize),r=i-2,o=`M0,${.55*r}L${.18*n},${.51*r}L${.45*n},${r}L${n},2L${e},2`;this.$element.setAttr("d",o),this.$element.css("stroke",this.color||"currentColor"),Hn(this.$element,s,this.status)}clean(){super.clean(),this.children.length||this.detach()}},ma=class extends gt{constructor(e,i,n){super("matrix",e,i,d("g"));this.rows=n;this.cols=Math.floor(e.length/n)}get expr(){return`${this.children.map(e=>e.expr).join(", ")}`}measure(e){super.measure(e);let i=.6*this.equation.fontSize,n=H(a=>Math.max(...H(h=>this.children[a*this.cols+h].height,this.cols)),this.rows),r=H(a=>Math.max(...H(h=>this.children[h*this.cols+a].width,this.rows)),this.cols);this.height=D(n)+(this.rows-1)*i/2,this.width=D(r)+this.cols*i,this.baseline=(this.height+hs*this.equation.fontSize)/2;let o=0;for(let a=0;a<this.rows;++a){let h=i/2;for(let l=0;l<this.cols;++l){let p=this.children[a*this.cols+l],f=h+(r[l]-p.width)/2,m=o+(n[a]-p.height)/2;p.setTransform(f,m),h+=r[l]+i}o+=n[a]+i/2}}},ga=class extends gt{constructor(e,i){var n;super("foreign",[],i,d("g"));this.$body=d("div",{},i.$overlay),this.$body._el.append(e),this.$measure=d("span",{text:".",style:"font-size: 0"},this.$body),this.checkForResize(),this.$body.on("resize",()=>{this.checkForResize()&&this.equation.resize()}),(n=this.$body.$("x-blank, x-blank-mc"))==null||n.on("solve",r=>{oe(()=>this.replace(r.solution,"#0f82f2"),r.restore?0:200)})}deleteFromDom(){var e;super.deleteFromDom(),(e=this.$body)==null||e.remove(),this.$body=void 0,this.$measure=void 0}replace(e,i){var o;let n=Number.isNaN(+e)?"mtext":"mn",r=new jn(n,e,this.equation);r.customColor=i,this.insertAfter([r]),(o=this.$body)==null||o.off("resize"),this.deleteFromDom(),this.equation.resize()}checkForResize(){var r,o;let e=this.height,i=this.width,n=this.baseline;return this.height=((r=this.$body)==null?void 0:r.height)||0,this.width=((o=this.$body)==null?void 0:o.width)||0,this.baseline=this.$measure.bounds.top-this.$body.bounds.top,!(y(e,this.height)&&y(i,this.width)&&y(n,this.baseline))}positionElement(e){var i,n;(i=this.$body)==null||i.css({left:e.x+"px",top:e.y+"px"}),y(e.scale,1)||(n=this.$body)==null||n.css("transform",`scale(${e.scale})`)}get expr(){var e;return`"${(e=this.$body)==null?void 0:e.text}"`}get log(){return`<foreign>${this.expr}</foreign>`}};var Ls=class extends Me{constructor(e,i,n=0,r="=",o=18,a=!0){super();this.$row=e;this.$overlay=i;this.fontSize=o;this.isDisplay=a;this.isReady=!0;this.deletedNodes=new Set;this.root=new Pe([],this,r,n)}setValue(e){let i=Array.isArray(e)?e.map(n=>gt.create(n,this)):this.parse(e);for(;this.root.children.length;)this.root.children[0].deleteFromDom();this.root.addChildren(i),this.updateDescription(),this.resize()}updateDescription(){try{let e=$t.parse(this.root.expr).toVoice();this.$row.setAttr("aria-label",e)}catch(e){this.$row.setAttr("aria-label","Invalid expression: "+this.root.expr)}}resize(){this.root.measure(),this.root.render()}parse(e){var a;let i=new DOMParser,n=$t.parse(e).toMathML(),r=i.parseFromString(`<math>${n}</math>`,"text/xml");if(((a=r.firstChild)==null?void 0:a.nodeName)==="parsererror")throw new Error(r.firstChild.textContent);let o=r.firstChild.childNodes;return Array.from(o,h=>gt.create(h,this))}find(e){let[i,n]=e.split("`");i=i.replace(/[–-]/g,"\u2212");let r=+n||1,o=this.root.children.slice(0),a=0;for(;o.length;){let h=o.shift(),l=h instanceof Pe?void 0:wc(h,i);if(l&&(a+=1,a===r))return l;o.unshift(...h.children)}throw new Error(`Can't find element ${i}.`)}animate(e=1200){return O(this,null,function*(){this.isReady=!1,this.root.clean(),this.root.measure();let i=new Fn;this.root.render(i),this.trigger("resize",{height:this.root.height});for(let n of this.deletedNodes)n.render(i);yield i.start(e);for(let n of this.deletedNodes)n.deleteFromDom();this.root.setStatus(""),this.deletedNodes.clear(),this.isReady=!0})}addTermAfter(e,i){let n=L(i?this.find(i):this.root.children),r=this.parse(e);n.insertAfter(r);for(let o of r)o.setStatus("adding");this.updateDescription()}addTermBefore(e,i){let n=i?this.find(i)[0]:this.root.children[0],r=this.parse(e);n.insertBefore(r);for(let o of r)o.setStatus("adding");this.updateDescription()}deleteTerm(e){for(let i of this.find(e))i.setStatus("deleting"),i.detach(),this.deletedNodes.add(i);this.updateDescription()}replaceTerm(e,i){let n=this.find(e),r=this.parse(i);n[0].insertBefore(r);for(let o of r)o.setStatus("adding");for(let o of n)o.setStatus("deleting"),o.detach(),this.deletedNodes.add(o);this.updateDescription()}moveTermAfter(e,i){let n=this.find(e);for(let o of n)o.roundedMotion=!0;L(i?this.find(i):this.root.children).insertAfter(n),this.updateDescription()}moveTermBefore(e,i){let n=this.find(e);for(let o of n)o.roundedMotion=!0;(i?this.find(i)[0]:this.root.children[0]).insertBefore(n),this.updateDescription()}moveTermToStart(e){let i=this.find(e);for(let n of i)n.roundedMotion=!0;this.root.children[0].insertBefore(i),this.updateDescription()}wrapTerms(e,...i){let n=i.map(o=>this.find(o));for(let o of n)for(let a of o)a.roundedMotion=!0;let r=this.parse(e);for(let o of r)o.setStatus("adding");n[0][0].insertBefore(r);for(let[o,a]of n.entries()){let h=this.find("$"+(o+1))[0];h.insertAfter(a),h.deleteFromDom()}this.updateDescription()}unwrapTerm(e,i=1){let n=this.find(e),r=n[0],o=1;for(;o<=i;)r=r.parent,r instanceof Pe&&(r=r.parent),o+=1;r.insertAfter(n),r.setStatus("deleting"),r.detach(),this.deletedNodes.add(r),this.updateDescription()}get leftSide(){let e=this.root.children.findIndex(i=>i.expr==="=");return this.root.children.slice(0,e-1)}get rightSide(){let e=this.root.children.findIndex(i=>i.expr==="=");return this.root.children.slice(e+1)}};var bc='<svg class="equation"><g></g></svg><div class="overlay"></div><div class="nav"><div class="btn back hide"><x-icon name="left"></x-icon></div><div class="btn next"><x-icon name="right"></x-icon></div></div><div class="legend-box"><slot></slot></div>';var $c=1200,Em=400,Pc=1200,_s=600,Pi=16,Kn=class extends S{constructor(){super(...arguments);this.rows=[];this.isReady=!0;this.topOffset=4;this.currentHeight=0;this.currentStep=0;this.nextEvents={};this.backEvents={}}ready(){this.$svg=this.$("svg"),this.$lastRow=this.$svg.$("g"),this.$overlay=this.$(".overlay"),this.$legend=this.$(".legend-box"),this.$steps=this.$legend.$$("li"),this.$back=this.$(".back"),this.$next=this.$(".next");let e=+this.attr("dx")||0;this.equation=new Ls(this.$lastRow,this.$overlay,e);let i=this.$(".math"),n=i?Array.from(i._el.children):[];this.equation.setValue(this.attr("expr")||n),this.currentHeight=this.topOffset+this.$lastRow.height+16,this.$svg.css("height",this.currentHeight+"px"),this.equation.on("resize",({height:o})=>{let a=this.topOffset+o+Pi;Math.abs(a-this.currentHeight)<Pi/2||(this.currentHeight=a,this.$svg.animate({height:a+"px"},Pc))}),this.$back.on("click",()=>this.goBack()),this.$next.on("click",()=>this.goNext()),this.$steps[0].show(),w.onResize(()=>{let o=this.$svg.width/2;for(let a of[this.$lastRow,this.$overlay])a.css("transform",`translate(${o}px, ${this.topOffset}px)`);for(let a of this.rows)a.$el.css("transform",`translate(${o}px, ${a.top}px)`)});let r=this.$overlay.$$("x-blank, x-blank-mc");r.length&&(this.$next.addClass("hide"),Promise.all(r.map(o=>o.onPromise("solve"))).then(()=>setTimeout(()=>this.goNext(),$c)))}setup(e){this.one("next",({step:i})=>e.score("algebra-flow-"+(i-1)))}newRow(){return O(this,null,function*(){let e=this.$lastRow.copy(!0,!1),i=this.equation.root.height;this.rows.push({$el:e,height:i,top:this.topOffset}),this.$lastRow.insertBefore(e),w.redraw(),this.topOffset+=i+Pi,this.currentHeight=this.topOffset+i+Pi;for(let n of[this.$lastRow,this.$overlay])n.animate({transform:`translate(${this.$svg.width/2}px, ${this.topOffset}px)`},_s);yield this.$svg.animate({height:this.currentHeight+"px"},_s).promise})}hideLastRow(){return O(this,null,function*(){if(!this.rows.length)return;let e=this.rows.pop();this.topOffset=e.top;for(let i of[this.$lastRow,this.$overlay])i.animate({transform:`translate(${this.$svg.width/2}px, ${e.top}px)`},_s);this.currentHeight=e.top+this.$lastRow.height+Pi,this.$svg.animate({height:this.currentHeight+"px"},_s),yield e.$el.exit("fade",_s/2,_s/2).promise,e.$el.remove()})}onNextStep(e){this.nextEvents=e}onBackStep(e){this.backEvents=e}goNext(){return O(this,null,function*(){if(!this.isReady||!this.equation.isReady||this.currentStep>=this.$steps.length-1)return;this.isReady=!1;let e=this.currentStep+1;this.$steps[e].hasClass("new-row")&&(yield this.newRow(),yield ei(Em)),e in this.nextEvents&&(yield this.nextEvents[e](this.equation),yield this.equation.animate(Pc),yield ei($c)),yield this.go(e),this.trigger("next",{step:e}),this.isReady=!0})}goBack(){return O(this,null,function*(){if(!this.isReady||!this.equation.isReady||this.currentStep<=0)return;let e=this.currentStep-1;this.isReady=!1,this.currentStep in this.backEvents&&(yield this.backEvents[this.currentStep](this.equation),yield this.equation.animate()),this.$steps[this.currentStep].hasClass("new-row")&&this.hideLastRow(),yield this.go(e),this.trigger("back",{step:e}),this.isReady=!0})}go(e){return O(this,null,function*(){this.$steps[e].show();let i=this.$steps[e].height+"px";this.$steps[e].hide(),this.$legend.animate({height:i},800).promise.then(()=>this.$legend.css("height","auto"));let n=this.currentStep;this.currentStep=e,this.trigger("step",e),yield this.$steps[n].exit("fade",400).promise,this.$back.setClass("hide",e<=0),this.$next.setClass("hide",e>=this.$steps.length-1),yield this.$steps[e].enter("fade",400).promise})}};Kn=$([P("x-algebra-flow",{template:bc})],Kn);var Ec='<div class="input"><textarea></textarea></div><div class="math empty"><span class="cursor">&#8203;</span></div><div class="keys"><!-- TODO Make these buttons tabbable--><div class="btn" data-type="+">+</div><div class="btn" data-type="\u2212">\u2212</div><div class="btn" data-type="\xD7">\xD7</div><div class="btn" data-type="\xF7">\xF7</div><div class="btn i" data-type="\u03C0">\u03C0</div><div class="btn" data-type="frac"><x-icon name="fraction"></x-icon></div><div class="btn" data-type="sup"><x-icon name="power"></x-icon></div><div class="btn" data-type="sqrt"><x-icon name="sqrt"></x-icon></div><div class="btn" data-type="brackets"><x-icon name="brackets"></x-icon></div></div><div class="error"><x-icon name="warning"></x-icon></div><div class="error-message"></div>';function Mc(t){let s=t.prev;s&&_(s.tagName,"MO","MI","MN")?s.insertBefore(t):s?L(s.children).append(t):t.parent.hasClass("math")||(t.parent.prev?t.parent.prev.append(t):t.parent.parent.insertBefore(t))}function Tm(t){let s=t.next;if(s&&_(s.tagName,"MO","MI","MN"))return s.insertAfter(t);s?s.children[0].prepend(t):t.parent.hasClass("math")||(t.parent.next?t.parent.next.prepend(t):t.parent.parent.insertAfter(t))}function Sm(t){let s=t.parent;for(;s.parent.tagName!=="MFRAC"||!s.prev;){if(s.hasClass("math"))return;s=s.parent}s.prev.append(t)}function Mm(t){let s=t.parent;for(;s.parent.tagName!=="MFRAC"||!s.next;){if(s.hasClass("math"))return;s=s.parent}s.next.prepend(t)}function Cm(t){let s=t.prev,e=t.parent;if(s&&_(s.tagName,"MO","MI","MN"))s.remove(),e.children.length<=1&&e.addClass("empty");else if(!s&&!e.prev&&!e.hasClass("math")){let i=e.parent;i.insertBefore(t);for(let n of i.children)for(let r of n.children)i.insertBefore(r);i.remove(),t.parent.children.length<=1&&t.parent.addClass("empty")}else Mc(t)}function ls(t,s){s.insertBefore(t),s.parent.removeClass("empty"),t.children.length&&t.children[0].append(s)}function Tc(t,s){"abcdefghijklmnopqrstuvwxyz\u03C0".includes(s)?ls(d("mi",{text:s}),t):"0123456789.".includes(s)?ls(d("mn",{text:s}),t):"+\u2212\xB1\xD7\xF7<>\u2264\u2265=%!".includes(s)?ls(d("mo",{text:s,value:s}),t):s==="frac"?ls(d("mfrac",{html:'<mrow class="empty"></mrow><mrow class="empty"></mrow>'}),t):s==="sqrt"?ls(d("msqrt",{html:'<mrow class="empty"></mrow>'}),t):_(s,"^","sup")?ls(d("msup",{html:'<mrow class="empty"></mrow>'}),t):s==="brackets"||"([{|".includes(s)?ls(d("mfenced",{html:'<mrow class="empty"></mrow>',type:"("}),t):")]}".includes(s)&&!t.next&&t.parent.parent.tagName==="MFENCED"&&t.parent.parent.insertAfter(t)}function Sc(t,s){let e=t.$$(`${s}:first-child, *:not(${s}) + ${s}`);for(let i of e)if(i.parent.tagName!=="MFRAC")for(;i.next&&i.next.tagName===s.toUpperCase();)i.text+=i.next.text,i.next.remove()}var km="This is not a valid mathematical expression.",Am="Fill in all empty placeholders in the expression.",Vm={"+":"addition","\xD7":"multiplication","/":"fractions or division","\u2212":"subtraction",sqrt:"square roots","^":"powers"};function cs(t,s){if(t instanceof Text)return t.textContent||"";if(t.hasClass("cursor"))return"";let e=t.childNodes;return t.tagName==="MI"?t.text+(s?" ":""):t.tagName==="MFENCED"?"("+cs(e[0],s)+")":t.tagName==="MSUP"?"^("+cs(e[0],s)+")":t.tagName==="MFRAC"?`(${cs(e[0],s)})/(${cs(e[1],s)})`:t.tagName==="MSQRT"?"sqrt("+cs(e[0],s)+")":e.map(i=>cs(i,s)).join("")}function Im(t,s){try{return{expr:$t.parse(t,!0,{variables:s})}}catch(e){return{error:e instanceof B?e.message:km}}}function Om(t,s,e){let i=t.variables;if(s.length){let n=i.find(o=>!s.includes(o));if(n){let o=ah(n,e||s);return o?`Did you mean \u201C<em>${o}</em>\u201D instead of \u201C<em>${n}</em>\u201D?`:`There shouldn\u2019t be a variable called \u201C<em>${n}</em>\u201D.`}let r=s.find(o=>!i.includes(o));if(r)return`Your expression should contain \u201C<em>${r}</em>\u201D.`}}function Rm(t,s){if(s.length){let e=t.functions.find(i=>!s.includes(i));if(e)return`This expression should not contain ${Vm[e]||"\u201C"+e+"\u201D"}.`}}function Lm(t,s,e=.001){try{return y(t.evaluate(),s.evaluate(),e)}catch(i){return!1}}var Xn=class extends S{constructor(){super(...arguments);this.isDone=!1;this.shortVar=!1;this.lastAttempt="";this.errorCount=0;this.hints=[];this.fns=[];this.vars=[];this.validate=void 0}ready(){if(this.$math=this.$(".math"),this.$textarea=this.$("textarea"),this.$cursor=this.$(".cursor"),this.$error=this.$(".error-message"),this.solution=$t.parse(this.attr("solution")),this.hasAttr("numeric")&&(this.numeric=+this.attr("precision")||.01),this.vars=this.hasAttr("vars")?K(this.attr("vars")):this.solution?this.solution.variables:[],this.hasAttr("fns")&&(this.fns=K(this.attr("fns"))),this.solution&&this.fns.push(...this.solution.functions),this.fns.includes("/")&&!this.fns.includes("\xD7")&&this.fns.push("\xD7"),this.hasAttr("hints")&&(this.hints=K(this.attr("hints"))),this.hasAttr("substitutions")){this.substitutions={},this.autocomplete=this.vars.slice(0);for(let n of this.attr("substitutions").split("|"))if(n.trim()){let[r,o]=n.split(":");this.autocomplete.push(r.trim()),this.substitutions[r.trim()]=$t.parse(o)}}for(let n of["solution","precision","vars","fns","vars-required","substitutions"])this.removeAttr(n);this.shortVar=this.hasAttr("short-var");let e=K(this.attr("keys")||"+ \u2212 \xD7 \xF7 frac sup sqrt brackets"),i=this.$(".keys");for(let n of i.children)e.includes(n.data.type)?(n.on("pointerdown",r=>r.preventDefault()),n.on("pointerup",()=>{Tc(this.$cursor,n.data.type),this.check()})):n.remove();this.on("pointerdown",n=>this.onPointerdown(n)),this.$textarea.on("focus",()=>this.onPointerdown()),this.$textarea.on("blur",()=>this.onBlur()),this.$textarea.on("key",n=>this.handleKey(n))}setup(e,i,n){var r;this.$step=e,(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(),this.on("solve",()=>{e.addHint("correct"),e.score(i)})}focus(){this.trigger("pointerdown")}onPointerdown(e){if(this.isDone)return;e&&e.preventDefault&&e.preventDefault(),this.addClass("active"),this.$textarea.focus();let i=e&&e.target?k(e.target):this;if(i.tagName==="X-EQUATION"||i.hasClass("math")){let n=this.$math.children,r=D(n.map(a=>a.outerWidth))/2;(e?Ct(e).x<this.$math.bounds.left+r:!0)?this.$math.prepend(this.$cursor):this.$math.append(this.$cursor)}else if(i.tagName[0]==="M"){let n=Ct(e).x<i.boxCenter.x;i.tagName==="MROW"?n?i.prepend(this.$cursor):i.append(this.$cursor):n?i.insertBefore(this.$cursor):i.insertAfter(this.$cursor)}}handleKey(e){let i=li(e);if(_(i,"Enter","Escape"))this.$textarea.blur();else if(i==="ArrowLeft")Mc(this.$cursor);else if(i==="ArrowRight")Tm(this.$cursor);else if(i==="ArrowUp")Sm(this.$cursor);else if(i==="ArrowDown")Mm(this.$cursor);else if(_(i,"Backspace","Delete"))Cm(this.$cursor),this.check();else{let n=e.key.replace("*","\xD7").replace("/","\xF7").replace("-","\u2212");Tc(this.$cursor,n),this.check()}}onBlur(){if(this.isDone)return;if(!this.value)return this.removeClass("active has-error");if(this.removeClass("active"),this.addClass("has-error"),this.value===this.lastAttempt||(this.lastAttempt=this.value,!this.$step))return;let e=this.error||(this.hints||[]).shift()||"incorrect",i=this.$step.addHint(e,{class:"incorrect"});this.$error.html=(i==null?void 0:i.text)||"",this.errorCount+=1,this.trigger("error",{count:this.errorCount,msg:e}),this.errorCount>=5&&this.$step.addHint(`Hmmm\u2026 maybe try ${this.solution.toMathML()}?`)}check(){if(this.error=void 0,this.value=cs(this.$math,this.shortVar).trim(),!this.value)return;if(this.$math.$(".empty"))return this.error=Am;let e=Im(this.value,this.vars);if(e.error)return this.error=e.error;let i=this.substitutions?e.expr.substitute(this.substitutions):e.expr;if(this.numeric&&Lm(this.solution,i,this.numeric))return this.solve();if(this.validate){let o=this.validate(e.expr)||{};if(o.isCorrect)return this.complete(e.expr);if(o.error)return this.error=o.error}if(this.solution&&$t.numEquals(this.solution,i))return this.complete(e.expr);let n=Om(i,this.vars,this.autocomplete);if(n)return this.error=n;let r=Rm(i,this.fns);if(r)return this.error=r}complete(e){this.isDone||(this.isDone=!0,this.removeClass("has-error active"),this.addClass("done"),this.$textarea.blur(),this.shortVar||Sc(this.$math,"mi"),Sc(this.$math,"mn"),this.trigger("solve",{expr:e}))}solve(){this.$math.removeClass("empty"),this.$math.html=this.solution.toMathML(),this.complete(this.solution)}};Xn=$([P("x-equation",{template:Ec})],Xn);var _m={opacity:[0,1],transform:["translateX(-50px)","none"]},Nm={error:"You\u2019ve already had this expression before. Try simplifying it."},Dm="You have to fully simplify this expression. The correct solution is $0.",Yn=class extends S{constructor(){super(...arguments);this.rowCount=1;this.previousAnswers=[];this.isSolved=!1;this.maxRows=6;this.steps=[];this.hints=[]}created(){this.$table=this.$("table tbody"),this.lastRowContent=this.$table.$("tr:last-child").html}ready(){this.hasAttr("max-rows")&&(this.maxRows=+this.attr("max-rows")),this.hasAttr("steps")&&(this.steps=this.attr("steps").split("|")),this.hasAttr("hints")&&(this.hints=this.attr("hints").split("|")),this.removeAttr("steps"),this.removeAttr("hints"),this.setupEquation(this.$("x-equation"))}setup(e,i,n){var r;this.$step=this.$equation.$step=e,(r=n==null?void 0:n.scores)!=null&&r.includes(i)&&this.solve(),this.on("solve",()=>{e.addHint("correct"),e.score(i)}),this.on("hint",o=>e.addHint(o))}setupEquation(e){this.$equation=e,this.$equation.$step=this.$step,e.one("solve",i=>this.onSolveRow(i.expr)),e.hints=this.hints,e.validate=i=>{let n=this.previousAnswers.includes(i.toString());return(this.validate?this.validate(i,n):void 0)||(n?Nm:{})}}onSolveRow(e){if(this.trigger("solve-row",{expr:e,$math:this.$equation.$math}),this.isFinal&&this.isFinal(e))return this.trigger("solve");if(this.isSolved)return;if(this.rowCount+=1,this.previousAnswers.push(e.toString()),this.rowCount>this.maxRows){let n=this.$equation.solution.toMathML();this.trigger("hint",Dm.replace("$0",n)),this.trigger("solve")}let i=d("tr",{html:this.lastRowContent},this.$table);i.animate(_m,400,500),this.setupEquation(i.$("x-equation")),setTimeout(()=>this.$equation.focus(),1200)}solve(){if(this.isSolved=!0,this.steps.length){let e=this.$table.$("tr:last-child"),i=this.lastRowContent.replace(/<x-equation.*<\/x-equation>/,'<span class="math fill"></span>');for(let n of this.steps){let r=d("tr",{html:i},this.$table),o=r.$(".math.fill"),a=$t.parse(n);o.html=a.toMathML(),e.insertBefore(r),this.trigger("solve-row",{expr:a,$math:o})}}this.$equation.solve()}};Yn=$([P("x-equation-system")],Yn);var wa=Math.PI/2;function Zn(t){if(it(t))return[t];if(_t(t))return t.points;if(le(t))return[t.p1,t.p2];if(Nt(t))return Zn(t.shape(!0));if(j(t))return[t.c.shift(t.r,0),t.c.shift(-t.r,0),t.c.shift(0,t.r),t.c.shift(0,-t.r)];if(ge(t)||Rt(t)){let s=[t.start,t.end];ge(t)&&s.push(t.c);let e=t.radius;for(let[i,n]of[[e,0],[0,e],[-e,0],[0,-e]]){let r=t.c.shift(i,n);Lt.prototype.contains.call(t,r)&&s.push(r)}return s}return[]}function Oe(...t){return R.aroundPoints(function*(){for(let s of t)for(let e of Zn(s))yield e}())}function Jn(t,s,e=0){if(!t.size&&!s.size)return new ut(0,100,0,100);let i=R.aroundPoints(function*(){for(let n of t.values())if(n.transformed&&n.props.status!=="hidden")for(let r of Zn(n.transformed))yield r;for(let n of s.values())if(n.path)for(let r of Zn(n.path))yield r}());return new ut(i.p.x-e,i.p.x+i.w+e,i.p.y-e,i.p.y+i.h+e)}function Ns(t,s,e){if(it(s))return t.contains(s);if(ws(s))return C.collision(t.polygon,s);if(wo(s))return s.collision(t);if(ot(s))return Z(s,t).length>0||t.contains(s.p1);if(Nt(s))return Ns(t,s.shape(!0),e);if(j(s))return e==="geo"?Z(s,t).length>0||t.contains(s.at(0)):s.collision(t);if(ge(s)){let i=new C(s.c,s.start,s.at(.25),s.at(.5),s.at(.75),s.end);return C.collision(t.polygon,i)}return!1}var Qn=class{constructor(s){this.$parent=s;this.visible=!1;this.$el=d("div",{class:"tile-error",hidden:!0},s.$html),this.$text=d("span",{},this.$el),this.$button=d("button",{text:"Select Errors"},this.$el),this.$button.on("click",()=>{s.selection.clear(),this.error&&s.selection.select(this.error.locations),this.hide()})}show(s,e){this.visible&&this.error===e||(this.visible=!0,this.$el.setTransform(s),this.$text.html=e.message,this.$button.toggle(!!(e!=null&&e.locations.length)),this.$el.enter("pop",200),this.error=e)}hide(){!this.visible||(this.visible=!1,this.$el.exit("pop",200),this.error=void 0)}},va=new Map;function Ds(t){if(!t||!w.theme.isDark)return t;if(va.has(t))return va.get(t);let s=J.fromHex(t),e=s.hsl;ct(e[2],20,80)||(e[2]=100-e[2]);let i=J.fromHsl(...e);i.a=s.a;let n=i.hex;return va.set(t,n),n}function Cc(t){let s=t==null?void 0:t.items;if(!!(s!=null&&s.length))for(let e=0;e<s.length;++e){if(!s[e].type.startsWith("image/"))continue;let i=s[e].getAsFile();if(i)return i}}var Gm=80,Bm=[5,2,1];function ya(t,s,e,i=.01){let n=t?t.split(","):[];if(n.length===3)return n.map(m=>+m);let r=n.length>0?+n[0]:e?e[0]:0,o=n.length>1?+n[1]:e?e[1]:s;if(y(r,o))return[r-1,o+1,1];i&&(o+=.01*(o-r));let a=Math.floor(Math.abs(s)/Gm),h=(o-r)/a,l=Math.floor(Math.log10(h)),p=Math.pow(10,l),f=Bm.find(m=>p*m<=h)*p;return o=f*Math.ceil(o/f),r=f*Math.floor(r/f),[r,o,f]}function tr(t,s=4e3){let e=k(`x-alert[key=${t}]`);return e==null?void 0:e.open(s)}function kc(t,s){let e=new c(-t/2,-s/2);return new R(e,t,s)}function xa(t,s,e){if(!t)return;let i={},n=0;for(let r of t){let o=s(r);if(o&&(i[r.id]=o,n+=1),e&&n>e)break}return n?i:void 0}function Ac(t,s,e,i,n){return d("use",{href:`/icons.svg#${t}`,fill:s,width:e,height:e,x:i==null?void 0:i.x,y:i==null?void 0:i.y},n)}function ba(t){let s=Math.min(...t.map(i=>Math.min(...i.map(n=>n.y)))),e=Math.max(...t.map(i=>Math.max(...i.map(n=>n.y))));return[s,e]}function Ee(t,s,e){return t.hasAttr(s)?t.attr(s)!=="no":e}function Vc(t){let s=K(t).map(e=>+e);return s.length===1?[s[0],s[0],s[0],s[0]]:s.length===2?[s[0],s[1],s[0],s[1]]:s.length===3?[s[0],s[1],s[2],s[1]]:s}function Ic(t){let s=t.split(",");return[s[0]!=="no",(s.length>1?s[1]:s[0])!=="no"]}var Oc={hasGeoModel:!0,pi:Math.PI,point:(t,s)=>t!==void 0&&s!==void 0?new c(t,s):void 0,angle:(t,s,e)=>t&&s&&e?new pt(t,s,e):void 0,line:(t,s)=>t&&s&&!t.equals(s)?new st(t,s):void 0,ray:(t,s)=>t&&s&&!t.equals(s)?new fo(t,s):void 0,segment:(t,s)=>t&&s&&!t.equals(s)?new X(t,s):void 0,circle:(t,s)=>t&&s?new et(t,s):void 0,arc:(t,s,e)=>t&&s&&e?new Lt(t,s,e):void 0,sector:(t,s,e)=>t&&s&&e?new mo(t,s,e):void 0,polygon:(...t)=>t.every(s=>s)?new C(...t):void 0,polyline:(...t)=>t.every(s=>s)?new Wt(...t):void 0,triangle:(t,s,e)=>t&&s&&e?new oi(t,s,e):void 0,rectangle:(t,s,e)=>t?new R(t,s,e):void 0,distance:c.distance,round:(t,s=0)=>ae(t,s),sqrt:Math.sqrt,floor:Math.floor,ceil:Math.ceil,intersections:Z};function er(t,s,e){let i=e,n;for(let r of t){let o=s(r);o!==void 0&&o<i&&(i=o,n=r)}return n}function Rc(t,s){s.clear();for(let e of t)if(!(e.isHidden||!e.value))for(let i of t){if(e.isHidden||!i.value||e===i)continue;let n=Z(e.value,i.value);for(let[r,o]of n.entries())s.add({path1:e,path2:i,posn:o,index:r})}}var Lc="M100,50h0l-5.2-4.9L52.6,10.2v-9C52.6.6,51.4,0,50,0s-2.6.6-2.6,1.2v9L5.2,45.1,0,50H0l6.6-3L35,25.9H65L93.4,47ZM38.4,23.5,50,14.8l11.6,8.7Z",_c="M0,0V8H100V0ZM7,6A2,2,0,1,1,9,4,2,2,0,0,1,7,6Z";function ps(t,s,e,i){return`translate(${t.x}px, ${t.y-s}px) scale(${i/100}) rotate(${e}rad)`}var Nc=4,qm=`<marker id="axis-arrow" refX="3" refY="3" markerWidth="6"
    markerHeight="6" orient="auto"><path d="M 0 0 L 6 3 L 0 6 z"/></marker>`,He=class extends S{constructor(){super(...arguments);this.labelSuffix=["",""];this.gridSize=[1,1];this.showGrid=!1;this.showXAxis=!1;this.showYAxis=!1;this.showLabels=!1}setupCoordinates(e,i={}){this.$svg=e,e.addClass("canvas"),this.proportional=!!i.proportional,this.padding=Vc(this.attr("padding")||i.padding||"0"),Ee(this,"grid",i.showGrid||!1)&&(this.$grid=d("g",{class:"grid"}),e.prepend(this.$grid),this.showGrid=!0);let n=this.attr("axes")||(i.showAxes?"yes":"no");[this.showXAxis,this.showYAxis]=Ic(n),(this.showXAxis||this.showYAxis)&&(d("defs",{html:qm},e),this.$axes=d("g",{class:"axes"}),e.prepend(this.$axes),this.axisNames=(this.attr("axis-names")||",").split(",")),this.$axes&&Ee(this,"labels",!0)&&(this.labelSuffix=(this.attr("label-suffix")||",").split(","),this.showLabels=!0),(this.showLabels||this.axisNames)&&(this.$labels=d("g",{class:"labels"},e)),this.resize()}resize(){this.css("max-width","none");let e=+this.attr("width")||this.width,i=+this.attr("height")||(this.hasAttr("width")?e:this.height);this.css("max-width",e+"px"),this.$svg.setAttr("width",e),this.$svg.setAttr("height",i),this.$svg.setAttr("viewBox",`0 0 ${e} ${i}`);let n=this.padding;this.viewportBounds=new ut(n[3],e-n[1],n[0],i-n[2]),this.updatePlotBounds(),this.positionElements(e,i)}updatePlotBounds(e){let[i,n,r]=ya(this.attr("x-axis"),this.viewportBounds.dx,e==null?void 0:e.xRange),[o,a,h]=ya(this.attr("y-axis"),this.viewportBounds.dy,e==null?void 0:e.yRange),l=Math.abs(this.viewportBounds.dx/(n-i)),p=Math.abs(this.viewportBounds.dy/(a-o)),f=Math.min(l,p),m=this.proportional?l/f:1,g=this.proportional?p/f:1;this.plotBounds=new ut(m*i,m*n,g*a,g*o),this.plotScale=this.proportional?f:(l+p)/2,this.gridSize=[r,h];let[x,u]=[this.plotBounds,this.viewportBounds];this.plotToViewportMatrix=[[u.dx/x.dx,0,u.xMin-x.xMin/x.dx*u.dx],[0,u.dy/x.dy,u.yMin-x.yMin/x.dy*u.dy]];let v=i>0?m*i:n<0?m*n:0,b=o>0?g*o:a<0?g*a:0;this.plotOrigin=new c(v,b),this.drawAxes()}drawAxes(){let[e,i]=[this.plotBounds,this.viewportBounds],n=this.toViewportCoords(this.plotOrigin),[r,o]=this.gridSize;if(this.$grid&&this.$grid.removeChildren(),this.$axes&&this.$axes.removeChildren(),this.$labels&&this.$labels.removeChildren(),this.showGrid||this.showXAxis){let a=r*Math.trunc(e.xMin/r+.01);for(let h=a;h<e.xMax;h+=r){if(this.showYAxis&&h===this.plotOrigin.x)continue;let l=this.toViewportCoords(new c(h,0)).x;this.showGrid&&d("line",{x1:l,y1:i.yMin,x2:l,y2:i.yMax},this.$grid),this.showLabels&&this.makeLabel(0,h,l,n)}}if(this.showGrid||this.showYAxis){let[a,h]=e.yMin<e.yMax?[e.yMin,e.yMax]:[e.yMax,e.yMin],l=o*Math.trunc(a/o+.01);for(let p=l;p<h;p+=o){if(this.showXAxis&&p===this.plotOrigin.y)continue;let f=this.toViewportCoords(new c(0,p)).y;this.showGrid&&d("line",{x1:i.xMin,y1:f,x2:i.xMax,y2:f},this.$grid),this.showLabels&&this.makeLabel(1,p,f,n)}}this.showXAxis&&(this.$xAxis=d("line",{x1:i.xMin,x2:i.xMax,y1:n.y,y2:n.y},this.$axes)),this.showYAxis&&(this.$yAxis=d("line",{x1:n.x,x2:n.x,y1:i.yMax,y2:i.yMin},this.$axes)),this.showLabels&&this.showXAxis&&this.showYAxis&&(e.xMin===0&&e.yMax===0&&!this.labelSuffix[0]&&!this.labelSuffix[1]?d("text",{text:0,x:n.x-5,y:n.y+15,"text-anchor":"end"},this.$labels):e.yMax===this.plotOrigin.y?this.makeLabel(0,this.plotOrigin.x,n.x,n):this.makeLabel(1,this.plotOrigin.y,n.y,n)),this.axisNames&&(this.axisNames[0]&&d("text",{text:this.axisNames[0],x:this.viewportBounds.xMax-2,y:n.y-12,"text-anchor":"end"},this.$labels),this.axisNames[1]&&d("text",{text:this.axisNames[1],x:n.x+10,y:this.viewportBounds.yMin+5},this.$labels))}makeLabel(e,i,n,r){let o=this.labelSuffix[e],a=o==="i"?new lt(0,i).toString():It(i,4)+o;d("text",{text:a,x:e?r.x-8:n,y:e?n+4:r.y+18,"text-anchor":e?"end":"middle"},this.$labels),d("line",{class:"tick",x1:e?r.x:n,y1:e?n:r.y,x2:e?r.x-Nc:n,y2:e?n:r.y+Nc},this.$axes)}positionElements(e,i){for(let n of this.$$("[data-bounds]")){let r=n.data.bounds.split(","),o=this.toViewportCoords(new c(+r[3],+r[0])),a=this.toViewportCoords(new c(+r[1],+r[2]));n.css({left:`${o.x/e*100}%`,top:`${o.y/i*100}%`,width:`${(a.x-o.x)/e*100}%`,height:`${(a.y-o.y)/i*100}%`})}}toPlotCoords(e){return e.changeCoordinates(this.viewportBounds,this.plotBounds)}toViewportCoords(e){return e.transform(this.plotToViewportMatrix)}};var sr=class extends He{constructor(){super(...arguments);this.steps=400}ready(){let e=d("svg",{},this),i=d("g",{class:"plot"},e);this.$path=d("path",{},i),this.setupCoordinates(e,{showGrid:!0,showAxes:!0,padding:"20"}),this.clear();let n=this.viewportBounds,r=this.steps/n.dx,o;Je(e,{start:()=>o=void 0,move:a=>{let h=G(Math.round((a.x-n.xMin)*r),0,this.steps-1);this.points[h]=this.toPlotCoords(new c(n.xMin+h/r,a.y)),o&&this.interpolate(o,h),o=h,this.redraw()},end:()=>this.snap()})}interpolate(e,i){i<e&&([e,i]=[i,e]);let n=this.points[e],r=this.points[i];for(let o=e+1;o<i;++o)this.points[o]=c.interpolate(n,r,(o-e)/(i-e))}redraw(){let e="",i=!0;for(let n of this.points){if(n){let r=this.toViewportCoords(n);e+=(i?"M":"L")+`${r.x},${r.y}`}i=!n}this.$path.setAttr("d",e)}snap(){let e=this.points.filter(n=>n).map(n=>[n.x,n.y]),i=lo.bestPolynomial(e);if(!!i){for(let n=0;n<this.steps;++n){if(!this.points[n])continue;let r=this.plotBounds.xMin+n/this.steps*this.plotBounds.dx;this.points[n]=new c(r,i.fn(r))}this.redraw(),this.trigger("snap",{regression:i})}}clear(){this.points=Zt(void 0,this.steps),this.$path.setAttr("d","")}};sr=$([P("x-coordinate-sketch")],sr);var zm=2,Dc=5e3,ir=class extends He{constructor(){super(...arguments);this.isAnimated=this.hasAttr("animate");this.crosshairGrid=10;this.getCrosshairPosn=e=>e}ready(){let e=d("svg",{},this);if(this.$plot=d("g",{class:"plot"},e),this.$overlay=d("g",{class:"overlay"},e),this.setupCoordinates(e,{showGrid:!0,showAxes:!0,padding:"20"}),this.hasAttr("fn")){let i=$t.parse(this.attr("fn"),!0);this.setFunctions(n=>i.evaluate({x:n}))}Ee(this,"crosshairs",!0)&&(this.crosshairGrid=+this.attr("crosshair-grid")||10,this.setupCrosshairs(e))}setPoints(e,i=1){let n=e.map((r,o)=>new c(o+i,r));this.setSeries(n)}setSeries(...e){let i=Math.max(...e.map(o=>L(o).x)),[n,r]=ba(e);this.updatePlotBounds(new ut(0,i,n,r)),this.$plot.removeChildren();for(let o of e)this.drawLinePlot(o);this.getCrosshairPosn=o=>e[0].reduce((a,h)=>Math.abs(h.x-o.x)<=Math.abs(a.x-o.x)?h:a)}setFunctions(...e){let[i,n]=[this.plotBounds,this.viewportBounds],r=e.map(l=>{let p=[];for(let f=n.xMin;f<n.xMax;f+=zm){let m=this.toPlotCoords(new c(f,0)).x;p.push(new c(m,l(m)))}return p}),[o,a]=ba(r);this.updatePlotBounds(new ut(i.xMin,i.xMax,o,a)),this.$plot.removeChildren();for(let l of r)this.drawLinePlot(l);let h=this.gridSize[0]/this.crosshairGrid;this.getCrosshairPosn=l=>{let p=vt(G(l.x,i.xMin,i.xMax),h);return new c(p,e[0](p))}}drawLinePlot(e){let i=d("g",{},this.$plot),n=d("path",{},i),r=this.plotBounds;e=e.filter(a=>a.y>=r.yMax&&a.y<=r.yMin);let o=e.map(a=>this.toViewportCoords(a));this.isAnimated?dt(a=>{let h=e.findIndex(l=>l.x>r.xMin+a*r.dx);n.points=o.slice(0,h)},Dc):n.points=o}drawPoints(e){let i=d("g",{},this.$plot),n=this.plotBounds;for(let r of e){let o=this.toViewportCoords(r),a=d("circle",{r:4,cx:o.x,cy:o.y},i);if(this.isAnimated){a.hide();let h=Dc*(r.x-n.xMin)/(n.xMax-n.xMin);setTimeout(()=>a.show(),h)}}}setupCrosshairs(e){let i=d("g",{class:"crosshair"},e),n=d("path",{},i),r=d("circle",{r:4},i),o=d("text",{},i),a=0,h=l=>{let p=this.getCrosshairPosn(this.toPlotCoords(l));if(y(p.x,a))return;a=p.x;let f=this.toViewportCoords(p),m=this.toViewportCoords(this.plotOrigin);r.setCenter(f),n.points=[new c(m.x,f.y),f,new c(f.x,m.y)],o.text=`(${It(p.x,5,!1)}, ${It(p.y,5,!1)})`;let g=o.width,x=f.x+8+g<this.viewportBounds.dx;o.setAttr("x",x?f.x+5:f.x-g-5),o.setAttr("y",f.y>20?f.y-7:f.y+18)};Kh(e,{enter:()=>i.show(),move:l=>h(l),exit:()=>i.hide()})}};ir=$([P("x-coordinate-system")],ir);var Gs=class{constructor(s,e){this.$canvas=s;this.defaultCallbacks=e;this.callbacks=new WeakMap;this.global=[];this.isMoving=!1;this.shiftKey=!1;this.altKey=!1;this.cancelled=!1;setTimeout(()=>{document.addEventListener("keydown",i=>{this.shiftKey=i.shiftKey,this.altKey=i.altKey}),document.addEventListener("keyup",i=>{this.shiftKey=i.shiftKey,this.altKey=i.altKey}),document.addEventListener("visibilitychange",()=>{this.shiftKey=this.altKey=!1})},2e3),s.css("touch-action","none"),s.on("pointerdown",i=>this.startEvent(i)),A.onKey("Escape",()=>this.cancel()),e.hover&&s.on("pointermove",i=>{this.isMoving||e.hover({posn:ee(i,s),event:i})})}listen(s,e){this.callbacks.set(s._el,e),s.hasParent(this.$canvas)||(s.css("touch-action","none"),s.on("pointerdown",i=>this.startEvent(i)))}listenAll(s){this.global.push(s)}startEvent(s){var p,f,m;if(s.handled||s.button)return;this.isMoving=!0,this.cancelled=!1,s.preventDefault();let e=s.pointerId,i=this.getCallbacks(s.target);"shiftKey"in s&&(this.shiftKey=s.shiftKey),i.blurInput!==!1&&((p=w.getActiveInput())==null||p.blur());let n=ee(s,this.$canvas),r=n,o=!1,a=g=>{var v,b,E,M;if(g.pointerId&&g.pointerId!==e)return;if(g.preventDefault(),this.cancelled)return h(g);let x=ee(g,this.$canvas);if(c.distance(x,r)<.5)return;if(!o){let T={posn:n,event:g};(v=i.start)==null||v.call(i,T);for(let F of this.global)(b=F.start)==null||b.call(F,T)}let u={posn:x,startPosn:n,lastPosn:r,event:g};(E=i.move)==null||E.call(i,u);for(let T of this.global)(M=T.move)==null||M.call(T,u);!o&&i.cursor!==!1&&xt.addClass("grabbing"),r=x,o=!0},h=g=>{var u,v,b,E,M,T;if(g.pointerId&&g.pointerId!==e)return;g.preventDefault(),A.off("pointermove",a),A.off("pointerstop",h);let x={posn:n,event:g};(u=i.up)==null||u.call(i,x);for(let F of this.global)(v=F.up)==null||v.call(F,x);if(o){let F={posn:r,lastPosn:r,startPosn:n,event:g,cancelled:this.cancelled};(b=i.end)==null||b.call(i,F);for(let mt of this.global)(E=mt.end)==null||E.call(mt,F)}else if(!this.cancelled){let F={posn:n,event:g};(M=i.click)==null||M.call(i,F);for(let mt of this.global)(T=mt.click)==null||T.call(mt,F)}xt.removeClass("grabbing"),this.isMoving=this.cancelled=!1},l={posn:n,event:s};(f=i.down)==null||f.call(i,l);for(let g of this.global)(m=g.down)==null||m.call(g,l);A.on("pointermove",a),A.on("pointerstop",h)}getCallbacks(s){for(;s;){let e=this.callbacks.get(s);if(e&&(!e.checkIfActive||e.checkIfActive()))return e;s=s.parentNode||void 0}return this.defaultCallbacks}cancel(){this.cancelled=!0}};function Fm(t,s){if(typeof t=="string"){let e=at(t);return i=>{var n;return(n=e(s))==null?void 0:n.equals(i)}}return typeof t=="function"?t:e=>t.equals(e)}function $a(t,s,e){let i=s.map(g=>Fm(g,t.model)),n=Zt(void 0,s.length),r=Ne(),o=[],a=({point:g})=>o.push(g),h=e.maxErrors||4,l=0,p=({path:g})=>{e.onBegin&&e.onBegin(g)},f=()=>{n.every(g=>g)&&(e.onComplete&&e.onComplete(!0),t.off("add:path",m),t.off("begin:path",p),t.off("add:point",a),r.resolve(n))},m=({path:g})=>{let x=g.value;if(!!x){for(let[u,v]of i.entries())if(!n[u]&&v(x))return n[u]=g,e.onCorrect&&e.onCorrect(g,u),l=0,o=[],f();g.delete();for(let u of o)u.delete();if(o=[],!(ot(x)&&x.length<1))if(l+=1,l>=h){let u=n.findIndex(b=>!b),v=s[u];if(typeof v!="function"){let b=t.drawPath(v,{animated:1e3});n[u]=b,e.onHint&&e.onHint(b,u),l=0,f()}}else e.onIncorrect&&e.onIncorrect(g)}};return t.on("begin:path",p),t.on("add:path",m),t.on("add:point",a),r.promise}function qc(t,s){return d("text",{target:t.attr("target")||void 0,class:t.attr("label-class")||t.attr("class")||void 0,"data-when":t.data.when,style:s?`color: ${s}`:void 0,"text-anchor":"middle"})}function Gc(t,s){let e=[];for(let i of s.paths)i!==t&&i.value&&e.push(i.value.transform(s.plotToViewportMatrix));return e}var Hm=new et(new c(0,-9),12);function Bc(t,s,e){for(let i of e)if(s.every(n=>!Z(Hm.translate(i),n).length))return i;return e[0]}function zc(t,s){let e=t.value.transform(s.plotToViewportMatrix),i=t.$el;if(ot(e)){let n=e.perpendicularVector,r=e.angle;n.y>=0&&(n=n.scale(-1),r+=Math.PI);let o=[];for(let l of[.5,.35,.65])for(let p of[-15,5])o.push(e.at(l).add(n.scale(p)));if(!s.labelPositioning)return[o[0],r];let a=Gc(t,s),h=Bc(e,a,o);return i.hasAttr("mark")&&(h=h.add(e.unitVector.scale(12))),[h,r]}if(ge(e))return[e.at(.5).subtract(e.c).scale(.6).add(e.c).shift(0,5)];if(Rt(e)){let n=new st(e.start,e.end),r=n.perpendicularVector.y>=0,o=n.angle+(r?Math.PI:0);return[e.at(.5).add(n.perpendicularVector.scale(r?14:5)),o]}if(Nt(e)){let n=(+i.attr("size")||(e.isRight&&!i.hasAttr("round")?20:e.radius))+8;return[e.b.add(e.bisector.unitVector.scale(n+5)).shift(0,3)]}if(it(e)){let n=i.hasClass("move")?10:8,r=[e.shift(n,-n),e.shift(-n,-n),e.shift(n,10+n),e.shift(-n,10+n)];if(!s.labelPositioning)return[r[0]];let o=Gc(t,s);return[Bc(e,o,r)]}return _t(e)?[e.centroid.shift(0,5)]:j(e)?[e.c.shift(0,5)]:[]}var nr=class{constructor(s,e,i,n){this.$parent=s;this.$el=i;this.color="";this.label="";this.isPending=!1;this.isLocked=!1;this.components=[];this.dependencies=[];this.fixedLabel=!1;this.name=n||s.model.getKey(),s.shapes.set(this.name,this),s.model.watch(r=>{let o=r[this.name];this.$el.css("display",o?"block":"none"),this.$label&&this.$label.css("display",o?"block":"none"),o&&this.redraw(o),s.queueLabelPositioning()}),this.color=i.css("color")||"",this.setValue(e),i.hasAttr("label")&&this.setLabel(i.attr("label"))}get value(){return this.$parent.model[this.name]}get type(){var s;return(s=this.value)==null?void 0:s.type}get locked(){return this.isLocked}get isHidden(){return this.isPending||this.$el.hasAttr("hidden")||this.$el.hasClass("transparent")}setValue(s){s instanceof Function?this.$parent.model.setComputed(this.name,s):this.$parent.model[this.name]=s}setLabel(s,e,i){this.$label||(this.$label=qc(this.$el,e),this.$parent.$objLabels.append(this.$label));let n=tn(s);if(this.$parent.model.watch(r=>this.$label.text=n(r)||""),this.fixedLabel=!!i,i){let r=at(i);this.$parent.model.watch(o=>{this.$label.setTransform(r(o).shift(0,5))})}this.updateLabelPosition()}setColor(s){this.color=s,this.$el.css("color",s);for(let e of this.dependencies)e.setColor(s);this.$label&&this.$label.css("color",s)}updateLabelPosition(){if(!this.$label||!this.value||this.fixedLabel)return;let[s,e]=zc(this,this.$parent);this.$label.setTransform(s,e)}select(){this.$el.addClass("selected"),this.$el.parent.append(this.$el);for(let s of this.dependencies)s.select()}deselect(){this.$el.removeClass("selected");for(let s of this.dependencies)s.deselect()}hover(s=!1){if(!s){if(this.$parent.hovering===this)return;this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.hovering=this}this.$el.addClass("hover");for(let e of this.dependencies)e.hover(!0)}unhover(s=!1){if(!s){if(this.$parent.hovering!==this)return;this.$parent.hovering=void 0}this.$el.removeClass("hover");for(let e of this.dependencies)e.unhover(!0)}delete(s=300){return O(this,null,function*(){this.$parent.shapes.delete(this.name);for(let e of this.components)e.deselect();this.$label&&this.$label.exit("fade",s,0,!0),yield this.removeElement(s),this.$parent.model[this.name]=void 0})}},Te=class extends nr{constructor(e,i,n,r,o=!1){r||(r=d("circle",{}));super(e,i,r,n);this.$parent.hidePoints||e.$points.append(this.$el),e.points.add(this),this.projectionId=e.model.getKey(),this.projectionOffset=void 0,e.model.watch(a=>{this.projection=a[this.projectionId],this.projection&&(this.projectionOffset===void 0&&(this.projectionOffset=this.projection.offset(this.$parent.model[this.name])),this.$parent.model[this.name]=this.projection.at(this.projectionOffset))}),this.lock(o)}setValue(e){e instanceof Function?(this.project(void 0),this.$parent.model.setComputed(this.name,e)):(e&&this.projection&&(e=this.projection.project(e),this.projectionOffset=this.projection.offset(e)),this.$parent.model[this.name]=e)}redraw(e){let i=e.transform(this.$parent.plotToViewportMatrix);this.$el.setCenter(i),this.$halo&&this.$halo.setCenter(i),this.$pulse&&this.$pulse.setCenter(i)}removeElement(e){return O(this,null,function*(){this.$parent.points.delete(this),yield this.$el.exit("pop",e,0,!0).promise})}distance(e){return this.value?c.distance(e,this.value):1/0}lock(e=!0){this.isLocked=e,this.$el.setClass("move",!e),e?this.$el.removeAttr("tabindex"):this.$el.setAttr("tabindex",0)}project(e){if(this.projectionOffset=void 0,typeof e=="string"){let i=at(e);this.$parent.model.setComputed(this.projectionId,i)}else e?this.$parent.model.setComputed(this.projectionId,()=>e.value):this.$parent.model[this.projectionId]=void 0}makeIntersection({path1:e,path2:i,index:n}){this.setValue(r=>{if(!r[e.name]||!r[i.name])return;let o=Z(r[e.name],r[i.name]);return o[Math.min(n,o.length-1)]}),this.lock()}addHalo(){this.$halo=d("circle",{class:"halo",r:18},this.$parent.$pulses),this.$halo.setCenter(this.$el.center),this.$halo.enter("pop")}removeHalo(){return O(this,null,function*(){!this.$halo||(this.$halo.exit("pop",500,0,!0),this.$halo=void 0)})}pulsate(){this.$pulse=d("circle",{class:"pulse",r:8},this.$parent.$pulses),this.$pulse.setCenter(this.$el.center),this.$el.one("mouseover pointerdown focus",()=>{this.$pulse&&this.$pulse.remove(),this.$pulse=void 0})}},Re=class extends nr{constructor(s,e,i,n){super(s,e,n||d("path"),i),s.$paths.append(this.$el),s.paths.add(this)}get locked(){return this.isLocked||!this.components.length||this.components.every(s=>s.locked)}redraw(s){let e=s.transform(this.$parent.plotToViewportMatrix);this.$el.draw(e,{box:this.$parent.viewportRect})}distance(s){return this.value?c.distance(s,this.value.project(s)):1/0}removeElement(s){return O(this,null,function*(){this.$parent.paths.delete(this),yield this.$el.exit("draw",s,0,!0).promise})}setComponents(s,e){this.components=this.dependencies=s,this.setValue(()=>{let i=s.map(n=>n.value);if(!i.some(n=>n===void 0))return e(...i)})}};var Ei=class{constructor(s){this.$parent=s}enable(){}down(s){}start(s){}move(s,e){}end(s){}hover(s){}click(s){}cancel(){}snapToGrid(s){return this.$parent.snapToGrid?s.round(this.$parent.snapToGrid):s}snapToPoint(s,e){if(this.snapPoint=this.$parent.getPointAt(e),this.snapPoint)return s.$el.setClass("move",!this.snapPoint.locked),s.setValue(this.snapPoint.value);if(this.snapIntersect=this.$parent.getIntersectionAt(e),this.snapIntersect)return s.$el.removeClass("move"),s.setValue(this.snapIntersect.posn);if(!this.$parent.snapToGrid&&(this.snapPath=this.$parent.getPathAt(e),this.snapPath))return s.setValue(this.snapPath.value.project(e));s.$el.addClass("move"),s.setValue(this.snapToGrid(e))}getOrMakePointAt(s){let e=this.$parent.getPointAt(s);if(!e){e=new Te(this.$parent,this.snapToGrid(s));let i=this.$parent.getIntersectionAt(s);if(i)e.makeIntersection(i);else if(!this.$parent.snapToGrid){let n=this.$parent.getPathAt(s);n&&e.project(n)}this.$parent.trigger("add:point",{point:e})}return e}showPendingPointAt(s){var n,r,o;let e=((n=this.$parent.getIntersectionAt(s))==null?void 0:n.posn)||((o=(r=this.$parent.getPathAt(s))==null?void 0:r.value)==null?void 0:o.project(s)),i=!!e;if(this.$parent.$pendingPoint.toggle(i),i){let a=this.$parent.toViewportCoords(e||s);this.$parent.$pendingPoint.setCenter(a)}}},Ti=class extends Ei{constructor(){super(...arguments);this.isMoving=!1}enable(){}down(e){this.obj=this.$parent.getPointAt(e)||this.$parent.getPathAt(e),this.obj||this.$parent.deselect();let i=this.$parent.selection;i!==this.obj&&(i&&i.components.includes(this.obj)||this.$parent.select(this.obj))}start(){!this.obj||(this.isMoving=!0,this.obj.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("move",{obj:this.obj}))}move(e,i){if(!(!this.obj||this.obj.locked||this.$parent.locked))if(this.obj instanceof Re){let n=e.subtract(i);for(let r of this.obj.components)r.locked||r.setValue(r.value.add(n))}else this.obj instanceof Te&&this.obj.setValue(this.snapToGrid(e))}end(){!this.obj||(this.isMoving=!1,this.obj.isPending=!1,this.snapPoint||(this.snapIntersect?this.obj.makeIntersection(this.snapIntersect):this.snapPath&&this.obj.project(this.snapPath)),this.$parent.trigger("moveEnd",{path:this.obj}),this.obj=void 0,this.$parent.updateIntersections())}hover(e){if(this.isMoving)return;let i=this.$parent.getPointAt(e)||this.$parent.getPathAt(e),n=i&&!this.$parent.locked&&!i.locked,r=i&&this.$parent.canSelect;this.$parent.setCursor(n?"grab":r?"pointer":"default"),n||r?i.hover():this.$parent.hovering&&this.$parent.hovering.unhover()}},rr=class extends Ti{down(s){this.$parent.deselect(),this.obj=this.getOrMakePointAt(s),this.$parent.select(this.obj)}hover(s){let e=this.$parent.getPointAt(s);if(e)return this.$parent.setCursor(this.$parent.locked||e.locked?"default":"grab"),this.$parent.$pendingPoint.hide(),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(s)}},Bs=class extends Ei{enable(){this.$parent.setCursor("crosshair")}down(e){this.$parent.deselect(),this.startPoint=this.getOrMakePointAt(e)}start(e){!this.startPoint||(this.$parent.$pendingPoint.hide(),this.endPoint=new Te(this.$parent,e),this.endPoint.isPending=!0,this.endPoint.$el.addClass("pending"),this.path=new Re(this.$parent,void 0),this.path.setComponents([this.startPoint,this.endPoint],this.expr),this.path.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("begin:path",{path:this.path,start:this.startPoint}))}move(e){if(!this.startPoint||!this.path||!this.endPoint)return;if(c.distance(e,this.startPoint.value)<20/this.$parent.plotScale)return this.endPoint.setValue(this.snapToGrid(e));this.snapToPoint(this.endPoint,e)}end(){if(!this.startPoint||!this.path||!this.endPoint)return;this.path.isPending=!1,this.endPoint.isPending=!1,this.startPoint.value.equals(this.endPoint.value)?(this.endPoint.delete(),this.path.delete(),this.path=this.endPoint=void 0):this.snapPoint?(this.path.setComponents([this.startPoint,this.snapPoint],this.expr),this.endPoint.delete(),this.endPoint=void 0):this.snapIntersect?this.endPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.endPoint.project(this.snapPath),this.endPoint&&(this.$parent.trigger("add:point",{point:this.endPoint}),this.endPoint.$el.removeClass("pending"));let e=this.path;this.startPoint=this.endPoint=this.path=void 0,e&&(this.$parent.trigger("add:path",{path:e}),this.$parent.updateIntersections())}hover(e){let i=this.$parent.getPointAt(e);if(i)return this.$parent.$pendingPoint.hide(),i.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.showPendingPointAt(e)}cancel(){this.endPoint&&this.endPoint.delete(),this.path&&this.path.delete(),this.$parent.$pendingPoint.hide(),this.startPoint=this.endPoint=this.path=void 0}},or=class extends Bs{expr(s,e){return new X(s,e)}},ar=class extends Bs{expr(s,e){return new et(s,c.distance(s,e))}},hr=class extends Bs{expr(s,e){return new R(s,e.x-s.x,e.y-s.y)}},lr=class extends Bs{expr(s,e){return new X(s,e).perpendicularBisector}},Fc=(t,s,e)=>new pt(t,s,e).bisector,cr=class extends Ei{enable(){}down(e){if(this.$parent.deselect(),!this.firstPoint)this.firstPoint=this.getOrMakePointAt(e),this.firstPoint&&this.firstPoint.addHalo();else if(this.secondPoint){this.path.isPending=this.thirdPoint.isPending=!1,this.thirdPoint.$el.removeClass("pending"),this.firstPoint.removeHalo(),this.secondPoint.removeHalo(),this.snapPoint?(this.path.setComponents([this.firstPoint,this.secondPoint,this.snapPoint],Fc),this.thirdPoint.delete(),this.thirdPoint=void 0):this.snapIntersect?this.thirdPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.thirdPoint.project(this.snapPath);let i=this.path,n=this.thirdPoint;this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0,n&&this.$parent.trigger("add:point",{point:n}),this.$parent.trigger("add:path",{path:i}),this.$parent.updateIntersections()}else{if(this.secondPoint=this.getOrMakePointAt(e),!this.secondPoint)return;this.secondPoint.addHalo(),this.thirdPoint=new Te(this.$parent,this.secondPoint.value),this.thirdPoint.$el.addClass("pending"),this.path=new Re(this.$parent,void 0),this.path.setComponents([this.firstPoint,this.secondPoint,this.thirdPoint],Fc),this.path.isPending=this.thirdPoint.isPending=!0}}hover(e){if(this.$parent.$pendingPoint.hide(),this.thirdPoint){this.snapToPoint(this.thirdPoint,e),this.$parent.setCursor(this.snapPoint?"pointer":"crosshair");return}let i=this.$parent.getPointAt(e);if(i)return this.$parent.setCursor("pointer"),i.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(e)}cancel(){this.firstPoint&&this.firstPoint.removeHalo(),this.secondPoint&&this.secondPoint.removeHalo(),this.thirdPoint&&this.thirdPoint.delete(),this.path&&this.path.delete(),this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0}};var Hc='<x-select class="tools"><div class="tool" data-tool="move"><x-icon name="hand" size="28"></x-icon></div><div class="tool" data-tool="point"><x-icon name="geo-point" size="28"></x-icon></div><div class="tool" data-tool="line"><x-icon name="geo-line" size="28"></x-icon></div><div class="tool" data-tool="rectangle"><x-icon name="geo-rectangle" size="28"></x-icon></div><div class="tool" data-tool="circle"><x-icon name="geo-circle" size="28"></x-icon></div><div class="tool" data-tool="perpBisector"><x-icon name="geo-perp-bisector" size="28"></x-icon></div><div class="tool" data-tool="angleBisector"><x-icon name="geo-angle-bisector" size="28"></x-icon></div></x-select><slot></slot>';var pr=class extends He{constructor(){super(...arguments);this.shapes=new Map;this.points=new Set;this.paths=new Set;this.intersections=new Set;this.snapToGrid=0;this.locked=!1;this.hidePoints=!1;this.canSelect=!1;this.canIntersect=!1;this.canProject=!0;this.labelPositioning=!1;this.cursor="default"}ready(){let e=this.children.filter(h=>h.tagName==="SVG")[0];if(this.hasAttr("complex")&&(this.setAttr("label-suffix",",i"),this.setAttr("axis-names","Real, Imaginary"),this.setAttr("axes","true"),this.setAttr("grid","true")),!this.hasAttr("x-axis")&&!this.hasAttr("y-axis")){let h=+this.attr("grid"),l=+this.attr("width")||this.width,p=+this.attr("height")||l;this.setAttr("x-axis",h?`-0.5,${l/h-.5},1`:`0,${l},1`),this.setAttr("y-axis",h?`${p/h-.5},-0.5,1`:`${p},0,1`),h&&this.setAttr("snap",1)}this.setupCoordinates(e,{proportional:!0}),this.viewportRect=this.viewportBounds.rect,this.model=this.getParentModel()||Ht({}),this.model.hasGeoModel||this.model.assign(Oc),this.$paths=d("g",{class:"paths"},e),this.$pulses=d("g",{class:"pulses"},e),this.$points=d("g",{class:"points"},e),this.$objLabels=d("g",{class:"labels"},e),this.snapToGrid=this.hasAttr("snap")?+this.attr("snap")||1:0,this.hidePoints=this.hasAttr("no-points"),this.canIntersect=Ee(this,"intersections",!1),this.canProject=Ee(this,"projections",!0),this.canSelect=Ee(this,"selectable",!1),this.labelPositioning=Ee(this,"label-positioning",!0),this.hasClass("sticky")&&this.css("top",`calc(50vh - ${this.height/2}px)`),this.queueLabelPositioning=ue(()=>{for(let h of this.shapes.values())h.updateLabelPosition()},0,!0);let i=e.$$("path[x], path[\\:d], circle");for(let h of i){let l=h.hasAttr("x")?at(h.attr("x")):void 0,p=h.attr("name");if(h.hasAttr(":d"))this.$paths.append(h),h.bindModel(this.model);else if(h.tagName==="PATH")this.$paths.append(h),new Re(this,l,p,h);else{this.$points.append(h);let f=!h.hasClass("move"),m=l||h.center,g=new Te(this,m,p,h,f);h.hasAttr("project")&&g.project(h.attr("project")),h.hasClass("pulsate")&&g.pulsate()}}this.$pendingPoint=d("circle",{class:"pending"},this.$points),this.$pendingPoint.hide(),this.updateIntersections();let n={move:new Ti(this),point:new rr(this),line:new or(this),circle:new ar(this),perpBisector:new lr(this),angleBisector:new cr(this),rectangle:new hr(this)};this.$tools=this.$(".tools");let r=n[this.$tools.$active.data.tool];r.enable();let o=()=>this.toolOverride||r;this.$tools.on("change",h=>{o().cancel(),this.toolOverride=void 0,r=n[h.data.tool],this.hovering&&this.hovering.unhover(),this.$pendingPoint.hide(),this.hovering=void 0,this.deselect(),r.enable()});let a=(h,l=!1)=>this.toPlotCoords(l?h.clamp(this.viewportBounds,8):h);new Gs(e,{down:h=>o().down(a(h.posn)),start:h=>o().start(a(h.posn)),move:h=>o().move(a(h.posn,!0),a(h.lastPosn,!0)),end:h=>o().end(a(h.posn,!0)),click:h=>o().click(a(h.posn)),hover:h=>o().hover(a(h.posn))}),A.onKey("Escape",()=>o().cancel()),A.onKey("Backspace Clear Delete",()=>this.delete()),document.addEventListener("keydown",h=>{if([37,38,39,40].indexOf(h.keyCode)<0)return;let p=w.getActiveInput();if(!(!p||!p.hasParent(this))){h.preventDefault();for(let f of this.points){if(f.$el!==p||!f.value)continue;let m=15/this.plotScale,g=this.plotBounds.yMin>this.plotBounds.yMax?-1:1,x=h.keyCode===37?-m:h.keyCode===39?m:0,u=h.keyCode===38?-g*m:h.keyCode===40?g*m:0;f.setValue(f.value.shift(x,u));return}}})}switchTool(e){this.$tools.makeActive(this.$(`.tool[data-tool="${e}"]`))}setCursor(e="default"){e!==this.cursor&&(this.cursor=e,this.$svg.css("cursor",e))}select(e){!this.canSelect||(this.deselect(),e&&(this.selection=e,e.select()),this.trigger("select",{shape:e}))}deselect(){!this.selection||(this.selection.deselect(),this.selection=void 0,this.trigger("select",{shape:void 0}))}delete(){this.hovering&&this.hovering.unhover(),this.selection&&this.selection.delete(),this.trigger("select",{shape:void 0})}redraw(){this.resize(),this.viewportRect=this.viewportBounds.rect,this.model.forceUpdate()}getPointAt(e,i=20){if(this.hidePoints)return;let n=r=>r.isHidden?void 0:r.distance(e);return er(this.points,n,i/this.plotScale)}getPathAt(e,i=10){if(this.hidePoints||!this.canProject)return;let n=r=>r.isHidden?void 0:r.distance(e);return er(this.paths,n,i/this.plotScale)}getIntersectionAt(e,i=20){if(!this.canIntersect)return;let n=r=>c.distance(e,r.posn);return er(this.intersections,n,i/this.plotScale)}updateIntersections(){!this.canIntersect||this.hidePoints||Rc(this.paths,this.intersections)}drawPath(e,i={}){typeof e=="string"&&(e=at(e));let n=new Re(this,e,i.name);i.classes&&n.$el.addClass(i.classes),i.target&&n.$el.setAttr("target",i.target);let r=n.$el.hasClass("fill")?"fade":"draw";return i.animated&&n.$el.enter(r,i.animated),n}drawPoint(e,i={}){typeof e=="string"&&(e=at(e));let n=new Te(this,e,i.name,void 0,i.interactive===!1);return i.classes&&n.$el.addClass(i.classes),i.target&&n.$el.setAttr("target",i.target),i.animated!==0&&n.$el.enter("pop",i.animated||500),n}animatePoint(e,i,n=400){let r=this.shapes.get(e),o=new X(this.model[e],i);return dt(a=>r.setValue(o.at(bt("quad",a))),n)}animateConstruction(e,i=2e3){return O(this,null,function*(){let n=this.shapes.get(e),r=n.value;if(j(r)&&(r=r.arc),ot(r)){this.$ruler||(this.$ruler=d("path",{d:_c,class:"sketch"},this.$svg));let o=ps(r.at(-.1),12,r.angle-.3,r.length*1.2),a=ps(r.at(-.1),12,r.angle,r.length*1.2);this.$ruler.show(),n.$el.hide(),yield this.$ruler.animate({opacity:[0,1],transform:[o,a]},500).promise,yield n.$el.enter("draw",i).promise,yield this.$ruler.animate({opacity:[1,0],transform:[a,o]},500).promise}else if(Rt(r)){this.$compass||(this.$compass=d("path",{d:Lc,class:"sketch"},this.$svg));let o=ps(r.c,50,r.startAngle,r.radius*1.5),a=ps(r.c,50,r.startAngle,r.radius),h=ps(r.c,50,r.startAngle+r.angle,r.radius),l=ps(r.c,50,r.startAngle+r.angle,r.radius*1.5);this.$compass.show(),n.$el.hide(),yield this.$compass.animate({opacity:[0,1],transform:[o,a]},500).promise,n.$el.enter("draw",i),yield this.$compass.animate({transform:[a,h]},i,0,"linear").promise,yield this.$compass.animate({opacity:[1,0],transform:[h,l]},500).promise}})}showGesture(e,i){this.$gesture||(this.$gesture=d("x-gesture",{},this)),this.$gesture.stop();let n=this.toViewportCoords(at(e)(this.model));if(this.$gesture.from=n,i){let r=this.toViewportCoords(at(i)(this.model));this.$gesture.start(r.subtract(n))}else this.$gesture.start();this.one("click mouseover pointerdown",()=>this.$gesture.stop())}waitForPoint(){return O(this,null,function*(){return new Promise(e=>{this.one("add:point",({point:i})=>e(i))})})}waitForPath(n){return O(this,arguments,function*(e,i={}){return(yield $a(this,[e],i))[0]})}waitForPaths(e,i={}){return $a(this,e,i)}};pr=$([P("x-geopad",{template:Hc})],pr);var jc='<div class="image"></div><div class="content"><slot></slot></div>';var dr=class extends S{ready(){let s=this.$(".image"),e=this.positionTop<50,i,n;s.css({"background-image":`url("${this.attr("background")}")`,height:e?"100%":"150%"});let r=({height:a})=>{let h=this.positionTop;i=Math.max(0,h-a),n=h+this.height};function o(a){if(a.top<i||a.top>n)return;let h=(a.top-i)/(n-i)*(e?50:33);s.css("transform",`translateY(${h}%)`)}w.onResize(r),A.on("scroll",o)}};dr=$([P("x-parallax",{template:jc})],dr);var jm=new Set(["watch","assign","updateTheme","raw"]);function Uc(t){let s=new Map,e=(o,a)=>{for(let h of K(o))s.has(h)||s.set(h,[]),s.get(h).push(a);a(r)},i=o=>{Object.assign(t,o);let a=Pt(Object.keys(o).flatMap(h=>{var l;return(l=s.get(h))!=null?l:[]}));for(let h of a)h(r)},n=()=>{var o;for(let a of(o=s.get("color"))!=null?o:[])a(r)},r=new Proxy(t,{get(o,a){switch(a){case"watch":return e;case"assign":return i;case"updateTheme":return n;case"raw":return t;case"copy":return()=>Object.assign({},t);case"color":return Ds(t.color);default:return t[a]}},set(o,a,h){var l;if(jm.has(a))return!1;if(t[a]===h)return!0;t[a]=h;for(let p of(l=s.get(a))!=null?l:[])p(r);return!0}});return r}function Wc(t,s){let e={},i={},n=!1;for(let r of Object.keys(s))s[r]!==t[r]&&(n=!0,e[r]=s[r],i[r]=t[r]);return n?[i,e]:void 0}var Kc=6,Um="M8.1-1.7l-14-8.8c-0.6-0.4-1.4-0.4-2-0.1c-0.6,0.4-1,1-1,1.7V8.8c0,0.7,0.4,1.4,1,1.7c0.3,0.2,0.6,0.3,1,0.3c0.4,0,0.7-0.1,1.1-0.3l14-8.8C8.6,1.3,9,0.7,9,0S8.6-1.3,8.1-1.7z",Si=!1;function Xc(t){if(!Array.isArray(t))return Xc([t,0]);let[s,e]=t;if(s instanceof c)return[[s,e]];if(j(s)&&(s=new R(s.c.shift(-s.r),2*s.r,2*s.r)),!(s instanceof C)&&!(s instanceof R))return[[I,0]];let i=s.edges.map(n=>[n.midpoint,n.perpendicularBisector.angle]).filter(n=>!y(n[1],1.5*Math.PI));return ii(i,e)}var ur=class{constructor(s,e,i){this.tile=s;this.name=e;this.options={};this.cables=new Set;i&&this.setOptions(i)}get location(){let s=this.options.location;return Array.isArray(s)?s[0]:s}get type(){return(this.location||this.tile.path)instanceof c?"POINT":"REGION"}get points(){let s=this.options.location||this.tile.path||I;return Xc(s).map(e=>[this.tile.worldPosn(e[0]),e[1]])}setOptions(s,e=!0){Object.assign(this.options,s),e&&this.redraw()}redraw(){for(let s of this.cables)s.redraw()}},fr=class extends ur{sendMessage(s){this.cables.size===0&&this.redraw();for(let e of this.cables.values())e.enqueueMessage(s,!1);Yc()}addCable(s,e=!1){this.cables.add(s),!s.to&&!s.dragging&&this.cables.size>1&&this.removeCable(s,!1),e&&(this.updateTileProps(),this.tile.$parent.change({changed:[this.tile]})),this.redraw()}removeCable(s,e=!0){this.cables.delete(s),s.delete(),e&&this.redraw()}redraw(){if(me(this.cables,s=>s.to))for(let s of this.cables)!s.to&&!s.dragging&&this.removeCable(s);this.cables.size||this.addCable(new ie(this)),super.redraw()}updateTileProps(){let s=Array.from(this.tile.getCableData());this.tile.props.cables=s.length?s:void 0}delete(){for(let s of this.cables)s.delete()}},mr=class extends ur{setOptions(e,i=!0){Object.assign(this.options,e);let n=Array.isArray(e.location)?e.location[0]:e.location;n instanceof c?this.$dot=d("circle",{class:"link-dot persist",r:Kc,cx:n.x,cy:n.y},this.tile.$el):this.$dot&&this.$dot.remove(),i&&this.redraw()}addCable(e,i){i&&this.tile.highlight(!0),this.cables.add(e),this.options.connect&&this.options.connect(e)}removeCable(e,i){var n,r;i&&this.tile.highlight(!1),(r=(n=this.options).disconnect)==null||r.call(n,e),this.cables.delete(e)}delete(){for(let e of this.cables)e.from.removeCable(e)}validateConnection(e){return Ta(e,this)}},Ea=[],Pa=!1;function Yc(){var s,e;if(Pa)return;Pa=!0;let t=0;for(;Ea.length;){if(t>=1e4)throw new Error("Queue overflow!");let[i,n]=Ea.shift();(s=i.to)!=null&&s.options.message&&((e=i.to)==null||e.options.message(n,i)),t++}Pa=!1}function Ta(t,s){if(t.tile===s.tile||s.options.max&&[...s.cables].filter(r=>r.from!==t||r.to!==s).length>=s.options.max)return!1;let e=s.options.tileTypes;if(e){let n=t.tile.props.name;if(!e.includes(n))return!1}let i=t.options.tileTypes;if(i){let n=s.tile.props.name;if(!i.includes(n))return!1}return!0}var ie=class{constructor(s,e){this.from=s;this.dragging=!1;let i=this.from.tile.$parent,n=s.options.persistent?"":"dashed";this.$group=d("g",{class:"link-bar",style:"display:none"},s.tile.$el),this.$line=d("path",{style:"pointer-events: none",class:n},this.$group),this.$originDot=d("circle",{class:"link-dot",r:Kc},this.$group),this.$handle=d("path",{class:"link-handle",d:Um},this.$group),this.connectTo(e),i.events.listen(this.$handle,{start:()=>{i.selection.add(s.tile,!0),Si=this.dragging=!0},move:({posn:o})=>{this.connectTo(i.getInputAt(o,this.from),o)},end:()=>{Si=this.dragging=!1,this.to&&this.to.tile.highlight(!1),this.redraw(),s.addCable(this,!0)},click:()=>{this.connectTo(),s.addCable(this,!0)}});let r;i.events.listen(this.$originDot,{start:()=>{i.selection.add(s.tile,!0),r=new ie(this.from),Si=r.dragging=!0,this.from.addCable(r)},move:({posn:o})=>{r.connectTo(i.getInputAt(o,this.from),o)},end:()=>{r.to&&r.to.tile.highlight(!1),r.redraw(),Si=r.dragging=!1,s.addCable(r,!0),r=void 0}})}connectTo(s,e){this.to&&this.to!==s&&this.to.removeCable(this,!0),s?this.to!==s&&Ta(this.from,s)&&(this.to=s,s.addCable(this,e!==void 0),this.from.options.connect&&this.from.options.connect(this)):this.to=void 0,this.redraw(e)}redraw(s){var x;if(!(this.from.options.persistent||this.from.tile.isActive||((x=this.to)==null?void 0:x.tile.isActive)))return this.$group.hide();if(this.from.tile.$el.append(this.$group),this.$group.show(),!this.to&&!s){let[u,v]=this.from.points[0],b=new et(I,20).at(v/(Math.PI*2));this.$handle.setTransform(this.from.tile.relativePosn(u).add(b),v),this.$line.setAttr("d",""),this.$originDot.hide();return}let i=this.to?this.to.points:[[s,0]],n=ms(this.from.points,i),[r,o]=Xe(n,([u,v])=>c.distance(u[0],v[0])),a=this.from.tile.relativePosn(r[0]),h=o[1]+Q((this.to?this.to.tile.rot:180)-this.from.tile.rot),l=this.to?new et(I,14).at(h/(Math.PI*2)):I,p=this.from.tile.relativePosn(o[0]).add(l),f=c.distance(a,p),m=a.add(c.fromPolar(r[1],f*.7)),g=p.add(c.fromPolar(h,Math.max(f*.7,40)));this.$line.setAttr("d",`M${p.x} ${p.y}C${g.x} ${g.y},${m.x} ${m.y},${a.x} ${a.y}`),this.$handle.setTransform(p,h+Math.PI,this.to?.8:1),this.$originDot.setTransform(a),this.$originDot.show()}delete(){this.connectTo(),this.$group.remove()}enqueueMessage(s,e=!0){if(Ea.push([this,s]),e&&Yc(),!this.from.options.highlights)return;let n=s.type==="number"&&s.value===1?q.yellow:q.blue;this.$line.setAttr("style",`stroke: ${n}`),this.$handle.setAttr("style",`fill: ${n}`)}serialize(){return this.to?{fromPort:this.from.name,toTileId:this.to.tile.id,toPort:this.to.name}:void 0}static unSerialize(s,e,i){var o,a;let n=i.tiles.get(s),r=i.tiles.get(e.toTileId);if(n&&r){let h=(o=n.outPorts)==null?void 0:o.get(e.fromPort||"main"),l=(a=r.inPorts)==null?void 0:a.get(e.toPort||"main");h&&l&&Ta(h,l)&&h.addCable(new ie(h,l))}}static get isMoving(){return Si}};var q={grey:"#cccccc",darkGrey:"#242436",red:"#cd0e66",orange:"#eb4726",yellow:"#fd8c00",lime:"#bfc212",green:"#22ab24",teal:"#009ea6",blue:"#0f82f2",purple:"#6d3bbf"},Wm="M12.5,0H0V25H12.5a12.5,12.5,0,0,0,0-25Z",Km="M0,0V12.5a12.5,12.5,0,0,0,25,0V0Z",Sa=new Map,gr=new Map,vr=[];function Bt(t){Sa.set(t.type,t)}function qt(t){vr.push(...t)}var tt=class{constructor(s,e,i,n){this.$parent=s;this.rot=0;this.snapPoints=[];this.snapLines=[];this.snapAngles=[0,90];this.id=i||ds(10),e.name||(e.name=this.constructor.type),this.props=Uc(e),this.posn=new c(this.props.x||0,this.props.y||0),this.rot=e.rot||0,this.$el=n||d("g",{class:"tile"},s.$tiles[2]),s.tiles.set(this.id,this),gr.set(this.$el._el,this),this.props.watch("status",({status:r})=>{this.$el.setClass("locked-tile",r==="locked"),this.$el.setClass("hidden-tile",r==="hidden"),this.canSelect||this.$parent.selection.remove(this)}),this.props.watch("layer",()=>this.$container.append(this.$el)),this.props.watch("hideHandles",({hideHandles:r})=>this.$el.setClass("no-handles",!!r))}static create(s,e,i){let n=Sa.get(e.name);if(!n)throw new Error(`Unknown tile type: ${e.name}`);n.defaultProps&&(e=Object.assign({},n.defaultProps,e));let r=new n(s,e,i);return r.setTransform(),r.serialize(),r}static thumbnail(s,e,i){var o;let n=Sa.get(e);if(!n)throw new Error(`Unknown tile type: ${e}`);let r=fe(i.attr("props"),{});return(o=n.makeThumbnail)==null?void 0:o.call(n,i,r,s)}delete(){var s,e;for(let i of this.polypadOptionCallbacks||[])this.$parent.options.unwatch(i);this.$parent.selection.remove(this);for(let i of((s=this.inPorts)==null?void 0:s.values())||[])i.delete();for(let i of((e=this.outPorts)==null?void 0:e.values())||[])i.delete();this.$parent.tiles.delete(this.id),this.$parent.mathContext.removeSource(this),gr.delete(this.$el._el),this.$el.remove()}applyChange(s){this.props.assign(s),Object.assign(this.lastSavedData||{},s),("x"in s||"y"in s||"rot"in s)&&this.setTransform(new c(this.props.x,this.props.y),this.props.rot)}recreate(s){let e=Object.assign({},this.props.raw,s),i=[...e.cables||[],...this.getCableData("in")];this.delete();let n=tt.create(this.$parent,e,this.id);for(let r of i)ie.unSerialize(this.id,r,this.$parent);n.serialize()}serialize(){return this.lastSavedData=this.props.copy()}makeHandle(s,e,i,n,r){let a=d(s==="c"?"circle":"path",{class:"handle"},this.$el);return s==="h"&&a.setAttr("d",Wm),s==="v"&&a.setAttr("d",Km),s==="c"&&a.setAttr("r",10),this.$parent.events.listen(a,{start:()=>{this.$parent.selection.add(this,!0),n==null||n()},move:({posn:h})=>e(this.relativePosn(h),h),click:()=>i==null?void 0:i(),end:()=>{r==null||r(),this.$parent.change({changed:[this]})}}),a}is(s){return this.props.name===s}get $container(){let s=this.props.layer==="back"?0:this.props.layer==="front"?2:1;return this.$parent.$tiles[s*2+(this.isActive?1:0)]}get canSelect(){return this.$parent.state.setupMode||this.props.status!=="hidden"&&this.props.status!=="locked"}watchPolypadOptions(s){this.polypadOptionCallbacks||(this.polypadOptionCallbacks=[]),this.polypadOptionCallbacks.push(s),this.$parent.options.watch(s)}showErrorIcon(s){var e;if(this.currentError=s,!s)return(e=this.$errorIcon)==null?void 0:e.detach();this.$errorIcon||(this.$errorIcon=d("g",{style:"cursor: pointer"}),d("circle",{cx:12,cy:12,r:12,fill:"transparent"},this.$errorIcon),Ac("warning",q.yellow,24,void 0,this.$errorIcon),this.transform(),this.$parent.events.listen(this.$errorIcon,{click:()=>{let i=this.$errorIcon.transformMatrix,n=this.posn.shift(i[0][2],i[1][2]);this.$parent.warningBanner.show(n,this.currentError)}})),this.$el.append(this.$errorIcon)}setCollision(s){var e;s&&s===this.collision||((e=this.collision)==null||e.highlight(!1),this.collision=s,s==null||s.highlight(!0))}collide(s){}get ariaDescription(){return this.props.name}click(s){}doubleClick(s){}down(s){}up(s){}format(s,e){}focus(){this.$parent.focussedTile=this,this.$parent.selection.clear(),this.isFocussed=!0,this.$parent.trigger("change-focus",{tiles:[this]})}blur(){this.isFocussed=!1,this.$parent.focussedTile=void 0,this.$parent.trigger("change-focus",{tiles:[]})}highlight(s=!0){}select(){this.isActive=!0,this.$el.addClass("active"),this.$container.append(this.$el),this.redrawCables()}deselect(){this.isActive=!1,this.$el.removeClass("active"),this.$container.append(this.$el),this.redrawCables()}moveStart(s=!1){this.startPosn=this.posn}move(s,e){s&&(this.posn=this.startPosn.add(s),this.transform(!0))}moveEnd(){this.collision&&this.collide(this.collision),this.setTransform()}rotate(){}transform(s){var i;let e=Q(this.rot);this.$el.setTransform(this.posn,e),this.redrawCables(),!s&&this.path&&(this.transformed=this.path.rotate(e).translate(this.posn),this.padding&&(this.transformedPadded=Oe(this.path).padding(...this.padding).rotate(e).translate(this.posn)),this.snapPoints=this.getSnapPoints().map(n=>n.rotate(e).translate(this.posn)),this.snapLines=this.getSnapLines().map(n=>n.rotate(e).translate(this.posn)),(i=this.$errorIcon)==null||i.setTransform(Oe(this.path).p.shift(-28,5)))}setTransform(s=this.posn,e=this.rot){this.posn=s,this.props.x=s.x,this.props.y=s.y,this.rot=this.props.rot=Mt(e,360),this.transform()}getSnapPoints(){return this.path?it(this.path)?[this.path]:_t(this.path)?this.path.points:ot(this.path)?[this.path.p1,this.path.p2]:j(this.path)?[this.path.c,this.path.c.shift(0,this.path.r),this.path.c.shift(0,-this.path.r),this.path.c.shift(this.path.r,0),this.path.c.shift(-this.path.r,0)]:ge(this.path)?[this.path.c,this.path.start,this.path.end]:Rt(this.path)?[this.path.start,this.path.end]:Nt(this.path)?[]:[]:[]}getSnapLines(){return[]}relativePosn(s){return s.subtract(this.posn).rotate(-Q(this.rot))}worldPosn(s){return s.rotate(Q(this.rot)).add(this.posn)}get center(){return this.path?j(this.path)?this.path.c:Oe(this.path).center:I}contains(s){let e=this.transformed;return!e||!_t(e)&&!j(e)&&!ge(e)?!1:e.contains(s)}findNearby(s,e,i){let n=i||this.worldPosn(this.center);for(let r of this.$parent.getTilesOfType(s))if(r!==this&&c.distance(n,r.worldPosn(r.center))<e)return r}animateTo(s,e=this.posn,i=400){return this.setTransform(s),dt(n=>{n=bt("sine",n),this.$el.setTransform(c.interpolate(e,s,n),Q(this.rot))},i).promise}loadCables(s=this.props.cables){var e;for(let i of((e=this.outPorts)==null?void 0:e.values())||[])for(let n of i.cables)n.delete();for(let i of s||[])ie.unSerialize(this.id,i,this.$parent);this.props.cables=s}redrawCables(){var s,e;for(let i of((s=this.inPorts)==null?void 0:s.values())||[])i.redraw();for(let i of((e=this.outPorts)==null?void 0:e.values())||[])i.redraw()}makeInPort(s,e){this.inPorts||(this.inPorts=new Map),this.inPorts.has(s)||this.inPorts.set(s,new mr(this,s));let i=this.inPorts.get(s);return i.setOptions(e,!1),i}makeOutPort(s,e){this.outPorts||(this.outPorts=new Map),this.outPorts.has(s)||this.outPorts.set(s,new fr(this,s));let i=this.outPorts.get(s);return i.setOptions(e,!1),i}emitMessage(s,e){var i;typeof s=="string"&&(s=(i=this.outPorts)==null?void 0:i.get(s)),s==null||s.sendMessage(e)}*getCableData(s="out"){let e=s==="in"?this.inPorts:this.outPorts;if(!!e)for(let i of e.values())for(let n of i.cables)(s==="in"||n.to)&&(yield n.serialize())}getClosestPort(s,e,i=10){if(!this.inPorts)return;let n=this.relativePosn(s);for(let a of this.inPorts.values())if(a.location&&it(a.location)&&c.distance(a.location,n)<=i&&(!e||a.validateConnection(e)))return a;if(!this.contains(s))return;let r=Array.from(this.inPorts.values()).filter(a=>!e||a.validateConnection(e));for(let a of r.filter(h=>h.type==="REGION"))if((a.location||this.path).contains(n))return a;let o=r.filter(a=>a.type==="POINT");return Xe(o,a=>c.distance(n,a.location))}},Ma=new st(I,new c(0,1)),Xm=new R(I,50,50).shift(-25,-25).polygon,qs=class extends tt{constructor(e,i,n){super(e,i,n);this.$path=d("path",{class:"polygon-tile"},this.$el),this.$outline=d("path",{class:"outline"},this.$el),this.props.watch("color",({color:r})=>this.$path.setAttr("fill",r))}setPath(e=Xm){this.path=e,this.snapAngles=Pt(e.edges.map(r=>Mt(Math.round(Kt(r.angle)),180))),this.$path.draw(e),this.$outline.draw(e),this.transform();let i=R.aroundPoints(e.points),n=new c(i.center.x,i.p.y);this.showSelectionOutline=c.distance(n,e.project(n))>5}flip(e){this.props.isFlipped=!this.props.isFlipped||void 0;let i=new c(2*e.x-this.posn.x,this.posn.y);this.setPath(this.path.reflect(Ma)),this.setTransform(i,-this.rot)}};var wr={point:(t,s)=>t!==void 0&&s!==void 0?new c(t,s):void 0,angle:(t,s,e)=>t&&s&&e?new pt(t,s,e):void 0,line:(t,s)=>t&&s&&!t.equals(s)?new st(t,s):void 0,segment:(t,s)=>t&&s&&!t.equals(s)?new X(t,s):void 0,circle:(t,s)=>t&&s?new et(t,s):void 0,arc:(t,s,e)=>t&&s&&e?new Lt(t,s,e):void 0,polygon:(...t)=>t.every(Boolean)?new C(...t):void 0,polyline:(...t)=>t.every(Boolean)?new Wt(...t):void 0,triangle:(t,s,e)=>t&&s&&e?new oi(t,s,e):void 0,rectangle:(t,s,e)=>t?new R(t,s,e):void 0,distance:c.distance,intersections:Z},ne=Ht({});ne.assign(wr);var je=new Map,Mi=new Map,Ym=/^_x\d+\.at\([\d.e-]+\)$/,Zm=/^intersections\(|\.midpoint$|\.centroid$/,At=class extends tt{constructor(e,i,n){super(e,i,n,d("path",{class:"geo-path"},e.$geoPaths));this.$parent=e;this.hideSelectionOutline=!0;this.isProjection=!1;this.parentKeys=[];this.deleted=!1;this.onDraw=()=>this.draw();this.$shadow=d("path",{class:"geo-shadow"},e.$geoShadows),this.props.key||(this.props.key=ne.getKey()),je.set(this.props.key,this),this.snapPoints=this.snapLines=this.snapAngles=[],this.props.expr&&this.setExpr(this.props.expr),ne.watch(this.onDraw),this.props.color||(this.props.color=e.state.penColor),this.props.watch("color",({color:r})=>{var o,a,h;(o=this.$el)==null||o.css("color",r),(a=this.$shadow)==null||a.css("color",r),(h=this.$label)==null||h.setAttr("fill",r)}),this.props.watch("label",({label:r})=>{if(!r&&this.$label)return this.$label.detach();this.$label||(this.$label=d("text",{fill:this.props.color,class:"geo-label"})),this.$parent.$geoPoints.append(this.$label),tp(this)})}applyChange(e){super.applyChange(e),"expr"in e&&this.setExpr(this.props.expr)}setExpr(e,i=!1){let n=at(e);ne.setComputed(this.props.key,n),!i&&(this.props.expr=e,this.setParentKeys(e.match(/_x\d+/g)||[]),this.isProjection=Ym.test(e),this.computed=Zm.test(e),this.$el.setClass("intersection",this.computed))}draw(){let e=ne[this.props.key];if(e===this.path)return;this.path=e,this.$el.setAttr("hidden",e?void 0:!0),this.isActive&&!e&&this.$shadow.hide();let i=e==null?void 0:e.type;i!==this.geoType&&(this.$el.setClass("geo-point",i==="point"),this.$el.setClass("geo-path",i!=="point"),this.geoType=i,this.$container.append(this.$el)),e&&(i==="point"&&(e=new et(e,this.computed?3.5:6)),this.$el.setClass("fill",this.geoType==="angle"),this.$el.draw(e,{box:this.$parent.canvasBounds.rect}),this.$shadow.setAttr("d",this.$el.attr("d")),this.transform())}setParentKeys(e){var i;for(let n of this.parentKeys)(i=Mi.get(n))==null||i.delete(this.props.key);this.parentKeys=e;for(let n of e)Mi.has(n)||Mi.set(n,new Set),Mi.get(n).add(this.props.key)}get parents(){return this.parentKeys.map(e=>je.get(e)).filter(Boolean)}get children(){let e=Mi.get(this.props.key);return e?Array.from(e).map(i=>je.get(i)).filter(Boolean):[]}get ariaDescription(){var e;return`${(e=this.path)==null?void 0:e.type} ${this.props.key}: ${this.props.expr}`}get $container(){return this.geoType==="point"?this.$parent.$geoPoints:this.$parent.$geoPaths}select(){var e;this.isActive=!0,this.path&&(this.geoType==="angle"?this.$el.addClass("hover"):(this.$shadow.show(),(e=this.$el.parent)==null||e.append(this.$el)))}deselect(){this.isActive=!1,this.$shadow.hide(),this.$el.removeClass("hover")}hover(e=!0){this.isActive||!this.path||(this.geoType==="angle"?this.$el.setClass("hover",e):e?this.$shadow.show():this.$shadow.hide())}transform(){this.transformed=this.path,this.snapPoints=this.pending?[]:this.getSnapPoints(),this.snapLines=this.pending||!this.path||it(this.path)||Nt(this.path)?[]:[this.path],tg()}setTransform(){this.transform()}shift(e){!/^point\([\d.-]+,[\d.-]+\)$/.test(this.props.expr)||this.setExpr(this.path.translate(e).toString())}delete(){var e;this.deleted=!0,super.delete(),ne.unwatch(this.onDraw),ne[this.props.key]=void 0,je.delete(this.props.key),this.$shadow.remove(),(e=this.$label)==null||e.remove();for(let i of this.children)i.delete()}setPending(e=!0){this.pending=e,e||this.transform();for(let i of this.children)i.setPending(e)}moveStart(){if(!(this.computed||!this.path)){if(this.isProjection){if(this.$parent.selection.size>1)return;this.setParentKeys([])}this.setPending(!0);for(let e of this.parents)e.moveStart();this.moveStartValue=this.transformed}}move(e,i){if(!(!e||!this.path||!this.moveStartValue))if(it(this.path))this.snapTarget=i,this.$el.setClass("intersection",this.computed||!!(i!=null&&i.intersection)),ne[this.props.key]=this.moveStartValue.translate(e);else for(let n of this.parents)n.move(e)}moveEnd(){var e,i,n,r;if(!!this.moveStartValue){for(let o of this.parents)o.moveEnd();if(this.setPending(!1),(e=this.snapTarget)!=null&&e.intersection)this.setExpr(this.snapTarget.intersection);else if(((n=(i=this.snapTarget)==null?void 0:i.tile)==null?void 0:n.props.name)==="geo"){let o=(r=this.snapTarget)==null?void 0:r.tile;if(o.path&&it(o.path)){for(let a of this.children)a.setExpr(a.props.expr.replace(this.props.key,o.props.key));return this.$parent.selection.add(o),this.delete()}else if(o.path){let a=o.path.offset(ne[this.props.key]);this.setExpr(`${o.props.key}.at(${a})`)}}else this.path&&it(this.path)&&(this.props.expr=`point(${this.path.x},${this.path.y})`,this.isActive||this.$parent.selection.implicitChanges.add(this))}}static getInferredShape(e){if(e=e.filter(h=>h.path),!e.length)return;if(e.length===1)return{type:e[0].path.type,expr:e[0].props.key,value:e[0].path};e=e.filter(h=>h.geoType!=="angle");let i=e.filter(h=>it(h.path)),n=e.filter(h=>ot(h.path)||j(h.path));if(n.length===1&&i.length===e.length-1){let h=n[0].path;if(i.every(l=>h.contains(l.path)))return{type:h.type,expr:n[0].props.key,value:h}}let r=n.filter(h=>ot(h.path));if(i.length+r.length!==e.length)return;for(let h of r)if(le(h.path)){let l=h.parentKeys.map(p=>je.get(p));for(let p of l)i.includes(p)||i.push(p)}else if(i.filter(l=>h.path.contains(l.path)).length<2)return;let o=i.map(h=>h.props.key).join(","),a=i.map(h=>h.path);if(i.length===2){let h=new X(a[0],a[1]);return{type:"segment",expr:`segment(${o})`,value:h}}return i.length===3?{type:"triangle",expr:`triangle(${o})`,value:new oi(...a)}:{type:"polygon",expr:`polygon(${o})`,value:new C(...a)}}static redrawLines(e){for(let i of je.values())i.path&&yo(i.path)&&(i.$el.draw(i.path,{box:e}),i.$shadow.setAttr("d",i.$el.attr("d")))}static copy(e,i){let n=a=>{let h=e.get(a)||ne.getKey();return e.set(a,h),h},r=n(i.key),o=i.expr.replace(/\b_x\d+\b/g,n);return{key:r,expr:o}}static clearModel(){ne.clear(),ne.assign(wr)}};At.type="geo",At=$([Bt],At);var Zc=new WeakMap,Qc=t=>{let s=Zc.get(t);if(s)return s;let e=At.getInferredShape(t);return Zc.set(t,e),e};qt([["Midpoint","geo-midpoint","$0.midpoint","segment"],["Perpendicular bisector","geo-perp-bisector","$0.perpendicularBisector","segment"],["Parallel line","geo-parallel","$0.parallel($1)","line","segment"],["Perpendicular line","geo-perpendicular","$0.perpendicular($1)","line","segment"],["Tangent line","geo-tangent","line($0.c,$1).perpendicular($1)","circle"],["Centroid","geo-centroid","$0.centroid","polygon","triangle"],["Circumcircle","geo-circumcircle","$0.circumcircle","triangle"],["Incircle","geo-incircle","$0.incircle","triangle"],["Angle bisector","geo-angle-bisector","$0.bisector","angle"]].map(([t,s,e,...i])=>({type:"button",tileTypes:["geo"],label:t,icon:s,show:n=>{var r;return i.includes(((r=Qc(n))==null?void 0:r.type)||"")},click:(n,r)=>{var h;let o=(h=Qc(n))==null?void 0:h.expr,a=e.replace(/\$0/g,o||"");if(a.includes("$1"))r.tools.geoPending.enable(a);else{let l=tt.create(r,{name:"geo",expr:a});r.selection.add(l,!0);let p=it(l.path)?"pop":"draw",f=l.$el.enter(p,400);l.$shadow.enter(p,400),r.snapping.updateIntersections(),r.change({added:[l]}),f.promise.then(()=>l.$el.css("display",""))}}})));qt([{type:"input",tileTypes:["geo"],label:"Label:",advanced:!0,get:t=>t.props.label||"",set:(t,s)=>s.props.label=t}]);var Jc=Math.PI/12;function Qm(t){return Ce(t/Jc,.03)?new z(Math.round(t/Jc),12,"\u03C0").simplified.toString():It(t,4)}function Jm(t,s){return le(s)?t.replace(/\$l/g,It(s.length/50,4)):_t(s)||j(s)?t.replace(/\$[cp]/g,It(s.circumference/50,4)).replace(/\$a/g,It(s.area/2500,4)):Nt(s)?t.replace(/\$r/g,Qm(s.rad)).replace(/\$d/g,It(s.deg,4)+"\xB0"):t}var tg=ue(()=>{for(let t of je.values())tp(t)},0,!0);function tp(t){if(!t.props.label||!t.path)return;t.$label.text=Jm(t.props.label,t.path);let[s,e]=eg(t);t.$label.css("transform",`translate(${s.x}px,${s.y}px) rotate(${e}rad)`)}function eg(t){let s,e=t.$label.width,i=12,n=new R(new c(-e/2-3,-i-3),e+6,i+6);for(let r of sg(t.path,t,e,i)){s||(s=r);let o=n.rotate(r[1]).translate(r[0]);if(!me(je.values(),a=>{if(!a.path||a.props.status==="hidden"||a===t)return!1;let h=it(a.path)?new et(a.path,10):a.path;if(Z(h,o).length)return!0}))return r}return s||[I,0]}function*sg(t,s,e,i){var n;if(it(t)){let r=s.computed?8:10;yield[t.shift(r+e/2,-r),0],yield[t.shift(-r-e/2,-r),0],yield[t.shift(r+e/2,r+i),0],yield[t.shift(-r-e/2,r+i),0]}else if(ot(t)){let r=t.perpendicularVector,o=t.angle;r.y>=0&&(r=r.scale(-1),o+=Math.PI);let a=le(t)?[.5,.3,.7]:[0,150,-150];for(let h of a)for(let l of[8,-8-i])yield[t.at(h).add(r.scale(l)),o]}else if(_t(t))for(let r of t.edges){let o=r.perpendicularVector.scale(8),a=r.angle;o.y>=0&&(o=o.scale(1+i/8),a+=Math.PI),yield[r.midpoint.add(o),a]}else if(j(t))yield[t.at(7/8).shift(5+e/2,-5),0],yield[t.at(5/8).shift(-5-e/2,-5),0],yield[t.at(1/8).shift(5+e/2,5+i),0],yield[t.at(3/8).shift(-5-e/2,5+i),0];else if(Nt(t)){let r=t.isRight?20*Math.sqrt(2):t.radius,o=((n=t.bisector)==null?void 0:n.unitVector.scale(r+6))||I,a=o.angle();yield[t.b.add(o).shift(e/2*Math.cos(a),i/2*(1+Math.sin(a))),0]}}var ig={1:q.yellow,x:q.green,x2:q.blue,y:q.teal,y2:"#8d2ca1",xy:"#4e53d0"},Ci=25,ip=5.4,np=4.7,ng="#ddd";function ep(t){return t.replace("-","\u2013").replace("2","\xB2")}function Ca(t){return t[0]==="-"?q.red:ig[t]}function sp(t){return t[0]==="-"?t.slice(1):"-"+t}function ka(t,s,e,i){return t.endsWith("x2")?[e,e]:t.endsWith("y2")?[i,i]:t.endsWith("xy")?[e,i]:t.endsWith("x")?[s,e]:t.endsWith("y")?[s,i]:[s,s]}var ki=class extends qs{constructor(e,i,n){super(e,i,n);this.props.color||(this.props.color=Ca(this.props.expr)),this.$text=d("text",{class:"polygon-label",y:6},this.$el),this.resize(),this.props.watch("color expr",()=>this.redraw()),this.props.watch("labels",({labels:r})=>this.$text.toggle(r!=="hidden"))}resize(){let e=this.$parent.options.algebraXSize*Ci,i=this.$parent.options.algebraYSize*Ci,[n,r]=ka(this.props.expr,Ci,e,i);this.setPath(kc(n,r).polygon)}redraw(){this.$path.setAttr("fill",this.collision?Ds(ng):this.props.color),this.$text.text=this.collision?"0":ep(this.props.expr)}transform(e){this.$text.css("transform",`rotate(${-this.rot}deg)`),super.transform(e)}getSize(e){let i=!!(this.rot%180);return ka(this.props.expr,"1","x","y")[e===(i?"y":"x")?0:1]}getEdge(e){let i=Mt(e-Math.round(this.rot/90),4);return this.transformed.edges[i]}setCollision(e){this.collision=e,this.redraw()}move(e){if(super.move(e),this.collision){if(c.distance(this.posn,this.collision.posn)<.95*Ci)return;this.collision.setCollision(),this.setCollision()}let i=sp(this.props.expr);for(let n of this.$parent.getTilesOfType("algebra"))if(!(n.collision||n.props.expr!==i)&&!(c.distance(this.posn,n.posn)>=.95*Ci)){this.setCollision(n),n.setCollision(this);return}}static makeThumbnail(e,i){let n=i.expr,[r,o]=ka(n,20,78,64),a=n[0]==="-"?n.slice(1):n,h=a==="y2"?112:["x2","xy"].includes(a)?28:2,l=a==="1"?2:["x","x2"].includes(a)?28:112;i.rot&&([h,l,r,o]=[l,h,o,r]),e.setRect(new R(new c(h,l),r,o)),e.setAttr("fill",Ca(n)),e.insertAfter(d("text",{text:ep(n),class:"polygon-label",x:h+r/2,y:l+o/2+5}))}negate(){this.props.expr=sp(this.props.expr),this.props.color=Ca(this.props.expr)}};ki.type="algebra",ki=$([Bt],ki);qt([{type:"button",tileTypes:["algebra","dot","number-card"],label:"Negate",click:(t,s)=>{for(let e of t)e.negate();s.change({changed:t})}}]);var rp=1,rg=.05,og=5;function ag([t,s],e,i){if(!i)return[Math.min(t,e),Math.max(s,e)];let n=s<t?s+1:s;if(y(n-t,1,.001))return[0,1];if(ct(e<t?e+1:e,t,n))return[t,s];let r=Math.abs(t-e),o=Math.abs(s-e);return Math.min(r,1-r)<Math.min(o,1-o)?[e,s]:[t,e]}function hg(t,s,e){if(y(s,0)&&y(e,1))return t;if(ot(t))return new X(t.at(s),t.at(e));if(Rt(t)){let i=t.angle*Math.abs(e-s);return new Lt(t.c,t.at(Math.min(s,e)),i)}else if(j(t)){let i=(e-s+(e<s?1:0))*yt;return new Lt(t.c,t.at(s),i)}else if(ws(t)){let i=Bi(t.edges.map(h=>h.length)),n=L(i),r=i.findIndex(h=>h/n>s)+1,o=i.findIndex(h=>h/n>e)+1,a=s<=e?t.points.slice(r,o):[...t.points.slice(r),...t.points.slice(0,o)];return new Wt(t.at(s),...a,t.at(e))}return t}function Aa(t,s,e,i){let n=rp,r=-1;for(let o=s+1;o<e;o++){let a=new st(t[s],t[e]).distanceSquared(t[o]);a>n&&(r=o,n=a)}n>rp&&(r-s>1&&Aa(t,s,r,i),i.push(t[r]),e-r>1&&Aa(t,r,e,i))}function lg(t){if(t.length<=2)return t;let s=[t[0]];return Aa(t,0,t.length-1,s),s.push(L(t)),s}function op(t,s,e,i=!1){let n=s||t,r=e||t,o=Math.atan2(r.y-n.y,r.x-n.x)+(i?Math.PI:0),a=c.distance(n,r)*rg;return t.shift(Math.cos(o)*a,Math.sin(o)*a)}function cg(t){return t.length<=2?ke(new Wt(...t)):t.map((s,e)=>{if(e===0)return`M${s.x.toFixed(2)} ${s.y.toFixed(2)}`;if(c.distance(t[e-1],s)<4)return`L${s.x.toFixed(2)},${s.y.toFixed(2)}`;let i=op(t[e-1],t[e-2],s),n=op(s,t[e-1],t[e+1],!0);return`C${i.x.toFixed(2)},${i.y.toFixed(2)} ${n.x.toFixed(2)},${n.y.toFixed(2)} ${s.x.toFixed(2)},${s.y.toFixed(2)}`}).join("")}var ce=class{constructor(s,e,i,n,r){this.$parent=s;this.brush=n;this.options="";this.$el=d("path",{class:`stroke ${n}`},s.$strokes),this.id=r||ds(10),this.setColor(i),e&&this.parse(e),s.strokes.set(this.id,this)}setColor(s){this.color=s,this.$el.setAttr("stroke",Ds(s))}parse(s){if(this.options=s,s.startsWith("M")){let e=Co(s);this.path=new Wt(...e),this.$el.setAttr("d",s)}else this.path=at(s)(wr),this.path&&(this.snap=!0),this.$el.setAttr("d",this.path?ke(this.path):"")}start(s,e){var i;if(this.brush==="ruler"&&(s=((i=this.$parent.snapping.snap([s]))==null?void 0:i.posn)||s),this.startPoint=s,this.path=new Wt(s,s.shift(.01)),e&&this.brush!=="ruler"){this.utensil=e;let n=e.offset(s);this.utensilRange=[n,n+.01]}this.$el.draw(this.path)}addPoint(s){if(this.brush==="ruler"){let e=this.$parent.snapping.snap([s]),i=(e==null?void 0:e.posn)||s.snap(this.startPoint,og);this.path=new X(this.startPoint,i),this.$el.draw(this.path)}else if(this.utensil){let e=G(this.utensil.offset(s),0,1),i=j(this.utensil)||ws(this.utensil);this.utensilRange=ag(this.utensilRange,e,i),this.path=hg(this.utensil,...this.utensilRange),this.$el.draw(this.path)}else this.path.points.push(s),this.$el.setAttr("d",this.$el.attr("d")+`L${s.x},${s.y}`)}end(){if(this.utensil||this.brush==="ruler")return this.snap=!0,this.options=this.path.toString().replace(/\.(\d{3})\d+/g,(s,e)=>`.${e}`),this.$parent.snapping.addStroke(this);{let s=lg(this.path.points);this.path=new Wt(...s),this.options=cg(s),this.$el.setAttr("d",this.options)}this.startPoint=this.utensil=this.utensilRange=void 0}get snapPoints(){if(!!this.snap){if(le(this.path))return[this.path.p1,this.path.p2];if(Rt(this.path))return[this.path.start,this.path.end]}}hitTest(s,e){if(!this.path)return!1;let i=this.path.project(s);return(s.x-i.x)**2+(s.y-i.y)**2<e**2}delete(){this.$parent.strokes.delete(this.id),this.$el.remove()}serialize(s=1/0){return{points:this.options.slice(0,s),colour:this.color,brush:this.brush}}get lastSavedData(){return this.serialize()}static create(s,e,i){return new ce(s,e.points,e.colour||"#000",e.brush||"",i)}};var ap,hp,yr=new Set,Va=new Set;function pg(t,s,e){let i=Mt(t-s,e);return i>e/2?i-e:i}var xr=class{constructor(s){this.$parent=s;this.angle=0;this.startAngle=0;this.hasChanged=!1;this.showTools=!1;this.isMoving=!1;this.tiles=new Set;this.implicitChanges=new Set;this.$tools=s.$(".transform-tools"),this.$shadow=s.$(".group-shadow"),this.$rect=this.$tools.$(".group-outline"),this.$rotateBar=this.$tools.$(".rotate-bar"),this.$rotateCircle=this.$tools.$(".rotate-circle");let e=s.$(".rotate-label");e.hide(),s.events.listen(this.$rotateCircle,{start:()=>{this.startAngle=this.angle,this.rotateStart(),e.show()},move:({startPosn:i,posn:n,event:r})=>{this.rotate(this.startAngle-new pt(n,this.center,i).deg);let o=Ct(r).subtract(s.topLeftPosition);e.setTransform(o.shift(w.isMobile?-15:5,w.isMobile?-100:-40)),e.text=Mt(ae(this.angle,1),360)+"\u2009\xB0"},end:()=>{this.rotateEnd(),e.hide()}})}bindKeyboardEvents(s){s.onKey("ArrowUp ArrowDown ArrowLeft ArrowRight r R",(e,i)=>{if(!!this.tiles.size){if(i==="r"||i==="R"){if(Array.from(this.tiles).some(n=>n.props.status==="fixed"||n.cannotRotate))return;this.rotateStart(),this.rotate(this.angle+(i==="R"?-15:15)),this.rotateEnd()}else{let n=I,r=e.shiftKey?5:25,o=i==="ArrowLeft"?-r:i==="ArrowRight"?r:0,a=i==="ArrowUp"?-r:i==="ArrowDown"?r:0,h=n.shift(o,a);this.moveStart(),this.move({posn:h,startPosn:n}),this.moveEnd()}this.$parent.trigger("shift-selection")}}),s.onKey("Escape",()=>this.clear())}get size(){return this.tiles.size}add(s,e=!1,i=!1){e&&this.clear(),!s.isActive&&this.$parent.tiles.has(s.id)&&this.select([s],i)}select(s,e=!1){var i;(i=this.$parent.focussedTile)==null||i.blur();for(let n of s)n.isActive||!this.$parent.tiles.has(n.id)||(this.tiles.add(n),n.select(),this.hasChanged=!0);e||this.update(!0)}remove(s,e=!1){!s.isActive||(s.deselect(),this.hasChanged=!0,this.tiles.delete(s),e||this.update(!0))}clear(){if(!this.isMoving){for(let s of this.tiles)s.deselect();this.tiles.size&&(this.hasChanged=!0),this.tiles.clear(),this.update(!0)}}getTileProperty(s){if(!this.size)return;let e=Array.from(this.tiles),i=s(e[0]);return e.slice(1).some(r=>s(r)!==i)?void 0:i}update(s=!1){if(s&&!this.hasChanged)return;if(this.hasChanged=!1,this.implicitChanges.clear(),!this.size){for(let h of[this.$shadow,this.$tools])h.hide();this.$parent.trigger("change-selection",{tiles:[],color:void 0});return}let e=Array.from(this.tiles).filter(h=>h.transformed);this.angle=this.getTileProperty(h=>h.rot)||0;let i=Oe(...e.map(h=>h.transformed.rotate(-Q(this.angle)))),n=i.p.shift(i.w/2,i.h/2).rotate(Q(this.angle)).shift(-i.w/2,-i.h/2);this.rect=new R(n,i.w,i.h),this.center=this.rect.center;let r=!this.$parent.options.noRotating&&e.every(h=>!h.cannotRotate&&h.props.status!=="fixed");if(e.length===1&&j(e[0].transformed)&&(r=!1),r&&this.getTileProperty(h=>h.rotateAroundOrigin)){let h=e[0].posn;e.slice(1).every(l=>l.posn.equals(h))&&(this.center=h,this.angle&&e.length===1&&(this.rect=Oe(e[0].transformed.rotate(-Q(this.angle),h))))}this.$rotateBar.toggle(r),this.$rotateCircle.toggle(r);let o=this.size>1||e[0].showSelectionOutline;this.$rect.toggle(o),this.showTools=!this.getTileProperty(h=>h.hideSelectionOutline),this.$tools.toggle(this.showTools),this.$shadow.toggle(o&&this.showTools),(!r||!this.showTools)&&(this.rotateHandle=void 0),(this.size===1?e[0].$container:this.$parent.$svg).append(this.$tools),this.positionTools();let a=this.getTileProperty(h=>h.props.color);this.$parent.trigger("change-selection",{tiles:e,color:a})}positionTools(){if(!this.showTools)return;let s=this.bounds;for(let n of[this.$shadow,this.$rect])n.draw(s);let e=new c(this.center.x,this.rect.p.y),i=new X(e,e.shift(0,-28)).rotate(Q(this.angle),this.center);this.$rotateBar.setLine(i.p1,i.p2),this.$rotateCircle.setCenter(i.p2),this.rotateHandle=i.p2}get bounds(){return this.rect.rotate(Q(this.angle),this.center)}moveStart(s=!1){for(let e of this.tiles)if(e.props.status==="fixed"||e.cannotEdit)return;this.isMoving=!0;for(let e of this.tiles)e.moveStart(s);this.startSnapPoints=[];for(let e of this.tiles)for(let i of e.snapPoints)this.startSnapPoints.some(n=>i.equals(n))||this.startSnapPoints.push(i);hp=this.rect,ap=this.center,this.$parent.newTileShift=0,this.$parent.trigger("move-start")}move({posn:s,startPosn:e}){if(!this.isMoving)return;let i=s.subtract(e),n=this.startSnapPoints.map(a=>a.add(i)),r=this.$parent.snapping.snap(n);r&&(i=i.add(r.shift));let o=this.tiles.size===1?r:void 0;for(let a of this.tiles)a.move(i,o);this.rect=hp.translate(i),this.center=ap.add(i),this.positionTools(),this.$parent.trigger("move-selection")}moveEnd(s=!1){if(!this.isMoving)return;for(let i of this.tiles)i.moveEnd();if(me(this.tiles,i=>i.props.name==="geo")&&this.$parent.snapping.updateIntersections(),this.$parent.trigger("move-end"),this.isMoving=!1,!this.tiles.size)return;let e=[...Array.from(this.tiles),...Array.from(this.implicitChanges)];this.$parent.change({[s?"added":"changed"]:e}),this.implicitChanges.clear()}rotateStart(){Va.clear();for(let s of this.tiles)for(let e of s.snapAngles)Va.add(Mt(e+s.rot,180));yr.clear(),yr.add(0);for(let s of this.$parent.tiles.values())if(!s.isActive&&!!me(this.tiles,e=>c.distance(e.posn,s.posn)<140))for(let e of s.snapAngles)yr.add(Mt(e+s.rot,180));this.$parent.newTileShift=0,this.$parent.trigger("rotate-start")}rotate(s){if(s=vt(s,3),s===this.angle)return;let e=1/0;for(let n of Va)for(let r of yr){let o=pg(r,n+s-this.startAngle,180);Math.abs(o)<Math.abs(e)&&(e=o)}if(Math.abs(e)<8&&(s+=e),s===this.angle)return;let i=s-this.angle;this.angle=s;for(let n of this.tiles)n.posn=n.posn.rotate(Q(i),this.center),n.rot=Mt(n.rot+i,360),n.transform(!0);this.positionTools(),this.$parent.trigger("rotate-selection")}rotateEnd(){for(let s of this.tiles)s.setTransform();this.$parent.change({changed:Array.from(this.tiles)}),this.$parent.trigger("rotate-end")}copy(){if(this.$parent.options.noCopyPaste)return{};if(this.isMoving||!this.tiles.size||ie.isMoving)return{};if(me(this.tiles,e=>e.cannotEdit))return{};let s={};for(let e of this.tiles)s[e.id]=e.props.copy();for(let e of this.tiles)if(e.is("geo")){for(let i of e.parents)if(!this.tiles.has(i)&&!(i.id in s)&&i.geoType==="point"){let n=`point(${i.path.x},${i.path.y})`;s[i.id]=Object.assign(i.props.copy(),{expr:n})}}return s}delete(){var i;if(this.isMoving||this.$parent.options.noDeleting||ie.isMoving)return;let s=Array.from(this.tiles).filter(n=>n.props.status!=="fixed"&&!n.cannotEdit);if(!s.length)return;let e=new Set;for(let n of s){for(let r of Fi(((i=n.inPorts)==null?void 0:i.values())||[],o=>o.cables))e.add(r.from.tile);n.delete()}s.some(n=>n.props.name==="geo")&&this.$parent.snapping.updateIntersections(),this.$parent.change({deleted:s,changed:Array.from(e).filter(n=>!s.includes(n))}),this.$parent.newTileShift=0}};var U=class{constructor(s=0,e=0,i=0){this.x=s;this.y=e;this.z=i}transform(s){if(s instanceof Ai&&(s=s.matrix),s.length!==4||s[0].length!==4)throw new Error("Must use a 4x4 matrix for 3D transforms!");let[[e],[i],[n],[r]]=Et.product(s,[[this.x],[this.y],[this.z],[1]]);return new U(e/r,i/r,n/r)}equals(s){return y(this.x,s.x)&&y(this.y,s.y)&&y(this.z,s.z)}fixFloat(){return new U(y(this.x,0)?0:this.x,y(this.y,0)?0:this.y,y(this.z,0)?0:this.z)}add(s){return this.x+=s.x||0,this.y+=s.y||0,this.z+=s.z||0,this}multiply(s){return this.x*=s.x,this.y*=s.y,this.z*=s.z,this}lerp(s,e){return new U(wt(this.x,s.x||0,e),wt(this.y,s.y||0,e),wt(this.z,s.z||0,e))}scale(s){return new U(this.x*s,this.y*s,this.z*s)}get magnitude(){return Math.hypot(this.x,this.y,this.z)}get normalize(){return this.scale(1/this.magnitude)}get asArray(){return[this.x,this.y,this.z]}get inverse(){return new U(-this.x,-this.y,-this.z)}get xy(){return new c(this.x,this.y)}[Symbol.iterator](){return this.asArray.values()}static get zero(){return new U(0,0,0)}static get oneZ(){return new U(0,0,1)}static get one(){return new U(1,1,1)}static all(s){return new U(s,s,s)}static from2D(s){return new U(s.x,s.y,0)}static average(s){return new U(gs(s.map(e=>e.x)),gs(s.map(e=>e.y)),gs(s.map(e=>e.z)))}static dot(s,e){return s.x*e.x+s.y*e.y+s.z*e.z}static cross(s,e){let i=s.y*e.z-s.z*e.y,n=s.z*e.x-s.x*e.z,r=s.x*e.y-s.y*e.x;return new U(i,n,r)}};var Yt={translate({x:t,y:s,z:e}){return[[1,0,0,t],[0,1,0,s],[0,0,1,e],[0,0,0,1]]},rotateX(t){let s=Math.cos(t),e=Math.sin(t);return[[1,0,0,0],[0,s,-e,0],[0,e,s,0],[0,0,0,1]]},rotateY(t){let s=Math.cos(t),e=Math.sin(t);return[[s,0,e,0],[0,1,0,0],[-e,0,s,0],[0,0,0,1]]},rotateZ(t){let s=Math.cos(t),e=Math.sin(t);return[[s,-e,0,0],[e,s,0,0],[0,0,1,0],[0,0,0,1]]},rotateAxis({x:t,y:s,z:e},i){let n=Math.hypot(t,s,e);n=1/n,t*=n,s*=n,e*=n;let r=Math.sin(i),o=Math.cos(i),a=1-o;return[[t*t*a+o,t*s*a-e*r,t*e*a+s*r,0],[s*t*a+e*r,s*s*a+o,s*e*a-t*r,0],[e*t*a-s*r,e*s*a+t*r,e*e*a+o,0],[0,0,0,1]]},fromEulerAngles(t,s,e){return Et.product(Yt.rotateX(t),Yt.rotateY(s),Yt.rotateZ(e))},scale({x:t,y:s,z:e}){return[[t,0,0,0],[0,s,0,0],[0,0,e,0],[0,0,0,1]]},scaleAll(t){return[[t,0,0,0],[0,t,0,0],[0,0,t,0],[0,0,0,1]]},perspective(t,s,e,i){let n=e*Math.tan(Q(t)/2),r=-n,o=n*s,a=-o;return[[2*e/(o-a),0,(o+a)/(o-a),0],[0,2*e/(n-r),(n+r)/(n-r),0],[0,0,-((i+e)/(i-e)),-(2*i*e/(i-e))],[0,0,-1,0]]},transformPoint(t,s){return s instanceof U?s.transform(t):new U(s.x,s.y).transform(t)}},Ai=class{constructor(){this.matrix=Et.identity(4)}clear(){return this.matrix=Et.identity(4),this}translate(s=0,e=0,i=0){return this.matrix=Et.product(this.matrix,Yt.translate({x:s,y:e,z:i})),this}rotate(s=0,e=0,i=0){return this.matrix=Et.product(this.matrix,Yt.rotateZ(i),Yt.rotateY(e),Yt.rotateX(s)),this}scale(s){return this.matrix=Et.product(this.matrix,Yt.scale(s)),this}dragToRotate(s,e,i=100){let n=new U(s.x,s.y,i**3/(i**2+s.length**2)).normalize,r=new U(e.x,e.y,i**3/(i**2+e.length**2)).normalize,o=G(U.dot(n,r),-1,1),a=U.cross(n,r),h=Yt.rotateAxis(a,2*Math.acos(o));return this.matrix=Et.product(h,this.matrix),this}isRotationMatrix(){if(!y(Et.determinant(this.matrix),1))return!1;let s=Et.transpose(this.matrix);return Et.product(this.matrix,s).every((i,n)=>i.every((r,o)=>y(r,n===o?1:0)))}toEulerAngles(){let s=this.matrix,e=Math.sqrt(s[0][0]*s[0][0]+s[1][0]*s[1][0]);if(y(e,0)){let a=Math.atan2(-s[1][2],s[1][1]),h=Math.atan2(-s[2][0],e);return[a,h,0]}let n=Math.atan2(s[2][1],s[2][2]),r=Math.atan2(-s[2][0],e),o=Math.atan2(s[1][0],s[0][0]);return[n,r,o]}};var dg=new J(0,0,0);function ug(t){let s=t.r,e=t.c.x,i=t.c.y,n=.5523*s;return`M${e} ${i-s}C${e+n} ${i-s} ${e+s} ${i-n} ${e+s} ${i}C${e+s} ${i+n} ${e+n} ${i+s} ${e} ${i+s}C${e-n} ${i+s} ${e-s} ${i+n} ${e-s} ${i}C${e-s} ${i-n} ${e-n} ${i-s} ${e} ${i-s}`}var br=class{constructor(){this.transform=new Ai;this.visible=!0}getTransformed(s){let e=this;do s=s.transform(e.transform);while(e=e.parent);return s}get normal(){return this.getTransformed(U.oneZ).add(this.getTransformed(U.zero).inverse).normalize}project(s,e={fov:120}){if(e.fov===!1)return new c(s.x,s.y);let i=Math.exp(s.z/e.fov);return new c(s.x*i,s.y*i)}*getProjectedVertices(s){for(let e of this.getVertices())yield this.project(e,s)}},Vi=class extends br{constructor(e,i={},n){super();this.children=[];this.sorting=!1;this.$el=d("g",i,n);for(let r of e)this.addChild(r)}addChild(e){return e.parent&&e.parent.removeChild(e),this.children.push(e),this.$el&&e.$el&&this.$el.append(e.$el),e.parent=this,e}removeChild(e){let i=this.children.indexOf(e);i>=0&&this.children.splice(i,1),e.$el&&e.$el.remove(),e.parent=void 0}render(e){if(!!this.visible){if(this.sorting)for(let i of si(this.children,n=>n.zIndex))this.$el.append(i.$el);for(let i of this.children)i.render(e)}}*getFaces(){for(let e of this.children)for(let i of e.getFaces())yield i}*getVertices(){for(let e of this.children)for(let i of e.getVertices())yield i}get zIndex(){return gs(this.children.map(e=>e.zIndex))}},Ii=class extends br{constructor(e,i={},n){super();this.shape=e;if(!e)this.commands=[];else if(typeof e=="string")this.commands=rn(e);else{let o=j(e)?ug(e):ke(e);this.commands=rn(o)}let r=c.average(...this.commands.filter(o=>o.points.length).map(o=>c.average(...o.points)));this.centroid=new U(r.x,r.y,0),n&&(this.color=n),this.$el=d("path",i)}render(e){if(!this.visible)return;let i=this.normal.z;if(e!=null&&e.hideBackface){let r=i>-.01;if(this.$el.toggle(r),!r)return}if(this.color){let r=J.mix(this.color,dg,(Math.abs(i)+1)/2);this.$el.setAttr("fill",r),this.$el.setAttr("stroke",r)}let n=this.commands.map(r=>{let o=r.points.map(a=>{let h=this.project(this.getTransformed(new U(a.x,a.y)),e);return`${h.x},${h.y}`});return r.type+o.join(",")}).join("");this.$el.setAttr("d",n)}get zIndex(){return this.getTransformed(this.centroid).z}*getFaces(){yield this}*getVertices(){if(!(!this.shape||typeof this.shape=="string"||!_t(this.shape)))for(let e of this.commands)for(let i of e.points)yield this.getTransformed(new U(i.x,i.y))}};var W=C.regular(3),zs=C.regular(4),re=C.regular(5),lp={shape:W,children:[{shape:W,dihedral:70.53,rot:180},{shape:W,dihedral:70.53,parentEdge:1,rot:300},{shape:W,dihedral:70.53,parentEdge:2,rot:60}]},cp={shape:zs,children:[{shape:zs,dihedral:90,myEdge:2,children:[{shape:zs,dihedral:90,myEdge:2}]},{shape:zs,dihedral:90,parentEdge:1,rot:270},{shape:zs,dihedral:90,parentEdge:2},{shape:zs,dihedral:90,parentEdge:3,rot:90}]},pp={shape:W,children:[{shape:W,dihedral:109.47,rot:180},{shape:W,dihedral:109.47,parentEdge:1,rot:300,children:[{shape:W,dihedral:109.47,parentEdge:1,rot:300}]},{shape:W,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:W,dihedral:109.47,parentEdge:1,rot:300},{shape:W,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:W,dihedral:109.47,parentEdge:1,rot:300}]}]}]},dp={shape:re,children:[{shape:re,dihedral:116.57,rot:180},{shape:re,dihedral:116.57,parentEdge:1,rot:252},{shape:re,dihedral:116.57,parentEdge:2,rot:324},{shape:re,dihedral:116.57,parentEdge:3,rot:36},{shape:re,dihedral:116.57,parentEdge:4,rot:108,children:[{shape:re,dihedral:116.57,parentEdge:2,rot:324,children:[{shape:re,dihedral:116.57,parentEdge:3,rot:36,children:[{shape:re,dihedral:116.57,parentEdge:1,rot:252},{shape:re,dihedral:116.57,parentEdge:2,rot:324},{shape:re,dihedral:116.57,parentEdge:3,rot:36},{shape:re,dihedral:116.57,parentEdge:4,rot:108}]}]}]}]},up={shape:W,children:[{shape:W,dihedral:138.19,rot:180},{shape:W,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:W,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:W,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:W,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:W,dihedral:138.19,parentEdge:1,rot:300}]},{shape:W,dihedral:138.19,parentEdge:2,rot:60}]},{shape:W,dihedral:138.19,parentEdge:1,rot:300}]},{shape:W,dihedral:138.19,parentEdge:2,rot:60}]},{shape:W,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:W,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:W,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:W,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:W,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:W,dihedral:138.19,parentEdge:1,rot:300}]},{shape:W,dihedral:138.19,parentEdge:2,rot:60}]},{shape:W,dihedral:138.19,parentEdge:1,rot:300}]},{shape:W,dihedral:138.19,parentEdge:2,rot:60}]},{shape:W,dihedral:138.19,parentEdge:1,rot:300}]}]},fp=new C(new c(.587785,.466639),new c(0,.750495),new c(-.587785,.466639),new c(0,-.73981)),Le={shape:fp,dihedral:89.7451,rot:180},eE={shape:fp,children:[Ft(zt({},Le),{parentEdge:1,myEdge:1,children:[Ft(zt({},Le),{children:[Ft(zt({},Le),{parentEdge:1,myEdge:1,children:[Ft(zt({},Le),{children:[Ft(zt({},Le),{parentEdge:1,myEdge:1,children:[Ft(zt({},Le),{children:[Ft(zt({},Le),{parentEdge:1,myEdge:1,children:[Ft(zt({},Le),{children:[Ft(zt({},Le),{parentEdge:1,myEdge:1})]})]})]})]})]})]})]})]})]};function mp(t,s,e){let i=C.regular(t).scale(s*Vt(t)),n=new R(I,s,e).polygon,r=[{shape:i,rot:180,parentEdge:2}],o=H(a=>({shape:n,parentEdge:a,rot:360/t*a,children:a?void 0:r}),t);return{shape:i,children:o}}function gp(t,s,e){let i=C.regular(t).scale(s*Vt(t)),n=new C(new c(-s/2,0),new c(s/2,0),new c(0,-e)),r=Kt(Math.acos(s/e/2/Math.tan(Math.PI/t))),o=H(a=>({shape:n,dihedral:r,parentEdge:a,rot:180+360/t*a}),t);return{shape:i,children:o}}var fg=Et.identity(4);function vp(t,s,e,i){var g;let n=s.shape.edges[t.parentEdge||0],r=t.shape.edges[t.myEdge||0],o=Q(t.dihedral||90),a=i(t);e.addChild(a);let h=U.from2D(n.midpoint),l=U.from2D(r.midpoint),p=U.from2D(n.unitVector),f=t.rot?Q(t.rot):0,m=((g=t.children)==null?void 0:g.map(x=>vp(x,t,e,i)))||[];return[a,h,l,p,f,o,m]}function Ia(t,s,e=1){var o;let i=s(t),n=new Vi([i]);n.sorting=!0;let r=((o=t.children)==null?void 0:o.map(a=>vp(a,t,n,s)))||[];return Oa(r,n,e),{group:new Vi([n]),foldTree:r}}function wp(t,s,e=fg){let[i,n,r,o,a,h,l]=t,p=wt(Math.PI,h,s),f=Yt.rotateAxis(o,Math.PI-p);a&&(f=Et.product(f,Yt.rotateZ(a)));let m=r.transform(f),g=Yt.translate(m.inverse.add(n));i.transform.matrix=Et.product(e,g,f);for(let x of l||[])wp(x,s,i.transform.matrix)}function Oa(t,s,e){s.transform.clear();for(let r of t)wp(r,e);let i=Array.from(s.getFaces()).map(r=>r.getTransformed(r.centroid)),n=U.average(i).inverse;s.transform.translate(n.x,n.y,n.z)}function mg(t,s,e){let i=Math.cos(t),n=Math.cos(s),r=Math.cos(e),o=Math.sin(s),a=Math.acos((r-i*n)/(Math.sin(t)*o)),h=Math.acos((i-n*r)/(o*Math.sin(e)));return[a,h]}function yp(t,s){return Math.asin(Math.cos(t*s)/Math.cos(t/2))}var gg=new Set([60,90,108]),vg=[{internal:[60,90,90,90],dihedral:[144.74,135,135,135]},{internal:[60,60,60,60,90],dihedral:[153.23,153.23,153.23,142.98,142.98]},{internal:[60,90,108,90],dihedral:[159.09,148.28,148.28,159.09]},{internal:[60,60,60,60,108],dihedral:[164.18,164.18,152.93,152.93,152.93]}];function wg(...t){let s=t.length;if(s===3)return mg(t[0],t[1],t[2]);let e=t.map(n=>Math.round(Kt(n)));if((s===4||s===5)&&e.includes(60)&&e.every(n=>gg.has(n))){for(let n of vg)if(n.internal.length===s){for(let r=0;r<t.length;++r)if(e.every((o,a)=>o===n.internal[(a+r)%s]))return ii(n.dihedral,r).slice(0,s-1).map(o=>Q(o))}}if(s===4&&e.filter(n=>n===60).length===3){let n=e.findIndex(l=>l!==60),r=(Math.PI-t[n])/4,o=Math.acos(-1/Math.sqrt(3)*Math.tan(r)),a=Math.acos(1-2/3*((3-Math.tan(r)**2)/4+(Math.sin(3*r)/Math.sin(2*r))**2));return ii([o,a,a,o],4-n).slice(0,s-1)}let i=Math.PI/D(t);return H(n=>{let r=yp(t[n],i),o=yp(t[n+1],i);return r+o},t.length-1)}var Ra=(t,s)=>Mt(t+1,s.size),La=(t,s)=>Mt(t-1,s.size);function yg(t,s){let e=t.polygon.points[La(s,t)],i=t.polygon.points[s],n=t.polygon.points[Ra(s,t)];return new pt(n,i,e).sup.rad}function xg(t){let s=t.find(a=>a.neighbours.filter(Boolean).length===1),e=La(s.neighbours.findIndex(Boolean),s),i=[],n=s,r=e;do{let a=[];for(;a.push({face:n,vertex:r}),!!n.neighbours[r];){let h=n;n=n.neighbours[r],r=Ra(n.neighbours.indexOf(h),n)}r=Ra(r,n),i.push(a)}while(n!==s||r!==e);let o=new oh(i);for(;;){let a=Math.max(3,...o.array.map(p=>p.val.length)),h=o.array.filter(p=>p.val.length>=a);if(!h.length)break;let l=new Set;for(let p of h){if(l.has(p))continue;let f=p.val.map(g=>yg(g.face,g.vertex)),m=wg(...f);for(let[g,x]of m.entries()){let u=p.val[g],v=p.val[g+1],b=u.vertex,E=La(v.vertex,v.face);u.face.dihedral[b]=v.face.dihedral[E]=Math.max(x,u.face.dihedral[b]||0,v.face.dihedral[E]||0)}p.prev.val.push(...p.next.val),l.add(p.next),o.delete(p.next),o.delete(p)}}}function xp(t,s){return Math.max(...t.neighbours.map(e=>!e||e===s?0:xp(e,t)))+1}function bp(t,s){return t.visited?!0:(t.visited=!0,t.neighbours.filter(e=>e&&e!==s).some(e=>bp(e,t)))}function $p(t,s,e,i){let n=t.neighbours.map((r,o)=>{if(!(!r||r===e))return $p(r,s,t,t.dihedral[o])}).filter(Boolean);return{shape:t.polygon.translate(s.inverse),color:t.tile.props.color,children:n.length?n:void 0,dihedral:i?+Kt(i).toFixed(2):void 0,parentEdge:e?e.neighbours.indexOf(t):void 0,myEdge:e?t.neighbours.indexOf(e):void 0}}function bg(t){let s=t.map(e=>{let i=e.transformed.oriented,n=i.points.length;return{tile:e,polygon:i,size:n,neighbours:Zt(void 0,n),dihedral:Zt(void 0,n),edges:i.edges,center:i.centroid,radius:i.radius}});if(!s.some(e=>e.size<3)){for(let[e,i]of s.entries())for(let[n,r]of s.entries())if(!(e>=n)&&!(i.radius+r.radius<c.distance(i.center,r.center)-2)){for(let[o,a]of i.edges.entries())for(let[h,l]of r.edges.entries())if(a.equals(l,2)){if(i.neighbours[o]||r.neighbours[h])return;i.joined=r.joined=!0,i.neighbours[o]=r,r.neighbours[h]=i}}if(!s.some(e=>!e.joined)&&!bp(s[0]))return s}}function Pp(t){let s=bg(t);if(!s)return;xg(s);let e=Xe(s,n=>xp(n)),i=e.polygon.centroid;return[i,$p(e,i)]}var _a=t=>Oi[t%Oi.length]||q.yellow;function Mp(t){var e;let s=((e=t.c||t.children)==null?void 0:e.map(i=>Mp(i)))||[];return{shape:$r(t.shape||t.s),color:t.color||t.a,children:s,dihedral:t.dihedral||t.d,parentEdge:t.parentEdge||t.p,myEdge:t.myEdge||t.m,rot:t.rot||t.r}}function Cp(t){var e;let s=(e=t.children)==null?void 0:e.map(i=>Cp(i));return s!=null&&s.length||(s=void 0),{s:Hs(t.shape),a:t.color,c:s,d:t.dihedral,p:t.parentEdge,m:t.myEdge,r:t.rot}}function $g(t){return Mp(fe(t.replace(/([a-z]):/g,'"$1":'),{}))}function Pg(t){return JSON.stringify(Cp(t)).replace(/"([a-z])":/g,"$1:")}function Fs(t,s=1){var i;let e=(i=t.children)==null?void 0:i.map(n=>Fs(n,s));return Object.assign({},t,{children:e,shape:t.shape.scale(s)})}var Ep=t=>t.split(",").map(s=>+s),Na=t=>t.map(s=>s.toFixed(4)).join(","),Tp={Tetrahedron:{net:Fs(lp,Vt(3)*50),scale:1.1},Cube:{net:Fs(cp,Vt(4)*50),scale:.8},Octahedron:{net:Fs(pp,Vt(3)*50),scale:.95},Dodecahedron:{net:Fs(dp,Vt(5)*50),scale:.42},Icosahedron:{net:Fs(up,Vt(3)*50),scale:.67},Pyramid:{net:gp(6,50,100),scale:.57},Prism:{net:mp(6,50,100),scale:.45}},Da={fov:400},Sp=[1.066,.243,-.088],Ue=class extends tt{constructor(e,i,n){var o;super(e,i,n);this.cannotRotate=!0;this.net=((o=Tp[this.props.net])==null?void 0:o.net)||$g(this.props.net),this.rotation=Ep(this.props.rotation);let r=Ia(this.net,a=>new Ii(a.shape,{class:"polygon-tile"},a.color||_a(a.shape.points.length)));this.solid=r.group,this.foldTree=r.foldTree,this.$el.append(this.solid.$el),this.$outline=d("path",{class:"outline"},this.$el),this.$moveBar=d("path",{d:"M0 0h30",class:"handle"},this.$el),this.$moveHandle=d("path",{d:"M0 0h14v14h-14Z",class:"handle",style:"cursor: grab"},this.$el),this.solid.$el.css("cursor","move"),this.props.watch("color",({color:a})=>{if(!!a){for(let h of this.solid.getFaces())h.color=a;this.render(!1)}}),this.render(),this.updateOutline(),e.events.listen(this.solid.$el,{start:()=>{e.selection.add(this,!0),this.$el.removeClass("active")},move:({posn:a,lastPosn:h})=>{this.solid.transform.dragToRotate(h.subtract(this.posn),a.subtract(this.posn),100),this.render(!1)},end:()=>{this.rotation=this.solid.transform.toEulerAngles(),this.props.rotation=Na(this.rotation),this.updateOutline(),e.change({changed:[this]}),this.$el.addClass("active")},click:a=>e.tools.move.down(a),checkIfActive:()=>this.props.hinge>0})}applyChange(e){super.applyChange(e),this.rotation=Ep(this.props.rotation),this.render(),this.updateOutline()}render(e=!0){e&&(this.solid.transform.clear(),Oa(this.foldTree,this.solid.children[0],-this.props.hinge),this.solid.transform.rotate(...this.rotation)),this.solid.render(Da)}updateOutline(){let e=this.solid.getProjectedVertices(Da);this.path=C.convexHull(...e),this.$outline.draw(this.path),this.transform(),this.$moveBar.translate(this.path.points[0].x-30,this.path.points[0].y),this.$moveHandle.translate(this.path.points[0].x-45,this.path.points[0].y-7)}animateHinges(e,i=!1,n=800){return O(this,null,function*(){let r=i?this.rotation:[0,0,0],o=this.props.hinge;yield dt(a=>{this.props.hinge=wt(o,e,a),i&&(this.rotation=r.map(h=>h*(1-a))),this.render()},n).promise,this.props.rotation=Na(this.rotation),this.updateOutline()})}hingeStart(){this.startRotation=this.rotation,this.startAngle=this.props.hinge,this.$el.removeClass("active")}hingeMove(e){if(!y(e,this.props.hinge)){if(this.props.hinge=G(e,0,1),this.startRotation&&this.startAngle){let i=G(e/this.startAngle,0,1);this.rotation=this.startRotation.map(n=>i*n)}this.render()}}hingeEnd(){this.updateOutline(),this.props.rotation=Na(this.rotation),this.$el.addClass("active")}static fold(e){let i=Pp(e);if(!i){tr("polyhedron-error");return}let n={name:"polyhedron",net:Pg(i[1]),hinge:0,rotation:"0,0,0"},r=tt.create(e[0].$parent,n),o=r.solid.children[0].transform.matrix;r.setTransform(i[0].shift(-o[0][3],-o[1][3])),r.props.hinge=1,setTimeout(()=>{r.props.hinge=0,r.animateHinges(1)},10);for(let a of e)a.delete();return r}unfold(){return O(this,null,function*(){this.$parent.selection.remove(this),this.props.hinge>0&&(yield this.animateHinges(0,!0));let e=Array.from(this.solid.getFaces()).map(i=>{let n=new C(...Array.from(i.getProjectedVertices())),r=this.props.color||i.color||_a(n.points.length);return tt.create(this.$parent,{name:"polygon",shape:Hs(n),color:r,x:this.posn.x,y:this.posn.y})});return this.delete(),e})}static makeThumbnail(e,i){let n=d("svg",{width:70,height:70},e),r=d("g",{transform:"translate(35, 35)"},n),{net:o,scale:a}=Tp[i.net],h=Ia(o,l=>new Ii(l.shape,{class:"polygon-tile"},_a(l.shape.points.length)),-1).group;h.transform.clear().rotate(...Sp).scale({x:a,y:a,z:a}),r.append(h.$el),h.render(Da)}};Ue.type="polyhedron",Ue.defaultProps={hinge:1,rotation:Sp.join(",")},Ue=$([Bt],Ue);qt([{type:"button",tileTypes:["polyhedron"],label:"Unfold",click:(t,s)=>O(void 0,null,function*(){let e=Qt(yield Promise.all(t.map(i=>i.unfold())));s.change({added:e,deleted:t})})},{type:"slider",tileTypes:["polyhedron"],label:"Unfold",start:t=>t.hingeStart(),move:(t,s)=>t.hingeMove(s),end:t=>t.hingeEnd(),get:t=>t.props.hinge}]);var V=50,nt=Math.sqrt(3)/4*V;function Vt(t){let s=Math.cos(yt/t);return 1/Math.sqrt(2-2*s)}var kp={"equ-triangle":new C(new c(-V/2,nt),new c(V/2,nt),new c(0,-nt)),square:C.regular(4,V*Vt(4)),"reg-pentagon":C.regular(5,V*Vt(5)),"reg-hexagon":C.regular(6,V*Vt(6)),"reg-heptagon":C.regular(7,V*Vt(7)),"reg-octagon":C.regular(8,V*Vt(8)),"reg-decagon":C.regular(10,V*Vt(10)),"reg-dodecagon":C.regular(12,V*Vt(12)),rectangle:new R(new c(-V,-V/2),2*V,V).polygon,trapezium:new C(new c(-V,nt),new c(V,nt),new c(V/2,-nt),new c(-V/2,-nt)),rhombus:new C(new c(-V*3/4,nt),new c(V/4,nt),new c(V*3/4,-nt),new c(-V/4,-nt)),"right-triangle":new C(new c(-V/2,-V/2),new c(V/2,-V/2),new c(-V/2,V/2)),"rhombus-2":new C(new c(V/2-nt,V/4),new c(-nt-V/2,V/4),new c(nt-V/2,-V/4),new c(nt+V/2,-V/4)),chevron:new C(new c(-.75*V,2*nt),new c(.25*V,2*nt),new c(.75*V,0),new c(.25*V,-2*nt),new c(-.75*V,-2*nt),new c(-.25*V,0)),"right-triangle-2":new C(new c(-2*nt,-V/2),new c(-2*nt,V/2),new c(2*nt,-V/2)),kite:new C(new c(0,-V),new c(2*nt,-V/2),new c(0,V),new c(-2*nt,-V/2)),dart:new C(new c(2*nt,.75*V),new c(0,-.75*V),new c(-2*nt,.75*V),new c(0,.25*V))},Eg=[[[-15.7728,63.1105],[-65.2725,56.0545],[-61.7426,-21.037],[-34.7275,-63.1105],[65.2725,-63.1105]],[[60.6056,14.8729],[-53.4909,57.394],[-80.668,-12.5086],[-20.582,-57.394],[80.668,-57.394]],[[0,-73.612],[50,12.9905],[15,73.612],[-50,12.9905],[-30,-73.612]],[[67.056,-58.248],[67.056,1.752],[-10.5597,58.248],[-67.056,-19.3675],[7.056,-58.248]],[[-74.4415,-47.6314],[35.5585,-47.6314],[74.4415,-8.733],[60.1965,44.3902],[-19.4415,47.6314]],[[47.6215,-81.108],[43.731,-26.2458],[-24.012,81.108],[-47.6215,-43.6179],[-7.3786,-81.108]],[[94.9659,43.7299],[-5.0343,43.7299],[-94.9659,0],[-5.0343,-43.7299],[42.1151,-41.1631]],[[-13.1927,57.1955],[76.8074,57.1955],[76.8257,-32.8045],[-9.8062,-57.1955],[-76.8257,-6.4506]],[[-3.2764,58.8874],[86.2804,29.1016],[26.2804,-43.7514],[-26.2804,-58.8874],[-86.2804,13.9666]],[[51.5265,-55],[58.4735,-14.7198],[9.6458,43.251],[-58.4735,55],[-58.4735,-55]],[[-95.733,-40.991],[53.87,-40.991],[95.733,-15.7718],[1.5099,40.991],[-95.733,-10.4271]],[[-85.642,-51.4515],[12.4961,-51.4515],[85.642,-13.2965],[-38.4855,51.4515],[-85.642,18.5485]],[[-69.99,67.0025],[84.488,2.9975],[84.488,-67.0025],[14.488,-67.0025],[-84.488,32.0117]],[[-15.6401,96.696],[46.9202,6.219],[8.0799,-96.696],[-46.9202,-96.696],[-46.9202,51.458]],[[-46.6683,85],[-46.6683,22.7758],[15.5561,-85],[46.6683,-31.1122],[15.5561,85]],[[0,-46.65],[-43.301,-21.65],[-43.301,46.65],[43.301,46.65],[43.301,-21.65]],[[-25,46.65],[25,46.65],[59.15,-12.5],[0,-46.65],[-59.15,-12.5]],[[0,-64.951],[-50,21.65],[-25,64.951],[25,64.951],[50,21.65]]].map(t=>new C(...t.map(s=>new c(...s)))),Oi=["","","",q.yellow,q.blue,q.green,q.red,q.teal,q.purple],Tg={trapezium:q.orange,"right-triangle":q.green,"rhombus-2":q.lime,chevron:q.orange,kite:q.purple,dart:q.teal},Sg={"equ-triangle":q.green,square:q.yellow,"reg-pentagon":q.blue,"reg-hexagon":"#ffd615",rectangle:q.yellow,trapezium:"#cc1030",rhombus:q.blue,"rhombus-2":"#e6e2c6",chevron:"#cc1030","right-triangle-2":"#ffd615",kite:"#134791",dart:q.purple},Mg=[...J.rainbow(15).map(t=>t.hex),q.red,q.blue,q.yellow],Cg=new Set(["trapezium","rhombus","rhombus-2","rectangle","right-triangle","right-triangle-2"]),kg=new Set(["equ-triangle","square","reg-pentagon","reg-hexagon","reg-heptagon","reg-octagon","reg-decagon","reg-dodecagon","rectangle","trapezium","kite","dart"]),Hs=t=>t.points.map(s=>`${s.x.toFixed(2)} ${s.y.toFixed(2)}`).join(","),Ag=t=>new C(...t.split(",").map(s=>{let[e,i]=s.split(" ");return new c(+e||0,+i||0)}));function $r(t){return t.startsWith("pentagon-")?Eg[+t.slice(9)-1]:/^[\d.-]/.test(t)?Ag(t):kp[t]||kp.square}function Ap(t,s,e=!1){return t.startsWith("pentagon-")?Mg[+t.slice(9)-1]:(e?Sg:Tg)[t]||Oi[s%Oi.length]||q.yellow}var We=class extends qs{constructor(s,e,i){super(s,e,i);let n=$r(this.props.shape);this.props.watch("scale",({isFlipped:r,scale:o})=>{let a=r?n.reflect(Ma):n;this.setPath(a.scale(o||1))}),this.symmetric=kg.has(this.props.shape),this.props.color||(this.props.color=Ap(this.props.shape,this.path.points.length,s.options.altColors))}static makeThumbnail(s,e,i){let n=Cg.has(e.shape)?60:80,r=$r(e.shape);r=r.scale((e.shape.startsWith("pentagon-")?41:36)/r.radius).shift(40,n/2);let o=d("svg",{width:80,height:n},s),a=d("path",{class:"polygon-tile",path:r},o);i.options.watch(h=>a.setAttr("fill",Ap(e.shape,r.points.length,h.altColors)))}};We.type="polygon",We=$([Bt],We);var Pr=["polygon","tangram","polyomino","custom-polygon","rectangle","reg-polygon"];qt([{type:"button",label:"Flip",tileTypes:[...Pr,"egg","fractal","garden"],show:t=>t.length>1||!!t[0].rot||!t[0].symmetric,click:(t,s)=>{let e=s.selection.center;for(let i of t)i.flip(e);s.change({changed:t})}},{type:"button",tileTypes:Pr,label:"Cut",click:(t,s)=>s.tools.cutPolygon.enable()},{type:"button",label:"Join",tileTypes:Pr,show:t=>t.length>1,click:(t,s)=>{let e=t.map(o=>o.transformed),i=C.union(...e),n=t[0].props.color,r=i.map(o=>new We(t[0].$parent,{shape:Hs(o),color:n}));for(let o of t)o.delete();s.selection.select(r,!0),s.change({added:r,deleted:t})}},{type:"button",label:"Fold Net",tileTypes:Pr,show:t=>t.length>2,click:(t,s)=>{let e=Ue.fold(t);e&&s.change({added:[e],deleted:t})}}]);qt([{type:"input",label:"Scale:",advanced:!0,value:"number",range:[.1,10],icon:"geo-scale",tileTypes:["polygon","reg-polygon","custom-polygon"],get:t=>t.props.scale||1,set:(t,s)=>{s.props.scale=G(+t,.1,10),s.$parent.selection.update()}}]);var Vp='<g class="leg-pin" style="transform-origin:bottom right"><polygon points="0,-21 -7,-21 0,0" fill="#3a3645"></polygon><path d="M-23.9-375H0v354h-7l-17-19v-335H-23.9z" fill="#d6d4db"></path></g><g class="pencil"><rect class="leg-pencil" x="0" y="-375" width="24" height="307" style="transform-box:fill-box;transform-origin:bottom center" fill="#d6d4db"></rect><g><path d="M72-48c-0.5,0-3,5-3,5H39c0,0-2.5-5-3-5v-106h36C72-154,72-48,72-48z"></path><rect x="47" y="-154" width="14" height="111" fill="#000" opacity="0.3"></rect><path d="M37.4-47.3l2.2,2.6c0.4,0.5,1,0.8,1.6,0.8c0.5,0,1-0.2,1.4-0.6l2.8-3.9c0.9-0.8,2.3-0.9,3.3-0.2l3.6,3.2c1,0.8,2.4,0.8,3.4,0l3.6-3.2c1-0.7,2.4-0.6,3.3,0.2l2.8,3.9c0.4,0.4,0.9,0.6,1.4,0.6c0.6,0,1.2-0.3,1.6-0.8l2.2-2.6c0.3-0.4,0.8-0.7,1.4-0.7L61.4-19.6c-4.8-1.9-10-1.9-14.8,0L36-48C36.6-48,37.1-47.7,37.4-47.3z" fill="#f7eecb"></path><path d="M46.6-19.6c4.8-1.9,10-1.9,14.8,0L54,0L46.6-19.6z"></path></g><path d="M81-56H15c-1.7,0-3-1.3-3-3v-18c0-1.7,1.3-3,3-3h66c1.7,0,3,1.3,3,3v18C84-57.3,82.7-56,81-56z" fill="#d6d4db"></path><circle cx="12" cy="-68" r="16" fill="#d6d4db"></circle><circle cx="12" cy="-68" r="9" fill="#3a3645"></circle></g><g class="top"><path d="M19-422H9v-25c0-2.8-2.2-5-5-5h-8c-2.8,0-5,2.2-5,5v25h-10c-2.8,0-5,2.2-5,5l0.1,42l9.2,19.2c0.4,1,1.4,4,4,4h21.7c2.7,0,3.7-3,4.1-4L24-375v-42C24-419.8,21.8-422,19-422z" fill="#3a3645"></path><circle cy="-386" r="9" fill="#d6d4db"></circle></g>';var ft=50,Ip=100,Ys=class extends tt{constructor(e,i,n){super(e,i,n);this.cannotRotate=!0;this.cannotDragToSelect=!0;this.$el.addClass("utensil"),this.absoluteEnd=new c(this.props.width,0),this.setup(),this.$handles=[0,1].map(r=>this.makeHandle("c",(o,a)=>{var p;let h=r?this.posn:this.absoluteEnd,l=(p=this.$parent.snapping.snap([a]))==null?void 0:p.shift;a=l?a.add(l):a.snap(h,10),c.distance(a,h)<Ip&&(a=new et(h,Ip).project(a)),this[r?"absoluteEnd":"posn"]=a,this.rot=this.props.rot=Kt(this.absoluteEnd.angle(this.posn)),this.props.isFixed||(this.props.width=this.absoluteEnd.subtract(this.posn).length),this.update()})),this.update()}applyChange(e){super.applyChange(e),this.update()}flip(){this.props.isFlipped=!this.props.isFlipped,this.update()}moveEnd(){this.absoluteEnd=new c(this.props.width,0).rotate(Q(this.rot)).add(this.posn),super.moveEnd()}update(){this.$handles[1].setCenter({x:this.props.width,y:0}),this.transform()}getDrawingPath(e){var n;let i=(n=this.transformed)==null?void 0:n.project(e);if(i&&c.distance(e,i)<30)return this.transformed}},Vg=new Set(["ruler","protractor","set-triangle","compass"]);function Rp(t){return Vg.has(t.props.name)}var Ig=2.54,Er=60,js=ft*Ig;function*Op(t,s,e,i){let n=(s+.1)/t;for(let r=0;r<=n;r+=1){let o=i?i.findIndex(h=>!(r%h)):-1,a=r*t;yield[e?s-a:a,o]}}var Us=class extends Ys{constructor(e,i,n){super(e,i,n);this.padding=[0,20,0,20];this.props.watch("units fixed",()=>this.update())}setup(){this.$glass=d("rect",{x:-20,height:Er,class:"glass",rx:5},this.$el),this.$ticks=d("path",{class:"ticks"},this.$el),this.$labelsTop=H(e=>d("text",{text:e},this.$el),31),this.$labelsBottom=H(e=>d("text",{text:e,y:42},this.$el),12)}update(){let{units:e,width:i,isFlipped:n}=this.props,r=e==="both";this.$glass.setAttr("width",i+40),this.path=new R(I,i,Er);let o="";if(e!=="in")for(let[h,l]of Op(ft/10,i,n,[10,5]))o+=`M${h} 0v${([20,15][l]||10)*(r?.8:1)}`;if(e!=="cm"){let h=r?Er:0;for(let[l,p]of Op(js/16,i,n,[16,8,4]))o+=`M${l} ${h}v${([20,16,12][p]||8)*(r?-.8:1)}`}this.$ticks.setAttr("d",o);let a=e==="in"?js:ft;for(let[h,l]of this.$labelsTop.entries())l.toggle(h*a<=i+.1),l.setAttr("y",r?26:32),l.setAttr("x",n?i-a*h:a*h);for(let[h,l]of this.$labelsBottom.entries())l.toggle(r&&h*js<=i+.1),l.setAttr("x",n?i-js*h:js*h);super.update()}getSnapPoints(){let e=this.props.units==="both",i=js/2,n=H(o=>new c(this.props.isFlipped?this.props.width-o*ft:o*ft,0),this.props.width/ft),r=H(o=>new c(this.props.isFlipped?this.props.width-o*i:o*i,e?Er:0),this.props.width/i);return this.props.units==="cm"?n:e?[...n,...r]:r}getSnapLines(){let[e,i,n]=this.path.edges;return this.props.units==="both"?[e,n]:[e]}getDrawingPath(e){if(!this.transformed)return;let[i,n,r]=this.transformed.edges,o=c.distance(e,i.project(e)),a=c.distance(e,r.project(e));return o<30?i:this.props.units==="both"&&a<30?r:void 0}};Us.type="ruler",Us.defaultProps={width:400,layer:"front",units:"cm"},Us=$([Bt],Us);function Og(t){return`M0-${t}A${t},${t},0,0,0-${t},0V3a5,5,0,0,0,5,5H${t-5}a5,5,0,0,0,5-5V0A${t},${t},0,0,0,0-${t}Z`}var Ws=class extends Ys{constructor(){super(...arguments);this.padding=[0,0,10,0]}setup(){this.$glass=d("path",{d:"",class:"glass"},this.$el),this.$ticks=d("path",{class:"ticks"},this.$el),this.$labels=H(e=>[d("text",{text:e*10},this.$el),d("text",{text:e*10,style:"font-size:9px"},this.$el)],19),this.$labels[9][0].css("font-size","20px"),this.$labels[9][1].hide()}update(){let e=this.props.width;this.path=new Lt(I,new c(-this.props.width,0),Math.PI),this.$glass.setAttr("d",Og(e));let i="",n=this.props.width<120?5:1;for(let r=0;r<=180;r+=n){let o=!(r%10),a=!o&&!(r%5),h=c.fromPolar(Q(-r)),l=e-(o?30:a?23:15);i+=`M${h.x*e} ${h.y*e}L${h.x*l} ${h.y*l}`,o&&(i+=`M${h.x*8} ${h.y*8}L${h.x*(e-60)} ${h.y*(e-60)}`)}this.$ticks.setAttr("d",i);for(let[r,[o,a]]of this.$labels.entries()){if(r===9){o.setAttr("y",52-e);continue}o.toggle(e>160||!(r%3)),a.toggle(e>160),o.setAttr("y",44-e),a.setAttr("y",55-e),o.setAttr("transform",`rotate(${(this.props.isFlipped?-1:1)*(90-10*r)})`),a.setAttr("transform",`rotate(${(this.props.isFlipped?1:-1)*(90-10*r)})`)}super.update()}getSnapPoints(){return[I,this.path.start,this.path.at(.5),this.path.end]}getSnapLines(){return[]}};Ws.type="protractor",Ws.defaultProps={width:200,layer:"front"},Ws=$([Bt],Ws);var Ga=234,Mr=150;function Rg(t){let s=t<Mr?t/(Mr/(Ga/6)):t<Ga?Ga/6:t/6,e=s+s*Math.SQRT2;return`M0,0 H${t} L0,${-t} V0 M${s},${-s} H${t-e} L${s},${-t+e} V${s},${-s}`}var Ks=class extends Ys{setup(){this.$glass=d("path",{d:"","fill-rule":"evenodd",class:"glass"},this.$el),this.$ticks=d("path",{class:"ticks"},this.$el),this.$hLabels=H(e=>d("text",{text:e,y:-23},this.$el),31),this.$hLabels[0].hide(),this.$vLabels=H(e=>d("text",{text:e,x:25,"dominant-baseline":"central"},this.$el),31),this.$vLabels[0].hide()}update(){this.path=new C(I,new c(this.props.width,0),new c(0,-this.props.width)),this.$glass.setAttr("d",Rg(this.props.width));let e=this.props.width-50,i="",n=2,r=1;for(let o=0;o<=e;o+=ft/10){let a=o%ft?o%(ft/2)?0:r:n,h=o<10?-10*(o/10):[-10,-15,-20][a];i+=`M${o} 0V${h}`}for(let o=0;o<=e;o+=ft/10){let a=o%ft?o%(ft/2)?0:r:n,h=o<10?10*(o/10):[10,15,20][a];i+=`M0,${-o} H${h}`}this.$ticks.setAttr("d",i);for(let[o,a]of this.$hLabels.entries())o>0&&a.toggle(this.props.width>=Mr&&o<e/ft),a.setAttr("x",ft*o);for(let[o,a]of this.$vLabels.entries())o>0&&a.toggle(this.props.width>=Mr&&o<e/ft),a.setAttr("y",ft*-o);super.update()}getSnapPoints(){let e=this.props.width,i=new X(I,new c(e,0)),n=new X(I,new c(0,-e)),r=H(a=>i.at(a*ft/e),e/ft),o=H(a=>n.at(a*ft/e),e/ft);return r.concat(o)}getSnapLines(){return[this.path]}};Ks.type="set-triangle",Ks.defaultProps={width:280,layer:"front"},Ks=$([Bt],Ks);var Tr=375,Sr=new c(54,68),Xs=class extends Ys{setup(){this.$el.html=Vp,this.$pencil=this.$el.$(".pencil"),this.$top=this.$el.$(".top"),this.$legPin=this.$el.$(".leg-pin"),this.$legPencil=this.$el.$(".leg-pencil"),this.props.watch("color",({color:n})=>this.$pencil.css("fill",n));let e,i=0;this.$parent.events.listen(this.$pencil.$("g"),{start:n=>{let r=new c(this.props.width,0).rotate(Q(this.rot)).add(this.posn);e=new ce(this.$parent,"",this.props.color,"pen"),e.start(r,new et(this.posn,this.props.width)),i=Kt(n.posn.angle(this.posn))-this.rot;for(let o of this.$handles)o.setAttr("hidden",!0)},move:n=>{this.rot=Kt(n.posn.angle(this.posn))-i,this.transform();let r=c.fromPolar(Q(this.rot),this.props.width).add(this.posn);e.addPoint(r)},end:()=>{e.end(),this.$parent.change({added:[e],changed:[this]}),e=void 0;for(let n of this.$handles)n.removeAttr("hidden")}}),this.$parent.events.listen(this.$top,{start:n=>{i=Kt(n.posn.angle(this.posn))-this.rot;for(let r of this.$handles)r.setAttr("hidden",!0)},move:n=>{this.rot=Kt(n.posn.angle(this.posn))-i,this.transform()},end:()=>{this.$parent.change({changed:[this]});for(let n of this.$handles)n.removeAttr("hidden")}})}update(){this.props.width>730&&(this.props.width=730);let e=this.props.width-Sr.x,i=Tr-Sr.y,n=new et(I,Tr),r=new et(new c(e,-Sr.y),i),o=Z(n,r)[0],a=Math.acos(o.x/Tr),h=Math.acos((e-o.x)/i);this.$legPin.css("transform",`rotate(${-a+wa}rad`),this.$legPencil.css("transform",`rotate(${h-wa}rad`),this.$pencil.setTransform({x:this.props.width-Sr.x,y:0}),this.$top.setTransform({x:o.x,y:Tr+o.y}),this.path=new X(I,new c(this.props.width,0)),super.update()}getSnapPoints(){return[I,new c(this.props.width,0)]}getDrawingPath(){}};Xs.type="compass",Xs.defaultProps={width:300,layer:"front",color:q.red},Xs=$([Bt],Xs);qt([{type:"button",tileTypes:["ruler","protractor"],label:"Flip",click:(t,s)=>{for(let e of t)e.flip();s.change({changed:t})}}]);qt([{type:"select",tileTypes:["ruler"],label:"Units:",options:[{label:"Centimeters",key:"cm"},{label:"Inches",key:"in"},{label:"Both",key:"both"}],advanced:!0,get:t=>t.props.units,set:(t,s)=>s.props.units=t},{type:"checkbox",tileTypes:["ruler"],label:"Fixed Length",advanced:!0,get:t=>!!t.props.isFixed,set:(t,s)=>s.props.isFixed=t}]);var _e=class{constructor(s){this.$parent=s}getTileAt(s){let e=this.$parent.snapping.snapGeo(s.posn);if((e==null?void 0:e.tile)&&e.tile.canSelect)return e.tile;let i=s.event.target;for(;i;){let n=gr.get(i);if((n==null?void 0:n.canSelect)&&n.props.name!=="geo")return n;if(i=i.parentNode||void 0,i===this.$parent._el)return}}hoverGeoTile(s){var e;this.hoveringTile!==s&&((e=this.hoveringTile)==null||e.hover(!1)),s==null||s.hover(),this.hoveringTile=s}down(s){}start(s){}move(s){}up(s){}end(s){}click(s){}hover(s){}cancel(){}},Cr=class extends _e{constructor(){super(...arguments);this.clickTimeout=0}down(e){var n;let i=this.activeTile=this.getTileAt(e);this.previousSelection=void 0,(n=this.$parent.focussedTile)==null||n.blur(),this.$parent.warningBanner.hide(),i?(i.isActive&&this.$parent.events.shiftKey?this.$parent.selection.remove(i):(this.$parent.events.shiftKey||!i.isActive)&&this.$parent.selection.add(i,!this.$parent.events.shiftKey),i.down(e),xt.addClass("grabbing")):this.$parent.events.shiftKey?this.previousSelection=new Set(this.$parent.selection.tiles):this.$parent.selection.clear()}up(e){var i;(i=this.activeTile)==null||i.up(e)}start(){this.activeTile?(this.$parent.events.altKey&&this.$parent.paste(this.$parent.selection.copy(),I),this.$parent.selection.moveStart()):this.$parent.$selection.show()}move(e){var n;if(this.activeTile){this.$parent.selection.move(e);return}let i=R.aroundPoints([e.startPosn,e.posn]);this.$parent.$selection.setRect(i);for(let r of this.$parent.tiles.values()){if(!r.canSelect||r.cannotDragToSelect||!r.transformed)continue;let o=Ns(i,r.transformed,r.props.name);(this.$parent.events.shiftKey&&((n=this.previousSelection)==null?void 0:n.has(r))?!o:o)?this.$parent.selection.add(r,!1,!0):this.$parent.selection.remove(r,!0)}this.$parent.selection.update(!0)}end(){this.activeTile?this.$parent.selection.moveEnd():this.$parent.$selection.hide(),xt.removeClass("grabbing")}click(e){if(this.activeTile){this.activeTile.click(e);let i=Date.now();i-this.clickTimeout<500&&this.activeTile.doubleClick(e),this.clickTimeout=i}}hover(e){let i=this.getTileAt(e);this.hoverGeoTile(i!=null&&i.is("geo")?i:void 0),this.$parent.$svg.css("cursor",i?"grab":"")}},kr=class extends _e{constructor(){super(...arguments);this.erased=[]}down({posn:e}){this.erase(e)}move({posn:e,lastPosn:i}){let n=c.distance(e,i)/4;for(let r=0;r<n;++r)this.erase(c.interpolate(e,i,r/n))}shouldErase(e,i,n){return it(i)?c.distance(i,e)<10:ot(i)?i.distanceSquared(e)<100:Xi(i)?i.edges.some(r=>r.distanceSquared(e)<100):j(i)&&n==="geo"?Math.abs(c.distance(e,i.c)-i.r)<10:i.contains(e)}erase(e){for(let i of this.$parent.tiles.values())if(!(!i.transformed||i.cannotDragToSelect||!i.canSelect||i.cannotEdit)&&this.shouldErase(e,i.transformed,i.props.name)){i.delete(),this.erased.push(i);return}for(let i of this.$parent.strokes.values())if(i.hitTest(e,10)){i.delete(),this.erased.push(i);return}}end(){this.erased.length&&(this.$parent.change({deleted:this.erased}),this.$parent.snapping.updateIntersections()),this.erased=[]}click(){this.end()}},Ar=class extends _e{constructor(){super(...arguments);this.options="text"}down({posn:e}){let i=tt.create(this.$parent,{name:this.options,x:e.x-10,y:e.y-15});this.$parent.trigger("add-tile",{tile:i}),this.$parent.setActiveTool("move"),i.focus(!0)}},Vr=class extends _e{enable(){this.previousTool=this.$parent.state.tool,this.$parent.setActiveTool("pan")}down(e){this.initialOrigin=this.$parent.origin,this.startPosn=Ct(e.event)}move(e){let i=Ct(e.event).subtract(this.startPosn),n=this.initialOrigin.subtract(i.scale(1/this.$parent.zoom));this.$parent.setViewport(n,this.$parent.zoom)}disable(){this.$parent.setActiveTool(this.previousTool)}},Ir=class extends _e{constructor(){super(...arguments);this.options="pen"}getUtensil(e){for(let i of this.$parent.tiles.values()){let n=Rp(i)?i.getDrawingPath(e):void 0;if(n)return n}}down({posn:e}){this.stroke=new ce(this.$parent,"",this.$parent.state.penColor,this.options),this.stroke.start(e,this.getUtensil(e))}move({posn:e}){this.stroke.addPoint(e)}click(){this.$parent.change({added:[this.stroke]}),this.stroke=void 0}end(e){this.stroke.end(),this.click()}},Ri=class extends _e{constructor(){super(...arguments);this.options="line";this.angleIndex=0}expr(e,i){var n;switch(this.options){case"line":return`segment(${e},${i})`;case"circle":return`circle(${e},distance(${e},${i}))`;case"rect":return`rectangle(${e},${i}.x-${e}.x,${i}.y-${e}.y)`;case"angle":return`angle(${i},${(n=this.midPoint)==null?void 0:n.props.key},${e})`}}snapPoint(e){var o;let i=this.$parent.snapping.snap([e]);i&&(e=e.add(i.shift));let n="",r=((o=i==null?void 0:i.tile)==null?void 0:o.props.name)==="geo"?i==null?void 0:i.tile:void 0;return(r==null?void 0:r.path)&&it(r.path)&&(n=r.props.key),i!=null&&i.intersection&&(n=i.intersection),{point:e,tile:r,expr:n||`point(${e.x},${e.y})`}}getOrMakePointTile(e){var n,r;if(((n=e==null?void 0:e.tile)==null?void 0:n.path)&&it(e.tile.path))return e.tile;if((r=e==null?void 0:e.tile)!=null&&r.path){let o=e.tile.path.offset(e.point),a=new At(this.$parent,{expr:`${e.tile.props.key}.at(${o})`});return this.$parent.trigger("add-tile",{tile:a}),a}let i=new At(this.$parent,{expr:e.expr});return this.$parent.trigger("add-tile",{tile:i}),i}drawPendingPoint(e){var r,o;let i=((o=(r=e.tile)==null?void 0:r.path)==null?void 0:o.type)==="point",n=e.expr.startsWith("intersection");this.$parent.$pendingPoint.toggle(!i),i||(this.$parent.$pendingPoint.setCenter(e.point),this.$parent.$pendingPoint.setClass("intersection",n),this.$parent.$pendingPoint.setAttr("r",n?3.5:6))}down({posn:e}){var r;let i=this.snapPoint(e),n=this.getOrMakePointTile(i);this.createdNewStart=((r=i.tile)==null?void 0:r.geoType)!=="point",this.options==="angle"?this.angleIndex===0?(this.startPoint=n,this.angleIndex=1,this.createdNewStart&&this.$parent.change({added:[n]})):this.angleIndex===1?(this.midPoint=n,this.angleIndex=2,this.path=new At(this.$parent,{expr:this.expr(this.startPoint.props.key,n.props.key)}),this.createdNewStart&&this.$parent.change({added:[n]})):(this.path.setExpr(this.expr(this.startPoint.props.key,n.props.key)),this.$parent.change({added:this.createdNewStart?[n,this.path]:[this.path]}),this.angleIndex=0,this.path=this.startPoint=this.midPoint=this.createdNewStart=void 0):this.startPoint=n}start(){var e;this.options!=="angle"&&(this.path=new At(this.$parent,{}),this.startPoint.pending=this.path.pending=!0,(e=this.$parent.$pendingPoint)==null||e.show(),this.hoverGeoTile())}move({posn:e}){var i;this.options!=="angle"&&(this.endSnap=this.snapPoint(e),this.path.setExpr(this.expr(this.startPoint.props.key,this.endSnap.expr),!0),this.drawPendingPoint(this.endSnap),this.hoverGeoTile((i=this.endSnap)==null?void 0:i.tile))}end(){var n,r,o;if(this.options==="angle")return;let e=c.distance(this.startPoint.path,this.endSnap.point)<8,i;if(e?this.path.delete():(i=this.getOrMakePointTile(this.endSnap),this.path.setExpr(this.expr(this.startPoint.props.key,i.props.key)),this.path.setPending(!1),this.$parent.trigger("add-tile",{tile:this.path})),this.startPoint.setPending(!1),(n=this.$parent.$pendingPoint)==null||n.hide(),this.hoverGeoTile(),this.$parent.snapping.updateIntersections(),this.createdNewStart||!e){let a=[];this.createdNewStart&&a.push(this.startPoint),this.path&&a.push(this.path),i&&((o=(r=this.endSnap)==null?void 0:r.tile)==null?void 0:o.geoType)!=="point"&&a.push(i),this.$parent.change({added:a})}this.startPoint=this.path=this.endSnap=void 0}click(){this.options!=="angle"&&this.createdNewStart&&this.$parent.change({added:[this.startPoint]})}hover(e){var n;let i=this.snapPoint(e.posn);this.drawPendingPoint(i),this.hoverGeoTile(((n=i==null?void 0:i.tile)==null?void 0:n.props.name)==="geo"?i.tile:void 0),this.options==="angle"&&this.angleIndex===2&&this.path.setExpr(this.expr(this.startPoint.props.key,i.expr))}cancel(){this.$parent.$pendingPoint.hide(),this.path&&this.path.delete(),this.startPoint=this.path=this.endSnap=void 0,this.angleIndex=0}},Or=class extends Ri{constructor(){super(...arguments);this.startId="";this.expression=""}enable(e){var i;this.expression=e,this.$parent.selection.clear(),this.$parent.setActiveTool("geoPending"),(i=window.event)!=null&&i.clientX&&this.hover({posn:ee(window.event,this.$parent.$svg)})}makePath(){return this.path=new At(this.$parent,{}),this.path.$el.css("opacity",.5),this.path.pending=!0,this.path}down(e){if(!this.expression)return;super.down(e);let i=this.path||this.makePath();i.$el.css("opacity",1),i.setExpr(this.expression.replace(/\$1/g,this.startPoint.props.key)),i.pending=!1,this.path=void 0,this.$parent.selection.add(i,!0);let n=this.createdNewStart?[this.startPoint]:[];this.$parent.change({added:[...n,i]}),this.$parent.snapping.updateIntersections(),this.$parent.trigger("add-tile",{tile:i}),this.$parent.setActiveTool("move")}hover({posn:e}){var n;if(!this.expression)return;let i=this.snapPoint(e);this.drawPendingPoint(i),this.hoverGeoTile(((n=i==null?void 0:i.tile)==null?void 0:n.props.name)==="geo"?i.tile:void 0),this.path||this.makePath(),this.path.setExpr(this.expression.replace(/\$1/g,i.expr))}cancel(){super.cancel(),this.expression=""}},Rr=class extends _e{enable(){if(this.tiles=Array.from(this.$parent.selection.tiles).filter(e=>e.props.status!=="fixed"),!this.tiles.length)return this.cancel();this.$parent.selection.clear(),this.$parent.setActiveTool("cutPolygon");for(let e of this.tiles)e.$el.addClass("active")}down(){}start({posn:e}){var i;!this.tiles||(this.startPoint=((i=this.$parent.snapping.snap([e]))==null?void 0:i.posn)||e,this.$stroke=d("line",{class:"stroke cut"},this.$parent.$strokes))}move({posn:e}){var i,n;!this.tiles||(this.endPoint=((i=this.$parent.snapping.snap([e]))==null?void 0:i.posn)||e.snap(this.startPoint,5),(n=this.$stroke)==null||n.setLine(this.startPoint,this.endPoint))}end(e){var a;if(!this.tiles)return;if(e.cancelled)return this.cancel();let i=new st(this.startPoint,this.endPoint),n=!1,r=[],o=[];for(let h of this.tiles||[]){let p=h.transformed.cut(i);if(p.length>1){for(let f of p)r.push(new We(this.$parent,{shape:Hs(f),color:h.props.color}));h.delete(),o.push(h),n=!0}else h.$el.removeClass("active")}n&&this.$parent.change({added:r,deleted:o}),(a=this.$stroke)==null||a.remove(),this.$stroke=this.tiles=this.startPoint=this.endPoint=void 0,this.$parent.setActiveTool("move")}click(){this.cancel()}cancel(){var e;for(let i of this.tiles||[])i.$el.removeClass("active");(e=this.$stroke)==null||e.remove(),this.$stroke=this.tiles=this.startPoint=this.endPoint=void 0,setTimeout(()=>this.$parent.setActiveTool("move"))}};var Lp='<x-icon class="bg-icon" name="eye-off" size="360"></x-icon><svg class="canvas" tabindex="0"><defs><pattern class="grid-pattern" id="square2-grid" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="50" height="50" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="square-dots" x="-4" y="-4" width="25" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="4" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="square-grid" x="0" y="0" width="125" height="125" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="25" y1="0" x2="25" y2="125"></line><line x1="0" y1="25" x2="125" y2="25"></line><line x1="50" y1="0" x2="50" y2="125"></line><line x1="0" y1="50" x2="125" y2="50"></line><line x1="75" y1="0" x2="75" y2="125"></line><line x1="0" y1="75" x2="125" y2="75"></line><line x1="100" y1="0" x2="100" y2="125"></line><line x1="0" y1="100" x2="125" y2="100"></line></g><rect x="0" y="0" width="125" height="125" opacity="0.5"></rect></pattern><pattern class="grid-pattern" id="tri-dots" x="0" y="-4" width="25" height="43.302" patternUnits="userSpaceOnUse"><circle cx="0" cy="4" r="2" opacity="0.3"></circle><circle cx="25" cy="4" r="2" opacity="0.3"></circle><circle cx="12.5" cy="25.651" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri-grid" x="0" y="0" width="25" height="43.302" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="25" y2="0"></line><line x1="0" y1="21.651" x2="25" y2="21.651"></line><line x1="0" y1="43.302" x2="25" y2="43.302"></line><line x1="0" y1="0" x2="25" y2="43.302"></line><line x1="25" y1="0" x2="0" y2="43.302"></line></g></pattern><pattern class="grid-pattern" id="tri2-dots" x="-4" y="0" width="43.302" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="0" r="2" opacity="0.3"></circle><circle cx="4" cy="25" r="2" opacity="0.3"></circle><circle cx="25.651" cy="12.5" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri2-grid" x="0" y="0" width="43.302" height="25" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="0" y2="25"></line><line x1="21.651" y1="0" x2="21.651" y2="25"></line><line x1="43.302" y1="0" x2="43.302" y2="25"></line><line x1="0" y1="0" x2="43.302" y2="25"></line><line x1="0" y1="25" x2="43.302" y2="0"></line></g></pattern><pattern class="grid-pattern" id="square-checked" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect class="filled" x="0" y="0" width="25" height="25" opacity="0.2"></rect><rect class="filled" x="25" y="25" width="25" height="25" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="rainbow-grid" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="10" y1="-10" x2="-110" y2="110" style="stroke:#cd0e66" stroke-width="17.678"></line><line x1="35" y1="-10" x2="-85" y2="110" style="stroke:#fd8c00" stroke-width="17.678"></line><line x1="60" y1="-10" x2="-60" y2="110" style="stroke:#22ab24" stroke-width="17.678"></line><line x1="85" y1="-10" x2="-35" y2="110" style="stroke:#0f82f2" stroke-width="17.678"></line><line x1="110" y1="-10" x2="-10" y2="110" style="stroke:#cd0e66" stroke-width="17.678"></line><line x1="135" y1="-10" x2="15" y2="110" style="stroke:#fd8c00" stroke-width="17.678"></line><line x1="160" y1="-10" x2="40" y2="110" style="stroke:#22ab24" stroke-width="17.678"></line><line x1="185" y1="-10" x2="65" y2="110" style="stroke:#0f82f2" stroke-width="17.678"></line><line x1="210" y1="-10" x2="90" y2="110" style="stroke:#cd0e66" stroke-width="17.678"></line></g></pattern><radialGradient id="sphere-gradient" cx="65%" cy="35%" r="65%"><stop offset="0" stop-color="white" stop-opacity="0.3"></stop><stop offset="0.32" stop-color="white" stop-opacity="0"></stop><stop offset="0.33" stop-opacity="0"></stop><stop offset="1" stop-opacity="0.2"></stop></radialGradient><linearGradient id="card-gradient"><stop offset="0" stop-color="#999"></stop><stop offset="0.08" stop-color="#bbb"></stop><stop offset="0.92" stop-color="#bbb"></stop><stop offset="1" stop-color="#999"></stop></linearGradient><filter id="handdrawn" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" basefrequency="0.004 0.004" numoctaves="26" stitchtiles="stitch" result="turbulence"></feTurbulence><feDisplacementMap in="SourceGraphic" in2="turbulence" scale="20" xchannelselector="R" ychannelselector="G" result="displacementMap"></feDisplacementMap></filter><filter id="pencil" x="-10%" y="-10%" width="110%" height="110%" filterUnits="objectBoundingBox"><feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="3" result="noise"></feTurbulence><feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="2" in="SourceGraphic" result="newSource"></feDisplacementMap></filter><symbol id="suit-c" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c2.3.1 4.2 1.9 4.3 4.2 0 1.6-.9 3-2.3 3.8.8-.3 1.6-.5 2.5-.5 2.4-.1 4.4 1.7 4.5 4.1v.2c0 2.3-1.9 4.2-4.2 4.2-.1 0-.2 0-.3 0-1.2-.1-2.4-.4-3.5-1 0 0-.3 2 2 5h-6c2.3-3 2-5 2-5-1.1.6-2.3.9-3.5 1-2.3.2-4.3-1.6-4.5-3.9 0-.1 0-.2 0-.3 0-2.4 1.9-4.3 4.3-4.3h.2c.9 0 1.7.2 2.5.5-1.4-.8-2.3-2.2-2.3-3.8.1-2.3 2-4.1 4.3-4.2z"></path></symbol><symbol id="suit-s" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c-3 5-8 7-8 12 .1 2.1 1.9 3.9 4 4 1.1.1 2.2-.2 3-1 0 0 .3 2-2 5h6c-2-3-2-5-2-5 .8.8 1.9 1.1 3 1 2.1-.1 3.9-1.9 4-4 0-5-5-7-8-12z"></path></symbol><symbol id="suit-h" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0 8.5-1.3-1.3c-4.6-4.1-7.7-6.9-7.7-10.3-.1-2.7 2.1-4.9 4.8-5h.2c1.5 0 3.1.7 4 1.9 1-1.2 2.5-1.9 4-1.9 2.8-.1 4.9 2.1 5 4.8v.2c0 3.4-3.1 6.2-7.7 10.3z"></path></symbol><symbol id="suit-d" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m7 0-7 10-7-10 7-10"></path></symbol><pattern id="card-bg" width="6" height="8" patternUnits="userSpaceOnUse"><rect width="6" height="8" fill="#0f82f2"></rect><line x2="6" y2="8" stroke="#eee" stroke-width="1"></line><line x1="6" y2="8" stroke="#eee" stroke-width="1"></line></pattern></defs><rect class="grid"></rect><path class="group-shadow"></path><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="strokes"></g><g class="geo-shadows"></g><g class="geo-paths"></g><g class="geo-points"></g><g class="tiles"></g><g class="tiles"></g><rect class="selection"></rect><g class="transform-tools" hidden><path class="group-outline"></path><line class="rotate-bar"></line><circle class="rotate-circle" r="10"></circle></g></svg><div class="html-overlay"></div><div class="rotate-label"></div><slot></slot>';var Lg=new Set(["x","y","\u03B8","r"]);function _p(t){if(t instanceof Tt&&t.fn==="="){let[s,e]=t.args;if(s instanceof Is&&!Lg.has(s.i))return[s.i,e]}return[void 0,t]}var Lr=class{constructor(){this.assignments=new Map;this.callbackDeps=new Map;this.updatedNames=new Set}findFirstAssigner(s){var e;return(e=this.assignments.get(s))==null?void 0:e.keys().next().value}findDependants(s,e=[]){let i=[];for(let[r,o]of this.assignments.entries())o.size===1&&r!==s&&!e.includes(r)&&zi(o.values()).unknowns.filter(h=>!e.includes(h)).includes(s)&&i.push(r);let n=Fi(i,r=>this.findDependants(r,i));return[...i,...n]}validate(s){let e=new Set,i=(n,r=[])=>{if(!this.assignments.has(n)){e.add(n);return}if(r.includes(n))return{message:`The variable <em>${n}</em> is defined recursively.`,locations:r.splice(r.indexOf(n)).map(a=>this.findFirstAssigner(a))};let o=this.assignments.get(n);if(o.size===1){let a=zi(o.values());for(let h of a.unknowns){let l=i(h,[...r,n]);if(l)return l}}else return{message:`You have defined <em>${n}</em> in multiple places.`,locations:Array.from(o.keys())}};for(let n of s.unknowns){let r=i(n);if(r)return{error:r,dependsOn:[],unknowns:[]}}return{dependsOn:[],unknowns:Array.from(e)}}evaluate(s){let{error:e,unknowns:i}=this.validate(s);if(e||i.length)return{error:e,value:Number.NaN};try{return{value:s.evaluate(this.evalContext)}}catch(n){return{value:Number.NaN}}}get evalContext(){let s={};for(let[e,i]of this.assignments.entries())i.size===1&&(s[e]=zi(i.values()));return s}get serializedEvalContext(){let s={};for(let[e,i]of Object.entries(this.evalContext))s[e]=i.toString();return s}substituteAssignments(s){let[e,i]=_p(s);return e?new Tt("=",[new Is(e),i.recursiveSubstitute(this.evalContext)]):s.recursiveSubstitute(this.evalContext)}markUpdated(s){this.updatedNames.add(s);for(let e of this.findDependants(s))this.updatedNames.add(e)}flushChanges(){for(let[e,i]of this.callbackDeps.entries())i.some(n=>this.updatedNames.has(n))&&e();let s=Array.from(this.updatedNames);return this.updatedNames.clear(),s}updateSource(s,e,i,n=!0){this.removeSource(s,!1),this.assignments.has(e)||this.assignments.set(e,new Map),this.assignments.get(e).set(s,i),this.markUpdated(e),n&&this.flushChanges()}attemptUpdateSource(s,e,i=!0){if(typeof e=="string")try{e=$t.parse(e).collapse()}catch(o){return}let[n,r]=_p(e);return n?this.updateSource(s,n,r,i):this.removeSource(s),r}removeSource(s,e=!0){for(let[i,n]of this.assignments.entries())n.has(s)&&this.markUpdated(i),n.delete(s),n.size===0&&this.assignments.delete(i);e&&this.flushChanges()}watch(s,e,i=!1){this.callbackDeps.set(e,s),i&&e()}unwatch(s){s&&this.callbackDeps.delete(s)}};var pe="https://static.mathigon.org/polypad/audio",Np={roll:new se(`${pe}/roll.mp3`,.6,!1),spin:new se(`${pe}/spin.mp3`,.5,!1),coinToss:new se(`${pe}/coin-toss.mp3`,.3,!1),shuffle:new se(`${pe}/shuffle.mp3`,.3,!1),draw:new se(`${pe}/card-draw.mp3`,.2,!1),click:new se(`${pe}/click.mp3`,.3,!1),woosh:new se(`${pe}/woosh.mp3`,.2,!1),rise:new se(`${pe}/rise.mp3`,.3,!1),fall:new se(`${pe}/fall.mp3`,.3,!1),splitCoins:new se(`${pe}/split-coins.mp3`,.175,!1),mergeCoins:new se(`${pe}/merge-coins.mp3`,.3,!1)};var Se=25,Ba=Se*Math.sqrt(3)/2,_g=Math.sqrt(2*Se**2)/2;function Zs(t,s,e){let i,n,r;t:for(let o of e)for(let a of s){let h=o.posn||o.path.project(a),l=h.subtract(a),p=l.length;if(p<t&&(t=p,i=h,n=l,r=o,p<1))break t}return n?Ft(zt({},r),{posn:i,shift:n}):void 0}function*qa(t){var s;for(let[e,i]of t){let n=Z(e.path,i.path);for(let[r,o]of n.entries())yield{posn:o,intersection:`intersections(${e.props.key},${((s=i==null?void 0:i.props)==null?void 0:s.key)||i.path})[${r}]`}}}var _r=class{constructor(s){this.$parent=s;this.geoIntersections=new Set;this.strokeIntersections=new Set}*getGeoPoints(){for(let s of this.$parent.getTilesOfType("geo"))s.isActive||s.pending||s.props.status==="hidden"||s.path&&it(s.path)&&(yield{posn:s.path,tile:s});for(let s of this.geoIntersections)yield s}*getVertices(){for(let s of this.$parent.tiles.values())if(!(s.isActive||s.pending||s.props.name==="geo"))for(let e of s.snapPoints)yield{posn:e,tile:s};for(let s of this.$parent.strokes.values())for(let e of s.snapPoints||[])yield{posn:e};for(let s of this.strokeIntersections)yield s}*getGridPoints(s){if(!this.$parent.options.grid||this.$parent.options.grid==="none")return;let e=this.$parent.options.grid.split("-")[0],i=R.aroundPoints(s),n=new ut(i.p.x-Se,i.p.x+i.w+2*Se,i.p.y-Se,i.p.y+i.h+2*Se);if(e.startsWith("square")){let r=(e==="square2"?2:1)*Se,o=vt(n.xMin,r);for(let a=vt(n.yMin,r);a<n.yMax;a+=r)for(let h=o;h<n.xMax;h+=r)yield{posn:new c(h,a)}}else if(e.startsWith("tri")){let r=e==="tri2";r&&(n=n.flip);let o=vt(n.xMin,Se);for(let a=Math.floor(n.yMin/Ba);a*Ba<n.yMax;++a)for(let h=o+(a%2?Se/2:0);h<n.xMax;h+=Se){let l=new c(h,a*Ba);yield{posn:r?l.flip:l}}}}*getSnapLines(){for(let s of this.$parent.tiles.values())if(!(s.isActive||s.pending))for(let e of s.snapLines)yield{path:e,tile:s};for(let s of this.$parent.strokes.values())s.snap&&(yield{path:s.path})}snap(s){var e,i,n;if(!this.$parent.options.noSnapping)return(n=(i=(e=Zs(12,s,this.getGeoPoints()))!=null?e:Zs(8,s,this.getVertices()))!=null?i:Zs(_g,s,this.getGridPoints(s)))!=null?n:Zs(6,s,this.getSnapLines())}*getGeoEls(s=!0){for(let e of this.$parent.getTilesOfType("geo"))!e.canSelect||!e.transformed||(s&&it(e.transformed)&&(yield{posn:e.transformed,tile:e}),!s&&!it(e.transformed)&&(yield{path:e.transformed,tile:e}))}snapGeo(s){if(!this.$parent.options.noSnapping)return Zs(12,[s],this.getGeoEls(!0))||Zs(6,[s],this.getGeoEls(!1))}*geoTiles(){for(let s of this.$parent.getTilesOfType("geo"))s.path&&s.props.status!=="hidden"&&!it(s.path)&&(yield s)}*strokes(){for(let s of this.$parent.strokes.values())s.snap&&(yield s)}updateIntersections(){this.geoIntersections.clear(),this.strokeIntersections.clear();let s=Array.from(this.geoTiles()),e=Array.from(this.strokes());for(let i of qa(eo(s)))this.geoIntersections.add(i);for(let i of qa(ms(s,e)))this.geoIntersections.add(i);for(let[i,n]of eo(e))for(let r of Z(i.path,n.path))this.strokeIntersections.add({posn:r})}addStroke(s){if(!!s.snap){for(let e of this.strokes())if(e!==s)for(let i of Z(e.path,s.path))this.strokeIntersections.add({posn:i});for(let e of qa(ms(this.geoTiles(),[s])))this.geoIntersections.add(e)}}};var za=[{type:"checkbox",tileTypes:["axes","balance","fraction-bar","decimal-grid","multi-jump","number-line","ten-frame","number-tile","image","spinner","custom-spinner","box-whisker","chart","pie-chart","table","rectangle","reg-polygon","custom-polygon"],label:"Show handles:",icon:"handles",advanced:!0,get:t=>!t.props.hideHandles,set:(t,s)=>s.props.hideHandles=!t},{type:"button",tileTypes:["all"],label:"Copy",icon:"copy",show:t=>!t[0].$parent.options.noCopyPaste&&t.every(s=>!s.cannotEdit),click:(t,s)=>s.paste(s.selection.copy(),new c(25,25))},{type:"button",tileTypes:["all"],label:"Delete",icon:"delete",show:t=>!t[0].$parent.options.noDeleting&&t.every(s=>s.props.status!=="fixed"&&!s.cannotEdit),click:(t,s)=>s.selection.delete()},{type:"select",tileTypes:["all"],label:"Layer:",icon:"layer-front",show:t=>t.every(s=>s.props.name!=="geo"),options:[{key:"front",label:"Top"},{key:"normal",label:"Default"},{key:"back",label:"Back"}],advanced:!0,get:t=>t.props.layer||"normal",set:(t,s)=>s.props.layer=t},{type:"select",tileTypes:["all"],label:"Interactivity:",icon:"lock",options:[{key:"",label:"Default"},{key:"locked",label:"Locked"},{key:"fixed",label:"Cannot Move"},{key:"hidden",label:"Invisible"}],advanced:!0,get:t=>t.props.status||"",set:(t,s)=>s.props.status=t||void 0}];var Dp=t=>t.toLowerCase().replace(":","").replace(/\s/g,"-"),Ng=["polygons","polyominoes","tangram","penrose","pentagons","solids","measuring","patterns","number-tiles","number-bars","number-frames","number-cards","number-line","primes","number-dots","number-grid","number-tools","fraction-bars","fraction-circles","algebra-tiles","balance","axes","sliders","random","charts","playing-cards","polyhedral-dice","non-trans-dice","logic","chess","currency","clocks","dominoes"],Dg=["move","pen","geo","text","equation","eraser","image","color"],Gg=Pt([...za,...vr].map(t=>Dp(t.label))).sort(),Dr=[["toolbar",Dg],["sidebar",Ng],["actionbar",Gg]],Fa=["mergeTiles","evalEquations","altColors","largeUI"],Ha=["noCopyPaste","noDeleting","noRotating","noUndoRedo","noPinchPan","noSnapping","noAudio"],Bg=["fullscreen","grid"],Gp=[...Dr.map(t=>t[0]),...Fa,...Ha,"settings"],Bp={advanced:{mergeTiles:!0,evalEquations:!0},common:{actionbar:Pt([...za,...vr].filter(t=>!t.advanced).map(t=>Dp(t.label))).join(","),mergeTiles:!0,evalEquations:!0},simple:{sidebar:"polygons,polyominoes,tangram,solids,measuring,number-tiles,number-bars,number-frames,number-cards,number-line,fraction-bars,fraction-circles,algebra,balance,probability,playing-cards,polyhedral-dice,clocks,dominoes",toolbar:"move,pen,text,eraser,color",actionbar:"copy,delete,unfold,hinges,flip,cut,fold-net,turn-over,draw,shuffle,merge,split,start,step,width,divisions,rename,balance,randomise,seconds",settings:"grid",mergeTiles:!0,largeUI:!0,noPinchPan:!0}};function qp(){let t={};for(let s of Gp)t[s]=Bp.advanced[s];return t}function qg(t,s,e,i){let n=d("label",{text:" "+e},t),r=d("input",{type:"checkbox"});n.prepend(r),r.bindVariable(i,s)}function zg(t){return t.replace(/(^|-)(\w)/g,(s,e,i)=>` ${i.toUpperCase()}`)}var Nr=class extends S{bindPolypad(e){this.options=e.options}ready(){this.$modal=this.parents("x-modal")[0],this.$modal.on("open",()=>this.load(this.options)),this.setup()}setup(){let e=Ht({preset:r=>this.load(Bp[r]||{}),cancel:()=>this.$modal.close(),save:()=>this.save()});this.bindModel(e);let i=this.$$(".ui-columns").slice(1),n=this.$$("button.switch");for(let[r,[o,a]]of Dr.entries()){for(let h of a)qg(i[r],`${o}-${h}`,zg(h),e);n[r].on("click",()=>{let h=a.some(l=>e[`${o}-${l}`]);for(let l of a)e[`${o}-${l}`]=!h}),this.model[o]=!0}}load(e){var n;for(let[r,o]of Dr){let a=e[r]||"";this.model[r]=a!=="hidden";let h=a.split(",");for(let l of o)this.model[`${r}-${l}`]=!a||h.includes(l)}let i=(n=e.settings)==null?void 0:n.split(",");for(let r of Bg)this.model[r]=!i||i.includes(r);for(let r of Fa)this.model[r]=!!e[r];for(let r of Ha)this.model[r]=!e[r]}save(){for(let[e,i]of Dr)this.model[e]?i.every(n=>this.model[`${e}-${n}`])?this.options[e]=void 0:this.options[e]=i.filter(n=>this.model[`${e}-${n}`]).join(","):this.options[e]="hidden";this.options.settings=this.model.fullscreen&&this.model.grid?void 0:this.model.fullscreen?"fullscreen":this.model.grid?"grid":"other";for(let e of Fa)this.options[e]=!!this.model[e]||void 0;for(let e of Ha)this.options[e]=!this.model[e]||void 0;for(let e of Gp)w.setStorage(`polypad.options.${e}`,this.options[e]);this.$modal.close()}};Nr=$([P("x-polypad-customise")],Nr);function ja(t,s){var o,a,h,l,p,f,m;if(s.value!==void 0)return["",s.value,0,s.value,0];if(s.is("algebra")){let g=s.props.expr.startsWith("-")?-1:1,x=g<0?s.props.expr.slice(1):s.props.expr,u=(o=t.tileWeights.get("x"))!=null?o:5,v=(a=t.tileWeights.get("y"))!=null?a:4;switch(x){case"1":return["",g,0,g,0];case"x":return["x",g,0,g*u,u];case"x2":return["x",0,g,g*u*u,u];case"y":return["y",g,0,g*v,v];case"y2":return["y",0,g,g*v*v,v];case"xy":return["x",g*v,0,g*v*u,u]}}let e=s.props,i=(f=(p=(l=(h=e.shape)!=null?h:e.index)!=null?l:e.href)!=null?p:e.sides)!=null?f:e.expr,n=btoa(s.props.name+i+s.props.raw.color).replace(/=/g,""),r=(m=t.tileWeights.get(n))!=null?m:1;return[n,1,0,r,r]}function Fg(t,s,e){let i={},n=0,r=(m,g=1)=>{let[x,u,v,b,E]=ja(t,m);n+=g*b,x&&(i[x]||(i[x]=[0,0,0]),i[x][0]+=g*u,i[x][1]+=g*v,i[x][2]=E)};for(let m of s)r(m,1);for(let m of e)r(m,-1);if(y(n,0))return;let o=Object.keys(i).filter(m=>i[m][0]||i[m][1]),a=o.find(m=>!t.tileWeights.has(m))||L(o);if(!a)return!0;let[h,l,p]=i[a],f=y(l,0)?p-n/h:Math.max(...ao(l,h,n-h*p-l*p*p));t.tileWeights.set(a,f),t.options.tileWeights=Array.from(t.tileWeights.entries()).map(m=>m.join("=")).join(",")}function Up(t,s){t.tileWeights.clear();for(let e of s.split(",")){let[i,n]=e.split("=");i&&t.tileWeights.set(i,+n||0)}}var zp="M0,26A18.1,18.1,0,0,0-18,44V72H18V44A18.1,18.1,0,0,0,0,26Z",Fp=new Set(["text","number-line","spinner","decimal-grid","axes","custom-spinner","ruler","protractor","compass","geo","dot-machine","abacus","balance","chess-board","multi-jump","set-triangle","bucket","table","number-grid","ten-frame","chart","pie-chart","box-whisker","clock","polyhedron","rectangle","question-blank","logic-switch","logic-gate","logic-speaker","chess-piece"]),Li=15,St=40,Hp=180;function Gr(t){let s=t/2;return`M${s},0C${s},16,66.3,20,0,20S${-s},16${-s},0Z`}function jp(t,s){var i;let e=t.posn.shift(0,s);t.$el.setTransform(e,Q(t.rot)),t.transformed=(i=t.path)==null?void 0:i.rotate(t.rot).translate(e)}var Qs=class extends tt{constructor(e,i,n){super(e,i,n);this.cannotRotate=!0;this.left=[];this.right=[];this.isAnimating=!1;this.$beam=d("path",{class:"balance-beam"},this.$el),this.$left=d("path",{class:"balance"},this.$el),this.$right=d("path",{class:"balance"},this.$el),this.$base=d("path",{d:zp,class:"balance"},this.$el),this.$leftRect=d("rect",{class:"balance-target"},this.$el),this.$rightRect=d("rect",{class:"balance-target"},this.$el),this.$handle=this.makeHandle("c",o=>{this.props.size=G(vt(o.x-St,20),120,800),this.resize(),this.draw(),this.transform()},void 0,()=>this.showTargets(),()=>this.hideTargets()),this.props.watch("color",({color:o})=>{this.$beam.css("stroke",o);for(let a of[this.$base,this.$left,this.$right])a.css("fill",o)}),this.customTransform(),this.resize(),this.draw();let r=[];this.onMoveStart=()=>{r=Array.from(e.selection.tiles).filter(o=>!Fp.has(o.props.name)),this.isActive&&this.showTargets()},this.onMove=()=>{if(this.isActive||!r.length)return;for(let h of r)h.transform();let[o,a]=this.checkTileOverlaps(r);this.$leftRect.toggle(!!o.length),this.$rightRect.toggle(!!a.length)},this.onMoveEnd=()=>{this.hideTargets(),r=[]},this.onChange=o=>{o.action==="change"&&([this.left,this.right]=this.checkTileOverlaps(this.$parent.tiles.values()),this.rebalance(400,o))},e.on("move-start",this.onMoveStart),e.on("move-selection",this.onMove),e.on("move-end",this.onMoveEnd),setTimeout(()=>e.on("change",this.onChange))}delete(){this.$parent.off("move-start",this.onMoveStart),this.$parent.off("move-selection",this.onMove),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}showTargets(){this.$leftRect.show(),this.$rightRect.show()}hideTargets(){this.$leftRect.hide(),this.$rightRect.hide()}targetAreas(){let e=new R(new c(0,-Hp),this.props.size,Hp),i=e.shift(-this.props.size-St,this.props.level*Li),n=e.shift(St,-this.props.level*Li);return[i,n]}checkTileOverlaps(e){let[i,n]=this.targetAreas().map(a=>a.translate(this.posn)),r=[],o=[];for(let a of e)!a.transformed||Fp.has(a.props.name)||(Ns(i,a.transformed)?r.push(a):Ns(n,a.transformed)&&o.push(a));return[r,o]}resize(){this.$left.setAttr("d",Gr(this.props.size)),this.$right.setAttr("d",Gr(this.props.size))}draw(e=this.props.level){let i=this.props.size/2+St,n=new c(-i,e*15),r=new c(i,-e*15);this.$beam.draw(new Wt(n.shift(0,10),n.shift(0,44),r.shift(0,44),r.shift(0,10))),this.$left.setTransform(n),this.$right.setTransform(r),this.$handle.setCenter({x:this.props.size+St,y:-e*15});let[o,a]=this.targetAreas();this.$leftRect.setRect(o),this.$rightRect.setRect(a)}rebalance(e=400,i){return O(this,null,function*(){let n=D(this.left.map(l=>ja(this.$parent,l)[3])),r=D(this.right.map(l=>ja(this.$parent,l)[3])),o=y(n,r)?0:n<r?-1:1;if(o===this.props.level||this.isAnimating)return;let a=this.props.level,h=(o-a)*Li;this.props.level=o;for(let l of this.left)l.setTransform(l.posn.shift(0,h));for(let l of this.right)l.setTransform(l.posn.shift(0,-h));if(i!=null&&i.data){let l=i.data.changed=i.data.changed||[],p=new Set([...i.data.added||[],...i.data.deleted||[]]);for(let f of[this,...this.left,...this.right])!l.includes(f)&&!p.has(f)&&l.push(f)}this.isAnimating=!0,yield dt(l=>{this.draw(wt(a,o,l));for(let p of this.left)jp(p,(l-1)*h);for(let p of this.right)jp(p,(1-l)*h);this.$parent.selection.update()},e).promise,this.isAnimating=!1,this.transform(),this.$parent.selection.update()})}customTransform(){let e=this.props.level*Li,i=this.props.size+St;this.path=new C(new c(-i,e),new c(-St,e),new c(-St,25),new c(St,25),new c(St,-e),new c(i,-e),new c(i,-e+48),new c(St,-e+48),new c(St,72),new c(-St,72),new c(-St,e+48),new c(-i,e+48))}getSnapPoints(){let e=this.props.level*Li,i=this.props.size+St;return[new c(-i,e),new c(-St,e),new c(St,-e),new c(i,-e)]}getSnapLines(){let[e,i,n,r]=this.getSnapPoints();return[new X(e,i),new X(n,r)]}balance(){if(Fg(this.$parent,this.left,this.right))return tr("balance-error");let i=new Set;for(let n of this.$parent.getTilesOfType("balance")){n.rebalance();for(let r of[n,...n.left,...n.right])i.add(r)}}static makeThumbnail(e){let i=d("svg",{width:250,height:50,viewBox:"-290 -10 580 82",class:"scale"},e);d("path",{d:"M-160 10v34h320v-34",fill:"transparent",stroke:"#bbb","stroke-width":10},i),d("path",{d:Gr(240),transform:"translate(-160 0)",fill:"#bbb"},i),d("path",{d:Gr(240),transform:"translate(160 0)",fill:"#bbb"},i),d("path",{d:zp,fill:"#bbb"},i)}};Qs.type="balance",Qs.defaultProps={level:0,size:240,color:"#bbb"},Qs=$([Bt],Qs);qt([{type:"button",tileTypes:["balance"],label:"Balance",show:t=>t.length===1&&!!t[0].props.level,click:(t,s)=>{t[0].balance(),s.change({changed:t})}}]);var Ua=3,Hg=new ut(-2e3,4e3,-2e3,4e3),Br=t=>`${t.xMin} ${t.yMin} ${t.dx} ${t.dy}`,Wp=t=>!!t.name,qr=class extends S{constructor(){super(...arguments);this.tiles=new Map;this.strokes=new Map;this.options=Ht({});this.state=Ht({tool:"move",changeCount:0,penColor:"#242436"});this.mathContext=new Lr;this.snapping=new _r(this);this.tools={move:new Cr(this),pen:new Ir(this),geo:new Ri(this),geoPending:new Or(this),eraser:new kr(this),text:new Ar(this),pan:new Vr(this),cutPolygon:new Rr(this)};this.initial={};this.margins=[20,20,20,20];this.origin=I;this.zoom=1;this.newTileShift=0;this.tileWeights=new Map;this.setup=!1;this.undoStack=[];this.redoStack=[]}ready(){this.$svg=this.$("svg.canvas"),this.$tiles=this.$svg.$$(".tiles"),this.$selection=this.$svg.$(".selection"),this.$strokes=this.$svg.$(".strokes"),this.$grid=this.$svg.$(".grid"),this.$html=this.$(".html-overlay"),this.$geoShadows=this.$svg.$(".geo-shadows"),this.$geoPaths=this.$svg.$(".geo-paths"),this.$geoPoints=this.$svg.$(".geo-points"),this.$pendingPoint=d("circle",{class:"geo-point pending",hidden:!0},this.$geoPoints),this.setAttr("data-tool","move"),this.events=new Gs(this.$svg,{down:e=>this.tools[this.state.tool].down(e),up:e=>this.tools[this.state.tool].up(e),start:e=>this.tools[this.state.tool].start(e),move:e=>this.tools[this.state.tool].move(e),end:e=>this.tools[this.state.tool].end(e),click:e=>this.tools[this.state.tool].click(e),hover:e=>this.tools[this.state.tool].hover(e),cursor:!1}),this.selection=new xr(this),this.warningBanner=new Qn(this),this.setViewport(I,1),this.options.watch(e=>{this.$grid.setAttr("fill",e.grid&&e.grid!=="none"?`url(#${e.grid})`:"none"),this.$grid.setRect(this.canvasBounds.rect)}),this.$svg.on("contextmenu",e=>{this.focussedTile||e.preventDefault()}),this.enablePinchPan(),this.enableAccessibility(),w.onThemeChange(()=>{for(let e of this.tiles.values())e.props.updateTheme();for(let e of this.strokes.values())e.setColor(e.color)}),this.state.watch(e=>this.setClass("high-contrast",!!e.highContrast)),this.state.watch(e=>this.setClass("handdrawn",!!e.handdrawn)),this.state.watch(e=>{this.setClass("setup-mode",!!e.setupMode);for(let i of this.selection.tiles)i.canSelect||this.selection.remove(i);this.selection.update()})}playSound(e){this.options.noAudio||Np[e].play()}getTileAt(e,i){for(let n of this.tiles.values())if(!(i&&!i.includes(n.props.name))&&n.contains(e))return n}getInputAt(e,i){for(let n of this.tiles.values()){let r=n.getClosestPort(e,i);if(r)return r}}*getTilesOfType(e){for(let i of this.tiles.values())i.is(e)&&(yield i)}enablePinchPan(){this.on("wheel",n=>{if(!this.options.noPinchPan)if(n.preventDefault(),n.ctrlKey){let r=this.zoom*(1-n.deltaY/100);this.setViewport(this.origin,r,ee(n,this.$svg))}else{let r=this.origin.shift(n.deltaX/this.zoom,n.deltaY/this.zoom);this.setViewport(r,this.zoom)}});let e=0,i=this.origin;this.on("gesturestart",n=>{this.options.noPinchPan||(n.preventDefault(),i=new c(n.pageX,n.pageY).subtract(this.origin),e=this.zoom,this.events.cancel())}),this.on("gesturechange",n=>{if(this.options.noPinchPan)return;n.preventDefault();let r=e*n.scale,o=new c(n.pageX,n.pageY).subtract(i);this.setViewport(o,r,ee(n,this.$svg))}),this.on("gestureend",n=>{this.options.noPinchPan||n.preventDefault()})}enableImageDrop(e,i){let n=d("div",{class:"image-drop"},this);this.imageUploadCallback=e,this.on("dragenter dragover dragleave drop",o=>o.preventDefault()),this.on("dragenter dragover",()=>n.show()),this.on("dragleave drop",()=>n.hide());let r=(o,a)=>O(this,null,function*(){let l=Array.from((o==null?void 0:o.files)||[]).slice(0,10).map((f,m)=>this.newImage(f,a.shift(m*25),e)),p=yield Promise.all(l);this.change({added:p}),this.trigger("paste")});this.on("drop",o=>r(o.dataTransfer,ee(o,this.$svg))),i==null||i.on("change",()=>O(this,null,function*(){yield r(i._el,this.canvasBounds.center),i.value=""}))}bindKeyboardEvents(e=A){this.selection.bindKeyboardEvents(e),e.onKey("Backspace Clear Delete",()=>this.selection.delete()),e.onKey("z",i=>{i.preventDefault(),this[i.shiftKey?"redo":"undo"]()},{meta:!0}),e.onKey("y",i=>{i.preventDefault(),this.redo()},{meta:!0}),e.onKey("c",()=>{if(this.options.noCopyPaste)return;let i=this.selection.copy();this.paste(i,new c(25,25))}),e.onKey("a",i=>{var n;(n=k("x-modal"))!=null&&n.getOpenModal()||(i.preventDefault(),this.selection.select(Array.from(this.tiles.values())))},{meta:!0}),e.on("cut copy",i=>{var r;if(!this.selection.tiles.size||this.options.noCopyPaste||w.formIsActive)return;let n=this.selection.copy();(r=window.navigator.clipboard)==null||r.writeText(JSON.stringify(n)),i.type==="cut"&&this.selection.delete()}),e.on("paste",i=>O(this,null,function*(){var o;if(this.options.noCopyPaste||w.formIsActive)return;let n=Cc(i.clipboardData);if(n&&this.imageUploadCallback){let a=yield this.newImage(n,this.center.shift(-50),this.imageUploadCallback);return this.trigger("paste"),this.change({added:[a]})}let r=yield(o=window.navigator.clipboard)==null?void 0:o.readText();if(!!r)try{let a=JSON.parse(r);if(!Object.keys(a).length)return;this.paste(a)}catch(a){let h=tt.create(this,{name:"text",html:r});h.setTransform(this.canvasBounds.center.subtract(h.center)),this.selection.add(h,!0),this.change({added:[h]}),this.trigger("paste"),this.selection.select([h])}})),e.onKey("Space",i=>{this.state.tool!=="pan"&&(i.preventDefault(),this.tools.pan.enable())}),e.onKey("Space",i=>{this.state.tool==="pan"&&(i.preventDefault(),this.tools.pan.disable())},{up:!0})}enableAccessibility(){let e,i=!1,n=r=>{this.focussedTile||(e=r,this.$svg.setAttr("aria-description",r?r.ariaDescription:"Empty Canvas"),r&&this.selection.add(r,!0))};this.$svg.on("focusin",()=>{if(!i)return;let r=Array.from(this.tiles.values());n(this.events.shiftKey?L(r):r[0])}),this.$svg.on("focusout",()=>e=void 0),A.on("keydown",r=>{if(i=!0,r.keyCode!==9||!e)return;let o=Array.from(this.tiles.values());n(o[o.indexOf(e)+(r.shiftKey?-1:1)]),e&&r.preventDefault()}),A.on("pointerdown",()=>i=!1),this.$svg.on("pointerdown",()=>{i=!1,this.$svg.focus()})}newImage(e,i,n){return O(this,null,function*(){let r=new FileReader;r.readAsDataURL(e),yield new Promise(a=>r.onloadend=a);let o=tt.create(this,{name:"image",href:(r.result||"").toString(),x:i.x,y:i.y});return this.selection.add(o,!0),yield n==null?void 0:n(e,o),o})}setViewport(e,i=1,n){if(i=G(i,1/Ua,Ua),n){let h=this.zoom/i;e=n.subtract(n.subtract(this.origin).scale(h))}let r=this.width/i,o=this.height/i;this.zoom=i,this.origin=e.clamp(Hg.resize(-r,-o)),this.canvasBounds=new ut(this.origin.x,this.origin.x+r,this.origin.y,this.origin.y+o),this.$svg.setAttr("viewBox",this.attr("viewBox")||Br(this.canvasBounds)),this.$html.setTransform(this.origin.inverse.scale(this.zoom),0,this.zoom);let a=this.canvasBounds.rect;this.options.grid!=="none"&&this.$grid.setRect(a),At.redrawLines(a),this.newTileShift=0,this.trigger("viewport")}resetViewport(){if(!this.tiles.size&&!this.strokes.size)return this.setViewport(I,1);let e=Jn(this.tiles,this.strokes,0),[i,n,r,o]=this.margins,a=(this.width-o-n)/e.dx,h=(this.height-i-r)/e.dy,l=G(Math.min(a,h),1/Ua,1),p=new c(this.width+o-n,this.height+i-r),f=e.center.subtract(p.scale(1/2/l));this.setViewport(f,l)}setZoom(e){let i=this.canvasBounds.center;this.setViewport(this.origin,this.zoom*e,i)}bindSource(e,i){let n=e.attr("tile");tt.thumbnail(this,n,e);let r,o=i==null?void 0:i.$(".tiles");this.events.listen(e,{down:()=>this.trigger("add-tile-start"),start:({posn:a})=>{r=tt.create(this,Object.assign({name:n},fe(e.attr("props"),{}))),r.setTransform(a.subtract(r.center)),this.selection.add(r,!0),this.selection.moveStart(!0),i&&i.setAttr("viewBox",Br(this.canvasBounds)),(o||r.$container).append(r.$el),this.trigger("add-tile",{tile:r})},move:a=>this.selection.move(a),end:()=>{r.$container.append(r.$el),this.selection.moveEnd(!0)},click:()=>{r=tt.create(this,Object.assign({name:n},fe(e.attr("props"),{}))),r.setTransform(this.center.subtract(r.center).shift(this.newTileShift*25)),this.selection.add(r,!0),r.moveEnd(),this.trigger("add-tile",{tile:r}),this.change({added:[r]}),this.newTileShift+=1}})}get center(){let[e,i,n,r]=this.margins;return this.canvasBounds.center.shift((r-i)/this.zoom/2,(e-n)/this.zoom/2)}setActiveTool(e,i){this.tools[this.state.tool].cancel(),this.warningBanner.hide(),this.selection.clear(),this.state.assign({tool:e,toolOptions:i}),i&&(this.tools[this.state.tool].options=i),this.setAttr("data-tool",e)}clear(e=!0){this.selection.clear();let i=[...Array.from(this.tiles.values()),...Array.from(this.strokes.values())];for(let n of i)n.delete();e&&this.setViewport(I,1),i.length&&this.change({deleted:i})}thumbnail(e,i,n="jpg"){return O(this,null,function*(){let r=this.canEditQuestions?Array.from(this.getTilesOfType("question-blank")):[];for(let h of r)h.hideForThumbnail();let o=Jn(this.tiles,this.strokes,50),a=yield this.$svg.image(n,e,i,Br(o));for(let h of r)h.hideForThumbnail(!0);return a})}paste(e,i){var h;let n=new Map,r=new Map,o=Object.entries(e).map(([l,p])=>{p.name==="geo"&&Object.assign(p,At.copy(r,p)),p.status=void 0;let f=tt.create(this,p);return f&&n.set(l,f.id),f}).filter(Boolean);for(let[l,p]of Object.entries(e)){let f=(h=p.cables)==null?void 0:h.map(m=>Ft(zt({},m),{toTileId:n.get(m.toTileId)}));this.tiles.get(n.get(l)).loadCables(f)}let a=Oe(...o.map(l=>l.transformed)).center;i===void 0&&(i=this.center.subtract(a).shift(this.newTileShift*25));for(let l of o)l.is("geo")?l.shift(i):l.setTransform(l.posn.add(i));this.newTileShift+=1,this.change({added:o}),this.trigger("paste"),this.selection.select(o)}downloadImage(e="png",i){var o;this.selection.clear();let n=i||((o=this.state.title)==null?void 0:o.replace(/\s+/g,"-").replace(/[^\w-]/g,"").toLowerCase())||"polypad",r=Jn(this.tiles,this.strokes,50);this.$svg.downloadImage(`${n}.${e}`,r.dx,r.dy,Br(r))}check(e){let i=!1;return new Promise(n=>{this.on("change",()=>{!i&&e(Array.from(this.tiles.values()))&&(i=!0,n())})})}change(e){if(this.setup||this.options.noUndoRedo)return;this.trigger("change",{action:"change",data:e});let i=new Map;for(let n of e.added||[])i.set(n.id,[void 0,n.serialize()]);for(let n of e.changed||[]){let r=Wc(n.lastSavedData,n.serialize());r&&i.set(n.id,r)}for(let n of e.deleted||[])i.set(n.id,[n.lastSavedData,void 0]);!i.size||(this.undoStack.push(i),this.undoStack.length>50&&this.undoStack.shift(),this.redoStack=[],this.state.canUndo=!0,this.state.canRedo=!1,this.state.changeCount+=1)}undo(){!this.undoStack.length||(this.applyChange(L(this.undoStack),!0),this.redoStack.push(this.undoStack.pop()),this.state.canUndo=!!this.undoStack.length,this.state.canRedo=!0,this.state.changeCount-=1,this.selection.update(),this.trigger("change",{action:"undo"}))}redo(){!this.redoStack.length||(this.applyChange(L(this.redoStack)),this.undoStack.push(this.redoStack.pop()),this.state.canUndo=!0,this.state.canRedo=!!this.redoStack.length,this.state.changeCount+=1,this.selection.update(),this.trigger("change",{action:"redo"}))}applyChange(e,i=!1){var n,r;for(let[o,[a,h]]of e.entries())if(i&&([a,h]=[h,a]),a)h?(r=this.tiles.get(o))==null||r.applyChange(h):(n=(Wp(a)?this.tiles:this.strokes).get(o))==null||n.delete();else if(Wp(h)){let l=tt.create(this,h,o);l.lastSavedData=h}else ce.create(this,h,o);for(let[o,[a,h]]of e.entries()){let l=i?a:h;l&&"cables"in l&&this.tiles.get(o).loadCables(l.cables)}}serialize(e=2e3,i=1e3,n=16e3){var r;return{title:(r=this.state.title)==null?void 0:r.slice(0,30),version:2,tiles:xa(this.tiles.values(),o=>o.props.copy(),e),strokes:xa(this.strokes.values(),o=>o.serialize(n),i),options:this.options.copy()}}load(e){var n,r;this.setup=!0,this.clear(!1),At.clearModel(),this.initial=e,this.state.assign({title:e.title,canUndo:!1,canRedo:!1,changeCount:0}),this.undoStack=this.redoStack=[];let i=this.attr("user-type")==="teacher";this.canEditQuestions=i&&((n=e.canEdit)!=null?n:!0),e.options||(e.options=qp()),e.options.grid||(e.options.grid="none"),e.options.algebraXSize||(e.options.algebraXSize=ip),e.options.algebraYSize||(e.options.algebraYSize=np),this.options.assign(e.options,!0),this.options.forceUpdate(),Up(this,((r=e.options)==null?void 0:r.tileWeights)||"");for(let[o,a]of Object.entries(e.tiles||{}))tt.create(this,a,o);for(let[o,a]of Object.entries(e.strokes||{}))ce.create(this,a,o);for(let[o,a]of Object.entries(e.tiles||{}))this.tiles.get(o).loadCables(a.cables);for(let o of this.tiles.values())o.move();this.snapping.updateIntersections(),this.resetViewport(),this.setActiveTool("move"),this.setup=!1}};qr=$([P("x-polypad",{template:Lp})],qr);var Kp=`<div class="factris-panel-left"><div class="keys-play"><button @click="app.reset()" title="Restart Game"><x-icon name="restart" size="36"></x-icon></button><button @click="app.toggle()" :title="playing ? 'Pause' : 'Play'"><span :show="playing"><x-icon name="pause" size="36"></x-icon></span><span :show="!playing"><x-icon name="play" size="36"></x-icon></span></button><button class="highscore-btn" @click="app.showHighscore()" title="Highscore"><x-icon name="trophy" size="36"></x-icon></button></div><div class="panel-item"><div class="text-large" :class="points &gt; 999999 ? 'narrow' : ''">\${numberFormat(points)}</div><div class="text-small">Points</div></div><div class="panel-item"><div class="text-large margin"><span :show="min(time)" data-display="inline">\${min(time)}m</span> \${time % 60}s</div><div class="text-small">Time</div></div><hr :show="highscore.length"><div class="highscore-panel" :show="highscore.length"><div class="highscore-title">Highscore</div><table><tr><td>\${highscore[0].name.slice(0, 4)}</td><td>\${numberFormat(highscore[0].score)}</td></tr><tr><td>\${highscore[1].name.slice(0, 4)}</td><td>\${numberFormat(highscore[1].score)}</td></tr><tr><td>\${highscore[2].name.slice(0, 4)}</td><td>\${numberFormat(highscore[2].score)}</td></tr><tr><td>\${highscore[3].name.slice(0, 4)}</td><td>\${numberFormat(highscore[3].score)}</td></tr><tr><td colspan="2"><a @click="app.showHighscore()">View more\u2026</a></td></tr></table></div><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V5A12,12,0,0,1,12,17h1V0Z"></path><path d="M0,0V1A12,12,0,0,1,12,13v4h1V0Z"></path></svg></div></div><div class="factris-panel-right"><div class="panel-item"><div class="text-small">Next blocks:</div><div class="text-large">\${next[0]}</div><div class="text-large">\${next[1]}</div><div class="text-large">\${next[2]}</div><div class="text-large">\${next[3]}</div><div class="text-large">\${next[4]}</div></div><hr><div class="text-small discharge-label">Discharge:</div><button class="discharge" :show="!discardCounter" data-display="inline-block" @click="app.discharge()" title="Discard Tile"><x-icon name="delete" size="36"></x-icon></button><svg class="discharge-count" :show="discardCounter" data-display="inline-block" width="74" height="74" viewBox="0 0 74 74"><circle cx="37" cy="37" r="32" style="strokeDashoffset:\${201*discardCounter/5}px"></circle><text class="large" x="37" y="38">\${discardCounter}</text><text class="small" x="37" y="51">needed</text></svg><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V17H1A12,12,0,0,1,13,5V0Z"></path><path d="M0,0V17H1V13A12,12,0,0,1,13,1V0Z"></path></svg></div></div><div class="factris-body"><svg class="factris-board" :show="(playing || lost) &amp;&amp; !showHighscore &amp;&amp; !initial" data-display="visibility"><defs><linearGradient id="shadow" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color: white; stop-opacity: 0.2"></stop><stop offset="100%" style="stop-color: white; stop-opacity: 0.05"></stop></linearGradient></defs><rect class="shadow" fill="url(#shadow)"></rect><g class="tiles"></g><g class="grid"><g class="faint-grid"></g></g><g class="scores"></g></svg><div class="logo" :class="initial &amp;&amp; !showHighscore ? 'show' : ''"><svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg"><g fill="#ffffff"><path d="m1.5039 59.1143v-57.9034h24.7227v7.8077h-16.4278v17.5659h14.313v7.8071h-14.313v24.7227z"/><path d="m23.7871 59.1143 12.9307-57.9034h6.9122l12.931 57.9034h-8.2954l-2.4394-12.4429h-11.3042l-2.44 12.4429zm20.4937-20.25-4.066-20.9815h-.1626l-4.0664 20.9815z"/><path d="m86.9766 42.6055v3.5781a12.9 12.9 0 0 1 -1.0166 5.083 14.0881 14.0881 0 0 1 -2.8057 4.27 13.5323 13.5323 0 0 1 -4.1885 2.9683 12.2636 12.2636 0 0 1 -5.164 1.0977 18.5964 18.5964 0 0 1 -4.7984-.65 11.3307 11.3307 0 0 1 -4.3911-2.2774 12.5723 12.5723 0 0 1 -3.2123-4.1889 14.814 14.814 0 0 1 -1.2608-6.5463v-31.8795a14.0993 14.0993 0 0 1 .976-5.2861 12.4357 12.4357 0 0 1 2.7648-4.229 12.863 12.863 0 0 1 4.27-2.8054 14.35 14.35 0 0 1 5.4892-1.0169 12.5807 12.5807 0 0 1 9.5151 3.8223 13.6266 13.6266 0 0 1 2.8057 4.4321 14.9842 14.9842 0 0 1 1.0166 5.5708v3.253h-8.2954v-2.7652a6.7153 6.7153 0 0 0 -1.3824-4.2285 4.4819 4.4819 0 0 0 -3.7412-1.789q-3.0915 0-4.1064 1.9111a10.23 10.23 0 0 0 -1.0166 4.8384v29.6025a7.6635 7.6635 0 0 0 1.0976 4.2285q1.098 1.7081 3.9444 1.708a6.0109 6.0109 0 0 0 1.7485-.2846 5.2115 5.2115 0 0 0 1.7485-.9351 4.953 4.953 0 0 0 1.22-1.79 7.2474 7.2474 0 0 0 .4878-2.8462v-2.8457z"/><path d="m99.1748 59.1143v-50.0957h-9.5967v-7.8077h27.4878v7.8077h-9.5959v50.0957z"/><path d="m120.7246 59.1143v-57.9034h13.3369q14.6385 0 14.6385 16.9971a21.4218 21.4218 0 0 1 -1.5859 8.7017 12.2983 12.2983 0 0 1 -5.5708 5.7739l8.9458 26.4307h-8.7832l-7.7256-24.7227h-4.9603v24.7227zm8.2954-50.0957v18.0537h4.7168a8.348 8.348 0 0 0 3.4971-.61 4.7555 4.7555 0 0 0 2.0332-1.7485 7.9534 7.9534 0 0 0 .8945-2.8057 26.9748 26.9748 0 0 0 .2437-3.8628 26.99 26.99 0 0 0 -.2437-3.8628 7.7387 7.7387 0 0 0 -.976-2.8872q-1.5467-2.2753-5.8556-2.2767z"/><path d="m155.6123 59.1143v-57.9034h8.2954v57.9034z"/><path d="m198.7954 17.8828h-8.2949v-1.8706a8.8535 8.8535 0 0 0 -1.3423-4.92 4.962 4.962 0 0 0 -4.5132-2.0737 5.2227 5.2227 0 0 0 -2.7651.65 5.4612 5.4612 0 0 0 -1.708 1.6265 6.8624 6.8624 0 0 0 -.8946 2.3989 15.6706 15.6706 0 0 0 -.2436 2.8057 27.5758 27.5758 0 0 0 .1216 2.8467 5.3954 5.3954 0 0 0 .61 2.0332 4.5014 4.5014 0 0 0 1.4229 1.5449 12.9606 12.9606 0 0 0 2.562 1.3013l6.3433 2.521a15.7628 15.7628 0 0 1 4.4726 2.48 10.7272 10.7272 0 0 1 2.6839 3.2943 15.4228 15.4228 0 0 1 1.22 4.4321 44.0689 44.0689 0 0 1 .3252 5.6524 29.8066 29.8066 0 0 1 -.7319 6.7905 14.3039 14.3039 0 0 1 -2.3584 5.3267 11.699 11.699 0 0 1 -4.4727 3.5781 15.7942 15.7942 0 0 1 -6.75 1.3013 14.7745 14.7745 0 0 1 -5.6113-1.0572 13.31 13.31 0 0 1 -4.4732-2.9277 14.2235 14.2235 0 0 1 -2.9682-4.3506 13.2116 13.2116 0 0 1 -1.0982-5.4082v-3.09h8.2955v2.6025a6.7761 6.7761 0 0 0 1.3418 4.1069q1.3418 1.83 4.5136 1.83a7.2794 7.2794 0 0 0 3.2935-.61 4.3859 4.3859 0 0 0 1.83-1.7486 6.4244 6.4244 0 0 0 .7729-2.7246q.1216-1.5856.1221-3.5376a35.0565 35.0565 0 0 0 -.1631-3.7407 6.4528 6.4528 0 0 0 -.65-2.3584 4.59 4.59 0 0 0 -1.5044-1.4639 19.57 19.57 0 0 0 -2.4805-1.22l-5.9365-2.44q-5.3679-2.1958-7.1972-5.8145a19.9948 19.9948 0 0 1 -1.83-9.0679 21.0112 21.0112 0 0 1 .8945-6.1806 14.0506 14.0506 0 0 1 2.6841-5.042 12.3042 12.3042 0 0 1 4.3506-3.375 14.5257 14.5257 0 0 1 6.3018-1.2609 13.7661 13.7661 0 0 1 5.6519 1.1387 14.5927 14.5927 0 0 1 4.4326 3.0088 12.5712 12.5712 0 0 1 3.7407 8.9458z"/></g></svg></div><x-icon class="play" :class="initial &amp;&amp; !showHighscore ? 'show' : ''" @click="app.play()" name="play" size="80"></x-icon><div class="overlay lost" :class="lost &amp;&amp; !showHighscore ? 'show' : ''">Game over!</div><div class="overlay paused" :class="playing || lost || initial || showHighscore ? '' : 'show'">Paused</div><div class="highscore" :show="showHighscore"><div class="text-large"><x-icon name="trophy" size="36"></x-icon> Highscore</div><table><tr><td>\${highscore[0].name}</td><td>\${numberFormat(highscore[0].score)}</td></tr><tr><td>\${highscore[1].name}</td><td>\${numberFormat(highscore[1].score)}</td></tr><tr><td>\${highscore[2].name}</td><td>\${numberFormat(highscore[2].score)}</td></tr><tr><td>\${highscore[3].name}</td><td>\${numberFormat(highscore[3].score)}</td></tr><tr><td>\${highscore[4].name}</td><td>\${numberFormat(highscore[4].score)}</td></tr><tr><td>\${highscore[5].name}</td><td>\${numberFormat(highscore[5].score)}</td></tr><tr><td>\${highscore[6].name}</td><td>\${numberFormat(highscore[6].score)}</td></tr><tr><td>\${highscore[7].name}</td><td>\${numberFormat(highscore[7].score)}</td></tr><tr><td>\${highscore[8].name}</td><td>\${numberFormat(highscore[8].score)}</td></tr><tr><td>\${highscore[9].name}</td><td>\${numberFormat(highscore[9].score)}</td></tr><tr><td>\${highscore[10].name}</td><td>\${numberFormat(highscore[10].score)}</td></tr></table></div></div><div class="factris-keys"><button class="key-left" :class="key === 'left' ? 'active' : ''" title="Left" @pointerdown="app.keyPress('left')"><x-icon name="left" size="36"></x-icon></button><div class="keys-center"><button class="key-up" :class="key === 'up' ? 'active' : ''" title="Resize" @pointerdown="app.keyPress('up')"><svg class="icon" width="54" height="36" viewBox="0 0 54 36" xmlns="http://www.w3.org/2000/svg"><path d="m41.1973 11 1.5975-1.635a.75.75 0 0 1 1.2751.5325v.495a6 6 0 0 1 5.2501 5.8575.75.75 0 0 1 -1.5 0 4.5 4.5 0 0 0 -3.75-4.3426v1.1475a.75.75 0 0 1 -1.2751.5326l-1.5975-1.56a.7676.7676 0 0 1 -.0001-1.0275z"/><path d="m12.8027 11-1.5975-1.635a.75.75 0 0 0 -1.2752.5324v.495a6 6 0 0 0 -5.25 5.8576.75.75 0 0 0 1.5 0 4.5 4.5 0 0 1 3.75-4.3426v1.1475a.75.75 0 0 0 1.2751.5326l1.5975-1.56a.7676.7676 0 0 0 .0001-1.0275z"/><rect height="11" rx="2" width="11" x="15" y="6"/><rect height="11" rx="2" width="11" x="28" y="6"/><rect height="11" rx="2" width="11" x="15" y="19"/><rect height="11" rx="2" width="11" x="28" y="19"/><path d="m50 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/><path d="m11 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/></svg>
</button><button class="key-down" :class="key === 'down' ? 'active' : ''" title="Down" @pointerdown="app.keyPress('down')"><x-icon name="down" size="36"></x-icon></button></div><button class="key-right" :class="key === 'right' ? 'active' : ''" title="Right" @pointerdown="app.keyPress('right')"><x-icon name="right" size="36"></x-icon></button></div><div class="factris-panel-top" :class="showHighscore ? 'hide' : ''"><div class="text-small">Block size:</div><div class="text-large">\${active[0] || '?' } = \${active[2]|| '?'} \xD7 \${active[1]|| '?'}</div><div class="corner left"><svg width="13" height="13"><path d="M12,0A12,12,0,0,1,0,12v1H13V0Z"></path></svg></div><div class="corner right"><svg width="13" height="13"><path d="M1,0A12,12,0,0,0,13,12v1H0V0Z"></path></svg></div></div>`;var jg=1e3,Y=G(+ko(location.search).size||16,8,24),Ug=5,Js=Math.ceil(Y/2),Fr=Y+Js,Hr=[];for(let t=2;t<=Y*1.5;t+=1){let s=ho(t);s&&t>.75*Y||t>Y&&mh(t)[0]>Y/2||(s&&t>Y/2||t>1.25*Y?Hr.push(t):Hr.push(t,t))}var _i=()=>Hr[Ot.integer(Hr.length)],Wg=fs(1,Y),Kg=Y*10,Xp=H(t=>Kg*2**t,Y),Wa=class{constructor(s,e,i){this.$el=d("rect",{width:20,height:20},i),this.setPosition(s,e)}setPosition(s,e){this.x=s,this.y=e,this.$el.setTransform({x:10+20*this.x,y:10+20*this.y})}go(s,e,i){this.setPosition(this.x+i-e,this.y+s)}canSet(s,e,i){return!i.find(n=>n.x===s&&n.y===e)}canGo(s,e,i,n){let r=this.x+i-e,o=this.y+s;return o>=Fr||r<0||r>=Y?!1:this.canSet(r,o,n)}canGoDown(s){return this.canGo(1,0,0,s)}goDown(s=1){if(s!==0)return this.go(s,0,0)}},zr=class extends S{constructor(){super(...arguments);this.interval=void 0;this.tiles=[];this.activeTiles=[];this.activeSize=[0,0,0];this.activeFactors=[];this.isDown=!1;this.keyLock=!1;this.requestQueue=Promise.resolve("");this.highscore=!0}ready(){this.$svg=this.$(".factris-board"),this.$tiles=this.$svg.$(".tiles"),this.$shadow=this.$svg.$(".shadow"),this.attr("highscore")==="no"&&(this.highscore=!1);let e=this.$svg.$(".scores");this.$scores=Xp.map((i,n)=>{let r=d("g",{},e);return d("text",{text:"+"+i,class:`s${n+1}`},r),r}),this.bindModel(Ht({time:0,points:0,playing:!1,lost:!1,initial:!0,key:void 0,discardCounter:0,next:[],active:[],highscore:[],showHighscore:!1,min:i=>Math.floor(i/60),numberFormat:It,app:this}));for(let i of this.$$("button, .play"))i.on("contextmenu",n=>n.preventDefault());A.onKey("AllArrows",(i,n)=>{!this.model.playing||(i.preventDefault(),this.isDown=!0,this.model.key=n,this.keyPress(n))}),A.onKey("AllArrows",()=>{!this.model.playing||(this.isDown=this.keyLock=!1,this.model.key=void 0)},{up:!0}),this.setupSVG(),this.updateHighscore()}setupSVG(){this.$svg.setAttr("viewBox",`0 0 ${(Y+1)*20} ${(Fr+1)*20}`);let e=this.$svg.$(".grid"),i=e.$(".faint-grid");for(let n=0;n<=Y;n+=1){let r=10+n*20,o=10+(Js+n)*20,a=!(n%4)||n===Y?e:i,h=!(n%2)||n===Y?"thick":"";d("line",{x1:10,y1:o,x2:10+Y*20,y2:o,class:h},a),d("line",{x1:r,y1:10+Js*20,x2:r,y2:Fr*20+10,class:h},a)}}drawShadow(){!this.activeTiles.length||(this.$shadow.setAttr("x",10+20*this.activeSize[0]),this.$shadow.setAttr("y",10+20*this.activeSize[1]),this.$shadow.setAttr("width",20*this.activeSize[2]),this.$shadow.setAttr("height",20*(Fr-this.activeSize[1])))}newRect(){let e=this.getNewTileSize();this.activeFactors=Wg.filter(r=>e%r===0);let i=this.activeFactors.pop(),n=Math.floor((Y-i)/2);this.activeTiles=H(r=>new Wa(n+r%i,Math.floor(r/i),this.$tiles),e),this.model.active=[e,i,e/i],this.activeSize=[n,e/i,i],this.drawShadow(),this.isDown&&(this.keyLock=!0)}reset(){this.pause(),this.model.time=0,this.model.points=0,this.model.discardCounter=0,this.model.showHighscore=!1,this.model.lost=!1,this.model.next=[_i(),_i(),_i(),_i()];for(let e of this.tiles)e.$el.remove();for(let e of this.activeTiles)e.$el.remove();this.tiles=[],this.newRect(),this.play(),this.requestQueue=Promise.resolve("")}toggle(){this.model.lost?this.reset():this.model.playing?this.pause():this.play()}pause(){this.model.playing=!1,clearInterval(this.interval)}play(){var e,i;if(this.model.showHighscore=!1,(e=window.ga)==null||e.call(window,"send","event","Factris","play"),(i=window.gtag)==null||i.call(window,"event","factris",{action:"play"}),this.model.initial||this.model.lost)return this.model.initial=!1,this.reset();this.model.playing=!0,this.interval=window.setInterval(()=>this.tick(),jg)}getNewTileSize(){let e=Y*Y-this.tiles.length;if(this.model.next[0]>e)return e>Y?e-Y:Y;this.model.discardCounter>0&&(this.model.discardCounter-=1);let i=this.model.next[0];return this.model.next=[...this.model.next.slice(1),_i()],i}tick(){if(this.model.time+=1,this.activeTiles.every(o=>o.canGoDown(this.tiles))){for(let o of this.activeTiles)o.goDown();this.activeSize[1]+=1,this.drawShadow();return}this.tiles.push(...this.activeTiles);for(let o of this.activeTiles)o.$el.addClass("fixed");if(this.tiles.some(o=>o.y<Js))return this.gameOver();this.activeTiles=[];let i=this.getFullRows();if(!i.length)return this.newRect();this.model.points+=D(Xp.slice(0,i.length)),i.length>=6&&ci(10,150*i.length/Y),this.removeRows(i);let n=this.model.points,r=(n+Y)%13+(n-Y)%87;this.requestQueue=this.requestQueue.then(o=>Ae("/factris-verify",{token:o,size:Y,score:n,check:r})),this.trigger("score",{points:n})}getFullRows(){return H(e=>this.tiles.filter(i=>i.y===e+Js),Y).filter(e=>e.length===Y)}removeRows(e){let i=Qt(e);this.tiles=this.tiles.filter(o=>!i.includes(o)),this.$tiles.addClass("animated"),w.redraw();for(let o of i)o.$el.addClass("removing");let n=e.map(o=>o[0].y);for(let o of this.tiles)o.goDown(n.filter(a=>a>o.y).length);let r=400/e.length;for(let[o,a]of n.reverse().entries())this.$scores[o].setTransform({x:10+Js*20,y:27+a*20}),oe(()=>this.$scores[o].addClass("visible"),o*r);return setTimeout(()=>{for(let o of this.$scores)o.removeClass("visible")},600),setTimeout(()=>{for(let o of i)o.$el.remove();this.$tiles.removeClass("animated"),this.newRect()},1e3),!1}gameOver(){this.model.lost=!0;for(let e of this.activeTiles)e.$el.addClass("error");this.pause(),this.requestQueue.then(e=>{e&&this.trigger("game-over",{token:e,points:this.model.points})})}discharge(){if(!!this.model.playing){for(let e of this.activeTiles)e.$el.remove();this.newRect(),this.model.discardCounter=Ug}}keyPress(e,i=!0){if(!!this.model.playing&&!this.keyLock){if(e==="up"){if(!this.activeFactors.length)return;let n=this.activeFactors.pop(),r=this.activeSize[0]+Math.floor((this.activeSize[2]-n)/2),o=this.activeSize[1];if(this.activeTiles.some((l,p)=>!l.canSet(r+p%n,o-1-Math.floor(p/n),this.tiles)))return;for(let[l,p]of this.activeTiles.entries())p.setPosition(r+l%n,o-1-Math.floor(l/n));let h=this.model.active[0];this.model.active=[h,n,h/n],this.activeSize=[r,o,n]}else{let n=e==="down"?1:0,r=e==="left"?1:0,o=e==="right"?1:0;if(this.activeTiles.every(a=>a.canGo(n,r,o,this.tiles))){for(let a of this.activeTiles)a.go(n,r,o);this.activeSize[0]+=o-r,this.activeSize[1]+=n}i&&e==="down"&&setTimeout(()=>this.keyPress("down",!1),100)}this.drawShadow()}}showHighscore(){!this.highscore||(this.pause(),this.model.showHighscore=!0)}updateHighscore(){return O(this,null,function*(){if(!this.highscore)return;let e=yield fetch(`/factris-highscore?size=${Y}`);this.model.highscore=yield e.json()})}};zr=$([P("x-factris",{template:Kp})],zr);var jr=class extends S{ready(){let s=Array.from(this._el.children);this.removeChildren();let e=d("svg",{class:"equation"},this),i=d("g",{transform:"translate(2 0)"},e),n=d("div",{class:"overlay"},this),r=parseFloat(this.css("font-size")),o=this.parents(".text-center").length||this.hasClass("display"),a=new Ls(i,n,0,"",r,!!o);a.setValue(this.attr("expr")||s),this.css({width:a.root.width+4+"px",height:a.root.height+"px","vertical-align":`-${a.root.height-a.root.baseline}px`})}};jr=$([P("x-math")],jr);window.$=k;window.$$=ve;window.Browser=w;var Ur=k("x-modal#privacy");Ur&&Ur.$("form").on("submit",t=>{t.preventDefault();let s=Ur.$('input[name="newsletter"]');Ae("/settings/privacy",{policies:"on",newsletter:s.checked?"on":"off"}),Ur.close()});var Yp="";function Xa(){return fetch("/joke").then(t=>t.text()).then(t=>Yp=t),Yp}var Ka=k(".error-box");Ka&&Ka.on("click",()=>Ka.html=Xa());Xa();window.tellMeAJoke=function(){return Xa().replace(/<p>/g,"").replace(/<\/p>/g,`
`).trim()};console.log(`%cWelcome to Mathigon!
%cYou can see our source code at https://github.com/mathigon
%cIf you want to contribute, visit https://mathigon.io
%cJust here for fun? Run tellMeAJoke()`,"color: #cd0e66; font-weight: bold; font-size: 18px;","color: #0f82f2; font-weight: bold;","color: #22ab24; font-weight: bold;","color: #fd8c00; font-weight: bold;");var Zp=[38,38,40,40,37,39,37,39,66,65],Ni=0;document.addEventListener("keydown",t=>{t.keyCode===Zp[Ni]?(Ni+=1,Ni===Zp.length&&(ci(),Ni=0)):Ni=0});})();
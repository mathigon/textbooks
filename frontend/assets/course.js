/* (c) Mathigon, generated by Mathigon Studio */
(()=>{var Oc=Object.defineProperty;var ig=Object.prototype.hasOwnProperty;var sg=Object.getOwnPropertyDescriptor,Lc=Object.getOwnPropertySymbols,ng=Object.prototype.propertyIsEnumerable;var Rc=(i,t,e)=>t in i?Oc(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,j=(i,t)=>{for(var e in t||(t={}))ig.call(t,e)&&Rc(i,e,t[e]);if(Lc)for(var e of Lc(t))ng.call(t,e)&&Rc(i,e,t[e]);return i};var N=(i,t,e,s)=>{for(var n=s>1?void 0:s?sg(t,e):t,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(t,e,n):r(n))||n);return s&&n&&Oc(t,e,n),n};var R=(i,t,e)=>new Promise((s,n)=>{var o=l=>{try{a(e.next(l))}catch(c){n(c)}},r=l=>{try{a(e.throw(l))}catch(c){n(c)}},a=l=>l.done?s(l.value):Promise.resolve(l.value).then(o,r);a((e=e.apply(i,t)).next())});function ci(i=10){return Math.random().toString(36).substr(2,i)}function Y(i,...t){return t.includes(i)}var og=(i,t)=>i.concat(t);function Ar(i,t,e=og){for(let s of Object.keys(t))s in i&&Array.isArray(i[s])&&Array.isArray(t[s])?i[s]=e(i[s],t[s]):s in i&&i[s]instanceof Object&&t[s]instanceof Object?Ar(i[s],t[s]):i[s]=t[s]}function xe(i,t=0){return t?+setTimeout(i,t):(i(),0)}function Xe(i){return new Promise(t=>setTimeout(t,i))}function di(){let i=()=>{},t=()=>{},e=new Promise((s,n)=>{i=s,t=n});return e.catch(s=>s),{promise:e,resolve:i,reject:t}}var Ic=class extends Error{constructor(i){super("[Cache Error]");this.data=i}};function le(i){let t=new Map;return function(...e){let s=e.join("--");if(!t.has(s))try{t.set(s,i(...e))}catch(o){t.set(s,new Ic(o))}let n=t.get(s);if(n instanceof Ic)throw n.data;return n}}function Le(i,t=0,e=!1){let s=!1,n=!1;return(...o)=>{s?n=!0:(e?n=!0:i(...o),s=!0,setTimeout(()=>{n&&i(...o),s=n=!1},t))}}function rg(i){return function(t,e){if(!t||Array.isArray(this)||i.includes(t))return e}}function ki(i,t,e){if(!i)return t;try{return JSON.parse(i,e?rg(e):void 0)||t}catch(s){return t}}function Ht(i,t){return new Array(t).fill(i)}function kr(i,t,e){let s=[];for(let n=0;n<t;++n)s.push(Ht(i,e));return s}function B(i,t){let e=[];for(let s=0;s<t;++s)e.push(i(s));return e}function jn(i,t,e){let s=[];for(let n=0;n<t;++n){let o=[];for(let r=0;r<e;++r)o.push(i(n,r));s.push(o)}return s}function pi(i,t,e=1){let s=[];if(t===void 0&&i>=0)for(let n=0;n<i;n+=e)s.push(n);else if(t===void 0)for(let n=0;n>i;n-=e)s.push(n);else if(i<=t)for(let n=i;n<=t;n+=e)s.push(n);else for(let n=i;n>=t;n-=e)s.push(n);return s}function _(i,t=0){return i[i.length-1-t]}function q(i){return i.reduce((t,e)=>t+e,0)}function Vi(i,t,e=!1){return i.slice(0).sort((s,n)=>{let o=t(s),r=t(n);return o<r?e?1:-1:o>r?e?-1:1:0})}function Oi(i){let t=0;return()=>i[t++%i.length]}function Dt(i){return i.filter((t,e)=>i.indexOf(t)===e)}function qt(i){return i.reduce((t,e)=>t.concat(Array.isArray(e)?qt(e):e),[])}function ui(i){let t=0;return i.map(e=>t+=e)}function ls(i,t){let e=[];for(let s=0;s<i.length;s+=t)e.push(i.slice(s,s+t));return e}function Ys(i,t=1){let e=i.length;t=(t%e+e)%e;let s=i.slice(0,t);return i.slice(t).concat(s)}function Nc(...i){return i.reduce((t,e)=>t.concat(e),[])}var Gc=class{constructor(i){let t=i.length,e=i.map(s=>({val:s}));for(let[s,n]of e.entries())n.next=e[(s+1)%t],n.prev=e[(s-1+t)%t];this.root=e[0]}*traverse(){let i=this.root;for(;i;)if(yield i,i=i.next,i===this.root)return}get array(){return Array.from(this.traverse())}delete(i){if(i===this.root){if(i.next===i)return this.root=void 0;this.root=i.next}i.prev.next=i.next,i.next.prev=i.prev}};function lt(i,t=/\s+/){return i?i.trim().split(t):[]}function Un(i){return i.toLowerCase().replace(/^-/,"").replace(/-(.)/g,(t,e)=>e.toUpperCase())}function ag(i,t,e=!1){let s=kr(0,i.length+1,t.length+1);for(let n=0;n<=i.length;n++)s[n][0]=n;for(let n=0;n<=t.length;n++)s[0][n]=n;for(let n=1;n<=i.length;n++)for(let o=1;o<=t.length;o++)s[n][o]=Math.min(s[n-1][o-1]+(i.charAt(n-1)===t.charAt(o-1)?0:1),s[n-1][o]+1,s[n][o-1]+1);return e?Math.min(...s[i.length]):s[i.length][t.length]}function Dc(i,t){let e=i.length/2,s=t.map(o=>({w:o,d:ag(i,o)})).filter(({d:o})=>o<e),n=Vi(s,o=>o.d)[0];return n?n.w:void 0}var Ye=class{constructor(){this.events=new Map}on(i,t){for(let e of lt(i))this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}one(i,t){let e=s=>{this.off(i,e),t(s)};this.on(i,e)}off(i,t){for(let e of lt(i))this.events.has(e)&&this.events.set(e,this.events.get(e).filter(s=>s!==t))}trigger(i,t){for(let e of lt(i))if(this.events.has(e))for(let s of this.events.get(e))s(t)}},lg=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,hg=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i,cg=/rgba?\(([0-9.]+), ?([0-9.]+), ?([0-9.]+)(, ?([0-9.]+))?\)/,dg=["#22ab24","#009ea6","#0f82f2","#6d3bbf","#cd0e66","#eb4726","#fd8c00"];function _c(i){return i.length===1?`0${i}`:i}function Hc(i,t){if(t<=0)return F.from(i[0]);if(t>=1)return F.from(_(i));let e=Math.floor(t*(i.length-1)),s=t*(i.length-1)-e;return F.mix(i[e+1],i[e],s)}function Vr(i,t,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?i+(t-i)*6*e:e<1/2?t:e<2/3?i+(t-i)*(2/3-e)*6:i}var F=class{constructor(i,t,e,s=1){this.r=i,this.g=t,this.b=e,this.a=s}get hex(){let i=[this.r,this.g,this.b].map(e=>_c(Math.round(e).toString(16))),t=this.a>=1?"":_c(Math.round(this.a*255).toString(16));return`#${i.join("")}${t}`}get rgb(){return`rgba(${[this.r,this.g,this.b].map(t=>Math.round(t)).join(",")},${this.a})`}get brightness(){return(this.r*299+this.g*587+this.g*114)/1e3}get hsl(){let i=this.r/255,t=this.g/255,e=this.b/255,s=Math.max(i,t,e),n=Math.min(i,t,e),o=(n+s)/2,r=s-n;if(s===n)return[0,0,Math.round(o*100)];let a=i===s?(t-e)/r:t===s?2+(e-i)/r:4+(i-t)/r;a=Math.min(a*60,360),a<0&&(a+=360);let l=o<=.5?r/(s+n):r/(2-s-n);return[Math.round(a),Math.round(l*100),Math.round(o*100)]}get chroma(){return Math.max(this.r,this.g,this.b)-Math.min(this.r,this.g,this.b)}toString(){return this.rgb}copy(){return new F(this.r,this.g,this.b,this.a)}static from(i){return typeof i!="string"?i:i.startsWith("#")?F.fromHex(i):F.fromRgb(i)}static fromRgb(i){let t=i.match(cg);if(!t)return new F(0,0,0);let e=t[4]?+t[5]||0:1;return new F(+t[1],+t[2],+t[3],e)}static fromHex(i){i=i.replace(lg,(e,s,n,o)=>s+s+n+n+o+o);let t=hg.exec(i);return t?new F(parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),t[4]?parseInt(t[4],16)/255:1):new F(0,0,0)}static fromHsl(i,t,e){if(i/=360,t/=100,e/=100,t===0){let l=Math.round(e*255);return new F(l,l,l)}let s=e<.5?e*(1+t):e+t-e*t,n=2*e-s,o=Vr(n,s,i+1/3),r=Vr(n,s,i),a=Vr(n,s,i-1/3);return new F(Math.round(o*255),Math.round(r*255),Math.round(a*255))}static rainbow(i){return B(t=>Hc(dg,t/(i-1)),i)}static gradient(i,t){return B(e=>Hc(i,e/(t-1)),t)}static shades(i,t,e=.5){let s=F.mix("#fff",i,e),n=F.mix("#000",i,e);return F.gradient([s,i,n],t)}static mix(i,t,e=.5){return i=F.from(i),t=F.from(t),new F(e*i.r+(1-e)*t.r,e*i.g+(1-e)*t.g,e*i.b+(1-e)*t.b,e*i.a+(1-e)*t.a)}static mixMany(i,t){t||(t=i.map(()=>1));let e=q(t),s=i.map(v=>v.hsl),n=s.map(v=>v[0]),o=n.map(v=>v<180?v+360:v),r=t.map((v,y)=>v*Math.sqrt(i[y].chroma)),a=q(r),l=q(n.map((v,y)=>v*r[y]))/a,c=q(o.map((v,y)=>v*r[y]))/a,p=q(n.map((v,y)=>Math.abs(v-l)*r[y])),u=q(o.map((v,y)=>Math.abs(v-c)*r[y])),f=p<=u?l:c%360,g=q(s.map((v,y)=>t[y]*v[1]))/e,w=q(s.map((v,y)=>t[y]*v[2]))/e;return F.fromHsl(f,g,w)}};function Zn(i){return i[Symbol.iterator]().next().value}function Wn(i,t){for(let e of i)if(!t(e))return!1;return!0}function Pe(i,t){for(let e of i)if(t(e))return!0;return!1}function*hs(i,t){for(let e of i)for(let s of t(e))yield s}function*cs(i,t){for(let e of i)for(let s of t)yield[e,s]}function*Or(i){let t=i.length;for(let e=0;e<t;++e)for(let s=e+1;s<t;++s)yield[i[e],i[s]]}function Qe(i,t,e=Infinity,s){let n,o=e;for(let r of i){let a=t(r);if(a<o&&(n=r,o=a,s!==void 0&&o<s))return n}return n}var Kn=class{constructor(...i){this.values=i}map(i){let t=this.values;return new Kn(function*(){let e=0;for(let s of t)for(let n of s)yield i(n,e),e+=1}())}every(i){let t=0;for(let e of this.values)for(let s of e){if(!i(s,t))return!1;t+=1}return!0}some(i){let t=0;for(let e of this.values)for(let s of e){if(i(s,t))return!0;t+=1}return!1}slice(i,t){let e=this.values;return new Kn(function*(){let s=0;for(let n of e)for(let o of n)s<i||t!==void 0&&s>i+t||(yield o,s+=1)}())}filter(i){let t=this.values;return new Kn(function*(){let e=0;for(let s of t)for(let n of s)i(n,e)&&(yield n),e+=1}())}concat(i){this.values.push(i)}[Symbol.iterator](){let i=this.values;return function*(){for(let t of i)for(let e of t)yield e}()}static make(i,t){return new Kn(function*(){let e=0;for(;t===void 0||e<t;)yield i(e),e+=1}())}};var pg=Object.defineProperty,Lr=(i,t)=>{for(var e in t)pg(i,e,{get:t[e],enumerable:!0})},Rr=1e-6;function P(i,t,e=Rr){return isNaN(i)||isNaN(t)?!1:Math.abs(i-t)<e}function Je(i,t=Rr){return P(i%1,0,t)}function it(i,t,e,s=Rr){return t>e&&([t,e]=[e,t]),i>t+s&&i<e-s}var qc=/(\d+)(\d{3})/,ug=["","k","m","b","t","q"];function fg(i){let[t,e]=i.split(".");for(;qc.test(t);)t=t.replace(qc,"$1,$2");return t+(e?`.${e}`:"")}function mg(i,t=6){if(!t)return`${i}`;let e=`${Math.abs(Math.floor(i))}`.length,s=i<0?1:0;if(e<=t-s)return`${Kt(i,t-e-s-1)}`;let n=Math.floor(Math.log10(Math.abs(i))/3);return Kt(i/Math.pow(10,3*n),t-(e%3||3)-s-1)+ug[n]}function nt(i,t=0,e=!0){let s=mg(i,t).replace("-","\u2013");return e?fg(s):s}var gg=/^-?0,[0-9]+$/,vg=/^-?([0-9]+(,[0-9]{3})*)?\.?[0-9]*$/,wg=/^-?[0-9]+(\.[0-9]{3})*,?[0-9]*$/;function Qs(i){return i=i.replace(/^–/,"-").trim(),!i||i.match(/[^0-9.,-]/)?NaN:gg.test(i)?parseFloat(i.replace(/,/,".")):vg.test(i)?parseFloat(i.replace(/,/g,"")):wg.test(i)?parseFloat(i.replace(/\./g,"").replace(/,/,".")):NaN}var Ir=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],Bc=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],yg=[""," thousand"," million"," billion"," trillion"," quadrillion"," quintillion"," sextillion"];function bg(i){let[t,e,s]=i.split(""),n=t==="0"?"":` ${Ir[+t]} hundred`;return e+s==="00"?n:+e<2?`${n} ${Ir[+(e+s)]}`:s==="0"?`${n} ${Bc[+e]}`:`${n} ${Bc[+e]}-${Ir[+s]}`}function ds(i){if(i===0)return"zero";let t=Math.round(Math.abs(i)).toString(),e=Math.ceil(t.length/3),s=t.padStart(3*e,"0"),n="";for(let o=0;o<e;o+=1){let r=s.substr(o*3,3);r!=="000"&&(n+=bg(r)+yg[e-1-o])}return n.trim()}function Kt(i,t=0){let e=Math.pow(10,t);return Math.round(i*e)/e}function ht(i,t=1){return Math.round(i/t)*t}function S(i,t=-Infinity,e=Infinity){return Math.min(e,Math.max(t,i))}function bt(i,t,e=.5){return i+(t-i)*e}function ce(i){return i*i}function Rt(i,t){return(i%t+t)%t}function Nr(i,t,e){if(P(i,0)&&P(t,0))return[];if(P(i,0))return[-e/t];let s=-t/2/i,n=Math.sqrt(t*t-4*i*e)/2/i;return[s+n,s-n]}function Fc(i,t=0){let e=i.slice(0),s=zc(e);return t?s.filter(n=>n.length===t):s}function zc(i){if(i.length===1)return[[],i];let t=i.pop(),e=zc(i),s=[];for(let n of e)s.push(n,[...n,t]);return s}var Xn=(i,t)=>{let e=i<0?"\u2013":"";return Math.abs(i)===1&&t?e+t:e+Math.abs(i)+(t||"")},Tt=class{constructor(i=0,t=0){this.re=i,this.im=t}get modulus(){return Math.sqrt(this.re*this.re+this.im*this.im)}get argument(){return Math.atan2(this.im,this.re)}get conjugate(){return new Tt(this.re,-this.im)}root(i,t=0){let e=Math.pow(this.modulus,1/i),s=(this.argument+t*2*Math.PI)/i;return new Tt(e*Math.cos(s),e*Math.sin(s))}toString(i=2){let t=Kt(this.re,i),e=Kt(this.im,i);return e===0?Xn(t):t===0?Xn(e,"i"):[Xn(t),e<0?"\u2013":"+",Xn(Math.abs(e),"i")].join(" ")}add(i){return Tt.sum(this,i)}subtract(i){return Tt.difference(this,i)}multiply(i){return Tt.product(this,i)}divide(i){return Tt.quotient(this,i)}static sum(i,t){return typeof i=="number"&&(i=new Tt(i,0)),typeof t=="number"&&(t=new Tt(t,0)),new Tt(i.re+t.re,i.im+t.im)}static difference(i,t){return typeof i=="number"&&(i=new Tt(i,0)),typeof t=="number"&&(t=new Tt(t,0)),new Tt(i.re-t.re,i.im-t.im)}static product(i,t){typeof i=="number"&&(i=new Tt(i,0)),typeof t=="number"&&(t=new Tt(t,0));let e=i.re*t.re-i.im*t.im,s=i.im*t.re+i.re*t.im;return new Tt(e,s)}static quotient(i,t){if(typeof i=="number"&&(i=new Tt(i,0)),typeof t=="number"&&(t=new Tt(t,0)),Math.abs(t.re)<Number.EPSILON||Math.abs(t.im)<Number.EPSILON)return new Tt(Infinity,Infinity);let e=t.re*t.re+t.im*t.im,s=(i.re*t.re+i.im*t.im)/e,n=(i.im*t.re-i.re*t.im)/e;return new Tt(s,n)}static exp(i){typeof i=="number"&&(i=new Tt(i,0));let t=Math.exp(i.re);return new Tt(t*Math.cos(i.im),t*Math.sin(i.im))}};function fi(...i){let[t,...e]=i;if(e.length>1)return fi(t,fi(...e));let s=Math.abs(t),n=Math.abs(e[0]);for(;n;)[s,n]=[n,s%n];return s}function Li(...i){let[t,...e]=i;return e.length>1?Li(t,Li(...e)):Math.abs(t*e[0])/fi(t,e[0])}function Js(i){if(i%1!=0||i<2)return!1;if(i%2==0)return i===2;if(i%3==0)return i===3;let t=Math.sqrt(i);for(let e=5;e<=t;e+=6)if(i%e==0||i%(e+2)==0)return!1;return!0}function Re(i){if(i===1)return[];if(Js(i))return[i];let t=Math.sqrt(i);for(let e=2;e<=t;++e)if(i%e==0)return Re(e).concat(Re(i/e));return[]}function jc(i){return Dt(Re(i))}var $g=/^([0-9\-.]*)([%πkmbtq]?)(\/([0-9\-.]+))?([%π]?)$/,U=class{constructor(i,t,e){this.unit=e,this.num=t!==void 0&&t<0?-i:i,t!==void 0&&Math.abs(t)!==1&&i!==0&&(this.den=Math.abs(t))}valueOf(){return this.value}toString(i=4){let t=nt(this.num,i),e=this.unit||"",s=this.den?`/${nt(this.den,i)}`:"";return t==="0"&&(e=""),e==="\u03C0"&&!this.den&&(t==="1"||t==="\u20131")&&(t=t.replace("1","")),`${t}${s}${e}`}toMathML(){let i=`<mn>${this.num}</mn>`;return this.den!==void 0&&(i=`<mfrac>${i}<mn>${this.den}</mn></mfrac>`),this.unit&&(i+=this.unit==="\u03C0"?"<mi>\u03C0</mi>":"<mo>%</mo>"),i}get value(){let i=this.unit==="%"?1/100:this.unit==="\u03C0"?Math.PI:1;return this.num*i/(this.den||1)}get sign(){return Math.sign(this.num)}get simplified(){if(!this.den)return this;let i=fi(Math.abs(this.num),this.den);return new U(this.num/i,this.den/i,this.unit)}get inverse(){return this.den?new U(1/this.num,void 0,this.unit):new U(this.den,this.num)}get negative(){return new U(-this.num,this.den,this.unit)}static fromString(i){i=i.toLowerCase().replace(/[\s,]/g,"").replace("\u2013","-").replace("pi","\u03C0");let t=i.match($g);if(!t)return;let e=t[2]||t[5]||void 0,s=t[1]?+t[1]:void 0,n=t[4]?+t[4]:void 0;if(e==="\u03C0"&&(!t[1]||t[1]==="-")&&(s=t[1]?-1:1),s===void 0||isNaN(s))return;let o=e?"kmbtq".indexOf(e):-1;if(o>=0&&(s*=1e3**(o+1),e=void 0),n===void 0)return new U(s,void 0,e);if(!(isNaN(n)||P(n,0)))return!Je(s)||!Je(n)?new U(s/n,void 0,e):new U(s,n,e)}static fractionFromDecimal(i,t=100){let e=Math.sign(i),s=Math.floor(Math.abs(i));i=Math.abs(i)-s;let n=0,o=1,r=1,a=1;for(;o<=t&&a<=t;){let l=(n+r)/(o+a);if(i===l)return o+a<=t?new U(e*(s*(o+a)+n+r),o+a):a>o?new U(e*(s*a+r),a):new U(e*(s*o+n),o);i>l?[n,o]=[n+r,o+a]:[r,a]=[n+r,o+a]}return o>t?new U(e*(s*a+r),a):new U(e*(s*o+n),o)}clamp(i,t){let e=this.value;return i!==void 0&&e<i?new U(i):t!==void 0&&e>t?new U(t):this}add(i){return U.sum(this,i)}subtract(i){return U.difference(this,i)}multiply(i){return U.product(this,i)}divide(i){return U.quotient(this,i)}static sum(i,t){return typeof t=="number"&&(t=new U(t)),i.num===0?t:i.unit!==t.unit?new U(i.value+t.value):!i.den&&!t.den?new U(i.num+t.num,void 0,i.unit):(i.den||([i,t]=[t,i]),Je(t.num)?new U(i.num*(t.den||1)+t.num*i.den,i.den*(t.den||1),i.unit).simplified:new U(i.value+t.value,void 0,i.unit))}static difference(i,t){return typeof t=="number"&&(t=new U(t)),U.sum(i,t.negative)}static product(i,t){if(typeof t=="number"&&(t=new U(t)),!i.unit&&!i.den&&Je(i.num))return new U(i.num*t.num,t.den,t.unit).simplified;if(!t.unit&&!t.den&&Je(t.num))return new U(i.num*t.num,i.den,i.unit).simplified;if(i.unit==="\u03C0"||t.unit==="\u03C0"||!Je(i.num)||!Je(t.num))return new U(i.value*t.value);let e=(i.unit==="%"?100:1)*(t.unit==="%"?100:1);return new U(i.num*t.num,(i.den||1)*(t.den||1)*e)}static quotient(i,t){return typeof t=="number"&&(t=new U(t)),U.product(i,t.inverse)}},Et={};Lr(Et,{determinant:()=>Cg,fill:()=>Uc,identity:()=>Zc,inverse:()=>Xc,product:()=>Yn,reflection:()=>Sg,rotation:()=>xg,scalarProduct:()=>Tg,shear:()=>Pg,sum:()=>Wc,transpose:()=>Kc});function Uc(i,t,e){return kr(i,t,e)}function Zc(i=2){let t=Uc(0,i,i);for(let e=0;e<i;++e)t[e][e]=1;return t}function xg(i){let t=Math.sin(i),e=Math.cos(i);return[[e,-t],[t,e]]}function Pg(i){return[[1,i],[0,1]]}function Sg(i){let t=Math.sin(2*i),e=Math.cos(2*i);return[[e,t],[t,-e]]}function Wc(...i){let[t,...e]=i,s=e.length>1?Wc(...e):e[0];if(t.length!==s.length||t[0].length!==s[0].length)throw new Error("Matrix sizes don\u2019t match");let n=[];for(let o=0;o<t.length;++o){let r=[];for(let a=0;a<t[o].length;++a)r.push(t[o][a]+s[o][a]);n.push(r)}return n}function Tg(i,t){return i.map(e=>e.map(s=>s*t))}function Yn(...i){let[t,...e]=i,s=e.length>1?Yn(...e):e[0];if(t[0].length!==s.length)throw new Error("Matrix sizes don\u2019t match.");let n=[];for(let o=0;o<t.length;++o){let r=[];for(let a=0;a<s[0].length;++a){let l=0;for(let c=0;c<s.length;++c)l+=t[o][c]*s[c][a];r.push(l)}n.push(r)}return n}function Kc(i){let t=[];for(let e=0;e<i[0].length;++e){let s=[];for(let n=0;n<i.length;++n)s.push(i[n][e]);t.push(s)}return t}function Cg(i){if(i.length!==i[0].length)throw new Error("Not a square matrix.");let t=i.length;if(t===1)return i[0][0];if(t===2)return i[0][0]*i[1][1]-i[0][1]*i[1][0];let e=0;for(let s=0;s<t;++s){let n=i[0][s],o=i[0][s];for(let r=1;r<t;++r)o*=i[r][(s+r)%t],n*=i[r][(s-r+t)%t];e+=o-n}return e}function Xc(i){let t=i.length;if(t!==i[0].length)throw new Error("Not a square matrix.");let e=Zc(t),s=jn((n,o)=>i[n][o],t,t);for(let n=0;n<t;++n){let o=s[n][n];if(P(o,0)){for(let r=n+1;r<t;++r)if(s[r][n]!==0){for(let a=0;a<t;++a)[s[r][a],s[n][a]]=[s[n][a],s[r][a]],[e[r][a],e[n][a]]=[e[n][a],e[r][a]];break}if(o=s[n][n],P(o,0))throw new Error("Matrix not invertible.")}for(let r=0;r<t;++r)s[n][r]=s[n][r]/o,e[n][r]=e[n][r]/o;for(let r=0;r<t;++r){if(r===n)continue;let a=s[r][n];for(let l=0;l<t;++l)s[r][l]-=a*s[n][l],e[r][l]-=a*e[n][l]}}return e}var tt={};Lr(tt,{bernoulli:()=>Qc,binomial:()=>Vg,cauchy:()=>Gg,chiCDF:()=>_g,exponential:()=>Ig,find:()=>Ag,geometric:()=>Ng,integer:()=>Eg,integrate:()=>Jc,normal:()=>Rg,normalPDF:()=>Dg,poisson:()=>Og,shuffle:()=>Mg,smart:()=>kg,uniform:()=>Lg,weighted:()=>Yc});function Mg(i){i=i.slice(0);for(let t=i.length-1;t>0;--t){let e=Math.floor(Math.random()*(t+1));[i[t],i[e]]=[i[e],i[t]]}return i}function Eg(i,t){let e=t===void 0?0:i,s=t===void 0?i:t-i+1;return e+Math.floor(s*Math.random())}function Yc(i){let t=Math.random()*q(i),e=0;return i.findIndex(s=>(e+=s)>=t)}function Ag(i){return i[Math.floor(i.length*Math.random())]}var Qn=new Map;function kg(i,t){t||(t=ci()),Qn.has(t)||Qn.set(t,Ht(1,i));let e=Qn.get(t),s=Yc(e.map(n=>n*n));return e[s]-=1,e[s]<=0&&Qn.set(t,e.map(n=>n+1)),s}function Qc(i=.5){return Math.random()<i?1:0}function Vg(i=1,t=.5){let e=0;for(let s=0;s<i;++s)e+=Qc(t);return e}function Og(i=1){if(i<=0)return 0;let t=Math.exp(-i),e=1,s=0;for(;e>t;++s)e*=Math.random();return s-1}function Lg(i=0,t=1){return i+(t-i)*Math.random()}function Rg(i=0,t=1){let e=Math.random(),s=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*s)*Math.sqrt(t)+i}function Ig(i=1){return i<=0?0:-Math.log(Math.random())/i}function Ng(i=.5){if(!(i<=0||i>1))return Math.floor(Math.log(Math.random())/Math.log(1-i))}function Gg(){let i,t,e;do t=2*Math.random()-1,e=2*Math.random()-1,i=t*t+e*e;while(i>=1);return t/e}function Dg(i,t=1,e=0){return Math.exp(-((i-t)**2)/(2*e))/Math.sqrt(2*Math.PI*e)}var td=7,ed=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23];function id(i){if(i<.5)return Math.PI/(Math.sin(Math.PI*i)*id(1-i));i-=1;let t=ed[0];for(let s=1;s<td+2;s++)t+=ed[s]/(i+s);let e=i+td+.5;return Math.sqrt(2*Math.PI)*Math.pow(e,i+.5)*Math.exp(-e)*t}function Jc(i,t,e,s=1){let n=0;for(let o=t;o<e;o+=s)n+=i(o)*s||0;return n}function _g(i,t){let e=Jc(s=>Math.pow(s,(t-2)/2)*Math.exp(-s/2),0,i);return 1-e/Math.pow(2,t/2)/id(t/2)}var Gr={};Lr(Gr,{bestPolynomial:()=>Fg,coefficient:()=>nd,exponential:()=>qg,linear:()=>Hg,logarithmic:()=>Bg,polynomial:()=>sd,power:()=>zg});function jg(i,t){let e=1,s=i[0];for(let n=1;n<i.length;++n)e*=t,s+=e*i[n];return s}function Hg(i,t=!1){let e=0,s=0,n=0,o=0,r=i.length;for(let c=0;c<r;c++)e+=i[c][0],s+=i[c][1],n+=i[c][0]*i[c][0],o+=i[c][0]*i[c][1];if(t){let c=o/n;return[0,c]}let a=(r*o-e*s)/(r*n-e*e);return[s/r-a*e/r,a]}function qg(i){let t=[0,0,0,0,0,0];for(let o of i)t[0]+=o[0],t[1]+=o[1],t[2]+=o[0]*o[0]*o[1],t[3]+=o[1]*Math.log(o[1]),t[4]+=o[0]*o[1]*Math.log(o[1]),t[5]+=o[0]*o[1];let e=t[1]*t[2]-t[5]*t[5],s=Math.exp((t[2]*t[3]-t[5]*t[4])/e),n=(t[1]*t[4]-t[5]*t[3])/e;return[s,n]}function Bg(i){let t=[0,0,0,0],e=i.length;for(let o of i)t[0]+=Math.log(o[0]),t[1]+=o[1]*Math.log(o[0]),t[2]+=o[1],t[3]+=Math.pow(Math.log(o[0]),2);let s=(e*t[1]-t[2]*t[0])/(e*t[3]-t[0]*t[0]);return[(t[2]-s*t[0])/e,s]}function zg(i){let t=[0,0,0,0],e=i.length;for(let o of i)t[0]+=Math.log(o[0]),t[1]+=Math.log(o[1])*Math.log(o[0]),t[2]+=Math.log(o[1]),t[3]+=Math.pow(Math.log(o[0]),2);let s=(e*t[1]-t[2]*t[0])/(e*t[3]-t[0]*t[0]);return[Math.exp((t[2]-s*t[0])/e),s]}function sd(i,t=2){let e=i.map(l=>pi(t+1).map(c=>Math.pow(l[0],c))),s=Kc(e),n=i.map(l=>[l[1]]),o=Yn(s,e),r=Xc(o);return Yn(r,s,n).map(l=>l[0])}function nd(i,t){let s=i.reduce((r,a)=>r+a[1],0)/i.length,n=i.reduce((r,a)=>r+(a[1]-s)**2,0),o=i.reduce((r,a)=>r+(a[1]-t(a[0]))**2,0);return 1-o/n}function Fg(i,t=.85,e=8){if(!(i.length<=1))for(let s=1;s<e;++s){let n=sd(i,s),o=a=>jg(n,a);if(nd(i,o)>=t)return{order:s,coefficients:n,fn:o}}}function ps(i){return i.length?q(i)/i.length:0}function us(i,t){let e=i.length;if(!e)return 0;let s=i.slice(0).sort((r,a)=>r-a);if(t===0)return i[0];if(t===1)return i[e-1];let n=e*t-.5;if(Number.isInteger(n))return s[n];let o=Math.floor(n);return bt(s[o],s[o+1],n-o)}var D=2*Math.PI;function mi(i,t){let e=Math.atan2(i.y-(t?t.y:0),i.x-(t?t.x:0));return Rt(e,D)}function od(i,t){let e,s=Infinity,n=-1;for(let[o,r]of t.entries()){let a=r.project(i),l=d.distance(i,a);l<s&&(e=a,s=l,n=o)}return e?[e,n]:void 0}var d=class{constructor(i=0,t=0){this.x=i,this.y=t,this.type="point"}get unitVector(){return P(this.length,0)?new d(1,0):this.scale(1/this.length)}get length(){return Math.sqrt(this.x**2+this.y**2)}get inverse(){return new d(-this.x,-this.y)}get flip(){return new d(this.y,this.x)}get perpendicular(){return new d(-this.y,this.x)}get array(){return[this.x,this.y]}distanceFromLine(i){return d.distance(this,i.project(this))}clamp(i,t=0){let e=S(this.x,i.xMin+t,i.xMax-t),s=S(this.y,i.yMin+t,i.yMax-t);return new d(e,s)}changeCoordinates(i,t){let e=t.xMin+(this.x-i.xMin)/i.dx*t.dx,s=t.yMin+(this.y-i.yMin)/i.dy*t.dy;return new d(e,s)}add(i){return d.sum(this,i)}subtract(i){return d.difference(this,i)}round(i=1){return new d(ht(this.x,i),ht(this.y,i))}floor(){return new d(Math.floor(this.x),Math.floor(this.y))}mod(i,t=i){return new d(this.x%i,this.y%t)}angle(i=$){return mi(this,i)}snap(i,t=5){return P(this.x,i.x,t)?new d(i.x,this.y):P(this.y,i.y,t)?new d(this.x,i.y):this}static average(...i){let t=q(i.map(s=>s.x))/i.length,e=q(i.map(s=>s.y))/i.length;return new d(t,e)}static dot(i,t){return i.x*t.x+i.y*t.y}static sum(i,t){return new d(i.x+t.x,i.y+t.y)}static difference(i,t){return new d(i.x-t.x,i.y-t.y)}static distance(i,t){return Math.sqrt(ce(i.x-t.x)+ce(i.y-t.y))}static manhattan(i,t){return Math.abs(i.x-t.x)+Math.abs(i.y-t.y)}static interpolate(i,t,e=.5){return new d(bt(i.x,t.x,e),bt(i.y,t.y,e))}static interpolateList(i,t=.5){let e=i.length-1,s=Math.floor(S(t,0,1)*e);return d.interpolate(i[s],i[s+1],e*t-s)}static fromPolar(i,t=1){return new d(t*Math.cos(i),t*Math.sin(i))}static random(i){let t=tt.uniform(i.xMin,i.xMax),e=tt.uniform(i.yMin,i.yMax);return new d(t,e)}static equals(i,t,e){return P(i.x,t.x,e)&&P(i.y,t.y,e)}static colinear(i,t,e,s){let n=i.x-t.x,o=i.y-t.y,r=t.x-e.x,a=t.y-e.y;return P(n*a,r*o,s)}transform(i){let t=i[0][0]*this.x+i[0][1]*this.y+i[0][2],e=i[1][0]*this.x+i[1][1]*this.y+i[1][2];return new d(t,e)}rotate(i,t=$){if(P(i,0))return this;let e=this.x-t.x,s=this.y-t.y,n=Math.cos(i),o=Math.sin(i),r=e*n-s*o+t.x,a=e*o+s*n+t.y;return new d(r,a)}reflect(i){let t=i.p2.x-i.p1.x,e=i.p2.y-i.p1.y,s=this.x-i.p1.x,n=this.y-i.p1.y,o=(t*n-e*s)/(t*t+e*e),r=this.x+2*o*e,a=this.y-2*o*t;return new d(r,a)}scale(i,t=i){return new d(this.x*i,this.y*t)}shift(i,t=i){return new d(this.x+i,this.y+t)}translate(i){return this.shift(i.x,i.y)}equals(i,t){return d.equals(this,i,t)}toString(){return`point(${this.x},${this.y})`}},$=new d(0,0),$t=class{constructor(i,t){this.p1=i,this.p2=t,this.type="line"}make(i,t){return new $t(i,t)}get length(){return d.distance(this.p1,this.p2)}get lengthSquared(){return(this.p1.x-this.p2.x)**2+(this.p1.y-this.p2.y)**2}get midpoint(){return d.average(this.p1,this.p2)}get slope(){return(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x)}get intercept(){return this.p1.y-this.slope*this.p1.x}get angle(){return mi(this.p2,this.p1)}get unitVector(){return this.p2.subtract(this.p1).unitVector}get perpendicularVector(){return new d(this.p2.y-this.p1.y,this.p1.x-this.p2.x).unitVector}parallel(i){let t=d.sum(i,d.difference(this.p2,this.p1));return new $t(i,t)}perpendicular(i){return new $t(i,d.sum(i,this.perpendicularVector))}get perpendicularBisector(){return this.perpendicular(this.midpoint)}distanceSquared(i){let t=this.project(i);return(i.x-t.x)**2+(i.y-t.y)**2}offset(i){let t=d.difference(this.p2,this.p1),e=d.difference(i,this.p1);return d.dot(t,e)/this.lengthSquared}project(i){return this.at(this.offset(i))}side(i,t){let e=d.difference(this.p2,this.p1),s=d.difference(i,this.p1),n=s.x*e.y-s.y*e.x;return P(n,0,t)?0:Math.sign(n)}contains(i,t){return this.side(i,t)===0}at(i){return d.interpolate(this.p1,this.p2,i)}transform(i){return new this.constructor(this.p1.transform(i),this.p2.transform(i))}rotate(i,t=$){return P(i,0)?this:new this.constructor(this.p1.rotate(i,t),this.p2.rotate(i,t))}reflect(i){return new this.constructor(this.p1.reflect(i),this.p2.reflect(i))}scale(i,t=i){return this.make(this.p1.scale(i,t),this.p2.scale(i,t))}shift(i,t=i){return this.make(this.p1.shift(i,t),this.p2.shift(i,t))}translate(i){return this.shift(i.x,i.y)}equals(i,t){return this.contains(i.p1,t)&&this.contains(i.p2,t)}toString(){return`line(${this.p1},${this.p2})`}},Dr=class extends $t{constructor(){super(...arguments);this.type="ray"}make(i,t){return new Dr(i,t)}equals(i,t){return i.type!=="ray"?!1:this.p1.equals(i.p1,t)&&this.contains(i.p2,t)}toString(){return`ray(${this.p1},${this.p2})`}},st=class extends $t{constructor(){super(...arguments);this.type="segment"}contains(i,t){return $t.prototype.contains.call(this,i,t)?this.p1.equals(i,t)||this.p2.equals(i,t)?!0:P(this.p1.x,this.p2.x,t)?it(i.y,this.p1.y,this.p2.y):it(i.x,this.p1.x,this.p2.x):!1}make(i,t){return new st(i,t)}project(i){let t=d.difference(this.p2,this.p1),e=d.difference(i,this.p1),s=S(d.dot(t,e)/this.lengthSquared,0,1);return d.sum(this.p1,t.scale(s))}contract(i){return new st(this.at(i),this.at(1-i))}equals(i,t,e=!1){return i.type!=="segment"?!1:this.p1.equals(i.p1,t)&&this.p2.equals(i.p2,t)||!e&&this.p1.equals(i.p2,t)&&this.p2.equals(i.p1,t)}toString(){return`segment(${this.p1},${this.p2})`}},H=class{constructor(i=$,t=1){this.c=i,this.r=t,this.type="circle"}get circumference(){return D*this.r}get area(){return Math.PI*this.r**2}get arc(){let i=this.c.shift(this.r,0);return new Jt(this.c,i,D)}tangentAt(i){let t=this.at(i),e=this.c.rotate(Math.PI/2,t);return new $t(t,e)}collision(i){let t=this.c.x<i.p.x?i.p.x:this.c.x>i.p.x+i.w?i.p.x+i.w:this.c.x,e=this.c.y<i.p.y?i.p.y:this.c.y>i.p.y+i.h?i.p.y+i.h:this.c.y;return d.distance(this.c,new d(t,e))<=this.r}project(i){let t=i.subtract(this.c).unitVector.scale(this.r);return d.sum(this.c,t)}at(i){let t=D*i;return this.c.shift(this.r*Math.cos(t),this.r*Math.sin(t))}offset(i){return mi(i,this.c)/D}contains(i){return d.distance(i,this.c)<=this.r}transform(i){let t=Math.abs(i[0][0])+Math.abs(i[1][1]);return new H(this.c.transform(i),this.r*t/2)}rotate(i,t=$){return P(i,0)?this:new H(this.c.rotate(i,t),this.r)}reflect(i){return new H(this.c.reflect(i),this.r)}scale(i,t=i){return new H(this.c.scale(i,t),this.r*(i+t)/2)}shift(i,t=i){return new H(this.c.shift(i,t),this.r)}translate(i){return this.shift(i.x,i.y)}equals(i,t){return P(this.r,i.r,t)&&this.c.equals(i.c,t)}toString(){return`circle(${this.c},${this.r})`}},Jt=class{constructor(i,t,e){this.c=i,this.start=t,this.angle=e,this.type="arc"}get circle(){return new H(this.c,this.radius)}get radius(){return d.distance(this.c,this.start)}get end(){return this.start.rotate(this.angle,this.c)}get startAngle(){return mi(this.start,this.c)}contract(i){return new this.constructor(this.c,this.at(i/2),this.angle*(1-i))}get minor(){return this.angle<=Math.PI?this:new this.constructor(this.c,this.end,D-this.angle)}get major(){return this.angle>=Math.PI?this:new this.constructor(this.c,this.end,D-this.angle)}get center(){return this.at(.5)}project(i){let t=this.startAngle,e=t+this.angle,s=mi(i,this.c);return e>D&&s<e-D&&(s+=D),s=S(s,t,e),this.c.shift(this.radius,0).rotate(s,this.c)}at(i){return this.start.rotate(this.angle*i,this.c)}offset(i){return new Ot(this.start,this.c,i).rad/this.angle}contains(i){return i.equals(this.project(i))}transform(i){return new this.constructor(this.c.transform(i),this.start.transform(i),this.angle)}rotate(i,t=$){return P(i,0)?this:new this.constructor(this.c.rotate(i,t),this.start.rotate(i,t),this.angle)}reflect(i){return new this.constructor(this.c.reflect(i),this.start.reflect(i),this.angle)}scale(i,t=i){return new this.constructor(this.c.scale(i,t),this.start.scale(i,t),this.angle)}shift(i,t=i){return new this.constructor(this.c.shift(i,t),this.start.shift(i,t),this.angle)}translate(i){return this.shift(i.x,i.y)}equals(){return!1}toString(){return`arc(${this.c},${this.start},${this.angle})`}},Ie=class extends Jt{constructor(){super(...arguments);this.type="sector"}contains(i){return d.distance(i,this.c)<=this.radius&&new Ot(this.start,this.c,i).rad<=this.angle}toString(){return`sector(${this.c},${this.start},${this.angle})`}},Ri=1e-6;function _r(i,t,e){let s=(e.x-t.x)*(i.y-t.y),n=(e.y-t.y)*(i.x-t.x);return s-n>=-Ri}function rd(i,t,e){let s=i.y-t.y,n=e.x-t.x,o=i.x-t.x,r=e.y-t.y,a=o*n+s*r;if(a<Ri)return!1;let l=n*n+r*r;return a-l<=-Ri}function ad(i,t){return P(i.x,t.x)?P(i.y,t.y)?0:i.y<t.y?-1:1:i.x<t.x?-1:1}function ld(i){return i<=-Ri?-2:i<Ri?-1:i-1<=-Ri?0:i-1<Ri?1:2}function Ug(i,t,e,s){let n=t.x-i.x,o=t.y-i.y,r=s.x-e.x,a=s.y-e.y,l=n*a-o*r;if(P(l,0))return!1;let c=i.x-e.x,p=i.y-e.y,u=(r*p-a*c)/l,f=(n*p-o*c)/l,g=new d(i.x+u*n,i.y+u*o);return{alongA:ld(u),alongB:ld(f),pt:g}}var fs=class{constructor(){this.root={root:!0,next:void 0}}exists(i){return i!==void 0&&i!==this.root}get head(){return this.root.next}insertBefore(i,t){let e=this.root,s=this.root.next;for(;s;){if(t(s)){i.prev=s.prev,i.next=s,s.prev.next=i,s.prev=i;return}e=s,s=s.next}e.next=i,i.prev=e,i.next=void 0}findTransition(i){let t=this.root,e=this.root.next;for(;e&&!i(e);)t=e,e=e.next;return{before:t===this.root?void 0:t,after:e,insert:s=>(s.prev=t,s.next=e,t.next=s,e&&(e.prev=s),s)}}static node(i){let t=i;return t.remove=()=>{t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t.prev=t.next=void 0},t}};function Hr(i,t,e){let s={above:e.myFill.above,below:e.myFill.below};return{start:i,end:t,myFill:s}}function Zg(i,t,e,s,n,o){let r=ad(t,n);return r!==0?r:d.equals(e,o)?0:i!==s?i?1:-1:_r(e,s?n:o,s?o:n)?1:-1}function qr(i,t,e){i.insertBefore(t,s=>Zg(!!t.isStart,t.pt,e,!!s.isStart,s.pt,s.other.pt)<0)}function Wg(i,t,e){let s=fs.node({isStart:!0,pt:t.start,seg:t,primary:e});return qr(i,s,t.end),s}function Kg(i,t,e,s){let n=fs.node({pt:e.end,seg:e,primary:s,other:t});t.other=n,qr(i,n,t.pt)}function Jn(i,t,e){let s=Wg(i,t,e);return Kg(i,s,t,e),s}function Xg(i,t,e){t.other.remove(),t.seg.end=e,t.other.pt=e,qr(i,t.other,t.pt)}function Se(i,t,e){let s=Hr(e,t.seg.end,t.seg);return Xg(i,t,e),Jn(i,s,!!t.primary)}function Yg(i,t){let e=i.seg.start,s=i.seg.end,n=t.seg.start,o=t.seg.end;return d.colinear(e,n,o)?d.colinear(s,n,o)||_r(s,n,o)?1:-1:_r(e,n,o)?1:-1}function Br(i,t,e){let s=t.seg,n=e.seg,o=s.start,r=s.end,a=n.start,l=n.end,c=Ug(o,r,a,l);if(c===!1){if(!d.colinear(o,r,a)||d.equals(o,l)||d.equals(r,a))return!1;let p=d.equals(o,a),u=d.equals(r,l);if(p&&u)return e;let f=!p&&rd(o,a,l),g=!u&&rd(r,a,l);if(p)return g?Se(i,e,r):Se(i,t,l),e;f&&(u||(g?Se(i,e,r):Se(i,t,l)),Se(i,e,o))}else c.alongA===0&&(c.alongB===-1?Se(i,t,a):c.alongB===0?Se(i,t,c.pt):c.alongB===1&&Se(i,t,l)),c.alongB===0&&(c.alongA===-1?Se(i,e,o):c.alongA===0?Se(i,e,c.pt):c.alongA===1&&Se(i,e,r));return!1}function hd(i,t){var e,s;let n=new fs,o=[];for(;i.head;){let r=i.head;if(r.isStart){let a=function(){if(c){let f=Br(i,r,c);if(f)return f}return p?Br(i,r,p):!1},l=n.findTransition(f=>Yg(r,f.ev)>0),c=(e=l.before)==null?void 0:e.ev,p=(s=l.after)==null?void 0:s.ev,u=a();if(u&&(t?(r.seg.myFill.below?r.seg.myFill.above!==r.seg.myFill.below:!0)&&(u.seg.myFill.above=!u.seg.myFill.above):u.seg.otherFill=r.seg.myFill,r.other.remove(),r.remove()),i.head!==r)continue;if(t){let f=r.seg.myFill.below?r.seg.myFill.above!==r.seg.myFill.below:!0;r.seg.myFill.below=p?p.seg.myFill.above:!1,r.seg.myFill.above=f?!r.seg.myFill.below:r.seg.myFill.below}else if(r.seg.otherFill===void 0){let f=p?r.primary===p.primary?p.seg.otherFill.above:p.seg.myFill.above:!1;r.seg.otherFill={above:f,below:f}}r.other.status=l.insert(fs.node({ev:r}))}else{let a=r.status;if(a===void 0)throw new Error("[Euclid.js] Zero-length segment detected!");if(n.exists(a.prev)&&n.exists(a.next)&&Br(i,a.prev.ev,a.next.ev),a.remove(),!r.primary){let l=r.seg.myFill;r.seg.myFill=r.seg.otherFill,r.seg.otherFill=l}o.push(r.seg)}i.head.remove()}return o}function Qg(i){let t=[],e=[];return i.forEach(s=>{let n=s.start,o=s.end;if(d.equals(n,o))return;let r={index:0,matchesHead:!1,matchesPt1:!1},a={index:0,matchesHead:!1,matchesPt1:!1},l=r;function c(v,y,C){l.index=v,l.matchesHead=y,l.matchesPt1=C;let k=l===r;return l=k?a:void 0,!k}for(let v=0;v<t.length;v++){let y=t[v],C=y[0],k=_(y);if(d.equals(C,n)){if(c(v,!0,!0))break}else if(d.equals(C,o)){if(c(v,!0,!1))break}else if(d.equals(k,n)){if(c(v,!1,!0))break}else if(d.equals(k,o)&&c(v,!1,!1))break}if(l===r){t.push([n,o]);return}if(l===a){let v=r.index,y=r.matchesPt1?o:n,C=r.matchesHead,k=t[v],L=C?k[0]:k[k.length-1],V=C?k[1]:k[k.length-2],ot=C?k[k.length-1]:k[0],Gt=C?k[k.length-2]:k[1];if(d.colinear(V,L,y)&&(C?k.shift():k.pop(),L=V),d.equals(ot,y)){t.splice(v,1),d.colinear(Gt,ot,L)&&(C?k.pop():k.shift()),e.push(k);return}C?k.unshift(y):k.push(y);return}function p(v){t[v].reverse()}function u(v,y){let C=t[v],k=t[y],L=C[C.length-1],V=C[C.length-2],ot=k[0],Gt=k[1];d.colinear(V,L,ot)&&(C.pop(),L=V),d.colinear(L,ot,Gt)&&k.shift(),t[v]=C.concat(k),t.splice(y,1)}let f=r.index,g=a.index,w=t[f].length<t[g].length;r.matchesHead?a.matchesHead?w?(p(f),u(f,g)):(p(g),u(g,f)):u(g,f):a.matchesHead?u(f,g):w?(p(f),u(g,f)):(p(g),u(f,g))}),e}function Jg(i,t){let e=[];for(let s of i){let n=(s.myFill.above?8:0)+(s.myFill.below?4:0)+(s.otherFill&&s.otherFill.above?2:0)+(s.otherFill&&s.otherFill.below?1:0);t[n]!==0&&e.push({start:s.start,end:s.end,myFill:{above:t[n]===1,below:t[n]===2}})}return e}function cd(i){let t=new fs;for(let e of i)for(let s=0;s<e.length;s++){let n=s?e[s-1]:_(e),o=e[s],r=ad(n,o);if(r===0)continue;let a=r<0?n:o,l=r<0?o:n;Jn(t,{start:a,end:l,myFill:{}},!0)}return hd(t,!0)}function zr(i,t,e){let s=new fs;for(let o of cd(i))Jn(s,Hr(o.start,o.end,o),!0);for(let o of cd(t))Jn(s,Hr(o.start,o.end,o),!1);let n=Jg(hd(s,!1),e);return Qg(n)}var t0=[0,2,1,0,2,2,0,0,1,0,1,0,0,0,0,0],e0=[0,0,0,0,0,2,0,2,0,0,1,1,0,2,1,0],i0=[0,0,0,0,2,0,2,0,1,1,0,0,0,1,2,0],s0=(i,t)=>zr(i,t,t0),n0=(i,t)=>zr(i,t,e0),o0=(i,t)=>zr(i,t,i0);function te(i){return["polygon","polyline","rectangle","triangle"].includes(i.type)}function ms(i){return["polygon","triangle"].includes(i.type)}function to(i){return i.type==="polyline"}function Fr(i){return i.type==="rectangle"}function Ct(i){return["line","ray","segment"].includes(i.type)}function jr(i){return i.type==="line"}function dd(i){return i.type==="ray"}function Te(i){return i.type==="segment"}function ct(i){return i.type==="circle"}function r0(i){return i.type==="ellipse"}function ee(i){return i.type==="arc"}function Ne(i){return i.type==="sector"}function ie(i){return i.type==="angle"}function wt(i){return i.type==="point"}function a0(i,t){return P(i.p1.x,i.p2.x)?it(t.y,i.p1.y,i.p2.y):it(t.x,i.p1.x,i.p2.x)}function l0(i,t){return P(i.p1.x,i.p2.x)?(t.y-i.p1.y)/(i.p2.y-i.p1.y)>0:(t.x-i.p1.x)/(i.p2.x-i.p1.x)>0}function h0(i,t){return it(i.offset(t),0,1)}function c0(i,t){let e=i.p1.x-i.p2.x,s=i.p1.y-i.p2.y,n=t.p1.x-t.p2.x,o=t.p1.y-t.p2.y,r=e*o-s*n;if(P(r,0))return[];let a=i.p1.x*i.p2.y-i.p1.y*i.p2.x,l=t.p1.x*t.p2.y-t.p1.y*t.p2.x,c=a*n-e*l,p=a*o-s*l;return[new d(c/r,p/r)]}function d0(i,t){let e=d.distance(i.c,t.c);if(e>i.r+t.r)return[];if(e<Math.abs(i.r-t.r))return[];if(P(e,0)&&P(i.r,t.r))return[];if(P(e,i.r+t.r))return[new $t(i.c,t.c).midpoint];let s=(ce(i.r)-ce(t.r)+ce(e))/(2*e),n=Math.sqrt(ce(i.r)-ce(s)),o=(t.c.x-i.c.x)*s/e+(t.c.y-i.c.y)*n/e+i.c.x,r=(t.c.y-i.c.y)*s/e-(t.c.x-i.c.x)*n/e+i.c.y,a=(t.c.x-i.c.x)*s/e-(t.c.y-i.c.y)*n/e+i.c.x,l=(t.c.y-i.c.y)*s/e+(t.c.x-i.c.x)*n/e+i.c.y;return[new d(o,r),new d(a,l)]}function pd(i,t){let e=i.p2.x-i.p1.x,s=i.p2.y-i.p1.y,n=ce(e)+ce(s),o=t.c.x,r=t.c.y,a=(i.p1.x-o)*(i.p2.y-r)-(i.p2.x-o)*(i.p1.y-r),l=ce(t.r)*n-ce(a);if(l<0)return[];let c=a*s/n,p=-a*e/n;if(P(l,0))return[t.c.shift(c,p)];let u=e*(s<0?-1:1)*Math.sqrt(l)/n,f=Math.abs(s)*Math.sqrt(l)/n;return[t.c.shift(c+u,p+f),t.c.shift(c-u,p-f)]}function p0(i,t){let e=[],s=ee(i)?i.circle:i,n=ee(t)?t.circle:t;Ct(i)&&Ct(t)?e=c0(i,t):Ct(s)&&ct(n)?e=pd(s,n):ct(s)&&Ct(n)?e=pd(n,s):ct(s)&&ct(n)&&(e=d0(s,n));for(let o of[i,t])Te(o)&&(e=e.filter(r=>a0(o,r))),dd(o)&&(e=e.filter(r=>l0(o,r))),ee(o)&&(e=e.filter(r=>h0(o,r)));return e}function ft(...i){if(i.length<2)return[];if(i.length>2)return qt(Fc(i,2).map(s=>ft(...s)));let[t,e]=i;if(ie(t)&&(t=t.shape(!0)),ie(e)&&(e=e.shape(!0)),te(e)&&([t,e]=[e,t]),te(t)){let s=Ct(e)?t.points.filter(n=>e.contains(n)):[];for(let n of t.edges)s.push(...ft(n,e));return s}return p0(t,e)}var M=class{constructor(...i){this.type="polygon",this.points=i}get circumference(){if(this.points.length<=1)return 0;let i=d.distance(this.points[0],_(this.points));for(let t=1;t<this.points.length;++t)i+=d.distance(this.points[t-1],this.points[t]);return i}get signedArea(){let i=this.points,t=i.length,e=i[t-1].x*i[0].y-i[0].x*i[t-1].y;for(let s=1;s<t;++s)e+=i[s-1].x*i[s].y-i[s].x*i[s-1].y;return e/2}get area(){return Math.abs(this.signedArea)}get centroid(){let i=this.points,t=i.length,e=0;for(let n=0;n<t;++n)e+=i[n].x;let s=0;for(let n=0;n<t;++n)s+=i[n].y;return new d(e/t,s/t)}get edges(){let i=this.points.length,t=[];for(let e=0;e<i;++e)t.push(new st(this.points[e],this.points[(e+1)%i]));return t}get radius(){let i=this.centroid,t=this.points.map(e=>d.distance(e,i));return Math.max(...t)}get oriented(){if(this.signedArea>=0)return this;let i=[...this.points].reverse();return new this.constructor(...i)}cut(i){let t=this.radius/i.length*10,e=i.at(-t),s=i.at(t),n=i.perpendicularVector.scale(i.length*t),o=[e,s,s.add(n),e.add(n)],r=n0([this.points],[o]),a=o0([this.points],[o]);return[...r,...a].map(l=>new M(...l))}static collision(i,t){if(i.points.some(e=>t.contains(e))||t.points.some(e=>i.contains(e)))return!0;for(let e of i.edges)for(let s of t.edges)if(ft(e,s)[0])return!0;return!1}static union(...i){let[t,...e]=i;if(!e.length)return[t];let s=[t.points],n=e.length>1?M.union(...e).map(o=>o.points):[i[1].points];return s0(s,n).map(o=>new M(...o))}static regular(i,t=1){let e=D/i,s=Math.PI/2-e/2,n=B(o=>d.fromPolar(s+e*o,t),i);return new M(...n)}static interpolate(i,t,e=.5){let s=i.points.map((n,o)=>d.interpolate(n,t.points[o],e));return new M(...s)}static convexHull(...i){if(i.length<=3)return new M(...i);let t=i.sort((o,r)=>o.x!==r.x?o.x-r.x:o.y-r.y),e=t.slice(0).reverse(),s=[],n=[];for(let[o,r]of[[t,s],[e,n]]){for(let a of o){for(;r.length>=2;){let l=r[r.length-1],c=r[r.length-2];if((l.x-c.x)*(a.y-c.y)>=(a.x-c.x)*(l.y-c.y))r.pop();else break}r.push(a)}r.pop()}return new M(...s.concat(n))}contains(i){let t=!1;for(let e of this.edges){if(e.p1.equals(i)||e.contains(i))return!1;if(e.p1.y>i.y==e.p2.y>i.y)continue;let s=(e.p2.x-e.p1.x)/(e.p2.y-e.p1.y);i.x<s*(i.y-e.p1.y)+e.p1.x&&(t=!t)}return t}at(i){i<0&&(i+=Math.floor(i));let t=i*this.circumference,e=0;for(let s of this.edges){let n=s.length;if(e+n>t)return s.at((t-e)/n);e+=n}return this.points[0]}offset(i){let t=this.edges,e=od(i,this.edges)||[this.points[0],0],s=0;for(let n=0;n<e[1];++n)s+=t[n].length;return s+=t[e[1]].offset(i)*t[e[1]].length,s/this.circumference}project(i){let t=od(i,this.edges);return t?t[0]:this.points[0]}centerAt(i=$){return this.translate(i.subtract(this.centroid))}transform(i){return new this.constructor(...this.points.map(t=>t.transform(i)))}rotate(i,t=$){if(P(i,0))return this;let e=this.points.map(s=>s.rotate(i,t));return new this.constructor(...e)}reflect(i){let t=this.points.map(e=>e.reflect(i));return new this.constructor(...t)}scale(i,t=i){let e=this.points.map(s=>s.scale(i,t));return new this.constructor(...e)}shift(i,t=i){let e=this.points.map(s=>s.shift(i,t));return new this.constructor(...e)}translate(i){return this.shift(i.x,i.y)}equals(i,t,e){let s=this.points.length;if(s!==i.points.length)return!1;let n=e?this:this.oriented,o=e?i:i.oriented;for(let r=0;r<s;++r)if(n.points.every((a,l)=>a.equals(o.points[(l+r)%s],t)))return!0;return!1}toString(){return`polygon(${this.points.join(",")})`}},se=class extends M{constructor(){super(...arguments);this.type="polyline"}get circumference(){return this.length}get length(){let i=0;for(let t=1;t<this.points.length;++t)i+=d.distance(this.points[t-1],this.points[t]);return i}get edges(){let i=[];for(let t=0;t<this.points.length-1;++t)i.push(new st(this.points[t],this.points[t+1]));return i}toString(){return`polyline(${this.points.join(",")})`}},tn=class extends M{constructor(){super(...arguments);this.type="triangle"}get circumcircle(){let[i,t,e]=this.points,s=2*(i.x*(t.y-e.y)+t.x*(e.y-i.y)+e.x*(i.y-t.y)),n=(i.x**2+i.y**2)*(t.y-e.y)+(t.x**2+t.y**2)*(e.y-i.y)+(e.x**2+e.y**2)*(i.y-t.y),o=(i.x**2+i.y**2)*(e.x-t.x)+(t.x**2+t.y**2)*(i.x-e.x)+(e.x**2+e.y**2)*(t.x-i.x),r=new d(n/s,o/s),a=d.distance(r,this.points[0]);if(!(isNaN(a)||a>Number.MAX_SAFE_INTEGER))return new H(r,a)}get incircle(){let i=this.edges,t=i.map(p=>p.length),e=t[0]+t[1]+t[2],[s,n,o]=this.points,r=t[1]*s.x+t[2]*n.x+t[0]*o.x,a=t[1]*s.y+t[2]*n.y+t[0]*o.y,l=new d(r/e,a/e),c=l.distanceFromLine(i[0]);return isNaN(c)?void 0:new H(l,c)}get orthocenter(){let[i,t,e]=this.points,s=new $t(i,t).perpendicular(e),n=new $t(i,e).perpendicular(t);return ft(s,n)[0]}},u0=180/Math.PI,f0=Math.PI/180;function _t(i){return i*u0}function Z(i){return i*f0}var Ot=class{constructor(i,t,e){this.a=i,this.b=t,this.c=e,this.type="angle"}static fromDegrees(i){return Ot.fromRadians(i*(Math.PI/180))}static fromRadians(i){let t=new d(1,0),e=t.rotate(i);return new Ot(t,$,e)}get rad(){let i=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),e=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x)-i;return e<0&&(e+=D),e}get deg(){return this.rad*180/Math.PI}get isRight(){return P(this.rad,Math.PI/2,Math.PI/360)}get bisector(){if(this.b.equals(this.a)||this.b.equals(this.c))return;let i=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),t=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x),e=(i+t)/2;i>t&&(e+=Math.PI);let s=Math.cos(e)+this.b.x,n=Math.sin(e)+this.b.y;return new $t(this.b,new d(s,n))}get sup(){return this.rad<Math.PI?this:new Ot(this.c,this.b,this.a)}get arc(){return new Jt(this.b,this.a,this.rad)}get radius(){return 24+20*(1-S(this.rad,0,Math.PI)/Math.PI)}shape(i=!0,t,e){if(this.a.equals(this.b)||this.c.equals(this.b))return new M($);let s=this.isRight&&!e;t||(t=s?20:this.radius);let n=new st(this.b,this.a),o=n.at(t/n.length);if(s){let r=d.difference(this.c,this.b).unitVector.scale(t);return i?new M(this.b,o,o.add(r),this.b.add(r)):new se(o,o.add(r),this.b.add(r))}return i?new Ie(this.b,o,this.rad):new Jt(this.b,o,this.rad)}project(i){return this.contains(i)?i:this.shape(!0).project(i)}at(){return this.c}offset(){return 0}contains(i){return this.shape(!0).contains(i)}transform(i){return new Ot(this.a.transform(i),this.b.transform(i),this.c.transform(i))}rotate(i,t){return P(i,0)?this:new Ot(this.a.rotate(i,t),this.b.rotate(i,t),this.c.rotate(i,t))}reflect(i){return new Ot(this.a.reflect(i),this.b.reflect(i),this.c.reflect(i))}scale(i,t=i){return new Ot(this.a.scale(i,t),this.b.scale(i,t),this.c.scale(i,t))}shift(i,t=i){return new Ot(this.a.shift(i,t),this.b.shift(i,t),this.c.shift(i,t))}translate(i){return new Ot(this.a.translate(i),this.b.translate(i),this.c.translate(i))}equals(i){return!1}toString(){return`angle(${this.a},${this.b},${this.c})`}},x=class{constructor(i,t=1,e=t){this.p=i,this.w=t,this.h=e,this.type="rectangle"}static aroundPoints(i){let t=Infinity,e=-Infinity,s=Infinity,n=-Infinity;for(let o of i)t=t<o.x?t:o.x,e=e>o.x?e:o.x,s=s<o.y?s:o.y,n=n>o.y?n:o.y;return new x(new d(t,s),e-t,n-s)}get center(){return new d(this.p.x+this.w/2,this.p.y+this.h/2)}get centroid(){return this.center}get circumference(){return 2*Math.abs(this.w)+2*Math.abs(this.h)}get area(){return Math.abs(this.w*this.h)}get edges(){return this.polygon.edges}get points(){return this.polygon.points}get polygon(){let i=new d(this.p.x+this.w,this.p.y),t=new d(this.p.x+this.w,this.p.y+this.h),e=new d(this.p.x,this.p.y+this.h);return new M(this.p,i,t,e)}collision(i){return this.p.x<i.p.x+i.w&&this.p.x+this.w>i.p.x&&this.p.y<i.p.y+i.h&&this.p.y+this.h>i.p.y}padding(i,t,e,s){return new x(this.p.shift(-s,-i),this.w+s+t,this.h+i+e)}contains(i,t){return it(i.x,this.p.x,this.p.x+this.w,t)&&it(i.y,this.p.y,this.p.y+this.h,t)}project(i){let t;for(let e of this.edges){let s=e.project(i);(!t||d.distance(i,s)<d.distance(i,t))&&(t=s)}return t}at(i){return this.polygon.at(i)}offset(i){return this.polygon.offset(i)}transform(i){return this.polygon.transform(i)}rotate(i,t=$){return P(i,0)?this:this.polygon.rotate(i,t)}reflect(i){return this.polygon.reflect(i)}scale(i,t=i){return new x(this.p.scale(i,t),this.w*i,this.h*t)}shift(i,t=i){return new x(this.p.shift(i,t),this.w,this.h)}translate(i){return this.shift(i.x,i.y)}equals(i){return!1}toString(){return`rectangle(${this.p},${this.w},${this.h})`}},At=class{constructor(i,t,e,s){this.xMin=i,this.xMax=t,this.yMin=e,this.yMax=s}contains(i){return this.containsX(i)&&this.containsY(i)}containsX(i){return it(i.x,this.xMin,this.xMax)}containsY(i){return it(i.y,this.yMin,this.yMax)}resize(i,t){return new At(this.xMin,this.xMax+i,this.yMin,this.yMax+t)}get dx(){return this.xMax-this.xMin}get dy(){return this.yMax-this.yMin}get xRange(){return[this.xMin,this.xMax]}get yRange(){return[this.yMin,this.yMax]}get rect(){return new x(new d(this.xMin,this.yMin),this.dx,this.dy)}get center(){return new d(this.xMin+this.dx/2,this.yMin+this.dy/2)}get flip(){return new At(this.yMin,this.yMax,this.xMin,this.xMax)}};function Ur(i,t,e={}){if(ie(t))return Ur(i,t.shape(!!e.fill),e);if(e.fill&&(i.fillStyle=e.fill),e.opacity&&(i.globalAlpha=e.opacity),e.stroke&&(i.strokeStyle=e.stroke,i.lineWidth=e.strokeWidth||1,e.lineCap&&(i.lineCap=e.lineCap),e.lineJoin&&(i.lineJoin=e.lineJoin)),i.beginPath(),Te(t))i.moveTo(t.p1.x,t.p1.y),i.lineTo(t.p2.x,t.p2.y);else if(ct(t))i.arc(t.c.x,t.c.y,t.r,0,D);else if(te(t)){let s=t.points;i.moveTo(s[0].x,s[0].y);for(let n of s.slice(1))i.lineTo(n.x,n.y);i.closePath()}else if(to(t)){i.moveTo(t.points[0].x,t.points[0].y);for(let s of t.points.slice(1))i.lineTo(s.x,s.y)}else r0(t)&&i.ellipse(t.c.x,t.c.y,t.a,t.b,t.angle,0,D);e.fill&&i.fill(),e.stroke&&i.stroke()}function ud(i,t,e){let n=t.x*(e.y-i.y)+i.x*(t.y-e.y)+e.x*(i.y-t.y)>0?1:0,o=d.distance(t,i);return[i.x,`${i.y}A${o}`,o,0,n,1,e.x,e.y].join(",")}function de(...i){return`M${i.map(t=>`${t.x},${t.y}`).join("L")}`}function fd(i,t){let e=i.perpendicularVector.scale(6),s=i.unitVector.scale(3),n=i.midpoint;switch(t){case"bar":return de(n.add(e),n.add(e.inverse));case"bar2":return de(n.add(s).add(e),n.add(s).add(e.inverse))+de(n.add(s.inverse).add(e),n.add(s.inverse).add(e.inverse));case"arrow":return de(n.add(s.inverse).add(e),n.add(s),n.add(s.inverse).add(e.inverse));case"arrow2":return de(n.add(s.scale(-2)).add(e),n,n.add(s.scale(-2)).add(e.inverse))+de(n.add(e),n.add(s.scale(2)),n.add(e.inverse));default:return""}}function eo(i,t){if(!i||!t)return"";let e=t.perpendicular,s=i.add(t.scale(9)).add(e.scale(9)),n=i.add(t.scale(9)).add(e.scale(-9));return de(s,i,n)}function m0(i,t){let e="";return Y(t,"start","both")&&(e+=eo(i.p1,i.unitVector)),Y(t,"end","both")&&(e+=eo(i.p2,i.unitVector.inverse)),e}function g0(i,t){let e="";if(Y(t,"start","both")){let s=new $t(i.c,i.start).perpendicularVector.inverse;e+=eo(i.start,s)}if(Y(t,"end","both")){let s=new $t(i.c,i.end).perpendicularVector;e+=eo(i.end,s)}return e}function Bt(i,t={}){if(ie(i)){let e=i.shape(!!t.fill,t.size,t.round);return Bt(e,t)}if(Te(i)){if(i.p1.equals(i.p2))return"";let e=de(i.p1,i.p2);return t.mark&&(e+=fd(i,t.mark)),t.arrows&&(e+=m0(i,t.arrows)),e}if(dd(i)){if(!t.box)return"";let e=ft(i,t.box)[0];return e?de(i.p1,e):""}if(jr(i)){if(!t.box)return"";let e=ft(i,t.box);if(e.length<2)return"";let s=de(e[0],e[1]);return t.mark&&(s+=fd(i,t.mark)),s}if(ct(i))return`M ${i.c.x-i.r} ${i.c.y} a ${i.r},${i.r} 0 1 0 ${2*i.r} 0 a ${i.r} ${i.r} 0 1 0 ${-2*i.r} 0`;if(ee(i)){let e=`M${ud(i.start,i.c,i.end)}`;return t.arrows&&(e+=g0(i,t.arrows)),e}return Ne(i)?`M ${i.c.x} ${i.c.y} L ${ud(i.start,i.c,i.end)} Z`:to(i)?de(...i.points):ms(i)?`${de(...i.points)}Z`:Fr(i)?`${de(...i.polygon.points)}Z`:""}var Ce=(i,t,e)=>new Promise((s,n)=>{var o=l=>{try{a(e.next(l))}catch(c){n(c)}},r=l=>{try{a(e.throw(l))}catch(c){n(c)}},a=l=>l.done?s(l.value):Promise.resolve(l.value).then(o,r);a((e=e.apply(i,t)).next())});function v0(i){let t=[];for(let e of Object.keys(i)){let s=i[e];if(e=encodeURIComponent(e),s==null){t.push(e);continue}s=Array.isArray(s)?s.join(","):`${s}`,s=s.replace(/(\r)?\n/g,`\r
`),s=encodeURIComponent(s),s=s.replace(/%20/g,"+"),t.push(`${e}=${s}`)}return t.join("&")}function io(i){i=i.replace(/^[?,&]/,"");let t=decodeURIComponent(i).split("&"),e={};return t.forEach(s=>{let n=s.split("=");e[n[0]]=n[1]}),e}function ti(i,t){return Ce(this,null,function*(){let e=t instanceof FormData,s={method:"POST",body:e?t:t?v0(t):void 0,headers:{"X-CSRF-Token":window.csrfToken||""}};e||(s.headers["Content-Type"]="application/x-www-form-urlencoded");let n=i.includes("?")?"&xhr=1":"?xhr=1",o=yield fetch(i+n,s);if(!o.ok)throw new Error(`Fetch error ${o.status}: ${i}`);return o.text()})}function so(i,t=!1){return new Promise(e=>{let s=new Image;t||(s.crossOrigin="Anonymous"),s.onload=()=>e(s),s.src=i})}var en=new Map;function md(i,t){en.has(i)?Ar(en.get(i),t,(e,s)=>Dt(e.concat(s))):en.set(i,t)}function gd(){if(!!window.navigator.onLine)for(let[i,t]of en)en.delete(i),ti(i,{data:JSON.stringify(t)}).catch(e=>{console.error("Failed to send POST request:",e),md(i,t)})}var vd=Le(gd,5e3);window.addEventListener("online",vd);window.onbeforeunload=gd;function wd(i,t){md(i,t),vd()}var fe=class{constructor(i,t=1,e=!0){this.src=i,this.defaultVolume=t,this.player=new Audio,this.player.src=i,e&&(this.player.preload="auto")}play(i){this.player.currentTime=0,this.player.volume=i||this.defaultVolume,this.player.play()}},yd={"===":(i,t)=>i===t,"!==":(i,t)=>i!==t,"||":(i,t)=>i||t,"&&":(i,t)=>i&&t,"==":(i,t)=>i==t,"!=":(i,t)=>i!=t,"<=":(i,t)=>i<=t,">=":(i,t)=>i>=t,"**":(i,t)=>i**t,"<":(i,t)=>i<t,">":(i,t)=>i>t,"+":(i,t)=>i+t,"-":(i,t)=>i-t,"*":(i,t)=>i*t,"/":(i,t)=>i/t,"%":(i,t)=>i%t},bd={"-":i=>-i,"+":i=>+i,"!":i=>!i},$d={"||":1,"&&":2,"==":3,"!=":3,"===":3,"!==":3,"<":4,">":4,"<=":4,">=":4,"+":5,"-":5,"*":6,"/":6,"%":6,"**":7},xd={true:!0,false:!1,undefined:void 0},w0=/\s/,Zr=/[0-9]/,Wr=/[a-zA-Zα-ωΑ-Ω$_]/,y0=/[0-9a-zA-Zα-ωΑ-Ω$_]/;function b0(i){let t=i.length,e=0;function s(v){throw new Error(`${v} at character ${e} of "${i}"`)}function n(){for(;w0.test(i[e]);)e+=1}function o(){let v="";for(;Zr.test(i[e]);)v+=i[e++];if(i[e]===".")for(v+=i[e++];Zr.test(i[e]);)v+=i[e++];let y=i[e];if(y&&Wr.test(y)){let C=v+i[e];s(`Variable names cannot start with a number (${C})`)}else y==="."&&s("Unexpected period");return{type:5,value:parseFloat(v)}}function r(){let v=i[e];e+=1;let y=!1,C="";for(;e<t;){let k=i[e++];if(k===v){y=!0;break}C+=k}return y||s(`Unclosed quote after "${C}"`),{type:5,value:C}}function a(){let v=i[e];for(Wr.test(i[e])||s(`Unexpected ${v}`),e+=1;e<t&&y0.test(i[e]);)v+=i[e++];return v in xd?{type:5,value:xd[v]}:{type:4,name:v}}function l(v){let y=[],C=!1,k;for(;e<t;)if(i[e]===v){k&&y.push(k),C=!0,e+=1;break}else i[e]===","?(y.push(k||{type:5,value:void 0}),e+=1):k=g();return C||s(`Expected ${v}`),y}function c(){let v;if(i[e]==="("){if(e+=1,v=g(),n(),i[e]===")")return e+=1,v;s("Unclosed (")}else v=a();for(n();".[(".includes(i[e]);)i[e]==="."?(e++,n(),v={type:6,object:v,computed:!1,property:a()}):i[e]==="["?(e++,v={type:6,object:v,computed:!0,property:g()},n(),i[e]!=="]"&&s("Unclosed ["),e++):i[e]==="("&&(e++,v={type:2,args:l(")"),callee:v}),n();return v}function p(){n();for(let v of[3,2,1]){let y=i.substr(e,v);if(y in yd)return e+=v,y}}function u(){n();let v=i[e];if(Zr.test(v)||v===".")return o();if(v==="'"||v==='"')return r();if(v==="[")return e+=1,{type:0,elements:l("]")};if(v in bd)return e+=1,{type:7,operator:v,argument:u()};if(Wr.test(v)||v==="(")return c();s("Expression parsing error")}function f(){let v=u(),y=p();if(!y)return v;let C=u();C||s(`Expected expression after ${y}`);let k,L=[v,y,C];for(;y=p();){let ot=$d[y],Gt=y;for(;L.length>2&&ot<=$d[L[L.length-2]];)C=L.pop(),y=L.pop(),v=L.pop(),k={type:1,operator:y,left:v,right:C},L.push(k);k=u(),k||s(`Expected expression after ${Gt}`),L.push(Gt,k)}let V=L.length-1;for(k=L[V];V>1;)k={type:1,operator:L[V-1],left:L[V-2],right:k},V-=2;return k}function g(){let v=f();if(n(),v&&i[e]==="?"){e+=1;let y=g();if(y||s("Expected expression"),n(),i[e]===":"){e++;let C=g();return C||s("Expected expression"),{type:3,test:v,consequent:y,alternate:C}}else s("Expected :")}else return v}let w=g();return e<i.length&&s(`Unexpected "${i[e]}"`),w}var no=[void 0,void 0];function me(i,t,e){switch(i.type){case 0:let s=i.elements.map(w=>me(w,t,e)[0]);return s.some(w=>w===void 0)?no:[s,void 0];case 1:let n=me(i.left,t,e)[0],o=me(i.right,t,e)[0];return"+-**/%".includes(i.operator)&&(n===void 0||o===void 0)?no:[yd[i.operator](n,o),void 0];case 2:let[r,a]=me(i.callee,t,e),l=i.args.map(w=>me(w,t,e)[0]);return l.some(w=>w===void 0)||typeof r!="function"?no:[r.apply(a,l),void 0];case 3:let c=me(i.consequent,t,e),p=me(i.alternate,t,e);return me(i.test,t,e)[0]?c:p;case 4:return[e[i.name]||t[i.name],void 0];case 5:return[i.value,void 0];case 6:let u=me(i.object,t,e)[0],f=i.computed?me(i.property,t,e)[0]:i.property.name;return u?[u[f],u]:[void 0,void 0];case 7:let g=me(i.argument,t,e)[0];return g===void 0&&i.operator!=="!"?no:[bd[i.operator](g),void 0]}}function Pt(i){let t=b0(i);return t?(e={},s={})=>me(t,e,s)[0]:(e={})=>{}}var $0=/\${([^}]+)}/g;function oo(i){let t=i.split($0),e=t.map((s,n)=>n%2?Pt(s.replace(/×/g,"*")):void 0);return s=>t.map((n,o)=>{if(!(o%2))return n;let r=e[o](s);return typeof r=="number"&&r<0?`\u2013${-r}`:r}).join("")}var sn="ontouchstart"in window,gs="onpointerdown"in window;function he(i){if(i.touches){let t=i.targetTouches.length?i.targetTouches:i.changedTouches;return new d(t[0].clientX,t[0].clientY)}else return new d(i.clientX||0,i.clientY||0)}function x0(i){return i.touches||[]}function ge(i,t){return he(i).transform(t.inverseTransformMatrix)}function Pd(i,t){let e=he(i),s=t.bounds,n=(e.x-s.left)*t.canvasWidth/s.width,o=(e.y-s.top)*t.canvasHeight/s.height;return new d(n,o)}function P0(i){if(i instanceof PointerEvent&&i.pointerType==="mouse")return G(i.target);let t=he(i);return G(document.elementFromPoint(t.x,t.y)||void 0)}function S0(i){if(i._data.tapEvent)return;i._data.tapEvent=!0;let t;i.on("pointerdown",e=>t=he(e)),i.on("pointerup",e=>{if(!t)return;let s=he(e);d.distance(t,s)<6&&i.trigger("tap",e),t=void 0}),i.on("pointercancel",()=>t=void 0)}function T0(i){i._data.clickOutsideEvent||(i._data.clickOutsideEvent=!0,W.on("pointerdown",t=>{var e,s;let n=t.target,o=(s=(e=i._el).getRootNode)==null?void 0:s.call(e),r=he(t);(o==null?void 0:o.host)&&(n=o.elementFromPoint(r.x,r.y)),!(!n||i._el===n||i._el.contains(n))&&i.trigger("clickOutside",t)}))}function Ii(i,t){let e=t.$box||i,s=he;e.type==="svg"?s=f=>ge(f,e.$ownerSVG):e.type==="canvas"&&(s=f=>Pd(f,e));let n=t.justInside?i:W,o,r,a=!1,l=0;i.css("touch-action")==="auto"&&i.css("touch-action","none"),i.addClass("noselect");function c(f){f.handled||x0(f).length>1||(f.preventDefault(),a=!1,l=f.pointerId||0,n.on("pointermove",p),n.on("pointerstop",u),o=r=s(f),t.down&&t.down(o))}function p(f){if(!o||l&&f.pointerId!==l)return;f.preventDefault();let g=s(f);d.distance(g,r)<.5||(!a&&t.start&&t.start(o),t.move&&t.move(g,o,r),r=g,a=!0)}function u(f,g=!1){!o||l&&f.pointerId!==l||(f.preventDefault(),n.off("pointermove",p),n.off("pointerstop",u),t.up&&t.up(r,o),a&&t.end&&t.end(r,o),!a&&t.click&&!g&&t.click(o),o=void 0)}b.onKey("escape",()=>{if(!o)return;a&&t.move&&t.move(o,o,r),r=o;let f=document.createEvent("MouseEvent");f.pointerId=l,u(f,!0)}),i.on("pointerdown",c),t.justInside&&i.on("mouseleave",u),t.accessible&&(i.setAttr("tabindex","0"),document.addEventListener("keydown",f=>{if(![37,38,39,40].includes(f.keyCode)||i!==b.getActiveInput())return;let g=i.boxCenter,w=s({clientX:g.x,clientY:g.y}),v=f.keyCode===37?-25:f.keyCode===39?25:0,y=f.keyCode===38?-25:f.keyCode===40?25:0,C=w.shift(v,y);t.down&&t.down(w),t.start&&t.start(w),t.move&&t.move(C,w,w),t.end&&t.end(C,w)}))}function Sd(i,t){let e=he;i.type==="svg"?e=n=>ge(n,i.$ownerSVG):i.type==="canvas"&&(e=n=>Pd(n,i));let s=!1;i.on("touchstart mouseenter",n=>{!s&&t.enter&&t.enter(),t.move&&t.move(e(n)),s=!0},{passive:!0}),i.on("pointermove",n=>{s&&t.move&&t.move(e(n))}),i.on("touchend mouseleave",()=>{s&&t.exit&&t.exit(),s=!1},{passive:!0})}function C0(i){if(i._data.scrollEvents)return;i._data.scrollEvents=!0;let t=!1,e;function s(){let l=i.scrollTop;if(l===e){t=!1;return}e=l,i.trigger("scroll",{top:e}),window.requestAnimationFrame(s)}function n(){t||window.requestAnimationFrame(s),t=!0}(i.type==="window"?window:i._el).addEventListener("scroll",n);function r(){window.addEventListener("touchmove",n),window.addEventListener("touchend",a)}function a(){window.removeEventListener("touchmove",n),window.removeEventListener("touchend",a)}i._el.addEventListener("touchstart",function(l){l.handled||r()})}function vs(i,t){let e=t.$clickTarget||i,s=0,n=!1,o=!1,r=!1;function a(){n||(t.enter&&t.enter(),n=!0)}function l(){!n||(clearTimeout(s),t.exit&&t.exit(),n=!1)}i.on("mouseover",()=>{t.preventMouseover&&t.preventMouseover()||(clearTimeout(s),s=xe(()=>{a(),o=!0},t.delay))}),i.on("mouseout",()=>{!o||(clearTimeout(s),s=xe(l,t.exitDelay||t.delay))}),e.on("focus",()=>{n||t.preventMouseover&&t.preventMouseover()||(clearTimeout(s),a(),r=!0)});let c=()=>{!r||(t.canFocusWithin?setTimeout(()=>{let p=b.getActiveInput();p&&p.hasParent(i)?p.one("blur",c):l()}):l())};e.on("blur",c),e.on("click",()=>{n&&!o?l():n||(a(),o=!1)}),i.on("clickOutside",l)}var Kr;function M0(i){for(let t of i){let e=t.isIntersecting?"enterViewport":"exitViewport";setTimeout(()=>G(t.target).trigger(e))}}function Td(i){if(!i._data.intersectionEvents){if(i._data.intersectionEvents=!0,!window.IntersectionObserver){let t=!1;W.on("scroll",()=>{let e=i.isInViewport;t&&!e?(i.trigger("exitViewport"),t=!1):e&&!t&&(i.trigger("enterViewport"),t=!0)});return}Kr||(Kr=new IntersectionObserver(M0)),Kr.observe(i._el)}}function E0(i,t=!1){if(t&&(i._data.resizeObserver&&i._data.resizeObserver.disconnect(),i._data.resizeObserver=void 0),!i._data.resizeObserver){if(window.ResizeObserver){let e=new window.ResizeObserver(()=>i.trigger("resize"));e.observe(i._el),i._data.resizeObserver=e}else if(window.MutationObserver){let e=new MutationObserver(()=>i.trigger("resize"));e.observe(i._el,{attributes:!0,childList:!0,characterData:!0,subtree:!0}),i._data.resizeObserver=e}}}function Cd(i){if(i._data.pointerPositionEvents)return;i._data.pointerPositionEvents=!0;let t=i.parent,e;t.on("pointerend",()=>e=void 0),t.on("pointermove",s=>{let n=e,o=P0(s);e=o.equals(i)||o.hasParent(i),n!==void 0&&e&&!n&&i.trigger("pointerenter",s),!e&&n&&i.trigger("pointerleave",s)})}function Xr(i,t){t._data[`_${i}`]||(t._data[`_${i}`]=!0,gs?t.on(i.replace("mouse","pointer"),e=>{e.pointerType==="mouse"&&t.trigger(i,e)}):sn||t._el.addEventListener(i,e=>t.trigger(i,e)))}function A0(i){i.on("keydown",t=>{if(t.metaKey||t.ctrlKey||b.isAndroid&&t.keyCode===229)return;let e=t.key||String.fromCharCode(t.which),s=e.toLowerCase(),n=!!t.shiftKey;i.trigger("key",{code:t.keyCode,key:s,char:e,shift:n})}),b.isAndroid&&i.type==="input"&&i.on("input",t=>{let e=t.data[t.data.length-1],s=e.toLowerCase();i.trigger("key",{code:void 0,key:s,char:e}),i.value=""})}var ro={scrollwheel:"DOMMouseScroll mousewheel",pointerdown:gs?"pointerdown":sn?"touchstart":"mousedown",pointermove:gs?"pointermove":sn?"touchmove":"mousemove",pointerup:gs?"pointerup":sn?"touchend":"mouseup",pointercancel:gs?"pointercancel":"touchcancel",pointerstop:gs?"pointerup pointercancel":sn?"touchend touchcancel":"mouseup"},ao={scroll:C0,tap:S0,clickOutside:T0,key:A0,mousedown:Xr.bind(void 0,"mousedown"),mousemove:Xr.bind(void 0,"mousemove"),mouseup:Xr.bind(void 0,"mouseup"),pointerenter:Cd,pointerleave:Cd,enterViewport:Td,exitViewport:Td,resize:E0};function k0(i,t,e,s){if(t in ao)ao[t](i,!1);else if(t in ro){let n=lt(ro[t]);for(let o of n)i._el.addEventListener(o,e,s)}else i._el.addEventListener(t,e,s)}function V0(i,t,e){if(t in ao)(!i._events[t]||!i._events[t].length)&&ao[t](i,!0);else if(e&&t in ro){let s=lt(ro[t]);for(let n of s)i._el.removeEventListener(n,e)}else e&&i._el.removeEventListener(t,e)}var lo=0,Yr=new Map;function Md(i,t){Yr.set(i,t)}function O0(i){if(lo++,i(),lo--,lo===0){for(let[t,e]of Yr.entries())t(e);Yr.clear()}}function mt(i,t){let e=new Map,s=new Map,n=new Set,o,r=0;function a(L){o=L;let V=L(k,!0);return o=void 0,V}function l(L){for(let V of e.values())V.has(L)&&V.delete(L);n.delete(L)}function c(L,V){return n.add(L),V?void 0:L(k,!0)}function p(L,V){s.has(L)&&l(s.get(L));let ot=()=>{i[L]=V(k),o===ot&&(o=void 0),u(L)};s.set(L,ot),a(ot)}function u(L){if(lo>0){for(let V of e.get(L)||[])Md(V,i);for(let V of n)Md(V,i)}else{for(let V of e.get(L)||[])V(i);for(let V of n)V(i)}}function f(){for(let L of e.values())for(let V of L)V(i);for(let L of n)L(i)}function g(L,V){V&&(i={}),O0(()=>{for(let[ot,Gt]of Object.entries(L))k[ot]=Gt})}function w(){for(r+=1;`_x${r}`in i;)r+=1;return`_x${r}`}function v(){i={},e.clear(),s.clear(),r=0}function y(){return Object.assign({},i)}function C(L){!t||t.watch(()=>k[L]=t[L])}let k=new Proxy(i,{get(L,V){return V==="watch"?a:V==="unwatch"?l:V==="watchAll"?c:V==="setComputed"?p:V==="forceUpdate"?f:V==="assign"?g:V==="getKey"?w:V==="clear"?v:V==="copy"?y:V==="_internal"?[i,e]:(o&&(e.has(V)||e.set(V,new Set),e.get(V).add(o)),V in i||C(V),i[V])},set(L,V,ot){return i[V]===ot||(i[V]=ot,s.has(V)&&(l(s.get(V)),s.delete(V)),u(V)),!0},deleteProperty(L,V){return delete i[V],e.delete(V),s.delete(V),!0}});return k}var L0={A:7,C:6,H:1,L:2,M:2,Q:4,S:4,T:2,V:1,Z:0},R0=/[astvzqmhlc]([^astvzqmhlc]*)/ig,I0=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function ho(i){let t=[],e;for(let s of i.match(R0)||[]){let n=s[0].toUpperCase();if(n==="Z"){t.push({type:"Z",points:[]});continue}let o=(s.slice(1).match(I0)||[]).map(a=>+a),r=n===s[0];for(let[a,l]of ls(o,L0[n]).entries()){let c=[],p=n==="M"&&a>0?"L":n,u;n==="H"?(p="L",c=[new d(l[0],r&&(e==null?void 0:e.y)||0)]):n==="V"?(p="L",c=[new d(r&&(e==null?void 0:e.x)||0,l[0])]):n==="A"?(p="A",c=[new d(l[5],l[6])],u=l.slice(0,5)):"MLCSQT".includes(n)&&(c=ls(l,2).map(f=>new d(f[0],f[1]))),!r&&e&&(c=c.map(f=>f.translate(e))),e=_(c),t.push({type:p,points:c,options:u})}}return t}function Ni(i){return i?ho(i).map(e=>_(e.points)).filter(e=>!!e):[]}var N0=["font-family","font-size","font-style","font-weight","letter-spacing","text-decoration","color","display","visibility","alignment-baseline","baseline-shift","opacity","text-anchor","clip","clip-path","clip-rule","mask","filter","transform","transform-origin","white-space","line-height"],G0=["fill","fill-rule","marker","marker-start","marker-mid","marker-end","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-width","text-rendering","dominant-baseline","transform-box","paint-order"],D0=["padding","min-width","max-width","height","border-width","border-style","border-color","box-sizing","background","width","grid-template-columns","text-align"],_0=["class","tabindex","contenteditable"],H0=new Set(["opacity","transform-box","transform-origin","border-width","border-style","border-color"]),q0={"font-style":"normal","font-weight":"400","letter-spacing":"normal","text-decoration":"none",display:"block",visibility:"visible","alignment-baseline":"auto","baseline-shift":"0px","text-anchor":"start",clip:"auto","clip-path":"none","clip-rule":"nonzero",mask:"none",opacity:"1",filter:"none",fill:"rgb(0, 0, 0)","fill-rule":"nonzero",marker:"none",stroke:"none","stroke-dasharray":"none","stroke-dashoffset":"0px","stroke-linecap":"butt","stroke-linejoin":"miter","stroke-width":"1px","text-rendering":"auto",transform:"none","dominant-baseline":"auto","transform-origin":"0px 0px","transform-box":"view-box","paint-order":"normal"};function Ed(i){var t,e;if(i.getAttribute("hidden")||i.style.opacity==="0"||i.style.display==="none")(t=i.parentNode)==null||t.removeChild(i);else{for(let s of Array.from(i.children))Ed(s);if(i.tagName==="g"&&i.childElementCount===0)(e=i.parentNode)==null||e.removeChild(i);else for(let s of _0)i.hasAttribute(s)&&i.removeAttribute(s)}}function B0(i,t){let e=i.parentElement;for(;e;){let s=e.style.getPropertyValue(t);if(s)return s;e=e.parentElement}}function Ad(i,t,e=!1){let s=window.getComputedStyle(i);t.removeAttribute("style");let n=e||i.tagName==="foreignObject",o=[...N0,...n?D0:G0];for(let l of o){let c=s.getPropertyValue(l),p=B0(t,l);c===q0[l]&&!p||!H0.has(l)&&c===p||t.style.setProperty(l,c)}let r=i.children,a=t.children;for(let l=0;l<a.length;++l)Ad(r[l],a[l],n)}var kd=class{constructor(i){this._el=i,this._data={},this._events={},this.type="default",i._view=this}get id(){return this._el.id}get data(){return this._el.dataset}get tagName(){return this._el.tagName.toUpperCase()}equals(i){return this._el===i._el}addClass(i){for(let t of lt(i))this._el.classList.add(t)}removeClass(i){for(let t of lt(i))this._el.classList.remove(t)}hasClass(i){return this._el.classList.contains(i)}toggleClass(i){return this._el.classList.toggle(i)}setClass(i,t){t?this.addClass(i):this.removeClass(i)}attr(i){return this._el.getAttribute(i)||""}hasAttr(i){return this._el.hasAttribute(i)}setAttr(i,t){t===void 0?this.removeAttr(i):this._el.setAttribute(i,t.toString())}removeAttr(i){this._el.removeAttribute(i)}get attributes(){return Array.from(this._el.attributes||[])}get html(){return this._el.innerHTML||""}set html(i){this._el.innerHTML=i}get text(){return this._el.textContent||""}set text(i){this._el.textContent=i}set textStr(i){this._el.textContent=`${i}`}blur(){this._el.blur()}focus(){this._el.focus()}getParentModel(){let i=this.parent;return i?i.model||i.getParentModel():void 0}bindModel(i,t=!0){var e;if(!this.model){if(this.model=i,this.hasAttr(":for"))return this.makeDynamicList(i);for(let{name:s,value:n}of this.attributes)this.makeDynamicAttribute(s,n,i);for(let s of this.childNodes)if(s instanceof Text){if((e=s.textContent)==null?void 0:e.includes("${")){let n=oo(s.textContent);i.watch(()=>s.textContent=n(i)||"")}}else t&&s.bindModel(i)}}bindVariable(i,t){}toggleDOM(i=!0){i!==!!this._el.parentNode&&(this.$placeholder||(this.$placeholder=G(document.createComment("")),this.insertBefore(this.$placeholder)),i?this.$placeholder.insertBefore(this):this.detach())}makeDynamicAttribute(i,t,e){if(i.startsWith("@")){let s=i.slice(1),n=Pt(t);this.on(s,o=>n(e,{$event:o}))}else if(i===":show"){let s=Pt(t);e.watch(()=>this.toggle(!!s(e)))}else if(i===":if"){let s=Pt(t);e.watch(()=>this.toggleDOM(!!s(e)))}else if(i===":html"){let s=Pt(t);e.watch(()=>this.html=s(e)||"")}else if(i===":draw"){let s=Pt(t);e.watch(()=>this.draw(s(e)))}else if(i===":class"){let s=Pt(t),n=`${this.attr("class")} `;e.watch(()=>this.setAttr("class",n+s(e)))}else if(i===":bind")this.bindVariable(e,t);else if(i.startsWith(":")){let s=Pt(t),n=i.slice(1);e.watch(()=>this.setAttr(n,s(e)))}else if(t.includes("${")){let s=oo(t);e.watch(()=>this.setAttr(i,s(e)||""))}(i.startsWith("@")||i.startsWith(":"))&&this.removeAttr(i)}makeDynamicList(i){let[t,e]=this.attr(":for").split(" in ");this.removeAttr(":for");let s=Pt(e),n=G(document.createComment(""));this.insertBefore(n),this.detach();let o=[],r=0;i.watch(()=>{let a=s(i);Array.isArray(a)||(a=[]);for(let l=a.length;l<r;++l)o[l].detach();for(let l=r;l<o.length;++l)n.insertBefore(o[l]);for(let l=o.length;l<a.length;++l){let c=this.copy(!0);c.bindModel(mt({[t]:void 0},i)),n.insertBefore(c),o.push(c)}r=a.length;for(let l=0;l<r;++l)o[l].model[t]=a[l]})}get bounds(){return this._el.getBoundingClientRect()}get boundsRect(){let i=this.bounds;return new x(new d(i.x,i.y),i.width,i.height)}contains(i){return this.boundsRect.contains(i)}get isInViewport(){if(this.height===0)return!1;let i=this.bounds;return it(i.top,-i.height,b.height)}get topLeftPosition(){let i=this.bounds;return new d(i.left,i.top)}get boxCenter(){let i=this.bounds;return new d(i.left+i.width/2,i.top+i.height/2)}get scrollWidth(){return this._el.scrollWidth}get scrollHeight(){return this._el.scrollHeight}get scrollTop(){return this._el.scrollTop}set scrollTop(i){this._el.scrollTop=i,this.trigger("scroll",{top:i,left:this.scrollLeft})}get scrollLeft(){return this._el.scrollLeft}set scrollLeft(i){this._el.scrollLeft=i,this.trigger("scroll",{top:this.scrollTop,left:i})}scrollTo(i,t=1e3,e="cubic"){i<0&&(i=0);let s=this.scrollTop,n=i-s;this._data.scrollAnimation&&this._data.scrollAnimation.cancel(),this._data.scrollAnimation=X(o=>{let r=s+n*rt(e,o);this.scrollTop=r,this.trigger("scroll",{top:r})},t)}scrollBy(i,t=1e3,e="cubic"){!i||this.scrollTo(this.scrollTop+i,t,e)}css(i,t){if(t===void 0){if(typeof i=="string")return window.getComputedStyle(this._el).getPropertyValue(i);{let e=Object.keys(i);for(let s of e)this._el.style.setProperty(s,`${i[s]}`)}}else typeof i=="string"&&this._el.style.setProperty(i,`${t}`)}get transform(){return this.css("transform").replace("none","")}get transformMatrix(){let i=this.transform;if(!i)return[[1,0,0],[0,1,0]];let t=i.match(/matrix\(([0-9,.\s-]*)\)/);if(!t||!t[1])return[[1,0,0],[0,1,0]];let e=t[1].split(",");return[[+e[0],+e[2],+e[4]],[+e[1],+e[3],+e[5]]]}get scale(){let i=this.transformMatrix;return[i[0][0],i[1][1]]}setTransform(i,t=0,e=1){let s="";i&&(s+=`translate(${ht(i.x,.1)}px,${ht(i.y,.1)}px)`),t&&(s+=` rotate(${t}rad)`),e&&(s+=` scale(${e})`),this._el.style.transform=s}translate(i,t){this.setTransform(new d(i,t))}show(){this.hasAttr("hidden")&&this.removeAttr("hidden"),this.data.display==="visibility"?this._el.style.visibility="visible":this._el.style.display=this.data.display||"block"}hide(){this.data.display==="visibility"?this._el.style.visibility="hidden":this._el.style.display="none"}toggle(i){i?this.show():this.hide()}is(i){return this._el.matches?this._el.matches(i):Array.from(document.querySelectorAll(i)).includes(this._el)}index(){let i=0,t=this._el;for(;(t=t.previousSibling||void 0)!==void 0;)++i;return i}prepend(i){let t=this._el.childNodes;t.length?this._el.insertBefore(i._el,t[0]):this._el.appendChild(i._el)}append(i){this._el.appendChild(i instanceof Text?i:i._el)}insertBefore(i){this.parent._el.insertBefore(i._el,this._el)}insertAfter(i){let t=this._el.nextSibling;t?this.parent._el.insertBefore(i._el,t):this.parent._el.appendChild(i._el)}get next(){return G(this._el.nextSibling)}get prev(){return G(this._el.previousSibling)}$(i){return G(i,this)}$$(i){return Ge(i,this)}get parent(){return G(this._el.parentElement||void 0)}parents(i){let t=[],e=this.parent;for(;e;)(!i||e.is(i))&&t.push(e),e=e.parent;return t}hasParent(...i){let t=i.map(s=>s._el),e=this._el.parentNode;for(;e;){if(Y(e,...t))return!0;e=e.parentNode}return!1}get children(){return Array.from(this._el.children||[],i=>G(i))}get childNodes(){return Array.from(this._el.childNodes,i=>{if(!(i instanceof Comment))return i instanceof Text?i:G(i)}).filter(i=>i)}restartAnimation(){let i=this.next,t=this.parent;this.detach(),i?i.insertBefore(this):t.append(this)}detach(){this._el&&this._el.parentNode&&this._el.parentNode.removeChild(this._el)}remove(){this.detach()}removeChildren(){for(;this._el.firstChild;)this._el.removeChild(this._el.firstChild)}copy(i=!0){return G(this._el.cloneNode(i))}on(i,t,e){for(let s of lt(i))s in this._events?this._events[s].includes(t)||this._events[s].push(t):this._events[s]=[t],k0(this,s,t,e)}one(i,t,e){let s=n=>{this.off(i,s),t(n)};this.on(i,s,e)}off(i,t){for(let e of lt(i))e in this._events&&(this._events[e]=t?this._events[e].filter(s=>s!==t):[]),V0(this,e,t)}trigger(i,t={}){for(let e of lt(i)){if(!this._events[e])return;for(let s of this._events[e])s.call(this,t)}}onKeyDown(i,t){let e=lt(i).map(s=>ne[s]||s);this._el.addEventListener("keydown",s=>{e.indexOf(s.keyCode)>=0&&t(s)})}onAttr(i,t){new MutationObserver(s=>{for(let n of s)n.type==="attributes"&&n.attributeName===i&&t(this.attr(i))}).observe(this._el,{attributes:!0}),t(this.attr(i),!0)}onPromise(i,t=!1){return t?Promise.resolve():new Promise(e=>this.one("solve",()=>e()))}animate(i,t=400,e=0,s="ease-in-out"){return oe(this,i,t,e,s)}enter(i="fade",t=500,e=0){return z0(this,i,t,e)}exit(i="fade",t=500,e=0,s=!1){return F0(this,i,t,e,s)}effect(i){this.one("animationend",()=>this.removeClass(`effects-${i}`)),this.addClass(`effects-${i}`)}},Gi=class extends kd{get offsetTop(){return this._el.offsetTop}get offsetLeft(){return this._el.offsetLeft}get offsetParent(){return G(this._el.offsetParent||void 0)}get width(){return this._el.offsetWidth}get height(){return this._el.offsetHeight}get innerWidth(){let i=parseFloat(this.css("padding-left")),t=parseFloat(this.css("padding-right"));return this._el.clientWidth-i-t}get innerHeight(){let i=parseFloat(this.css("padding-bottom")),t=parseFloat(this.css("padding-top"));return this._el.clientHeight-i-t}get outerWidth(){let i=parseFloat(this.css("margin-left")),t=parseFloat(this.css("margin-right"));return this.width+i+t||0}get outerHeight(){let i=parseFloat(this.css("margin-bottom")),t=parseFloat(this.css("margin-top"));return this.height+i+t||0}get positionTop(){let i=this._el,t=0;for(;i;)t+=i.offsetTop,i=i.offsetParent;return t}get positionLeft(){let i=this._el,t=0;for(;i;)t+=i.offsetLeft,i=i.offsetParent;return t}offset(i){if(i._el===this._el.offsetParent){let t=this.offsetTop+i._el.clientTop,e=this.offsetLeft+i._el.clientLeft,s=t+this.height,n=e+this.width;return{top:t,left:e,bottom:s,right:n}}else{let t=i._el.getBoundingClientRect(),e=this._el.getBoundingClientRect();return{top:e.top-t.top,left:e.left-t.left,bottom:e.bottom-t.top,right:e.right-t.left}}}},Vd=class extends kd{constructor(){super(...arguments);this.type="svg"}get $ownerSVG(){return G(this._el.ownerSVGElement||void 0)}get width(){return this.bounds.width}get height(){return this.bounds.height}get positionLeft(){let i=this._el.getBBox().x+this._el.getCTM().e;return this.$ownerSVG.positionLeft+i}get positionTop(){let i=this._el.getBBox().y+this._el.getCTM().f;return this.$ownerSVG.positionTop+i}get inverseTransformMatrix(){let i=this._el.getScreenCTM().inverse(),t=[[i.a,i.c,i.e],[i.b,i.d,i.f]];if(b.isFirefox){let e=this.transformMatrix;t[0][2]-=e[0][2],t[1][2]-=e[1][2]}return t}setTransform(i,t=0,e=1){let s=i?`translate(${ht(i.x,.1)} ${ht(i.y,.1)})`:"",n=P(t,0)?"":`rotate(${t*180/Math.PI})`,o=P(e,1)?"":`scale(${e})`;this.setAttr("transform",[s,n,o].join(" "))}get strokeLength(){if(this._el instanceof SVGGeometryElement)return this._el.getTotalLength();{let i=this.bounds;return 2*i.height+2*i.width}}getPointAtLength(i){if(this._el instanceof SVGGeometryElement){let t=this._el.getPointAtLength(i);return new d(t.x,t.y)}else return new d(0,0)}getPointAt(i){return this.getPointAtLength(i*this.strokeLength)}get points(){return Ni(this.attr("d"))}set points(i){let t=i.length?`M${i.map(e=>`${e.x},${e.y}`).join("L")}`:"";this.setAttr("d",t)}addPoint(i){let t=`${this.attr("d")} L ${i.x},${i.y}`;this.setAttr("d",t)}get center(){let i=+this.attr(this.tagName==="TEXT"?"x":"cx"),t=+this.attr(this.tagName==="TEXT"?"y":"cy");return new d(i,t)}setCenter(i){this.setAttr(this.tagName==="TEXT"?"x":"cx",i.x),this.setAttr(this.tagName==="TEXT"?"y":"cy",i.y)}setLine(i,t){this.setAttr("x1",i.x),this.setAttr("y1",i.y),this.setAttr("x2",t.x),this.setAttr("y2",t.y)}setRect(i){this.setAttr("x",i.p.x),this.setAttr("y",i.p.y),this.setAttr("width",i.w),this.setAttr("height",i.h)}draw(i,t={}){if(!i)return this.setAttr("d","");let e={mark:this.attr("mark"),arrows:this.attr("arrows"),size:+this.attr("size")||void 0,fill:this.hasClass("fill"),round:this.hasAttr("round")};this.setAttr("d",Bt(i,Object.assign(t,e)))}},j0=class extends Vd{get viewBox(){return this._el.viewBox.baseVal||{width:0,height:0}}get $ownerSVG(){return this}get positionLeft(){return parseInt(this.css("margin-left"))+this.parent.positionLeft}get positionTop(){return parseInt(this.css("margin-top"))+this.parent.positionTop}get svgWidth(){return this.viewBox.width||this.width}get svgHeight(){return this.viewBox.height||this.height}drawPath(i,t={},e={}){let s=h("path",t,this);return s.draw(i,e),s}image(i,t,e,s){return Ce(this,null,function*(){let n=this.copy(!0);if(Ad(this._el,n._el),i==="svg"&&Ed(n._el),e||(e=t||this.svgHeight),t||(t=this.svgWidth),n.setAttr("width",t),n.setAttr("height",e),n.setAttr("viewBox",s||this.attr("viewBox")||`0 0 ${this.svgWidth} ${this.svgHeight}`),n.setAttr("xmlns","http://www.w3.org/2000/svg"),i==="svg"){let c=n.$$('image[href^="/"]');for(let p of c)p.setAttr("href",`${location.protocol}//${location.host}${p.attr("href")}`)}else{let c=n.$$('image[href^="http"]');yield Promise.all(c.map(p=>Ce(this,null,function*(){let u=yield so(p.attr("href")),f=h("canvas",{width:u.width,height:u.height});f.ctx.drawImage(u,0,0,u.width,u.height);let g=yield f.image("png");p.setAttr("href",g)})))}let o=new XMLSerializer().serializeToString(n._el),r=`data:image/svg+xml;utf8,${encodeURIComponent(o)}`;if(i==="svg")return r;let a=h("canvas",{width:t,height:e});i==="jpg"&&(a.ctx.fillStyle="white",a.ctx.fillRect(0,0,t,e));let l=yield so(r);return a.ctx.drawImage(l,0,0,t,e),a.image(i)})}downloadImage(i,t,e,s){let n=b.isIOS?window.open("","_blank"):void 0,o=b.theme.isDark;o&&b.setTheme("light");let r=i.endsWith(".jpg")?"jpg":i.endsWith(".svg")?"svg":"png",a=this.image(r,t,e,s);o&&b.setTheme("dark"),a.then(l=>{if(n)return n.location.href=l;h("a",{download:i,href:l,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))})}},Od=class extends Gi{constructor(){super(...arguments);this.type="window"}get width(){return window.innerWidth}get height(){return window.innerHeight}get innerWidth(){return window.innerWidth}get innerHeight(){return window.innerHeight}get outerWidth(){return window.outerWidth}get outerHeight(){return window.outerHeight}get scrollWidth(){return document.body.scrollWidth}get scrollHeight(){return document.body.scrollHeight}get scrollTop(){return window.pageYOffset}set scrollTop(i){document.body.scrollTop=document.documentElement.scrollTop=i,this.trigger("scroll",{top:i,left:this.scrollLeft})}get scrollLeft(){return window.pageXOffset}set scrollLeft(i){document.body.scrollLeft=document.documentElement.scrollLeft=i,this.trigger("scroll",{top:this.scrollTop,left:i})}},U0=class extends Gi{constructor(){super(...arguments);this.type="form"}get action(){return this._el.action}get formData(){let i={};for(let t of Array.from(this._el.elements)){let e=t.name||t.id;e&&(i[e]=t.value)}return i}get isValid(){return this._el.checkValidity()}},Z0=class extends Gi{constructor(){super(...arguments);this.type="input"}get checked(){return this._el.checked||!1}set checked(i){this._el.checked=i}get value(){return this._el.value}set value(i){this._el.value=i}bindVariable(i,t){let e=this._el.type==="number",s=this._el.type==="checkbox";if(t in i?s?this.checked=i[t]:this.value=i[t]:this.value&&(s?i[t]=this.checked:i[t]=this.value),e){let n=this.hasAttr("min")?+this.attr("min"):-Infinity,o=this.hasAttr("max")?+this.attr("max"):Infinity;this.change(r=>i[t]=S(+r,n,o)),this.on("blur",()=>this.value=i[t])}else s?this.on("change",()=>i[t]=this.checked):this.change(n=>i[t]=n);i.watch(()=>{s?this.checked=i[t]:this.value=i[t],this.trigger("model-change",{defaultPrevented:!0})})}setInputPattern(i){if(isNaN(+i))return;let t=i.match(/^[0-9]+$/);this.setAttr("inputmode",t?"numeric":"decimal"),t&&this.setAttr("pattern","[0-9]*")}change(i){let t=this.value||"";this.on("change keyup input paste model-change",e=>{this.value!==t&&(t=this.value.trim(),e.defaultPrevented||i(t))})}validate(i){this.change(t=>this.setValidity(i(t)))}setValidity(i){this._el.setCustomValidity(i)}get isValid(){return this._el.checkValidity()}},W0=class extends Gi{constructor(){super(...arguments);this.type="canvas"}getContext(i="2d",t={}){return this._el.getContext(i,t)}image(i="png"){return this._el.toDataURL(i==="png"?"image/png":"image/jpeg")}get canvasWidth(){return this._el.width}get canvasHeight(){return this._el.height}get ctx(){return this._ctx||(this._ctx=this.getContext()),this._ctx}draw(i,t={}){this.ctx.save(),Ur(this.ctx,i,t),this.ctx.restore()}clear(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}fill(i){this.ctx.save(),this.ctx.fillStyle=i,this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.restore()}clearCircle(i,t){this.ctx.save(),this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,t,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.restore()}downloadImage(i){let t=this.image(i.endsWith(".jpg")?"jpg":"png");h("a",{download:i,href:t,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))}},K0=class extends Gi{play(){return this._el.play()||Promise.resolve()}pause(){return this._el.pause()}},Ld=["path","rect","circle","ellipse","polygon","polyline","g","defs","marker","line","text","tspan","pattern","mask","svg","foreignObject","image","use"];function G(i,t){if(!i)return;let e=t?t._el:document.documentElement,s=typeof i=="string"?e.querySelector(i):i;if(!s)return;if(s._view)return s._view;let n=(s.tagName||"").toLowerCase();return n==="svg"?new j0(s):n==="canvas"?new W0(s):n==="form"?new U0(s):n==="input"||n==="select"||n==="textarea"?new Z0(s):n==="video"||n==="audio"?new K0(s):Ld.includes(n)?new Vd(s):new Gi(s)}function Ge(i,t){let e=t?t._el:document.documentElement,s=i?e.querySelectorAll(i):[];return Array.from(s,n=>G(n))}function h(i,t={},e){let s=Ld.includes(i)?document.createElementNS("http://www.w3.org/2000/svg",i):document.createElement(i);for(let[o,r]of Object.entries(t))r!==void 0&&(o==="id"?s.id=r:o==="html"?s.innerHTML=r:o==="text"?s.textContent=r:o==="path"?s.setAttribute("d",Bt(r)):s.setAttribute(o,r));let n=G(s);return e&&e.append(n),n}var W=new Od(document.body),zt=new Od(document.documentElement),ne={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46},co="_M",ws=window.navigator.userAgent.toLowerCase(),Rd={};for(let[i,t]of Object.entries(ne))Rd[t]=i;var X0=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i,Id=/iphone|ipad|ipod/i,Y0=/^((?!chrome|android).)*safari/i,Nd,Q0=class{constructor(){this.isMobile=X0.test(ws),this.isRetina=(window.devicePixelRatio||1)>1,this.isTouch=!!window.Touch||"ontouchstart"in window,this.isChrome=!!window.chrome,this.isFirefox=ws.indexOf("firefox")>=0,this.isAndroid=ws.indexOf("android")>=0,this.isIOS=Id.test(ws),this.isSafari=Id.test(ws)||Y0.test(ws),this.loadQueue=[],this.loaded=!1,this.width=window.innerWidth,this.height=window.innerHeight,this.resizeCallbacks=[],this.theme={name:"light",isDark:!1},this.themeChangedCallbacks=[],this.themeOverride="",this.darkQuery=(Nd=window.matchMedia)==null?void 0:Nd.call(window,"(prefers-color-scheme: dark)");var i,t;window.onload=()=>this.afterLoad(),document.addEventListener("DOMContentLoaded",()=>this.afterLoad());let e=Le(()=>this.applyResize());window.addEventListener("resize",e);try{(i=this.darkQuery)==null||i.addEventListener("change",()=>this.applyThemeChange())}catch(n){(t=this.darkQuery)==null||t.addListener(()=>this.applyThemeChange())}let s=this.getCookie("theme");s&&this.setTheme(s);try{this.localStorage=window.localStorage}catch(n){console.warn("Unable to access Local Storage in this context.")}}afterLoad(){if(!this.loaded){this.loaded=!0;for(let i of this.loadQueue)i();setTimeout(()=>this.resize())}}ready(i){this.loaded?i():this.loadQueue.push(i)}redraw(){document.body.offsetHeight}applyResize(){let i=window.innerWidth,t=window.innerHeight;if(!(this.width===i&&this.height===t)){this.width=i,this.height=t;for(let e of this.resizeCallbacks)e({width:this.width,height:this.height});W.trigger("scroll",{top:W.scrollTop})}}onResize(i){i({width:this.width,height:this.height}),this.resizeCallbacks.push(i)}offResize(i){let t=this.resizeCallbacks.indexOf(i);t>=0&&this.resizeCallbacks.splice(t,1)}resize(){this.applyResize()}applyThemeChange(){let i=this.theme.name,t=i==="dark"||i==="auto"&&this.darkQuery.matches;if(t!==this.theme.isDark){this.theme.isDark=t,zt.setAttr("theme",this.themeOverride||(t?"dark":"light"));for(let e of this.themeChangedCallbacks)e(this.theme)}}setTheme(i){i!==this.theme.name&&(this.theme.name=i,this.setCookie("theme",i),this.applyThemeChange())}onThemeChange(i){this.themeChangedCallbacks.push(i)}getHash(){return window.location.hash.slice(1)}setHash(i){let t=document.body.scrollTop;window.location.hash=i,document.body.scrollTop=t}setURL(i,t=""){window.history.replaceState({},t,i),t&&(window.document.title=t)}getCookies(){let i=document.cookie.split(";"),t={};for(let e=0,s=i.length;e<s;++e){let n=i[e].split("=");t[decodeURIComponent(n[0]).trim()]=decodeURIComponent(n[1])}return t}getCookie(i){let t=document.cookie.match(new RegExp(`(^|;) ?${i}=([^;]*)(;|$)`));return t?t[2]:void 0}setCookie(i,t,e=60*60*24*365){let s=window.location.hostname.replace(/^[a-z]{2}\./,"");document.cookie=`${i}=${t};path=/;max-age=${e};domain=${s}`}deleteCookie(i){this.setCookie(i,"",-1)}setStorage(i,t){var e,s;let n=(i||"").split("."),o=ki(((e=this.localStorage)==null?void 0:e.getItem(co))||void 0,{}),r=o;for(let a=0;a<n.length-1;++a)r[n[a]]===void 0&&(r[n[a]]={}),r=r[n[a]];r[n[n.length-1]]=t,(s=this.localStorage)==null||s.setItem(co,JSON.stringify(o))}getStorage(i){var t;let e=ki((t=this.localStorage)==null?void 0:t.getItem(co),{});if(!i)return e;let s=(i||"").split("."),n=s.pop();for(let o of s){if(!(o in e))return;e=e[o]}return e[n]}deleteStorage(i){var t;i?this.setStorage(i,void 0):(t=this.localStorage)==null||t.setItem(co,"")}getActiveInput(){let i=document.activeElement;return(i==null?void 0:i.shadowRoot)&&(i=i.shadowRoot.activeElement),i===document.body?void 0:G(i)}onKey(i,t,e=!1){let s=lt(i),n=e?"keyup":"keydown";document.addEventListener(n,o=>{let r=Rd[o.keyCode]||o.key;if(!s.includes(r))return;let a=this.getActiveInput();a&&a.is("input, textarea, [contenteditable]")||a&&["space","enter","tab"].includes(r)&&a.is("button, a, [tabindex]")||t(o,r)})}},b=window.BoostBrowser||new Q0;window.BoostBrowser=b;var J0=/\bTrident\/[567]\b|\bMSIE (?:9|10)\.0\b/,t1=/\bAppleWebKit\/(\d+)\b/,e1=/\bEdge\/12\.(\d+)\b/,i1=J0.test(navigator.userAgent)||+(navigator.userAgent.match(e1)||[])[1]<10547||+(navigator.userAgent.match(t1)||[])[1]<537,Qr={};function s1(){if(!i1)return;Array.from(document.querySelectorAll("svg > use")).forEach(function(t){let e=t.getAttribute("xlink:href"),[s,n]=e.split("#");if(!s.length||!n)return;let o=t.parentNode;o.removeChild(t),s in Qr||(Qr[s]=fetch(s).then(a=>a.text())),Qr[s].then(a=>{let l=document.implementation.createHTMLDocument("");l.documentElement.innerHTML=a;let p=l.getElementById(n).cloneNode(!0),u=document.createDocumentFragment();for(;p.childNodes.length;)u.appendChild(p.firstChild);o.appendChild(u)})})}function Gd(){document.addEventListener("keydown",i=>{if(i.keyCode===ne.enter||i.keyCode===ne.space){let t=b.getActiveInput();t&&t.hasAttr("tabindex")&&t.tagName!=="TEXTAREA"&&(i.preventDefault(),t.trigger("pointerdown",i),t.trigger("pointerstop",i),W.trigger("pointerstop",i),t.trigger("click",i))}})}var po=!1;setTimeout(()=>po=!0);var n1="cubic-bezier(0.175, 0.885, 0.32, 1.275)",o1="cubic-bezier(0.68, -0.275, 0.825, 0.115)",Di={cancel:()=>{},promise:Promise.resolve()};function X(i,t){if(t===0)return i(1,0,()=>{}),Di;let e=Date.now(),s=di(),n=0,o=!0,r=()=>{o=!1,s.reject()};function a(){o&&(!t||n<=t)&&window.requestAnimationFrame(a);let l=Date.now()-e;i(t?Math.min(1,l/t):l,l-n,r),t&&l>=t&&s.resolve(),n=l}return a(),{cancel:r,promise:s.promise}}function uo(i,t=0,e=0){switch(i){case"quad":return t**2;case"cubic":return t**3;case"quart":return t**4;case"quint":return t**5;case"circ":return 1-Math.sqrt(1-t**2);case"sine":return 1-Math.cos(t*Math.PI/2);case"exp":return t<=0?0:Math.pow(2,10*(t-1));case"back":return e||(e=1.70158),t*t*((e+1)*t-e);case"elastic":return e||(e=.3),-Math.pow(2,10*(t-1))*Math.sin(((t-1)*2/e-.5)*Math.PI);case"swing":return .5-Math.cos(t*Math.PI)/2;case"spring":return 1-Math.cos(t*4.5*Math.PI)*Math.exp(-t*6);case"bounce":return t<1/11?1/64-7.5625*(.5/11-t)*(.5/11-t):t<3/11?1/16-7.5625*(2/11-t)*(2/11-t):t<7/11?1/4-7.5625*(5/11-t)*(5/11-t):1-7.5625*(1-t)*(1-t);default:return t}}function rt(i,t=0,e=0){if(t===0)return 0;if(t===1)return 1;let[s,n]=i.split("-");return n==="in"?uo(s,t,e):n==="out"?1-uo(s,1-t,e):t<=.5?uo(s,2*t,e)/2:1-uo(s,2*(1-t),e)/2}function oe(i,t,e=400,s=0,n="ease-in-out"){if(!po)return Object.keys(t).forEach(v=>{let y=t[v];i.css(v,Array.isArray(y)?y[1]:y)}),Di;n==="bounce-in"&&(n=n1),n==="bounce-out"&&(n=o1);let o="";b.isSafari&&(o=i._el.style.transition,i.css("transition","none"),b.redraw());let r=i._data.animation;r&&r.cancel();let a={},l={},c=di(),p=window.getComputedStyle(i._el);Object.keys(t).forEach(v=>{let y=t[v],C=Un(v);l[C]=Array.isArray(y)?y[0]:p.getPropertyValue(v),a[C]=Array.isArray(y)?y[1]:y,s&&i.css(v,l[C])});let u=a.height;if(a.height==="auto"){let v=i.children.filter(y=>y.css("position")!=="absolute");a.height=`${q(v.map(y=>y.outerHeight))}px`}let f,g=!1;xe(()=>{g||(f=i._el.animate([l,a],{duration:e,easing:n,fill:"forwards"}),f.onfinish=()=>{i._el&&Object.keys(t).forEach(v=>i.css(v,v==="height"?u:a[v])),b.isSafari&&i.css("transition",o),c.resolve(),f.cancel()})},s);let w={cancel(){g=!0,i._el&&Object.keys(t).forEach(v=>i.css(v,i.css(v))),f&&f.cancel()},promise:c.promise};return setTimeout(()=>i._data.animation=w),w}var r1=/matrix\([0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,([0-9.\-\s]+),([0-9.\-\s]+)\)/;function z0(i,t="fade",e=500,s=0){if(i.show(),!po)return Di;let n=+i.css("opacity")||1;if(t==="fade")return oe(i,{opacity:[0,n]},e,s);if(t==="pop"){let o=i.transform.replace(/scale\([0-9.]*\)/,"").replace(r1,"translate($1px,$2px)");return oe(i,{opacity:[0,n]},e,s),oe(i,{transform:[`${o} scale(0.5)`,`${o} scale(1)`]},e,s,"bounce-in")}else{if(t==="descend")return oe(i,{opacity:[0,1],transform:["translateY(-50%)","none"]},e,s);if(t.startsWith("draw")){let o=i.strokeLength;i.css("stroke-dasharray",`${o}px`),i.css("opacity")||i.css("opacity",1);let r=t==="draw-reverse"?`${2*o}px`:0,a={"stroke-dashoffset":[`${o}px`,r]},l=oe(i,a,e,s,"linear");return l.promise.then(()=>i.css("stroke-dasharray","")),l}else if(t.startsWith("slide")){let o={opacity:[0,n],transform:["translateY(50px)","none"]};return t.includes("down")&&(o.transform[0]="translateY(-50px)"),t.includes("right")&&(o.transform[0]="translateX(-50px)"),t.includes("left")&&(o.transform[0]="translateX(50px)"),oe(i,o,e,s)}else if(t.startsWith("reveal")){let o={opacity:[0,n],height:[0,"auto"]};return t.includes("left")&&(o.transform=["translateX(-50%)","none"]),t.includes("right")&&(o.transform=["translateX(50%)","none"]),oe(i,o,e,s)}}return Di}function F0(i,t="fade",e=400,s=0,n=!1){if(!i._el)return Di;if(!po)return i.hide(),Di;if(i.css("display")==="none")return Di;let o;if(t==="fade")o=oe(i,{opacity:[1,0]},e,s);else if(t==="pop"){let r=i.transform.replace(/scale\([0-9.]*\)/,"");oe(i,{opacity:[1,0]},e,s),o=oe(i,{transform:[`${r} scale(1)`,`${r} scale(0.5)`]},e,s,"bounce-out")}else if(t==="ascend")o=oe(i,{opacity:[1,0],transform:["none","translateY(-50%)"]},e,s);else if(t.startsWith("draw")){let r=i.strokeLength;i.css("stroke-dasharray",r);let l={"stroke-dashoffset":[t==="draw-reverse"?`${2*r}px`:0,`${r}px`]};o=oe(i,l,e,s,"linear")}else if(t.startsWith("slide")){let r={opacity:0,transform:"translateY(50px)"};t.includes("up")&&(r.transform="translateY(-50px)"),o=oe(i,r,e,s)}else if(t.startsWith("reveal")){let r={opacity:0,height:0};t.includes("left")&&(r.transform="translateX(-50%)"),t.includes("right")&&(r.transform="translateX(50%)"),o=oe(i,r,e,s)}return o.promise.then(()=>n?i.remove():i.hide()),o}var a1=Oi(["#cd0e66","#0f82f2","#22ab24","#fd8c00"]),l1=class{constructor(i){this.index=i,this.color=a1(),this.tilt=Math.floor(Math.random()*10)-10,this.tiltAngleIncrement=Math.random()*.07+.05,this.tiltAngle=0,this.x=Math.random()*b.width,this.y=(Math.random()-1)*b.height,this.r=tt.uniform(10,30)}draw(i){i.beginPath(),i.lineWidth=this.r/2,i.strokeStyle=this.color,i.moveTo(this.x+this.tilt+this.r/4,this.y),i.lineTo(this.x+this.tilt,this.y+this.tilt+this.r/4),i.stroke()}update(i,t){this.tiltAngle+=this.tiltAngleIncrement,this.y+=(Math.cos(i)+3+this.r/2)/2,this.x+=Math.sin(i),this.tilt=Math.sin(this.tiltAngle-this.index/3)*15,this.x<-20?(this.x=-20,this.y=Math.random()*b.height,this.tilt=Math.floor(Math.random()*10)-20):this.x>b.width+20?(this.x=b.width+20,this.y=Math.random()*b.height,this.tilt=Math.floor(Math.random()*10)-20):t&&this.y>b.height&&(this.x=Math.random()*b.width,this.y=-10,this.tilt=Math.floor(Math.random()*10)-20)}},h1="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999",_i=void 0;function Hi(i=2e3,t=150){_i||(_i=h("canvas",{style:h1},W)),_i.setAttr("width",b.width),_i.setAttr("height",b.height),_i.show();let e=_i.ctx,s=B(o=>new l1(o),t),n=X(o=>{e.clearRect(0,0,b.width,b.height);let r=o<i,a=0;for(let l of s)l.draw(e),l.update(o,r),l.y<b.height&&(a+=1);a||(n.cancel(),_i.hide())})}var qi=class extends Ye{constructor(i,t={}){super();this.$el=i,this.startPos=new d(0,0),this.position=new d(0,0),this.disabled=!1,this.options=Object.assign({moveX:!0,moveY:!0,withinBounds:!0},t),b.onResize(()=>this.updateBounds()),Ii(i,{start:()=>{this.disabled||(this.startPos=this.position,this.trigger("start"),zt.addClass("grabbing"))},move:(e,s)=>{this.disabled||(this.setPosition(this.startPos.x+e.x-s.x,this.startPos.y+e.y-s.y),this.trigger("drag",{posn:this.position,pointerPosn:e}),this.checkTarget(e))},end:(e,s)=>{this.disabled||(this.trigger(e.equals(s)?"click":"end",{$target:this.$over}),this.options.$targets&&!this.$over&&this.options.resetOnMiss&&this.resetPosition(),this.$over=void 0,zt.removeClass("grabbing"))},click:()=>this.trigger("click"),accessible:!0})}addTarget(i){var t;this.options.$targets||(this.options.$targets=[]),(t=this.options.$targets)==null||t.push(i)}removeTarget(i){var t,e;this.options.$targets=(t=this.options.$targets)==null?void 0:t.filter(s=>s!==i),((e=this.options.$targets)==null?void 0:e.length)||(this.options.$targets=void 0)}checkTarget(i){if(!this.options.$targets)return;let t=this.options.$targets.find(e=>e.boundsRect.contains(i));t!==this.$over&&(this.$over&&this.trigger("exit-target",{$target:this.$over}),t&&this.trigger("enter-target",{$target:t}),this.$over=t)}updateBounds(){if(!this.options.withinBounds)return this.bounds=void 0;if(this.options.bounds)return this.bounds=this.options.bounds;let i=this.bounds,t=this.options.$parent||this.$el.parent,e=t.type==="svg"?t.svgWidth:t.width,s=t.type==="svg"?t.svgHeight:t.height;this.bounds=new At(0,e,0,s),!e&&!s&&setTimeout(()=>this.updateBounds()),i&&this.setPosition(this.position.x*this.bounds.dx/i.dx||0,this.position.y*this.bounds.dy/i.dy||0)}setPosition(i,t){var e;let s=new d(this.options.moveX?i:0,this.options.moveY?t:0);this.bounds&&(s=s.clamp(this.bounds,(e=this.options.margin)!=null?e:0)),s=s.round(this.options.snap||1),this.options.round&&(s=this.options.round(s)),!s.equals(this.position)&&(this.position=s,this.options.useTransform?this.$el.translate(s.x,s.y):(this.options.moveX&&this.$el.css("left",`${s.x}px`),this.options.moveY&&this.$el.css("top",`${s.y}px`)),this.trigger("move",{posn:s}))}resetPosition(i=250){return Ce(this,null,function*(){let t=this.position;this.$el.css({"pointer-events":"none"}),yield X(e=>{let s=d.interpolate(t,this.startPos,e);this.setPosition(s.x,s.y)},i).promise,this.$el.css({"pointer-events":"initial"})})}},c1="position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #0f82f2; pointer-events: none; z-index: 9999; will-change: transform;";function Dd(i,t){let e=t.regex.exec(i);if(e){e.shift();let s={};for(let[n,o]of t.params.entries())s[o]=e[n];return s}else return}function d1(i,t,e){return Ce(this,null,function*(){return i.template?typeof i.template=="string"?i.template:i.template(t):(yield fetch(e+(e.indexOf("?")>=0?"&xhr=1":"?xhr=1"))).text()})}var _d=document.readyState==="complete";window.addEventListener("load",()=>setTimeout(()=>_d=!0));"scrollRestoration"in window.history&&(window.history.scrollRestoration="manual");var p1=class extends Ye{constructor(){super(...arguments);this.$viewport=W,this.views=[],this.active={path:"",hash:""},this.preloaded=!1,this.transition=!1,this.noLoad=!1,this.initialise=()=>{}}setup(i={}){i.$viewport&&(this.$viewport=i.$viewport),i.initialise&&(this.initialise=i.initialise),i.preloaded&&(this.preloaded=i.preloaded),i.transition&&(this.transition=i.transition),i.noLoad&&(this.noLoad=i.noLoad),i.click&&W.on("click",t=>this.onLinkClick(t)),i.history&&window.addEventListener("popstate",t=>Ce(this,null,function*(){var e;if(!_d||!((e=t.state)==null?void 0:e.path))return;(yield this.load(t.state.path,t.state.hash))||window.history.pushState(this.active,"",this.active.path+this.active.hash)}))}view(i,{enter:t,exit:e,template:s}={}){let n=(i.match(/:\w+/g)||[]).map(u=>u.substr(1)),o=`${i.replace(/:\w+/g,"([\\w-]+)").replace("/","\\/")}\\/?`,r=i.includes("?")?"":"(\\?.*)?",l={regex:new RegExp(`^${o}${r}$`,"i"),params:n,enter:t,exit:e,template:s};this.views.push(l);let c=window.location.pathname+window.location.search,p=Dd(c,l);!p||(this.active={path:c,hash:window.location.hash},window.history.replaceState(this.active,"",this.active.path+this.active.hash),b.ready(()=>{setTimeout(()=>{this.preloaded?(this.initialise(this.$viewport,p),l.enter&&l.enter(this.$viewport,p)):this.loadView(l,p)})}))}paths(...i){for(let t of i)this.view(t)}getView(i){for(let t of this.views){let e=Dd(i,t);if(e)return{view:t,params:e}}}load(i,t){return Ce(this,null,function*(){if(i===this.active.path&&t!==this.active.hash)return this.trigger("hashChange",t.slice(1)),this.trigger("change",i+t),this.active={path:i,hash:t},!0;let e=this.getView(i);return!e||this.beforeChange&&!(yield this.beforeChange())?!1:(this.active={path:i,hash:t},this.trigger("change",i+t),window.ga&&window.ga("send","pageview",i+t),this.noLoad?e.view.enter&&e.view.enter(this.$viewport,e.params):this.loadView(e.view,e.params),!0)})}loadView(i){return Ce(this,arguments,function*(t,e={}){this.showLoadingBar();let s=this.active.path,n=yield d1(t,e,s);if(this.active.path!==s)return;yield this.$viewport.animate({opacity:0},200).promise,this.$viewport.removeChildren(),W.scrollTop=0,this.$viewport.html=n,b.resize(),s1(),this.$viewport.animate({opacity:1},200),this.hideLoadingBar();let o=this.$viewport.$("title");o&&(document.title=o.text),this.initialise(this.$viewport,e),t.enter&&t.enter(this.$viewport,e),this.trigger("afterChange",{$viewport:this.$viewport})})}onLinkClick(i){if(i.metaKey||i.ctrlKey||i.shiftKey||i.defaultPrevented)return;let t=i.target;for(;t&&t.nodeName!=="A";)t=t.parentNode;if(!t||t.nodeName!=="A")return;let e=t;if(e.target||e.origin!==window.location.origin||e.hasAttribute("download")||e.getAttribute("rel")==="external")return;let s=e.getAttribute("href");s&&s.indexOf("mailto:")>-1||this.getView(e.pathname+e.search)&&(i.preventDefault(),this.goTo(e.pathname+e.search,e.hash))}goTo(i,t=""){return Ce(this,null,function*(){let e=this.active.path+this.active.hash;(yield this.load(i,t))&&e!==this.active.path+this.active.hash&&window.history.pushState(this.active,"",i+t)})}replace(i,t=""){this.active={path:i,hash:t},window.history.replaceState(this.active,"",i+t)}back(){window.history.back()}forward(){window.history.forward()}showLoadingBar(){this.$loadingBar||(this.$loadingBar=h("div",{style:c1},W)),this.$loadingBar.css({transform:"translateX(-100%)",opacity:1}),this.$loadingBar.show(),this.animation=X(i=>{this.$loadingBar.css("transform",`translateX(-${10+90*Math.exp(-4*i)}%)`)},3e3)}hideLoadingBar(){return Ce(this,null,function*(){var i,t,e;(i=this.animation)==null||i.cancel(),yield(t=this.$loadingBar)==null?void 0:t.animate({transform:"none",opacity:0}).promise,(e=this.$loadingBar)==null||e.hide()})}},nn=new p1;function u1(i,t){let e=Array.from(i.childNodes);i.innerHTML=t;let s={};for(let n of Array.from(i.querySelectorAll("slot")))s[n.getAttribute("name")||""]=n;for(let n of e){let o=n.getAttribute&&n.getAttribute("slot")||"",r=s[o]||s[""];r&&r.parentNode.insertBefore(n,r)}for(let n of Object.values(s))n.parentNode.removeChild(n)}function Hd(i){let t=[];for(let e of Array.from(i.children))e.tagName.startsWith("X-")?t.push(e):t.push(...Hd(e));return t}var qd=new Map,f1=class extends HTMLElement{constructor(){super(...arguments);this.wasConnected=!1,this.isReady=!1}connectedCallback(){return Ce(this,null,function*(){if(this.wasConnected){this._view.trigger("connected");return}this.wasConnected=!0,this.isReady=!1,this._view.created();let i=qd.get(this._view.tagName)||{};i.template&&u1(this,i.template);let t=Hd(this).filter(e=>!e.isReady).map(e=>new Promise(s=>e.addEventListener("ready",s)));yield Promise.all(t),this._view.ready(),this.dispatchEvent(new CustomEvent("ready")),this.isReady=!0})}disconnectedCallback(){this._view.trigger("disconnected")}},O=class extends Gi{created(){}ready(){}};function A(i,t={}){return function(e){if(window.customElements.get(i)){console.warn(`Trying to declare the custom element ${i} twice!`);return}class s extends f1{constructor(){super();this._view=new e(this)}}qd.set(i.toUpperCase(),t),window.customElements.define(i,s)}}var Jr=class{constructor(t){this.clipEndTime=0;this.player=new Audio(t),this.player.preload="true",this.player.addEventListener("timeupdate",()=>{this.player.currentTime>=this.clipEndTime&&this.triggerCallback(!0)}),window.addEventListener("beforeunload",()=>this.player.pause())}playClip(t,e,s){this.triggerCallback(!1),this.player.currentTime=t,this.clipEndTime=e,this.clipCallback=s,this.player.play()}triggerCallback(t){if(!this.clipCallback)return;let e=this.clipCallback;this.clipCallback=void 0,this.player.pause(),e({ended:t})}pause(){this.triggerCallback(!1)}get isPlaying(){return!!this.clipCallback}},ta=!1,ea,ia=class{constructor(t,e){this.audio=t;this.paragraphs=[];this.paragraphs=e.$$(".voice").map(s=>new Bd(s,t));for(let[s,n]of this.paragraphs.entries())n.on("end",()=>{var o;if(this.paragraphs[s+1])this.paragraphs[s+1].play();else{let r=e.nextStep;r&&r.isShown&&((o=r.narration)==null||o.play())}})}play(){var t;this.audio.isPlaying||!ta||(t=this.paragraphs[0])==null||t.play()}},Bd=class extends Ye{constructor(t,e){super();this.$p=t;this.audio=e;this.playing=void 0;this.sentences=t.$$(".sentence[data-timings]").map(s=>new zd(s,e)),this.$button=h("button",{class:"playback-btn",title:"Play Narration"}),this.$button.on("click",()=>{this.playing?this.audio.pause():this.play(),ta=!ta,ea=void 0}),t.prepend(this.$button),t.addClass("sentence-wrap");for(let[s,n]of this.sentences.entries())n.on("end",o=>{this.playing=void 0,o&&this.sentences[s+1]?setTimeout(()=>this.play(this.sentences[s+1]),200):(this.$button.removeClass("active"),o&&setTimeout(()=>this.trigger("end"),400))})}play(t){let e=t||this.sentences[0],s=e.$reveal;if(s&&s.css("visibility")==="hidden"){this.$button.removeClass("active"),ea=s,s.one("reveal",()=>{ea===s&&!this.audio.isPlaying&&this.play(e)});return}this.playing=e,this.playing.play(),this.$button.addClass("active");let n=this.$p.parents("x-tabbox .tab")[0];if(n){let a=n.parents("x-tabbox")[0];a.makeActive(n.index());let l=a.active;a.one("change",c=>{this.playing&&c!==l&&this.audio.pause()})}let o=this.$p.bounds,r=o.top+o.height-b.height+20;r>0&&W.scrollBy(r+100),setTimeout(()=>this.$button.focus(),800)}},zd=class extends Ye{constructor(t,e){super();this.$el=t;this.audio=e;let s=t.attr("data-timings").split("-");this.start=+s[0]/1e3,this.end=(+s[1]-200)/1e3}play(){this.$el.addClass("playing"),this.audio.playClip(this.start,this.end,({ended:t})=>{this.$el.removeClass("playing"),this.trigger("end",t)})}get $reveal(){return this.$el.parents(".reveal")[0]}};var m1=Object.defineProperty,g1=Object.getOwnPropertyDescriptor,on=(i,t,e,s)=>{for(var n=s>1?void 0:s?g1(t,e):t,o=i.length-1,r;o>=0;o--)(r=i[o])&&(n=(s?r(t,e,n):r(n))||n);return s&&n&&m1(t,e,n),n},Fd=(i,t,e)=>new Promise((s,n)=>{var o=l=>{try{a(e.next(l))}catch(c){n(c)}},r=l=>{try{a(e.throw(l))}catch(c){n(c)}},a=l=>l.done?s(l.value):Promise.resolve(l.value).then(o,r);a((e=e.apply(i,t)).next())}),ys,v1=h("div",{class:"snackbar"},W),jd=class extends O{ready(){var i;v1.append(this),(i=this.$("button"))==null||i.on("click",()=>this.close())}open(i=2e3){return Fd(this,null,function*(){ys!==this&&(ys&&(yield ys.close()),ys=this,yield this.enter("pop",300).promise,this.setAttr("role","alert"),i&&setTimeout(()=>this.close(),i))})}close(){return Fd(this,null,function*(){ys===this&&(ys=void 0,this.removeAttr("role"),yield this.exit("pop",300).promise)})}};jd=on([A("x-alert")],jd);var Ud=undefined,Zd=class extends O{ready(){if(this.children.length)return;let i=+this.attr("size")||24;this.css({width:`${i}px`,height:`${i}px`});let t=h("svg",{viewBox:"0 0 24 24"},this);if(t.css({width:`${i}px`,height:`${i}px`}),Ud)this.onAttr("name",e=>t.html=Ud[e]);else{let e=h("use",{},t);this.onAttr("name",s=>e.setAttr("href",`/icons.54b14688.svg#${s}`))}}};Zd=on([A("x-icon")],Zd);var Bi=h("div",{class:"modal-background"},W),sa,De=void 0,na=void 0;function oa(){De&&De.canClose&&De.close()}Bi.on("click",oa);b.onKey("escape",oa);nn.on("change",oa);Bi.on("scrollwheel touchmove",i=>{i.preventDefault(),i.stopPropagation()});b.onKey("space up down pagedown pageup",i=>{De&&(i.preventDefault(),i.stopPropagation())});var Wd=class extends O{constructor(){super(...arguments);this.isOpen=!1,this.canClose=!0}ready(){this.canClose=!this.hasAttr("no-close"),this.$iframe=this.$("iframe[data-src]"),this.$video=this.$("video");let i=Ge(`[data-modal=${this.id}]`);for(let e of i)e.on("click",()=>this.open());nn.on("afterChange",({$viewport:e})=>{let s=e.$$(`[data-modal=${this.id}]`);for(let n of s)n.on("click",()=>this.open())}),(this.hasClass("open")||b.getHash()===this.id)&&!De&&this.open(!0),this.$("input")&&this.addClass("interactive");let t=this.$(".close");t&&t.on("click",()=>this.close());for(let e of this.$$(".btn"))e.on("click",()=>this.trigger("btn-click",e))}open(i=!1){if(this.isOpen)return;Bi.setClass("light",this.hasClass("light")),De?De.close(!0):i?Bi.show():Bi.css("display")==="block"?sa==null||sa.cancel():Bi.enter("fade",250),this.isOpen=!0,De=this,this.$iframe&&this.$iframe.setAttr("src",this.$iframe.data.src),this.$video&&this.$video.play(),i?this.show():this.enter("pop",250).promise.then(()=>this.css("transform","")),this.setAttr("role","dialog"),this.trigger("open"),na=document.activeElement;let t=this.$('input, a, button, textarea, [tabindex="0"]');t&&t.focus()}close(i=!1,t=!1){!this.isOpen||(this.isOpen=!1,this.removeAttr("role"),De=void 0,this.$iframe&&this.$iframe.setAttr("src",""),this.$video&&this.$video.pause(),i||(sa=Bi.exit("fade",250)),this.exit("pop",250).promise.then(()=>this.css("transform","")),t||this.trigger("close"),na&&na.focus())}getOpenModal(){return De}};Wd=on([A("x-modal")],Wd);var Kd=class extends O{constructor(){super(...arguments);this.isOpen=!1}ready(){this.animation=this.attr("animation")||"pop",this.$bubble=this.$(".popup-body"),this.$bubble.hide(),this.$(".popup-target").on("click",()=>this.toggle()),this.on("clickOutside",()=>this.close());for(let t of this.$bubble.$$("a"))t.on("click",()=>this.close());b.onKey("escape",()=>this.close())}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen||(this.isOpen=!0,this.addClass("active"),this.$bubble.enter(this.animation,150),this.$bubble.setAttr("role","dialog"),this.$bubble.focus())}close(){!this.isOpen||(this.isOpen=!1,this.removeClass("active"),this.$bubble.exit(this.animation,150),this.$bubble.removeAttr("role"))}};Kd=on([A("x-popup")],Kd);var Xd=class extends O{constructor(){super(...arguments);this.$options={}}ready(){let i=this.children;this.$active=this.$(".active")||i[0],this.$active.addClass("active");for(let[t,e]of i.entries())!Y(e.tagName,"A","BUTTON")&&!e.hasAttr("tabindex")&&e.setAttr("tabindex",0),e.on("click",()=>this.makeActive(e)),this.$options[e.attr("value")||t]=e;this.trigger("change",this.$active)}makeActive(i){i!==this.$active&&(this.$active.removeClass("active"),this.$active=i,i.addClass("active"),this.trigger("change",i))}bindVariable(i,t){i[t]===void 0&&(i[t]=this.$active.attr("value")),this.on("change",e=>i[t]=e.attr("value")),i.watch(()=>{let e=this.$options[i[t]];e&&this.makeActive(e)})}};Xd=on([A("x-select")],Xd);var ra=12;function w1(i){return`M${i},${i/2}a${i/2},${i/2},0,0,1,0,${i}A${i/2},${i/2},0,0,1,${i},${i/2}`}function y1(i){return`M ${i},0 C ${i/2},0,0,${i/2},0,${i}  s ${i/2},${i},${i},${i} s ${i}-${i/2},${i}-${i}     S ${i*1.5},0,${i},0 z M ${i*44.6/50},${i*76.1/50} L ${i*19.2/50},${i*48.8/50} l ${i*4/50}-${i*4.2/50}     l ${i*19.8/50},${i*11.9/50} l ${i*34.2/50}-${i*32.6/50} l ${i*3.5/50},${i*3.5/50} L ${i*44.6/50},${i*76.1/50} z`}var aa=class extends O{constructor(){super(...arguments);this.completed=!1}ready(){this.r=+this.attr("r")||10,this.r1=this.r+ra,this.$svg=h("svg",{width:2*this.r1,height:2*this.r1},this),this.$progress=h("path",{class:"pie",d:w1(this.r),"stroke-width":this.r},this.$svg),this.onAttr("p",t=>this.setProgress(+t,!1))}setProgress(t,e=!0){if(t>.99)return this.complete(e);let s=Math.PI*this.r;this.$progress.css("stroke",t?"currentColor":"none"),this.$progress.css("stroke-dasharray",`${t*s} ${s}`)}complete(t=!0){if(this.completed||(this.completed=!0,this.$progress.css("stroke","none"),this.$progress.css("fill","currentColor"),this.$progress.setAttr("d",y1(this.r)),!t))return;let e=`translate(${this.r1} ${this.r1})`,s=h("g",{transform:e},this.$svg),n=B(()=>h("line",{},s),18);X(o=>{let r=this.r+ra*rt("quint-out",o),a=this.r+ra*o;for(let l=0;l<18;++l){let c=Math.cos(Math.PI*2*l/18),p=Math.sin(Math.PI*2*l/18);n[l].setLine({x:c*r,y:p*r},{x:c*a,y:p*a})}},800).promise.then(()=>s.remove())}};aa=N([A("x-progress")],aa);var Yd="2.4.1",la="i5iSjo",Qd="_av",ha="_au",ca="(not set)";var fo=[],mo=class{static add(t,e,s){Jd(t,e).add(s)}static remove(t,e,s){Jd(t,e).remove(s)}constructor(t,e){this.context=t,this.methodName=e,this.isTask=/Task$/.test(e),this.originalMethodReference=this.isTask?t.get(e):t[e],this.methodChain=[],this.boundMethodChain=[],this.wrappedMethod=(...s)=>this.boundMethodChain[this.boundMethodChain.length-1](...s),this.isTask?t.set(e,this.wrappedMethod):t[e]=this.wrappedMethod}add(t){this.methodChain.push(t),this.rebindMethodChain()}remove(t){let e=this.methodChain.indexOf(t);e>-1&&(this.methodChain.splice(e,1),this.methodChain.length>0?this.rebindMethodChain():this.destroy())}rebindMethodChain(){this.boundMethodChain=[];for(let t,e=0;t=this.methodChain[e];e++){let s=this.boundMethodChain[e-1]||this.originalMethodReference.bind(this.context);this.boundMethodChain.push(t(s))}}destroy(){let t=fo.indexOf(this);t>-1&&(fo.splice(t,1),this.isTask?this.context.set(this.methodName,this.originalMethodReference):this.context[this.methodName]=this.originalMethodReference)}},ei=mo;function Jd(i,t){let e=fo.filter(s=>s.context==i&&s.methodName==t)[0];return e||(e=new mo(i,t),fo.push(e)),e}var bs=window.Element.prototype,zb=bs.matches||bs.matchesSelector||bs.webkitMatchesSelector||bs.mozMatchesSelector||bs.msMatchesSelector||bs.oMatchesSelector;var x1="80",P1="443",t$=RegExp(":("+x1+"|"+P1+")$"),e$=document.createElement("a");function go(i,t,e=void 0,s=void 0,n=void 0,o=void 0){if(typeof s=="function"){let r=e.get("buildHitTask");return{buildHitTask:a=>{a.set(i,null,!0),a.set(t,null,!0),s(a,n,o),r(a)}}}else return gi({},i,t)}var da={};function ep(i,t){let e=i.get("trackingId"),s=da[e]=da[e]||{},n=()=>{clearTimeout(s.timeout),s.send&&ei.remove(i,"send",s.send),delete da[e],s.queue.forEach(o=>o())};clearTimeout(s.timeout),s.timeout=setTimeout(n,0),s.queue=s.queue||[],s.queue.push(t),s.send||(s.send=o=>(...r)=>{n(),o(...r)},ei.add(i,"send",s.send))}var gi=Object.assign||function(i,...t){for(let e=0,s=t.length;e<s;e++){let n=Object(t[e]);for(let o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])}return i};function ip(i){return i.charAt(0).toUpperCase()+i.slice(1)}function sp(i){return typeof i=="object"&&i!==null}function vi(){return+new Date}var rn=function i(t){return t?(t^Math.random()*16>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,i)};function pa(i,t){let e=window.GoogleAnalyticsObject||"ga";window[e]=window[e]||function(...s){(window[e].q=window[e].q||[]).push(s)},window.gaDevIds=window.gaDevIds||[],window.gaDevIds.indexOf(la)<0&&window.gaDevIds.push(la),window[e]("provide",i,t),window.gaplugins=window.gaplugins||{},window.gaplugins[ip(i)]=t}var ua=class{constructor(){this.registry_={}}on(t,e){this.getRegistry_(t).push(e)}off(t=void 0,e=void 0){if(t&&e){let s=this.getRegistry_(t),n=s.indexOf(e);n>-1&&s.splice(n,1)}else this.registry_={}}emit(t,...e){this.getRegistry_(t).forEach(s=>s(...e))}getEventCount(){let t=0;return Object.keys(this.registry_).forEach(e=>{t+=this.getRegistry_(e).length}),t}getRegistry_(t){return this.registry_[t]=this.registry_[t]||[]}},np=ua;var vo="autotrack",$s={},fa=!1,an,Me=class extends np{static getOrCreate(t,e,s){let n=[vo,t,e].join(":");return $s[n]||($s[n]=new Me(n,s),fa||T1()),$s[n]}static isSupported_(){if(an!=null)return an;try{window.localStorage.setItem(vo,vo),window.localStorage.removeItem(vo),an=!0}catch(t){an=!1}return an}static get_(t){return window.localStorage.getItem(t)}static set_(t,e){window.localStorage.setItem(t,e)}static clear_(t){window.localStorage.removeItem(t)}constructor(t,e={}){super();this.key_=t,this.defaults_=e,this.cache_=null}get(){if(this.cache_)return this.cache_;if(Me.isSupported_())try{this.cache_=ma(Me.get_(this.key_))}catch(t){}return this.cache_=gi({},this.defaults_,this.cache_)}set(t){if(this.cache_=gi({},this.defaults_,this.cache_,t),Me.isSupported_())try{Me.set_(this.key_,JSON.stringify(this.cache_))}catch(e){}}clear(){if(this.cache_={},Me.isSupported_())try{Me.clear_(this.key_)}catch(t){}}destroy(){delete $s[this.key_],Object.keys($s).length||C1()}},wo=Me;function T1(){window.addEventListener("storage",op),fa=!0}function C1(){window.removeEventListener("storage",op),fa=!1}function op(i){let t=$s[i.key];if(t){let e=gi({},t.defaults_,ma(i.oldValue)),s=gi({},t.defaults_,ma(i.newValue));t.cache_=s,t.emit("externalSet",s,e)}}function ma(i){let t={};if(i)try{t=JSON.parse(i)}catch(e){}return t}var M1=1e3,E1=60*M1,yo={},zi=class{static getOrCreate(t,e,s){let n=t.get("trackingId");return yo[n]?yo[n]:yo[n]=new zi(t,e,s)}constructor(t,e,s){this.tracker=t,this.timeout=e||zi.DEFAULT_TIMEOUT,this.timeZone=s,this.sendHitTaskOverride=this.sendHitTaskOverride.bind(this),ei.add(t,"sendHitTask",this.sendHitTaskOverride);try{this.dateTimeFormatter=new Intl.DateTimeFormat("en-US",{timeZone:this.timeZone})}catch(o){}let n={hitTime:0,isExpired:!1};this.store=wo.getOrCreate(t.get("trackingId"),"session",n),this.store.get().id||this.store.set({id:rn()})}getId(){return this.store.get().id}isExpired(t=this.getId()){if(t!=this.getId())return!0;let e=this.store.get();if(e.isExpired)return!0;let s=e.hitTime;if(s){let n=new Date,o=new Date(s);if(n-o>this.timeout*E1||this.datesAreDifferentInTimezone(n,o))return!0}return!1}datesAreDifferentInTimezone(t,e){return this.dateTimeFormatter?this.dateTimeFormatter.format(t)!=this.dateTimeFormatter.format(e):!1}sendHitTaskOverride(t){return e=>{t(e);let s=e.get("sessionControl"),n=s=="start"||this.isExpired(),o=s=="end",r=this.store.get();r.hitTime=vi(),n&&(r.isExpired=!1,r.id=rn()),o&&(r.isExpired=!0),this.store.set(r)}}destroy(){ei.remove(this.tracker,"sendHitTask",this.sendHitTaskOverride),this.store.destroy(),delete yo[this.tracker.get("trackingId")]}},ga=zi;zi.DEFAULT_TIMEOUT=30;var va={CLEAN_URL_TRACKER:1,EVENT_TRACKER:2,IMPRESSION_TRACKER:3,MEDIA_QUERY_TRACKER:4,OUTBOUND_FORM_TRACKER:5,OUTBOUND_LINK_TRACKER:6,PAGE_VISIBILITY_TRACKER:7,SOCIAL_WIDGET_TRACKER:8,URL_CHANGE_TRACKER:9,MAX_SCROLL_TRACKER:10},rp=Object.keys(va).length;function ap(i,t){k1(i),A1(i,t)}function V1(i){return parseInt(i||"0",16).toString(2)}function O1(i){return parseInt(i||"0",2).toString(16)}function L1(i,t){if(i.length<t){let e=t-i.length;for(;e;)i="0"+i,e--}return i}function R1(i,t){return i.substr(0,t)+1+i.substr(t+1)}function A1(i,t){let e=i.get("&"+ha),s=L1(V1(e),rp);s=R1(s,rp-t),i.set("&"+ha,O1(s))}function k1(i){i.set("&"+Qd,Yd)}var ln="hidden",_e="visible",xs=rn(),lp=1e3,hp=class{constructor(t,e){if(ap(t,va.PAGE_VISIBILITY_TRACKER),!document.visibilityState)return;let s={sessionTimeout:ga.DEFAULT_TIMEOUT,visibleThreshold:5*lp,sendInitialPageview:!1,fieldsObj:{}};this.opts=gi(s,e),this.tracker=t,this.lastPageState=document.visibilityState,this.visibleThresholdTimeout_=null,this.isInitialPageviewSent_=!1,this.trackerSetOverride=this.trackerSetOverride.bind(this),this.handleChange=this.handleChange.bind(this),this.handleWindowUnload=this.handleWindowUnload.bind(this),this.handleExternalStoreSet=this.handleExternalStoreSet.bind(this),this.store=wo.getOrCreate(t.get("trackingId"),"plugins/page-visibility-tracker"),this.store.on("externalSet",this.handleExternalStoreSet),this.session=ga.getOrCreate(t,this.opts.sessionTimeout,this.opts.timeZone),ei.add(t,"set",this.trackerSetOverride),window.addEventListener("unload",this.handleWindowUnload),document.addEventListener("visibilitychange",this.handleChange),ep(this.tracker,()=>{document.visibilityState==_e?(this.opts.sendInitialPageview&&(this.sendPageview({isPageLoad:!0}),this.isInitialPageviewSent_=!0),this.store.set({time:vi(),state:_e,pageId:xs,sessionId:this.session.getId()})):this.opts.sendInitialPageview&&this.opts.pageLoadsMetricIndex&&this.sendPageLoad()})}handleChange(){if(!(document.visibilityState==_e||document.visibilityState==ln))return;let t=this.getAndValidateChangeData(),e={time:vi(),state:document.visibilityState,pageId:xs,sessionId:this.session.getId()};document.visibilityState==_e&&this.opts.sendInitialPageview&&!this.isInitialPageviewSent_&&(this.sendPageview(),this.isInitialPageviewSent_=!0),document.visibilityState==ln&&this.visibleThresholdTimeout_&&clearTimeout(this.visibleThresholdTimeout_),this.session.isExpired(t.sessionId)?(this.store.clear(),this.lastPageState==ln&&document.visibilityState==_e&&(clearTimeout(this.visibleThresholdTimeout_),this.visibleThresholdTimeout_=setTimeout(()=>{this.store.set(e),this.sendPageview({hitTime:e.time})},this.opts.visibleThreshold))):(t.pageId==xs&&t.state==_e&&this.sendPageVisibilityEvent(t),this.store.set(e)),this.lastPageState=document.visibilityState}getAndValidateChangeData(){let t=this.store.get();return this.lastPageState==_e&&t.state==ln&&t.pageId!=xs&&(t.state=_e,t.pageId=xs,this.store.set(t)),t}sendPageVisibilityEvent(t,{hitTime:e}={}){let s=this.getTimeSinceLastStoredChange(t,{hitTime:e});if(s&&s>=this.opts.visibleThreshold){let n=Math.round(s/lp),o={transport:"beacon",nonInteraction:!0,eventCategory:"Page Visibility",eventAction:"track",eventValue:n,eventLabel:ca};e&&(o.queueTime=vi()-e),this.opts.visibleMetricIndex&&(o["metric"+this.opts.visibleMetricIndex]=n),this.tracker.send("event",go(o,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}}sendPageLoad(){let t={transport:"beacon",eventCategory:"Page Visibility",eventAction:"page load",eventLabel:ca,["metric"+this.opts.pageLoadsMetricIndex]:1,nonInteraction:!0};this.tracker.send("event",go(t,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}sendPageview({hitTime:t,isPageLoad:e}={}){let s={transport:"beacon"};t&&(s.queueTime=vi()-t),e&&this.opts.pageLoadsMetricIndex&&(s["metric"+this.opts.pageLoadsMetricIndex]=1),this.tracker.send("pageview",go(s,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}trackerSetOverride(t){return(e,s)=>{let n=sp(e)?e:{[e]:s};n.page&&n.page!==this.tracker.get("page")&&this.lastPageState==_e&&this.handleChange(),t(e,s)}}getTimeSinceLastStoredChange(t,{hitTime:e}={}){return t.time?(e||vi())-t.time:0}handleExternalStoreSet(t,e){t.time!=e.time&&e.pageId==xs&&e.state==_e&&!this.session.isExpired(e.sessionId)&&this.sendPageVisibilityEvent(e,{hitTime:t.time})}handleWindowUnload(){this.lastPageState!=ln&&this.handleChange()}remove(){this.store.destroy(),this.session.destroy(),ei.remove(this.tracker,"set",this.trackerSetOverride),window.removeEventListener("unload",this.handleWindowUnload),document.removeEventListener("visibilitychange",this.handleChange)}};pa("pageVisibilityTracker",hp);Gd();zt.addClass((b.isMobile?"is":"not")+"-mobile");b.isSafari&&zt.addClass("is-safari");setTimeout(()=>zt.addClass("ready"));window.addEventListener("keydown",i=>{i.keyCode===9&&zt.addClass("is-tabbing")});window.addEventListener("mousedown",()=>{zt.removeClass("is-tabbing")});var cp=G(".cookie-warning");cp&&G("#yes-to-cookies").on("click",function(){cp.exit("pop",300),b.setCookie("cookie_consent",1)});var wa=G("x-modal#privacy");wa&&wa.$("form").on("submit",i=>{i.preventDefault(),fetch("/profile/accept-policies",{method:"POST"}),wa.close()});var dp;(dp=navigator.serviceWorker)==null||dp.register("/service_worker.js",{scope:"/"}).catch(()=>console.warn("Unable to register Service Worker."));window.addEventListener("beforeinstallprompt",i=>{i.prompt()});var pp;(pp=G("#skip-nav"))==null||pp.on("click",()=>{var t;(t=(G("article")||G(".panel.active")||G(".body")||W).$("input, button, a, textarea, [contenteditable], [tabindex]"))==null||t.focus()});var ya=G("nav x-popup");if(ya){let i=ya.$$(".popup-body a, .popup-body button");for(let t of i)t.on("click",()=>ya.close())}var I1=Ge("#language .locale-link");nn.on("change",i=>{for(let t of I1)t.setAttr("href",t.data.host+i)});var bo=G("#dark-mode");bo&&(bo.checked=b.theme.isDark,bo.on("change",()=>b.setTheme(bo.checked?"dark":"light")));var hn={},Fi=G("#search"),wi=Fi==null?void 0:Fi.$(".form-field input"),$o=Fi==null?void 0:Fi.$(".search-body");hn[""]=($o==null?void 0:$o.html)||"";function N1(i){return i=i.trim().replace(/\s+/," ").toLowerCase().slice(0,50),i==="pi"||i.length>=3?i:""}function G1(i){return R(this,null,function*(){if(i=encodeURIComponent(N1(i)),i in hn)return hn[i];let t=yield fetch(`/api/search?q=${i}`);return t.ok?hn[i]=yield t.text():hn[i]=""})}var D1=0,up=0;function fp(i){return R(this,null,function*(){let t=D1+=1,e=yield G1(i);t<=up||(up=t,$o.html=e)})}wi==null||wi.change(i=>{b.setCookie("search",i,60*60*24),setTimeout(()=>{wi.value===i&&fp(i)},300)});(wi==null?void 0:wi.value)&&Fi.one("open",()=>fp(wi.value));var mp='<label class="target"><input maxlength="15" autocomplete="off" aria-label="Fill in this blank"></label>';function gp(i){if(i.match("^[0-9]+/[0-9]+$")){let t=i.split("/");return+t[0]/+t[1]}else return Qs(i)}var ba=class extends O{constructor(){super(...arguments);this.solution="";this.solutionNum=NaN;this.solutionDisplay="";this.range=0;this.input="";this.hint="";this.attempts=0;this.placeholder="???";this.done=!1}ready(){if(this.$input=this.$("input"),this.$target=this.$(".target"),this.solution=this.attr("solution"),this.solution.indexOf("\xB1")>=0){let t=this.solution.split("\xB1");this.solution=t[0].trim(),this.range=+t[1]}this.solutionNum=gp(this.solution),this.solutionDisplay=this.solution,this.hint=this.attr("hint"),this.removeAttr("solution"),this.removeAttr("hint"),this.$input.setInputPattern(this.solution),this.hasAttr("placeholder")&&(this.placeholder=this.attr("placeholder")),this.$input.setAttr("placeholder",this.placeholder),this.removeAttr("placeholder"),this.$input.change(t=>{this.input=t,this.isCorrect&&(this.solve(),this.trigger("valid",t),this.moveCursor())}),this.$input.onKeyDown("enter",()=>this.$input.blur()),this.$input.on("focus",()=>{this.addClass("on"),this.removeClass("invalid"),this.$input.setAttr("placeholder"," ")}),this.$input.on("blur",()=>{if(this.removeClass("on"),this.setClass("invalid",!!this.input&&!this.done),this.$input.setAttr("placeholder",this.placeholder),this.input&&!this.done){this.attempts+=1;let t=this.attempts>=(this.hint?4:3)?`Hmmm\u2026 maybe try ${this.solution}?`:this.attempts>=2?this.hint:void 0;this.trigger("invalid",{hint:t})}})}setup(t,e,s){var n;this.goal=e,this.$step=t,((n=s==null?void 0:s.scores)==null?void 0:n.includes(e))&&this.solve(!0),this.one("valid",()=>{t.addHint("correct"),t.score(this.solvedBlank?this.solvedBlank.goal:e)}),this.on("invalid",o=>t.addHint(o.hint||"incorrect",{class:"incorrect"}))}get isCorrect(){if(this.done)return!0;if(this.linkedBlanks){let t=this.linkedBlanks.map(e=>e.solvedBlank);return this.solvedBlank=this.linkedBlanks.find(e=>{if(e.done&&!e.solvedBlank||t.includes(e))return!1;if(e.checkAnswer(this.input))return!0}),this.solvedBlank&&(this.solutionDisplay=this.solvedBlank.solution),!!this.solvedBlank}return this.checkAnswer(this.input)}checkAnswer(t){let e=gp(t);return t.toLowerCase()===this.solution.toLowerCase()?!0:this.range&&Math.abs(e-this.solutionNum)<=this.range?(this.solutionDisplay=t,!0):P(e,this.solutionNum)||ds(e)===this.solution||t===ds(this.solutionNum)}moveCursor(){if(!this.$step)return;let t=this.$step.$blanks[this.$step.$blanks.indexOf(this)+1];!t||t.done||t.tagName==="X-BLANK-MC"||t.css("visibility")==="hidden"||!t.bounds.width||t.focus()}solve(t=!1){this.done=!0,this.$input.remove(),this.$target.html=this.solutionDisplay,this.addClass("done"),this.trigger("solve",{solution:this.solutionDisplay,restore:t})}focus(){this.$input.focus()}blur(){this.$input.blur()}};ba=N([A("x-blank",{template:mp})],ba);var vp='<span class="target" slot="target" tabindex="0" aria-label="Fill in this blank">???</span><div class="popup"><slot></slot></div>';var $a=class extends O{constructor(){super(...arguments);this.done=!1}ready(){this.$target=this.$(".target"),this.$popup=this.$(".popup");let t=this.$popup.$$(".choice");this.solution=t[0].html,tt.shuffle(pi(t.length)).forEach(n=>{this.$popup.append(t[n]),t[n].on("click",()=>{this.removeClass("on"),t[n].blur(),n?(this.$target.html=t[n].html,this.addClass("invalid"),this.trigger("invalid")):(this.solve(),this.trigger("valid",this.solution))})});let s=this.$target.bounds.left+this.$popup.width>b.width-15;this.setClass("left",s),vs(this,{enter:()=>{if(this.done)return;this.addClass("on");let n=this.$target.bounds,o=this.$popup.width,r=this.$popup.height,a=b.width-10-n.left,l=o<a,c=n.right-o>10,p=n.top+n.height+r>b.height-10;this.setClass("left",c&&!l),this.setClass("top",p),this.$popup.css("max-width",!c&&!l?`${a}px`:"none")},exit:()=>{this.removeClass("on")},delay:100,exitDelay:400,$clickTarget:this.$target})}setup(t,e,s){var n;((n=s==null?void 0:s.scores)==null?void 0:n.includes(e))&&this.solve(!0),this.one("valid",()=>{t.addHint("correct"),t.score(e)}),this.on("invalid",o=>t.addHint(o.hint||"incorrect",{class:"incorrect"}))}solve(t=!1){this.done=!0,this.$target.html=this.solution,this.removeClass("on invalid"),this.addClass("done"),this.trigger("solve",{solution:this.solution,restore:t}),setTimeout(()=>this.$popup.remove(),250),this.$target.removeAttr("tabindex")}};$a=N([A("x-blank-mc",{template:vp})],$a);var wp='<div class="text-area" contenteditable="true"></div><div class="toolbar"><button class="command" data-command="bold"><x-icon name="bold" size="20"></x-icon></button><button class="command" data-command="italic"><x-icon name="italic" size="20"></x-icon></button><button class="command" data-command="underline"><x-icon name="underline" size="20"></x-icon></button><div class="space"></div><button class="btn btn-green submit"><x-icon name="check"></x-icon> Done</button></div>';var yp=40,bp="free-text",xa=class extends O{setup(t,e,s){var c,p;let n=this.$(".text-area"),o=this.$(".toolbar .submit"),r=((c=s==null?void 0:s.data)==null?void 0:c[bp])||"";r&&(n.html=r);for(let u of this.$$(".toolbar .command")){let f=u.data.command.split(":");u.on("click",()=>document.execCommand(f[0],!1,f[1]))}let a=r,l=Le(()=>{a!==r&&t.storeData(bp,r),a=r},5e3);n.on("change keyup input paste",()=>{r=n.html.replace(/&nbsp;/g," ").trim().slice(0,500).trim(),o.setClass("invisible",r.length<yp),l()}),((p=s==null?void 0:s.scores)==null?void 0:p.includes(e))?o.remove():(o.setClass("invisible",r.length<yp),o.on("click",()=>{l(),t.score(e),o.exit("pop"),this.trigger("submit")}))}};xa=N([A("x-free-text",{template:wp})],xa);var $p='<div class="wrapper"><div class="panel"><slot></slot></div></div><div class="nav"><button class="btn back" aria-label="Previous Step"><x-icon name="left"></x-icon></button><button class="btn next" aria-label="Next Step"><x-icon name="right"></x-icon></button><div class="dots"></div></div>';var Pa=class extends O{ready(){let t=this.$(".wrapper"),e=this.$(".panel"),s=e.children,n=this.$(".next"),o=this.$(".back"),r=this.$(".dots"),a=s.map(()=>h("div",{class:"dot"},r)),l=s.length,c=+this.attr("slide-width")||void 0,p=this.width,u=1,f=p,g=0,w=0,v=St=>{w=St,e.translate(St,0),this.trigger("move",St)},y=St=>{g=St;for(let[Oe,Xs]of a.entries())Xs.setClass("on",Oe>=St&&Oe<St+u);n.setClass("disabled",St===l-u),o.setClass("disabled",St===0),this.trigger("change",St)};b.onResize(()=>{p=this.width,u=c?Math.ceil(p/c):1,f=p/u;for(let St of s)St.css("width",f+"px");e.css("width",l*f+"px"),v(-g*f),y(g)});let C="quad",k=500,L,V,ot,Gt,Tr=!1,kc=()=>{L=Date.now()-Gt,v(V+ot*rt(C,L/k)),!Tr&&L<k?requestAnimationFrame(kc):this.trigger("slide-end")},Cr=St=>{Tr=!1,L=0,V=w,ot=-St*f-w,Gt=Date.now(),y(St),kc()};n.on("click",()=>{C="quad",g<l-u&&Cr(g+1)}),o.on("click",()=>{C="quad",g>0&&Cr(g-1)});let Vc,Mr,Er,Fn;Ii(t,{start:St=>{Tr=!0,Vc=w,Mr=St.x,Fn=Er=Mr},move:St=>{Er=Fn,Fn=St.x;let Oe=Vc-Mr+St.x,Xs=-(l-u)*f,eg=Oe>0?Oe/4:Oe<Xs?Xs+(Oe-Xs)/4:Oe;v(eg),this.css("pointer-events","none")},end:()=>{let St=Fn-Er,Oe=St>12?1:St<-12?-1:0;C="quad-out",Cr(S(Math.round(-w/f-Oe),0,l-u)),setTimeout(()=>this.css("pointer-events","auto"))}})}};Pa=N([A("x-gallery",{template:$p})],Pa);var xp='<svg width="70" height="80"><path d="M20.5,7.4,27.2,24c-1.9-4.7,6-7.1,8-2.3l1.4,3.6c-1.9-4.8,6.1-7.1,8-2.3l1.3,3.1c-2-4.7,5.7-6.5,7.7-1.8,3.3,7.8,5.8,13.6,9,21.3S60.8,56.2,65,66.7L44.9,75A13.9,13.9,0,0,0,36,66.9c-7.7-2.2-11.4-8.3-18.4-14.3a44.2,44.2,0,0,0-9.5-6.5c-2.6-1.5-4.2-3.4-2.2-5.7,3.5-4.1,9.3-1.3,13.1,1.5,1.6,1.2,4.4,4.1,5.9,3.8s1.7-.8,1-2.6L12.8,10.5c-1.9-4.7,5.8-7.9,7.7-3.1Z"></path></svg>';function Sa(i,t){let e=t.positionLeft-i.positionLeft+t.width/2,s=t.positionTop-i.positionTop+t.height/2;return new d(e,s)}function Pp(i){return i?new d(...i.split(",").map(t=>+t)):void 0}var Ta=class extends O{constructor(){super(...arguments);this.doAnimation=!1}created(){this.slide=Pp(this.attr("slide")),this.shift=Pp(this.attr("offset"))}ready(){this.$target=G(this.attr("target")),this.$target&&(this.$target.on("click pointerdown focus",()=>this.stop()),this.hasAttr("start")&&this.start())}setTarget(t,e,s){this.$target=typeof t=="string"?G(t):t,e&&(this.slide=e),s&&(this.slide=s)}start(t){this.doAnimation||!this.from&&!this.$target||(this.doAnimation=!0,t&&(this.slide=t),this.slide||this.$end?this.runSlideAnimation():this.runClickAnimation())}startSlide(t,e){this.$target=t,this.$end=e,this.start()}stop(){this.doAnimation=!1}runSlideAnimation(){return R(this,null,function*(){this.show();let t=this.from||Sa(this,this.$target);this.shift&&(t=t.add(this.shift));let e=this.slide?t.add(this.slide):Sa(this,this.$end),s=`translate(${t.x-15}px,${t.y-10}px)`,n=`translate(${e.x-15}px,${e.y-10}px)`;yield this.animate({transform:[s+" scale(2)",s],opacity:[0,1]},300).promise,yield this.animate({transform:[s,n]},1e3).promise,yield this.animate({transform:[n,n+" scale(2)"],opacity:[1,0]},300).promise,this.hide(),setTimeout(()=>{this.doAnimation&&this.runSlideAnimation()},1e3)})}runClickAnimation(){return R(this,null,function*(){this.show();let t=this.from||Sa(this,this.$target);this.shift&&(t=t.add(this.shift));let e=`translate(${t.x-15}px,${t.y-10}px)`;yield this.animate({transform:[e+" scale(2)",e],opacity:[0,1]},500).promise,yield this.animate({transform:[e,e+" scale(2)"],opacity:[1,0]},500,200).promise,this.hide(),setTimeout(()=>{this.doAnimation&&this.runClickAnimation()},1e3)})}};Ta=N([A("x-gesture",{template:xp})],Ta);var Ca='<span class="target" tabindex="0"><slot></slot></span><div class="popup"></div>';var _1=JSON.parse(G("#glossary").text),H1=JSON.parse(G("#bios").text),Ma=600,xo;b.onResize(()=>{xo&&xo.hide()});var Po=class extends O{ready(){this.xid=this.attr("xid"),this.$target=this.$(".target"),this.$popup=this.$(".popup"),this.$popup.html=this.body()||"",this.setClass("left",b.width>Ma&&this.$target.bounds.left+this.$popup.width>b.width-15),vs(this,{enter:()=>this.show(),exit:()=>this.hide(),delay:100,exitDelay:200,$clickTarget:this.$target,canFocusWithin:!0,preventMouseover:()=>b.width<=Ma})}show(){if(xo=this,this.addClass("on"),b.width<=Ma){let r=G("#glossary-modal");return r.$(".modal-body").html=this.body(),r.open()}let t=this.$target.bounds,e=this.$popup.width,s=this.$popup.height,n=t.top+t.height+s<b.height-10,o=t.top-s>54;this.setClass("top",o&&!n),this.setClass("left",t.left+e>b.width-15)}hide(){xo=void 0,this.removeClass("on")}body(){let t=_1[this.xid];if(!t)return console.warn("missing gloss:",this.xid);let e=t.text;return t.image&&(e+=`<img class="gloss-img" alt="" src="/content/shared/glossary/${t.image}"/>`),t.link&&(location.pathname===t.link.split("#")[0]||(e+=`<p><a href="${t.link}" class="btn btn-white btn-small">Learn more\u2026</a></p>`)),e}};Po=N([A("x-gloss",{template:Ca})],Po);var Ea=class extends Po{body(){let t=H1[this.xid];if(!t)return console.warn("missing bio:",this.xid);let e=`<img class="bio-img" alt="" src="/content/shared/bios/${this.xid}.jpg"/>`,s=t.born?`<p><a href="/timeline/${this.xid}" class="btn btn-white btn-small" target="_blank">Timeline</a></p>`:"";return(t.image===!1?"":e)+t.bio+s}};Ea=N([A("x-bio",{template:Ca})],Ea);var Sp='<div class="wrap"><img alt=""><div class="credit"></div><button class="zoom"><x-icon name="fullscreen" size="24"></x-icon></button><slot></slot></div>';var q1=document.createElement("a").relList.supports("ar"),So=!1,Aa={x:0,y:0,s:1},Tp,ji=h("div",{class:"lightbox-overlay"},W),ii=h("div",{class:"lightbox-img"},ji);function B1(i,t,e){So=!0,Tp=i,ji.show(),ii.show();let s=i.bounds,n=ii.bounds,o=s.left+s.width/2-n.left-n.width/2,r=s.top+s.height/2-n.top-n.height/2,a=Math.max(s.width/n.width,s.height/n.height);Aa={x:o,y:r,s:a},ii.css("background-image",`url(${e}), url(${t})`),ii.css("transform",`translate(${o}px, ${r}px) scale(${a})`),b.redraw(),ii.addClass("transitions"),b.redraw(),i.css("visibility","hidden"),ji.addClass("on"),ii.css("transform","scale(1) translate(0,0)")}function Cp(){!So||(So=!1,ji.removeClass("on"),ii.setTransform(Aa,0,Aa.s),setTimeout(()=>{Tp.css("visibility","visible"),ji.css("display","none"),ii.css("transform","none"),ii.removeClass("transitions")},400))}ji.on("click touchmove",Cp);b.onKey("escape",Cp);ji.on("scrollwheel touchmove",i=>{i.preventDefault(),i.stopPropagation()});b.onKey("space up down left right pagedown pageup",i=>{So&&(i.preventDefault(),i.stopPropagation())});var ka=class extends O{ready(){let t=this.attr("src"),e=this.$(".wrap"),s=this.attr("width"),n=this.attr("height");this.css("width",s+"px"),e.css("padding-bottom",+n/+s*100+"%");let o=e.$("img");o.setAttr("src",t),o.setAttr("alt",this.attr("alt")||""),o.setAttr("width",s),o.setAttr("height",n),t.endsWith(".gif")&&o.on("click",()=>o.setAttr("src",t));let r=e.$(".credit"),a=this.attr("credit");a?r.text=a:r.remove();let l=e.$(".zoom");if(this.hasAttr("lightbox")){this.addClass("interactive");let c=t.replace(/\.(?=[^.]*$)/,"-large.");this.on("click",()=>B1(this,t,c))}else l.remove();if(q1&&this.hasAttr("ar")){let c=h("a",{href:this.attr("ar"),rel:"ar"});e.prepend(c),c.append(o)}}};ka=N([A("x-img",{template:Sp})],ka);var Va=class extends O{constructor(){super(...arguments);this.correctCount=0;this.solvedCount=0;this.isSolved=!1}setup(t,e,s){var a;let n=this.children,o=n.map(()=>!1);for(let[l,c]of n.entries()){let p=c.data.error,u=p?"incorrect":"correct";p||(this.correctCount+=1),c.one("click",()=>{o[l]||this.isSolved||(t.addHint(p||"correct",{class:u}),c.addClass(u),p||(this.solvedCount+=1,t.score("picker-"+l),this.checkSolved()))})}let r=((a=s==null?void 0:s.scores)==null?void 0:a.filter(l=>l.startsWith("picker-")))||[];for(let l of r){let c=+l.slice(7);o[c]=!0,n[c].addClass("correct")}this.solvedCount=r.length,this.checkSolved()}checkSolved(){this.solvedCount<this.correctCount||(this.addClass("solved"),this.isSolved=!0)}};Va=N([A("x-picker")],Va);var Mp='<button class="play" aria-label="Play Slider"><x-icon name="play" size="32"></x-icon></button><div class="bar"><div class="knob"></div></div>';var Oa=class extends O{constructor(){super(...arguments);this.current=0}ready(){this.onAttr("steps",r=>this.steps=+r),this.speed=+this.attr("speed")||1;let t=this.$(".bar"),e=this.$(".knob"),s=this.$(".play");this.hasAttr("no-play")?s.remove():s.on("click",()=>this.play());let n=this.hasAttr("continuous"),o=this.hasAttr("snap")?t.width/this.steps:.001;this.drag=new qi(e,{moveY:!1,snap:o}),this.drag.on("start",()=>{this.animation&&this.animation.cancel(),this.animation=void 0}),this.drag.on("move",({posn:r})=>{let a=r.x/this.drag.bounds.dx*this.steps;n||(a=Math.round(a)),!P(a,this.current)&&(this.current=a,this.trigger("move",a))}),this.drag.on("end",()=>this.trigger("slide-end"))}setup(t,e){this.bindModel(t.model),this.one("slide-end",()=>t.score(e))}set(t){P(t,this.current)||this.drag.setPosition(t*this.drag.bounds.dx/this.steps,0)}play(){return R(this,null,function*(){this.current>=this.steps&&this.set(0);let t=(1-this.current/this.steps)*3e3/this.speed;this.moveTo(this.steps,t)})}moveTo(t,e=600){return R(this,null,function*(){if(this.animation||t===this.current)return;let s=this.current;this.animation=X(n=>{this.set(s+(t-s)*rt("quad",n))},e),yield this.animation.promise,this.animation=void 0,this.trigger("slide-end")})}bindVariable(t,e){t[e]=0,this.on("move",s=>t[e]=s),t.watch(()=>this.set(t[e]))}};Oa=N([A("x-slider",{template:Mp})],Oa);var Ep='<slot name="stage"></slot><div class="nav"><button class="btn back disabled" aria-label="Previous Step"><x-icon name="left" size="24"></x-icon></button><button class="btn next" aria-label="Next Step"><x-icon name="right" size="24"></x-icon></button><div class="dots"></div></div><div class="legend-box"><slot></slot></div>';function z1(i){let t=i.$$("x-blank, x-blank-mc");if(!t.length)return Promise.resolve();let e=0;return new Promise(s=>{for(let n of t)n.on("solve",()=>{e+=1,e>=t.length&&s()})})}var La=class extends O{constructor(){super(...arguments);this.length=0;this.current=0;this.locked=!1}ready(){this.$legend=this.$(".legend-box"),this.$steps=this.$legend.children,this.$back=this.$(".back"),this.$next=this.$(".next");let t=this.$(".dots");this.$dots=this.$steps.map(()=>h("div",{class:"dot"},t)),this.length=this.$steps.length,this.current=0,this.$back.on("click",()=>this.goBack()),this.$next.on("click",()=>this.goNext()),this.blanks=this.$steps.map(e=>z1(e)),this.reveals=this.$$("[slide]").map(e=>{let s=e.attr("slide").split("-"),n=s.length>1?[+s[0]||0,+s[1]||this.length]:[+s[0],+s[0]],o=[e.data.animation||"fade",+e.data.duration||400];return e.data.display="visibility",n[0]>=0&&!e.hasClass("reveal")&&e.hide(),[e,n,o]}),this.autoAdvance=this.attr("step")==="auto",this.$steps[0].show(),this.$dots[0].addClass("on"),this.setupSlide(0)}setup(t,e,s){var o;let n=(o=s==null?void 0:s.scores)==null?void 0:o.filter(r=>r.startsWith("slide-")).length;if(n&&n<this.$steps.length-1){this.go(n);for(let r=1;r<=n;++r)this.trigger("next",r)}this.on("next",r=>t.score("slide-"+(r-1)))}go(t){if(this.locked||t<0||t>this.length-1||t===this.current)return;this.locked=!0,setTimeout(()=>this.locked=!1,600),this.$back.setClass("disabled",t===0),this.$next.setClass("disabled",t===this.length-1),this.$dots[this.current].removeClass("on"),this.$dots[t].addClass("on"),this.$steps[t].show();let e=this.$steps[t].height+"px";this.$steps[t].hide(),this.$steps[this.current].exit("fade",300).promise.then(()=>this.$steps[t].enter("fade",300)),this.$legend.animate({height:e},600).promise.then(()=>this.$legend.css("height","auto")),this.setupSlide(t),this.current=t,this.trigger("step",t)}setupSlide(t){this.$next.setAttr("disabled","true"),this.blanks[t].then(()=>this.$next.removeAttr("disabled"));for(let[e,s,n]of this.reveals){if(e.hasClass("reveal"))continue;let o=e.css("visibility")!=="hidden",r=t>=s[0]&&t<=s[1];r&&!o&&e.enter(...n,300),!r&&o&&e.exit(...n)}}goNext(){this.locked||(this.go(this.current+1),this.trigger("next",this.current))}goBack(){this.locked||(this.go(this.current-1),this.trigger("back",this.current))}};La=N([A("x-slideshow",{template:Ep})],La);var Ra=class extends O{ready(){var g,w;(g=G(".sidebar-toggle"))==null||g.on("click",()=>this.addClass("open")),(w=G(".sidebar-shadow"))==null||w.on("pointerdown",()=>this.removeClass("open"));let t=G("#feedback form"),e=G("#feedback button"),s=G("#feedback .error"),n=G("#feedback-success"),o=G('#feedback textarea[name="message"]'),r=G("x-course").id;t==null||t.on("submit",v=>{v.preventDefault(),e.setAttr("disabled","true"),s.hide(),ti(`/course/${r}/feedback`,t.formData).then(()=>{n.open(),o.value=""}).catch(()=>s.show()).then(()=>e.removeAttr("disabled"))});let a=JSON.parse(G("#glossary").text),l=G("#glossary-search"),c=l.$(".gloss-body"),p=l.$(".gloss-list"),u=l.$(".gloss-search input"),f;for(let v of Object.keys(a).sort()){let y=a[v],C=h("div",{class:"gloss-item",html:y.title,tabindex:0},p);C.on("click",()=>{f&&f.removeClass("on"),f=C,C.addClass("on"),c.html=y.text});let k=y.title.toLowerCase();u.change(L=>C.setClass("hidden",!!L&&k.indexOf(L.toLowerCase())<0))}}};Ra=N([A("x-course-sidebar")],Ra);function Ia(i,t){let e=ui(i.map(s=>s.h+10));for(let[s,n]of i.entries())n.drag.bounds=new At(0,0,0,_(e)),n!==t&&n.drag.setPosition(0,e[s-1]||0)}function F1(i){return i.every((t,e)=>t.index===e)||i.every((t,e)=>t.index===i.length-e-1)}var Na=class extends O{ready(){this.items=this.children.map(t=>({drag:new qi(t,{moveX:!1,useTransform:!0}),index:+t.data.index,h:0}));for(let t of this.children)t.removeAttr("data-index");for(let t of this.items)t.drag.on("drag",()=>{this.items=Vi(this.items,e=>e.drag.position.y-(e===t?10:0)),Ia(this.items,t)}),t.drag.on("end",()=>{Ia(this.items),F1(this.items)&&this.solve()});b.onResize(()=>{for(let e of this.items)e.h=e.drag.$el.height;let t=q(this.items.map(e=>e.h));this.css("height",t+this.items.length*10-10+"px"),Ia(this.items)})}setup(t,e,s){var n;((n=s==null?void 0:s.scores)==null?void 0:n.includes(e))&&this.solve(),this.one("solve",()=>{t.addHint("correct"),t.score(e)})}solve(){this.trigger("solve"),this.addClass("solved");for(let t of this.items)t.drag.disabled=!0}};Na=N([A("x-sortable")],Na);function Ap(i,t=!1){return R(this,null,function*(){if(i.css("visibility")==="visible")return;i.data.display="visibility";let e=+i.data.duration||400,s=(t?0:600)+(+i.data.delay||0);yield i.enter(i.data.animation||"fade",e,s).promise,i.css({opacity:"",transform:""}),i.trigger("reveal"),i.removeClass("reveal")})}var Ga=class extends O{constructor(){super(...arguments);this.model=mt({});this.isShown=!1;this.isCompleted=!1;this.scores=new Set}ready(){var e,s,n,o;this.$course=this.parents("x-course")[0],this.$blanks=this.$$("x-blank, x-blank-mc"),this.$components=this.$$("[goal]"),this.userData=(n=(s=(e=this.$course)==null?void 0:e.userData)==null?void 0:s.steps)==null?void 0:n[this.id],this.goals=lt(this.attr("goals")),this.$reveals=this.$$(".reveal");let t=this.$$(".check[data-when]");for(let r of[...this.$reveals,...t])this.onScore(r.data.when,()=>Ap(r));this.$nextBtn=this.$$(".next-step");for(let[r,a]of this.$nextBtn.entries())this.onScore("next-"+r,()=>a.exit("pop")),a.one("click",()=>this.score("next-"+r));for(let r of this.$$(".step-target"))r.tagName!=="X-TARGET"&&vs(r,{enter:()=>{let a=this.$$('[target~="'+r.data.to+'"]');for(let l of a)l.addClass("focus");this.addClass("focus"),this.trigger("target-focus",{$targets:a})},exit:()=>{for(let a of this.$$(".focus"))a.removeClass("focus");this.removeClass("focus")}});for(let r of this.$$(".var, .var-action"))r.bindModel(this.model);((o=this.$course)==null?void 0:o.audio)&&(this.narration=new ia(this.$course.audio,this))}show(){var s,n,o;if(this.isShown)return;this.isShown=!0,(s=StepFunctions==null?void 0:StepFunctions[Un(this.id)])==null||s.call(StepFunctions,this);for(let r of this.$components)r.setup(this,r.attr("goal"),this.userData);let t=((n=this.userData)==null?void 0:n.scores)||[];for(let r of t)this.score(r,!1);let e=this.$$("x-gesture[target]");setTimeout(()=>{if(!this.isReady)for(let r of e)r.start()},2e3),(o=this.$course)==null||o.log("Step","show",this.id),this.trigger("show"),this.addClass("on"),this.narration&&setTimeout(()=>this.narration.play(),400)}complete(){if(!this.isCompleted){this.isShown||this.show(),this.isCompleted=!0;for(let t=0;t<this.$nextBtn.length;++t)this.score("next-"+t);for(let t of this.$reveals)t.parents("svg").length||Ap(t,!0);this.trigger("complete")}}get isReady(){return this.goals.every(t=>this.scores.has(t))}get isPageLoaded(){return this.$course?this.$course.isReady:!0}score(t,e=!0){this.scores.has(t)||(this.scores.add(t),this.trigger("score-"+t),this.trigger("score"),this.$course&&(this.$course.trigger("score"),this.$course.saveProgress({steps:{[this.id]:{scores:[t]}}}),this.$course.log("Step","score",this.id+"/"+t)),e&&this.isReady&&this.$course&&this.$course.isReady&&setTimeout(()=>{this.$course.$activeStep===this&&this.$course.nextStep()},1200))}storeData(t,e){var s;(s=this.$course)==null||s.saveProgress({steps:{[this.id]:{data:{[t]:e}}}})}onScore(t,e){let s=lt(t);if(s.every(r=>this.scores.has(r)))return e&&e(),Promise.resolve();let n=di(),o=()=>{!s.every(r=>this.scores.has(r))||(e&&e(),n.resolve(),this.off("score",o))};return this.on("score",o),n.promise}addHint(t,e={}){var s,n,o;return this.trigger("hint",t),((s=this.$course)==null?void 0:s.isReady)?this.isInViewport?(n=this.$course.$tutor)==null?void 0:n.showHint(t,e):(this.one("enterViewport",()=>{var r;return(r=this.$course.$tutor)==null?void 0:r.showHint(t,e)}),{text:((o=this.$course.$tutor)==null?void 0:o.hints[t])||t}):{text:t}}delayedHint(t,e=1e4){let s=setTimeout(t,e);this.on("score",()=>{clearTimeout(s),this.isCompleted||(s=setTimeout(t,e))}),this.on("complete",()=>clearTimeout(s))}get nextStep(){if(!this.$course)return;let t=this.$course.$steps.indexOf(this);return this.$course.$steps[t+1]}groupBlanks(...t){let e=t.map(s=>this.$blanks[s]);for(let s of e)s.linkedBlanks=e}};Ga=N([A("x-step")],Ga);var j1='<div class="titles"></div><div class="body"><slot></slot></div>',Da=class extends O{constructor(){super(...arguments);this.$titles=[];this.active=0}ready(){let t=this.$(".titles");this.$body=this.$(".body"),this.$tabs=this.$$(".tab");for(let e=0;e<this.$tabs.length;++e){let s=this.$tabs[e].$("h3")||h("h3");s.setAttr("tabindex","0"),t.append(s),this.$titles.push(s),s.on("click",()=>this.makeActive(e))}this.$titles[0].addClass("active"),this.$tabs[0].show()}makeActive(t){if(this.active===t)return;this.$titles[this.active].removeClass("active"),this.$titles[t].addClass("active"),this.$tabs[t].show();let e=this.$tabs[t].outerHeight+"px";this.$tabs[t].hide(),this.$tabs[this.active].exit("fade",300).promise.then(()=>this.$tabs[t].enter("fade",300)),this.$body.animate({height:e},600).promise.then(()=>this.$body.css("height","auto")),this.active=t,this.trigger("change",t)}};Da=N([A("x-tabbox",{template:j1})],Da);var kp='<defs><mask id="masking"><rect width="100%" height="100%" fill="white"></rect></mask></defs><marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><rect x="0" y="0" width="100%" height="100%" mask="url(#masking)" opacity="0.8"></rect><path class="target-arrow" stroke-width="5" marker-end="url(#arrow)" opacity="0.4" stroke-linecap="round"></path>';function U1(i,t,e,s){let n=new d(i.left-15,i.top+e-15),o=new x(n,i.width+30,i.height+30),r=new d(t.left-15,t.top+s-15),a=new x(r,t.width+30,t.height+30),l=new st(o.center,a.center);return[ft(l,o)[0],ft(l,a)[0]]}function Z1(i,t){return Math.abs(i[0]-t[0])+Math.abs(i[1]-t[1])}var Vp=Ge("header, x-tutor, .sidebar"),Ps=h("svg",{class:"target-body",html:kp},W),W1=Ps.$("mask"),K1=Ps.$(".target-arrow"),Ss=!1,Op=[],_a=class extends O{ready(){this.setAttr("tabindex",0);let t=this.attr("to").replace(/_/g," "),e=this.hasClass("no-margins"),s,n,o,r,a=()=>{Ss=!0;let u=Ge(t);if(!u.length)return;let f=u[0].hasParent(...Vp);s===void 0&&(s=this.hasParent(...Vp));let g=this.bounds,w=u.map(v=>v.bounds).filter(v=>v.width||v.height);if(o=0,!f){let v=Math.min(...w.map(L=>L.top)),y=Math.max(...w.map(L=>L.top+L.height)),C=b.height-12-y,k=56-v;o=C<0?C:k>0?k:0}for(let v of Op)v.remove();Op=[g,...w].map((v,y)=>{let C=!y||e?4:10;return h("rect",{x:v.left-C,y:v.top-C+(y||!s?o:0),width:v.width+2*C,height:v.height+2*C,rx:y?4:18,ry:y?4:18},W1)}),K1.points=U1(g,w[0],s?0:o,f?0:o)},l=()=>{o&&W.scrollBy(-o,300),Ps.css("display","block"),b.redraw(),xe(function(){Ps.css("opacity",1)},o?300:0)},c=u=>{!Ss||u&&Y(u.type,"mousemove","pointermove")&&Z1(n,[u.clientX,u.clientY])<40||(clearTimeout(r),Ss=!1,Ps.css("opacity",0),setTimeout(()=>{Ss||Ps.css("display","none")},300),W.off("mousewheel mousemove touchend touchmove",c),this.off("mouseleave blur",c))},p=()=>{o&&!s?W.on("mousemove",c):this.on("mouseleave",c),W.on("mousewheel touchend touchmove",c),this.on("blur",c)};this.on("mouseenter touchstart focus",u=>{n=[u.clientX,u.clientY],a(),r=window.setTimeout(l,o?50:30),p()}),this.on("click",u=>{Ss?(u.handled=!0,c(),setTimeout(()=>G(t).trigger("click mousedown"))):(Ss=!0,o=0,l(),p())})}};_a=N([A("x-target")],_a);var et=class extends Error{constructor(i,t){super(t);this.name=i}static undefinedVariable(i){return new et("EvalError",`Undefined variable \u201C${i}\u201D.`)}static undefinedFunction(i){return new et("EvalError",`Undefined function \u201C${i}\u201D.`)}static uncallableExpression(i){return new et("EvalError",`Cannot call \u201C${i}\u201D.`)}static evalLoop(i){return new et("EvalError",`Loop in nested evaluation \u201C${i}\u201D.`)}static invalidCharacter(i){return new et("SyntaxError",`Unknown symbol \u201C${i}\u201D.`)}static conflictingBrackets(i){return new et("SyntaxError",`Conflicting brackets \u201C${i}\u201D.`)}static unclosedBracket(i){return new et("SyntaxError",`Unclosed bracket \u201C${i}\u201D.`)}static startOperator(i){return new et("SyntaxError",`A term cannot start with a \u201C${i}\u201D.`)}static endOperator(i){return new et("SyntaxError",`A term cannot end with a \u201C${i}\u201D.`)}static consecutiveOperators(i,t){return new et("SyntaxError",`A \u201C${i}\u201D cannot be followed by a \u201C${t}\u201D.`)}static invalidExpression(){return new et("SyntaxError","This expression is invalid.")}},Ha={pi:Math.PI,\u03C0:Math.PI,e:Math.E},qa={"(":")","[":"]","{":"}"},Ts={"*":"\xB7","**":"\u2217","//":"//","+-":"\xB1","\u2013":"\u2212","-":"\u2212",xx:"\xD7",sum:"\u2211",prod:"\u220F",int:"\u222B",del:"\u2202",grad:"\u2207",aleph:"\u2135",not:"\xAC",AA:"\u2200",EE:"\u2203","'":"\u2019","!=":"\u2260","<=":"\u2264",">=":"\u2265",in:"\u2208","!in":"\u2209","==":"\u2261","~=":"\u2245","~~":"\u2248",sub:"\u2282",sube:"\u2286",prop:"\u221D",oo:"\u221E",cap:"\u2229",cup:"\u222A","<-":"\u2190","->":"\u2192","=>":"\u21D2","<=>":"\u21D4","|->":"\u21A6",uarr:"\u2191",darr:"\u2193",lArr:"\u21D0"},yi={Gamma:"\u0393",Delta:"\u0394",Theta:"\u0398",Lambda:"\u039B",Xi:"\u039E",Pi:"\u03A0",Sigma:"\u03A3",Phi:"\u03A6",Psi:"\u03A8",Omega:"\u03A9",alpha:"\u03B1",beta:"\u03B2",gamma:"\u03B3",delta:"\u03B4",epsilon:"\u025B",zeta:"\u03B6",eta:"\u03B7",theta:"\u03B8",iota:"\u03B9",kappa:"\u03BA",lambda:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",pi:"\u03C0",rho:"\u03C1",sigma:"\u03C3",tau:"\u03C4",upsilon:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",omega:"\u03C9",CC:"\u2102",NN:"\u2115",QQ:"\u211A",RR:"\u211D",ZZ:"\u2124"},Lp="abcdefghijklmnopqrstuvwxyz",X1=Lp.split(""),Y1=Lp.toUpperCase().split(""),Q1=Object.values(yi),J1=[...X1,...Y1,...Q1,"$"],tv="|()[]{}\xF7,!<>=*/+-\u2013\u2212~^_\u2026\xB0\u2022\u2225\u22A5'\u2220:%\u223C\u25B3",ev=Object.values(Ts),iv=[...tv,...ev],sv={_:"sub","^":"sup","//":"/","\xF7":"/"},Rp={"<":"&lt;",">":"&gt;"};function Ip(i){return i in Rp?Rp[i]:i}var nv=["abs","round","floor","ceil","max","min","mod","lcm","gcd","gcf","log","exp","ln","sqrt","root","sin","cos","tan","sec","csc","cot","cosec","cotan","arcsin","arccos","arctan","sinh","cosh","tanh","sech","csch","coth","cosech"];function Ui(i){return nv.includes(i)}var Cs={"+":"plus","\u2212":"minus","\xB7":"times","\xD7":"times","/":"over","//":"divided by","%":"percent","!":"factorial","\xB1":"plus-minus","=":"equals","\u2260":"does not equal","<":"is less than",">":"is greater than","\u2264":"is less than or equal to","\u2265":"is greater than or equal to",\u03C0:"pi","\u2245":"is congruent to","\u2225":"is parallel to","\u22A5":"is perpendicular to"};for(let i of Object.keys(yi))Cs[yi[i]]=i;var Np=i=>typeof i=="number"?i:i[0],Gp=i=>typeof i=="number"?[i,i]:i,bi=class{evaluate(i={},t){return NaN}interval(i={},t){return Gp(this.evaluate(i))}substitute(i={}){return this}recursiveSubstitute(i){let t=Object.keys(i);return this.unknowns.filter(e=>t.includes(e)).length?this.substitute(i).recursiveSubstitute(i):this}get simplified(){return this}get unknowns(){return this.variables.filter(i=>!Object.prototype.hasOwnProperty.call(Ha,i))}get variables(){return[]}get functions(){return[]}collapse(){return this}toString(){return""}toVoice(i={}){return""}toMathML(i={}){return""}},Ba=new Set;function za(i,t,e=!1){var s;let n=(s=t[i])!=null?s:Ha[i];if(n===void 0)throw et.undefinedVariable(i);if(typeof n=="string"||n instanceof bi){if(e||Ba.clear(),Ba.has(i))throw et.evalLoop(i);return Ba.add(i),typeof n=="string"&&(n=kt.parse(n)),n.evaluate(t,!0)}else return typeof n=="function"?n():n}var si=class extends bi{constructor(i){super();this.n=i}evaluate(){return this.n}toString(){return`${this.n}`}toVoice(){return`${this.n}`}toMathML(){return`<mn>${this.n}</mn>`}},Ms=class extends bi{constructor(i){super();this.i=i}evaluate(i={},t){return Np(za(this.i,i,t))}interval(i={},t){return Gp(za(this.i,i,t))}toMathML(){return`<mi${Ui(this.i)?' mathvariant="normal"':""}>${this.i}</mi>`}substitute(i={}){return i[this.i]||this}get variables(){return[this.i]}toString(){return this.i}toVoice(){return this.i in Cs?Cs[this.i]:this.i.length===1?`_${this.i}_`:this.i}},ov=class extends bi{constructor(i){super();this.s=i}evaluate(i={},t){return Np(za(this.s,i,t))}toString(){return`"${this.s}"`}toVoice(){return this.s}toMathML(){return`<mtext>${this.s}</mtext>`}},Dp=class extends bi{toString(){return" "}toMathML(){return"<mspace></mspace>"}},He=class extends bi{constructor(i){super();this.o=i}toString(){return this.o.replace("//","/")}toVoice(){return Cs[this.o]||this.o}get functions(){return[this.o]}toMathML(){let i=Ip(this.toString());return`<mo value="${i}">${i}</mo>`}},_p=[-Infinity,Infinity],Es=[NaN,NaN],Zi=Math.PI/2,Fa=Math.PI*2,xt=(i,t)=>[i-Number.EPSILON,t+Number.EPSILON],Wi=(...i)=>xt(Math.min(...i),Math.max(...i)),rv=i=>Math.abs(i[1]-i[0]);var As=i=>isNaN(i[0])||isNaN(i[1]),Hp=i=>!isFinite(i[0])&&i[0]===i[1],av=(i,t)=>it(t,i[0]-Number.EPSILON,i[1]+Number.EPSILON),To=i=>av(i,0),qe={add:(...i)=>i.reduce((t,e)=>t+e,0),sub:(...i)=>i.length>1?i[0]-i[1]:-i[0],mul:(...i)=>i.reduce((t,e)=>t*e,1),div:(i,t)=>i/t,abs:i=>Math.abs(i),round:i=>Math.round(i),floor:i=>Math.floor(i),ceil:i=>Math.ceil(i),max:(...i)=>Math.max(...i),min:(...i)=>Math.min(...i),mod:(i,t)=>i%t,lcm:(...i)=>Li(...i),gcd:(...i)=>fi(...i),gcf:(...i)=>fi(...i),sup:(i,t)=>Math.pow(i,t),log:(i,t)=>Math.log(i)/(t===void 0?1:Math.log(t)),exp:i=>Math.exp(i),ln:i=>Math.log(i),sqrt:i=>Math.sqrt(i),root:(i,t)=>Math.pow(i,1/t),sin:i=>Math.sin(i),cos:i=>Math.cos(i),tan:i=>Math.tan(i),sec:i=>1/Math.cos(i),csc:i=>1/Math.sin(i),cot:i=>1/Math.tan(i),cosec:i=>qe.csc(i),cotan:i=>qe.cot(i),arcsin:i=>Math.asin(i),arccos:i=>Math.acos(i),arctan:i=>Math.atan(i),sinh:i=>Math.sinh(i),cosh:i=>Math.cosh(i),tanh:i=>Math.tanh(i),sech:i=>1/Math.cosh(i),csch:i=>1/Math.sinh(i),coth:i=>1/Math.tanh(i),cosech:i=>qe.csch(i)};function Co(i,t){if(i[0]>0)return t[0]>=0?xt(i[0]**t[0],i[1]**t[1]):Wi(i[0]**t[0],i[0]**t[1],i[1]**t[0],i[1]**t[1]);let e=t[0];return Number.isInteger(e)&&e===t[1]?e===0?[To(i)?0:1,1]:e%2?xt(i[0]**e,i[1]**e):To(i)?[0,Math.max(i[0]**e,i[1]**e)]:Wi(i[1]**e,i[0]**e):Es}function qp(i,t=Fa){let e=Math.floor(i[0]/t)*t;return[i[0]-e,i[1]-e]}var Q={add:(...i)=>xt(q(i.map(t=>t[0])),q(i.map(t=>t[1]))),sub:(i,t)=>t!==void 0?xt(i[0]-t[1],i[1]-t[0]):xt(-i[1],-i[0]),mul:(i,...t)=>(t.length>1&&(t=[Q.mul(...t)]),Wi(i[0]*t[0][0],i[0]*t[0][1],i[1]*t[0][0],i[1]*t[0][1])),div:(i,t)=>To(t)?_p:Wi(i[0]/t[0],i[0]/t[1],i[1]/t[0],i[1]/t[1]),abs:i=>To(i)?xt(0,Math.max(-i[0],i[1])):Wi(Math.abs(i[0]),Math.abs(i[1])),round:i=>xt(Math.round(i[0]),Math.round(i[1])),floor:i=>xt(Math.floor(i[0]),Math.floor(i[1])),ceil:i=>xt(Math.ceil(i[0]),Math.ceil(i[1])),max:(...i)=>xt(Math.max(...i.map(t=>t[0])),Math.max(...i.map(t=>t[1]))),min:(...i)=>xt(Math.min(...i.map(t=>t[0])),Math.min(...i.map(t=>t[1]))),mod:(i,t)=>{if(As(i)||As(t))return Es;let e=i[0]/(i[0]<0?t[0]:t[1]);return e=e<0?Math.ceil(e):Math.floor(e),Q.sub(i,Q.mul(t,[e,e]))},lcm:(...i)=>Wi(Li(...i.map(t=>t[0]))),gcd:(...i)=>Wi(fi(...i.map(t=>t[0]))),gcf:(...i)=>Q.gcd(...i),sup:(i,t)=>Co(i,t),log:(i,t)=>(t!==void 0&&Q.div(Q.log(i),Q.log(t)),xt(i[0]<=0?-Infinity:Math.log(i[0]),Math.log(i[1]))),exp:i=>Co([Math.E,Math.E],i),ln:i=>Q.log(i),sqrt:i=>Co(i,[.5,.5]),root:(i,t)=>Co(i,Q.div([1,1],t)),sin:i=>Q.cos(Q.sub(i,[Zi,Zi])),cos:i=>As(i)||Hp(i)?Es:rv(i)>=Fa-Number.EPSILON?[-1,1]:(i=qp(i),i[0]>Math.PI+Number.EPSILON?Q.sub(Q.cos(Q.sub(i,[Math.PI,Math.PI]))):i[1]<Math.PI-Number.EPSILON?xt(Math.cos(i[1]),Math.cos(i[0])):i[1]<Fa-Number.EPSILON?xt(-1,Math.max(Math.cos(i[1]),Math.cos(i[0]))):xt(-1,1)),tan:i=>As(i)||Hp(i)?Es:(i=qp(i,Math.PI),i[0]>Zi+Number.EPSILON&&(i=Q.sub(i,[Math.PI,Math.PI])),i[0]<-Zi+Number.EPSILON||i[1]>Zi-Number.EPSILON?_p:xt(Math.tan(i[0]),Math.tan(i[1]))),sec:i=>Q.div([1,1],Q.cos(i)),csc:i=>Q.div([1,1],Q.sin(i)),cot:i=>Q.div([1,1],Q.tan(i)),cosec:i=>Q.csc(i),cotan:i=>Q.cot(i),arcsin:i=>As(i)||i[1]<-1||i[0]>1?Es:xt(i[0]<=-1?-Zi:Math.asin(i[0]),i[1]>=1?Zi:Math.asin(i[1])),arccos:i=>As(i)||i[1]<-1||i[0]>1?Es:xt(i[1]>=1?0:Math.acos(i[1]),i[0]<=-1?Math.PI:Math.acos(i[0])),arctan:i=>xt(Math.atan(i[0]),Math.atan(i[1])),sinh:i=>xt(Math.sinh(i[0]),Math.sinh(i[1])),cosh:i=>i[1]<0?xt(Math.cosh(i[1]),Math.cosh(i[0])):i[0]>0?xt(Math.cosh(i[0]),Math.cosh(i[1])):xt(1,Math.cosh(Math.max(-i[0],i[1]))),tanh:i=>xt(Math.tanh(i[0]),Math.tanh(i[1])),sech:i=>Q.div([1,1],Q.cosh(i)),csch:i=>Q.div([1,1],Q.sinh(i)),coth:i=>Q.div([1,1],Q.tanh(i)),cosech:i=>Q.csch(i)},Mo=lt("+ \u2212 * \xD7 \xB7 / \xF7 // sup sub subsup"),Bp=lt("sub sup subsup"),ja='<mo value="," lspace="0">,</mo>';function zp(i,t){return Mo.includes(t)?i instanceof Eo?!0:!(i instanceof Zt)||!Mo.includes(i.fn)?!1:Bp.includes(i.fn)&&Bp.includes(t)?!0:Mo.indexOf(t)>Mo.indexOf(i.fn):!1}function lv(i,t,e){return zp(i,t)?`<mfenced>${e}</mfenced>`:e}function $i(i,t){return i instanceof Eo||i instanceof Zt?`<mrow>${t}</mrow>`:t}function Fp(i){return i==="2"?"squared":i==="3"?"cubed":`to the power of ${i}`}var Zt=class extends bi{constructor(i,t=[]){super();this.fn=i,this.args=t}evaluate(i={}){let t=this.args.map(e=>e.evaluate(i));if(this.fn in i){let e=i[this.fn];if(typeof e=="function")return e(...t);if(typeof e=="number"&&t.length===1)return qe.mul(e,t[0]);throw et.uncallableExpression(this.fn)}if(this.fn==="+")return qe.add(...t);if(this.fn==="\u2212")return qe.sub(...t);if(["*","\xB7","\xD7"].includes(this.fn))return qe.mul(...t);if(this.fn==="/")return qe.div(...t);if(this.fn==="sup")return qe.sup(...t);if(Ui(this.fn))return qe[this.fn](...t);if(this.fn==="(")return t[0];throw et.undefinedFunction(this.fn)}interval(i={}){let t=this.args.map(e=>e.interval(i));if(this.fn in i){let e=i[this.fn];if(typeof e=="function")return Ht(e(...t.map(s=>s[0])),2);if(typeof e=="number"&&t.length===1)return Q.mul([e,e],t[0]);if(Array.isArray(e)&&t.length===1)return Q.mul(e,t[0]);throw et.uncallableExpression(this.fn)}if(this.fn==="+")return Q.add(...t);if(this.fn==="\u2212")return Q.sub(...t);if(["*","\xB7","\xD7"].includes(this.fn))return Q.mul(...t);if(this.fn==="/")return Q.div(...t);if(this.fn==="sup")return Q.sup(...t);if(Ui(this.fn))return Q[this.fn](...t);if(this.fn==="(")return t[0];throw et.undefinedFunction(this.fn)}substitute(i={}){return new Zt(this.fn,this.args.map(t=>t.substitute(i)))}collapse(){return this.fn==="("?this.args[0].collapse():new Zt(this.fn,this.args.map(i=>i.collapse()))}get simplified(){return this}get variables(){return Dt(qt(this.args.map(i=>i.variables)))}get functions(){return Dt([this.fn,...qt(this.args.map(i=>i.functions))])}toString(){let i=this.args.map(t=>zp(t,this.fn)?`(${t.toString()})`:t.toString());return this.fn==="\u2212"?i.length>1?i.join(" \u2212 "):`\u2212${i[0]}`:this.fn==="sup"?i.join("^"):this.fn==="sub"?i.join("_"):this.fn==="subsup"?`${i[0]}_${i[1]}^${i[2]}`:lt("+ * \xD7 \xB7 / = < > \u2264 \u2265 \u2248").includes(this.fn)?i.join(` ${this.fn} `):Y(this.fn,"(","[","{")?this.fn+this.args.join(", ")+qa[this.fn]:Y(this.fn,"!","%")?i[0]+this.fn:`${this.fn}(${i.join(", ")})`}toMathML(i={}){let t=this.args.map(n=>n.toMathML(i)),e=this.args.map((n,o)=>lv(n,this.fn,t[o]));if(this.fn in i){let n=t.map((o,r)=>({toString:()=>o,val:this.args[r]}));return i[this.fn](...n)}if(this.fn==="\u2212")return e.length>1?e.join('<mo value="\u2212">\u2212</mo>'):`<mo rspace="0" value="\u2212">\u2212</mo>${e[0]}`;if(Y(this.fn,"+","=","<",">","\u2264","\u2265","\u2248")){let n=Ip(this.fn);return e.join(`<mo value="${n}">${n}</mo>`)}if(Y(this.fn,"*","\xD7","\xB7")){let n=e[0];for(let o=1;o<e.length-1;++o)n+=(this.args[0]instanceof si&&this.args[1]instanceof si?'<mo value="\xD7">\xD7</mo>':"")+e[1];return n}if(this.fn==="//")return e.join('<mo value="/">/</mo>');if(this.fn==="sqrt")return`<msqrt>${e[0]}</msqrt>`;if(Y(this.fn,"/","root")){let n=this.fn==="/"?"mfrac":"mroot",o=this.args.map((r,a)=>$i(r,t[a]));return`<${n}>${o.join("")}</${n}>`}if(Y(this.fn,"sup","sub")){let n=[$i(this.args[0],e[0]),$i(this.args[1],t[1])];return`<m${this.fn}>${n.join("")}</m${this.fn}>`}return this.fn==="subsup"?`<msubsup>${[$i(this.args[0],e[0]),$i(this.args[1],t[1]),$i(this.args[2],t[2])].join("")}</msubsup>`:Y(this.fn,"(","[","{")?`<mfenced open="${this.fn}" close="${qa[this.fn]}">${e.join(ja)}</mfenced>`:Y(this.fn,"!","%")?`${e[0]}<mo value="${this.fn}" lspace="0">${this.fn}</mo>`:this.fn==="abs"?`<mfenced open="|" close="|">${e.join(ja)}</mfenced>`:this.fn==="bar"?`<mover>${$i(this.args[0],e[0])}<mo value="\u203E">\u203E</mo></mover>`:this.fn==="vec"?`<mover>${$i(this.args[0],e[0])}<mo value="\u2192">\u2192</mo></mover>`:`<mi${Ui(this.fn)?' mathvariant="normal"':""}>${this.fn}</mi><mfenced>${e.join(ja)}</mfenced>`}toVoice(i={}){let t=this.args.map(s=>s.toVoice(i)),e=t.join(" ");if(this.fn in i){let s=t.map((n,o)=>({toString:()=>n,val:this.args[o]}));return i[this.fn](...s)}return Y(this.fn,"(","[","{")?e:this.fn==="sqrt"?`square root of ${e}`:this.fn==="%"?`${e} percent`:this.fn==="!"?`${e} factorial`:this.fn==="/"?`${t[0]} over ${t[1]}`:this.fn==="//"?`${t[0]} divided by ${t[1]}`:this.fn==="sub"?e:this.fn==="subsup"?`${t[0]} ${t[1]} ${Fp(t[2])}`:this.fn==="sup"?`${t[0]} ${Fp(t[1])}`:Cs[this.fn]?t.join(` ${Cs[this.fn]} `):Ui(this.fn)?`${this.fn} ${e}`:`${this.fn} of ${e}`}},Eo=class extends bi{constructor(i){super();this.items=i}evaluate(i={}){return this.collapse().evaluate(i)}interval(i={}){return this.collapse().interval(i)}substitute(i={}){return this.collapse().substitute(i)}get simplified(){return this.collapse().simplified}get variables(){return Dt(Nc(...this.items.map(i=>i.variables)))}get functions(){return this.collapse().functions}toString(){return this.items.map(i=>i.toString()).join(" ")}toMathML(i={}){return this.items.map(t=>t.toMathML(i)).join("")}toVoice(i={}){return this.items.map(t=>t.toVoice(i)).join(" ")}collapse(){return Ua(this.items).collapse()}};function Za(i,t){if(t===2)return new ov(i);if(!(!i||!t)){if(t===1&&i.length>1)return new Dp;if(t===3){if(isNaN(+i))throw et.invalidExpression();return new si(+i)}if(t===4)return i in yi?new Ms(yi[i]):i in Ts?new He(Ts[i]):new Ms(i);if(t===5)return i in Ts?new He(Ts[i]):new He(i)}}function hv(i){let t=[],e="",s=0;for(let o of i){if(o==='"'){let a=s===2?0:2,l=Za(e,s);l&&t.push(l),e="",s=a;continue}else if(s===2){e+=o;continue}let r=o.match(/[0-9.]/)?3:J1.includes(o)?4:iv.includes(o)?5:o.match(/\s/)?1:0;if(!r)throw et.invalidCharacter(o);if(!s||s===3&&r!==3||s===4&&r!==4&&r!==3||s===5&&!(e+o in Ts)||s===1&&r!==1){let a=Za(e,s);a&&t.push(a),e="",s=r}e+=o}let n=Za(e,s);return n&&t.push(n),t}function cv(i){return i.length>1?new Eo(i):i[0]instanceof He?new Eo(i):i[0]}function dv(i,t){let e=[[]];for(let s of i)t(s)?e.push([]):_(e).push(s);return e}function Xt(i,t){return i instanceof He&&lt(t).includes(i.o)}function cn(i){return i instanceof Zt&&i.fn==="("?i.args[0]:i}function Ao(i,t){if(Xt(i[0],t))throw et.startOperator(i[0]);if(Xt(_(i),t))throw et.endOperator(_(i));for(let e=1;e<i.length-1;++e){if(!Xt(i[e],t))continue;let s=i[e],n=i[e-1],o=i[e+1];if(n instanceof He)throw et.consecutiveOperators(n.o,s.o);if(o instanceof He)throw et.consecutiveOperators(s.o,o.o);let r=i[e+2];if(t==="^ _"&&Xt(s,"_ ^")&&Xt(r,"_ ^")&&s.o!==r.o){let a=i[e+3];if(a instanceof He)throw et.consecutiveOperators(r.o,a.o);let l=[cn(n),cn(o),cn(a)];s.o==="^"&&([l[1],l[2]]=[l[2],l[1]]),i.splice(e-1,5,new Zt("subsup",l)),e-=4}else{let a=sv[s.o]||s.o,l=[cn(n),cn(o)];i.splice(e-1,3,new Zt(a,l)),e-=2}}}function jp(i){return Ao(i,"^ _"),Ao(i,"/"),cv(i)}function pv(i,t){let e=[[]],s=["\u03C0",...(t==null?void 0:t.variables)||[]];for(let n of i){let o=_(e).length?_(e)[0].o:void 0;if(Xt(n,") ] }")){if(!Xt(n,qa[o]))throw et.conflictingBrackets(n.o);let r=e.pop(),a=_(e),l=_(a),p=Xt(n,")")&&l instanceof Ms&&!s.includes(l.i)?a.pop().i:r[0].o,u=dv(r.slice(1),f=>Xt(f,","));a.push(new Zt(p,u.map(jp)))}else Xt(n,"( [ {")?e.push([n]):_(e).push(n)}if(e.length>1)throw et.unclosedBracket(_(e)[0].o);return jp(e[0])}function Up(i,t,e=!1){let s=[],n=[],o=!1;function r(){if(o)throw et.invalidExpression();!n.length||(s.push(n.length>1?new Zt(t[0],n):n[0]),n=[])}for(let a of i)if(Xt(a,t)){if(o||!n.length)throw et.invalidExpression();o=!0}else if(a instanceof He)r(),s.push(a),o=!1;else{let l=!e||a instanceof si;if(n.length&&!o&&l)throw et.invalidExpression();n.push(a),o=!1}return r(),s}function Ua(i){if(i=i.filter(e=>!(e instanceof Dp)),!i.length)throw et.invalidExpression();let t=i.findIndex(e=>Xt(e,"= < > \u2264 \u2265"));if(t===0)throw et.startOperator(i[0]);if(t===i.length-1)throw et.endOperator(i[0]);if(t>0){let e=Ua(i.slice(0,t)),s=Ua(i.slice(t+1));return new Zt(i[t].o,[e,s])}if(Xt(i[0],"%!"))throw et.startOperator(i[0]);for(let e=0;e<i.length;++e)!Xt(i[e],"%!")||(i.splice(e-1,2,new Zt(i[e].o,[i[e-1]])),e-=1);Ao(i,"// \xF7");for(let e=1;e<i.length;++e){let s=i[e];if(s instanceof Zt&&s.fn==="/"){let n=i[e-1];if(n instanceof si)i.splice(e-1,2,new Zt("+",[n,s])),e-=1;else if(!(n instanceof He))throw et.consecutiveOperators(n.toString(),s.toString())}}if(i=Up(i,"\xD7 * \xB7",!0),Xt(i[0],"\u2212 \xB1")&&i.splice(0,2,new Zt(i[0].o,[i[1]])),Ao(i,"\u2212 \xB1"),Xt(i[0],"+")&&(i=i.slice(1)),i=Up(i,"+"),i.length>1)throw et.invalidExpression();return i[0]}function uv(i,t=!1,e){let s=pv(hv(i),e);return t?s.collapse():s}function fv(i,t){try{let e=Dt([...i.variables,...t.variables]),s=i.collapse(),n=t.collapse(),o=0;for(let r=0;r<5;++r){let a={};for(let p of e)a[p]=Ha[p]||Math.random()*5;let l=s.evaluate(a),c=n.evaluate(a);if(!(isNaN(l)||isNaN(c))){if(!P(l,c))return!1;o+=1}}return!!o}catch(e){return!1}}var kt={numEquals:fv,parse:le(uv)};var Zp='<div class="toasts"><div class="msg-wrap"><button class="msg archie" aria-label="Virtual Tutor"><slot name="icon"></slot></button></div></div><div class="chat" data-display="flex"><div class="chat-header"><slot name="header"></slot><button class="close"><x-icon name="close" size="24"></x-icon></button></div><div class="chat-body"></div><div class="chat-footer"><div class="input" contenteditable></div><button class="hint"><x-icon name="lightbulb" size="24"></x-icon></button></div></div>';var mv=/[0-9+\-*/()^\s]+/g,gv=Oi(tt.shuffle(["happy","spongebob","sloth","party","robot","excited","cute","highfive1","applause","highfive2"])),vv=Oi(tt.shuffle(["minions","panther","dog","snape","what","door","horrible"]));function Wa(i,t,e={}){let s=h("div",{class:"msg-wrap","data-display":"flex"}),n=h("div",{class:"msg "+t},s);return e.class&&n.addClass(e.class),e.visible||s.hide(),Y(t,"hint","question")?n.html=i:t==="img"?n.css("background-image",`url(${i})`):t==="video"&&h("iframe",{src:i,allowfullscreen:!0},n),s}var Ka=class extends O{constructor(){super(...arguments);this.recentMessages=[];this.isOpen=!1;this.queuePromise=Promise.resolve()}ready(){var n;this.$course=this.parents("x-course")[0],this.hints=this.$course?JSON.parse(this.$course.$("#hints").text):{};let t=window.user;this.correct=Oi(tt.shuffle(this.hints.correct||[])),this.incorrect=Oi(tt.shuffle(this.hints.incorrect||[])),this.$toasts=this.$(".toasts"),this.$chat=this.$(".chat"),this.$chatBody=this.$(".chat-body"),this.$toasts.on("click",o=>{o.handled||this.open()}),this.$(".close").on("click",()=>this.close());let e=this.$(".chat-footer");if(this.$query=e.$(".input"),this.$query.onKeyDown("enter",o=>{o.preventDefault(),this.askQuestion(this.$query.text.trim()),this.$query.text=""}),this.$query.on("focus",()=>e.addClass("focus")),this.$query.on("blur",()=>e.removeClass("focus")),this.$(".hint").on("click",()=>{this.queue(this.hints.tutorial1),this.queue(t?this.hints.tutorial2:this.hints.account)}),this.$course&&((n=this.$course.userData)==null?void 0:n.messages))for(let o of this.$course.userData.messages)this.$chatBody.append(Wa(o.content,o.kind||"hint",{visible:!0}));if(!b.getCookie("sessionWelcome")&&this.$course){b.setCookie("sessionWelcome",1,60*60*4);let o=new Date().getHours(),r=o<12?"Morning":o<18?"Afternoon":"Evening";t?setTimeout(()=>this.showHint(`welcome${r}Named`,{variables:{name:t.shortName}}),3e3):b.getCookie("welcome")?(setTimeout(()=>this.showHint(`welcome${r}`),3e3),setTimeout(()=>this.queue(this.hints.account),4500)):(b.setCookie("welcome",1),setTimeout(()=>this.queue(this.hints.welcome),3e3),setTimeout(()=>this.queue(this.hints.tutorial1),4500))}}open(){this.isOpen||(this.isOpen=!0,this.$chat.enter("slide-up",200),this.$chatBody.scrollTop=this.$chatBody.scrollHeight,this.trigger("open"))}close(){!this.isOpen||(this.isOpen=!1,this.$query.blur(),this.trigger("close"),this.$chat.exit("slide-down",200))}queue(t,e="hint",s={}){this.queuePromise=this.queuePromise.then(()=>(this.display(t,e,s),Xe(500)))}display(t,e="hint",s={}){let n=s.timeout||8e3;if(b.width<640&&(n*=.7),(s.toast==null?!0:s.toast)&&!this.isOpen){let a=Wa(t,e,s);a.setAttr("role","alert"),this.$toasts.append(a),a.enter("reveal-right"),setTimeout(()=>a.exit("reveal-right",400,0,!0),n),this.on("open",()=>a.exit("reveal",200,0,!0))}let r=Wa(t,e,{class:s.class,visible:!this.isOpen});this.$chatBody.append(r),this.isOpen&&(r.enter("reveal",300),X(()=>this.$chatBody.scrollTop=this.$chatBody.scrollHeight,200))}showHint(t,e={}){if(Y(t,"correct","incorrect")){let n=t==="correct"?this.correct():this.incorrect(),o=t==="correct"?3e3:5e3;if(this.queue(n,"hint",{class:e.class||t,timeout:o}),Math.random()<.2){let r=t==="correct"?gv():vv(),a="";this.queue(`${a}/images/gifs/${r}.gif`,"img",{timeout:o})}return{text:n}}let s=this.hints[t]||t;if(e.variables)for(let[n,o]of Object.entries(e.variables))s=s.replace(new RegExp("\\$"+n,"g"),o);return!e.force&&this.recentMessages.includes(t)?{text:s}:(this.recentMessages.push(t),setTimeout(()=>this.recentMessages.shift(),1e4),e.store!==!1&&this.$course&&this.$course.saveProgress({hints:[{content:s,kind:"hint"}]}),this.queue(s,"hint",{class:e.class}),{text:s})}askQuestion(t){if(!t)return;this.queue(t,"question"),this.$course&&this.$course.log("Tutor","ask",t);let e=(t.match(mv)||[]).filter(s=>s.length>=3&&!s.match(/^[\s0-9]+$/));if(e.length)try{let s=kt.parse(e[0],!0),n=kt.parse("="+s.evaluate());return this.queue(`<span class="math">${s.toMathML()}${n.toMathML()}</span>`)}catch(s){console.log("Parse Error:",e[0])}this.$chatBody.addClass("loading"),ti(this.attr("api"),{query:t}).then(s=>{this.$chatBody.removeClass("loading");let n=JSON.parse(s);for(let o of n)this.queue(o.content,o.kind)}).catch(s=>{this.$chatBody.removeClass("loading"),this.queue(this.hints.serverError),console.error("Tutor Error:",s)})}};Ka=N([A("x-tutor",{template:Zp})],Ka);var Wp='<div class="left" tabindex="0"><x-icon name="left" size="14"></x-icon></div><div class="content"><slot></slot></div><div class="right" tabindex="0"><x-icon name="right" size="14"></x-icon></div><div class="bubble"><div class="bubble-box"><div class="progress"></div></div><div class="bubble-arrow"></div></div>';var Kp=h("div",{class:"var-overlay"},W),Xa=class extends O{constructor(){super(...arguments);this.valueChange=!1}ready(){let t=this.attr("bind");if(!t)return;let[e,s,n]=t.split("|");[this.min,this.max,this.step]=n.split(",").map(l=>+l),this.name=e,this.model=this.getParentModel(),this.$(".content").bindModel(this.model),this.$progress=this.$(".progress"),this.setValue(+s);let o=20*(b.isMobile?1.5:1)/S((this.max-this.min)/this.step/12,1,3),r=0,a=0;for(let l of this.$$(".left, .right")){let c=l.hasClass("left")?-this.step:this.step;l.on("click",()=>{this.setValue(this.value+c),this.trigger("slide-end")})}Ii(this,{start:l=>{r=l.x,a=this.value,this.addClass("on"),this.valueChange=!1,Kp.show(),zt.addClass("grabbing")},move:l=>{let c=(l.x-r)/o;this.setValue(a+Kt(c)*this.step)},end:()=>{this.removeClass("on"),this.valueChange&&this.trigger("slide-end"),Kp.hide(),zt.removeClass("grabbing")}})}setup(t,e){this.one("slide-end",()=>t.score(e))}setValue(t){let e=Kt(S(t,this.min,this.max),2);if(e===this.value)return;this.value=e,this.valueChange=!0,this.model&&(this.model[this.name]=e);let s=this.max-this.min;this.$progress.css("width",116*(e-this.min)/s+"px")}};Xa=N([A("x-var",{template:Wp})],Xa);var Xp='<button class="play-btn-box" aria-label="Play"><x-icon name="play" size="44"></x-icon></button>';var Ya=class extends O{constructor(){super(...arguments);this.visible=!0}ready(){this.on("click",()=>{this.play(),setTimeout(()=>this.trigger("play"),400)})}play(){!this.visible||(this.visible=!1,this.exit("pop",400))}reset(){this.visible||(this.visible=!0,setTimeout(()=>this.enter("pop"),400))}};Ya=N([A("x-play-btn",{template:Xp})],Ya);var Qa=class extends O{constructor(){super(...arguments);this.playing=!1}ready(){this.$icon=this.$("x-icon"),this.$("button").on("click",()=>this.toggle())}toggle(){this.playing?this.pause():this.play()}play(){this.playing||(this.playing=!0,this.$icon.setAttr("name","pause"),this.trigger("play"))}pause(){!this.playing||(this.playing=!1,this.$icon.setAttr("name","play"),this.trigger("pause"))}};Qa=N([A("x-play-toggle",{template:'<button class="icon-btn"><x-icon name="play"></x-icon></button>'})],Qa);var Yp='<div class="video-wrap"><video playsinline></video></div><div class="credit"></div><x-play-btn></x-play-btn><div class="controls"><div class="shadow"></div><button class="play-pause-btn" tabindex="0" aria-label="Play video"><div class="play-icon"><x-icon name="play" size="32"></x-icon></div><div class="pause-icon"><x-icon name="pause" size="32"></x-icon></div></button><div class="timeline"><div class="bar"><div class="background"></div><div class="buffer"></div><div class="progress"></div></div><div class="handle"></div></div><div class="timecode"></div></div>';function Qp(i){let t=Math.floor(i/60),e=Math.floor(i%60);return t+":"+(e<10?"0":"")+e}var Ja=class extends O{ready(){let t=this.attr("src"),e=this.$(".video-wrap"),s=this.$("video"),n=this.attr("width"),o=this.attr("height");this.css("width",n+"px"),e.css("padding-bottom",+o/+n*100+"%"),s.setAttr("poster",this.attr("poster")||t.replace(/mp4$/,"jpg")),this.hasAttr("loop")&&(s._el.loop=!0),this.hasAttr("audio")||(s._el.muted=!0),s._el.preload=this.attr("preload")==="no"?"metadata":"auto",h("source",{src:t,type:"video/mp4"},s),this.hasAttr("credit")&&(this.$(".credit").text=this.attr("credit"));let r=this.$(".bar"),a=this.$(".progress"),l=this.$(".buffer"),c=this.$(".timecode"),p=new qi(this.$(".handle"),{$parent:r,moveY:!1}),u=this.video=s._el,f=this.width-110;b.onResize(()=>f=this.width-110),s.on("canplay",()=>{c.text=Qp(+u.duration)}),s.on("timeupdate",()=>{let v=u.currentTime/u.duration;a.css("width",v*100+"%"),c.text=Qp(+u.currentTime),p.setPosition(v*f,0),this.trigger("timeupdate",u.currentTime)}),s.on("progress",()=>{if(u.buffered.length<=0||u.duration<=0)return;let y=u.buffered.end(u.buffered.length-1)/u.duration*100;l.css("width",y+"%")}),s.on("ended",()=>{u.pause(),this.removeClass("playing"),this.trigger("end")});let g=()=>u.paused?this.play():this.pause(),w=v=>this.setTime(v/f*u.duration);this.hasAttr("hover")?(s.on("mouseover touchstart",()=>this.play()),s.on("mouseout touchend touchcancel",()=>this.pause())):s.on("click",g),this.hasAttr("controls")&&(this.$(".controls").show(),this.$(".play-pause-btn").on("click",g),p.on("start",()=>this.pause()),p.on("drag",({posn:v})=>w(v.x)),r.on("click",v=>w(v.offsetX)))}setTime(t){this.video.currentTime=t}play(){this.video.play(),this.addClass("playing"),this.trigger("play")}pause(){this.video.pause(),this.removeClass("playing")}};Ja=N([A("x-video",{template:Yp})],Ja);var tl=class extends O{constructor(){super(...arguments);this.isCompleted=!1;this.isReady=!1}created(){this.userData=window.progressData||JSON.parse(this.$("#userdata").text)||{},this.$steps=this.$$("x-step");for(let t of this.$steps)t.on("score",()=>this.trigger("score"));this.data.audio&&(this.audio=new Jr(this.data.audio))}ready(){this.$footer=this.$("footer"),this.$skipStep=this.$footer.$(".skip-step"),this.$progress=this.$(".sidebar-row.active x-progress"),this.$tutor=this.$("x-tutor"),this.$stepsWrap=this.$(".steps");let t=this.findStep(b.getHash()),e=this.findStep(this.userData.activeStep);this.$activeStep=e||this.$steps[0];for(let n of this.$steps){if(n.show(),n===this.$activeStep)break;n.complete()}if(this.userData.completed||b.getHash()==="full"||this.data.reveal)this.complete();else for(;this.$activeStep&&this.$activeStep.isReady&&!this.isCompleted;)this.nextStep();(t||e&&!this.userData.completed)&&this.goToStep(t||e,!1),this.$(".section-dev")&&this.complete();let s=this.$(".reveal-banner");setTimeout(()=>{this.isCompleted||(s.removeClass("off"),this.on("score complete",()=>s.addClass("off")))},1500),s.$(".complete").one("click",()=>this.complete()),b.onKey("space",n=>{n.preventDefault(),this.nextStep(),s.addClass("off")}),this.$footer.$(".skip").on("click",()=>this.nextStep()),this.$footer.$(".show-all").on("click",()=>this.complete()),this.$footer.show(),this.isReady=!0,setTimeout(()=>this.addClass("ready"))}nextStep(){if(this.isCompleted)return;let t=this.$activeStep,e=this.$stepsWrap.height;do{if(t.complete(),t=this.$steps[this.$steps.indexOf(t)+1],!t)return this.complete(!0);t.show()}while(t.isReady);this.$stepsWrap.animate({height:[e+"px","auto"]},800),this.$activeStep=t,this.saveProgress({activeStep:t.id})}goToStep(t,e=!0){let s=this.$stepsWrap.height;for(let r of this.$steps){if(r.isShown||(this.$activeStep=r),r.show(),t.isShown&&!r.isReady)break;r.complete()}let n=t.positionTop-Math.max(50,(b.height-t.height)/2);e?(this.$stepsWrap.animate({height:[s+"px","auto"]},800),W.scrollTo(n)):W.scrollTop=n;let o=_(this.$steps);if(o.isShown&&o.isReady)return this.complete();this.$activeStep&&this.saveProgress({activeStep:this.$activeStep.id})}complete(t=!1){if(this.isCompleted)return;this.isCompleted=!0,this.$steps.forEach(s=>s.complete()),this.$activeStep=void 0;let e=this.$footer.$(".next-section");t?(this.$skipStep.exit("fade",200),e&&e.enter("pop")):(this.$skipStep.hide(),e&&e.show()),this.trigger("complete"),this.saveProgress({completed:!0}),this.log("Course","complete")}findStep(t){for(let e of this.$steps)if(e.id===t)return e}saveProgress(t){if(!this.isReady)return;let s=q(this.$steps.map(n=>n.scores.size))/+this.data.goals||0;this.$progress.setProgress(s),wd(`/course/${this.id}/${this.data.section}`,t)}log(t,e,s){if(window.ga&&this.isReady){let n=e+(s?":"+s:"");window.ga("send","event",t,n,this.id)}}};tl=N([A("x-course")],tl);var el=class{constructor(){this.callbacks=[]}add(t){this.callbacks.push(t)}start(t=1e3){return X(s=>{for(let n of this.callbacks)n(s)},t).promise}};function Jp(i,t){return i.every((e,s)=>P(e,t[s]))}function tu(i,t){i.scale*=t.scale,i.x=i.x*t.scale+t.x,i.y=i.y*t.scale+t.y}function eu(i,t){return P(i.x,t.x)&&P(i.y,t.y)&&P(i.scale,t.scale)}function ko(i,t,e){if(e==="adding"){let s=i.strokeLength,n=t<.5?0:rt("cubic-in",t*2-1);i.css({"stroke-dasharray":s+"px","stroke-dashoffset":s*(1-n)+"px"})}else if(e==="deleting"){let s=i.strokeLength,n=t<.5?rt("cubic-in",2*t):1;i.css({"stroke-dasharray":s+"px","stroke-dashoffset":s*(2-n)+"px"})}}function iu(i,t){let e=[i],s=i.expr;for(;t.startsWith(s);){if(t===s)return e;let n=_(e).next;if(!n)return;e.push(n),s+=n.expr}}function su(i,t,e=1){let s=e*Math.abs(t.x-i.x)/3,n=d.average(i,t).shift(0,s);return function(o){let r=(1-o)**2*i.x+2*o*(1-o)*n.x+o*o*t.x,a=(1-o)**2*i.y+2*o*(1-o)*n.y+o*o*t.y;return{x:r,y:a}}}function il(i,t){return Math.max(t*i,.4)/i}function oi(i){return i instanceof ni&&i.children.length>1||i instanceof ks?`(${i.expr})`:i.expr}function Be(i,t){return t.length===1&&t[0].type==="mrow"?t[0]:new ni(t,i)}var Ft=class{constructor(t,e,s,n){this.type=t;this.equation=s;this.$element=n;this.children=[];this.status="";this.value="";this.customColor="";this.roundedMotion=!1;this.width=0;this.height=0;this.baseline=0;this.transform={x:0,y:0,scale:1};this.currentDimensions=[0,0,0];this.currentWorldTransform={x:0,y:0,scale:1};this.addChildren(e),n&&s.$row.append(n)}get expr(){return""}get log(){let t=this.children.map(e=>e.log);return`<${this.type}>${t.join("")}</${this.type}>`}get color(){return this.customColor||(this.parent?this.parent.color:"")}static create(t,e){let s=t.nodeName.toLowerCase();if(Y(s,"mn","mi","mo","mtext")){if(t.textContent==="placeholder")return new Oo(e);let o=t.getAttribute("mathvariant")||void 0;return new Ki(s,t.textContent||"",e,o)}if(!Y(s,"mrow","mfrac","mfenced","msqrt","mroot","msub","msup","msubsup","munder","mover","munderover","mspace"))return new ru(t,e);if(s==="mfenced"&&t.getAttribute("open")==="["){let o=t.children.length,r=qt(Array.from(t.children,l=>Array.from(l.children,c=>Ft.create(c,e)))),a=new ou(r,e,o);return new dn([a],e)}let n=Array.from(t.children,o=>Ft.create(o,e));switch(s){case"mrow":return new ni(n,e);case"mfrac":return n=n.map(o=>Be(e,[o])),new Lo(n,e);case"mfenced":return n=[Be(e,n)],new dn(n,e);case"msqrt":return n=[Be(e,n)],new Vs(s,n,e);case"mroot":return n=n.map(o=>Be(e,[o])),new Vs(s,n,e);case"msub":case"msup":case"msubsup":return n=n.map(o=>Be(e,[o])),new ks(s,n,e);case"munder":case"mover":case"munderover":return n=n.map(o=>Be(e,[o])),new nu(s,n,e);case"mspace":return new Vo(e)}throw new Error(`Unknown element type tag ${t.nodeName}`)}get marginLeft(){return .1}get marginRight(){return .1}setTransform(t=0,e=0,s=1){this.transform.x=t,this.transform.y=e,this.transform.scale=s}get worldTransform(){let t=this,e=Object.assign({},this.transform);for(;t=t.parent;)tu(e,t.transform);return e}get index(){return this.parent?this.parent.children.indexOf(this):-1}get next(){if(!this.parent)return;let t=this.parent.children.indexOf(this);return this.parent.children[t+1]}get prev(){if(!this.parent)return;let t=this.parent.children.indexOf(this);return this.parent.children[t-1]}addChildren(t,e=this.children.length){for(let s of this.children)s.type==="placeholder"&&s.deleteFromDom();for(let s of t)s.detach(),s.parent=this;this.children.splice(e,0,...t)}insertAfter(t){let e=this.parent.children.indexOf(this);this.parent.addChildren(t,e+1)}insertBefore(t){let e=this.parent.children.indexOf(this);this.parent.addChildren(t,e)}detach(){if(this.parent){let t=this.parent.children.indexOf(this);t>=0&&this.parent.children.splice(t,1),this.parent=void 0}}deleteFromDom(){this.parent&&this.detach(),this.$element&&this.$element.remove(),this.$element=void 0;for(let t of this.children.slice(0))t.deleteFromDom()}*parents(t=!1){let e=t?this:this.parent;for(;e;)yield e,e=e.parent}hasParent(t,e=!1){return Pe(this.parents(e),t)}hitTest(t){let{x:e,scale:s}=this.worldTransform,n=this.marginLeft*s*this.equation.fontSize,o=this.marginRight*s*this.equation.fontSize;if(it(t.x,e-n,e+this.width*s+n+o))return this.hitTestChildren(t)||this}hitTestChildren(t){for(let e of this.children){let s=e.hitTest(t);if(s)return s}}measure(t=1){for(let e of this.children)e.measure(t)}clean(){for(let t of this.children)t.clean()}setStatus(t){this.status=t;for(let e of this.children)e.setStatus(t)}render(t){for(let l of this.children)l.render(t);if(!this.$element)return;let e=this.currentWorldTransform,s=this.currentWorldTransform=this.worldTransform,n=this.currentDimensions,o=this.currentDimensions=[this.width,this.height,this.baseline];if(eu(e,s)&&Jp(n,o)&&!this.status)return;if(!t){this.positionElement(s),this.drawElement(1,o[0],o[1],o[2],s.scale);return}this.status==="adding"&&this.positionElement(s);let r=s.y+this.baseline<this.equation.root.baseline?-1:1,a=this.roundedMotion?su(e,s,r):void 0;this.roundedMotion=!1,t.add(l=>{if(!this.$element)return;let c=rt("cubic",l),p=Y(this.status,"adding","deleting"),u=p?o[0]:bt(n[0],o[0],c),f=p?o[1]:bt(n[1],o[1],c),g=p?o[2]:bt(n[2],o[2],c),w=p?s.scale:bt(e.scale,s.scale,c);if(this.drawElement(l,u,f,g,w),!this.status){let v=a?a(c):d.interpolate(e,s,c);this.positionElement({x:v.x,y:v.y,scale:w})}})}positionElement(t){this.$element.setTransform(t,0,t.scale)}drawElement(t,e,s,n,o){}},wv="acegmnopqrsuvwxyz",Xi=1.1,Os=.2,sl=["=","\u2248","<",">","\u2264","\u2265"],yv=document.createElement("canvas"),au=yv.getContext("2d"),bv=le((i,t)=>(au.font=`${t}px "Source Sans Pro", sans-serif`,au.measureText(i).width)),Ki=class extends Ft{constructor(t,e,s,n){super(t,[],s,h("text",{}));this.variant=n;this.setValue(e)}setValue(t){this.$element.text=this.value=t;let e=this.value.split("").every(n=>wv.includes(n));this.width=bv(t,this.equation.fontSize),this.height=(Xi-(e?.1:0))*this.equation.fontSize,this.baseline=this.height-Os*this.equation.fontSize;let s=this.type==="mtext"||this.variant==="normal";this.$element.setClass("font-normal",s||Ui(this.value))}get expr(){return this.value==="xx"?'"xx"':this.type==="mtext"?`"${this.value}"`:this.value}get log(){return`<${this.type}>${this.value}</${this.type}>`}get marginLeft(){if(this.type==="mo")return sl.includes(this.value)?this.equation.isDisplay?.5:.35:Y(this.value,"\u2221","\u25B3","!","%","\u2019")||Y(this.value,"\u2026","\xB0")&&this.prev&&this.prev.type==="mn"?0:.25;if(this.type==="mi"){if(this.prev&&this.prev.type==="mn")return .1;if(this.prev&&this.prev.type==="mi")return .05;if(this.prev&&this.prev.type==="mfrac")return .15}return 0}get marginRight(){return this.type==="mo"?this.equation.isDisplay&&sl.includes(this.value)?.5:Y(this.value,"\u2221","\u25B3")?0:this.value==="\u2212"&&(!this.prev||sl.includes(this.prev.value))?.1:.25:0}positionElement(t){if(!this.$element)return;let e=(this.equation.fontSize-this.baseline)*t.scale;this.$element.setTransform({x:t.x,y:t.y-e},0,t.scale)}drawElement(t,e,s,n,o){this.status==="adding"?this.$element.setAttr("opacity",t<.5?0:rt("cubic-in",t*2-1)):this.status==="deleting"&&this.$element.setAttr("opacity",t<.5?1-rt("cubic-in",2*t):0),this.$element.css("stroke-width",(1-o)*1.5+"px"),this.$element.css("color",this.color||"currentColor")}},Vo=class extends Ft{constructor(t){super("mspace",[],t);this.height=(Xi-.1)*t.fontSize,this.baseline=this.height-Os*this.equation.fontSize,this.width=t.fontSize*.2}get expr(){return" "}},ni=class extends Ft{constructor(t,e,s,n=0){super("mrow",t,e);this.align=s;this.dx=n}addChildren(t,e=this.children.length){let s=[];for(let n of t)n.type==="mrow"?(s.push(...n.children),n.detach()):s.push(n);super.addChildren(s,e)}get expr(){return this.children.map(t=>t.expr).join(" ").replace(/− /,"\u2212")||"placeholder"}measure(t=1){if(super.measure(t),!this.children.length){this.height=this.width=this.baseline=0;return}this.baseline=Math.max(...this.children.map(s=>s.baseline)),this.height=this.baseline+Math.max(...this.children.map(s=>s.height-s.baseline));let e=0;for(let[s,n]of this.children.entries())n.setTransform(e,this.baseline-n.baseline),e+=n.width,s<this.children.length-1&&(e+=Math.max(n.marginRight,this.children[s+1].marginLeft)*this.equation.fontSize);if(this.align){let s=this.children.find(n=>n.expr===this.align);s&&(this.transform.x=this.dx-s.transform.x-s.width/2)}this.width=e}},Oo=class extends Ft{constructor(t){let e=t.fontSize,s=`M${.1*e} ${.3*e}h${e/2}v${e/2}h-${e/2}Z`,n=h("path",{class:"placeholder",d:s});super("placeholder",[],t,n);this.width=.7*e,this.height=Xi*e,this.baseline=this.height-Os*e}get expr(){return"placeholder"}get marginLeft(){return 0}get marginRight(){return 0}},Lo=class extends Ft{constructor(t,e){super("mfrac",t,e,h("line"))}get expr(){return this.children.map(t=>oi(t)).join("/")}measure(t){let e=this.hasParent(a=>a.type==="mfrac"||a.type==="matrix"),s=il(t,!this.equation.isDisplay||e?.66:1),n=.1*this.equation.fontSize,[o,r]=this.children;super.measure(t*s),this.width=(Math.max(o.width,r.width)+2*n)*s,this.height=(o.height+r.height)*s,this.baseline=o.height*s+this.equation.fontSize*(Xi/2-Os),o.setTransform((this.width-o.width*s)/2,0,s),r.setTransform((this.width-r.width*s)/2,o.height*s,s)}drawElement(t,e,s,n){let o=n-this.equation.fontSize*(Xi/2-Os);this.$element.setLine({x:0,y:o},{x:e,y:o}),this.$element.setAttr("stroke",this.color||"currentColor"),ko(this.$element,t,this.status)}hitTestChildren(t){let{scale:e,y:s}=this.worldTransform,n=this.baseline-this.equation.fontSize*(Xi/2-Os),o=t.y<=s+n*e,r=this.children[o?0:1];return r.hitTestChildren(t)||r}},ks=class extends Ft{get expr(){let t=oi(this.children[0]);return this.type!=="msup"&&(t+="_"+oi(this.children[1])),this.type==="msup"&&(t+="^"+oi(this.children[1])),this.type==="msubsup"&&(t+="^"+oi(this.children[2])),t}measure(t){let[e,s,n]=this.children,o=this.type==="msup"?void 0:s,r=this.type==="msubsup"?n:this.type==="msup"?s:void 0,a=.05*this.equation.fontSize,l=il(t,.65);e.measure(t),o&&o.measure(t*l),r&&r.measure(t*l);let c=r?r.height*l-.4*this.equation.fontSize:0,p=o?o.height*l-.5*this.equation.fontSize:0,u=r?r.width:0,f=o?o.width:0;this.width=e.width+a+Math.max(u,f)*l,this.height=e.height+c+p,this.baseline=e.baseline+c,e.setTransform(0,this.baseline-e.baseline),r&&r.setTransform(e.width+a,0,l),o&&o.setTransform(e.width+a,this.height-o.height*l,l)}clean(){if(super.clean(),this.children=this.children.filter(t=>t.type!=="mrow"||t.children.length),this.children.length===0)return this.detach();this.children.length===1&&(this.insertAfter(this.children),this.detach())}},nu=class extends Ft{get expr(){let t=this.children[0].expr;return this.type!=="munder"&&(t+="_"+oi(this.children[1])),this.type==="mover"&&(t+="^"+oi(this.children[1])),this.type==="munderover"&&(t+="^"+oi(this.children[2])),t}measure(t){super.measure(t)}},dn=class extends Ft{constructor(t,e){super("mfenced",t,e,h("path"))}get expr(){return`(${this.children.map(t=>t.expr).join()})`}get marginLeft(){return .2}get marginRight(){return .2}measure(t){super.measure(t);let e=this.children[0];this.height=e.height+2,this.baseline=e.baseline+1;let s=1+this.height/this.equation.fontSize,n=.1*this.equation.fontSize;this.width=e.width+2*(s+n),e.setTransform(s+n,1)}drawElement(t,e,s){let n=Math.min(2+s/this.equation.fontSize,5),o=s-4,r=e-n,a=`M${n},2c${-2*n/3},${.15*o},${-n},${.32*o},${-n},${o/2}s${n/3},${.35*o},${n},${o/2}M${r},2c${2*n/3},${.15*o},${n},${.32*o},${n},${o/2}s${-n/3},${.35*o},${-n},${o/2}`;this.$element.setAttr("d",a),this.$element.css("stroke",this.color||"currentColor"),ko(this.$element,t,this.status)}clean(){super.clean(),this.children.length||this.detach()}},Vs=class extends Ft{constructor(t,e,s){super(t,e,s,h("path"))}get expr(){return`sqrt(${this.children.map(t=>t.expr).join(", ")})`}get marginLeft(){return .2}get marginRight(){return .2}measure(t){super.measure(t);let e=this.children[0];this.height=e.height+2,this.baseline=e.baseline+2;let s=Math.min(16,3+5*this.height/this.equation.fontSize),n=.05*this.equation.fontSize;this.width=e.width+s+2*n,e.setTransform(s+n,2)}drawElement(t,e,s){let n=Math.min(16,3+5*s/this.equation.fontSize),o=s-2,r=`M0,${.55*o}L${.18*n},${.51*o}L${.45*n},${o}L${n},2L${e},2`;this.$element.setAttr("d",r),this.$element.css("stroke",this.color||"currentColor"),ko(this.$element,t,this.status)}clean(){super.clean(),this.children.length||this.detach()}},ou=class extends Ft{constructor(t,e,s){super("matrix",t,e,h("g"));this.rows=s;this.cols=Math.floor(t.length/s)}get expr(){return`${this.children.map(t=>t.expr).join(", ")}`}measure(t){super.measure(t);let e=.6*this.equation.fontSize,s=B(r=>Math.max(...B(a=>this.children[r*this.cols+a].height,this.cols)),this.rows),n=B(r=>Math.max(...B(a=>this.children[a*this.cols+r].width,this.rows)),this.cols);this.height=q(s)+(this.rows-1)*e/2,this.width=q(n)+this.cols*e,this.baseline=(this.height+Xi*this.equation.fontSize)/2;let o=0;for(let r=0;r<this.rows;++r){let a=e/2;for(let l=0;l<this.cols;++l){let c=this.children[r*this.cols+l],p=a+(n[l]-c.width)/2,u=o+(s[r]-c.height)/2;c.setTransform(p,u),a+=n[l]+e}o+=s[r]+e/2}}},ru=class extends Ft{constructor(t,e){super("foreign",[],e,h("g"));var s;this.$body=h("div",{},e.$overlay),this.$body._el.appendChild(t),this.$measure=h("span",{text:".",style:"font-size: 0"},this.$body),this.checkForResize(),this.$body.on("resize",()=>{this.checkForResize()&&this.equation.resize()}),(s=this.$body.$("x-blank, x-blank-mc"))==null||s.on("solve",n=>{xe(()=>this.replace(n.solution,"#0f82f2"),n.restore?0:200)})}deleteFromDom(){var t;super.deleteFromDom(),(t=this.$body)==null||t.remove(),this.$body=void 0,this.$measure=void 0}replace(t,e){var o;let s=isNaN(+t)?"mtext":"mn",n=new Ki(s,t,this.equation);n.customColor=e,this.insertAfter([n]),(o=this.$body)==null||o.off("resize"),this.deleteFromDom(),this.equation.resize()}checkForResize(){var n,o;let t=this.height,e=this.width,s=this.baseline;return this.height=((n=this.$body)==null?void 0:n.height)||0,this.width=((o=this.$body)==null?void 0:o.width)||0,this.baseline=this.$measure.bounds.top-this.$body.bounds.top,!(P(t,this.height)&&P(e,this.width)&&P(s,this.baseline))}positionElement(t){var e,s;(e=this.$body)==null||e.css({left:t.x+"px",top:t.y+"px"}),P(t.scale,1)||(s=this.$body)==null||s.css("transform",`scale(${t.scale})`)}get expr(){var t;return`"${(t=this.$body)==null?void 0:t.text}"`}get log(){return`<foreign>${this.expr}</foreign>`}};var Ee=class extends Ye{constructor(t,e,s=0,n="=",o=18,r=!0){super();this.$row=t;this.$overlay=e;this.fontSize=o;this.isDisplay=r;this.isReady=!0;this.deletedNodes=new Set;this.root=new ni([],this,n,s)}setValue(t){let e=Array.isArray(t)?t.map(s=>Ft.create(s,this)):this.parse(t);for(let s of this.root.children)s.deleteFromDom();this.root.addChildren(e),this.updateDescription(),this.resize()}updateDescription(){try{let t=kt.parse(this.root.expr).toVoice();this.$row.setAttr("aria-label",t)}catch(t){this.$row.setAttr("aria-label","Invalid expression: "+this.root.expr)}}resize(){this.root.measure(),this.root.render()}parse(t){var r;let e=new DOMParser,s=kt.parse(t).toMathML(),n=e.parseFromString(`<math>${s}</math>`,"text/xml");if(((r=n.firstChild)==null?void 0:r.nodeName)==="parsererror")throw new Error(n.firstChild.textContent);let o=n.firstChild.childNodes;return Array.from(o,a=>Ft.create(a,this))}find(t){let[e,s]=t.split("`");e=e.replace(/[–-]/g,"\u2212");let n=+s||1,o=this.root.children.slice(0),r=0;for(;o.length;){let a=o.shift(),l=a instanceof ni?void 0:iu(a,e);if(l&&(r+=1,r===n))return l;o.unshift(...a.children)}throw new Error(`Can't find element ${e}.`)}animate(t=1200){return R(this,null,function*(){this.isReady=!1,this.root.clean(),this.root.measure();let e=new el;this.root.render(e),this.trigger("resize",{height:this.root.height});for(let s of this.deletedNodes)s.render(e);yield e.start(t);for(let s of this.deletedNodes)s.deleteFromDom();this.root.setStatus(""),this.deletedNodes.clear(),this.isReady=!0})}addTermAfter(t,e){let s=_(e?this.find(e):this.root.children),n=this.parse(t);s.insertAfter(n);for(let o of n)o.setStatus("adding");this.updateDescription()}addTermBefore(t,e){let s=e?this.find(e)[0]:this.root.children[0],n=this.parse(t);s.insertBefore(n);for(let o of n)o.setStatus("adding");this.updateDescription()}deleteTerm(t){for(let e of this.find(t))e.setStatus("deleting"),e.detach(),this.deletedNodes.add(e);this.updateDescription()}replaceTerm(t,e){let s=this.find(t),n=this.parse(e);s[0].insertBefore(n);for(let o of n)o.setStatus("adding");for(let o of s)o.setStatus("deleting"),o.detach(),this.deletedNodes.add(o);this.updateDescription()}moveTermAfter(t,e){let s=this.find(t);for(let o of s)o.roundedMotion=!0;_(e?this.find(e):this.root.children).insertAfter(s),this.updateDescription()}moveTermBefore(t,e){let s=this.find(t);for(let o of s)o.roundedMotion=!0;(e?this.find(e)[0]:this.root.children[0]).insertBefore(s),this.updateDescription()}moveTermToStart(t){let e=this.find(t);for(let s of e)s.roundedMotion=!0;this.root.children[0].insertBefore(e),this.updateDescription()}wrapTerms(t,...e){let s=e.map(o=>this.find(o));for(let o of s)for(let r of o)r.roundedMotion=!0;let n=this.parse(t);for(let o of n)o.setStatus("adding");s[0][0].insertBefore(n);for(let[o,r]of s.entries()){let a=this.find("$"+(o+1))[0];a.insertAfter(r),a.deleteFromDom()}this.updateDescription()}unwrapTerm(t,e=1){let s=this.find(t),n=s[0],o=1;for(;o<=e;)n=n.parent,n instanceof ni&&(n=n.parent),o+=1;n.insertAfter(s),n.setStatus("deleting"),n.detach(),this.deletedNodes.add(n),this.updateDescription()}get leftSide(){let t=this.root.children.findIndex(e=>e.expr==="=");return this.root.children.slice(0,t-1)}get rightSide(){let t=this.root.children.findIndex(e=>e.expr==="=");return this.root.children.slice(t+1)}};var lu='<svg class="equation"><g></g></svg><div class="overlay"></div><div class="nav"><div class="btn back hide"><x-icon name="left"></x-icon></div><div class="btn next"><x-icon name="right"></x-icon></div></div><div class="legend-box"><slot></slot></div>';var hu=1200,$v=400,cu=1200,Ls=600,pn=16,nl=class extends O{constructor(){super(...arguments);this.rows=[];this.isReady=!0;this.topOffset=4;this.currentHeight=0;this.currentStep=0;this.nextEvents={};this.backEvents={}}ready(){this.$svg=this.$("svg"),this.$lastRow=this.$svg.$("g"),this.$overlay=this.$(".overlay"),this.$legend=this.$(".legend-box"),this.$steps=this.$legend.$$("li"),this.$back=this.$(".back"),this.$next=this.$(".next");let t=+this.attr("dx")||0;this.equation=new Ee(this.$lastRow,this.$overlay,t);let e=this.$(".math"),s=e?Array.from(e._el.children):[];this.equation.setValue(this.attr("expr")||s),this.currentHeight=this.topOffset+this.$lastRow.height+16,this.$svg.css("height",this.currentHeight+"px"),this.equation.on("resize",({height:o})=>{let r=this.topOffset+o+pn;Math.abs(r-this.currentHeight)<pn/2||(this.currentHeight=r,this.$svg.animate({height:r+"px"},cu))}),this.$back.on("click",()=>this.goBack()),this.$next.on("click",()=>this.goNext()),this.$steps[0].show(),b.onResize(()=>{let o=this.$svg.width/2;for(let r of[this.$lastRow,this.$overlay])r.css("transform",`translate(${o}px, ${this.topOffset}px)`);for(let r of this.rows)r.$el.css("transform",`translate(${o}px, ${r.top}px)`)});let n=this.$overlay.$$("x-blank, x-blank-mc");n.length&&(this.$next.addClass("hide"),Promise.all(n.map(o=>o.onPromise("solve"))).then(()=>setTimeout(()=>this.goNext(),hu)))}setup(t){this.one("next",({step:e})=>t.score("algebra-flow-"+(e-1)))}newRow(){return R(this,null,function*(){let t=this.$lastRow.copy(!0,!1),e=this.equation.root.height;this.rows.push({$el:t,height:e,top:this.topOffset}),this.$lastRow.insertBefore(t),b.redraw(),this.topOffset+=e+pn,this.currentHeight=this.topOffset+e+pn;for(let s of[this.$lastRow,this.$overlay])s.animate({transform:`translate(${this.$svg.width/2}px, ${this.topOffset}px)`},Ls);yield this.$svg.animate({height:this.currentHeight+"px"},Ls).promise})}hideLastRow(){return R(this,null,function*(){if(!this.rows.length)return;let t=this.rows.pop();this.topOffset=t.top;for(let e of[this.$lastRow,this.$overlay])e.animate({transform:`translate(${this.$svg.width/2}px, ${t.top}px)`},Ls);this.currentHeight=t.top+this.$lastRow.height+pn,this.$svg.animate({height:this.currentHeight+"px"},Ls),yield t.$el.exit("fade",Ls/2,Ls/2).promise,t.$el.remove()})}onNextStep(t){this.nextEvents=t}onBackStep(t){this.backEvents=t}goNext(){return R(this,null,function*(){if(!this.isReady||!this.equation.isReady||this.currentStep>=this.$steps.length-1)return;this.isReady=!1;let t=this.currentStep+1;this.$steps[t].hasClass("new-row")&&(yield this.newRow(),yield Xe($v)),t in this.nextEvents&&(yield this.nextEvents[t](this.equation),yield this.equation.animate(cu),yield Xe(hu)),yield this.go(t),this.trigger("next",{step:t}),this.isReady=!0})}goBack(){return R(this,null,function*(){if(!this.isReady||!this.equation.isReady||this.currentStep<=0)return;let t=this.currentStep-1;this.isReady=!1,this.currentStep in this.backEvents&&(yield this.backEvents[this.currentStep](this.equation),yield this.equation.animate()),this.$steps[this.currentStep].hasClass("new-row")&&this.hideLastRow(),yield this.go(t),this.trigger("back",{step:t}),this.isReady=!0})}go(t){return R(this,null,function*(){this.$steps[t].show();let e=this.$steps[t].height+"px";this.$steps[t].hide(),this.$legend.animate({height:e},800).promise.then(()=>this.$legend.css("height","auto"));let s=this.currentStep;this.currentStep=t,this.trigger("step",t),yield this.$steps[s].exit("fade",400).promise,this.$back.setClass("hide",t<=0),this.$next.setClass("hide",t>=this.$steps.length-1),yield this.$steps[t].enter("fade",400).promise})}};nl=N([A("x-algebra-flow",{template:lu})],nl);var du='<div class="input"><textarea></textarea></div><div class="math empty"><span class="cursor">&#8203;</span></div><div class="keys"><!-- TODO Make these buttons tabbable--><div class="btn" data-type="+">+</div><div class="btn" data-type="\u2212">\u2212</div><div class="btn" data-type="\xD7">\xD7</div><div class="btn" data-type="\xF7">\xF7</div><div class="btn i" data-type="\u03C0">\u03C0</div><div class="btn" data-type="frac"><x-icon name="fraction"></x-icon></div><div class="btn" data-type="sup"><x-icon name="power"></x-icon></div><div class="btn" data-type="sqrt"><x-icon name="sqrt"></x-icon></div><div class="btn" data-type="brackets"><x-icon name="brackets"></x-icon></div></div><div class="error"><x-icon name="warning"></x-icon></div><div class="error-message"></div>';var xi=ne;function pu(i){let t=i.prev;t&&Y(t.tagName,"MO","MI","MN")?t.insertBefore(i):t?_(t.children).append(i):i.parent.hasClass("math")||(i.parent.prev?i.parent.prev.append(i):i.parent.parent.insertBefore(i))}function xv(i){let t=i.next;if(t&&Y(t.tagName,"MO","MI","MN"))return t.insertAfter(i);t?t.children[0].prepend(i):i.parent.hasClass("math")||(i.parent.next?i.parent.next.prepend(i):i.parent.parent.insertAfter(i))}function Pv(i){let t=i.parent;for(;t.parent.tagName!=="MFRAC"||!t.prev;){if(t.hasClass("math"))return;t=t.parent}t.prev.append(i)}function Sv(i){let t=i.parent;for(;t.parent.tagName!=="MFRAC"||!t.next;){if(t.hasClass("math"))return;t=t.parent}t.next.prepend(i)}function Tv(i){let t=i.prev,e=i.parent;if(t&&Y(t.tagName,"MO","MI","MN"))t.remove(),e.children.length<=1&&e.addClass("empty");else if(!t&&!e.prev&&!e.hasClass("math")){let s=e.parent;s.insertBefore(i);for(let n of s.children)for(let o of n.children)s.insertBefore(o);s.remove(),i.parent.children.length<=1&&i.parent.addClass("empty")}else pu(i)}function Yi(i,t){t.insertBefore(i),t.parent.removeClass("empty"),i.children.length&&i.children[0].append(t)}function uu(i,t){"abcdefghijklmnopqrstuvwxyz\u03C0".includes(t)?Yi(h("mi",{text:t}),i):"0123456789.".includes(t)?Yi(h("mn",{text:t}),i):"+\u2212\xB1\xD7\xF7<>\u2264\u2265=%!".includes(t)?Yi(h("mo",{text:t,value:t}),i):t==="frac"?Yi(h("mfrac",{html:'<mrow class="empty"></mrow><mrow class="empty"></mrow>'}),i):t==="sqrt"?Yi(h("msqrt",{html:'<mrow class="empty"></mrow>'}),i):Y(t,"^","sup")?Yi(h("msup",{html:'<mrow class="empty"></mrow>'}),i):t==="brackets"||"([{|".includes(t)?Yi(h("mfenced",{html:'<mrow class="empty"></mrow>',type:"("}),i):")]}".includes(t)&&!i.next&&i.parent.parent.tagName==="MFENCED"&&i.parent.parent.insertAfter(i)}function fu(i,t){let e=i.$$(`${t}:first-child, *:not(${t}) + ${t}`);for(let s of e)if(s.parent.tagName!=="MFRAC")for(;s.next&&s.next.tagName===t.toUpperCase();)s.text+=s.next.text,s.next.remove()}var Cv="This is not a valid mathematical expression.",Mv="Fill in all empty placeholders in the expression.",Ev={"+":"addition","\xD7":"multiplication","/":"fractions or division","\u2212":"subtraction",sqrt:"square roots","^":"powers"};function Qi(i,t){if(i instanceof Text)return i.textContent||"";if(i.hasClass("cursor"))return"";let e=i.childNodes;return i.tagName==="MI"?i.text+(t?" ":""):i.tagName==="MFENCED"?"("+Qi(e[0],t)+")":i.tagName==="MSUP"?"^("+Qi(e[0],t)+")":i.tagName==="MFRAC"?`(${Qi(e[0],t)})/(${Qi(e[1],t)})`:i.tagName==="MSQRT"?"sqrt("+Qi(e[0],t)+")":e.map(s=>Qi(s,t)).join("")}function Av(i,t){try{return{expr:kt.parse(i,!0,{variables:t})}}catch(e){return{error:e instanceof et?e.message:Cv}}}function kv(i,t,e){let s=i.variables;if(t.length){let n=s.find(r=>!t.includes(r));if(n){let r=Dc(n,e||t);return r?`Did you mean \u201C<em>${r}</em>\u201D instead of \u201C<em>${n}</em>\u201D?`:`There shouldn\u2019t be a variable called \u201C<em>${n}</em>\u201D.`}let o=t.find(r=>!s.includes(r));if(o)return`Your expression should contain \u201C<em>${o}</em>\u201D.`}}function Vv(i,t){if(t.length){let e=i.functions.find(s=>!t.includes(s));if(e)return`This expression should not contain ${Ev[e]||"\u201C"+e+"\u201D"}.`}}function Ov(i,t,e=.001){try{return P(i.evaluate(),t.evaluate(),e)}catch(s){return!1}}var ol=class extends O{constructor(){super(...arguments);this.isDone=!1;this.shortVar=!1;this.lastAttempt="";this.errorCount=0;this.hints=[];this.fns=[];this.vars=[];this.validate=void 0}ready(){if(this.$math=this.$(".math"),this.$textarea=this.$("textarea"),this.$cursor=this.$(".cursor"),this.$error=this.$(".error-message"),this.solution=kt.parse(this.attr("solution")),this.hasAttr("numeric")&&(this.numeric=+this.attr("precision")||.01),this.vars=this.hasAttr("vars")?lt(this.attr("vars")):this.solution?this.solution.variables:[],this.hasAttr("fns")&&(this.fns=lt(this.attr("fns"))),this.solution&&this.fns.push(...this.solution.functions),this.fns.includes("/")&&!this.fns.includes("\xD7")&&this.fns.push("\xD7"),this.hasAttr("hints")&&(this.hints=lt(this.attr("hints"))),this.hasAttr("substitutions")){this.substitutions={},this.autocomplete=this.vars.slice(0);for(let s of this.attr("substitutions").split("|"))if(s.trim()){let[n,o]=s.split(":");this.autocomplete.push(n.trim()),this.substitutions[n.trim()]=kt.parse(o)}}for(let s of["solution","precision","vars","fns","vars-required","substitutions"])this.removeAttr(s);this.shortVar=this.hasAttr("short-var");let t=lt(this.attr("keys")||"+ \u2212 \xD7 \xF7 frac sup sqrt brackets"),e=this.$(".keys");for(let s of e.children)t.includes(s.data.type)?(s.on("pointerdown",n=>n.preventDefault()),s.on("pointerup",()=>{uu(this.$cursor,s.data.type),this.check()})):s.remove();this.on("pointerdown",s=>this.onPointerdown(s)),this.$textarea.on("focus",()=>this.onPointerdown()),this.$textarea.on("blur",()=>this.onBlur()),this.$textarea.on("key",s=>this.onKey(s))}setup(t,e,s){var n;this.$step=t,((n=s==null?void 0:s.scores)==null?void 0:n.includes(e))&&this.solve(),this.on("solve",()=>{t.addHint("correct"),t.score(e)})}focus(){this.trigger("pointerdown")}onPointerdown(t){if(this.isDone)return;t&&t.preventDefault&&t.preventDefault(),this.addClass("active"),this.$textarea.focus();let e=t&&t.target?G(t.target):this;if(e.tagName==="X-EQUATION"||e.hasClass("math")){let s=this.$math.children,n=q(s.map(r=>r.outerWidth))/2;(t?he(t).x<this.$math.bounds.left+n:!0)?this.$math.prepend(this.$cursor):this.$math.append(this.$cursor)}else if(e.tagName[0]==="M"){let s=he(t).x<e.boxCenter.x;e.tagName==="MROW"?s?e.prepend(this.$cursor):e.append(this.$cursor):s?e.insertBefore(this.$cursor):e.insertAfter(this.$cursor)}}onKey(t){if(Y(t.code,xi.enter,xi.escape))this.$textarea.blur();else if(t.code===xi.left)pu(this.$cursor);else if(t.code===xi.right)xv(this.$cursor);else if(t.code===xi.up)Pv(this.$cursor);else if(t.code===xi.down)Sv(this.$cursor);else if(Y(t.code,xi.backspace,xi.delete))Tv(this.$cursor),this.check();else{let e=t.key.replace("*","\xD7").replace("/","\xF7").replace("-","\u2212");uu(this.$cursor,e),this.check()}}onBlur(){if(this.isDone)return;if(!this.value)return this.removeClass("active has-error");if(this.removeClass("active"),this.addClass("has-error"),this.value===this.lastAttempt||(this.lastAttempt=this.value,!this.$step))return;let t=this.error||(this.hints||[]).shift()||"incorrect",e=this.$step.addHint(t,{class:"incorrect"});this.$error.html=(e==null?void 0:e.text)||"",this.errorCount+=1,this.trigger("error",{count:this.errorCount,msg:t}),this.errorCount>=5&&this.$step.addHint(`Hmmm\u2026 maybe try ${this.solution.toMathML()}?`)}check(){if(this.error=void 0,this.value=Qi(this.$math,this.shortVar).trim(),!this.value)return;if(this.$math.$(".empty"))return this.error=Mv;let t=Av(this.value,this.vars);if(t.error)return this.error=t.error;let e=this.substitutions?t.expr.substitute(this.substitutions):t.expr;if(this.numeric&&Ov(this.solution,e,this.numeric))return this.solve();if(this.validate){let o=this.validate(t.expr)||{};if(o.isCorrect)return this.complete(t.expr);if(o.error)return this.error=o.error}if(this.solution&&kt.numEquals(this.solution,e))return this.complete(t.expr);let s=kv(e,this.vars,this.autocomplete);if(s)return this.error=s;let n=Vv(e,this.fns);if(n)return this.error=n}complete(t){this.isDone||(this.isDone=!0,this.removeClass("has-error active"),this.addClass("done"),this.$textarea.blur(),this.shortVar||fu(this.$math,"mi"),fu(this.$math,"mn"),this.trigger("solve",{expr:t}))}solve(){this.$math.removeClass("empty"),this.$math.html=this.solution.toMathML(),this.complete(this.solution)}};ol=N([A("x-equation",{template:du})],ol);var Lv={opacity:[0,1],transform:["translateX(-50px)","none"]},Rv={error:"You\u2019ve already had this expression before. Try simplifying it."},Iv="You have to fully simplify this expression. The correct solution is $0.",rl=class extends O{constructor(){super(...arguments);this.rowCount=1;this.previousAnswers=[];this.isSolved=!1;this.maxRows=6;this.steps=[];this.hints=[]}created(){this.$table=this.$("table tbody"),this.lastRowContent=this.$table.$("tr:last-child").html}ready(){this.hasAttr("max-rows")&&(this.maxRows=+this.attr("max-rows")),this.hasAttr("steps")&&(this.steps=this.attr("steps").split("|")),this.hasAttr("hints")&&(this.hints=this.attr("hints").split("|")),this.removeAttr("steps"),this.removeAttr("hints"),this.setupEquation(this.$("x-equation"))}setup(t,e,s){var n;this.$step=this.$equation.$step=t,((n=s==null?void 0:s.scores)==null?void 0:n.includes(e))&&this.solve(),this.on("solve",()=>{t.addHint("correct"),t.score(e)}),this.on("hint",o=>t.addHint(o))}setupEquation(t){this.$equation=t,this.$equation.$step=this.$step,t.one("solve",e=>this.onSolveRow(e.expr)),t.hints=this.hints,t.validate=e=>{let s=this.previousAnswers.includes(e.toString());return(this.validate?this.validate(e,s):void 0)||(s?Rv:{})}}onSolveRow(t){if(this.trigger("solve-row",{expr:t,$math:this.$equation.$math}),this.isFinal&&this.isFinal(t))return this.trigger("solve");if(this.isSolved)return;if(this.rowCount+=1,this.previousAnswers.push(t.toString()),this.rowCount>this.maxRows){let s=this.$equation.solution.toMathML();this.trigger("hint",Iv.replace("$0",s)),this.trigger("solve")}let e=h("tr",{html:this.lastRowContent},this.$table);e.animate(Lv,400,500),this.setupEquation(e.$("x-equation")),setTimeout(()=>this.$equation.focus(),1200)}solve(){if(this.isSolved=!0,this.steps.length){let t=this.$table.$("tr:last-child"),e=this.lastRowContent.replace(/<x-equation.*<\/x-equation>/,'<span class="math fill"></span>');for(let s of this.steps){let n=h("tr",{html:e},this.$table),o=n.$(".math.fill"),r=kt.parse(s);o.html=r.toMathML(),t.insertBefore(n),this.trigger("solve-row",{expr:r,$math:o})}}this.$equation.solve()}};rl=N([A("x-equation-system")],rl);var dt=Math.PI/2;function Ro(i){if(wt(i))return[i];if(te(i))return i.points;if(Te(i))return[i.p1,i.p2];if(ie(i))return Ro(i.shape(!0));if(ct(i))return[i.c.shift(i.r,0),i.c.shift(-i.r,0),i.c.shift(0,i.r),i.c.shift(0,-i.r)];if(Ne(i)||ee(i)){let t=[i.start,i.end];Ne(i)&&t.push(i.c);let e=i.radius;for(let[s,n]of[[e,0],[0,e],[-e,0],[0,-e]]){let o=i.c.shift(s,n);Jt.prototype.contains.call(i,o)&&t.push(o)}return t}return[]}function ri(...i){return x.aroundPoints(function*(){for(let t of i)for(let e of Ro(t))yield e}())}function Io(i,t,e=0){if(!i.size&&!t.size)return new At(0,100,0,100);let s=x.aroundPoints(function*(){for(let n of i.values())if(n.transformed&&!n.hidden)for(let o of Ro(n.transformed))yield o;for(let n of t.values())if(n.path)for(let o of Ro(n.path))yield o}());return new At(s.p.x-e,s.p.x+s.w+e,s.p.y-e,s.p.y+s.h+e)}function Rs(i,t,e){if(wt(t))return i.contains(t);if(ms(t))return M.collision(i.polygon,t);if(Fr(t))return t.collision(i);if(Ct(t))return ft(t,i).length>0||i.contains(t.p1);if(ie(t))return Rs(i,t.shape(!0),e);if(ct(t))return e==="geo"?ft(t,i).length>0||i.contains(t.at(0)):t.collision(i);if(Ne(t)){let s=new M(t.c,t.start,t.at(.25),t.at(.5),t.at(.75),t.end);return M.collision(i.polygon,s)}return!1}var al=class{constructor(t){this.$parent=t;this.visible=!1;this.$el=h("div",{class:"tile-error",hidden:!0},t.$html),this.$text=h("span",{},this.$el),this.$button=h("button",{text:"Select Errors"},this.$el),this.$button.on("click",()=>{t.selection.clear(),this.error&&t.selection.select(this.error.locations),this.hide()})}show(t,e){this.visible&&this.error===e||(this.visible=!0,this.$el.setTransform(t),this.$text.html=e.message,this.$button.toggle(!!(e==null?void 0:e.locations.length)),this.$el.enter("pop",200),this.error=e)}hide(){!this.visible||(this.visible=!1,this.$el.exit("pop",200),this.error=void 0)}},ll=new Map;function E(i){if(!i||!b.theme.isDark)return i;if(ll.has(i))return ll.get(i);let t=F.fromHex(i),e=t.hsl;it(e[2],20,80)||(e[2]=100-e[2]);let s=F.fromHsl(...e);s.a=t.a;let n=s.hex;return ll.set(i,n),n}function mu(i){let t=i==null?void 0:i.items;if(!!(t==null?void 0:t.length))for(let e=0;e<t.length;++e){if(!t[e].type.startsWith("image/"))continue;let s=t[e].getAsFile();if(s)return s}}var Nv=80,Gv=[5,2,1];function Pi(i,t,e,s=.01){let n=i?i.split(","):[];if(n.length===3)return n.map(f=>+f);let o=n.length>0?+n[0]:e?e[0]:0,r=n.length>1?+n[1]:e?e[1]:t;if(P(o,r))return[o-1,r+1,1];s&&(r+=.01*(r-o));let a=Math.floor(Math.abs(t)/Nv),l=(r-o)/a,c=Math.floor(Math.log10(l)),p=Math.pow(10,c),u=Gv.find(f=>p*f<=l)*p;return r=u*Math.ceil(r/u),o=u*Math.floor(o/u),[o,r,u]}function No(i,t=4e3){let e=G(`x-alert[key=${i}]`);return e==null?void 0:e.open(t)}function gu(i){var t;if(!["span","div","br"].includes(i.tagName.toLowerCase()))(t=i.parentElement)==null||t.removeChild(i);else{for(let e of Array.from(i.attributes))e.name==="style"?e.value=(e.value||"").replace(/[^\w\s.:;\-%]/g,""):i.removeAttributeNode(e);for(let e of Array.from(i.children))gu(e)}}function vu(i){let e=new DOMParser().parseFromString(i,"text/html").body;for(let s of Array.from(e.children))gu(s);return e.innerHTML}function hl(i){let t=Math.min(...i.map(s=>Math.min(...s.map(n=>n.y)))),e=Math.max(...i.map(s=>Math.max(...s.map(n=>n.y))));return[t,e]}function ze(i,t,e){return i.hasAttr(t)?i.attr(t)!=="no":e}function wu(i){let t=lt(i).map(e=>+e);return t.length===1?[t[0],t[0],t[0],t[0]]:t.length===2?[t[0],t[1],t[0],t[1]]:t.length===3?[t[0],t[1],t[2],t[1]]:t}function yu(i){let t=i.split(",");return[t[0]!=="no",(t.length>1?t[1]:t[0])!=="no"]}var bu={hasGeoModel:!0,pi:Math.PI,point:(i,t)=>i!==void 0&&t!==void 0?new d(i,t):void 0,angle:(i,t,e)=>i&&t&&e?new Ot(i,t,e):void 0,line:(i,t)=>i&&t&&!i.equals(t)?new $t(i,t):void 0,ray:(i,t)=>i&&t&&!i.equals(t)?new Dr(i,t):void 0,segment:(i,t)=>i&&t&&!i.equals(t)?new st(i,t):void 0,circle:(i,t)=>i&&t?new H(i,t):void 0,arc:(i,t,e)=>i&&t&&e?new Jt(i,t,e):void 0,sector:(i,t,e)=>i&&t&&e?new Ie(i,t,e):void 0,polygon:(...i)=>i.every(t=>t)?new M(...i):void 0,polyline:(...i)=>i.every(t=>t)?new se(...i):void 0,triangle:(i,t,e)=>i&&t&&e?new tn(i,t,e):void 0,rectangle:(i,t,e)=>i?new x(i,t,e):void 0,distance:d.distance,round:(i,t=0)=>Kt(i,t),sqrt:Math.sqrt,floor:Math.floor,ceil:Math.ceil,intersections:ft};function Go(i,t,e){let s=e,n;for(let o of i){let r=t(o);r!==void 0&&r<s&&(s=r,n=o)}return n}function $u(i,t){t.clear();for(let e of i)if(!(e.isHidden||!e.value))for(let s of i){if(e.isHidden||!s.value||e===s)continue;let n=ft(e.value,s.value);for(let[o,r]of n.entries())t.add({path1:e,path2:s,posn:r,index:o})}}var xu="M100,50h0l-5.2-4.9L52.6,10.2v-9C52.6.6,51.4,0,50,0s-2.6.6-2.6,1.2v9L5.2,45.1,0,50H0l6.6-3L35,25.9H65L93.4,47ZM38.4,23.5,50,14.8l11.6,8.7Z",Pu="M0,0V8H100V0ZM7,6A2,2,0,1,1,9,4,2,2,0,0,1,7,6Z";function Ji(i,t,e,s){return`translate(${i.x}px, ${i.y-t}px) scale(${s/100}) rotate(${e}rad)`}var Su=4,Dv=`<marker id="axis-arrow" refX="3" refY="3" markerWidth="6"
    markerHeight="6" orient="auto"><path d="M 0 0 L 6 3 L 0 6 z"/></marker>`,ts=class extends O{constructor(){super(...arguments);this.labelSuffix=["",""];this.gridSize=[1,1];this.showGrid=!1;this.showXAxis=!1;this.showYAxis=!1;this.showLabels=!1}setupCoordinates(t,e={}){this.$svg=t,t.addClass("canvas"),this.proportional=!!e.proportional,this.padding=wu(this.attr("padding")||e.padding||"0"),ze(this,"grid",e.showGrid||!1)&&(this.$grid=h("g",{class:"grid"}),t.prepend(this.$grid),this.showGrid=!0);let s=this.attr("axes")||(e.showAxes?"yes":"no");[this.showXAxis,this.showYAxis]=yu(s),(this.showXAxis||this.showYAxis)&&(h("defs",{html:Dv},t),this.$axes=h("g",{class:"axes"}),t.prepend(this.$axes),this.axisNames=(this.attr("axis-names")||",").split(",")),this.$axes&&ze(this,"labels",!0)&&(this.labelSuffix=(this.attr("label-suffix")||",").split(","),this.showLabels=!0),(this.showLabels||this.axisNames)&&(this.$labels=h("g",{class:"labels"},t)),this.resize()}resize(){this.css("max-width","none");let t=+this.attr("width")||this.width,e=+this.attr("height")||(this.hasAttr("width")?t:this.height);this.css("max-width",t+"px"),this.$svg.setAttr("width",t),this.$svg.setAttr("height",e),this.$svg.setAttr("viewBox",`0 0 ${t} ${e}`);let s=this.padding;this.viewportBounds=new At(s[3],t-s[1],s[0],e-s[2]),this.updatePlotBounds(),this.positionElements(t,e)}updatePlotBounds(t){let[e,s,n]=Pi(this.attr("x-axis"),this.viewportBounds.dx,t==null?void 0:t.xRange),[o,r,a]=Pi(this.attr("y-axis"),this.viewportBounds.dy,t==null?void 0:t.yRange),l=Math.abs(this.viewportBounds.dx/(s-e)),c=Math.abs(this.viewportBounds.dy/(r-o)),p=Math.min(l,c),u=this.proportional?l/p:1,f=this.proportional?c/p:1;this.plotBounds=new At(u*e,u*s,f*r,f*o),this.plotScale=this.proportional?p:(l+c)/2,this.gridSize=[n,a];let[g,w]=[this.plotBounds,this.viewportBounds];this.plotToViewportMatrix=[[w.dx/g.dx,0,w.xMin-g.xMin/g.dx*w.dx],[0,w.dy/g.dy,w.yMin-g.yMin/g.dy*w.dy]];let v=e>0?u*e:s<0?u*s:0,y=o>0?f*o:r<0?f*r:0;this.plotOrigin=new d(v,y),this.drawAxes()}drawAxes(){let[t,e]=[this.plotBounds,this.viewportBounds],s=this.toViewportCoords(this.plotOrigin),[n,o]=this.gridSize;if(this.$grid&&this.$grid.removeChildren(),this.$axes&&this.$axes.removeChildren(),this.$labels&&this.$labels.removeChildren(),this.showGrid||this.showXAxis){let r=n*Math.trunc(t.xMin/n+.01);for(let a=r;a<t.xMax;a+=n){if(this.showYAxis&&a===this.plotOrigin.x)continue;let l=this.toViewportCoords(new d(a,0)).x;this.showGrid&&h("line",{x1:l,y1:e.yMin,x2:l,y2:e.yMax},this.$grid),this.showLabels&&this.makeLabel(0,a,l,s)}}if(this.showGrid||this.showYAxis){let[r,a]=t.yMin<t.yMax?[t.yMin,t.yMax]:[t.yMax,t.yMin],l=o*Math.trunc(r/o+.01);for(let c=l;c<a;c+=o){if(this.showXAxis&&c===this.plotOrigin.y)continue;let p=this.toViewportCoords(new d(0,c)).y;this.showGrid&&h("line",{x1:e.xMin,y1:p,x2:e.xMax,y2:p},this.$grid),this.showLabels&&this.makeLabel(1,c,p,s)}}this.showXAxis&&(this.$xAxis=h("line",{x1:e.xMin,x2:e.xMax,y1:s.y,y2:s.y},this.$axes)),this.showYAxis&&(this.$yAxis=h("line",{x1:s.x,x2:s.x,y1:e.yMax,y2:e.yMin},this.$axes)),this.showLabels&&this.showXAxis&&this.showYAxis&&(t.xMin===0&&t.yMax===0&&!this.labelSuffix[0]&&!this.labelSuffix[1]?h("text",{text:0,x:s.x-5,y:s.y+15,"text-anchor":"end"},this.$labels):t.yMax===this.plotOrigin.y?this.makeLabel(0,this.plotOrigin.x,s.x,s):this.makeLabel(1,this.plotOrigin.y,s.y,s)),this.axisNames&&(this.axisNames[0]&&h("text",{text:this.axisNames[0],x:this.viewportBounds.xMax-2,y:s.y-12,"text-anchor":"end"},this.$labels),this.axisNames[1]&&h("text",{text:this.axisNames[1],x:s.x+10,y:this.viewportBounds.yMin+5},this.$labels))}makeLabel(t,e,s,n){let o=this.labelSuffix[t],r=o==="i"?new Tt(0,e).toString():nt(e,4)+o;h("text",{text:r,x:t?n.x-8:s,y:t?s+4:n.y+18,"text-anchor":t?"end":"middle"},this.$labels),h("line",{class:"tick",x1:t?n.x:s,y1:t?s:n.y,x2:t?n.x-Su:s,y2:t?s:n.y+Su},this.$axes)}positionElements(t,e){for(let s of this.$$("[data-bounds]")){let n=s.data.bounds.split(","),o=this.toViewportCoords(new d(+n[3],+n[0])),r=this.toViewportCoords(new d(+n[1],+n[2]));s.css({left:`${o.x/t*100}%`,top:`${o.y/e*100}%`,width:`${(r.x-o.x)/t*100}%`,height:`${(r.y-o.y)/e*100}%`})}}toPlotCoords(t){return t.changeCoordinates(this.viewportBounds,this.plotBounds)}toViewportCoords(t){return t.transform(this.plotToViewportMatrix)}};var cl=class extends ts{constructor(){super(...arguments);this.steps=400}ready(){let t=h("svg",{},this),e=h("g",{class:"plot"},t);this.$path=h("path",{},e),this.setupCoordinates(t,{showGrid:!0,showAxes:!0,padding:"20"}),this.clear();let s=this.viewportBounds,n=this.steps/s.dx,o;Ii(t,{start:()=>o=void 0,move:r=>{let a=S(Math.round((r.x-s.xMin)*n),0,this.steps-1);this.points[a]=this.toPlotCoords(new d(s.xMin+a/n,r.y)),o&&this.interpolate(o,a),o=a,this.redraw()},end:()=>this.snap()})}interpolate(t,e){e<t&&([t,e]=[e,t]);let s=this.points[t],n=this.points[e];for(let o=t+1;o<e;++o)this.points[o]=d.interpolate(s,n,(o-t)/(e-t))}redraw(){let t="",e=!0;for(let s of this.points){if(s){let n=this.toViewportCoords(s);t+=(e?"M":"L")+`${n.x},${n.y}`}e=!s}this.$path.setAttr("d",t)}snap(){let t=this.points.filter(s=>s).map(s=>[s.x,s.y]),e=Gr.bestPolynomial(t);if(!!e){for(let s=0;s<this.steps;++s){if(!this.points[s])continue;let n=this.plotBounds.xMin+s/this.steps*this.plotBounds.dx;this.points[s]=new d(n,e.fn(n))}this.redraw(),this.trigger("snap",{regression:e})}}clear(){this.points=Ht(void 0,this.steps),this.$path.setAttr("d","")}};cl=N([A("x-coordinate-sketch")],cl);var _v=2,Tu=5e3,dl=class extends ts{constructor(){super(...arguments);this.isAnimated=this.hasAttr("animate");this.crosshairGrid=10;this.getCrosshairPosn=t=>t}ready(){let t=h("svg",{},this);if(this.$plot=h("g",{class:"plot"},t),this.$overlay=h("g",{class:"overlay"},t),this.setupCoordinates(t,{showGrid:!0,showAxes:!0,padding:"20"}),this.hasAttr("fn")){let e=kt.parse(this.attr("fn"),!0);this.setFunctions(s=>e.evaluate({x:s}))}ze(this,"crosshairs",!0)&&(this.crosshairGrid=+this.attr("crosshair-grid")||10,this.setupCrosshairs(t))}setPoints(t,e=1){let s=t.map((n,o)=>new d(o+e,n));this.setSeries(s)}setSeries(...t){let e=Math.max(...t.map(o=>_(o).x)),[s,n]=hl(t);this.updatePlotBounds(new At(0,e,s,n)),this.$plot.removeChildren();for(let o of t)this.drawLinePlot(o);this.getCrosshairPosn=o=>t[0].reduce((r,a)=>Math.abs(a.x-o.x)<=Math.abs(r.x-o.x)?a:r)}setFunctions(...t){let[e,s]=[this.plotBounds,this.viewportBounds],n=t.map(l=>{let c=[];for(let p=s.xMin;p<s.xMax;p+=_v){let u=this.toPlotCoords(new d(p,0)).x;c.push(new d(u,l(u)))}return c}),[o,r]=hl(n);this.updatePlotBounds(new At(e.xMin,e.xMax,o,r)),this.$plot.removeChildren();for(let l of n)this.drawLinePlot(l);let a=this.gridSize[0]/this.crosshairGrid;this.getCrosshairPosn=l=>{let c=ht(S(l.x,e.xMin,e.xMax),a);return new d(c,t[0](c))}}drawLinePlot(t){let e=h("g",{},this.$plot),s=h("path",{},e),n=this.plotBounds;t=t.filter(r=>r.y>=n.yMax&&r.y<=n.yMin);let o=t.map(r=>this.toViewportCoords(r));this.isAnimated?X(r=>{let a=t.findIndex(l=>l.x>n.xMin+r*n.dx);s.points=o.slice(0,a)},Tu):s.points=o}drawPoints(t){let e=h("g",{},this.$plot),s=this.plotBounds;for(let n of t){let o=this.toViewportCoords(n),r=h("circle",{r:4,cx:o.x,cy:o.y},e);if(this.isAnimated){r.hide();let a=Tu*(n.x-s.xMin)/(s.xMax-s.xMin);setTimeout(()=>r.show(),a)}}}setupCrosshairs(t){let e=h("g",{class:"crosshair"},t),s=h("path",{},e),n=h("circle",{r:4},e),o=h("text",{},e),r=0,a=l=>{let c=this.getCrosshairPosn(this.toPlotCoords(l));if(P(c.x,r))return;r=c.x;let p=this.toViewportCoords(c),u=this.toViewportCoords(this.plotOrigin);n.setCenter(p),s.points=[new d(u.x,p.y),p,new d(p.x,u.y)],o.text=`(${nt(c.x,5,!1)}, ${nt(c.y,5,!1)})`;let f=o.width,g=p.x+8+f<this.viewportBounds.dx;o.setAttr("x",g?p.x+5:p.x-f-5),o.setAttr("y",p.y>20?p.y-7:p.y+18)};Sd(t,{enter:()=>e.show(),move:l=>a(l),exit:()=>e.hide()})}};dl=N([A("x-coordinate-system")],dl);var un=class{constructor(t,e){this.$canvas=t;this.defaultCallbacks=e;this.callbacks=new WeakMap;this.global=[];this.isMoving=!1;this.shiftKey=!1;this.altKey=!1;this.cancelled=!1;setTimeout(()=>{document.addEventListener("keydown",s=>{this.shiftKey=s.shiftKey,this.altKey=s.altKey}),document.addEventListener("keyup",s=>{this.shiftKey=s.shiftKey,this.altKey=s.altKey}),document.addEventListener("visibilitychange",()=>{this.shiftKey=this.altKey=!1})},2e3),t.css("touch-action","none"),t.on("pointerdown",s=>this.startEvent(s)),b.onKey("escape",()=>this.cancel()),e.hover&&t.on("pointermove",s=>{this.isMoving||e.hover({posn:ge(s,t),event:s})})}listen(t,e){this.callbacks.set(t._el,e),t.hasParent(this.$canvas)||(t.css("touch-action","none"),t.on("pointerdown",s=>this.startEvent(s)))}listenAll(t){this.global.push(t)}startEvent(t){var p,u,f;if(t.handled||t.button)return;this.isMoving=!0,this.cancelled=!1,t.preventDefault();let e=t.pointerId,s=this.getCallbacks(t.target);"shiftKey"in t&&(this.shiftKey=t.shiftKey),s.blurInput!==!1&&((p=b.getActiveInput())==null||p.blur());let n=ge(t,this.$canvas),o=n,r=!1,a=g=>{var y,C,k,L;if(g.pointerId&&g.pointerId!==e)return;if(g.preventDefault(),this.cancelled)return l(g);let w=ge(g,this.$canvas);if(d.distance(w,o)<.5)return;if(!r){let V={posn:n,event:g};(y=s.start)==null||y.call(s,V);for(let ot of this.global)(C=ot.start)==null||C.call(ot,V)}let v={posn:w,startPosn:n,lastPosn:o,event:g};(k=s.move)==null||k.call(s,v);for(let V of this.global)(L=V.move)==null||L.call(V,v);!r&&s.cursor!==!1&&zt.addClass("grabbing"),o=w,r=!0},l=g=>{var v,y,C,k,L,V;if(g.pointerId&&g.pointerId!==e)return;g.preventDefault(),W.off("pointermove",a),W.off("pointerstop",l);let w={posn:n,event:g};(v=s.up)==null||v.call(s,w);for(let ot of this.global)(y=ot.up)==null||y.call(ot,w);if(r){let ot={posn:o,lastPosn:o,startPosn:n,event:g,cancelled:this.cancelled};(C=s.end)==null||C.call(s,ot);for(let Gt of this.global)(k=Gt.end)==null||k.call(Gt,ot)}else if(!this.cancelled){let ot={posn:n,event:g};(L=s.click)==null||L.call(s,ot);for(let Gt of this.global)(V=Gt.click)==null||V.call(Gt,ot)}zt.removeClass("grabbing"),this.isMoving=this.cancelled=!1},c={posn:n,event:t};(u=s.down)==null||u.call(s,c);for(let g of this.global)(f=g.down)==null||f.call(g,c);W.on("pointermove",a),W.on("pointerstop",l)}getCallbacks(t){for(;t;){let e=this.callbacks.get(t);if(e&&(!e.checkIfActive||e.checkIfActive()))return e;t=t.parentNode||void 0}return this.defaultCallbacks}cancel(){this.cancelled=!0}};function Hv(i,t){if(typeof i=="string"){let e=Pt(i);return s=>{var n;return(n=e(t))==null?void 0:n.equals(s)}}return typeof i=="function"?i:e=>i.equals(e)}function pl(i,t,e){let s=t.map(g=>Hv(g,i.model)),n=Ht(void 0,t.length),o=di(),r=[],a=({point:g})=>r.push(g),l=e.maxErrors||4,c=0,p=({path:g})=>{e.onBegin&&e.onBegin(g)},u=()=>{n.every(g=>g)&&(e.onComplete&&e.onComplete(!0),i.off("add:path",f),i.off("begin:path",p),i.off("add:point",a),o.resolve(n))},f=({path:g})=>{let w=g.value;if(!!w){for(let[v,y]of s.entries())if(!n[v]&&y(w))return n[v]=g,e.onCorrect&&e.onCorrect(g,v),c=0,r=[],u();g.delete();for(let v of r)v.delete();if(r=[],!(Ct(w)&&w.length<1))if(c+=1,c>=l){let v=n.findIndex(C=>!C),y=t[v];if(typeof y!="function"){let C=i.drawPath(y,{animated:1e3});n[v]=C,e.onHint&&e.onHint(C,v),c=0,u()}}else e.onIncorrect&&e.onIncorrect(g)}};return i.on("begin:path",p),i.on("add:path",f),i.on("add:point",a),o.promise}function Cu(i,t){return h("text",{target:i.attr("target")||void 0,class:i.attr("label-class")||i.attr("class")||void 0,"data-when":i.data.when,style:t?`color: ${t}`:void 0,"text-anchor":"middle"})}function Mu(i,t){let e=[];for(let s of t.paths)s!==i&&s.value&&e.push(s.value.transform(t.plotToViewportMatrix));return e}var qv=new H(new d(0,-9),12);function Eu(i,t,e){for(let s of e)if(t.every(n=>!ft(qv.translate(s),n).length))return s;return e[0]}function Au(i,t){let e=i.value.transform(t.plotToViewportMatrix),s=i.$el;if(Ct(e)){let n=e.perpendicularVector,o=e.angle;n.y>=0&&(n=n.scale(-1),o+=Math.PI);let r=[];for(let c of[.5,.35,.65])for(let p of[-15,5])r.push(e.at(c).add(n.scale(p)));if(!t.labelPositioning)return[r[0],o];let a=Mu(i,t),l=Eu(e,a,r);return s.hasAttr("mark")&&(l=l.add(e.unitVector.scale(12))),[l,o]}if(Ne(e))return[e.at(.5).subtract(e.c).scale(.6).add(e.c).shift(0,5)];if(ee(e)){let n=new $t(e.start,e.end),o=n.perpendicularVector.y>=0,r=n.angle+(o?Math.PI:0);return[e.at(.5).add(n.perpendicularVector.scale(o?14:5)),r]}if(ie(e)){let n=(+s.attr("size")||(e.isRight&&!s.hasAttr("round")?20:e.radius))+8;return[e.b.add(e.bisector.unitVector.scale(n+5)).shift(0,3)]}if(wt(e)){let n=s.hasClass("move")?10:8,o=[e.shift(n,-n),e.shift(-n,-n),e.shift(n,10+n),e.shift(-n,10+n)];if(!t.labelPositioning)return[o[0]];let r=Mu(i,t);return[Eu(e,r,o)]}return te(e)?[e.centroid.shift(0,5)]:ct(e)?[e.c.shift(0,5)]:[]}var ul=class{constructor(t,e,s,n){this.$parent=t;this.$el=s;this.color="";this.label="";this.isPending=!1;this.isLocked=!1;this.components=[];this.dependencies=[];this.fixedLabel=!1;this.name=n||t.model.getKey(),t.shapes.set(this.name,this),t.model.watch(o=>{let r=o[this.name];this.$el.css("display",r?"block":"none"),this.$label&&this.$label.css("display",r?"block":"none"),r&&this.redraw(r),t.queueLabelPositioning()}),this.color=s.css("color")||"",this.setValue(e),s.hasAttr("label")&&this.setLabel(s.attr("label"))}get value(){return this.$parent.model[this.name]}get type(){var t;return(t=this.value)==null?void 0:t.type}get locked(){return this.isLocked}get isHidden(){return this.isPending||this.$el.hasAttr("hidden")||this.$el.hasClass("transparent")}setValue(t){t instanceof Function?this.$parent.model.setComputed(this.name,t):this.$parent.model[this.name]=t}setLabel(t,e,s){this.$label||(this.$label=Cu(this.$el,e),this.$parent.$objLabels.append(this.$label));let n=oo(t);if(this.$parent.model.watch(o=>this.$label.text=n(o)||""),this.fixedLabel=!!s,s){let o=Pt(s);this.$parent.model.watch(r=>{this.$label.setTransform(o(r).shift(0,5))})}this.updateLabelPosition()}setColor(t){this.color=t,this.$el.css("color",t);for(let e of this.dependencies)e.setColor(t);this.$label&&this.$label.css("color",t)}updateLabelPosition(){if(!this.$label||!this.value||this.fixedLabel)return;let[t,e]=Au(this,this.$parent);this.$label.setTransform(t,e)}select(){this.$el.addClass("selected"),this.$el.parent.append(this.$el);for(let t of this.dependencies)t.select()}deselect(){this.$el.removeClass("selected");for(let t of this.dependencies)t.deselect()}hover(t=!1){if(!t){if(this.$parent.hovering===this)return;this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.hovering=this}this.$el.addClass("hover");for(let e of this.dependencies)e.hover(!0)}unhover(t=!1){if(!t){if(this.$parent.hovering!==this)return;this.$parent.hovering=void 0}this.$el.removeClass("hover");for(let e of this.dependencies)e.unhover(!0)}delete(t=300){return R(this,null,function*(){this.$parent.shapes.delete(this.name);for(let e of this.components)e.deselect();this.$label&&this.$label.exit("fade",t,0,!0),yield this.removeElement(t),this.$parent.model[this.name]=void 0})}},ai=class extends ul{constructor(t,e,s,n,o=!1){n||(n=h("circle",{})),super(t,e,n,s),this.$parent.hidePoints||t.$points.append(this.$el),t.points.add(this),this.projectionId=t.model.getKey(),this.projectionOffset=void 0,t.model.watch(r=>{this.projection=r[this.projectionId],this.projection&&(this.projectionOffset===void 0&&(this.projectionOffset=this.projection.offset(this.$parent.model[this.name])),this.$parent.model[this.name]=this.projection.at(this.projectionOffset))}),this.lock(o)}setValue(t){t instanceof Function?(this.project(void 0),this.$parent.model.setComputed(this.name,t)):(t&&this.projection&&(t=this.projection.project(t),this.projectionOffset=this.projection.offset(t)),this.$parent.model[this.name]=t)}redraw(t){let e=t.transform(this.$parent.plotToViewportMatrix);this.$el.setCenter(e),this.$halo&&this.$halo.setCenter(e),this.$pulse&&this.$pulse.setCenter(e)}removeElement(t){return R(this,null,function*(){this.$parent.points.delete(this),yield this.$el.exit("pop",t,0,!0).promise})}distance(t){return this.value?d.distance(t,this.value):Infinity}lock(t=!0){this.isLocked=t,this.$el.setClass("move",!t),t?this.$el.removeAttr("tabindex"):this.$el.setAttr("tabindex",0)}project(t){if(this.projectionOffset=void 0,typeof t=="string"){let e=Pt(t);this.$parent.model.setComputed(this.projectionId,e)}else t?this.$parent.model.setComputed(this.projectionId,()=>t.value):this.$parent.model[this.projectionId]=void 0}makeIntersection({path1:t,path2:e,index:s}){this.setValue(n=>{if(!n[t.name]||!n[e.name])return;let o=ft(n[t.name],n[e.name]);return o[Math.min(s,o.length-1)]}),this.lock()}addHalo(){this.$halo=h("circle",{class:"halo",r:18},this.$parent.$pulses),this.$halo.setCenter(this.$el.center),this.$halo.enter("pop")}removeHalo(){return R(this,null,function*(){!this.$halo||(this.$halo.exit("pop",500,0,!0),this.$halo=void 0)})}pulsate(){this.$pulse=h("circle",{class:"pulse",r:8},this.$parent.$pulses),this.$pulse.setCenter(this.$el.center),this.$el.one("mouseover pointerdown focus",()=>{this.$pulse&&this.$pulse.remove(),this.$pulse=void 0})}},Si=class extends ul{constructor(t,e,s,n){super(t,e,n||h("path"),s);t.$paths.append(this.$el),t.paths.add(this)}get locked(){return this.isLocked||!this.components.length||this.components.every(t=>t.locked)}redraw(t){let e=t.transform(this.$parent.plotToViewportMatrix);this.$el.draw(e,{box:this.$parent.viewportRect})}distance(t){return this.value?d.distance(t,this.value.project(t)):Infinity}removeElement(t){return R(this,null,function*(){this.$parent.paths.delete(this),yield this.$el.exit("draw",t,0,!0).promise})}setComponents(t,e){this.components=this.dependencies=t,this.setValue(()=>{let s=t.map(n=>n.value);if(!s.some(n=>n===void 0))return e(...s)})}};var Do=class{constructor(t){this.$parent=t}enable(){}down(t){}start(t){}move(t,e){}end(t){}hover(t){}click(t){}cancel(){}snapToGrid(t){return this.$parent.snapToGrid?t.round(this.$parent.snapToGrid):t}snapToPoint(t,e){if(this.snapPoint=this.$parent.getPointAt(e),this.snapPoint)return t.$el.setClass("move",!this.snapPoint.locked),t.setValue(this.snapPoint.value);if(this.snapIntersect=this.$parent.getIntersectionAt(e),this.snapIntersect)return t.$el.removeClass("move"),t.setValue(this.snapIntersect.posn);if(!this.$parent.snapToGrid&&(this.snapPath=this.$parent.getPathAt(e),this.snapPath))return t.setValue(this.snapPath.value.project(e));t.$el.addClass("move"),t.setValue(this.snapToGrid(e))}getOrMakePointAt(t){let e=this.$parent.getPointAt(t);if(!e){e=new ai(this.$parent,this.snapToGrid(t));let s=this.$parent.getIntersectionAt(t);if(s)e.makeIntersection(s);else if(!this.$parent.snapToGrid){let n=this.$parent.getPathAt(t);n&&e.project(n)}this.$parent.trigger("add:point",{point:e})}return e}showPendingPointAt(t){var n,o,r;let e=((n=this.$parent.getIntersectionAt(t))==null?void 0:n.posn)||((r=(o=this.$parent.getPathAt(t))==null?void 0:o.value)==null?void 0:r.project(t)),s=!!e;if(this.$parent.$pendingPoint.toggle(s),s){let a=this.$parent.toViewportCoords(e||t);this.$parent.$pendingPoint.setCenter(a)}}},_o=class extends Do{constructor(){super(...arguments);this.isMoving=!1}enable(){}down(t){this.obj=this.$parent.getPointAt(t)||this.$parent.getPathAt(t),this.obj||this.$parent.deselect();let e=this.$parent.selection;e!==this.obj&&(e&&e.components.includes(this.obj)||this.$parent.select(this.obj))}start(){!this.obj||(this.isMoving=!0,this.obj.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("move",{obj:this.obj}))}move(t,e){if(!(!this.obj||this.obj.locked||this.$parent.locked))if(this.obj instanceof Si){let s=t.subtract(e);for(let n of this.obj.components)n.locked||n.setValue(n.value.add(s))}else this.obj instanceof ai&&this.obj.setValue(this.snapToGrid(t))}end(){!this.obj||(this.isMoving=!1,this.obj.isPending=!1,this.snapPoint||(this.snapIntersect?this.obj.makeIntersection(this.snapIntersect):this.snapPath&&this.obj.project(this.snapPath)),this.$parent.trigger("moveEnd",{path:this.obj}),this.obj=void 0,this.$parent.updateIntersections())}hover(t){if(this.isMoving)return;let e=this.$parent.getPointAt(t)||this.$parent.getPathAt(t),s=e&&!this.$parent.locked&&!e.locked,n=e&&this.$parent.canSelect;this.$parent.setCursor(s?"grab":n?"pointer":"default"),s||n?e.hover():this.$parent.hovering&&this.$parent.hovering.unhover()}},fl=class extends _o{down(t){this.$parent.deselect(),this.obj=this.getOrMakePointAt(t),this.$parent.select(this.obj)}hover(t){let e=this.$parent.getPointAt(t);if(e)return this.$parent.setCursor(this.$parent.locked||e.locked?"default":"grab"),this.$parent.$pendingPoint.hide(),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(t)}},fn=class extends Do{enable(){this.$parent.setCursor("crosshair")}down(t){this.$parent.deselect(),this.startPoint=this.getOrMakePointAt(t)}start(t){!this.startPoint||(this.$parent.$pendingPoint.hide(),this.endPoint=new ai(this.$parent,t),this.endPoint.isPending=!0,this.endPoint.$el.addClass("pending"),this.path=new Si(this.$parent,void 0),this.path.setComponents([this.startPoint,this.endPoint],this.expr),this.path.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("begin:path",{path:this.path,start:this.startPoint}))}move(t){if(!this.startPoint||!this.path||!this.endPoint)return;if(d.distance(t,this.startPoint.value)<20/this.$parent.plotScale)return this.endPoint.setValue(this.snapToGrid(t));this.snapToPoint(this.endPoint,t)}end(){if(!this.startPoint||!this.path||!this.endPoint)return;this.path.isPending=!1,this.endPoint.isPending=!1,this.startPoint.value.equals(this.endPoint.value)?(this.endPoint.delete(),this.path.delete(),this.path=this.endPoint=void 0):this.snapPoint?(this.path.setComponents([this.startPoint,this.snapPoint],this.expr),this.endPoint.delete(),this.endPoint=void 0):this.snapIntersect?this.endPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.endPoint.project(this.snapPath),this.endPoint&&(this.$parent.trigger("add:point",{point:this.endPoint}),this.endPoint.$el.removeClass("pending"));let t=this.path;this.startPoint=this.endPoint=this.path=void 0,t&&(this.$parent.trigger("add:path",{path:t}),this.$parent.updateIntersections())}hover(t){let e=this.$parent.getPointAt(t);if(e)return this.$parent.$pendingPoint.hide(),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.showPendingPointAt(t)}cancel(){this.endPoint&&this.endPoint.delete(),this.path&&this.path.delete(),this.$parent.$pendingPoint.hide(),this.startPoint=this.endPoint=this.path=void 0}},ml=class extends fn{expr(t,e){return new st(t,e)}},gl=class extends fn{expr(t,e){return new H(t,d.distance(t,e))}},vl=class extends fn{expr(t,e){return new x(t,e.x-t.x,e.y-t.y)}},wl=class extends fn{expr(t,e){return new st(t,e).perpendicularBisector}},ku=(i,t,e)=>new Ot(i,t,e).bisector,yl=class extends Do{enable(){}down(t){if(this.$parent.deselect(),!this.firstPoint)this.firstPoint=this.getOrMakePointAt(t),this.firstPoint&&this.firstPoint.addHalo();else if(this.secondPoint){this.path.isPending=this.thirdPoint.isPending=!1,this.thirdPoint.$el.removeClass("pending"),this.firstPoint.removeHalo(),this.secondPoint.removeHalo(),this.snapPoint?(this.path.setComponents([this.firstPoint,this.secondPoint,this.snapPoint],ku),this.thirdPoint.delete(),this.thirdPoint=void 0):this.snapIntersect?this.thirdPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.thirdPoint.project(this.snapPath);let e=this.path,s=this.thirdPoint;this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0,s&&this.$parent.trigger("add:point",{point:s}),this.$parent.trigger("add:path",{path:e}),this.$parent.updateIntersections()}else{if(this.secondPoint=this.getOrMakePointAt(t),!this.secondPoint)return;this.secondPoint.addHalo(),this.thirdPoint=new ai(this.$parent,this.secondPoint.value),this.thirdPoint.$el.addClass("pending"),this.path=new Si(this.$parent,void 0),this.path.setComponents([this.firstPoint,this.secondPoint,this.thirdPoint],ku),this.path.isPending=this.thirdPoint.isPending=!0}}hover(t){if(this.$parent.$pendingPoint.hide(),this.thirdPoint){this.snapToPoint(this.thirdPoint,t),this.$parent.setCursor(this.snapPoint?"pointer":"crosshair");return}let e=this.$parent.getPointAt(t);if(e)return this.$parent.setCursor("pointer"),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(t)}cancel(){this.firstPoint&&this.firstPoint.removeHalo(),this.secondPoint&&this.secondPoint.removeHalo(),this.thirdPoint&&this.thirdPoint.delete(),this.path&&this.path.delete(),this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0}};var Vu='<x-select class="tools"><div class="tool" data-tool="move"><x-icon name="hand" size="28"></x-icon></div><div class="tool" data-tool="point"><x-icon name="geo-point" size="28"></x-icon></div><div class="tool" data-tool="line"><x-icon name="geo-line" size="28"></x-icon></div><div class="tool" data-tool="rectangle"><x-icon name="geo-rectangle" size="28"></x-icon></div><div class="tool" data-tool="circle"><x-icon name="geo-circle" size="28"></x-icon></div><div class="tool" data-tool="perpBisector"><x-icon name="geo-perp-bisector" size="28"></x-icon></div><div class="tool" data-tool="angleBisector"><x-icon name="geo-angle-bisector" size="28"></x-icon></div></x-select><slot></slot>';var bl=class extends ts{constructor(){super(...arguments);this.shapes=new Map;this.points=new Set;this.paths=new Set;this.intersections=new Set;this.snapToGrid=0;this.locked=!1;this.hidePoints=!1;this.canSelect=!1;this.canIntersect=!1;this.canProject=!0;this.labelPositioning=!1;this.cursor="default"}ready(){let t=this.children.filter(a=>a.tagName==="SVG")[0];if(this.hasAttr("complex")&&(this.setAttr("label-suffix",",i"),this.setAttr("axis-names","Real, Imaginary"),this.setAttr("axes","true"),this.setAttr("grid","true")),!this.hasAttr("x-axis")&&!this.hasAttr("y-axis")){let a=+this.attr("grid"),l=+this.attr("width")||this.width,c=+this.attr("height")||l;this.setAttr("x-axis",a?`-0.5,${l/a-.5},1`:`0,${l},1`),this.setAttr("y-axis",a?`${c/a-.5},-0.5,1`:`${c},0,1`),a&&this.setAttr("snap",1)}this.setupCoordinates(t,{proportional:!0}),this.viewportRect=this.viewportBounds.rect,this.model=this.getParentModel()||mt({}),this.model.hasGeoModel||this.model.assign(bu),this.$paths=h("g",{class:"paths"},t),this.$pulses=h("g",{class:"pulses"},t),this.$points=h("g",{class:"points"},t),this.$objLabels=h("g",{class:"labels"},t),this.snapToGrid=this.hasAttr("snap")?+this.attr("snap")||1:0,this.hidePoints=this.hasAttr("no-points"),this.canIntersect=ze(this,"intersections",!1),this.canProject=ze(this,"projections",!0),this.canSelect=ze(this,"selectable",!1),this.labelPositioning=ze(this,"label-positioning",!0),this.hasClass("sticky")&&this.css("top",`calc(50vh - ${this.height/2}px)`),this.queueLabelPositioning=Le(()=>{for(let a of this.shapes.values())a.updateLabelPosition()},0,!0);let e=t.$$("path[x], path[\\:d], circle");for(let a of e){let l=a.hasAttr("x")?Pt(a.attr("x")):void 0,c=a.attr("name");if(a.hasAttr(":d"))this.$paths.append(a),a.bindModel(this.model);else if(a.tagName==="PATH")this.$paths.append(a),new Si(this,l,c,a);else{this.$points.append(a);let p=!a.hasClass("move"),u=l||a.center,f=new ai(this,u,c,a,p);a.hasAttr("project")&&f.project(a.attr("project")),a.hasClass("pulsate")&&f.pulsate()}}this.$pendingPoint=h("circle",{class:"pending"},this.$points),this.$pendingPoint.hide(),this.updateIntersections();let s={move:new _o(this),point:new fl(this),line:new ml(this),circle:new gl(this),perpBisector:new wl(this),angleBisector:new yl(this),rectangle:new vl(this)};this.$tools=this.$(".tools");let n=s[this.$tools.$active.data.tool];n.enable();let o=()=>this.toolOverride||n;this.$tools.on("change",a=>{o().cancel(),this.toolOverride=void 0,n=s[a.data.tool],this.hovering&&this.hovering.unhover(),this.$pendingPoint.hide(),this.hovering=void 0,this.deselect(),n.enable()});let r=(a,l=!1)=>this.toPlotCoords(l?a.clamp(this.viewportBounds,8):a);new un(t,{down:a=>o().down(r(a.posn)),start:a=>o().start(r(a.posn)),move:a=>o().move(r(a.posn,!0),r(a.lastPosn,!0)),end:a=>o().end(r(a.posn,!0)),click:a=>o().click(r(a.posn)),hover:a=>o().hover(r(a.posn))}),b.onKey("escape",()=>o().cancel()),b.onKey("backspace delete",()=>this.delete()),document.addEventListener("keydown",a=>{if([37,38,39,40].indexOf(a.keyCode)<0)return;let c=b.getActiveInput();if(!(!c||!c.hasParent(this))){a.preventDefault();for(let p of this.points){if(p.$el!==c||!p.value)continue;let u=15/this.plotScale,f=this.plotBounds.yMin>this.plotBounds.yMax?-1:1,g=a.keyCode===37?-u:a.keyCode===39?u:0,w=a.keyCode===38?-f*u:a.keyCode===40?f*u:0;p.setValue(p.value.shift(g,w));return}}})}switchTool(t){this.$tools.makeActive(this.$(`.tool[data-tool="${t}"]`))}setCursor(t="default"){t!==this.cursor&&(this.cursor=t,this.$svg.css("cursor",t))}select(t){!this.canSelect||(this.deselect(),t&&(this.selection=t,t.select()),this.trigger("select",{shape:t}))}deselect(){!this.selection||(this.selection.deselect(),this.selection=void 0,this.trigger("select",{shape:void 0}))}delete(){this.hovering&&this.hovering.unhover(),this.selection&&this.selection.delete(),this.trigger("select",{shape:void 0})}redraw(){this.resize(),this.viewportRect=this.viewportBounds.rect,this.model.forceUpdate()}getPointAt(t,e=20){if(this.hidePoints)return;let s=n=>n.isHidden?void 0:n.distance(t);return Go(this.points,s,e/this.plotScale)}getPathAt(t,e=10){if(this.hidePoints||!this.canProject)return;let s=n=>n.isHidden?void 0:n.distance(t);return Go(this.paths,s,e/this.plotScale)}getIntersectionAt(t,e=20){if(!this.canIntersect)return;let s=n=>d.distance(t,n.posn);return Go(this.intersections,s,e/this.plotScale)}updateIntersections(){!this.canIntersect||this.hidePoints||$u(this.paths,this.intersections)}drawPath(t,e={}){typeof t=="string"&&(t=Pt(t));let s=new Si(this,t,e.name);e.classes&&s.$el.addClass(e.classes),e.target&&s.$el.setAttr("target",e.target);let n=s.$el.hasClass("fill")?"fade":"draw";return e.animated&&s.$el.enter(n,e.animated),s}drawPoint(t,e={}){typeof t=="string"&&(t=Pt(t));let s=new ai(this,t,e.name,void 0,e.interactive===!1);return e.classes&&s.$el.addClass(e.classes),e.target&&s.$el.setAttr("target",e.target),e.animated!==0&&s.$el.enter("pop",e.animated||500),s}animatePoint(t,e,s=400){let n=this.shapes.get(t),o=new st(this.model[t],e);return X(r=>n.setValue(o.at(rt("quad",r))),s)}animateConstruction(t,e=2e3){return R(this,null,function*(){let s=this.shapes.get(t),n=s.value;if(ct(n)&&(n=n.arc),Ct(n)){this.$ruler||(this.$ruler=h("path",{d:Pu,class:"sketch"},this.$svg));let o=Ji(n.at(-.1),12,n.angle-.3,n.length*1.2),r=Ji(n.at(-.1),12,n.angle,n.length*1.2);this.$ruler.show(),s.$el.hide(),yield this.$ruler.animate({opacity:[0,1],transform:[o,r]},500).promise,yield s.$el.enter("draw",e).promise,yield this.$ruler.animate({opacity:[1,0],transform:[r,o]},500).promise}else if(ee(n)){this.$compass||(this.$compass=h("path",{d:xu,class:"sketch"},this.$svg));let o=Ji(n.c,50,n.startAngle,n.radius*1.5),r=Ji(n.c,50,n.startAngle,n.radius),a=Ji(n.c,50,n.startAngle+n.angle,n.radius),l=Ji(n.c,50,n.startAngle+n.angle,n.radius*1.5);this.$compass.show(),s.$el.hide(),yield this.$compass.animate({opacity:[0,1],transform:[o,r]},500).promise,s.$el.enter("draw",e),yield this.$compass.animate({transform:[r,a]},e,0,"linear").promise,yield this.$compass.animate({opacity:[1,0],transform:[a,l]},500).promise}})}showGesture(t,e){this.$gesture||(this.$gesture=h("x-gesture",{},this)),this.$gesture.stop();let s=this.toViewportCoords(Pt(t)(this.model));if(this.$gesture.from=s,e){let n=this.toViewportCoords(Pt(e)(this.model));this.$gesture.start(n.subtract(s))}else this.$gesture.start();this.one("click mouseover pointerdown",()=>this.$gesture.stop())}waitForPoint(){return R(this,null,function*(){return new Promise(t=>{this.one("add:point",({point:e})=>t(e))})})}waitForPath(s){return R(this,arguments,function*(t,e={}){return(yield pl(this,[t],e))[0]})}waitForPaths(t,e={}){return pl(this,t,e)}};bl=N([A("x-geopad",{template:Vu})],bl);var Ou='<div class="image"></div><div class="content"><slot></slot></div>';var $l=class extends O{ready(){let t=this.$(".image"),e=this.positionTop<50,s,n;t.css({"background-image":`url("${this.attr("background")}")`,height:e?"100%":"150%"});let o=({height:a})=>{let l=this.positionTop;s=Math.max(0,l-a),n=l+this.height};function r(a){if(a.top<s||a.top>n)return;let l=(a.top-s)/(n-s)*(e?50:33);t.css("transform",`translateY(${l}%)`)}b.onResize(o),W.on("scroll",r)}};$l=N([A("x-parallax",{template:Ou})],$l);var Lu=6,Bv="M8.1-1.7l-14-8.8c-0.6-0.4-1.4-0.4-2-0.1c-0.6,0.4-1,1-1,1.7V8.8c0,0.7,0.4,1.4,1,1.7c0.3,0.2,0.6,0.3,1,0.3c0.4,0,0.7-0.1,1.1-0.3l14-8.8C8.6,1.3,9,0.7,9,0S8.6-1.3,8.1-1.7z",mn=!1;function Ru(i){if(!Array.isArray(i))return Ru([i,0]);let[t,e]=i;if(t instanceof d)return[[t,e]];if(ct(t)&&(t=new x(t.c.shift(-t.r),2*t.r,2*t.r)),!(t instanceof M)&&!(t instanceof x))return[[$,0]];let s=t.edges.map(n=>[n.midpoint,n.perpendicularBisector.angle]).filter(n=>!P(n[1],1.5*Math.PI));return Ys(s,e)}var xl=class{constructor(t,e,s){this.tile=t;this.name=e;this.options={};this.cables=new Set;s&&this.setOptions(s)}get location(){let t=this.options.location;return Array.isArray(t)?t[0]:t}get type(){return(this.location||this.tile.path)instanceof d?"POINT":"REGION"}get points(){let t=this.options.location||this.tile.path||$;return Ru(t).map(e=>[this.tile.worldPosn(e[0]),e[1]])}setOptions(t,e=!0){Object.assign(this.options,t),e&&this.redraw()}redraw(){for(let t of this.cables)t.redraw()}},Pl=class extends xl{sendMessage(t){this.cables.size===0&&this.redraw();for(let e of this.cables.values())e.enqueueMessage(t,!1);Iu()}addCable(t,e=!1){this.cables.add(t),e&&this.tile.$parent.change({changed:[this.tile]}),!t.to&&!t.dragging&&this.cables.size>1&&this.removeCable(t,!1),this.redraw()}removeCable(t,e=!0){this.cables.delete(t),t.delete(),e&&this.redraw()}redraw(){if(Pe(this.cables,t=>t.to))for(let t of this.cables)!t.to&&!t.dragging&&this.removeCable(t);this.cables.size||this.addCable(new re(this)),super.redraw()}delete(){for(let t of this.cables)t.delete()}},Sl=class extends xl{setOptions(t,e=!0){Object.assign(this.options,t);let s=Array.isArray(t.location)?t.location[0]:t.location;s instanceof d?this.$dot=h("circle",{class:"link-dot persist",r:Lu,cx:s.x,cy:s.y},this.tile.$el):this.$dot&&this.$dot.remove(),e&&this.redraw()}addCable(t,e){e&&this.tile.highlight(!0),this.cables.add(t),this.options.connect&&this.options.connect(t)}removeCable(t,e){var s,n;e&&this.tile.highlight(!1),(n=(s=this.options).disconnect)==null||n.call(s,t),this.cables.delete(t)}delete(){for(let t of this.cables)t.from.removeCable(t)}validateConnection(t){return Tl(t,this)}},Cl=[],Ml=!1;function Iu(){var t,e;if(Ml)return;Ml=!0;let i=0;for(;Cl.length;){if(i>=1e4)throw new Error("Queue overflow!");let[s,n]=Cl.shift();((t=s.to)==null?void 0:t.options.message)&&((e=s.to)==null||e.options.message(n,s)),i++}Ml=!1}function Tl(i,t){if(i.tile===t.tile||t.options.max&&[...t.cables].filter(o=>o.from!==i||o.to!==t).length>=t.options.max)return!1;let e=t.options.tileTypes;if(e){let n=i.tile.type;if(!e.includes(n))return!1}let s=i.options.tileTypes;if(s){let n=t.tile.type;if(!s.includes(n))return!1}return!0}var re=class{constructor(t,e){this.from=t;this.dragging=!1;let s=this.from.tile.$parent,n=t.options.persistent?"":"dashed";this.$group=h("g",{class:"link-bar",style:"display:none"},t.tile.$el),this.$line=h("path",{style:"pointer-events: none",class:n},this.$group),this.$originDot=h("circle",{class:"link-dot",r:Lu},this.$group),this.$handle=h("path",{class:"link-handle",d:Bv},this.$group),this.connectTo(e),s.events.listen(this.$handle,{start:()=>{s.selection.add(t.tile,!0),mn=this.dragging=!0},move:({posn:r})=>{this.connectTo(s.getInputAt(r,this.from),r)},end:()=>{mn=this.dragging=!1,this.to&&this.to.tile.highlight(!1),this.redraw(),t.addCable(this,!0)},click:()=>{this.connectTo(),t.addCable(this,!0)}});let o;s.events.listen(this.$originDot,{start:()=>{s.selection.add(t.tile,!0),o=new re(this.from),mn=o.dragging=!0,this.from.addCable(o)},move:({posn:r})=>{o.connectTo(s.getInputAt(r,this.from),r)},end:()=>{o.to&&o.to.tile.highlight(!1),o.redraw(),mn=o.dragging=!1,t.addCable(o,!0),o=void 0}})}connectTo(t,e){this.to&&this.to!==t&&this.to.removeCable(this,!0),t?this.to!==t&&Tl(this.from,t)&&(this.to=t,t.addCable(this,e!==void 0),this.from.options.connect&&this.from.options.connect(this)):this.to=void 0,this.redraw(e)}redraw(t){var w;if(!(this.from.options.persistent||this.from.tile.isActive||((w=this.to)==null?void 0:w.tile.isActive)))return this.$group.hide();if(this.from.tile.$el.append(this.$group),this.$group.show(),!this.to&&!t){let[v,y]=this.from.points[0],C=new H($,20).at(y/(Math.PI*2));this.$handle.setTransform(this.from.tile.relativePosn(v).add(C),y),this.$line.setAttr("d",""),this.$originDot.hide();return}let s=this.to?this.to.points:[[t,0]],n=cs(this.from.points,s),[o,r]=Qe(n,([v,y])=>d.distance(v[0],y[0])),a=this.from.tile.relativePosn(o[0]),l=r[1]+Z((this.to?this.to.tile.rot:180)-this.from.tile.rot),c=this.to?new H($,14).at(l/(Math.PI*2)):$,p=this.from.tile.relativePosn(r[0]).add(c),u=d.distance(a,p),f=a.add(d.fromPolar(o[1],u*.7)),g=p.add(d.fromPolar(l,Math.max(u*.7,40)));this.$line.setAttr("d",`M${p.x} ${p.y}C${g.x} ${g.y},${f.x} ${f.y},${a.x} ${a.y}`),this.$handle.setTransform(p,l+Math.PI,this.to?.8:1),this.$originDot.setTransform(a),this.$originDot.show()}delete(){this.connectTo(),this.$group.remove()}enqueueMessage(t,e=!0){if(Cl.push([this,t]),e&&Iu(),!this.from.options.highlights)return;let n=t.type==="number"&&t.value===1?m.yellow:m.blue;this.$line.setAttr("style",`stroke: ${n}`),this.$handle.setAttr("style",`fill: ${n}`)}serialize(){return this.to?{fromPort:this.from.name,toTileId:this.to.tile.id,toPort:this.to.name}:void 0}static unSerialize(t,e,s){var r,a;let n=s.tiles.get(t),o=s.tiles.get(e.toTileId);if(n&&o){let l=(r=n.outPorts)==null?void 0:r.get(e.fromPort||"main"),c=(a=o.inPorts)==null?void 0:a.get(e.toPort||"main");l&&c&&Tl(l,c)&&l.addCable(new re(l,c))}}static get isMoving(){return mn}};var m={grey:"#cccccc",darkGrey:"#242436",red:"#cd0e66",orange:"#eb4726",yellow:"#fd8c00",lime:"#bfc212",green:"#22ab24",teal:"#009ea6",blue:"#0f82f2",purple:"#6d3bbf"},zv="M12.5,0H0V25H12.5a12.5,12.5,0,0,0,0-25Z",Fv="M0,0V12.5a12.5,12.5,0,0,0,25,0V0Z",jv="M22.1,19.5l-9.2-16a1,1,0,0,0-1.8,0l-9.2,16A1,1,0,0,0,2.7,21H21.3A1,1,0,0,0,22.1,19.5Zm-8.7-11v2.4l-.4,4.4H11.1l-.4-4.4V8.5ZM12,19.4a1.6,1.6,0,0,1-1.6-1.6,1.6,1.6,0,1,1,3.2,0A1.6,1.6,0,0,1,12,19.4Z",Ho=new Map,Is;function I(i){Is||(Is=[]),Is.push(...i)}var T=class{constructor(t,e,s){this.$parent=t;this.options="";this.colour="";this.posn=$;this.rot=0;this.snapPoints=[];this.snapLines=[];this.snapAngles=[0,90];this.canDragToSelect=!0;this.canRotate=!0;this.canMove=!0;this.$el=s||h("g",{class:"tile"},t.$tiles[2]),this.id=e||ci(10),t.tiles.set(this.id,this),Ho.set(this.$el._el,this)}makeHandle(t,e,s,n,o){let a=h(t==="c"?"circle":"path",{class:"handle"},this.$el);t==="h"&&a.setAttr("d",zv),t==="v"&&a.setAttr("d",Fv),t==="c"&&a.setAttr("r",10);let l="",c;return this.$parent.events.listen(a,{start:()=>{this.$parent.selection.add(this,!0),l=this.options,c=this.size,n==null||n()},move:({posn:p})=>e(this.relativePosn(p),p),click:()=>s==null?void 0:s(),end:()=>{o==null||o(),(this.options!==l||this.size!==c)&&this.$parent.change({changed:[this]})}}),a}is(t){return this.type===t}setColour(t,e){this.colour=t}setSize(t){this.size=t}setOrder(t){t!==this.order&&(this.order=t,this.$container.append(this.$el))}setHandles(t=!1){this.hideHandles=t,this.$el.setClass("no-handles",t)}setLabels(t){this.labels=t}lock(t=!0){t!==!!this.locked&&(this.$el.setClass("locked-tile",t),this.locked=t,this.canSelect||this.$parent.selection.remove(this))}hide(t=!0){t!==!!this.hidden&&(this.$el.setClass("hidden-tile",t),this.hidden=t,this.canSelect||this.$parent.selection.remove(this))}get canSelect(){return this.$parent.state.setupMode||!this.hidden&&!this.locked}flip(t){this.flipped=!this.flipped}click(t){}doubleClick(t){}down(t){}up(t){}format(t){}focus(){this.$parent.focussedTile=this,this.$parent.selection.clear(),this.isFocussed=!0,this.$parent.trigger("change-focus",{tiles:[this]})}blur(){this.isFocussed=!1,this.$parent.focussedTile=void 0,this.$parent.trigger("change-focus",{tiles:[]})}get $container(){let t=this.order==="back"?0:this.order==="front"?2:1;return this.$parent.$tiles[t*2+(this.isActive?1:0)]}select(){this.isActive=!0,this.$el.addClass("active"),this.$container.append(this.$el),this.redrawCables()}deselect(){this.isActive=!1,this.$el.removeClass("active"),this.$container.append(this.$el),this.redrawCables()}redrawCables(){var t,e;for(let s of((t=this.inPorts)==null?void 0:t.values())||[])s.redraw();for(let s of((e=this.outPorts)==null?void 0:e.values())||[])s.redraw()}watchPolypadOptions(t){this.polypadOptionCallbacks||(this.polypadOptionCallbacks=[]),this.polypadOptionCallbacks.push(t),this.$parent.options.watch(t)}moveStart(t=!1){this.startPosn=this.posn}move(t,e){t&&(this.posn=this.startPosn.add(t),this.transform(!0))}showErrorIcon(t){var e;if(this.currentError=t,!t)return(e=this.$errorIcon)==null?void 0:e.detach();this.$errorIcon||(this.$errorIcon=h("g",{style:"cursor: pointer"}),h("circle",{cx:12,cy:12,r:12,fill:"transparent"},this.$errorIcon),h("path",{d:jv,fill:m.yellow},this.$errorIcon),this.transform(),this.$parent.events.listen(this.$errorIcon,{click:()=>{let s=this.$errorIcon.transformMatrix,n=this.posn.shift(s[0][2],s[1][2]);this.$parent.warningBanner.show(n,this.currentError)}})),this.$el.append(this.$errorIcon)}moveEnd(){this.collision&&this.collide(this.collision)}highlight(t=!0){}findNearby(t,e,s=this.posn){for(let n of this.$parent.getTilesOfType(t))if(n!==this&&d.distance(s,n.posn)<e)return n}setCollision(t){var e;t&&t===this.collision||((e=this.collision)==null||e.highlight(!1),this.collision=t,t==null||t.highlight(!0))}collide(t){}transform(t=!1){var s;let e=Z(this.rot);this.$el.setTransform(this.posn,e),this.customTransform(this.posn,e),this.redrawCables(),!t&&this.path&&(this.transformed=this.path.rotate(e).translate(this.posn),this.padding&&(this.transformedPadded=ri(this.path).padding(...this.padding).rotate(e).translate(this.posn)),this.snapPoints=this.getSnapPoints().map(n=>n.rotate(e).translate(this.posn)),this.snapLines=this.getSnapLines().map(n=>n.rotate(e).translate(this.posn)),(s=this.$errorIcon)==null||s.setTransform(ri(this.path).p.shift(-28,5)))}customTransform(t,e){}setTransform(t,e=this.rot){this.posn=t,this.rot=Rt(e,360),this.transform()}animateTo(t,e=this.posn,s=400){return this.setTransform(t),X(n=>{n=rt("sine",n),this.$el.setTransform(d.interpolate(e,t,n),Z(this.rot))},s).promise}static makeThumbnail(t,e,s){}getSnapPoints(){return this.path?wt(this.path)?[this.path]:te(this.path)?this.path.points:Ct(this.path)?[this.path.p1,this.path.p2]:ct(this.path)?[this.path.c,this.path.c.shift(0,this.path.r),this.path.c.shift(0,-this.path.r),this.path.c.shift(this.path.r,0),this.path.c.shift(-this.path.r,0)]:Ne(this.path)?[this.path.c,this.path.start,this.path.end]:ee(this.path)?[this.path.start,this.path.end]:ie(this.path)?[]:[]:[]}getSnapLines(){return[]}delete(){var t,e;for(let s of this.polypadOptionCallbacks||[])this.$parent.options.unwatch(s);this.$parent.selection.remove(this);for(let s of((t=this.inPorts)==null?void 0:t.values())||[])s.delete();for(let s of((e=this.outPorts)==null?void 0:e.values())||[])s.delete();this.$parent.tiles.delete(this.id),this.$parent.mathContext.removeSource(this),Ho.delete(this.$el._el),this.$el.remove()}relativePosn(t){return t.subtract(this.posn).rotate(-Z(this.rot))}worldPosn(t){return t.rotate(Z(this.rot)).add(this.posn)}get center(){return this.path?ri(this.path).center:$}get ariaDescription(){return`${this.type}: ${this.options}`}applyChange(t){var e,s,n,o,r,a;if(t.options!==this.options){let l=[...t.cables||this.getCableData("out"),...this.getCableData("in")];this.delete(),t=Object.assign(this.serialize(),t);let c=T.unSerialize(t,this.$parent);for(let p of l)re.unSerialize(c.id,p,this.$parent);return}if((t.x!==void 0||t.y!==void 0||t.rot!==void 0)&&this.setTransform(new d((s=(e=t.x)!=null?e:this.posn.x)!=null?s:0,(o=(n=t.y)!=null?n:this.posn.y)!=null?o:0),(a=(r=t.rot)!=null?r:this.rot)!=null?a:0),t.colour&&t.colour!==this.colour&&this.setColour(t.colour),!t.flipped!=!this.flipped&&this.flip(),!t.locked!=!this.locked&&this.lock(!!t.locked),!t.hidden!=!this.hidden&&this.hide(!!t.hidden),!t.hideHandles!=!this.hideHandles&&this.setHandles(!!t.hideHandles),!t.labels!=!this.labels&&this.setLabels(t.labels),this.fixed=!!t.fixed,t.size&&t.size!==this.size&&this.setSize(t.size),t.order!==this.order&&this.setOrder(t.order),t.cables){for(let l of this.getCables("out"))l.from.removeCable(l);for(let l of t.cables)re.unSerialize(this.id,l,this.$parent)}this.serialize()}makeInPort(t,e){this.inPorts||(this.inPorts=new Map),this.inPorts.has(t)||this.inPorts.set(t,new Sl(this,t));let s=this.inPorts.get(t);return s.setOptions(e,!1),s}makeOutPort(t,e){this.outPorts||(this.outPorts=new Map),this.outPorts.has(t)||this.outPorts.set(t,new Pl(this,t));let s=this.outPorts.get(t);return s.setOptions(e,!1),s}deleteInPort(t){var e;typeof t=="string"&&(t=(e=this.inPorts)==null?void 0:e.get(t)),!(!t||!this.inPorts)&&(this.inPorts.delete(t.name),t.delete())}deleteOutPort(t){var e;typeof t=="string"&&(t=(e=this.outPorts)==null?void 0:e.get(t)),!(!t||!this.outPorts)&&(this.outPorts.delete(t.name),t.delete())}emitMessage(t,e){var s;typeof t=="string"&&(t=(s=this.outPorts)==null?void 0:s.get(t)),t==null||t.sendMessage(e)}*getCables(t){let e=t==="in"?this.inPorts:this.outPorts;if(!!e)for(let s of e.values())for(let n of s.cables)n.to&&(yield n)}*getCableData(t){for(let e of this.getCables(t))yield e.serialize()}contains(t){let e=this.transformed;return!e||!te(e)&&!ct(e)&&!Ne(e)?!1:e.contains(t)}getClosestPort(t,e,s=10){if(!this.inPorts)return;let n=this.relativePosn(t);for(let a of this.inPorts.values())if(a.location&&wt(a.location)&&d.distance(a.location,n)<=s&&(!e||a.validateConnection(e)))return a;if(!this.contains(t))return;let o=Array.from(this.inPorts.values()).filter(a=>!e||a.validateConnection(e));for(let a of o.filter(l=>l.type==="REGION"))if((a.location||this.path).contains(n))return a;let r=o.filter(a=>a.type==="POINT");return Qe(r,a=>d.distance(n,a.location))}serialize(){return this.lastSavedData={id:this.id,name:this.type,options:this.options,x:this.posn.x,y:this.posn.y,rot:this.rot,size:this.size||void 0,flipped:this.flipped||void 0,locked:this.locked||void 0,fixed:this.fixed||void 0,labels:this.labels,hidden:this.hidden||void 0,hideHandles:this.hideHandles||void 0,order:this.order,colour:this.colour,cables:Array.from(this.getCableData("out"))}}static unSerialize(t,e,s=!1){if(!(t==null?void 0:t.name))return;let n=e.newTile(t.name,t.options||"",s?void 0:t.id);return t.flipped&&n.flip(),n.setTransform(new d(t.x,t.y),t.rot),t.colour&&n.setColour(t.colour),t.size&&n.setSize(t.size),n.setOrder(t.order||void 0),t.hidden&&n.hide(!0),t.hideHandles&&n.setHandles(!0),t.labels&&n.setLabels(t.labels),t.fixed&&(n.fixed=!0),t.locked&&n.lock(),n.lastSavedData=t,n}};var J=class{constructor(t=0,e=0,s=0){this.x=t;this.y=e;this.z=s}transform(t){if(t instanceof qo&&(t=t.matrix),t.length!==4||t[0].length!==4)throw new Error("Must use a 4x4 matrix for 3D transforms!");let[[e],[s],[n],[o]]=Et.product(t,[[this.x],[this.y],[this.z],[1]]);return new J(e/o,s/o,n/o)}equals(t){return P(this.x,t.x)&&P(this.y,t.y)&&P(this.z,t.z)}fixFloat(){return new J(P(this.x,0)?0:this.x,P(this.y,0)?0:this.y,P(this.z,0)?0:this.z)}add(t){return this.x+=t.x||0,this.y+=t.y||0,this.z+=t.z||0,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}lerp(t,e){return new J(bt(this.x,t.x||0,e),bt(this.y,t.y||0,e),bt(this.z,t.z||0,e))}scale(t){return new J(this.x*t,this.y*t,this.z*t)}get magnitude(){return Math.hypot(this.x,this.y,this.z)}get normalize(){return this.scale(1/this.magnitude)}get asArray(){return[this.x,this.y,this.z]}get inverse(){return new J(-this.x,-this.y,-this.z)}get xy(){return new d(this.x,this.y)}[Symbol.iterator](){return this.asArray.values()}static get zero(){return new J(0,0,0)}static get oneZ(){return new J(0,0,1)}static get one(){return new J(1,1,1)}static all(t){return new J(t,t,t)}static from2D(t){return new J(t.x,t.y,0)}static average(t){return new J(ps(t.map(e=>e.x)),ps(t.map(e=>e.y)),ps(t.map(e=>e.z)))}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e){let s=t.y*e.z-t.z*e.y,n=t.z*e.x-t.x*e.z,o=t.x*e.y-t.y*e.x;return new J(s,n,o)}};var pt={translate({x:i,y:t,z:e}){return[[1,0,0,i],[0,1,0,t],[0,0,1,e],[0,0,0,1]]},rotateX(i){let t=Math.cos(i),e=Math.sin(i);return[[1,0,0,0],[0,t,-e,0],[0,e,t,0],[0,0,0,1]]},rotateY(i){let t=Math.cos(i),e=Math.sin(i);return[[t,0,e,0],[0,1,0,0],[-e,0,t,0],[0,0,0,1]]},rotateZ(i){let t=Math.cos(i),e=Math.sin(i);return[[t,-e,0,0],[e,t,0,0],[0,0,1,0],[0,0,0,1]]},rotateAxis({x:i,y:t,z:e},s){let n=Math.hypot(i,t,e);n=1/n,i*=n,t*=n,e*=n;let o=Math.sin(s),r=Math.cos(s),a=1-r;return[[i*i*a+r,i*t*a-e*o,i*e*a+t*o,0],[t*i*a+e*o,t*t*a+r,t*e*a-i*o,0],[e*i*a-t*o,e*t*a+i*o,e*e*a+r,0],[0,0,0,1]]},fromEulerAngles(i,t,e){return Et.product(pt.rotateX(i),pt.rotateY(t),pt.rotateZ(e))},scale({x:i,y:t,z:e}){return[[i,0,0,0],[0,t,0,0],[0,0,e,0],[0,0,0,1]]},scaleAll(i){return[[i,0,0,0],[0,i,0,0],[0,0,i,0],[0,0,0,1]]},perspective(i,t,e,s){let n=e*Math.tan(Z(i)/2),o=-n,r=n*t,a=-r;return[[2*e/(r-a),0,(r+a)/(r-a),0],[0,2*e/(n-o),(n+o)/(n-o),0],[0,0,-((s+e)/(s-e)),-(2*s*e/(s-e))],[0,0,-1,0]]},transformPoint(i,t){return t instanceof J?t.transform(i):new J(t.x,t.y).transform(i)}},qo=class{constructor(){this.matrix=Et.identity(4)}clear(){return this.matrix=Et.identity(4),this}translate(t=0,e=0,s=0){return this.matrix=Et.product(this.matrix,pt.translate({x:t,y:e,z:s})),this}rotate(t=0,e=0,s=0){return this.matrix=Et.product(this.matrix,pt.rotateZ(s),pt.rotateY(e),pt.rotateX(t)),this}scale(t){return this.matrix=Et.product(this.matrix,pt.scale(t)),this}dragToRotate(t,e,s=100){let n=new J(t.x,t.y,s**3/(s**2+t.length**2)).normalize,o=new J(e.x,e.y,s**3/(s**2+e.length**2)).normalize,r=S(J.dot(n,o),-1,1),a=J.cross(n,o),l=pt.rotateAxis(a,2*Math.acos(r));return this.matrix=Et.product(l,this.matrix),this}isRotationMatrix(){if(!P(Et.determinant(this.matrix),1))return!1;let t=Et.transpose(this.matrix);return Et.product(this.matrix,t).every((s,n)=>s.every((o,r)=>P(o,n===r?1:0)))}toEulerAngles(){let t=this.matrix,e=Math.sqrt(t[0][0]*t[0][0]+t[1][0]*t[1][0]);if(P(e,0)){let a=Math.atan2(-t[1][2],t[1][1]),l=Math.atan2(-t[2][0],e);return[a,l,0]}let n=Math.atan2(t[2][1],t[2][2]),o=Math.atan2(-t[2][0],e),r=Math.atan2(t[1][0],t[0][0]);return[n,o,r]}};var Uv=new F(0,0,0);function Zv(i){let t=i.r,e=i.c.x,s=i.c.y,n=.5523*t;return`M${e} ${s-t}C${e+n} ${s-t} ${e+t} ${s-n} ${e+t} ${s}C${e+t} ${s+n} ${e+n} ${s+t} ${e} ${s+t}C${e-n} ${s+t} ${e-t} ${s+n} ${e-t} ${s}C${e-t} ${s-n} ${e-n} ${s-t} ${e} ${s-t}`}var El=class{constructor(){this.transform=new qo;this.visible=!0}getTransformed(t){let e=this;do t=t.transform(e.transform);while(e=e.parent);return t}get normal(){return this.getTransformed(J.oneZ).add(this.getTransformed(J.zero).inverse).normalize}project(t,e={fov:120}){if(e.fov===!1)return new d(t.x,t.y);let s=Math.exp(t.z/e.fov);return new d(t.x*s,t.y*s)}*getProjectedVertices(t){for(let e of this.getVertices())yield this.project(e,t)}},ve=class extends El{constructor(t,e={},s){super();this.children=[];this.sorting=!1;this.$el=h("g",e,s);for(let n of t)this.addChild(n)}addChild(t){return t.parent&&t.parent.removeChild(t),this.children.push(t),this.$el&&t.$el&&this.$el.append(t.$el),t.parent=this,t}removeChild(t){let e=this.children.indexOf(t);e>=0&&this.children.splice(e,1),t.$el&&t.$el.remove(),t.parent=void 0}render(t){if(!!this.visible){if(this.sorting)for(let e of Vi(this.children,s=>s.zIndex))this.$el.append(e.$el);for(let e of this.children)e.render(t)}}*getFaces(){for(let t of this.children)for(let e of t.getFaces())yield e}*getVertices(){for(let t of this.children)for(let e of t.getVertices())yield e}get zIndex(){return ps(this.children.map(t=>t.zIndex))}},pe=class extends El{constructor(t,e={},s){super();this.shape=t;if(t==null)this.commands=[];else if(typeof t=="string")this.commands=ho(t);else{let o=ct(t)?Zv(t):Bt(t);this.commands=ho(o)}let n=d.average(...this.commands.filter(o=>o.points.length).map(o=>d.average(...o.points)));this.centroid=new J(n.x,n.y,0),s&&(this.color=s),this.$el=h("path",e)}render(t){if(!this.visible)return;if(t==null?void 0:t.hideBackface){let s=this.getTransformed(J.zero).z>0;if(this.$el.toggle(s),!s)return}if(this.color){let s=F.mix(this.color,Uv,(Math.abs(this.normal.z)+1)/2);this.$el.setAttr("fill",s),this.$el.setAttr("stroke",s)}let e=this.commands.map(s=>{let n=s.points.map(o=>{let r=this.project(this.getTransformed(new J(o.x,o.y)),t);return`${r.x},${r.y}`});return s.type+n.join(",")}).join("");this.$el.setAttr("d",e)}get zIndex(){return this.getTransformed(this.centroid).z}*getFaces(){yield this}*getVertices(){if(!(typeof this.shape=="string"||!te(this.shape)))for(let t of this.commands)for(let e of t.points)yield this.getTransformed(new J(e.x,e.y))}};var at=M.regular(3),Ns=M.regular(4),we=M.regular(5),Bo={shape:at,children:[{shape:at,dihedral:70.53,rot:180},{shape:at,dihedral:70.53,parentEdge:1,rot:300},{shape:at,dihedral:70.53,parentEdge:2,rot:60}]},zo={shape:Ns,children:[{shape:Ns,dihedral:90,myEdge:2,children:[{shape:Ns,dihedral:90,myEdge:2}]},{shape:Ns,dihedral:90,parentEdge:1,rot:270},{shape:Ns,dihedral:90,parentEdge:2},{shape:Ns,dihedral:90,parentEdge:3,rot:90}]},Fo={shape:at,children:[{shape:at,dihedral:109.47,rot:180},{shape:at,dihedral:109.47,parentEdge:1,rot:300,children:[{shape:at,dihedral:109.47,parentEdge:1,rot:300}]},{shape:at,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:at,dihedral:109.47,parentEdge:1,rot:300},{shape:at,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:at,dihedral:109.47,parentEdge:1,rot:300}]}]}]},jo={shape:we,children:[{shape:we,dihedral:116.57,rot:180},{shape:we,dihedral:116.57,parentEdge:1,rot:252},{shape:we,dihedral:116.57,parentEdge:2,rot:324},{shape:we,dihedral:116.57,parentEdge:3,rot:36},{shape:we,dihedral:116.57,parentEdge:4,rot:108,children:[{shape:we,dihedral:116.57,parentEdge:2,rot:324,children:[{shape:we,dihedral:116.57,parentEdge:3,rot:36,children:[{shape:we,dihedral:116.57,parentEdge:1,rot:252},{shape:we,dihedral:116.57,parentEdge:2,rot:324},{shape:we,dihedral:116.57,parentEdge:3,rot:36},{shape:we,dihedral:116.57,parentEdge:4,rot:108}]}]}]}]},Uo={shape:at,children:[{shape:at,dihedral:138.19,rot:180},{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60}]},{shape:at,dihedral:138.19,parentEdge:1,rot:300}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:at,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:at,dihedral:138.19,parentEdge:1,rot:300}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60}]},{shape:at,dihedral:138.19,parentEdge:1,rot:300}]},{shape:at,dihedral:138.19,parentEdge:2,rot:60}]},{shape:at,dihedral:138.19,parentEdge:1,rot:300}]}]},Nu=new M(new d(.587785,.466639),new d(0,.750495),new d(-.587785,.466639),new d(0,-.73981)),li={shape:Nu,dihedral:89.7451,rot:180},Gu={shape:Nu,children:[j(j({},li),{parentEdge:1,myEdge:1,children:[j(j({},li),{children:[j(j({},li),{parentEdge:1,myEdge:1,children:[j(j({},li),{children:[j(j({},li),{parentEdge:1,myEdge:1,children:[j(j({},li),{children:[j(j({},li),{parentEdge:1,myEdge:1,children:[j(j({},li),{children:[j(j({},li),{parentEdge:1,myEdge:1})]})]})]})]})]})]})]})]})]};function Du(i,t,e){let s=M.regular(i).scale(t*jt(i)),n=new x($,t,e).polygon,o=[{shape:s,rot:180,parentEdge:2}],r=B(a=>({shape:n,parentEdge:a,rot:360/i*a,children:a?void 0:o}),i);return{shape:s,children:r}}function _u(i,t,e){let s=M.regular(i).scale(t*jt(i)),n=new M(new d(-t/2,0),new d(t/2,0),new d(0,-e)),o=_t(Math.acos(t/e/2/Math.tan(Math.PI/i))),r=B(a=>({shape:n,dihedral:o,parentEdge:a,rot:180+360/i*a}),i);return{shape:s,children:r}}var Wv=Et.identity(4);function Hu(i,t,e,s){var g;let n=t.shape.edges[i.parentEdge||0],o=i.shape.edges[i.myEdge||0],r=Z(i.dihedral||90),a=s(i);e.addChild(a);let l=J.from2D(n.midpoint),c=J.from2D(o.midpoint),p=J.from2D(n.unitVector),u=i.rot?Z(i.rot):0,f=((g=i.children)==null?void 0:g.map(w=>Hu(w,i,e,s)))||[];return[a,l,c,p,u,r,f]}function gn(i,t,e=1){var r;let s=t(i),n=new ve([s]);n.sorting=!0;let o=((r=i.children)==null?void 0:r.map(a=>Hu(a,i,n,t)))||[];return Al(o,n,e),{group:new ve([n]),foldTree:o}}function qu(i,t,e=Wv){let[s,n,o,r,a,l,c]=i,p=bt(Math.PI,l,t),u=pt.rotateAxis(r,Math.PI-p);a&&(u=Et.product(u,pt.rotateZ(a)));let f=o.transform(u),g=pt.translate(f.inverse.add(n));s.transform.matrix=Et.product(e,g,u);for(let w of c||[])qu(w,t,s.transform.matrix)}function Al(i,t,e){t.transform.clear();for(let o of i)qu(o,e);let s=Array.from(t.getFaces()).map(o=>o.getTransformed(o.centroid)),n=J.average(s).inverse;t.transform.translate(n.x,n.y,n.z)}function Kv(i,t,e){let s=Math.cos(i),n=Math.cos(t),o=Math.cos(e),r=Math.sin(t),a=Math.acos((o-s*n)/(Math.sin(i)*r)),l=Math.acos((s-n*o)/(r*Math.sin(e)));return[a,l]}function Bu(i,t){return Math.asin(Math.cos(i*t)/Math.cos(i/2))}var Xv=[60,90,108],Yv=[{internal:[60,90,90,90],dihedral:[144.74,135,135,135]},{internal:[60,60,60,60,90],dihedral:[153.23,153.23,153.23,142.98,142.98]},{internal:[60,90,108,90],dihedral:[159.09,148.28,148.28,159.09]},{internal:[60,60,60,60,108],dihedral:[164.18,164.18,152.93,152.93,152.93]}];function Qv(...i){let t=i.length;if(t===3)return Kv(i[0],i[1],i[2]);let e=i.map(n=>Math.round(_t(n)));if((t===4||t===5)&&e.includes(60)&&e.every(n=>Xv.includes(n))){for(let n of Yv)if(n.internal.length===t){for(let o=0;o<i.length;++o)if(e.every((r,a)=>r===n.internal[(a+o)%t]))return Ys(n.dihedral,o).slice(0,t-1).map(r=>Z(r))}}if(t===4&&e.filter(n=>n===60).length===3){let n=e.findIndex(c=>c!==60),o=(Math.PI-i[n])/4,r=Math.acos(-1/Math.sqrt(3)*Math.tan(o)),a=Math.acos(1-2/3*((3-Math.tan(o)**2)/4+(Math.sin(3*o)/Math.sin(2*o))**2));return Ys([r,a,a,r],4-n).slice(0,t-1)}let s=Math.PI/q(i);return B(n=>{let o=Bu(i[n],s),r=Bu(i[n+1],s);return o+r},i.length-1)}var kl=(i,t)=>Rt(i+1,t.size),Vl=(i,t)=>Rt(i-1,t.size);function Jv(i,t){let e=i.polygon.points[Vl(t,i)],s=i.polygon.points[t],n=i.polygon.points[kl(t,i)];return new Ot(n,s,e).sup.rad}function t2(i){let t=i.find(a=>a.neighbours.filter(l=>l).length===1),e=Vl(t.neighbours.findIndex(a=>a),t),s=[],n=t,o=e;do{let a=[];for(;a.push({face:n,vertex:o}),!!n.neighbours[o];){let l=n;n=n.neighbours[o],o=kl(n.neighbours.indexOf(l),n)}o=kl(o,n),s.push(a)}while(n!==t||o!==e);let r=new Gc(s);for(;;){let a=Math.max(3,...r.array.map(p=>p.val.length)),l=r.array.filter(p=>p.val.length>=a);if(!l.length)break;let c=new Set;for(let p of l){if(c.has(p))continue;let u=p.val.map(g=>Jv(g.face,g.vertex)),f=Qv(...u);for(let[g,w]of f.entries()){let v=p.val[g],y=p.val[g+1],C=v.vertex,k=Vl(y.vertex,y.face);v.face.dihedral[C]=y.face.dihedral[k]=Math.max(w,v.face.dihedral[C]||0,y.face.dihedral[k]||0)}p.prev.val.push(...p.next.val),c.add(p.next),r.delete(p.next),r.delete(p)}}}function zu(i,t){return Math.max(...i.neighbours.map(e=>!e||e===t?0:zu(e,i)))+1}function Fu(i,t){return i.visited?!0:(i.visited=!0,i.neighbours.filter(e=>e&&e!==t).some(e=>Fu(e,i)))}function ju(i,t,e,s){let n=i.neighbours.map((o,r)=>{if(!(!o||o===e))return ju(o,t,i,i.dihedral[r])}).filter(o=>o);return{shape:gt(i.polygon.points.map(o=>o.subtract(t))),color:i.tile.colour,children:n.length?n:void 0,dihedral:s?+_t(s).toFixed(2):void 0,parentEdge:e?e.neighbours.indexOf(i):void 0,myEdge:e?i.neighbours.indexOf(e):void 0}}function e2(i){let t=i.map(e=>{let s=e.transformed.oriented,n=s.points.length;return{tile:e,polygon:s,size:n,neighbours:Ht(void 0,n),dihedral:Ht(void 0,n),edges:s.edges,center:s.centroid,radius:s.radius}});if(!t.some(e=>e.size<3)){for(let[e,s]of t.entries())for(let[n,o]of t.entries())if(!(e>=n)&&!(s.radius+o.radius<d.distance(s.center,o.center)-2)){for(let[r,a]of s.edges.entries())for(let[l,c]of o.edges.entries())if(a.equals(c,2)){if(s.neighbours[r]||o.neighbours[l])return;s.joined=o.joined=!0,s.neighbours[r]=o,o.neighbours[l]=s}}if(!t.some(e=>!e.joined)&&!Fu(t[0]))return t}}function Uu(i){let t=e2(i);if(!t)return;t2(t);let e=Qe(t,n=>zu(n)),s=e.polygon.centroid;return[s,ju(e,s)]}function Zu(i){var e;let t=((e=i.c||i.children)==null?void 0:e.map(s=>Zu(s)))||[];return{shape:es(i.shape||i.s),color:i.color||i.a,children:t,dihedral:i.dihedral||i.d,parentEdge:i.parentEdge||i.p,myEdge:i.myEdge||i.m,rot:i.rot||i.r}}function Wu(i){var e;let t=(e=i.children)==null?void 0:e.map(s=>Wu(s));return(t==null?void 0:t.length)||(t=void 0),{s:gt(i.shape.points),a:i.color,children:t,d:i.dihedral,p:i.parentEdge,m:i.myEdge,r:i.rot}}function i2(i){try{let{net:t,angle:e,rotation:s}=JSON.parse(i.replace(/([a-z]):/g,'"$1":')),n;return typeof t=="string"?(n=`"${t}"`,t=wn[t].net||wn.Cube.net):(t=Zu(t),n=JSON.stringify(Wu(t)).replace(/"([a-z])":/g,"$1:")),{net:t,serialized:n,angle:e,rotation:s}}catch(t){return{net:wn.Cube.net,serialized:'"Cube"',angle:1}}}function Gs(i,t=1){var s;let e=(s=i.children)==null?void 0:s.map(n=>Gs(n,t));return Object.assign({},i,{children:e,shape:i.shape.scale(t)})}var wn={Tetrahedron:{net:Gs(Bo,jt(3)*50),scale:1.1},Cube:{net:Gs(zo,jt(4)*50),scale:.8},Octahedron:{net:Gs(Fo,jt(3)*50),scale:.95},Dodecahedron:{net:Gs(jo,jt(5)*50),scale:.42},Icosahedron:{net:Gs(Uo,jt(3)*50),scale:.67},Pyramid:{net:_u(6,50,100),scale:.57},Prism:{net:Du(6,50,100),scale:.45}},is={fov:400},Ku=[1.066,.243,-.088],ss=class extends T{constructor(t,e,s){super(e,s);this.type="polyhedron";this.canRotate=!1;this.options=t,t in wn&&(t=`{"net":"${t}","angle":1,"rotation":${JSON.stringify(Ku)}}`);let n=i2(t);this.net=n.net,this.serialized=n.serialized;let o=gn(this.net,r=>new pe(r.shape,{class:"polygon-tile"},r.color||vn(r.shape.points.length)));this.solid=o.group,this.foldTree=o.foldTree,this.$el.append(this.solid.$el),this.$outline=h("path",{class:"outline"},this.$el),this.$moveBar=h("path",{d:"M0 0h30",class:"handle"},this.$el),this.$moveHandle=h("path",{d:"M0 0h14v14h-14Z",class:"handle",style:"cursor: grab"},this.$el),this.solid.$el.css("cursor","move"),this.setRotation(n.rotation||[0,0,0]),this.hinge(n.angle||0),this.solid.render(is),this.updateOutline(),e.events.listen(this.solid.$el,{start:()=>{e.selection.add(this,!0),this.$el.removeClass("active")},move:({posn:r,lastPosn:a})=>{this.solid.transform.dragToRotate(a.subtract(this.posn),r.subtract(this.posn),100),this.solid.render(is)},end:()=>{this.rotation=this.solid.transform.toEulerAngles(),this.updateOutline(),this.updateOptions(),e.change({changed:[this]}),this.$el.addClass("active")},click:r=>e.tools.move.down(r),checkIfActive:()=>this.angle>0})}updateOutline(){let t=this.solid.getProjectedVertices(is);this.path=M.convexHull(...t),this.$outline.draw(this.path),this.transform(),this.$moveBar.translate(this.path.points[0].x-30,this.path.points[0].y),this.$moveHandle.translate(this.path.points[0].x-45,this.path.points[0].y-7)}setRotation(t){this.rotation=t,this.solid.transform.clear().rotate(...t)}updateOptions(){let t=JSON.stringify(this.rotation.map(e=>+e.toFixed(4)));this.options=`{"net":${this.serialized},"angle":${this.angle},"rotation":${t}}`}animateHinges(t,e=!1,s=800){let n=e?this.rotation:[0,0,0],o=this.angle;return X(r=>{this.hinge(bt(o,t,r)),e&&this.setRotation(n.map(a=>a*(1-r))),this.solid.render(is)},s)}hinge(t){this.angle=S(t,0,1);let e=this.solid.transform.matrix;this.solid.transform.clear(),Al(this.foldTree,this.solid.children[0],-this.angle),this.solid.transform.matrix=e}hingeStart(){this.startRotation=this.rotation,this.startAngle=this.angle,this.$el.removeClass("active")}hingeMove(t){if(!P(t,this.angle)){if(this.hinge(t),this.startRotation&&this.startAngle){let e=S(t/this.startAngle,0,1);this.setRotation(this.startRotation.map(s=>e*s))}this.solid.render(is)}}hingeEnd(){this.updateOutline(),this.$el.addClass("active"),this.updateOptions()}setColour(t){super.setColour(t);for(let e of this.solid.getFaces())e.color=t;this.solid.render(is)}static fold(t){let e=Uu(t);if(!e){No("polyhedron-error");return}let s=JSON.stringify({net:e[1],angle:1}),n=new ss(s,t[0].$parent);n.hinge(0);let o=n.solid.children[0].transform.matrix;n.setTransform(e[0].shift(-o[0][3],-o[1][3])),n.animateHinges(1).promise.then(()=>n.updateOutline());for(let a of t)a.delete();return n}unfold(){return R(this,null,function*(){this.$parent.selection.remove(this),this.angle>0&&(yield this.animateHinges(0,!0).promise);let t=Array.from(this.solid.getFaces()).map(e=>{let s=Array.from(e.getProjectedVertices()),n=new K(gt(s),this.$parent);return n.setColour(this.colour||e.color||vn(s.length)),n.setTransform(this.posn),n});return this.delete(),t})}static makeThumbnail(t,e){let s=h("svg",{width:70,height:70},e),n=h("g",{transform:"translate(35, 35)"},s),{net:o,scale:r}=wn[t],a=gn(o,l=>new pe(l.shape,{class:"polygon-tile"},vn(l.shape.points.length)),-1).group;a.transform.clear().rotate(...Ku).scale({x:r,y:r,z:r}),n.append(a.$el),a.render(is)}};I([{type:"button",tileTypes:["polyhedron"],label:"Unfold",click:(i,t)=>R(void 0,null,function*(){let e=qt(yield Promise.all(i.map(s=>s.unfold())));t.change({added:e,deleted:i})})},{type:"slider",tileTypes:["polyhedron"],label:"Hinges",start:i=>i.hingeStart(),move:(i,t)=>i.hingeMove(t),end:i=>i.hingeEnd(),get:i=>i.angle}]);function jt(i){let t=Math.cos(D/i);return 1/Math.sqrt(2-2*t)}var yn=i=>Rt(Math.round(_t(i.angle)),180),gt=i=>i.map(t=>`${Kt(t.x,2)} ${Kt(t.y,2)}`).join(",");function Zo(i,t){let e=new d(-i/2,-t/2);return gt(new x(e,i,t).points)}var z=50,yt=Math.sqrt(3)/4*z,Ol=new $t($,new d(0,1)),Xu={"equ-triangle":new M(new d(-z/2,yt),new d(z/2,yt),new d(0,-yt)),square:M.regular(4,z*jt(4)),"reg-pentagon":M.regular(5,z*jt(5)),"reg-hexagon":M.regular(6,z*jt(6)),"reg-heptagon":M.regular(7,z*jt(7)),"reg-octagon":M.regular(8,z*jt(8)),"reg-decagon":M.regular(10,z*jt(10)),"reg-dodecagon":M.regular(12,z*jt(12)),rectangle:new x(new d(-z,-z/2),2*z,z).polygon,trapezium:new M(new d(-z,yt),new d(z,yt),new d(z/2,-yt),new d(-z/2,-yt)),rhombus:new M(new d(-z*3/4,yt),new d(z/4,yt),new d(z*3/4,-yt),new d(-z/4,-yt)),"right-triangle":new M(new d(-z/2,-z/2),new d(z/2,-z/2),new d(-z/2,z/2)),"rhombus-2":new M(new d(z/2-yt,z/4),new d(-yt-z/2,z/4),new d(yt-z/2,-z/4),new d(yt+z/2,-z/4)),chevron:new M(new d(-.75*z,2*yt),new d(.25*z,2*yt),new d(.75*z,0),new d(.25*z,-2*yt),new d(-.75*z,-2*yt),new d(-.25*z,0)),"right-triangle-2":new M(new d(-2*yt,-z/2),new d(-2*yt,z/2),new d(2*yt,-z/2)),kite:new M(new d(0,-z),new d(2*yt,-z/2),new d(0,z),new d(-2*yt,-z/2)),dart:new M(new d(2*yt,.75*z),new d(0,-.75*z),new d(-2*yt,.75*z),new d(0,.25*z))},Ll=["","","",m.yellow,m.blue,m.green,m.red,m.teal,m.purple],Yu={trapezium:m.orange,"right-triangle":m.green,"rhombus-2":m.lime,chevron:m.orange,kite:m.purple,dart:m.teal},Qu={"equ-triangle":m.green,square:m.yellow,"reg-pentagon":m.blue,"reg-hexagon":"#ffd615",rectangle:m.yellow,trapezium:"#cc1030",rhombus:m.blue,"rhombus-2":"#e6e2c6",chevron:"#cc1030","right-triangle-2":"#ffd615",kite:"#134791",dart:m.purple};function vn(i){return Ll[i%Ll.length]||m.yellow}function es(i){if(i in Xu)return Xu[i];if(i.match(/^[0-9.,\-\s]+$/)){let t=i.split(",").map(e=>new d(...e.split(" ").map(s=>+s)));return new M(...t)}throw new Error("Unknown polygon type.")}var s2=["trapezium","rhombus","rhombus-2","rectangle","right-triangle","right-triangle-2"],n2=["equ-triangle","square","reg-pentagon","reg-hexagon","reg-heptagon","reg-octagon","reg-decagon","reg-dodecagon","rectangle","trapezium","kite","dart"],K=class extends T{constructor(t,e,s){super(e,s);this.type="polygon";this.options=t,this.path=es(t),this.snapAngles=Dt(this.path.edges.map(yn)),this.symmetric=n2.includes(t);let n=e.options.altColors?Qu:Yu;this.colour=n[t]||vn(this.path.points.length);let o=x.aroundPoints(this.path.points),r=new d(o.center.x,o.p.y);this.showSelectionOutline=d.distance(r,this.path.project(r))>5;let a={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=h("path",a,this.$el),this.$outline=h("path",{class:"outline",path:this.path},this.$el)}setSize(t){t=S(Kt(t,1),.1,10),super.setSize(t);let e=es(this.options),s=e.centroid;this.path=e.translate(s.inverse).scale(t).translate(s),this.$path.draw(this.path),this.$outline.draw(this.path),this.transform()}static makeThumbnail(t,e,s){let n=s2.includes(t)?30:40,o=es(t),r=Math.max(...o.points.map(c=>c.length));o=o.scale(36/r).shift(40,n);let a=h("svg",{width:80,height:2*n},e),l=h("path",{class:"polygon-tile",path:o},a);s.options.watch(c=>{let p=c.altColors?Qu:Yu,u=e.data.color||p[t]||Ll[o.points.length];l.setAttr("fill",u)})}setColour(t){super.setColour(t),this.$path.setAttr("fill",E(this.colour))}flip(t){t&&(this.posn=new d(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.flipped=!this.flipped,this.symmetric||(this.path=this.path.reflect(Ol),this.$path.draw(this.path),this.$outline.draw(this.path)),this.transform()}},Wo=["polygon","tangram","pentomino","custom-polygon","pentagon","rectangle","reg-polygon"];I([{type:"button",label:"Flip",tileTypes:[...Wo,"egg","fractal","garden"],show:i=>i.length>1||!!i[0].rot||!i[0].symmetric,click:(i,t)=>{let e=t.selection.center;for(let s of i)s.flip(e);t.change({changed:i})}},{type:"button",tileTypes:Wo,label:"Cut",click:(i,t)=>t.tools.cutPolygon.enable()},{type:"button",label:"Join",tileTypes:Wo,show:i=>i.length>1,click:(i,t)=>{let e=i.map(r=>r.transformed),s=M.union(...e),n=i[0].colour,o=s.map(r=>new K(gt(r.points),i[0].$parent));for(let r of o)r.transform(),r.setColour(n);for(let r of i)r.delete();t.selection.select(o,!0),t.change({added:o,deleted:i})}},{type:"button",label:"Fold Net",tileTypes:Wo,show:i=>i.length>2,click:(i,t)=>{let e=ss.fold(i);e&&t.change({added:[e],deleted:i})}}]);var o2=[[0,-.2],[1.2,-1],[.6,1],[-.6,1],[-1.2,-.2]],Ju=o2.map(i=>new d(i[0]*50,i[1]*50)),Rl=class extends K{constructor(t,e,s){super(t||gt(Ju),e,s);this.type="custom-polygon";this.$handles=[];this.showSelectionOutline=!0;for(let[o,r]of this.path.points.entries())this.makeVertex(r,o);this.updatePath();let n;this.$parent.events.listen(this.$outline,{down:({posn:o})=>{o=this.relativePosn(o);let r=this.path.edges.findIndex(a=>o.distanceFromLine(a)<5);n=this.makeVertex(o,(r+1)%this.$handles.length),this.updatePath()},move:({posn:o})=>{n&&this.moveVertex(n,o)},end:()=>{n&&this.$parent.change({changed:[this]})}}),this.$outline.css("cursor","crosshair")}makeVertex(t,e){if(this.$handles.length>=24)return;let s=this.makeHandle("c",(n,o)=>this.moveVertex(s,o),()=>this.deleteVertex(s));return s.setCenter(t),s.setAttr("r",8),s.css("cursor","move"),this.$handles.splice(e,0,s),s}deleteVertex(t){t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.updatePath()}moveVertex(t,e){var n;let s=(n=this.$parent.snapping.snap([e]))==null?void 0:n.shift;t.setCenter(this.relativePosn(s?e.add(s):e)),this.updatePath()}updatePath(){let t=this.$handles.map(e=>e.center);this.path=new M(...t),this.$path.draw(this.path),this.$outline.draw(this.path),this.transform(),this.snapAngles=Dt(this.path.edges.map(yn)),this.options=gt(t),this.$parent.selection.update()}flip(t){t&&(this.posn=new d(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.transform();for(let e of this.$handles)e.setCenter(e.center.reflect(Ol));this.updatePath()}static makeThumbnail(t,e){let s=new M(...Ju).scale(.5).shift(40),n=h("svg",{width:80,height:80},e);h("path",{class:"polygon-tile",path:s,fill:m.green},n);for(let o of s.points)h("circle",{cx:o.x,cy:o.y,r:3.5,fill:"white"},n)}};I([{type:"button",tileTypes:["custom-polygon"],label:"Fix vertices",click:(i,t)=>{let e=[];for(let s of i){let n=new K(gt(s.path.points),t);n.setColour(s.colour),n.setTransform(s.posn,s.rot),t.selection.add(n),s.delete(),e.push(s)}t.change({added:e,deleted:i})}}]);var Il=25/2,tf=[[[0,2],[0,-4],[-2,-4],[-2,4],[2,4],[2,2],[0,2]],[[0,0],[0,-4],[-2,-4],[-2,2],[0,2],[0,4],[2,4],[2,0],[0,0]],[[-5,-1],[5,-1],[5,1],[-5,1]],[[-3,-2],[-3,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2]],[[3,-2],[3,0],[1,0],[1,-2],[-1,-2],[-1,2],[5,2],[5,-2],[3,-2]],[[-1,-3],[-1,-1],[-3,-1],[-3,3],[-1,3],[-1,1],[1,1],[1,-1],[3,-1],[3,-3],[-1,-3]],[[1,1],[1,-3],[-1,-3],[-1,1],[-3,1],[-3,3],[3,3],[3,1],[1,1]],[[1,-1],[1,-3],[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,1],[3,1],[3,-1],[1,-1]],[[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-4,-2],[-4,0],[-2,0],[-2,2],[0,2],[0,0],[4,0],[4,-2],[-4,-2]],[[-1,-3],[-1,1],[-3,1],[-3,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-1,-3],[-1,1],[-5,1],[-5,3],[1,3],[1,-3],[-1,-3]],[[-1,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2],[-3,0],[-1,0]],[[-3,2],[-3,0],[-1,0],[-1,-2],[3,-2],[3,0],[1,0],[1,2]],[[-3,2],[-3,-2],[3,-2],[3,0],[-1,0],[-1,2]],[[-2,2],[2,2],[2,-2],[-2,-2]],[[-4,1],[4,1],[4,-1],[-4,-1]]].map(i=>i.map(t=>new d(t[0]*Il,t[1]*Il))),r2=[[2,4],[4,4],[5,9],[7,2],[7,6],[11,3],[13,7],[15,3],[17,7],[20,2],[21,5],[23,7],[3,2],[7,2],[5,6],[10,4],[8,7]],ef=[...F.rainbow(12).map(i=>i.hex),m.red,m.blue,m.green,m.yellow,m.purple],Nl=class extends K{constructor(t,e,s){super(gt(tf[+t]),e,s);this.type="pentomino";this.options=t,this.setColour(ef[+t])}static makeThumbnail(t,e){let s=r2[+t],n=new M(...tf[+t]).scale(10/Il);e.draw(n.shift(10*s[0],10*s[1]).shift(1,1)),e.setAttr("fill",ef[+t])}};var sf=[[[-4,-2],[0,2],[4,-2]],[[-4,-2],[0,2],[4,-2]],[[-2,0],[0,-2],[2,0],[0,2]],[[-3,1],[1,1],[3,-1],[-1,-1]],[[0,-1],[2,1],[-2,1]],[[0,-1],[2,1],[-2,1]],[[-2,-2],[2,-2],[2,2]]],nf=[m.red,m.blue,m.green,m.yellow,m.orange,m.teal,m.purple],a2=[[2,4],[4,2],[6,4],[3,7],[7,2],[4,5],[6,6]],of=[-90,0,0,0,-90,0,90],l2=25,Gl=class extends K{constructor(t,e,s){super(gt(sf[+t].map(n=>new d(...n).scale(l2))),e,s);this.type="tangram";this.snapAngles=[0,45,90,135];this.options=t,this.setColour(nf[+t]),this.rot=of[+t],this.transform()}static makeThumbnail(t,e){let s=a2[+t],n=sf[+t].map(r=>new d(...r).rotate(Z(of[+t])).shift(...s).scale(18).shift(2,2)),o=new M(...n);e.draw(o),e.setAttr("fill",nf[+t])}getSnapLines(){return this.path.edges}};var rf=25,bn=(1+Math.sqrt(5))/2*rf,Ko=Math.sqrt((5+Math.sqrt(5))/2)*rf,$n=bn*(Math.sqrt(5)-1)/2,af=[`0 ${-bn},${Ko} ${-$n},0 ${bn},${-Ko} ${-$n}`,`0 ${2*$n-bn},${Ko} ${$n},0 ${-bn},${-Ko} ${$n}`],lf=[["M29.4-30.9C25.3-18.2,13.4-9.5,0-9.5c-13.4,0-25.3-8.6-29.4-21.4","M29.4,0C20.8-6.2,10.6-9.5,0-9.5c-10.6,0-20.8,3.3-29.4,9.5"],["M18.2,15.5C20.1,9.6,19,3.3,15.5-1.7C11.9-6.6,6.1-9.5,0-9.5c-6.1,0-11.9,2.9-15.5,7.9c-3.6,4.9-4.6,11.3-2.7,17.1","M18.2-15.5C12.9-11.6,6.5-9.5,0-9.5c-6.5,0-12.9-2.1-18.2-5.9"]],hf=[m.red,m.blue],Dl=class extends K{constructor(t,e,s){super(af[+t],e,s);this.type="penrose";this.setColour(hf[+t]),this.options=t;let n=h("g",{class:"penrose-circles"});this.$path.insertAfter(n);for(let o of lf[+t])h("path",{d:o},n)}static makeThumbnail(t,e){let s=+t,n=h("svg",{width:80,height:80,viewBox:"-50 -50 100 100"},e);h("polygon",{points:af[s],class:"polygon-tile",fill:hf[s]},n);let o=h("g",{class:"penrose-circles"},n);for(let r of lf[s])h("path",{d:r},o)}};var cf=["M13.9-13.9,2.8-25H-2.8L-25-2.8V2.8L-2.8,25H2.8L13.9,13.9C21.6,6.6,21.6-6.6,13.9-13.9Zm-2.8,25L0,22.2-22.2,0,0-22.2,11.1-11.1A15.8,15.8,0,0,1,11.1,11.1Z","M25-2.8,13.9-13.9c-7.3-7.7-20.5-7.7-27.8,0L-25-2.8V2.8l11.1,11.1c7.3,7.7,20.5,7.7,27.8,0L25,2.8ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1a15.8,15.8,0,0,1,22.2,0L22.2,0Z","M-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0s7.6-20.5,0-27.8L2.8-25H-2.8ZM15.7,0a15.9,15.9,0,0,1-4.6,11.1,15.8,15.8,0,0,1-22.2,0L-22.2,0,0-22.2,11.1-11.1A15.9,15.9,0,0,1,15.7,0Z","M-25-2.8V2.8L-2.8,25H2.8L25,2.8V-2.8L2.8-25H-2.8Zm25,25L-22.2,0,0-22.2,22.2,0Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8c-7.6,7.3-7.6,20.5,0,27.8s20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1c-5.8,6.1-16.3,6.1-22.2,0a15.8,15.8,0,0,1,0-22.2,15.8,15.8,0,0,1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8L-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1c5.9-6.1,16.4-6.1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z"],_l=class extends K{constructor(t,e,s){super("square",e,s);this.type="kolam";this.setColour(m.orange),this.options=t,h("path",{d:cf[+t],fill:"white"},this.$el),h("circle",{r:3,fill:"white"},this.$el),this.$el.append(this.$outline),this.$path.css("stroke-width",".5px")}static makeThumbnail(t,e){let s=h("svg",{width:60,height:60},e);h("rect",{class:"polygon-tile",fill:m.orange,x:5,y:5,width:50,height:50},s),h("path",{d:cf[+t],fill:"white",transform:"translate(30 30)"},s),h("circle",{r:3,cx:30,cy:30,fill:"white"},s)}};var Ds=["M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-42.1,0A288.5,288.5,0,0,0-20.2,110.2a287.6,287.6,0,0,0,62.3,93.3V0Z","M-42.1,0V203.5a289.5,289.5,0,0,0,62.4-93.3A286.5,286.5,0,0,0,42.1,0Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-59.6 59.6L59.6 59.6Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z"],df=[[66,-17.5,-22.5],[82,-17.5,22.5],[23,-36.5,45],[125,-36.5,-45],[56,47.3,135],[92,47.3,-135],[74,101,180],[41,98,45],[107,98,-45]],h2={0:1,1:1,2:3,3:2,7:8,8:7},pf=[m.lime,m.teal,m.blue,m.red,m.yellow,m.green,m.grey,m.orange,m.purple],Hl=class extends K{constructor(t,e,s){super(gt(Ni(Ds[+t])),e,s);this.type="egg";this.snapAngles=[0,45,90,135];this.options=t,this.$path.setAttr("d",Ds[+t]),this.$outline.setAttr("d",Ds[+t]),this.setColour(pf[+t]),this.rot=df[+t][2],this.transform(),+t<=1&&this.snapAngles.push(22.5,67.5,112.5,157.5)}flip(t){super.flip(t);let e=this.flipped?h2[this.options]||this.options:this.options;this.$path.setAttr("d",Ds[+e]),this.$outline.setAttr("d",Ds[+e])}static makeThumbnail(t,e){e.setAttr("d",Ds[+t]);let s=df[+t];e.css("transform",`translate(${s[0]}px, ${s[1]}px) rotate(${s[2]}deg) scale(0.5)`),e.setAttr("fill",pf[+t]),e.css("stroke-width","2px")}};var ql=1/Math.sqrt(3),c2=50/ql,uf=[m.blue,m.purple,m.red,m.orange,m.yellow],_s=M.regular(6,c2).rotate(Math.PI/6).points;_s.splice(3,1);_s.splice(2,0,new d(2*_s[1].x,_s[0].y));var Bl=class extends K{constructor(t,e,s){super(gt(_s.map(n=>n.scale(ql**+t))),e,s);this.type="fractal";this.setColour(uf[+t]),this.options=t}static makeThumbnail(t,e){let s=new M(..._s).scale(.6*ql**+t),n=x.aroundPoints(s.points),o=h("svg",{width:20+n.w,height:20+n.h},e);s=s.shift(10-n.center.x+n.w/2,10-n.center.y+n.h/2),h("path",{class:"polygon-tile",path:s,fill:uf[+t]},o)}};var Xo=["M-25,34.4a81.3,81.3,0,0,1,50,0h0A81.1,81.1,0,0,0,40.4-13.1h.1A81.5,81.5,0,0,1,0-42.5H0A81.5,81.5,0,0,1-40.5-13.2h.1A81.1,81.1,0,0,0-25,34.4Z","M-15.4-21.3A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3a80.6,80.6,0,0,1,50,0A80.3,80.3,0,0,1,25,8.1,80.4,80.4,0,0,1,40.4,55.7,80.2,80.2,0,0,1,0,26.3,80.2,80.2,0,0,1-40.4,55.7,80.4,80.4,0,0,1-25,8.1,80.3,80.3,0,0,1-65.4-21.3,80.6,80.6,0,0,1-15.4-21.3Z","M65.4-21.3A80.5,80.5,0,0,1,0,12.1,80.5,80.5,0,0,1-65.4-21.3a80.6,80.6,0,0,1,50,0A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3,80.6,80.6,0,0,1,65.4-21.3Z","M80.9-47.5h0A81.5,81.5,0,0,1,40.4-76.9,80.4,80.4,0,0,0,0-47.5,80.2,80.2,0,0,0-40.5-76.9h0A80.8,80.8,0,0,1-80.9-47.6h0A80.3,80.3,0,0,1-65.5,0,80.3,80.3,0,0,1-80.9,47.5h0A80.8,80.8,0,0,1-40.5,76.9h0A80.2,80.2,0,0,0,0,47.5,80.4,80.4,0,0,0,40.4,76.9,81.5,81.5,0,0,1,80.9,47.6h0A80.3,80.3,0,0,1,65.5,0,80.3,80.3,0,0,1,80.9-47.5Z","M0-47.5A80.3,80.3,0,0,1,15.5,0,80.3,80.3,0,0,1,0,47.5,80.3,80.3,0,0,1-15.5,0,80.3,80.3,0,0,1,0-47.5Z","M130.9,153.8a80.5,80.5,0,0,1,15.4-47.5,80.2,80.2,0,0,1-40.4-29.4A80.1,80.1,0,0,1,90.5,29.4a80.6,80.6,0,0,1-50,0A80.6,80.6,0,0,1,0,0,80.3,80.3,0,0,1-40.4,29.4a80.9,80.9,0,0,1-50.1,0,80.8,80.8,0,0,1-15.4,47.5,80.9,80.9,0,0,1-40.5,29.4,79.9,79.9,0,0,1,15.5,47.5,81.3,81.3,0,0,1,50,0A80.9,80.9,0,0,1,0,72.9a80.9,80.9,0,0,1,80.9,80.9A81.3,81.3,0,0,1,130.9,153.8Z","M40.4-13.2A80.4,80.4,0,0,0,0-42.5,80.7,80.7,0,0,0-40.4-13.1,80.9,80.9,0,0,0-25,34.4a80.6,80.6,0,0,0,50,0A81.2,81.2,0,0,0,40.4-13.2Z","M40.4-13.1A82,82,0,0,1,0-42.5,81.1,81.1,0,0,1-40.5-13.2,81.3,81.3,0,0,1-25,34.4a81.3,81.3,0,0,1,50,0A81.6,81.6,0,0,1,40.4-13.1Z"],ff=["M16.2-.3a5.5,5.5,0,0,1-4.4,6.4A5.3,5.3,0,0,1,5.5,1.8,5.4,5.4,0,0,1,9.8-4.6,5.5,5.5,0,0,1,16.2-.3Zm8-8A3.8,3.8,0,0,0,28-4.5a3.7,3.7,0,0,0,3.7-3.8A3.6,3.6,0,0,0,28-12,3.7,3.7,0,0,0,24.2-8.3ZM19,23.4a4.9,4.9,0,0,0,4.8-4.8A4.8,4.8,0,0,0,19,13.9a4.7,4.7,0,0,0-4.7,4.7A4.8,4.8,0,0,0,19,23.4ZM-11.7,6.1A5.3,5.3,0,0,0-5.4,1.8,5.4,5.4,0,0,0-9.7-4.6,5.5,5.5,0,0,0-16.1-.3,5.5,5.5,0,0,0-11.7,6.1ZM-27.9-4.5a3.8,3.8,0,0,0,3.8-3.8A3.7,3.7,0,0,0-27.9-12a3.6,3.6,0,0,0-3.7,3.7A3.7,3.7,0,0,0-27.9-4.5ZM20.9-22A139.9,139.9,0,0,1,3-19.5a1.1,1.1,0,0,1-.1.5L1-15.2V30H-1V-15.2L-2.9-19a1.1,1.1,0,0,1-.1-.5,127,127,0,0,1-17.8-2.6A80.8,80.8,0,0,0,0-41.7,83.3,83.3,0,0,0,20.9-22ZM-3.8-26.7A3.2,3.2,0,0,0-7-30a3.3,3.3,0,0,0-3.3,3.3A3.2,3.2,0,0,0-7-23.5,3.2,3.2,0,0,0-3.8-26.7ZM6.5-30a3.2,3.2,0,0,0-3.2,3.3,3.2,3.2,0,0,0,3.2,3.2,3.2,3.2,0,0,0,3.3-3.2A3.3,3.3,0,0,0,6.5-30ZM-23.7,18.6a4.9,4.9,0,0,0,4.8,4.8,4.8,4.8,0,0,0,4.7-4.8,4.7,4.7,0,0,0-4.7-4.7A4.8,4.8,0,0,0-23.7,18.6Z","M-16.9-4.7l-17.7-6.1a.8.8,0,0,1-.5-.9.8.8,0,0,1,.9-.5L-16.5-6a.7.7,0,0,1,.5.9.7.7,0,0,1-.7.4ZM-24.6-13l9.7,5.4h.3a.9.9,0,0,0,.7-.3.9.9,0,0,0-.3-1l-9.7-5.4a.8.8,0,0,0-1,.2A.8.8,0,0,0-24.6-13ZM-7.8-4.9l5.9,1.2h.5c.2-.1.3-.2.3-.4l.3-1.4a.6.6,0,0,0-.5-.8L-7.2-7.7h-.6l-.3.4-.3,1.4A.8.8,0,0,0-7.8-4.9ZM2.8-2.5a.9.9,0,0,0,.7.6h.2l1.6-.3a1,1,0,0,0,.5-.4.7.7,0,0,0,.1-.5l-1.4-6a.8.8,0,0,0-.9-.6L2-9.4l-.5.3a1.3,1.3,0,0,0-.1.6ZM10.9.4a.7.7,0,0,0-.1-.5L10-1.3a.8.8,0,0,0-1-.2L4,1.9c-.2.1-.3.2-.3.4a.7.7,0,0,0,.1.5L4.6,4a.6.6,0,0,0,.6.3h.4l5-3.4ZM-4.5-1l-1.4-.3a.4.4,0,0,0-.5.1c-.2.1-.3.2-.3.4L-8.2,5.1a.7.7,0,0,0,.5.8l1.4.4h.5a.5.5,0,0,0,.3-.5L-4-.1A.7.7,0,0,0-4.5-1Zm-12.1-.6a.7.7,0,0,0,.7-.6c.1-.4-.2-.7-.6-.8l-11-1.7a.8.8,0,0,0-.8.6c0,.4.2.8.6.8l11,1.7Zm16.1,6H-1c-.2,0-.3.1-.5.3l-.8,1.1a.8.8,0,0,0,.1,1l4.9,3.6.4.2h.1l.4-.3.9-1.1c.2-.4.2-.8-.1-1Zm-9.4,8.8a.7.7,0,0,0-1,.1L-22.2,28.2a.7.7,0,0,0,.1,1l.4.2a.9.9,0,0,0,.6-.3l11.3-15A.6.6,0,0,0-9.9,13.2Zm-11.2,5.6c.2.2.3.3.5.3l.5-.2,8.2-7.6a.7.7,0,0,0,0-1,.8.8,0,0,0-1,0L-21,17.8A.7.7,0,0,0-21.1,18.8Zm14-4.9a.8.8,0,0,0-1,.4L-13,24.2a.6.6,0,0,0,.3.9h.3a.6.6,0,0,0,.6-.4l5-9.9A.8.8,0,0,0-7.1,13.9Zm17.4-.7a.8.8,0,0,0-1-.2.8.8,0,0,0-.2,1L19.9,29.4a.5.5,0,0,0,.5.3h.4a.7.7,0,0,0,.2-1ZM7,14.4A.7.7,0,0,0,6,14a.7.7,0,0,0-.3.9L10.3,25a.8.8,0,0,0,.7.4h.3a.8.8,0,0,0,.3-1Zm4-2.8,7.8,7.8.5.2.5-.2a.7.7,0,0,0,0-1L12,10.6a.7.7,0,0,0-1,1ZM34.4-11.2a.7.7,0,0,0-.8-.5l-18,5.5a.7.7,0,0,0-.4.9.6.6,0,0,0,.6.5c.1,0,.2,0,.2-.1l18-5.4A.7.7,0,0,0,34.4-11.2ZM26.7-4l-11,1.3a.6.6,0,0,0-.6.8.7.7,0,0,0,.7.6h.1l11-1.3c.4,0,.6-.4.6-.8S27.1-4,26.7-4ZM14-7.3h.3l9.8-5.1a.7.7,0,0,0,.3-1,.7.7,0,0,0-.9-.3L13.6-8.6a.8.8,0,0,0-.3,1A.8.8,0,0,0,14-7.3ZM-.5-16.6h0a.7.7,0,0,0,.7-.6L.6-36a.7.7,0,0,0-.7-.7.7.7,0,0,0-.7.7l-.4,18.7A.7.7,0,0,0-.5-16.6Zm3.2,1.2h.2a.7.7,0,0,0,.7-.6L5.7-26.9a.7.7,0,0,0-.5-.8.8.8,0,0,0-.9.6L2.2-16.3A.7.7,0,0,0,2.7-15.4Zm-6.1-.1h.1c.4-.1.7-.5.6-.8l-1.8-11c0-.4-.4-.6-.8-.6a.8.8,0,0,0-.6.8l1.8,11A.9.9,0,0,0-3.4-15.5Z","M60.8-16.2l-3.6-2.5,1.4-3.9-.9-.3-1.3,3.5h0l-9.5,3,2.8-7.8h-1l-3,8.3-9.5,3.1,4.4-11.8H39.5L35-12.5,25.5-9.4l5-14.7H29.4L24.3-9.1l-9.1,3,6-16.3-1.2.3L14-5.7l-1.8.5a50.6,50.6,0,0,0,5.3-16.2l-1.9.6-.4.2L1-9.8v-10L14.4-30.3c0-.4-.1-.8-.1-1.2L1-21.1v-10l11.7-9.1-.3-1.1L1-32.4v-10l8.9-6.9a3,3,0,0,0-.4-1L1-43.7v-10l5.2-4a4.1,4.1,0,0,0-.5-.9l-5.2,4h-1l-5.2-4a4.1,4.1,0,0,0-.5.9l5.2,4v10l-8.5-6.6a3,3,0,0,0-.4,1L-1-42.4v10l-11.4-8.9-.3,1.1L-1-31.1v10L-14.3-31.5c0,.4-.1.8-.1,1.2L-1-19.8v10L-15.2-20.6l-.4-.2-1.9-.6A50.6,50.6,0,0,0-12.2-5.2L-14-5.7l-6-16.4-1.2-.3,6,16.3-9.1-3L-29.4-24h-1.1l5,14.7L-35-12.5l-4.5-12.2h-1.1l4.4,11.8L-45.7-16l-3-8.3h-1l2.8,7.8-9.5-3h0l-1.3-3.5-.9.3,1.4,3.9-3.6,2.5.7.7,3.1-2.2v.2l9.4,3-6.8,4.8.7.7,7.3-5.1,9.6,3.1L-47.3-3.8l.9.6,10.8-7.4,9.5,3.1-13,8.9,1,.5,13.2-9,9.6,3-14.4,10,1.2.4,14.3-9.9h.4l3,1C-9.8-1-8.9.5-7.9,1.9L-18.4,9.4l1.3.3,9.8-7a64.2,64.2,0,0,0,6.6,8H.7a64.2,64.2,0,0,0,6.6-8l9.8,7,1.3-.3L7.9,1.9C8.9.5,9.8-1,10.8-2.6l3-1h.4L28.5,6.3l1.2-.4L15.3-4.1l9.6-3,13.2,9,1-.5-13-8.9,9.5-3.1L46.4-3.2l.9-.6L36.8-11l9.6-3.1L53.7-9l.7-.7-6.8-4.8,9.4-3v-.2l3.1,2.2Zm-76-3.2L-1-8.5V.6l-9.7-7.4A45.9,45.9,0,0,1-15.2-19.4ZM0,8.5A66.6,66.6,0,0,1-9.6-4.7L-1,1.8V6.3a1,1,0,0,0,1,1,1,1,0,0,0,1-1V1.8L9.6-4.7A71,71,0,0,1,0,8.5ZM10.7-6.8,1,.6V-8.5L15.2-19.4A45.9,45.9,0,0,1,10.7-6.8Z","M65-1V1.1A81.6,81.6,0,0,1,40,5c-8.9,0-12.7-.4-20.6-2.9A1,1,0,0,1,18.8.8.9.9,0,0,1,20,.2C27.7,2.7,31.2,3,40,3A79.7,79.7,0,0,0,64.7-.9ZM-64.6,1.1A82.4,82.4,0,0,0-39.4,5c8.8,0,12.6-.4,20.5-2.9A1.2,1.2,0,0,0-18.2.8,1,1,0,0,0-19.5.2C-27.2,2.7-30.7,3-39.4,3A79.9,79.9,0,0,1-64.2-.9H-65V1ZM-45.8,36a6.7,6.7,0,0,1,6.7-6.7A6.7,6.7,0,0,1-32.4,36a6.7,6.7,0,0,1-6.7,6.7A6.7,6.7,0,0,1-45.8,36Zm2,0a4.7,4.7,0,0,0,4.7,4.7A4.7,4.7,0,0,0-34.4,36a4.7,4.7,0,0,0-4.7-4.7A4.7,4.7,0,0,0-43.8,36Zm10.4-71.4a5.7,5.7,0,0,0-5.7-5.7,5.6,5.6,0,0,0-5.7,5.7,5.7,5.7,0,0,0,5.7,5.7A5.8,5.8,0,0,0-33.4-35.4ZM4.9-37.1a2.2,2.2,0,0,0,2.2,2.2,2.2,2.2,0,0,0,2.2-2.2,2.2,2.2,0,0,0-2.2-2.2A2.2,2.2,0,0,0,4.9-37.1ZM38.7,42.7h0A6.8,6.8,0,0,1,32,36a6.7,6.7,0,1,1,6.7,6.7ZM43.4,36a4.7,4.7,0,1,0-4.7,4.7h0A4.7,4.7,0,0,0,43.4,36ZM0,42.9c4.1.7,8.7-9.6,11.4-17.9A78.6,78.6,0,0,0,15.3.3c0-6.7-1.3-13.7-3.2-21.6-.6-1.6-3.4-4.2-5.8-5.1,2.2-2,1.8-2.9,2.3-3.7s.1-3.3,0-3.8c-4.5,1.1-6.3-2.7-4.3-5.5C9-44,19.3-53.3,29-55.2a6.4,6.4,0,0,0,1,1.3,3.1,3.1,0,0,0,1.8.5,2.9,2.9,0,0,0,2.4-1.2h0a3,3,0,0,0-.6-4.2,2.9,2.9,0,0,0-4.2.7,2.6,2.6,0,0,0-.5.9C19-55.4,8.7-46.5,3.6-41.5A33.5,33.5,0,0,1-.2-42.6l-3.7,1.2c-5-4.9-15.3-13.9-25.4-15.8a2.7,2.7,0,0,0-.5-1.1,3,3,0,0,0-4.2-.6,3,3,0,0,0-.6,4.2h0a3,3,0,0,0,2.4,1.2,3.2,3.2,0,0,0,1.8-.6,3.1,3.1,0,0,0,.9-1.1c10.1,2,20.8,11.8,25.2,16.3,1.3,2.5-.4,5.8-4.2,5-.1.6-.5,3,0,4s.6,1.5,2.3,3.5c-2.4.7-6,4-6.3,5.3-1.6,7-3,15.5-3,21.4a78.8,78.8,0,0,0,4,24.7C-8.8,33.3-3.5,43.8,0,42.9Zm-5.2-80a2.2,2.2,0,0,0-2.2-2.2,2.2,2.2,0,0,0-2.2,2.2,2.2,2.2,0,0,0,2.2,2.2A2.2,2.2,0,0,0-5.2-37.1ZM33-35.4a5.8,5.8,0,0,0,5.7,5.7,5.7,5.7,0,0,0,5.7-5.7,5.6,5.6,0,0,0-5.7-5.7A5.7,5.7,0,0,0,33-35.4Z","M.9,33.4v-9l12.7-9.9.3-1.4L.9,23.2v-10l14-10.9V1L.9,12V2L14.5-8.6c0-.3-.1-.7-.1-1.1L.9.8v-10l11.9-9.3a3.6,3.6,0,0,1-.2-1L.9-10.4v-10l9.2-7.1a4.2,4.2,0,0,0-.4-1L.9-21.6v-9.9h0l5.6-4.3L6-36.8.4-32.4H-.4L-6-36.8l-.5.9L-1-31.6a.1.1,0,0,0-.1.1v9.8l-8.6-6.8a4.2,4.2,0,0,0-.4,1l9,7v10l-11.5-9a3.6,3.6,0,0,1-.2,1L-1.1-9.3V.7L-14.4-9.7c0,.4-.1.8-.1,1.1L-1.1,1.9v10L-14.9,1V2.3L-1.1,13.1v10l-12.8-10,.3,1.4,12.5,9.8v9l-9.6-7.5.6,1.8,9,7v4.1a1,1,0,0,0,1,1,.9.9,0,0,0,1-1v-4l9.2-7.1.6-1.7Z","M0,.8A76.2,76.2,0,0,0,7.8,9.9c-1.6,1.9-5.4,7.6-6.6,21.6h-2C-2,17.1-6,11.4-7.6,9.7A72.7,72.7,0,0,0,0,.8ZM124.3,117.2c-6.5,4.7-6.3,16,.5,25.4a30,30,0,0,0,5.8,6,81.7,81.7,0,0,1,8.3-31.1C133.6,114.7,128.1,114.4,124.3,117.2ZM-82.6,86.3A82.8,82.8,0,0,0-104,75l-1.2,1.7A81,81,0,0,1-83.8,87.9a79.9,79.9,0,0,1,17.6,17.7l.3.5,1.3-1.7A81.3,81.3,0,0,0-82.6,86.3Zm47.3-33.1a80,80,0,0,1-3.9-23.7l-1.1.4-.9.2a83.5,83.5,0,0,0,4,23.7A79.9,79.9,0,0,0-25.8,76.6l2-.6-.3-.4A78.4,78.4,0,0,1-35.3,53.2Zm-81,62.7.6-1.9c-11.9-5.1-16.5-10-18.1-12.4a81.4,81.4,0,0,1-11.8,4.9,85.1,85.1,0,0,1,5.8,9.4C-138.6,115.3-132.2,112.1-116.3,115.9ZM-90,30.1a81.7,81.7,0,0,1-.8,11.1c2,.4,8.7,2.3,18.5,13.8l1.7-1.2c-6.9-11.4-7.6-18.1-7.4-20.9A99.4,99.4,0,0,1-90,30.1ZM38,53.8a85.2,85.2,0,0,0,4.1-23.4l-1.8-.5h-.2a81.5,81.5,0,0,1-4,23.4A81.4,81.4,0,0,1,24.6,75.5l-.4.6,2,.7h0A83,83,0,0,0,38,53.8Zm68.4,24.7-.9-1.3-.3-.4a82,82,0,0,1-17.3,17,82,82,0,0,1-22.5,11.3h-.2l1.2,1.7A85.2,85.2,0,0,0,89.1,95.4,81.6,81.6,0,0,0,106.4,78.5ZM70.8,54.6l1.6,1.2c9.9-11.4,16.5-13.4,18.5-13.7a80.8,80.8,0,0,1-.9-12,97.8,97.8,0,0,1-11.9,2.8C78.4,35.1,78.4,42.1,70.8,54.6ZM126.3,152a28,28,0,0,0-3.9-7.7,26.3,26.3,0,0,0-11.9-9.5c-4.6-1.6-8.8-1.3-12,1s-5.5,8.3-4.3,14.4A82.6,82.6,0,0,1,126.3,152Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z"],mf=[m.red,m.blue,m.green,m.yellow,m.green,m.teal,m.orange,m.purple],d2=["-30 -35 60 60","-35 -42 70 70","-35 -60 70 70","-45 -45 90 90","-15 -30 30 60","-75 28 150 100","-30 -35 60 60","-30 -35 60 60"],gf=[.7,.6,.3,.6,.3,.6,.7,.7],zl=class extends K{constructor(t,e,s){super(gt(Ni(Xo[+t])),e,s);this.type="garden";this.options=t;let n=+t;this.$path.setAttr("d",Xo[n]),this.$outline.setAttr("d",Xo[n]);let o=h("path",{d:ff[n],fill:"black",opacity:gf[n]});this.$path.insertAfter(o),this.symmetric=!0,this.setColour(mf[n])}static makeThumbnail(t,e){let s=+t,o=h("svg",{width:s===4?40:s===5?120:80,height:80,viewBox:d2[s]},e),r=h("g",{transform:"scale(0.5)"},o);h("path",{d:Xo[s],fill:mf[s],class:"polygon-tile"},r),h("path",{d:ff[s],fill:"black",opacity:gf[s]},r)}};var p2=["M34,0a16,16,0,0,1,6.3-12.7l-9-15.7A34.1,34.1,0,0,0,16,0,34.1,34.1,0,0,0,31.3,28.4l9-15.7A16,16,0,0,1,34,0Z","M-25,9.3a33.7,33.7,0,0,0-15.2,3.6l9,15.7A14.4,14.4,0,0,1-25,27.3a16.1,16.1,0,0,1,15.9,14h18A34,34,0,0,0-25,9.3Z","M-25-9.3a33.7,33.7,0,0,1-15.2-3.6l9-15.7A14.4,14.4,0,0,0-25-27.3a16.1,16.1,0,0,0,15.9-14h18A34,34,0,0,1-25-9.3Z","M-8.9,41.3h18A16.1,16.1,0,0,1,25,27.3a14.4,14.4,0,0,1,6.2,1.3l9-15.7A33.9,33.9,0,0,0-8.9,41.3Z","M-31.3-28.4l-9,15.6A65.9,65.9,0,0,1-9.1,41.3h18A83.7,83.7,0,0,0-31.3-28.4Z","M-8.9,41.3h18A65.9,65.9,0,0,1,40.3-12.8l-9-15.6A83.7,83.7,0,0,0-8.9,41.3Z","M-40.3 12.9L-31.3 28.4L40.3 -12.9L31.3 -28.4Z","M-40.2,12.9l9,15.6A65.7,65.7,0,0,1,0,20.6a65.7,65.7,0,0,1,31.2,7.9l9-15.6A82.6,82.6,0,0,0,0,2.6,82.6,82.6,0,0,0-40.2,12.9Z","M31.3,28.4l9-15.6A65.9,65.9,0,0,1,9.1-41.3h-18A83.7,83.7,0,0,0,31.3,28.4Z"],u2=[[6,3,2],[6,4,8],[7,2,5],[7,5,2],[2,6,3],[8,6,4],[5,7,2],[2,7,5],[3,2,6],[4,8,6],[2,5,7],[5,2,7],[0,1,2],[0,2,1]],xn="#242436",f2=[m.red,m.green,m.yellow];function vf(i,t){let e=u2[i].map((s,n)=>[s,n]).sort((s,n)=>n[0]-s[0]);for(let[s,n]of e)h("path",{d:p2[s],class:"tantrix","stroke-width":2.8,stroke:xn,fill:f2[n]},t)}var Fl=class extends K{constructor(t,e,s){super("reg-hexagon",e,s);this.type="tantrix";this.options=t,this.colour=xn,this.$path.setAttr("fill",xn);for(let n of this.$el.$$(".tantrix"))n.setAttr("stroke",xn);vf(+t,this.$el)}setColour(){}static makeThumbnail(t,e){let s=h("svg",{width:60,height:60,viewBox:"-54 -54 108 108"},e);h("path",{class:"polygon-tile",path:es("reg-hexagon"),fill:xn},s),vf(+t,s)}};var wf=[[[-15.7728,63.1105],[-65.2725,56.0545],[-61.7426,-21.037],[-34.7275,-63.1105],[65.2725,-63.1105]],[[60.6056,14.8729],[-53.4909,57.394],[-80.668,-12.5086],[-20.582,-57.394],[80.668,-57.394]],[[0,-73.612],[50,12.9905],[15,73.612],[-50,12.9905],[-30,-73.612]],[[67.056,-58.248],[67.056,1.752],[-10.5597,58.248],[-67.056,-19.3675],[7.056,-58.248]],[[-74.4415,-47.6314],[35.5585,-47.6314],[74.4415,-8.733],[60.1965,44.3902],[-19.4415,47.6314]],[[47.6215,-81.108],[43.731,-26.2458],[-24.012,81.108],[-47.6215,-43.6179],[-7.3786,-81.108]],[[94.9659,43.7299],[-5.0343,43.7299],[-94.9659,0],[-5.0343,-43.7299],[42.1151,-41.1631]],[[-13.1927,57.1955],[76.8074,57.1955],[76.8257,-32.8045],[-9.8062,-57.1955],[-76.8257,-6.4506]],[[-3.2764,58.8874],[86.2804,29.1016],[26.2804,-43.7514],[-26.2804,-58.8874],[-86.2804,13.9666]],[[51.5265,-55],[58.4735,-14.7198],[9.6458,43.251],[-58.4735,55],[-58.4735,-55]],[[-95.733,-40.991],[53.87,-40.991],[95.733,-15.7718],[1.5099,40.991],[-95.733,-10.4271]],[[-85.642,-51.4515],[12.4961,-51.4515],[85.642,-13.2965],[-38.4855,51.4515],[-85.642,18.5485]],[[-69.99,67.0025],[84.488,2.9975],[84.488,-67.0025],[14.488,-67.0025],[-84.488,32.0117]],[[-15.6401,96.696],[46.9202,6.219],[8.0799,-96.696],[-46.9202,-96.696],[-46.9202,51.458]],[[-46.6683,85],[-46.6683,22.7758],[15.5561,-85],[46.6683,-31.1122],[15.5561,85]],[[0,-46.65],[-43.301,-21.65],[-43.301,46.65],[43.301,46.65],[43.301,-21.65]],[[-25,46.65],[25,46.65],[59.15,-12.5],[0,-46.65],[-59.15,-12.5]],[[0,-64.951],[-50,21.65],[-25,64.951],[25,64.951],[50,21.65]]],yf=[...F.rainbow(15).map(i=>i.hex),m.red,m.blue,m.yellow],jl=class extends K{constructor(t,e,s){super((wf[+t-1]||[]).map(n=>n.join(" ")).join(","),e,s);this.type="pentagon";this.options=t,this.setColour(yf[+t-1])}static makeThumbnail(t,e){let s=h("svg",{width:80,height:80},e),n=new M(...wf[+t-1].map(r=>new d(r[0],r[1])));n=n.scale(41/n.radius).shift(40);let o=yf[+t-1];h("path",{path:n,fill:o,class:"polygon-tile"},s)}};var Yo={point:(i,t)=>i!==void 0&&t!==void 0?new d(i,t):void 0,angle:(i,t,e)=>i&&t&&e?new Ot(i,t,e):void 0,line:(i,t)=>i&&t&&!i.equals(t)?new $t(i,t):void 0,segment:(i,t)=>i&&t&&!i.equals(t)?new st(i,t):void 0,circle:(i,t)=>i&&t?new H(i,t):void 0,arc:(i,t,e)=>i&&t&&e?new Jt(i,t,e):void 0,polygon:(...i)=>i.every(t=>t)?new M(...i):void 0,polyline:(...i)=>i.every(t=>t)?new se(...i):void 0,triangle:(i,t,e)=>i&&t&&e?new tn(i,t,e):void 0,rectangle:(i,t,e)=>i?new x(i,t,e):void 0,distance:d.distance,intersections:ft},ye=mt({});ye.assign(Yo);var Ti=new Map,Pn=new Map,m2=/^_x[0-9]+\.at\([0-9-.e]+\)$/,g2=/^intersections\(|\.midpoint$|\.centroid$/,ae=class extends T{constructor(t,e,s){super(e,s,h("path",{class:"geo-path"},e.$geoPaths));this.$parent=e;this.type="geo";this.label="";this.hideSelectionOutline=!0;this.isProjection=!1;this.parentKeys=[];this.deleted=!1;this.onDraw=()=>this.draw();this.$shadow=h("path",{class:"geo-shadow"},e.$geoShadows),this.options=t;let[n,o,r]=t.split("=");o||(o=n,n=ye.getKey()),this.key=n,Ti.set(n,this),this.snapPoints=this.snapLines=this.snapAngles=[],this.setExpr(o),ye.watch(this.onDraw),this.setColour(e.state.penColor),r&&this.setLabel(r)}setExpr(t,e=!1){let s=Pt(t);ye.setComputed(this.key,s),!e&&(this.options=`${this.key}=${t}=${this.label}`,this.expr=t,this.setParentKeys(t.match(/_x[0-9]+/g)||[]),this.isProjection=m2.test(t),this.computed=g2.test(t),this.$el.setClass("intersection",this.computed))}draw(){let t=ye[this.key];if(t===this.path)return;this.path=t,this.$el.setAttr("hidden",t?void 0:!0),this.isActive&&!t&&this.$shadow.hide();let e=t==null?void 0:t.type;e!==this.geoType&&(this.$el.setClass("geo-point",e==="point"),this.$el.setClass("geo-path",e!=="point"),(e==="point"?this.$parent.$geoPoints:this.$parent.$geoPaths).append(this.$el),this.geoType=e),!!t&&(e==="point"&&(t=new H(t,this.computed?3.5:6)),this.$el.setClass("fill",this.geoType==="angle"),this.$el.draw(t,{box:this.$parent.canvasBounds.rect}),this.$shadow.setAttr("d",this.$el.attr("d")),this.transform())}setParentKeys(t){var e;for(let s of this.parentKeys)(e=Pn.get(s))==null||e.delete(this.key);this.parentKeys=t;for(let s of t)Pn.has(s)||Pn.set(s,new Set),Pn.get(s).add(this.key)}get parents(){return this.parentKeys.map(t=>Ti.get(t)).filter(t=>t)}get children(){let t=Pn.get(this.key);return t?Array.from(t).map(e=>Ti.get(e)).filter(e=>e):[]}get ariaDescription(){var t;return`${(t=this.path)==null?void 0:t.type} ${this.key}: ${this.expr}`}setLabel(t){if(this.options=`${this.key}=${this.expr}=${t||""}`,!t&&this.$label&&this.$label.detach(),!t)return this.label="";this.$label||(this.$label=h("text",{fill:E(this.colour),class:"geo-label"})),this.label||this.$parent.$geoPoints.append(this.$label),this.label=t,bf(this)}setOrder(){}select(){var t;this.isActive=!0,!!this.path&&(this.geoType==="angle"?this.$el.addClass("hover"):(this.$shadow.show(),(t=this.$el.parent)==null||t.append(this.$el)))}deselect(){this.isActive=!1,this.$shadow.hide(),this.$el.removeClass("hover")}hover(t=!0){this.isActive||!this.path||(this.geoType==="angle"?this.$el.setClass("hover",t):t?this.$shadow.show():this.$shadow.hide())}transform(){this.transformed=this.path,this.snapPoints=this.pending?[]:this.getSnapPoints(),this.snapLines=this.pending||!this.path||wt(this.path)||ie(this.path)?[]:[this.path],v2()}setTransform(){this.transform()}shift(t){!this.expr.match(/^point\([0-9.-]+,[0-9.-]+\)$/)||this.setExpr(this.path.translate(t).toString())}setColour(t){var e,s,n;this.colour=t,(e=this.$el)==null||e.css("color",E(t)),(s=this.$shadow)==null||s.css("color",E(t)),(n=this.$label)==null||n.setAttr("fill",E(t))}delete(){var t;this.deleted=!0,super.delete(),ye.unwatch(this.onDraw),ye[this.key]=void 0,Ti.delete(this.key),this.$shadow.remove(),(t=this.$label)==null||t.remove();for(let e of this.children)e.delete()}setPending(t=!0){this.pending=t,t||this.transform();for(let e of this.children)e.setPending(t)}moveStart(){if(!(this.computed||!this.path)){if(this.isProjection){if(this.$parent.selection.size>1)return;this.setParentKeys([])}this.setPending(!0);for(let t of this.parents)t.moveStart();this.moveStartValue=this.transformed}}move(t,e){if(!(!t||!this.path||!this.moveStartValue))if(wt(this.path))this.snapTarget=e,this.$el.setClass("intersection",this.computed||!!(e==null?void 0:e.intersection)),ye[this.key]=this.moveStartValue.translate(t);else for(let s of this.parents)s.move(t)}moveEnd(){var t,e,s,n;if(!!this.moveStartValue){for(let o of this.parents)o.moveEnd();if(this.setPending(!1),(t=this.snapTarget)==null?void 0:t.intersection)this.setExpr(this.snapTarget.intersection);else if(((s=(e=this.snapTarget)==null?void 0:e.tile)==null?void 0:s.type)==="geo"){let o=(n=this.snapTarget)==null?void 0:n.tile;if(o.path&&wt(o.path)){for(let r of this.children)r.setExpr(r.expr.replace(this.key,o.key));return this.$parent.selection.add(o),this.delete()}else if(o.path){let r=o.path.offset(ye[this.key]);this.setExpr(`${o.key}.at(${r})`)}}else this.path&&wt(this.path)&&(this.expr=`point(${this.path.x},${this.path.y})`,this.options=`${this.key}=${this.expr}=${this.label}`,this.isActive||this.$parent.selection.implicitChanges.add(this))}}applyChange(t){let[e,s]=t.options.split("=");s!==this.expr&&this.setExpr(s),t.colour!==this.colour&&this.setColour(t.colour),!t.locked!=!this.locked&&this.lock(t.locked),this.lastSavedData=t}static getInferredShape(t){if(t=t.filter(a=>a.path),!t.length)return;if(t.length===1)return{type:t[0].path.type,expr:t[0].key,value:t[0].path};t=t.filter(a=>a.geoType!=="angle");let e=t.filter(a=>wt(a.path)),s=t.filter(a=>Ct(a.path)||ct(a.path));if(s.length===1&&e.length===t.length-1){let a=s[0].path;if(e.every(l=>a.contains(l.path)))return{type:a.type,expr:s[0].key,value:a}}let n=s.filter(a=>Ct(a.path));if(e.length+n.length!==t.length)return;for(let a of n)if(Te(a.path)){let l=a.parentKeys.map(c=>Ti.get(c));for(let c of l)e.includes(c)||e.push(c)}else if(e.filter(l=>a.path.contains(l.path)).length<2)return;let o=e.map(a=>a.key).join(","),r=e.map(a=>a.path);if(e.length===2){let a=new st(r[0],r[1]);return{type:"segment",expr:`segment(${o})`,value:a}}return e.length===3?{type:"triangle",expr:`triangle(${o})`,value:new tn(...r)}:{type:"polygon",expr:`polygon(${o})`,value:new M(...r)}}static redrawLines(t){for(let e of Ti.values())e.path&&jr(e.path)&&(e.$el.draw(e.path,{box:t}),e.$shadow.setAttr("d",e.$el.attr("d")))}static copy(t,e){return e.replace(/\b_x[0-9]+\b/g,n=>{let o=t.get(n)||ye.getKey();return t.set(n,o),o})}static clearModel(){ye.clear(),ye.assign(Yo)}},$f=new WeakMap,xf=i=>{let t=$f.get(i);if(t)return t;let e=ae.getInferredShape(i);return $f.set(i,e),e};I([["Midpoint","geo-midpoint","$0.midpoint","segment"],["Perpendicular bisector","geo-perp-bisector","$0.perpendicularBisector","segment"],["Parallel line","geo-parallel","$0.parallel($1)","line","segment"],["Perpendicular line","geo-perpendicular","$0.perpendicular($1)","line","segment"],["Tangent line","geo-tangent","line($0.c,$1).perpendicular($1)","circle"],["Centroid","geo-centroid","$0.centroid","polygon","triangle"],["Circumcircle","geo-circumcircle","$0.circumcircle","triangle"],["Incircle","geo-incircle","$0.incircle","triangle"],["Angle bisector","geo-angle-bisector","$0.bisector","angle"]].map(([i,t,e,...s])=>({type:"button",tileTypes:["geo"],label:i,icon:t,show:n=>{var o;return s.includes(((o=xf(n))==null?void 0:o.type)||"")},click:(n,o)=>{var l;let r=(l=xf(n))==null?void 0:l.expr,a=e.replace(/\$0/g,r||"");if(a.includes("$1"))o.tools.geoPending.enable(a);else{let c=new ae(a,o);o.selection.add(c,!0);let p=wt(c.path)?"pop":"draw",u=c.$el.enter(p,400);c.$shadow.enter(p,400),o.snapping.updateIntersections(),o.change({added:[c]}),u.promise.then(()=>c.$el.css("display",""))}}})));I([{type:"input",tileTypes:["geo"],label:"Label:",advanced:!0,get:i=>i.label,set:(i,t)=>t.setLabel(i)}]);var Pf=Math.PI/12;function w2(i){return Je(i/Pf,.03)?new U(Math.round(i/Pf),12,"\u03C0").simplified.toString():nt(i,4)}function y2(i,t){return Te(t)?i.replace(/\$l/g,nt(t.length/50,4)):te(t)||ct(t)?i.replace(/\$[pc]/g,nt(t.circumference/50,4)).replace(/\$a/g,nt(t.area/2500,4)):ie(t)?i.replace(/\$r/g,w2(t.rad)).replace(/\$d/g,nt(t.deg,4)+"\xB0"):i}var v2=Le(()=>{for(let i of Ti.values())bf(i)},0,!0);function bf(i){if(!i.label||!i.path)return;i.$label.text=y2(i.label,i.path);let[t,e]=b2(i);i.$label.css("transform",`translate(${t.x}px,${t.y}px) rotate(${e}rad)`)}function b2(i){let t,e=i.$label.width,s=12,n=new x(new d(-e/2-3,-s-3),e+6,s+6);for(let o of $2(i.path,i,e,s)){t||(t=o);let r=n.rotate(o[1]).translate(o[0]);if(!Pe(Ti.values(),a=>{if(!a.path||a.hidden||a===i)return!1;let l=wt(a.path)?new H(a.path,10):a.path;if(ft(l,r).length)return!0}))return o}return t||[$,0]}function*$2(i,t,e,s){var n;if(wt(i)){let o=t.computed?8:10;yield[i.shift(o+e/2,-o),0],yield[i.shift(-o-e/2,-o),0],yield[i.shift(o+e/2,o+s),0],yield[i.shift(-o-e/2,o+s),0]}else if(Ct(i)){let o=i.perpendicularVector,r=i.angle;o.y>=0&&(o=o.scale(-1),r+=Math.PI);let a=Te(i)?[.5,.3,.7]:[0,150,-150];for(let l of a)for(let c of[8,-8-s])yield[i.at(l).add(o.scale(c)),r]}else if(te(i))for(let o of i.edges){let r=o.perpendicularVector.scale(8),a=o.angle;r.y>=0&&(r=r.scale(1+s/8),a+=Math.PI),yield[o.midpoint.add(r),a]}else if(ct(i))yield[i.at(7/8).shift(5+e/2,-5),0],yield[i.at(5/8).shift(-5-e/2,-5),0],yield[i.at(1/8).shift(5+e/2,5+s),0],yield[i.at(3/8).shift(-5-e/2,5+s),0];else if(ie(i)){let o=i.isRight?20*Math.sqrt(2):i.radius,r=((n=i.bisector)==null?void 0:n.unitVector.scale(o+6))||$,a=r.angle();yield[i.b.add(r).shift(e/2*Math.cos(a),s/2*(1+Math.sin(a))),0]}}var Sf=1,x2=.05,P2=5;function S2([i,t],e,s){if(!s)return[Math.min(i,e),Math.max(t,e)];let n=t<i?t+1:t;if(P(n-i,1,.001))return[0,1];if(it(e<i?e+1:e,i,n))return[i,t];let o=Math.abs(i-e),r=Math.abs(t-e);return Math.min(o,1-o)<Math.min(r,1-r)?[e,t]:[i,e]}function T2(i,t,e){if(P(t,0)&&P(e,1))return i;if(Ct(i))return new st(i.at(t),i.at(e));if(ee(i)){let s=i.angle*Math.abs(e-t);return new Jt(i.c,i.at(Math.min(t,e)),s)}else if(ct(i)){let s=(e-t+(e<t?1:0))*D;return new Jt(i.c,i.at(t),s)}else if(ms(i)){let s=ui(i.edges.map(l=>l.length)),n=_(s),o=s.findIndex(l=>l/n>t)+1,r=s.findIndex(l=>l/n>e)+1,a=t<=e?i.points.slice(o,r):[...i.points.slice(o),...i.points.slice(0,r)];return new se(i.at(t),...a,i.at(e))}return i}function Ul(i,t,e,s){let n=Sf,o=-1;for(let r=t+1;r<e;r++){let a=new $t(i[t],i[e]).distanceSquared(i[r]);a>n&&(o=r,n=a)}n>Sf&&(o-t>1&&Ul(i,t,o,s),s.push(i[o]),e-o>1&&Ul(i,o,e,s))}function C2(i){if(i.length<=2)return i;let t=[i[0]];return Ul(i,0,i.length-1,t),t.push(_(i)),t}function Tf(i,t,e,s=!1){let n=t||i,o=e||i,r=Math.atan2(o.y-n.y,o.x-n.x)+(s?Math.PI:0),a=d.distance(n,o)*x2;return i.shift(Math.cos(r)*a,Math.sin(r)*a)}function M2(i){return i.length<=2?Bt(new se(...i)):i.map((t,e)=>{if(e===0)return`M${t.x.toFixed(2)} ${t.y.toFixed(2)}`;if(d.distance(i[e-1],t)<4)return`L${t.x.toFixed(2)},${t.y.toFixed(2)}`;let s=Tf(i[e-1],i[e-2],t),n=Tf(t,i[e-1],i[e+1],!0);return`C${s.x.toFixed(2)},${s.y.toFixed(2)} ${n.x.toFixed(2)},${n.y.toFixed(2)} ${t.x.toFixed(2)},${t.y.toFixed(2)}`}).join("")}var Fe=class{constructor(t,e,s,n,o){this.$parent=t;this.brush=n;this.options="";this.$el=h("path",{class:`stroke ${n}`},t.$strokes),this.id=o||ci(10),this.setColor(s),e&&this.parse(e),t.strokes.set(this.id,this)}setColor(t){this.color=t,this.$el.setAttr("stroke",E(t))}parse(t){if(this.options=t,t.startsWith("M")){let e=Ni(t);this.path=new se(...e),this.$el.setAttr("d",t)}else this.path=Pt(t)(Yo),this.path&&(this.snap=!0),this.$el.setAttr("d",this.path?Bt(this.path):"")}start(t,e){var s;if(this.brush==="ruler"&&(t=((s=this.$parent.snapping.snap([t]))==null?void 0:s.posn)||t),this.startPoint=t,this.path=new se(t,t.shift(.01)),e&&this.brush!=="ruler"){this.utensil=e;let n=e.offset(t);this.utensilRange=[n,n+.01]}this.$el.draw(this.path)}addPoint(t){if(this.brush==="ruler"){let e=this.$parent.snapping.snap([t]),s=(e==null?void 0:e.posn)||t.snap(this.startPoint,P2);this.path=new st(this.startPoint,s),this.$el.draw(this.path)}else if(this.utensil){let e=S(this.utensil.offset(t),0,1),s=ct(this.utensil)||ms(this.utensil);this.utensilRange=S2(this.utensilRange,e,s),this.path=T2(this.utensil,...this.utensilRange),this.$el.draw(this.path)}else this.path.points.push(t),this.$el.setAttr("d",this.$el.attr("d")+`L${t.x},${t.y}`)}end(){if(this.utensil||this.brush==="ruler")return this.snap=!0,this.options=this.path.toString().replace(/\.([0-9]{3})[0-9]+/g,(t,e)=>`.${e}`),this.$parent.snapping.addStroke(this);{let t=C2(this.path.points);this.path=new se(...t),this.options=M2(t),this.$el.setAttr("d",this.options)}this.startPoint=this.utensil=this.utensilRange=void 0}get snapPoints(){if(!!this.snap){if(Te(this.path))return[this.path.p1,this.path.p2];if(ee(this.path))return[this.path.start,this.path.end]}}hitTest(t,e){if(!this.path)return!1;let s=this.path.project(t);return(t.x-s.x)**2+(t.y-s.y)**2<e**2}delete(){this.$parent.strokes.delete(this.id),this.$el.remove()}serialize(t=Infinity){return{points:this.options.slice(0,t),colour:this.color,brush:this.brush,id:this.id}}get lastSavedData(){return this.serialize()}static unSerialize(t,e){return new Fe(e,t.points,t.colour||"#000",t.brush||"",t.id)}};var Cf='<g class="leg-pin" style="transform-origin:bottom right"><polygon points="0,-21 -7,-21 0,0" fill="#3a3645"></polygon><path d="M-23.9-375H0v354h-7l-17-19v-335H-23.9z" fill="#d6d4db"></path></g><g class="pencil"><rect class="leg-pencil" x="0" y="-375" width="24" height="307" style="transform-box:fill-box;transform-origin:bottom center" fill="#d6d4db"></rect><g><path d="M72-48c-0.5,0-3,5-3,5H39c0,0-2.5-5-3-5v-106h36C72-154,72-48,72-48z"></path><rect x="47" y="-154" width="14" height="111" fill="#000" opacity="0.3"></rect><path d="M37.4-47.3l2.2,2.6c0.4,0.5,1,0.8,1.6,0.8c0.5,0,1-0.2,1.4-0.6l2.8-3.9c0.9-0.8,2.3-0.9,3.3-0.2l3.6,3.2c1,0.8,2.4,0.8,3.4,0l3.6-3.2c1-0.7,2.4-0.6,3.3,0.2l2.8,3.9c0.4,0.4,0.9,0.6,1.4,0.6c0.6,0,1.2-0.3,1.6-0.8l2.2-2.6c0.3-0.4,0.8-0.7,1.4-0.7L61.4-19.6c-4.8-1.9-10-1.9-14.8,0L36-48C36.6-48,37.1-47.7,37.4-47.3z" fill="#f7eecb"></path><path d="M46.6-19.6c4.8-1.9,10-1.9,14.8,0L54,0L46.6-19.6z"></path></g><path d="M81-56H15c-1.7,0-3-1.3-3-3v-18c0-1.7,1.3-3,3-3h66c1.7,0,3,1.3,3,3v18C84-57.3,82.7-56,81-56z" fill="#d6d4db"></path><circle cx="12" cy="-68" r="16" fill="#d6d4db"></circle><circle cx="12" cy="-68" r="9" fill="#3a3645"></circle></g><g class="top"><path d="M19-422H9v-25c0-2.8-2.2-5-5-5h-8c-2.8,0-5,2.2-5,5v25h-10c-2.8,0-5,2.2-5,5l0.1,42l9.2,19.2c0.4,1,1.4,4,4,4h21.7c2.7,0,3.7-3,4.1-4L24-375v-42C24-419.8,21.8-422,19-422z" fill="#3a3645"></path><circle cy="-386" r="9" fill="#d6d4db"></circle></g>';var It=50,Mf=100,Sn=class extends T{constructor(t,e,s){super(e,s);this.canRotate=!1;this.canDragToSelect=!1;this.$el.addClass("utensil"),this.options=t,this.width=+t.split(":")[0],this.absoluteEnd=new d(this.width,0),this.setup(),this.$handles=[0,1].map(n=>this.makeHandle("c",(o,r)=>{var c;let a=n?this.posn:this.absoluteEnd,l=(c=this.$parent.snapping.snap([r]))==null?void 0:c.shift;r=l?r.add(l):r.snap(a,10),d.distance(r,a)<Mf&&(r=new H(a,Mf).project(r)),n?this.absoluteEnd=r:this.posn=r,this.rot=_t(this.absoluteEnd.angle(this.posn)),this.fixedSize||(this.width=this.absoluteEnd.subtract(this.posn).length),this.update(),this.transform()})),this.update(),this.setOrder("front")}flip(){super.flip(),this.update(),this.transform()}moveEnd(){this.absoluteEnd=new d(this.width,0).rotate(Z(this.rot)).add(this.posn)}update(){this.options=""+this.width,this.$handles[1].setCenter({x:this.width,y:0})}getDrawingPath(t){var s;let e=(s=this.transformed)==null?void 0:s.project(t);if(e&&d.distance(t,e)<30)return this.transformed}},E2=["ruler","protractor","set-triangle","compass"];function Ef(i){return E2.includes(i.type)}var A2=2.54,Qo=60,Hs=It*A2;function*Af(i,t,e,s){let n=(t+.1)/i;for(let o=0;o<=n;o+=1){let r=s?s.findIndex(l=>!(o%l)):-1,a=o*i;yield[e?t-a:a,r]}}var Zl=class extends Sn{constructor(){super(...arguments);this.type="ruler";this.padding=[0,20,0,20]}setup(){let[t,e,s]=this.options.split(":");this.units=e||"cm",this.fixedSize=!!s,this.$glass=h("rect",{x:-20,height:Qo,class:"glass",rx:5},this.$el),this.$ticks=h("path",{class:"ticks"},this.$el),this.$labelsTop=B(n=>h("text",{text:n},this.$el),31),this.$labelsBottom=B(n=>h("text",{text:n,y:42},this.$el),12)}setOptions(t=this.units,e=this.fixedSize){this.units=t,this.fixedSize=e,this.update(),this.transform()}update(){let t=this.units==="both";this.$glass.setAttr("width",this.width+40),this.path=new x($,this.width,Qo);let e="";if(this.units!=="in")for(let[n,o]of Af(It/10,this.width,this.flipped,[10,5]))e+=`M${n} 0v${([20,15][o]||10)*(t?.8:1)}`;if(this.units!=="cm"){let n=t?Qo:0;for(let[o,r]of Af(Hs/16,this.width,this.flipped,[16,8,4]))e+=`M${o} ${n}v${([20,16,12][r]||8)*(t?-.8:1)}`}this.$ticks.setAttr("d",e);let s=this.units==="in"?Hs:It;for(let[n,o]of this.$labelsTop.entries())o.toggle(n*s<=this.width+.1),o.setAttr("y",t?26:32),o.setAttr("x",this.flipped?this.width-s*n:s*n);for(let[n,o]of this.$labelsBottom.entries())o.toggle(t&&n*Hs<=this.width+.1),o.setAttr("x",this.flipped?this.width-Hs*n:Hs*n);super.update(),this.options=[this.width,this.units,this.fixedSize?"1":""].join(":")}getSnapPoints(){let t=this.units==="both",e=Hs/2,s=B(o=>new d(this.flipped?this.width-o*It:o*It,0),this.width/It),n=B(o=>new d(this.flipped?this.width-o*e:o*e,t?Qo:0),this.width/e);return this.units==="cm"?s:t?[...s,...n]:n}getSnapLines(){let[t,e,s]=this.path.edges;return this.units==="both"?[t,s]:[t]}getDrawingPath(t){if(!this.transformed)return;let[e,s,n]=this.transformed.edges,o=d.distance(t,e.project(t)),r=d.distance(t,n.project(t));return o<30?e:this.units==="both"&&r<30?n:void 0}};function k2(i){return`M0-${i}A${i},${i},0,0,0-${i},0V3a5,5,0,0,0,5,5H${i-5}a5,5,0,0,0,5-5V0A${i},${i},0,0,0,0-${i}Z`}var Wl=class extends Sn{constructor(){super(...arguments);this.type="protractor";this.padding=[0,0,10,0]}setup(){this.$glass=h("path",{d:"",class:"glass"},this.$el),this.$ticks=h("path",{class:"ticks"},this.$el),this.$labels=B(t=>[h("text",{text:t*10},this.$el),h("text",{text:t*10,style:"font-size:9px"},this.$el)],19),this.$labels[9][0].css("font-size","20px"),this.$labels[9][1].hide()}update(){let t=this.width;this.path=new Jt($,new d(-this.width,0),Math.PI),this.$glass.setAttr("d",k2(t));let e="",s=this.width<120?5:1;for(let n=0;n<=180;n+=s){let o=!(n%10),r=!o&&!(n%5),a=d.fromPolar(Z(-n)),l=t-(o?30:r?23:15);e+=`M${a.x*t} ${a.y*t}L${a.x*l} ${a.y*l}`,o&&(e+=`M${a.x*8} ${a.y*8}L${a.x*(t-60)} ${a.y*(t-60)}`)}this.$ticks.setAttr("d",e);for(let[n,[o,r]]of this.$labels.entries()){if(n===9){o.setAttr("y",52-t);continue}o.toggle(t>160||!(n%3)),r.toggle(t>160),o.setAttr("y",44-t),r.setAttr("y",55-t),o.setAttr("transform",`rotate(${(this.flipped?-1:1)*(90-10*n)})`),r.setAttr("transform",`rotate(${(this.flipped?1:-1)*(90-10*n)})`)}super.update()}getSnapPoints(){return[$,this.path.start,this.path.at(.5),this.path.end]}getSnapLines(){return[]}},Kl=234,Jo=150;function V2(i){let t=i<Jo?i/(Jo/(Kl/6)):i<Kl?Kl/6:i/6,e=t+t*Math.SQRT2;return`M0,0 H${i} L0,${-i} V0 M${t},${-t} H${i-e} L${t},${-i+e} V${t},${-t}`}var Xl=class extends Sn{constructor(){super(...arguments);this.type="set-triangle"}setup(){this.$glass=h("path",{d:"","fill-rule":"evenodd",class:"glass"},this.$el),this.$ticks=h("path",{class:"ticks"},this.$el),this.$hLabels=B(t=>h("text",{text:t,y:-23},this.$el),31),this.$hLabels[0].hide(),this.$vLabels=B(t=>h("text",{text:t,x:25,"dominant-baseline":"central"},this.$el),31),this.$vLabels[0].hide()}update(){this.path=new M($,new d(this.width,0),new d(0,-this.width)),this.$glass.setAttr("d",V2(this.width));let t=this.width-50,e="",s=2,n=1;for(let o=0;o<=t;o+=It/10){let r=o%It?o%(It/2)?0:n:s,a=o<10?-10*(o/10):[-10,-15,-20][r];e+=`M${o} 0V${a}`}for(let o=0;o<=t;o+=It/10){let r=o%It?o%(It/2)?0:n:s,a=o<10?10*(o/10):[10,15,20][r];e+=`M0,${-o} H${a}`}this.$ticks.setAttr("d",e);for(let[o,r]of this.$hLabels.entries())o>0&&r.toggle(this.width>=Jo&&o<t/It),r.setAttr("x",It*o);for(let[o,r]of this.$vLabels.entries())o>0&&r.toggle(this.width>=Jo&&o<t/It),r.setAttr("y",It*-o);super.update()}getSnapPoints(){let t=this.width,e=new st($,new d(this.width,0)),s=new st($,new d(0,-this.width)),n=B(r=>e.at(r*It/t),t/It),o=B(r=>s.at(r*It/t),t/It);return n.concat(o)}getSnapLines(){return[this.path]}},tr=375,er=new d(54,68),Yl=class extends Sn{constructor(){super(...arguments);this.type="compass"}setup(){this.$el.html=Cf,this.$pencil=this.$el.$(".pencil"),this.$top=this.$el.$(".top"),this.$legPin=this.$el.$(".leg-pin"),this.$legPencil=this.$el.$(".leg-pencil"),this.setColour(m.red);let t,e=0;this.$parent.events.listen(this.$pencil.$("g"),{start:s=>{let n=new d(this.width,0).rotate(Z(this.rot)).add(this.posn);t=new Fe(this.$parent,"",this.colour,"pen"),t.start(n,new H(this.posn,this.width)),e=_t(s.posn.angle(this.posn))-this.rot;for(let o of this.$handles)o.setAttr("hidden",!0)},move:s=>{this.rot=_t(s.posn.angle(this.posn))-e,this.transform();let n=d.fromPolar(Z(this.rot),this.width).add(this.posn);t.addPoint(n)},end:()=>{t.end(),this.$parent.change({added:[t],changed:[this]}),t=void 0;for(let s of this.$handles)s.removeAttr("hidden")}}),this.$parent.events.listen(this.$top,{start:s=>{e=Z(s.posn.angle(this.posn))-this.rot;for(let n of this.$handles)n.setAttr("hidden",!0)},move:s=>{this.rot=Z(s.posn.angle(this.posn))-e,this.transform()},end:()=>{this.$parent.change({changed:[this]});for(let s of this.$handles)s.removeAttr("hidden")}})}setColour(t){super.setColour(t),this.$pencil.css("fill",this.colour)}update(){this.width>730&&(this.width=730);let t=this.width-er.x,e=tr-er.y,s=new H($,tr),n=new H(new d(t,-er.y),e),o=ft(s,n)[0],r=Math.acos(o.x/tr),a=Math.acos((t-o.x)/e);this.$legPin.css("transform",`rotate(${-r+dt}rad`),this.$legPencil.css("transform",`rotate(${a-dt}rad`),this.$pencil.setTransform({x:this.width-er.x,y:0}),this.$top.setTransform({x:o.x,y:tr+o.y}),this.path=new st($,new d(this.width,0)),super.update()}getSnapPoints(){return[$,new d(this.width,0)]}getDrawingPath(){}};I([{type:"button",tileTypes:["ruler","protractor"],label:"Flip",click:(i,t)=>{for(let e of i)e.flip();t.change({changed:i})}}]);I([{type:"select",tileTypes:["ruler"],label:"Units:",options:[{label:"Centimeters",key:"cm"},{label:"Inches",key:"in"},{label:"Both",key:"both"}],advanced:!0,get:i=>i.units,set:(i,t)=>t.setOptions(i)},{type:"checkbox",tileTypes:["ruler"],label:"Fixed Length",advanced:!0,get:i=>!!i.fixedSize,set:(i,t)=>t.setOptions(void 0,i)}]);var Ql=class extends K{constructor(t,e,s){super("square",e,s);this.type="rectangle";this.$handle=this.makeHandle("c",(r,a)=>{var l;return this.setVertex(this.relativePosn(((l=this.$parent.snapping.snap([a]))==null?void 0:l.posn)||a))}),this.$handle.css("cursor","move");let[n,o]=t.split(":").map(r=>+r||110);this.setVertex({x:n,y:o}),this.symmetric=!0}flip(t){let[e,s]=this.options.split(":");this.setVertex(new d(-+e,+s)),super.flip(t)}setVertex(t){this.path=new x($,t.x,t.y).polygon,this.$path.draw(this.path),this.$outline.draw(this.path),this.$handle.setCenter(t),this.options=`${t.x.toFixed(2)}:${t.y.toFixed(2)}`,this.transform(),this.$parent.selection.update()}static makeThumbnail(t,e){let s=h("svg",{width:80,height:80},e);h("rect",{class:"polygon-tile",x:10,y:20,width:60,height:40,fill:m.blue},s),h("circle",{cx:69,cy:59,r:4,fill:"white"},s)}};var Jl=class extends K{constructor(t,e,s){super("reg-hexagon",e,s);this.type="reg-polygon";this.$handle=this.makeHandle("c",n=>{let o=S(Math.round(3+13*(n.length-30)/100),3,16);this.setSides(o)}),this.$handle.css("cursor","move"),this.setSides(+t||6),this.symmetric=!0}setSides(t){t!==+this.options&&(this.options=t.toString(),this.path=M.regular(t,50*jt(t)),this.$path.draw(this.path),this.$outline.draw(this.path),this.$handle.setCenter(this.path.points[0]),this.snapAngles=Dt(this.path.edges.map(yn)),this.transform(),this.$parent.selection.update())}static makeThumbnail(t,e){let s=M.regular(+t||6).scale(32).shift(40,40),n=h("svg",{width:80,height:80},e);h("path",{class:"polygon-tile",path:s,fill:m.red},n),h("circle",{cx:s.points[0].x,cy:s.points[0].y,r:4,fill:"white"},n)}};var Mt=25,qs=20,kf={100:m.yellow,10:m.blue};function Tn(i,t,e,s){let n=s.shift(i*e,0),o=n.shift(0,Math.floor(t/i)*e),r=s.shift(0,Math.ceil(t/i)*e),a=r.shift(t%i*e,0),l=a.shift(0,t%i?-e:0);return new M(s,n,o,l,a,r)}var ir=class extends T{constructor(t,e,s){super(e,s);this.type="number-tile";this.options=t;let[n,o]=t.split(":").map(r=>+r);this.count=o,this.$label=h("g",{class:"outline card-label"},this.$el),this.$body=h("path",{class:"polygon-tile"},this.$el),this.$grid=h("path",{class:"polygon-tile"},this.$el),this.$outline=h("path",{class:"outline"},this.$el),o>1&&(this.$handle=this.makeHandle("h",r=>this.setWidth(Math.round(r.x/Mt)))),this.setColour(kf[o]||m.red),this.setWidth(n,!0)}setWidth(t,e=!1){var r;if(t=S(t,1,this.count),t===this.width)return;this.value=this.count,this.width=t,this.options=`${t}:${this.count}`,this.path=Tn(t,this.count,Mt,new d(-Mt/2,-Mt/2)),this.$body.draw(this.path),this.$outline.draw(this.path);let s=Math.ceil(this.count/t),n=t-(t*s-this.count),o="";for(let a=1;a<t;++a)o+=`M${(a-.5)*Mt} ${-Mt/2}v${(n<a?s-1:s)*Mt}`;for(let a=1;a<s;++a)o+=`M${-Mt/2} ${(a-.5)*Mt}h${t*Mt}`;this.$grid.setAttr("d",o),(r=this.$handle)==null||r.setTransform(new d((t-.5)*Mt,-Mt/2)),this.renderLabel(),this.transform(),e||this.$parent.selection.update()}select(){super.select(),b.isFirefox&&this.renderLabel()}setColour(t){super.setColour(t),this.$body.setAttr("fill",E(t))}renderLabel(){let t=this.count<5||this.labels==="hidden";if(this.padding=[0,25,t?0:qs,0],this.$label.removeChildren(),t)return;let e=this.width,s=this.count%e,n=(this.count-s)/e;this.$label.setTransform(new d(-Mt/2,Mt*(Math.ceil(this.count/e)-.5)));let o=h("path",{},this.$label),r=h("text",{x:6,y:15,text:`${e} \xD7 ${n}`},this.$label);s&&h("tspan",{"fill-opacity":.6,dx:6,text:` + ${s}`},r);let a=5,l=r._el.getBBox().width+12;o.setAttr("d",`M0,0 H${l-a}Q${l},0 ${l},${a}V${qs-a}Q${l},${qs} ${l-a},${qs}H${a}Q0,${qs} 0,${qs-a}H0Z`)}setLabels(t){super.setLabels(t),this.renderLabel(),this.transform()}static makeThumbnail(t,e){let[s,n]=t.split(":").map(u=>+u);s=Math.min(s,n);let o=Math.ceil(n/s),r=h("svg",{width:n===1?40:80,height:80},e),a=(n===1?20:40)-s/2*7,l=40-o/2*7,c=kf[n]||m.red,p="";for(let u=1;u<s;++u)p+=`M${a+u*7} ${l}v${o*7}`;for(let u=1;u<o;++u)p+=`M${a} ${l+u*7}h${s*7}`;h("path",{class:"polygon-tile",path:Tn(s,n,7,new d(a,l)),fill:c},r),h("path",{class:"polygon-tile",d:p},r)}getSnapPoints(){let t=new d(-Mt/2,-Mt/2),e=[t];for(let n=1;n<=this.width;++n)e.push(t.shift(n*Mt,0));let s=Math.ceil(this.count/this.width);for(let n=1;n<=s;++n)e.push(t.shift(0,n*Mt));for(let n=0;n<this.count;++n)e.push(t.shift((n%this.width+1)*Mt,Math.floor(n/this.width+1)*Mt));return e}split(){if(this.count===1)return[];this.delete();let t=Math.ceil(this.count/this.width);return t===1?B(e=>{let s=this.posn.shift(e*Mt,0).rotate(Z(this.rot),this.posn);return th(1,1,this.$parent,s,this.rot,this.colour,this.hideHandles,this.labels)},this.count):B(e=>{let s=this.posn.shift(0,e*Mt).rotate(Z(this.rot),this.posn),n=e<t-1?this.width:this.count%this.width||this.width;return th(n,n,this.$parent,s,this.rot,this.colour,this.hideHandles,this.labels)},t)}};I([{type:"button",tileTypes:["number-tile"],label:"Merge tiles",show:i=>i.length>1,click:(i,t)=>{let e=q(i.map(p=>p.count)),s=_(Vi(i,p=>p.count)),n=s.$parent,o=Math.min(...i.map(p=>p.posn.x)),r=Math.min(...i.map(p=>p.posn.y)),a=Math.max(...i.map(p=>Math.ceil((p.posn.x-o)/Mt)+p.width)),l=i.every(p=>p.labels==="hidden")?"hidden":void 0,c=th(e,a,n,new d(o,r),s.rot,s.colour,s.hideHandles,l);for(let p of i)p.delete();n.selection.add(c),t.change({added:[c],deleted:i})}},{type:"button",tileTypes:["number-tile"],label:"Split tiles",show:i=>i.some(t=>t.count>1),click:(i,t)=>{let e=[];for(let s of i)e.push(...s.split());t.selection.select(e),t.change({added:e,deleted:i})}}]);function th(i,t,e,s,n,o,r,a){let l=new ir(`${t}:${i}`,e);return l.setColour(o),l.setLabels(a),l.setTransform(s,n),l.setHandles(r),l}var Cn=[m.yellow,"#f15e19","#e1343b",m.red,"#8d2ca1","#4e53d0",m.blue,m.teal,m.green,m.lime],Vf=["#e6e2c6","#cc1030",m.green,m.red,"#ffd615",m.teal,"#181824","#9a2e13",m.blue,m.yellow],Of=25,eh=class extends K{constructor(t,e,s){super(Zo(+t*Of,Of),e,s);this.type="number-bar";this.options=t,this.value=+t,this.$text=h("text",{text:t,class:"polygon-label",y:6},this.$el),this.setColour((e.options.altColors?Vf:Cn)[+t-1])}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}setLabels(t){super.setLabels(t),this.$text.toggle(t!=="hidden")}static makeThumbnail(t,e,s){let n=+t,o=new x(new d(1,1),n*20,20),r=h("svg",{width:n*20+2,height:22},e),a=h("path",{class:"polygon-tile",path:o},r);h("text",{html:t,class:"polygon-label",x:n*10+1,y:16},r),s.options.watch(l=>a.setAttr("fill",(l.altColors?Vf:Cn)[n-1]))}};I([{type:"checkbox",tileTypes:["number-bar","number-tile","prime-disk","number-grid","dot-machine","algebra-tile"],advanced:!0,label:"Show labels:",icon:"numbers",get:i=>!i.labels,set:(i,t)=>t.setLabels(i?void 0:"hidden")}]);var Bs=50,sr={1:m.grey,2:m.yellow,3:m.green,5:m.blue,7:m.purple},O2="M0-xAx,x,0,0,0-x,0,x,x,0,0,0,0,x,x,x,0,0,0,x,0,x,x,0,0,0,0-xZM0,yAz,z,0,0,1-y,0,z,z,0,0,1,0-y,z,z,0,0,1,y,0,z,z,0,0,1,0,yZ";function Lf(i,t,e=1){let s=i.y*t.x-i.x*t.y>0?e:1-e;return[i.x,i.y+"A"+i.length,i.length,0,s,e,t.x,t.y].join(",")}function Rf(i,t,e=Bs){if(t===1)return O2.replace(/x/g,""+e).replace(/y/g,""+.4*e).replace(/z/g,""+(.4*e+.1));let s=D/t,n=-dt-s/2,o=d.fromPolar(n+s*i,e),r=d.fromPolar(n+s*(i+1),e);return`M${Lf(o,r)}L${Lf(r.scale(.4),o.scale(.4),0)}Z`}function If(i){return i===1?[1]:Re(i).reverse()}var Mn=class extends T{constructor(t,e,s){super(e,s);this.type="prime-disk";this.$segments=[];this.factors=[];this.path=new H($,Bs),h("circle",{class:"prime-background",r:Bs},this.$el),this.$segmentWrap=h("g",{},this.$el),this.$label=h("text",{class:"prime-label",y:5},this.$el),this.$outline=h("path",{class:"outline",path:this.path},this.$el),this.setValue(+t)}setValue(t){t=this.value=S(Math.round(t),1,9999999),this.options=this.$label.text=""+t,this.factors=If(t);let e=this.factors.length;for(let s=0;s<e;++s){let n=this.getSegment(s);n.setAttr("fill",sr[this.factors[s]]||m.red),n.setAttr("d",Rf(s,e)),n.show()}for(let s=e;s<this.$segments.length;++s)this.$segments[s].hide()}setLabels(t){super.setLabels(t),this.$label.toggle(t!=="hidden")}multiply(t){this.setValue(+this.options*t)}getSegment(t){if(this.$segments[t])return this.$segments[t];let e=h("path",{class:"polygon-tile"},this.$segmentWrap);return this.$parent.events.listen(e,{down:()=>{this.$parent.selection.add(this,!this.$parent.events.shiftKey)},start:()=>{!this.isActive||(this.$parent.selection.add(this,!0),e.addClass("prime-move"),this.$container.append(e))},move:s=>{!this.isActive||(e.setTransform(this.posn.add(s.posn).subtract(s.startPosn)),this.setCollision(this.findNearby("prime-disk",Bs,s.posn)))},end:s=>{if(!this.isActive)return;e.removeClass("prime-move"),e.setTransform(),this.$segmentWrap.append(e);let n=s.lastPosn.subtract(s.startPosn);if(n.length>Bs){let o=[],r=[this];if(this.collision)this.collision.multiply(this.factors[t]),this.$parent.selection.add(this.collision,!0),r.push(this.collision),this.setCollision();else{let a=new Mn(`${this.factors[t]}`,this.$parent);a.setTransform(this.posn.add(n)),o.push(a),this.$parent.selection.add(a,!0)}this.setValue(+this.options/this.factors[t]),this.$parent.change({changed:r,added:o})}},checkIfActive:()=>this.factors.length>1}),this.$segments[t]=e,e}setColour(t){if(this.colour=t,t)for(let e of this.$segments)e.setAttr("fill",E(this.colour))}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findNearby("prime-disk",Bs))}collide(t){t.highlight(!1),t.multiply(+this.options),this.delete();let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e})}static makeThumbnail(t,e){let s=h("svg",{width:54,height:54},e),n=h("g",{transform:"translate(27 27)"},s),o=r=>{n.removeChildren();let a=If(r);for(let l=0;l<a.length;++l){let c=sr[a[l]]||m.red,p=Rf(l,a.length,25);h("path",{fill:c,d:p,class:"polygon-tile"},n),h("text",{text:r,y:4,fill:"white",style:"font-size: 11px; text-anchor: middle"},n)}};e.onAttr("data-options",r=>o(Math.round(+r)))}};var Nt=25,ih=class extends T{constructor(t,e,s){super(e,s);this.type="decimal-grid";this.padding=[0,25,25,0];this.$handles=[];this.$tiles=h("g",{},this.$el),this.$outline=h("path",{class:"outline"},this.$el),this.$handles[0]=this.makeHandle("h",a=>this.setDimensions(a.x/Nt,this.height,this.size)),this.$handles[1]=this.makeHandle("v",a=>this.setDimensions(this.width,a.y/Nt,this.size)),this.$handles[2]=this.makeHandle("c",a=>this.setDimensions(this.width,this.height,(a.x+a.y)/2/Nt)),this.$handles[1].css("cursor","ns-resize"),this.$handles[2].css("cursor","nwse-resize");let[n,o,r]=t.split(":");this.setDimensions(+n,+o,+r)}setDimensions(t,e,s){t=this.width=S(Math.round(t),1,100),e=this.height=S(Math.round(e),1,100),s=this.size=S(Math.round(s),2,Math.max(t,e));let n=[t,e,s].join(":");if(n===this.options)return;this.options=n,this.$tiles.removeChildren();let o=Math.floor(t/s)*s,r=Math.floor(e/s)*s,a=s*Nt;for(let l=0;l<o;l+=s)for(let c=0;c<r;c+=s)this.drawRect(l*Nt,c*Nt,a,a,m.yellow);for(let l=o;l<t;++l)for(let c=0;c<r;c+=s)this.drawRect(l*Nt,c*Nt,Nt,a,m.blue);for(let l=0;l<o;l+=s)for(let c=r;c<e;++c)this.drawRect(l*Nt,c*Nt,a,Nt,m.blue);for(let l=o;l<t;++l)for(let c=r;c<e;++c)this.drawRect(l*Nt,c*Nt,Nt,Nt,m.red);this.$handles[0].setTransform({x:t*Nt,y:0}),this.$handles[1].setTransform({x:0,y:e*Nt}),this.$handles[2].setTransform({x:a,y:a}),this.path=new x($,t*Nt,e*Nt),this.$outline.draw(this.path),this.transform(),this.$parent.selection.update()}drawRect(t,e,s,n,o){h("rect",{x:t,y:e,width:s,height:n,fill:this.colour||o,class:"polygon-tile"},this.$tiles)}setColour(t){this.colour=t;for(let e of this.$tiles.children)e.setAttr("fill",E(t))}static makeThumbnail(t,e){let s=h("svg",{width:140,height:80},e),n=(o,r,a,l,c)=>h("rect",{x:5+o,y:5+r,width:a,height:l,fill:c,class:"polygon-tile"},s);for(let o=0;o<2;++o)n(50*o,0,50,50,m.yellow);for(let o=0;o<3;++o)n(100+10*o,0,10,50,m.blue);for(let o=0;o<2;++o)for(let r=0;r<2;++r)n(50*o,50+r*10,50,10,m.blue);for(let o=0;o<3;++o)for(let r=0;r<2;++r)n(100+o*10,50+r*10,10,10,m.red)}};var sh=class extends T{constructor(t,e,s){super(e,s);this.type="dot-machine";this.canRotate=!1;this.canDragToSelect=!1;this.cells=[];this.isAnimating=!1;let[n,o]=t.split(":").map(r=>+r);this.model=mt({base:n,boxes:o}),this.$outline=h("rect",{class:"outline",rx:12},this.$el),this.model.watch(()=>this.draw(this.model)),this.setColour(m.purple),this.setOrder("back"),this.onMove=()=>{let r=Array.from(e.selection.tiles).filter(a=>a.type==="dot");for(let a of this.cells)a.hover(r.some(l=>a.contains(l.posn)))},this.onMoveEnd=()=>{for(let r of this.cells)r.hover(!1)},e.on("move-selection",this.onMove),e.on("move-end",this.onMoveEnd),this.onChange=()=>this.rearrangeDots(),setTimeout(()=>{this.rearrangeDots(),e.on("change",this.onChange)})}setLabels(t){super.setLabels(t),this.$el.setClass("no-labels",t==="hidden")}delete(){this.$parent.off("move-selection",this.onMove),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}select(){super.select();for(let t of this.cells)t.hover()}deselect(){super.deselect();for(let t of this.cells)t.hover(!1)}draw(t){let e=Math.round(t.base),s=Math.round(t.boxes);if(this.options=`${e}:${s}`,this.cells.length>s){for(let o=s;o<this.cells.length;++o)this.cells[o].delete();this.cells=this.cells.slice(0,s)}else if(this.cells.length<s)for(let o=this.cells.length;o<s;++o){let r=new Nf(this,o,this.$parent);this.cells.push(r),r.setColour(this.colour)}for(let o of this.cells)o.setBase(e);let n=150*(s-1)+10;this.path=new x(new d(-n,-10),n+160,170),this.$outline.setRect(this.path),this.transform(),this.$parent.selection.update()}getSnapPoints(){return[]}setColour(t){super.setColour(t.slice(0,7));for(let e of this.cells)e.setColour(this.colour)}moveEnd(){super.moveEnd();for(let t of this.cells)for(let e of[...t.dots,...t.antiDots])e.cell=void 0}rearrangeDots(){if(!this.isAnimating){for(let t of this.cells)t.clear();for(let t of this.$parent.getTilesOfType("dot"))if(!t.deleted)for(let e of this.cells)(t.cell===e||!t.cell&&e.contains(t.posn))&&e.addDot(t);for(let t of this.cells)t.rearrange()}}static makeThumbnail(t,e){let s=h("svg",{width:160,height:60},e);for(let n of[105,55,5])h("rect",{x:n,y:5,width:50,height:50,class:"dot-cell",stroke:"#eee",style:"stroke-width: 6px"},s),h("circle",{cx:n+25,cy:5,r:2},s),h("circle",{cx:n+25,cy:55,r:2},s)}};I([{type:"input",tileTypes:["dot-machine"],label:"Base:",value:"number",range:[2,25],get:i=>i.model.base,set:(i,t)=>t.model.base=+i},{type:"input",tileTypes:["dot-machine"],label:"Boxes:",value:"number",range:[1,10],get:i=>i.model.boxes,set:(i,t)=>t.model.boxes=+i},{type:"button",tileTypes:["dot-machine"],label:"Explode",show:i=>i.some(t=>t.cells.some(e=>e.dots.length||e.antiDots.length)),click:(i,t)=>{let e=i.filter(s=>!s.isAnimating);for(let s of e)s.cells[0].explode();t.change({changed:e})}},{type:"button",tileTypes:["dot-machine"],label:"Annihilate",show:i=>i.some(t=>t.cells.some(e=>e.dots.length&&e.antiDots.length)),click:(i,t)=>{let e=i.filter(s=>!s.isAnimating);for(let s of e)s.cells[0].annihilate();t.change({changed:e})}}]);var Nf=class{constructor(t,e=0,s){this.machine=t;this.index=e;this.$doc=s;this.dots=[];this.antiDots=[];let n=-150*e;this.$el=h("rect",{class:"dot-cell",width:150,height:150,x:n}),this.$label=h("text",{class:"dot-label",x:75+n,y:154,"font-size":"12px"},t.$el),this.$value=h("text",{class:"dot-label",x:75+n,y:6,text:0,"font-size":"18px"},t.$el),this.bounds=new x(new d(n,0),150,150),t.$el.prepend(this.$el)}setBase(t){this.$label.text=nt(Math.pow(t,this.index))}delete(){this.$el.remove(),this.$label.remove(),this.$value.remove()}setColour(t){this.$el.setAttr("stroke",t),this.machine.isActive&&this.$el.css("fill",t)}hover(t=!0){this.machine.isActive&&!t||this.$el.css("fill",t?this.machine.colour:"none")}contains(t){return this.bounds.translate(this.machine.posn).contains(t)}clear(){this.dots=[],this.antiDots=[]}addDot(t){(t.options==="1"?this.dots:this.antiDots).push(t),t.cell=this}rearrange(){this.$value.text=nt(this.dots.length-this.antiDots.length);let t=[...this.dots,...this.antiDots];if(!t.length)return;let e=Math.ceil(Math.sqrt(t.length)),s=Math.ceil(t.length/e),n=t.length<=16?30:t.length<=25?25:20,o=this.bounds.center.add(this.machine.posn).shift(-n*(e-1)/2,-n*(s-1)/2),r=B(a=>o.shift(a%e*n,Math.floor(a/e)*n),t.length);return this.animatePoints(t,r)}animatePoints(t,e){let s=t.map(n=>n.posn);for(let[n,o]of t.entries())o.setTransform(e[n]);return X(n=>{var o;for(let[r,a]of t.entries()){let l=d.interpolate(s[r],e[r],rt("quad",n));a.$el.setTransform(l),a.transformed=(o=a.path)==null?void 0:o.translate(l)}this.machine.$parent.selection.update()},240).promise}getDotsToExplode(){let t=this.machine.model.base;if(this.dots.length>=t)return this.dots.splice(0,t);if(this.antiDots.length>=t)return this.antiDots.splice(0,t)}explode(){return R(this,null,function*(){let t=this.machine.cells[this.index+1];if(!t){this.machine.isAnimating=!1,this.machine.$parent.change({changed:this.dots});return}this.machine.isAnimating=!0;let e=this.getDotsToExplode();if(!e)return t.explode();this.$doc.playSound("rise"),t.addDot(e[0]);for(let s of e.slice(1))s.popOut();return t.rearrange(),yield Xe(400),this.rearrange(),yield Xe(400),this.explode()})}annihilate(){return R(this,null,function*(){this.machine.isAnimating=!0;let t=Math.min(this.dots.length,this.antiDots.length);if(t){let s=this.dots.splice(0,t),n=this.antiDots.splice(0,t);for(let o of[...s,...n])o.popOut();this.$doc.playSound("woosh"),this.rearrange(),yield Xe(600)}let e=this.machine.cells[this.index+1];if(e)return e.annihilate();this.machine.isAnimating=!1,this.machine.$parent.change({changed:this.dots})})}};var nr=25/2,En=class extends T{constructor(t,e,s){super(e,s);this.type="dot";this.deleted=!1;this.options=t,this.$path=h("circle",{r:nr,class:"polygon-tile"},this.$el),this.$outline=h("circle",{r:nr,class:"outline"},this.$el),this.path=new H($,nr),this.setColour(m.blue)}setColour(t){this.colour=t,this.$path.setAttr("fill",this.options==="-1"?m.red:this.colour)}getSnapPoints(){return[]}getCell(){for(let t of this.$parent.getTilesOfType("dot-machine"))if(!t.isActive){for(let e of t.cells)if(e.contains(this.posn))return e}}moveEnd(){let t=this.cell,e=this.cell=this.getCell();if(!t||!e||t===e||t.machine!==e.machine)return;let s=Math.abs(t.index-e.index),n=t.machine.model.base**s;if(t.index<e.index){let o=this.options==="1"?t.dots:t.antiDots;if(o.length<n)return this.cell=t;for(let r of o.filter(a=>!a.isActive).slice(0,n-1))r.popOut()}else for(let o=0;o<n-1;++o){let r=new En(this.options,this.$parent);r.posn=this.posn,r.cell=e}}static makeThumbnail(t,e){let s=t==="1"?m.blue:m.red,n=h("svg",{width:40,height:40},e);h("circle",{class:"polygon-tile",cx:20,cy:20,r:nr,fill:s},n)}negate(){this.options=this.options==="-1"?"1":"-1",this.setColour(m.blue)}popOut(){return R(this,null,function*(){this.deleted=!0,yield this.$path.exit("pop").promise,this.delete()})}};function Gf(i){return i===0?m.grey:i>0?m.blue:m.red}function Df(i){return+i.replace("\u2013","-")}function _f(i,t,e=0){t=S(Math.round(t),-9999,9999);let s=i.text=nt(t),n=S(40/s.length*2,16,32);return i.css("font-size",n+"px"),i.setAttr("y",.3*n+26+e),t}var nh=class extends T{constructor(t,e,s){super(e,s);this.type="number-card";this.path=new x($,50),this.$path=h("rect",{class:"polygon-tile",rx:6,width:50,height:50},this.$el),this.$label=h("text",{x:25,fill:"white",style:"text-anchor: middle"},this.$el),this.$outline=h("rect",{class:"outline",rx:6,width:50,height:50},this.$el),this.setValue(Df(t))}setValue(t){this.value=_f(this.$label,t),this.options=""+this.value,this.setColour()}setColour(t){super.setColour(t||Gf(this.value)),this.$path.setAttr("fill",E(this.colour))}highlight(t=!0){this.$el.setClass("active",t)}move(t){if(super.move(t),!this.$parent.options.mergeTiles||this.$parent.selection.tiles.size>1)return;let e=this.findNearby("number-card",35);this.setCollision(e&&it(e.value+this.value,-9999,9999)?e:void 0)}collide(t){t.highlight(!1),t.setValue(t.value+this.value),this.$parent.playSound("click"),this.delete();let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e})}negate(){this.setValue(-this.value)}static makeThumbnail(t,e){let s=h("svg",{width:60,height:60},e),n=h("rect",{x:5,y:5,width:50,height:50,class:"polygon-tile",rx:6},s),o=h("text",{fill:"white",x:30,style:"text-anchor: middle"},s);e.onAttr("data-options",r=>{let a=_f(o,Df(r),5);n.setAttr("fill",Gf(a))})}};var Lt=50,ns=14,L2=`M-${Lt/2} -4.5h${Lt*ns}v-33h9v75h-9v-33h-${Lt*ns}v33h-9v-75h9Z`,oh=class extends T{constructor(t,e,s){super(e,s);this.type="abacus";this.options=t,this.path=new x(new d(-Lt/2-9,-Lt/2-12.5),ns*Lt+18,Lt+25),h("path",{path:this.path,fill:"transparent"},this.$el),h("path",{d:L2,class:"polygon-tile",fill:"#7e7c86"},this.$el),h("path",{path:this.path,class:"outline"},this.$el),this.positions=t.split(",").map(n=>+n),this.$beads=this.positions.map(n=>h("circle",{cx:n*Lt,r:Lt/2,class:"polygon-tile"},this.$el)),this.$gradients=this.positions.map(n=>h("circle",{cx:n*Lt,r:Lt/2,class:"bead-gradient"},this.$el)),this.count=this.$beads.length;for(let[n,o]of this.$beads.entries())this.setupBead(o,n);this.setColour(m.orange)}setupBead(t,e){let s=0;this.$parent.events.listen(t,{click:()=>{this.locked||this.$parent.selection.add(this,!this.$parent.events.shiftKey)},start:n=>{s=this.positions[e]-this.relativePosn(n.posn).x/Lt},move:n=>{let o=this.positions[e]=S(s+this.relativePosn(n.posn).x/Lt,e,ns-(this.count-e)),r=o;for(let l=e+1;l<this.count;++l)this.positions[l]<r+1&&(this.positions[l]=r+1),r=this.positions[l];let a=o;for(let l=e-1;l>=0;--l)this.positions[l]>a-1&&(this.positions[l]=a-1),a=this.positions[l];for(let[l,c]of this.$beads.entries())c.setAttr("cx",this.positions[l]*Lt),this.$gradients[l].setAttr("cx",this.positions[l]*Lt)},end:()=>{let n=this.options;this.options=this.positions.join(","),n!==this.options&&this.$parent.change({changed:[this]})}})}setColour(t){super.setColour(t.slice(0,7));let e=this.$beads.length/2,s=F.mix("#fff",this.colour,.8);for(let[n,o]of this.$beads.entries())o.setAttr("fill",n<e?this.colour:s)}getSnapPoints(){return[new d(-Lt/2,-25),new d((ns-.5)*Lt,-25),new d(-Lt/2,25),new d((ns-.5)*Lt,25),new d(-Lt/2,50),new d((ns-.5)*Lt,50)]}static makeThumbnail(t,e){let s=h("svg",{width:240,height:40},e);h("line",{x1:5,y1:18,x2:235,y2:20,stroke:"white","stroke-width":"3px"},s),h("line",{x1:4,y1:3,x2:4,y2:37,stroke:"white","stroke-width":"3px"},s),h("line",{x1:236,y1:3,x2:236,y2:37,stroke:"white","stroke-width":"3px"},s);for(let n=0;n<10;++n){let o=n<5?m.orange:F.mix("#fff",m.orange,.7),r={cx:16+20*n,cy:20,r:10,style:"stroke-width: 0.5px"};h("circle",j(j({},r),{class:"polygon-tile",fill:o}),s),h("circle",j(j({},r),{class:"bead-gradient"}),s)}}};var R2={1:m.yellow,x:m.green,x2:m.blue,y:m.teal,y2:"#8d2ca1",xy:"#4e53d0"},An=25,I2=An*5.4,N2=An*4.7,G2="#ddd";function or(i){return i.replace("-","\u2013").replace("2","\xB2")}function rh(i){return i[0]==="-"?m.red:R2[i]}function Hf(i,t=An,e=I2,s=N2){return i.endsWith("x2")?[e,e]:i.endsWith("y2")?[s,s]:i.endsWith("xy")?[e,s]:i.endsWith("x")?[t,e]:i.endsWith("y")?[t,s]:[t,t]}var kn=class extends K{constructor(t,e,s){super(Zo(...Hf(t.toLowerCase())),e,s);this.type="algebra-tile";this.options=t.toLowerCase(),this.$text=h("text",{text:or(this.options),class:"polygon-label",y:6},this.$el),this.setColour(rh(this.options))}setLabels(t){super.setLabels(t),this.$text.toggle(t!=="hidden")}setColour(t=this.colour){super.setColour(t),this.$path.setAttr("fill",E(this.collision?G2:this.colour)),this.$text.text=this.collision?"0":or(this.options)}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}setCollision(t){this.collision=t,this.setColour()}move(t){if(super.move(t),this.collision){if(d.distance(this.posn,this.collision.posn)<.95*An)return;this.collision.setCollision(),this.setCollision()}let e=this.options[0]==="-"?this.options.slice(1):"-"+this.options;for(let s of this.$parent.getTilesOfType("algebra-tile"))if(!(s.collision||s===this||s.options!==e)&&!(d.distance(this.posn,s.posn)>=.95*An)){this.setCollision(s),s.setCollision(this);return}}static makeThumbnail(t,e){let[s,n]=Hf(t,20,78,64),o=t[0]==="-"?t.slice(1):t,r=o==="y2"?112:["x2","xy"].includes(o)?28:2,a=o==="1"?2:["x","x2"].includes(o)?28:112;e.hasAttr("data-rot")&&([r,a,s,n]=[a,r,n,s]),e.setRect(new x(new d(r,a),s,n)),e.setAttr("fill",rh(t)),e.insertAfter(h("text",{text:or(t),class:"polygon-label",x:r+s/2,y:a+n/2+5}))}negate(){this.options.startsWith("-")?this.options=this.options.slice(1):this.options="-"+this.options,this.setColour(rh(this.options)),this.$text.text=or(this.options)}};I([{type:"button",tileTypes:["algebra-tile","dot","number-card"],label:"Negate",click:(i,t)=>{for(let e of i)e.negate();t.change({changed:i})}}]);var qf="M-125,0l35,252c0,11,40.3,20,90,20s90-9,90-20L125,0Z",Bf=B(i=>new d(i<5?-45:45,65+40*(i%5)),10),ah=class extends T{constructor(t,e,s){super(e,s);this.type="bucket";this.canRotate=!1;this.canDragToSelect=!1;this.isAnimating=!1;this.tiles=Ht(void 0,20);h("path",{class:"polygon-tile bucket",d:qf,fill:"#ccc"},this.$el),h("ellipse",{class:"polygon-tile bucket",rx:125,ry:28,fill:"#888"},this.$el),this.$text=h("text",{text:0,class:"bucket-label",y:12},this.$el),this.setColour(m.grey),this.path=new M(new d(-125,0),new d(0,-28),new d(125,0),new d(90,252),new d(0,272),new d(-90,252)),this.setOrder("back"),this.onMoveEnd=()=>this.recompute(),e.on("change",this.onMoveEnd)}delete(){this.$parent.off("change",this.onMoveEnd),super.delete()}getSnapPoints(){return[]}recompute(){return R(this,null,function*(){var e;if(this.isAnimating)return;let t=[];for(let[s,n]of this.tiles.entries())n&&!Pe(this.$parent.tiles.values(),o=>o===n)&&(this.tiles[s]=void 0);for(let s of this.$parent.getTilesOfType("algebra-tile")){if(!s.options.endsWith("1"))continue;let n=s.options!=="1",o=(e=this.transformed)==null?void 0:e.contains(s.posn),r=this.tiles.indexOf(s);if(r>=0&&!o&&(this.tiles[r]=void 0),!o)continue;if((n?r>=0&&r<10:r>=10)&&(this.tiles[r]=void 0,r=-1),r<0&&(r=this.tiles.findIndex((l,c)=>!l&&(n?c>=10:c<10))),r<0)return;this.tiles[r]=s;let a=Bf[r%10].shift(n?15:-15,0).add(this.posn);a.equals(s.posn)||t.push({tile:s,from:s.posn,to:a})}if(this.$text.text=nt(q(this.tiles.map((s,n)=>s?n<10?1:-1:0))),t.length){this.isAnimating=!0,yield X(s=>{var o;let n=rt("quad",s);for(let{tile:r,from:a,to:l}of t){let c=d.interpolate(a,l,n);r.posn=c,r.$el.setTransform(c,Z(r.rot)),r.transformed=(o=r.path)==null?void 0:o.translate(c)}this.$parent.selection.update()},240).promise;for(let s of t)s.tile.transform(),s.tile.move();this.isAnimating=!1}})}fill(){if(this.isAnimating)return[];let t=[];for(let[e,s]of this.tiles.entries()){if(s)continue;let n=new kn(e<10?"1":"-1",this.$parent);n.setTransform(Bf[e%10].shift(e<10?-15:15,0).add(this.posn)),this.tiles[e]=n,t.push(n)}return this.$text.text="0",t}static makeThumbnail(t,e){let s=h("svg",{width:120,height:140,viewBox:"-140 -40 280 320"},e);h("path",{class:"polygon-tile bucket",d:qf,fill:"#ccc",style:"stroke-width: 2px"},s),h("ellipse",{class:"polygon-tile bucket",rx:125,ry:28,fill:"#888",style:"stroke-width: 2px"},s)}};I([{type:"button",tileTypes:["bucket"],label:"Fill bucket",click:(i,t)=>{let e=[];for(let s of i)e.push(...s.fill());e.length&&t.change({added:e})}}]);var be=50,zf=le((i,t,e,s,n)=>i==="number"?1+s+n*t:i==="addition"?!s&&!n?"+":!s||!n?s||n:s+n:!s&&!n?"\xD7":!s||!n?s||n:s*n),D2=le(i=>F.from(i).brightness<140),_2=le(i=>F.mix(i,"#000",.7).hex);function H2(i){return i?new Map(i.split(",").map(t=>t.split("-"))):new Map}function q2(i){return Array.from(i.entries()).map(t=>t.join("-")).join(",")}var lh=class extends T{constructor(t,e,s){super(e,s);this.type="number-grid";this.cells=[];this.$handles=[];this.rows=3;this.cols=2;this.selected=new Set;this.padding=[0,25,25,0];this.canRotate=!1;this.$cells=h("g",{},this.$el),this.$outline=h("path",{class:"outline"},this.$el),e.events.listen(this.$el,{down:l=>this.selectCell(l.posn),move:l=>this.selectCell(l.posn,!0),checkIfActive:()=>!!this.isFocussed}),this.$handles[0]=this.makeHandle("h",l=>this.resize(l.x/be,this.rows)),this.$handles[1]=this.makeHandle("v",l=>this.resize(this.cols,l.y/be)),this.$handles[1].css("cursor","ns-resize");let[n,o,r,a]=t.split(":");this.gridType=n,this.colour="#ccc",this.colorsStr=a||"",this.colors=H2(this.colorsStr),this.resize(+o,+r)}resize(t,e){this.cols=S(Math.round(t),2,20),this.rows=S(Math.round(e),2,20);let s=`${this.gridType}:${this.cols}:${this.rows}:${this.colorsStr}`;if(s===this.options)return;this.options=s;let n=this.cols*this.rows;for(let o=this.cells.length;o<n;++o)this.cells.push(this.makeCell());for(let o=n;o<this.cells.length;++o)this.cells[o][0].hide();this.updateCells(),this.path=new x($,this.cols*be,this.rows*be),this.$outline.draw(this.path),this.$handles[0].setTransform({x:this.path.w,y:0}),this.$handles[1].setTransform({x:0,y:this.path.h}),this.transform(),this.$parent.selection.update()}makeCell(){let t=h("g",{class:"number-grid-cell"},this.$cells),e=h("circle",{r:23,cx:be/2,cy:be/2},t);return[t,e,h("text",{x:be/2,y:be/2+8},t)]}updateCells(){for(let t=0;t<this.cols;++t)for(let e=0;e<this.rows;++e){let[s,n,o]=this.cells[t+e*this.cols];s.show(),s.translate(t*be,this.flipped?(this.rows-1-e)*be:e*be),o.text=""+this.getCellValue(t,e)}this.updateColors()}updateColors(){let t=this.gridType==="number",e=E(this.colour),s=_2(e);for(let n=0;n<this.cols;++n)for(let o=0;o<this.rows;++o){let r=n+o*this.cols,a=!t&&(!n||!o),l=this.colors.get(t?`${r}`:`${o}/${n}`)||(a?s:e);this.cells[r][1].setAttr("fill",l),this.cells[r][2].setAttr("fill",D2(l)?"#fff":"#000")}}setLabels(t){super.setLabels(t),this.$el.setClass("no-labels",t==="hidden")}setColour(t,e){if(this.isFocussed&&e==="picker"){let s=this.gridType==="number",n=E(t);for(let o of this.selected)this.colors.set(s?`${o}`:`${Math.floor(o/this.cols)}/${o%this.cols}`,n);return this.colorsStr=q2(this.colors),this.options=`${this.gridType}:${this.cols}:${this.rows}:${this.colorsStr}`,this.$parent.change({changed:[this]}),this.updateColors()}e==="picker"&&(this.colors.clear(),this.colorsStr="",this.options=`${this.gridType}:${this.cols}:${this.rows}`),super.setColour(t),this.updateColors()}doubleClick(t){this.focus(),this.selectCell(t.posn)}selectCell(t,e=!1){if(t=this.relativePosn(t).scale(1/be).floor(),t.x<0||t.x>=this.cols||t.y<0||t.y>=this.rows)return;let s=t.x+(this.flipped?this.rows-1-t.y:t.y)*this.cols;if(e)this.selected.has(s)||this.addToSelection(s);else if(this.$parent.events.shiftKey)this.selected.has(s)?this.removeFromSelection(s):this.addToSelection(s);else{for(let n of this.selected)this.removeFromSelection(n);this.addToSelection(s)}}addToSelection(t){this.cells[t][0].addClass("active"),this.selected.add(t)}removeFromSelection(t){this.cells[t][0].removeClass("active"),this.selected.delete(t)}getCellValue(t,e){return zf(this.gridType,this.cols,this.rows,t,e)}blur(){if(!!this.isFocussed){for(let t of this.selected)this.removeFromSelection(t);super.blur()}}flip(){super.flip(),this.updateCells()}selectMultiples(){let t=Array.from(this.selected).map(s=>+this.getCellValue(s%this.cols,Math.floor(s/this.cols))),e=t.length>1?Li(...t):t[0];for(let s of this.selected)this.removeFromSelection(s);for(let s=0;s<this.cols;++s)for(let n=0;n<this.rows;++n)+this.getCellValue(s,n)%e==0&&this.addToSelection(s+n*this.cols)}static makeThumbnail(t,e){let s=t.split(":")[0],n=s==="number"?5:4,o=h("svg",{width:10+25*n,height:10+25*n,"text-anchor":"middle","font-size":"14"},e),r=(a,l,c,p)=>{h("circle",{cx:a+17.5,cy:l+17.5,r:12,fill:c},o),h("text",{x:a+17.5,y:l+22,text:p,fill:"white"},o)};for(let a=0;a<n;++a)for(let l=0;l<n;++l){let c=s==="number"||a&&l?"#ffffff44":"#ffffff88";r(25*a,25*l,c,zf(s,n,n,a,l))}}};I([{type:"button",tileTypes:["number-grid"],label:"Switch direction",click:(i,t)=>{for(let e of i)e.flip();t.change({changed:i})}},{type:"button",tileTypes:["number-grid"],focus:"show",label:"Select all multiples",click:i=>{i[0].selectMultiples()}}]);var Ff=25;function B2(i){let t=+i,e=Math.ceil(t/2);return gt(Tn(e,t,Ff,$).points)}function jf(i,t,e,s=0,n=0){let o=Math.ceil(i/2);for(let r=0;r<i;++r){let a=(r%o+.5)*t+s,l=(.5+(r<o?0:1))*t+n;h("circle",{fill:"white",cx:a,cy:l,r:t*.2},e)}}var hh=class extends K{constructor(t,e,s){super(B2(t),e,s);this.type="number-frame";this.options=t,this.value=+t,this.setColour(Cn[this.value-1]),jf(this.value,Ff,this.$el)}static makeThumbnail(t,e){let s=+t,n=Math.ceil(s/2),o=Tn(n,s,20,new d(5,5)),r=h("svg",{width:n*20+10,height:50},e);h("path",{path:o,fill:Cn[s-1],class:"polygon-tile"},r),jf(s,20,r,5,5)}};var Ae=50,ch=class extends T{constructor(t,e,s){super(e,s);this.type="ten-frame";this.canRotate=!1;this.canDragToSelect=!1;this.padding=[0,25,25,0];this.$handles=[];this.rows=2;this.cols=5;this.$border=h("rect",{"stroke-width":4,fill:"transparent"},this.$el),this.$minorGuides=h("path",{"stroke-width":3},this.$el),this.$majorGuides=h("path",{"stroke-width":2,opacity:.4},this.$el),this.$outline=h("rect",{class:"outline"},this.$el),this.$handles[0]=this.makeHandle("h",r=>this.resize(r.x/Ae,this.rows)),this.$handles[1]=this.makeHandle("v",r=>this.resize(this.cols,r.y/Ae)),this.$handles[1].css("cursor","ns-resize");let[n,o]=t.split(":");this.resize(+n,+o),this.setColour("#000000"),this.setOrder("back")}resize(t,e){this.cols=S(Math.round(t),1,25),this.rows=S(Math.round(e),1,20);let s=`${this.cols}:${this.rows}`;if(s===this.options)return;this.options=s,this.path=new x($,this.cols*Ae,this.rows*Ae),this.$outline.setRect(this.path),this.$border.setRect(this.path);let n=["",""];for(let o=1;o<this.rows;++o)n[o%2?1:0]+=`M0,${Ae*o}h${Ae*this.cols}`;for(let o=1;o<this.cols;++o)n[o%5?1:0]+=`M${Ae*o},0v${Ae*this.rows}`;this.$minorGuides.setAttr("d",n[0]),this.$majorGuides.setAttr("d",n[1]),this.$handles[0].setTransform({x:this.path.w,y:0}),this.$handles[1].setTransform({x:0,y:this.path.h}),this.transform(),this.$parent.selection.update()}*counters(){for(let t of this.$parent.getTilesOfType("ten-frame-counter"))this.transformed.contains(t.posn)&&(yield t)}moveStart(t=!1){if(super.moveStart(),!t)for(let e of this.counters())this.$parent.selection.add(e)}setColour(t){super.setColour(t);let e=E(t);for(let s of[this.$border,this.$minorGuides,this.$majorGuides])s.setAttr("stroke",e)}getSnapPoints(){return qt(jn((t,e)=>new d(.5+t,.5+e).scale(Ae),this.cols+1,this.rows+1))}static makeThumbnail(t,e){let[s,n]=t.split(":").map(a=>+a),o=h("svg",{width:s*25+4,height:n*25+4},e);h("rect",{x:2,y:2,width:s*25,height:n*25,fill:"none",stroke:"white","stroke-width":3},o);let r="";for(let a=1;a<n;++a)r+=`M2,${2+25*a}h${25*s}`;for(let a=1;a<s;++a)r+=`M${2+25*a},2v${25*n}`;h("path",{d:r,stroke:"white","stroke-width":1},o)}},dh=class extends T{constructor(t,e,s){super(e,s);this.type="ten-frame-counter";this.options=t,this.$path=h("circle",{r:20,class:"polygon-tile"},this.$el),this.$outline=h("circle",{r:20,class:"outline"},this.$el),this.path=new H($,20),this.setColour(t==="1"?m.yellow:m.red)}moveEnd(){let t=this.$parent.getTileAt(this.posn,["ten-frame"]);if(!t)return;let e=t.relativePosn(this.posn),s=t.worldPosn(e.scale(1/Ae).shift(-.5).round().shift(.5).scale(Ae));this.animateTo(s,this.posn,50)}flip(){this.options=this.options==="1"?"0":"1",this.setColour(this.options==="1"?m.yellow:m.red)}doubleClick(){this.flip(),this.$parent.change({changed:[this]})}setColour(t){this.colour=t,this.$path.setAttr("fill",this.colour)}getSnapPoints(){return[$]}static makeThumbnail(t,e){let s=h("svg",{width:40,height:40},e),n=t==="1"?m.yellow:m.red;h("circle",{cx:20,cy:20,r:18,fill:n},s)}static action(t,e){return R(this,null,function*(){if(t==="flip"){for(let s of e)s.flip();e[0].$parent.change({changed:e})}})}};I([{type:"button",tileTypes:["ten-frame-counter"],label:"Flip",click:(i,t)=>{for(let e of i)e.flip();t.change({changed:i})}}]);var Uf=4,Zf=6,os=6;function Wf(i){return i===1?[1]:Re(i)}var z2=le((i,t)=>{if(i===2)return 2*t+1.5*os;let e=2*t+os,s=2*t+os;i===3&&(s/=Math.sqrt(3)),i===4&&(s/=Math.sqrt(2)),i>3&&i%2&&(i-=1);let o=Math.ceil((Math.sqrt(i*8/Zf+1)-1)/2);return s+(o-1)*e+t+os});function ph(i){return i.reduceRight((t,e)=>z2(e,t),Uf)}function F2(i,t){if(i===1)return[];if(i===2)return[$.shift(-t-os/2,0),$.shift(t+os/2,0)];let e=[],s=2*t+os,n=s;i===3&&(n/=Math.sqrt(3)),i===4&&(n/=Math.sqrt(2)),i>3&&i%2&&(e.push($),i-=1);let o=1;for(;i;){let r=Math.min(Zf*o,i);e.push(...M.regular(r,n).points),i-=r,n+=s,o+=1}return e}function uh(i,t,e,s=$){if(i.length<1)return[];let n=h("g",{class:"tile","data-n":i.join("-")},e),o=sr[i[0]]||m.red;h("circle",{r:t,cx:s.x,cy:s.y,fill:o,class:"polygon-tile"},n);let r=i.slice(1),a=ph(r),l=F2(i[0],a);if(r.length){let c=[n];for(let p of l)c.push(...uh(r,a,n,s.add(p)));return c}else{for(let c of l){let p=s.add(c);h("circle",{r:Uf,cx:p.x,cy:p.y,fill:"white"},n)}return[n]}}var Vn=class extends T{constructor(t,e){super(e);this.type="number-dot";this.factors=[];this.$body=h("g",{},this.$el),this.$outline=h("path",{class:"outline"},this.$el),t.startsWith(">")?(this.options=t,this.factors=t.slice(1).split("-").map(s=>+s),this.value=this.factors.reduce((s,n)=>s*n,1),this.count=this.factors.length,this.buildTile()):this.setValue(+t)}setValue(t){t=this.value=S(Math.round(t),1,999),this.factors=Wf(t),this.count=this.factors.length,this.options=">"+this.factors.join("-"),this.buildTile()}add(t){this.setValue(this.value+t)}buildTile(){this.$body.removeChildren(),this.radius=ph(this.factors);let t=uh(this.factors,this.radius,this.$body);if(this.factors.length>1)for(let e of t.slice(1))this.setupListeners(e);this.path=new H($,this.radius),this.$outline.draw(this.path),this.transform()}setupListeners(t){let s=t.attr("data-n").split("-").reduce((r,a)=>r*+a,1),n=t.parent,o=t.children[0];this.$parent.events.listen(t,{down:()=>this.$parent.selection.add(this,!this.$parent.events.shiftKey),start:()=>{!this.isActive||(this.$parent.selection.add(this,!0),o.addClass("prime-move"),this.$container.append(t))},move:r=>{!this.isActive||(t.setTransform(this.posn.add(r.posn).subtract(r.startPosn)),this.setCollision(this.findCollision(r.posn)))},end:r=>{if(!!this.isActive)if(r.lastPosn.subtract(this.posn).length<=this.radius)t.setTransform(),o.removeClass("prime-move"),n.append(t);else if(this.collision)t.remove(),this.collision.add(s),this.add(-s),this.$parent.selection.add(this.collision,!0),this.$parent.change({changed:[this,this.collision]}),this.setCollision();else{t.remove();let a=new Vn(`${s}`,this.$parent);a.setTransform(this.posn.add(r.lastPosn).subtract(r.startPosn)),this.add(-s),this.$parent.change({added:[a],changed:[this]})}}})}findCollision(t){for(let e of this.$parent.getTilesOfType("number-dot"))if(e!==this&&d.distance(t,e.posn)<e.radius)return e}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findCollision(this.posn))}collide(t){t.highlight(!1),t.add(this.value);let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e}),this.delete()}reorder(){this.factors.push(this.factors.shift()),this.options=`>${this.factors.join("-")}`,this.buildTile()}shrink(){this.factors.length<=1||(this.factors.push(this.factors.pop()*this.factors.pop()),this.count=this.factors.length,this.options=`>${this.factors.join("-")}`,this.buildTile())}grow(){let t=this.factors.length-1-this.factors.slice(0).reverse().findIndex(n=>!Js(n));if(t<0||!this.factors[t])return;let e=Re(this.factors[t])[0],s=Math.round(this.factors[t]/e);this.factors.splice(t,1,e,s),this.count=this.factors.length,this.options=`>${this.factors.join("-")}`,this.buildTile()}static makeThumbnail(t,e){let s=h("svg",{width:54,height:54},e),n=o=>{s.removeChildren();let r=Wf(o);for(let a=0;a<r.length;++a){let l=ph(r);uh(r,l,s)[0].css("transform",`translate(27px, 27px) scale(${25/l})`)}};e.onAttr("data-options",o=>n(Math.round(+o)))}};I([{type:"button",tileTypes:["number-dot"],label:"Combine factors",icon:"combine-dots",show:i=>i.some(t=>t.factors.length>1),click:(i,t)=>{i=i.filter(e=>e.factors.length);for(let e of i)e.shrink();t.change({changed:i})}},{type:"button",tileTypes:["number-dot"],label:"Split factors",icon:"split-dots",click:(i,t)=>{for(let e of i)e.grow();t.change({changed:i})}},{type:"button",tileTypes:["number-dot"],label:"Reorder",show:i=>i.some(t=>t.factors.length>1),click:(i,t)=>{i=i.filter(e=>e.factors.length);for(let e of i)e.reorder();t.change({changed:i})}}]);var On=25,fh=class extends T{constructor(t,e,s){super(e,s);this.type="number-line";this.padding=[0,25,20,25];this.$el.addClass("number-line"),this.$fill=h("path",{fill:"transparent"},this.$el),this.$lines=h("path",{class:"number-line-ticks"},this.$el),this.$labels=h("g",{},this.$el),this.setColour(m.darkGrey);let[n,o,r,a,l]=t.split(":"),c=this.model=mt({start:U.fromString(n)||new U(0),step:U.fromString(o)||new U(1),width:+r,size:+a,minor:+l});this.$start=this.makeHandle("h",p=>{let u=S(Math.round(p.x/On/c.size),c.width-100,c.width-1);!u||(this.setTransform(this.posn.rotate(-Z(this.rot)).shift(u*On*c.size,0).rotate(Z(this.rot))),c.width-=u,c.start=c.start.add(c.step.multiply(u)))}),this.$start.css("transform",`translate(${-On}px, ${-2.5}px) rotate(${Math.PI}rad)`),this.$end=this.makeHandle("h",p=>{let u=p.x/On/c.size;c.width=S(Math.round(u),1,100)}),c.watch(()=>this.setDimensions(c))}setDimensions({start:t,step:e,width:s,size:n,minor:o}){let r=`${t}:${e}:${s}:${n}:${o}`;if(r===this.options)return;this.options=r,this.$labels.removeChildren(),n*=On;let a=`M0 10L${s*n} 10`;for(let l=0;l<=s*o;l+=1){let c=l*n/o,p=!(l%o);if(a+=`M${c} ${p?0:5}L${c} ${p?20:15}`,p){let u=t.add(e.multiply(l/o)).toString();if(u.includes("/")){let f=h("g",{},this.$labels),g=h("g",{class:"equation"},f),w=new Ee(g,void 0,0,"",18,!1);w.setValue(u),g.css("transform",`translate(${c-w.root.width/2}px, ${35-w.root.height/2}px)`)}else h("text",{text:u,class:"number-line-label",x:c,y:40},this.$labels)}}this.$lines.setAttr("d",a),this.$end.setTransform({x:s*n,y:-2.5}),this.linePoints=B(l=>new d(l*n/o,10),s*o+1),this.line=new st(new d(0,10),new d(s*n,10)),this.path=new x(new d(0,-2.5),s*n,25),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update()}getSnapPoints(){return this.linePoints}getSnapLines(){return[this.line]}customTransform(){if(!b.isSafari)for(let t of this.$labels.children)t.css("transform",`rotate(${-this.rot}deg)`)}setLabels(t){super.setLabels(t),this.$labels.toggle(t!=="hidden"),this.$labels.css("transform",t==="above"?"translate(0,-49px)":"")}setColour(t){super.setColour(t),this.$lines.setAttr("stroke",E(t)),this.$labels.setAttr("fill",E(t)),this.$labels.css("color",E(t))}static makeThumbnail(t,e){let s=h("svg",{width:240,height:40},e),n="M20 10L220 10";for(let o=0;o<=10;o+=1){let r=20+o*20;n+=`M${r} 5L${r} 15`,h("text",{text:o,x:r,y:30,class:"number-line-label"},s)}h("path",{d:n,class:"number-line-ticks"},s)}};I([{type:"input",tileTypes:["number-line"],label:"Start:",get:i=>i.model.start.toString(),set:(i,t)=>t.model.start=U.fromString(i)||new U(0)},{type:"input",tileTypes:["number-line"],label:"Step:",range:[0,void 0],get:i=>i.model.step.toString(),set:(i,t)=>t.model.step=U.fromString(i)||new U(1)},{type:"input",tileTypes:["number-line"],label:"Width:",value:"number",range:[1,25],advanced:!0,get:i=>i.model.size,set:(i,t)=>t.model.size=Math.round(+i)},{type:"input",tileTypes:["number-line"],label:"Divisions:",value:"number",range:[1,25],advanced:!0,get:i=>i.model.minor,set:(i,t)=>t.model.minor=Math.round(+i)},{type:"select",tileTypes:["number-line"],options:[{key:"below",label:"Below"},{key:"above",label:"Above"},{key:"hidden",label:"None"}],advanced:!0,label:"Labels:",icon:"numbers",get:i=>i.labels||"below",set:(i,t)=>t.setLabels(i||"below")}]);var j2=20,U2=25,Z2=500,Kf=new M(new d(-4,0),new d(3,4),new d(3,-4)),mh=class extends T{constructor(t,e,s){super(e,s);this.type="multi-jump";this.canRotate=!1;this.$selectionArea=h("rect",{fill:"transparent"},this.$el),this.$line=h("path",{fill:"none",class:"number-line-ticks"},this.$el),this.$arrows=h("path",{class:"number-line-ticks"},this.$el),this.$sizeHandle=this.makeHandle("c",r=>{var l;r=this.worldPosn(new d(r.x,0));let a=(l=this.$parent.snapping.snap([r]))==null?void 0:l.shift;this.update(this.relativePosn(a?r.add(a):r).x,this.jumps)}),this.$jumpsHandle=this.makeHandle("c",r=>{this.update(this.jumpSize,r.x/this.jumpSize)});let[n,o]=t.split(":");this.setColour(m.yellow),this.update(+n,+o)}update(t,e){t=this.jumpSize=S(Math.round(t),U2,Z2),e=this.jumps=S(Math.round(e),1,j2);let s=`${t}:${e}`;if(s===this.options)return;this.options=s;let n=t>=150?100:.4*t+40,o=new d(-t/4,-n).unitVector.scale(12),r="",a="";for(let c=0;c<e;c++){let p=c*t,u=new d(p+t,0).add(o);r+=`M${p},0 C${p+t/4},${-n} ${p+3/4*t},${-n} ${u.x},${u.y}`,a+=Bt(new H(new d(p,0),3)),a+=Bt(Kf.rotate(o.angle()).shift(p+t,0).translate(o))}this.$line.setAttr("d",r),this.$arrows.setAttr("d",a);let l=.8*n;this.path=new x(new d(0,-l),e*t,l),this.$selectionArea.setRect(this.path),this.$sizeHandle.setCenter({x:t,y:0}),this.$jumpsHandle.setCenter({x:e*t,y:0}),this.setColour(this.colour),this.transform(),this.$parent.selection.update()}getSnapPoints(){return B(t=>new d(t*this.jumpSize,0),this.jumps+1)}setColour(t){super.setColour(t),this.$line.setAttr("stroke",E(this.colour)),this.$arrows.setAttr("stroke",E(this.colour)),this.$arrows.setAttr("fill",E(this.colour))}static makeThumbnail(t,e){let s=h("svg",{width:200,height:50,viewBox:"-6 -44 200 50"},e),n=64,o=50,r=new d(-n/4,-o).unitVector.scale(9),a="",l="";for(let c=0;c<3;c++){let p=c*n,u=new d(p+n,0).add(r);a+=`M${p},0 C${p+n/4},${-o} ${p+3/4*n},${-o} ${u.x},${u.y}`,l+=Bt(new H(new d(p,0),2)),l+=Bt(Kf.scale(.6).rotate(r.angle()).shift(p+n,0).translate(r))}h("path",{d:a,fill:"none",stroke:m.yellow,"stroke-width":2.4},s),h("path",{d:l,fill:m.yellow,stroke:m.yellow,"stroke-width":2.4},s)}};var Ut=50,Ci=[m.yellow,"#f15e19","#e1343b",m.red,"#8d2ca1","#4e53d0",m.blue,"#0595bf","#0ba27b",m.green,"#7dc410","#ebc000"];function rs(...i){if(!!b.isSafari){for(let t of i)t==null||t.css("transform-box","view-box");setTimeout(()=>{for(let t of i)t==null||t.css("transform-box","fill-box")})}}function W2(i,t){return i==="fraction"?`"1"/"${t}"`:i==="decimal"?`"${Kt(1/t,2)}"`:`"${Kt(1/t*100,1)}%"`}function rr(i,t,e,s,n,o=1){let r=h("g",{class:"fraction"},n);if(i!=="fraction"&&t>12)return r;let a=t>24?10:t>20?12:t>16?14:18,l=h("g",{style:`font-size: ${a}px`,class:"equation"},r),c=new Ee(l,void 0,0,"",a,!0);c.setValue(W2(i||"fraction",t));let p=c.root.width*o/2,u=c.root.height*o/2;return l.css("transform",`translate(${e-p}px, ${s-u}px)`+(o!==1?` scale(${o})`:"")),r}function Xf(i,t,e,s,n,o,r,a="fraction",l=1){let c=h("rect",{x:i,y:t,width:e,height:s,fill:r,class:"polygon-tile"},o);return a==="hidden"?[c]:[c,rr(a,n,i+e/2,t+s/2,o,l)]}var zs=class extends T{constructor(t,e,s){super(e,s);this.type="fraction-bar";this.count=0;this.$parts=[];this.options=t;let[n,o,r]=t.split(":").map(a=>+a);this.denominator=n,this.tileWidth=10*Ut/n,this.$fraction=h("g",{},this.$el),this.$outline=h("path",{class:"outline"},this.$el),this.$handle=this.makeHandle("h",a=>this.setCount(Math.round((a.x+Ut/2)/this.tileWidth))),this.$dark=this.makeHandle("h",a=>this.setCount(this.count,Math.round((a.x+Ut/2)/this.tileWidth))),this.setCount(o,r!=null?r:o),this.setColour(Ci[(n-1)%Ci.length])}setCount(t,e){t=S(t,1,40),e=S(e!=null?e:this.dark===this.count?t:this.dark,0,t),!(t===this.count&&e===this.dark)&&(this.count=t,this.dark=e,this.value=e/this.denominator,this.options=`${this.denominator}:${t}:${e}`,this.draw(),this.path=new x(new d(-Ut/2,-Ut/2),t*this.tileWidth,Ut),this.$outline.draw(this.path),this.$handle.setTransform(new d(t*this.tileWidth-Ut/2,-Ut/2)),this.$dark.setTransform(new d(this.dark*this.tileWidth-Ut/2,Ut/2)),this.$dark.setAttr("d",`M0 0V20L${this.dark?-20:20} 0Z`),this.transform(),this.$parent.selection.update())}setLabels(t){super.setLabels(t),this.draw()}select(){super.select(),rs(...this.$parts.map(t=>t[1]))}deselect(){super.deselect(),rs(...this.$parts.map(t=>t[1]))}setColour(t){super.setColour(t);let e=E(t),s=F.mix("#fff",e,.8).hex;for(let[n,o]of this.$parts.entries())o[0].setAttr("fill",n<this.dark?e:s);this.$fraction.css("color",F.from(e).brightness<220?"#fff":"#000")}draw(){this.$fraction.removeChildren(),this.$parts=[];let t=F.mix("#fff",this.colour,.8).hex;for(let e=0;e<this.count;e+=1){let s=e<this.dark?this.colour:t;this.$parts.push(Xf(e*this.tileWidth-Ut/2,-Ut/2,this.tileWidth,Ut,this.denominator,this.$fraction,s,this.labels))}this.customTransform(),rs(...this.$parts.map(e=>e[1]))}customTransform(){var t;for(let e of this.$parts)(t=e[1])==null||t.css("transform",`rotate(${-this.rot}deg)`)}static makeThumbnail(t,e){let[s,n]=t.split(":").map(l=>+l),o=h("svg",{width:222,height:24},e),r=Ci[s-1],a=220/s;e.onAttr("data-labels",l=>{o.removeChildren();let c=l!=="fraction"&&s>10?.44:.5;for(let p=0;p<n;++p)Xf(1+p*a,1,a,22,s,o,r,l,c)})}changeDenominator(t){for(let e=this.denominator+t;t>0?e<=32:e>=1;e+=t){let s=Math.round(this.count/this.denominator*e);if(!P(s,this.count/this.denominator*e))continue;let n=Math.round(this.dark/this.denominator*e);if(!!P(n,this.dark/this.denominator*e)){this.denominator=e,this.tileWidth=10*Ut/e,this.setCount(s,n),this.setColour(Ci[(e-1)%Ci.length]);return}}}getSnapPoints(){let t=[];for(let e=0;e<=this.count;e+=1)t.push(new d(e*this.tileWidth-Ut/2,-Ut/2)),t.push(new d(e*this.tileWidth-Ut/2,Ut/2));return t}split(){if(this.count===1)return[];let t=B(e=>{let s=this.posn.shift(e*this.tileWidth,0).rotate(Z(this.rot),this.posn),n=new zs(`${this.denominator}:${1}`,this.$parent);return n.setTransform(s,this.rot),n.setColour(this.colour),n.setLabels(this.labels),n},this.count);return this.$parent.selection.select(t),this.delete(),t}};I([{type:"button",tileTypes:["fraction-bar"],label:"Merge tiles",show:i=>i.length>1&&i.every(t=>t.denominator===i[0].denominator),click:(i,t)=>{let e=Math.min(...i.map(a=>a.posn.x)),s=Math.min(...i.map(a=>a.posn.y)),n=i.map(a=>a.count),o=q(n),r=new zs(`${i[0].denominator}:${o}`,i[0].$parent);r.setColour(F.mixMany(i.map(a=>F.from(a.colour)),n).hex),r.setTransform(new d(e,s),i[0].rot),r.setLabels(i[0].labels);for(let a of i)a.delete();t.selection.add(r),t.change({added:[r],deleted:i})}},{type:"button",tileTypes:["fraction-bar"],label:"Split tiles",show:i=>i.some(t=>t.count>1),click:(i,t)=>{let e=[];for(let n of i)e.push(...n.split());let s=i.filter(n=>n.count>1);t.change({added:e,deleted:s})}},{type:"button",tileTypes:["fraction-bar"],label:"Rename",icon:"fraction-up",click:(i,t)=>{for(let e of i)e.changeDenominator(1);t.change({changed:i})}},{type:"button",tileTypes:["fraction-bar"],label:"Rename",icon:"fraction-down",click:(i,t)=>{for(let e of i)e.changeDenominator(-1);t.change({changed:i})}}]);I([{type:"select",tileTypes:["fraction-bar","fraction-circle"],advanced:!0,label:"Labels:",options:[{key:"fraction",label:"Fractions"},{key:"percentage",label:"Percentage"},{key:"decimal",label:"Decimal"},{key:"hidden",label:"None"}],get:i=>i.labels||"fraction",set:(i,t)=>t.setLabels(i)}]);var gh=100,vh=class extends T{constructor(t,e,s){super(e,s);this.type="fraction-circle";this.rotateAroundOrigin=!0;this.options=t;let n={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=h("path",n,this.$el),this.$outline=h("path",{class:"outline",path:this.path},this.$el);let o=this.denominator=+t;if(this.value=1/o,o>1){let r=new d(0,-gh).rotate(-Math.PI/o),a=this.path=new Ie($,r,D/o);this.snapAngles=[0,_t(mi(r)),_t(mi(a.end))]}else this.path=new H($,gh);this.$path.draw(this.path),this.$outline.draw(this.path),this.draw(),o===1&&this.setOrder("back"),this.setColour(Ci[o-1]),this.$path.setAttr("fill",this.colour)}setLabels(t){super.setLabels(t),this.draw()}draw(){var e;if((e=this.$label)==null||e.remove(),this.denominator===1||this.labels==="hidden")return;let t=2-gh/2-(this.denominator-2)*3;this.$label=rr(this.labels||"fraction",this.denominator,0,t,this.$el),this.customTransform(),rs(this.$label)}customTransform(){var t;(t=this.$label)==null||t.css("transform",`rotate(${-this.rot}deg)`)}select(){super.select(),rs(this.$label)}deselect(){super.deselect(),rs(this.$label)}setColour(t){super.setColour(t),this.$path.setAttr("fill",E(t)),this.$el.css("color",F.from(E(t)).brightness<220?"#fff":"#000")}static makeThumbnail(t,e){let s=+t,n=h("svg",{width:80,height:44},e),o=h("path",{class:"polygon-tile"},n),r=new d(40,2).rotate(-Math.PI/s,new d(40,42)),a=s>1?new Ie(new d(40,42),r,D/s):new H(new d(40,22),20);if(o.draw(a),o.setAttr("fill",Ci[s-1]),s===1)return;let l;e.onAttr("data-labels",c=>{l==null||l.remove();let p=26-(c==="fraction"?1.2:1.4)*s;c!=="hidden"&&(l=rr(c,s,40,p,n,.6-s/80))})}};var hi=25;function wh(i,t,e,s,n){return new M(new d(-n,-n),new d(-n,i),new d(n,i),new d(n,-n),new d(t,-n),new d(t,n),new d(n,n),new d(n,e),new d(-n,e),new d(-n,n),new d(s,n),new d(s,-n))}var yh=class extends T{constructor(t,e,s){super(e,s);this.type="grid";this.showSelectionOutline=!0;this.canDragToSelect=!1;this.options=t,this.dimensions=new d,this.$axes=B(()=>h("line",{class:"grid-axis",stroke:"#777"},this.$el),2),this.$fill=h("path",{fill:"transparent"},this.$el),this.$handles=[0,1].map(o=>this.makeHandle("c",r=>{let a=o?this.dimensions.x:Math.round(r.x/hi-1),l=o?Math.round(r.y/hi-1):this.dimensions.y;this.setDimensions(a,l)})),this.$handles[1].css("cursor","ns-resize");let n=t.split(":");this.setDimensions(+n[0],+n[1])}setDimensions(t,e){t=S(t,1,100),e=S(e,1,100),!(t===this.dimensions.x&&e===this.dimensions.y)&&(this.dimensions=new d(t,e),this.options=`${t}:${e}`,this.path=wh(-1.5,t+1,e+1,-1.5,.5).scale(hi),this.$axes[0].setLine({x:-1.5*hi,y:0},{x:(t+1)*hi,y:0}),this.$axes[1].setLine({x:0,y:-1.5*hi},{x:0,y:(e+1)*hi}),this.$handles[0].setCenter({x:(t+1)*hi,y:0}),this.$handles[1].setCenter({x:0,y:(e+1)*hi}),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update())}setColour(t){this.colour=t;for(let e of this.$axes)e.setAttr("stroke",E(t))}static makeThumbnail(t,e){let s=h("svg",{width:80,height:80},e);h("line",{x1:20,y1:0,x2:20,y2:80,stroke:"white","stroke-width":2},s),h("line",{x1:0,y1:20,x2:80,y2:20,stroke:"white","stroke-width":2},s)}};function bh(i,t){var n,o,r;if(t.value!==void 0)return["",t.value,0,t.value,0];if(t.is("algebra-tile")){let a=t.options.startsWith("-")?-1:1,l=a<0?t.options.slice(1):t.options,c=(n=i.tileWeights.get("x"))!=null?n:5,p=(o=i.tileWeights.get("y"))!=null?o:4;switch(l){case"1":return["",a,0,a,0];case"x":return["x",a,0,a*c,c];case"x2":return["x",0,a,a*c*c,c];case"y":return["y",a,0,a*p,p];case"y2":return["y",0,a,a*p*p,p];case"xy":return["x",a*p,0,a*p*c,c]}}let e=btoa(t.type+t.options+t.colour).replace(/=/g,""),s=(r=i.tileWeights.get(e))!=null?r:1;return[e,1,0,s,s]}function K2(i,t,e){let s={},n=0,o=(f,g=1)=>{let[w,v,y,C,k]=bh(i,f);n+=g*C,!!w&&(s[w]||(s[w]=[0,0,0]),s[w][0]+=g*v,s[w][1]+=g*y,s[w][2]=k)};for(let f of t)o(f,1);for(let f of e)o(f,-1);if(P(n,0))return;let r=Object.keys(s).filter(f=>s[f][0]||s[f][1]),a=r.filter(f=>!i.tileWeights.has(f))[0]||_(r);if(!a)return!0;let[l,c,p]=s[a],u=P(c,0)?p-n/l:Math.max(...Nr(c,l,n-l*p-c*p*p));i.tileWeights.set(a,u),i.options.tileWeights=Array.from(i.tileWeights.entries()).map(f=>f.join("=")).join(",")}function Yf(i,t){i.tileWeights.clear();for(let e of t.split(",")){let[s,n]=e.split("=");s&&i.tileWeights.set(s,+n||0)}}var Qf="M0,26A18.1,18.1,0,0,0-18,44V72H18V44A18.1,18.1,0,0,0,0,26Z",Jf=["text","grid","number-line","spinner","decimal-grid","axes","custom-spinner","ruler","protractor","compass","geo","dot-machine","abacus","balance","chess-board","multi-jump","set-triangle","bucket","table","number-grid","ten-frame","chart","pie-chart","box-whisker"],Ln=15,Wt=40,tm=180;function ar(i){let t=i/2;return`M${t},0C${t},16,66.3,20,0,20S${-t},16${-t},0Z`}function em(i,t){var s;let e=i.posn.shift(0,t);i.$el.setTransform(e,Z(i.rot)),i.transformed=(s=i.path)==null?void 0:s.rotate(i.rot).translate(e)}var $h=class extends T{constructor(t,e,s){super(e,s);this.type="balance";this.canRotate=!1;this.canDragToSelect=!0;this.level=0;this.left=[];this.right=[];this.isAnimating=!1;let[n,o]=t.split(":");this.level=+n||0,this.plateSize=+o||240,this.$beam=h("path",{class:"balance-beam"},this.$el),this.$left=h("path",{class:"balance"},this.$el),this.$right=h("path",{class:"balance"},this.$el),this.$base=h("path",{d:Qf,class:"balance"},this.$el),this.$leftRect=h("rect",{class:"balance-target"},this.$el),this.$rightRect=h("rect",{class:"balance-target"},this.$el),this.$handle=this.makeHandle("c",a=>{this.plateSize=S(ht(a.x-Wt,20),120,800),this.options=`${this.level}:${this.plateSize}`,this.resize(),this.draw(),this.transform()},void 0,()=>this.showTargets(),()=>this.hideTargets()),this.setColour("#bbb"),this.customTransform(),this.resize(),this.draw();let r=[];this.onMoveStart=()=>{r=Array.from(e.selection.tiles).filter(a=>!Jf.includes(a.type)),this.isActive&&this.showTargets()},this.onMove=()=>{if(this.isActive||!r.length)return;for(let c of r)c.transform();let[a,l]=this.checkTileOverlaps(r);this.$leftRect.toggle(!!a.length),this.$rightRect.toggle(!!l.length)},this.onMoveEnd=()=>{this.hideTargets(),r=[]},this.onChange=a=>{a.action==="change"&&([this.left,this.right]=this.checkTileOverlaps(this.$parent.tiles.values()),this.rebalance(400,a))},e.on("move-start",this.onMoveStart),e.on("move-selection",this.onMove),e.on("move-end",this.onMoveEnd),setTimeout(()=>e.on("change",this.onChange))}delete(){this.$parent.off("move-start",this.onMoveStart),this.$parent.off("move-selection",this.onMove),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}showTargets(){this.$leftRect.show(),this.$rightRect.show()}hideTargets(){this.$leftRect.hide(),this.$rightRect.hide()}targetAreas(){let t=new x(new d(0,-tm),this.plateSize,tm),e=t.shift(-this.plateSize-Wt,this.level*Ln),s=t.shift(Wt,-this.level*Ln);return[e,s]}checkTileOverlaps(t){let[e,s]=this.targetAreas().map(r=>r.translate(this.posn)),n=[],o=[];for(let r of t)!r.transformed||r.type==="balance"||Jf.includes(r.type)||(Rs(e,r.transformed)?n.push(r):Rs(s,r.transformed)&&o.push(r));return[n,o]}resize(){this.$left.setAttr("d",ar(this.plateSize)),this.$right.setAttr("d",ar(this.plateSize))}draw(t=this.level){let e=this.plateSize/2+Wt,s=new d(-e,t*15),n=new d(e,-t*15);this.$beam.draw(new se(s.shift(0,10),s.shift(0,44),n.shift(0,44),n.shift(0,10))),this.$left.setTransform(s),this.$right.setTransform(n),this.$handle.setCenter({x:this.plateSize+Wt,y:-t*15});let[o,r]=this.targetAreas();this.$leftRect.setRect(o),this.$rightRect.setRect(r)}rebalance(t=400,e){return R(this,null,function*(){let s=q(this.left.map(l=>bh(this.$parent,l)[3])),n=q(this.right.map(l=>bh(this.$parent,l)[3])),o=P(s,n)?0:s<n?-1:1;if(o===this.level||this.isAnimating)return;let r=this.level,a=(o-r)*Ln;this.level=o;for(let l of this.left)l.setTransform(l.posn.shift(0,a));for(let l of this.right)l.setTransform(l.posn.shift(0,-a));if(e==null?void 0:e.data){let l=e.data.changed=e.data.changed||[],c=[...e.data.added||[],...e.data.deleted||[]];for(let p of[this,...this.left,...this.right])!l.includes(p)&&!c.includes(p)&&l.push(p)}this.options=`${o}:${this.plateSize}`,this.isAnimating=!0,yield X(l=>{this.draw(bt(r,o,l));for(let c of this.left)em(c,(l-1)*a);for(let c of this.right)em(c,(1-l)*a);this.$parent.selection.update()},t).promise,this.isAnimating=!1,this.transform(),this.$parent.selection.update()})}customTransform(){let t=this.level*Ln,e=this.plateSize+Wt;this.path=new M(new d(-e,t),new d(-Wt,t),new d(-Wt,25),new d(Wt,25),new d(Wt,-t),new d(e,-t),new d(e,-t+48),new d(Wt,-t+48),new d(Wt,72),new d(-Wt,72),new d(-Wt,t+48),new d(-e,t+48))}getSnapPoints(){let t=this.level*Ln,e=this.plateSize+Wt;return[new d(-e,t),new d(-Wt,t),new d(Wt,-t),new d(e,-t)]}getSnapLines(){let[t,e,s,n]=this.getSnapPoints();return[new st(t,e),new st(s,n)]}setColour(t){this.colour=t,this.$beam.css("stroke",t);for(let e of[this.$base,this.$left,this.$right])e.css("fill",E(t))}balance(){if(K2(this.$parent,this.left,this.right))return No("balance-error");let e=new Set;for(let s of this.$parent.getTilesOfType("balance")){s.rebalance();for(let n of[s,...s.left,...s.right])e.add(n)}}static makeThumbnail(t,e){let s=h("svg",{width:250,height:50,viewBox:"-290 -10 580 82",class:"scale"},e);h("path",{d:"M-160 10v34h320v-34",fill:"transparent",stroke:"#bbb","stroke-width":10},s),h("path",{d:ar(240),transform:"translate(-160 0)",fill:"#bbb"},s),h("path",{d:ar(240),transform:"translate(160 0)",fill:"#bbb"},s),h("path",{d:Qf,fill:"#bbb"},s)}};I([{type:"button",tileTypes:["balance"],label:"Balance",show:i=>i.length===1&&!!i[0].level,click:(i,t)=>{i[0].balance(),t.change({changed:i})}}]);var xh={circle:"M -25 0a25,25 0 1 0 50 0a25 25 0 1 0 -50 0",square:"M0 -25L25 0L0 25L-25 0Z",cross:"M25 -9L9 -9L9 -25L-9 -25L-9 -9L-25 -9L-25 9L-9 9L-9 25L9 25L9 9L25 9L25 -9Z",weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1ZM0-11a4,4,0,0,1-4-4,4,4,0,0,1,4-4,4,4,0,0,1,4,4A4,4,0,0,1,0-11Z",star:"M0 15.7L15.5 23.8L12.5 6.6L25 -5.6L7.7 -8.1L0 -23.8L-7.7 -8.1L-25 -5.6L-12.5 6.6L-15.5 23.8L0 15.7Z",heart:"M3.4,20.8a4.9,4.9,0,0,1-6.7-.1l-.3-.2C-16.7,8.6-25.3.8-25-8.9a13.7,13.7,0,0,1,5.9-10.7A14.4,14.4,0,0,1,0-16.8a14.4,14.4,0,0,1,19.1-2.8A13.7,13.7,0,0,1,25-8.9C25.3.8,16.7,8.6,3.6,20.5Z"},X2={weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1Z"},im={circle:m.orange,square:m.purple,cross:m.green,weight:m.blue,star:m.yellow,heart:m.red},Ph=class extends K{constructor(t,e,s){super("square",e,s);this.type="token";this.options=t,this.$path.setAttr("d",xh[t]),this.$outline.setAttr("d",X2[t]||xh[t]),this.setColour(im[t])}static makeThumbnail(t,e){let s=h("svg",{width:36,height:36},e),n=h("path",{d:xh[t],class:"polygon-tile"},s);n.setTransform({x:18,y:18},0,.6),n.setAttr("fill",im[t])}};var Y2=["x","y","\u03B8","r"];function Fs(i){if(i instanceof Zt&&i.fn==="="){let[t,e]=i.args;if(t instanceof Ms&&!Y2.includes(t.i))return[t.i,e]}return[void 0,i]}var Sh=class{constructor(){this.assignments=new Map;this.callbackDeps=new Map;this.updatedNames=new Set}findFirstAssigner(t){var e;return(e=this.assignments.get(t))==null?void 0:e.keys().next().value}findDependants(t,e=[]){let s=[];for(let[o,r]of this.assignments.entries())r.size===1&&o!==t&&!e.includes(o)&&Zn(r.values()).unknowns.filter(l=>!e.includes(l)).includes(t)&&s.push(o);let n=[...hs(s,o=>this.findDependants(o,s))];return s.concat(n)}validate(t){let e=new Set,s=(n,o=[])=>{if(!this.assignments.has(n)){e.add(n);return}if(o.includes(n))return{message:`The variable <em>${n}</em> is defined recursively.`,locations:o.splice(o.indexOf(n)).map(a=>this.findFirstAssigner(a))};let r=this.assignments.get(n);if(r.size===1){let a=Zn(r.values());for(let l of a.unknowns){let c=s(l,[...o,n]);if(c)return c}}else return{message:`You have defined <em>${n}</em> in multiple places.`,locations:Array.from(r.keys())}};for(let n of t.unknowns){let o=s(n);if(o)return{error:o,dependsOn:[],unknowns:[]}}return{dependsOn:[],unknowns:Array.from(e)}}evaluate(t){let{error:e,unknowns:s}=this.validate(t);if(e||s.length)return{error:e,value:NaN};try{return{value:t.evaluate(this.evalContext)}}catch(n){return{value:NaN}}}get evalContext(){let t={};for(let[e,s]of this.assignments.entries())s.size===1&&(t[e]=Zn(s.values()));return t}get serializedEvalContext(){let t={};for(let[e,s]of Object.entries(this.evalContext))t[e]=s.toString();return t}substituteAssignments(t){let[e,s]=Fs(t);return e?new Zt("=",[new Ms(e),s.recursiveSubstitute(this.evalContext)]):t.recursiveSubstitute(this.evalContext)}markUpdated(t){this.updatedNames.add(t);for(let e of this.findDependants(t))this.updatedNames.add(e)}flushChanges(){for(let[e,s]of this.callbackDeps.entries())s.some(n=>this.updatedNames.has(n))&&e();let t=Array.from(this.updatedNames);return this.updatedNames.clear(),t}updateSource(t,e,s,n=!0){this.removeSource(t,!1),this.assignments.has(e)||this.assignments.set(e,new Map),this.assignments.get(e).set(t,s),this.markUpdated(e),n&&this.flushChanges()}attemptUpdateSource(t,e,s=!0){if(typeof e=="string")try{e=kt.parse(e).collapse()}catch(r){return}let[n,o]=Fs(e);return n?this.updateSource(t,n,o,s):this.removeSource(t),o}removeSource(t,e=!0){for(let[s,n]of this.assignments.entries())n.has(t)&&this.markUpdated(s),n.delete(t),n.size===0&&this.assignments.delete(s);e&&this.flushChanges()}watch(t,e,s=!1){this.callbackDeps.set(e,t),s&&e()}unwatch(t){t&&this.callbackDeps.delete(t)}};var Vt=50;function sm(i,t){for(let e of i)if(t(e))return e}var nm=class{constructor(t){this.promises=new Map;this.latestPromises=new Map;this.worker=new Worker(t),this.worker.onmessage=e=>{if(!e.data)return;let s=e.data[0],n=this.promises.get(e.data[0]);this.promises.delete(s),!(!n||this.latestPromises.get(n[0])!==s)&&n[1](e.data[1])}}draw(t,e,s,{xMin:n,xMax:o,yMin:r,yMax:a},[l,c]){let p=ci();return this.latestPromises.set(t,p),this.worker.postMessage(["plot",e,s,p,n,o,l,r,a,c,Vt]),new Promise(u=>this.promises.set(p,[t,u]))}},Th,Ch=class extends T{constructor(t,e,s){super(e,s);this.type="axes";this.showSelectionOutline=!0;this.canDragToSelect=!1;this.functions=new Map;this.scatterPlots=new Map;this.steps=[1,1];this.watchers=new Map;this.$fill=h("path",{fill:"transparent"},this.$el),this.$grid=h("path",{class:"axis-gridlines"},this.$el),this.$content=h("g",{},this.$el),this.$axes=h("path",{class:"grid-axis"},this.$el),this.$labels=h("g",{class:"axis-labels"},this.$el),this.$scatter=h("g",{},this.$el),this.$outline=h("rect",{class:"outline active",hidden:!0},this.$el),this.setColour(m.darkGrey),this.watchPolypadOptions(u=>this.$grid.toggle(u.grid==="none"));let[n,o,r,a,l,c]=t.split(":"),p=this.model=mt({xMin:+n,xMax:+r,xStep:o,yMin:+a,yMax:+c,yStep:l});this.$handles=[this.makeHandle("c",u=>p.xMin=S(Math.round(u.x/Vt),-20,0)),this.makeHandle("c",u=>p.xMax=S(Math.round(u.x/Vt),0,20)),this.makeHandle("c",u=>p.yMin=S(Math.round(-u.y/Vt),-20,0)),this.makeHandle("c",u=>p.yMax=S(Math.round(-u.y/Vt),0,20))];for(let u of[2,3])this.$handles[u].css("cursor","ns-resize");e.events.listen(this.$el,{click:u=>this.setAndDrawFocus(u),blurInput:!1,checkIfActive:()=>this.$focusSource!==void 0}),this.makeInPort("main",{connect:u=>{u.from.tile.is("equation")?this.functions.set(u,h("path",{class:"geo-path"},this.$content)):u.from.tile.is("table")&&this.scatterPlots.set(u,[h("g",{},this.$scatter),[]])},message:(u,f)=>{if(f.from.tile.is("equation")){let g=this.functions.get(f);g.css("color",E(f.from.tile.colour)),this.drawEquation(f.from.tile,g)}else if(u.type==="table"){let g=this.scatterPlots.get(f),w=f.from.tile.colour==="#bbb"?"#666":f.from.tile.colour;g[0].setAttr("fill",E(w)),g[1]=u.table,this.drawScatterPoints(g[0],u.table)}},disconnect:u=>{var f,g;u.from.tile.is("equation")?((f=this.functions.get(u))==null||f.remove(),this.functions.delete(u),this.$parent.mathContext.unwatch(this.watchers.get(u.from.tile))):u.from.tile.is("table")&&((g=this.scatterPlots.get(u))==null||g[0].remove(),this.scatterPlots.delete(u))},tileTypes:["table","equation"]}),p.watch(()=>this.setSizes(p))}highlight(t=!0){var e;(e=this.$outline)==null||e.toggle(t)}setSizes({xMin:t,xMax:e,yMin:s,yMax:n,xStep:o,yStep:r}){var g;let a=`${t}:${o}:${e}:${s}:${r}:${n}`;if(a===this.options)return;this.options=a;let l=Vt;this.$handles[0].setCenter({x:t*l,y:0}),this.$handles[1].setCenter({x:e*l,y:0}),this.$handles[2].setCenter({x:0,y:-s*l}),this.$handles[3].setCenter({x:0,y:-n*l}),this.$labels.removeChildren();let c="",p=`M${t*l} 0L${e*l} 0M0 ${-s*l}L0 ${-n*l}`;p+=`M0 ${-n*l-3}l5 8h-10ZM${e*l+3} 0l-8 5v-10Z`;let u=U.fromString(o),f=U.fromString(r);this.steps=[(u==null?void 0:u.value)||1,(f==null?void 0:f.value)||1];for(let w=t+1;w<e;++w)!w||(p+=`M${w*l} 0L${w*l} 5`,c+=`M${w*l} ${-s*l}L${w*l} ${-n*l}`,h("text",{text:(u==null?void 0:u.multiply(w).toString())||"",x:w*l,y:21,"text-anchor":"middle"},this.$labels));for(let w=s+1;w<n;++w)!w||(p+=`M0 ${-w*l}L-5 ${-w*l}`,c+=`M${t*l} ${-w*l}L${e*l} ${-w*l}`,h("text",{text:(f==null?void 0:f.multiply(w).toString())||"",x:-10,y:-w*l+5,"text-anchor":"end"},this.$labels));this.$axes.setAttr("d",p),this.$grid.setAttr("d",c),this.$fill.draw(wh(-n*Vt,e*Vt,-s*Vt,t*Vt,15)),this.path=new x(new d(t*Vt,-n*Vt),(e-t)*Vt,(n-s)*Vt),(g=this.$outline)==null||g.setRect(this.path);for(let[w,v]of this.functions.entries())this.drawEquation(w.from.tile,v);for(let[w,v]of this.scatterPlots.values())this.drawScatterPoints(w,v);this.transform(),this.$parent.selection.update()}getSnapPoints(){let{xMin:t,xMax:e,yMin:s,yMax:n}=this.model,o=[];for(let r=t;r<=e;++r)for(let a=s;a<=n;++a)o.push(new d(r*Vt,-a*Vt));return o}getSnapLines(){let{xMin:t,xMax:e,yMin:s,yMax:n}=this.model;return[new st(new d(t*Vt,0),new d(e*Vt,0)),new st(new d(0,-s*Vt),new d(0,-n*Vt))]}setColour(t){var e;if(this.$focusSource)this.$focusSource.from.tile.setColour(t),(e=this.$focusShadow)==null||e.css("stroke",E(this.colour)),this.$parent.change({changed:[this.$focusSource.from.tile]});else{super.setColour(t.slice(0,7));for(let s of[this.$axes,this.$labels])s.setAttr("fill",E(this.colour));for(let s of[this.$axes,this.$grid])s.setAttr("stroke",E(this.colour))}}getX(t){return t/this.steps[0]*Vt}getY(t){return t/this.steps[1]*Vt}drawEquation(t,e){let s=kt.parse(t.options).collapse(),n=this.$parent.mathContext;n.unwatch(this.watchers.get(t));let o=()=>R(this,null,function*(){let[r,a]=Fs(s),{error:l,unknowns:c}=n.validate(a);if(this.showErrorIcon(l),l)e.setAttr("d","");else if(c.length>2)this.showErrorIcon({message:"An equation has too many degrees of freedom.",locations:[t]}),e.setAttr("d","");else{Th||(Th=new nm(this.$parent.attr("worker")));let p=yield Th.draw(t,s.toString(),n.serializedEvalContext,this.model,this.steps);e.setAttr("d",p.startsWith("[Error]")?"":p)}});this.watchers.set(t,o),n.watch(s.unknowns,o,!0)}drawScatterPoints(t,e){let s=t.children;for(let n of s)n.hide();for(let n=1;n<e.length;++n){if(e[n].length<2)continue;let o=+e[n][0],r=+e[n][1];if(!it(o/this.steps[0],this.model.xMin,this.model.xMax,-1e-5)||!it(r/this.steps[1],this.model.yMin,this.model.yMax,-1e-5))continue;let a=s[n]||h("circle",{r:6},t);a.setAttr("cx",this.getX(o)),a.setAttr("cy",-this.getY(r)),a.show()}}select(){this.$focusSource&&this.blur(),super.select()}blur(){var t;!this.$focusSource||((t=this.$focusShadow)==null||t.hide(),this.$focusSource=void 0,super.blur())}doubleClick(t){this.setAndDrawFocus(t)}setAndDrawFocus(t){var n,o,r;let e=G(t.event.target);if(e.tagName==="CIRCLE"){let a=e.parent;this.$focusSource=(n=sm(this.scatterPlots.entries(),([l,[c]])=>a===c))==null?void 0:n[0]}else if(e.hasClass("geo-path"))this.$focusSource=(o=sm(this.functions.entries(),([a,l])=>l===e))==null?void 0:o[0];else return this.$parent.selection.add(this);this.focus(),this.$focusShadow||(this.$focusShadow=h("path",{class:"chart-shadow"})),this.$el.prepend(this.$focusShadow);let s="";if(this.$focusSource.from.tile.is("equation"))s=this.functions.get(this.$focusSource).attr("d")||"";else if(this.$focusSource.from.tile.is("table")){let a=this.scatterPlots.get(this.$focusSource)[0].children;for(let l of a)s+=Bt(new H(l.center,7))}this.$focusShadow.css("stroke",E((r=this.$focusSource)==null?void 0:r.from.tile.colour)),this.$focusShadow.setAttr("d",s),this.$focusShadow.show()}static makeThumbnail(t,e){let s=h("svg",{width:120,height:120},e);h("path",{d:"M20 4v112M40 4v112M80 4v112M100 4v112M4 20h112M4 40h112M4 80h112M4 100h112",class:"axis-gridlines",stroke:"white"},s),h("path",{d:"M5 60h112M60 4v112M60 2l4 6h-8ZM118 60l-6 4v-8Z",class:"grid-axis",fill:"white"},s)}};I([{type:"input",tileTypes:["axes"],label:"X axis:",range:[0,void 0],increment:!0,get:i=>i.model.xStep,set:(i,t)=>{var e;return t.model.xStep=((e=U.fromString(i))==null?void 0:e.clamp(.01).toString())||"1"}},{type:"input",tileTypes:["axes"],label:"Y axis:",range:[0,void 0],increment:!0,get:i=>i.model.yStep,set:(i,t)=>{var e;return t.model.yStep=((e=U.fromString(i))==null?void 0:e.clamp(.01).toString())||"1"}}]);var lr=200,hr=75,je=20,Q2='<tspan style="font-style:italic"></tspan> &nbsp;=&nbsp; <tspan></tspan>',om="M8,6.8V17.2a.9.9,0,0,0,1.5.8l8.2-5.2a1,1,0,0,0,0-1.7L9.5,6A1,1,0,0,0,8,6.8Z",J2="M8 19a2 2 0 0 0 2-2v-10a2 2 0 0 0 -2-2 2 2 0 0 0 -2 2v10a2 2 0 0 0 2 2zm6-12v10a2 2 0 0 0 2 2 2 2 0 0 0 2-2v-10a2 2 0 0 0 -2-2 2 2 0 0 0 -2 2z";function tw(i,t,e){let s=(Date.now()-i)/1e3;if(e==="once")return s/t;if(e==="loop")return s/t%1;let n=s/(t*2)%1;return n<.5?n*2:1-(n-.5)*2}var Mh=class extends T{constructor(t,e,s){super(e,s);this.type="slider";this.path=new x($,lr,hr);this.options=t,this.$body=h("rect",{class:"polygon-tile",rx:10},this.$el),this.$outline=h("rect",{class:"outline",rx:10},this.$el),this.$body.setRect(this.path),this.$outline.setRect(this.path),this.$expr=h("text",{x:je,y:30,html:Q2},this.$el),[this.$exprName,this.$exprValue]=this.$expr.$$("tspan"),this.$bar=h("line",{x1:je,x2:lr-je,y1:hr-je,y2:hr-je,opacity:.5,style:"stroke-width: 4"},this.$el);let n=h("g",{transform:"translate(162 12)",style:"cursor: pointer"},this.$el);h("rect",{x:-4,y:-4,width:32,height:32,fill:"transparent"},n),this.$playIcon=h("path",{d:om},n),e.events.listen(n,{click:()=>this.play()}),this.$handle=this.makeHandle("c",f=>{let g=bt(this.model.min,this.model.max,(f.x-je)/(lr-2*je));this.setValue(g),this.updateOptions()}),this.$handle.addClass("persistent");let[o,r,a,l,c,p,u]=this.options.split(":");this.variable=o,this.model=mt({name:o,min:a===void 0?-5:+a,max:l===void 0?5:+l,step:+c||.1,type:p||"bounce",duration:+u||2}),this.model.watchAll((f,g)=>{this.animation&&this.stopAnimating(),this.setValue(g?+r||0:this.value)})}play(){if(this.animation){this.stopAnimating(),this.$parent.change({changed:[this]});return}this.$playIcon.setAttr("d",J2);let{min:t,max:e,type:s,duration:n}=this.model,o=Date.now(),r=o+n*1e3;this.animation=X(()=>{let a=tw(o,n,s);this.setValue(bt(t,e,a)),s==="once"&&Date.now()>=r&&this.stopAnimating()})}stopAnimating(){var t;(t=this.animation)==null||t.cancel(),this.animation=void 0,this.$playIcon.setAttr("d",om),this.updateOptions()}delete(){this.animation&&this.stopAnimating(),super.delete()}setValue(t){if(t=S(ht(t,this.model.step),this.model.min,this.model.max),this.model.name!==this.variable)this.model.name=this.model.name.replace(/[^A-Za-z]/g,""),this.$parent.mathContext.removeSource(this),this.variable=this.model.name;else if(this.value!==void 0&&P(t,this.value))return;this.value=t;let e=bt(je,lr-je,(t-this.model.min)/(this.model.max-this.model.min));this.$handle.setTransform(new d(e,hr-je)),this.$exprName.text=this.variable,this.$exprValue.text=nt(t,5),this.$parent.mathContext.updateSource(this,this.variable,new si(t))}setColour(t){super.setColour(t);let e=E(t),s=F.from(e).brightness<180?"#fff":"#000";this.$body.setAttr("fill",e);for(let n of[this.$expr,this.$playIcon])n.setAttr("fill",s);this.$handle.css("fill",s),this.$bar.setAttr("stroke",s)}updateOptions(){this.options=[this.variable,this.value,this.model.min,this.model.max,this.model.step,this.model.type,this.model.duration].join(":")}static makeThumbnail(t,e){let n=t.split(":")[0],o=h("svg",{width:104,height:54},e);h("rect",{x:2,y:2,width:100,height:50,fill:e.data.colour,rx:5},o),h("rect",{x:10,y:40,width:84,height:3,fill:"white",rx:2,opacity:.5},o),h("circle",{cx:32,cy:41.5,r:6,fill:"white"},o),h("text",{x:52,y:28,fill:"white",style:"font-size:24;font-style:italic;text-anchor:middle",text:n},o)}};I([{type:"input",tileTypes:["slider"],label:"Name:",style:"font-style:italic",get:i=>i.model.name,set:(i,t)=>t.model.name=i},{type:"input",tileTypes:["slider"],label:"Range:",value:"number",noDivider:!0,get:i=>i.model.min,set:(i,t)=>t.model.min=+i},{type:"input",tileTypes:["slider"],label:"",value:"number",get:i=>i.model.max,set:(i,t)=>t.model.max=+i},{type:"input",tileTypes:["slider"],label:"Increment:",value:"number",advanced:!0,get:i=>i.model.step,set:(i,t)=>t.model.step=+i},{type:"input",tileTypes:["slider"],label:"Duration:",value:"number",range:[.1,10],advanced:!0,get:i=>i.model.duration,set:(i,t)=>t.model.duration=+i},{type:"select",tileTypes:["slider"],label:"Motion:",options:[{label:"Bounce",key:"bounce"},{label:"Loop",key:"loop"},{label:"Once",key:"once"}],advanced:!0,get:i=>i.model.type,set:(i,t)=>t.model.type=i}]);var rm=i=>50*Math.log(i)/Math.log(2),Eh=class extends K{constructor(t,e,s){super(gt(new x(new d(-25,-20),50,rm(+t)).points),e,s);this.type="log-bar";this.fill=m.blue;this.options=t;let n=ui(Re(+t).map(o=>rm(o)));n.pop();for(let o of n)h("line",{x1:-25,x2:25,y1:o-20,y2:o-20,class:"polygon-tile",opacity:.3},this.$el);this.$el.append(this.$outline),h("text",{text:t,class:"polygon-label",y:6},this.$el)}static makeThumbnail(t,e){e.setAttr("width",21),e.setAttr("fill",m.blue);let s=h("text",{class:"polygon-label",x:+e.attr("x")+10.5,y:+e.attr("y")+16},e.parent);e.onAttr("data-options",n=>{e.setAttr("height",Math.min(21*Math.log(+n)/Math.log(2),100)),s.text=n,s.css("font-size",+n<99?"":"11px")})}};var ue=19,Rn=[[],[[0,0]],[[-.9,-.9],[.9,.9]],[[-1,-1],[0,0],[1,1]],[[-.9,-.9],[.9,-.9],[.9,.9],[-.9,.9]],[[-1,-1],[1,-1],[1,1],[-1,1],[0,0]],[[-.9,-1.1],[-.9,0],[-.9,1.1],[.9,-1.1],[.9,0],[.9,1.1]],[[0,-1.2],[0,0],[0,1.2],[1,-.6],[1,.6],[-1,-.6],[-1,.6]],[[0,-1.1],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]],[[0,-1.1],[0,0],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]]],ew=new x(new d(-ue,-ue),2*ue,2*ue),cr=[[0,0],[0,dt],[dt,0],[-dt,0],[0,-dt],[Math.PI,0]],Ah=["#656073",m.teal,m.blue,m.purple,m.red,m.orange,m.yellow,m.lime,m.green,m.teal],$e=class extends T{constructor(t,e,s){super(e,s);this.type="dice";this.isAnimating=!1;this.options=t;let[n,o]=t.split(":");this.faces=o||"1,2,3,4,5,6";let r=this.faces.split(",").map(a=>{let l=new pe(ew,{class:"dice-face",fill:Ah[+a],stroke:Ah[+a]}),c=Rn[+a].map(p=>new pe(new H(new d(p[0]*ue/2,p[1]*ue/2),4),{class:"dice-dot"}));for(let p of c)p.transform.translate(0,0,2);return new ve([l,...c])});r[0].transform.translate(0,0,ue),r[1].transform.translate(-ue,0,0).rotate(0,-dt),r[2].transform.translate(0,ue,0).rotate(-dt,0),r[3].transform.translate(0,-ue,0).rotate(dt,0),r[4].transform.translate(ue,0,0).rotate(0,dt),r[5].transform.translate(0,0,-ue).rotate(0,Math.PI),this.die=new ve(r,{},this.$el),this.die.sorting=!0,this.setValue(+n||tt.integer(1,6)),this.path=new x(new d(-25,-25),50,50),this.$outline=h("path",{class:"outline",path:this.path},this.$el)}setColour(t){this.colour=t==="#000"||t==="#000000"?"":t.slice(0,7);for(let e of this.die.children)e.children[0].color=E(this.colour);this.die.render()}setValue(t){this.value!==t&&(this.value=t,this.options=`${t}:${this.faces}`,this.die.transform.clear().rotate(...cr[t-1]),this.die.render())}roll(t=2e3){return R(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("roll");let e=tt.integer(1,6),s=cr[this.value-1],n=4*Math.PI+cr[e-1][0]-s[0],o=4*Math.PI+cr[e-1][1]-s[1];yield X(r=>{let a=rt("sine",r);this.die.transform.clear().translate(0,0,4*a*(1-a)*ue/2).rotate(s[0]+a*n,s[1]+a*o),this.die.render()},t).promise,this.setValue(e),this.isAnimating=!1})}static makeThumbnail(t,e){if(e.data.thumb==="net"){let s=h("svg",{width:58,height:76},e),n=t.split(":")[1].split(",").map(a=>+a),o=e.data.colour,r=[new d(20,2),new d(20,20),new d(20,38),new d(20,56),new d(2,20),new d(38,20)];for(let[a,l]of r.entries()){let c=o||Ah[+n[a]];h("path",{path:new x(l,18,18),class:"polygon-tile",fill:c},s);for(let p of Rn[n[a]])h("circle",{cx:l.x+9+p[0]*4.5,cy:l.y+9+p[1]*4.5,r:1.8,class:"dice-dot"},s)}}else{let s=h("svg",{width:60,height:60},e);h("rect",{x:6,y:6,width:48,height:48,rx:6,class:"polygon-tile",fill:m.orange},s);for(let n of Rn[5])h("circle",{cx:30+n[0]*12,cy:30+n[1]*12,r:5,class:"dice-dot"},s)}}doubleClick(){$e.roll([this],this.$parent)}static roll(t,e){return R(this,null,function*(){e.selection.clear(),yield Promise.all(t.map(s=>s.roll())),e.selection.tiles.size||e.selection.select(t),e.change({changed:t})})}};I([{type:"button",tileTypes:["dice","coin","spinner","custom-spinner","polyhedral-dice","random"],label:"Randomize",labelFn:(i,t)=>Wn(t,e=>e==="coin")?"Flip":Wn(t,e=>e.endsWith("dice"))?"Roll":Wn(t,e=>e.endsWith("spinner"))?"Spin":"Randomize",click:(i,t)=>$e.roll(i,t)}]);var iw={1:"M-1.92 3.18V2.24H-0.5V-1.94H-1.67V-2.66C-1.15-2.74-0.65-2.92-0.2-3.18H0.66V2.24H1.91V3.18Z",2:"M-2.13 3.24V2.57C-1.04 1.37 0.53 0.37 0.75-1.23 0.78-2.65-0.89-2.56-1.53-1.62L-2.18-2.26C-1.23-3.5 1.07-3.69 1.72-2.09 2.36-0.32 0.62 1.1-0.44 2.33 0.43 2.26 1.3 2.24 2.18 2.26V3.24Z",3:"M-0.04 3.3C-0.86 3.34-1.65 3.01-2.2 2.4L-1.65 1.66C0.56 3.88 2.73 0.26-0.84 0.32V-0.52C2.13-0.44 0.64-3.74-1.4-1.79L-1.99-2.5C-1-3.49 1.1-3.71 1.83-2.34 2.03-1.92 2.04-1.45 1.85-1.03 1.67-0.61 1.31-0.29 0.87-0.16V-0.12C3.22 0.57 2.17 3.46-0.04 3.3Z",4:"M0.46 3.18V1.54H-2.34V0.76L0.18-3.18H1.55V0.65H2.35V1.54H1.55V3.18ZM-1.21 0.65H0.46C0.47-0.13 0.45-1.34 0.51-2.11H0.47C0.31-1.77 0.14-1.46-0.05-1.12Z",5:"M-0.03 3.24C-0.84 3.26-1.63 2.94-2.2 2.36L-1.67 1.62C-0.91 2.53 1.08 2.63 1.05 1.08 1.11-0.14-0.33-0.42-1.14 0.25L-1.69-0.1-1.5-3.24H1.9V-2.27H-0.5L-0.63-0.73C2.69-2.07 3.34 3.22-0.03 3.24Z",6:"M-0.78 3.3C-3.49 3.25-3.6-0.85-2.32-2.48-1.9-2.98-1.28-3.28-0.63-3.3 0.03-3.32 0.66-3.06 1.11-2.58L0.49-1.88C-0.96-3.24-2.1-1.59-2.02-0.01-1.71-0.43-1.23-0.7-0.72-0.75-0.2-0.8 0.32-0.63 0.71-0.28 1.85 0.94 1.02 3.38-0.78 3.3ZM-0.8 2.42C0.17 2.46 0.41 0.95-0.11 0.36-0.41 0.13-0.79 0.04-1.16 0.13-1.52 0.22-1.83 0.47-1.99 0.81-1.88 1.7-1.63 2.37-0.8 2.42ZM2.38 3.3C1.97 3.27 1.64 2.93 1.64 2.52 1.64 2.1 1.97 1.76 2.38 1.74 3.35 1.7 3.35 3.33 2.38 3.3Z",7:"M-0.89 3.18C-0.9 1.24-0.28-0.65 0.87-2.21H-2.13V-3.18H2.13V-2.48C0.84-0.89 0.17 1.13 0.28 3.18Z",8:"M0.01 3.3C-2.15 3.38-3.04 0.92-1.01-0.08V-0.12C-1.71-0.52-2.04-1.36-1.79-2.14-1.54-2.91-0.77-3.4 0.03-3.3 0.83-3.37 1.57-2.88 1.82-2.12 2.06-1.36 1.75-0.53 1.05-0.12V-0.08C3.03 0.9 2.12 3.43 0.01 3.3ZM0.03 2.48C0.38 2.52 0.72 2.36 0.91 2.06 1.11 1.77 1.13 1.39 0.96 1.08 0.57 0.68 0.08 0.38-0.46 0.24-1.49 0.87-1.34 2.51 0.02 2.48ZM0.43-0.41C1.17-1 1.18-2.49 0.02-2.48-0.3-2.49-0.59-2.33-0.75-2.06-0.9-1.79-0.91-1.46-0.75-1.19-0.46-0.81-0.04-0.54 0.42-0.41Z",9:"M-1.33 3.3C-1.97 3.31-2.59 3.05-3.03 2.58L-2.41 1.88C-0.96 3.23 0.2 1.59 0.11 0.01-0.27 0.53-0.9 0.81-1.55 0.74-2.19 0.66-2.74 0.25-2.99-0.35-3.27-0.99-3.21-1.72-2.84-2.31-2.46-2.9-1.83-3.27-1.13-3.3 2.17-3.26 1.88 3.36-1.33 3.3ZM-1.06-0.08C-0.58-0.12-0.15-0.39 0.08-0.82 0.07-1.94-0.89-2.96-1.79-2.11-2.32-1.48-2.12 0.01-1.06-0.08ZM2.41 3.3C2 3.28 1.67 2.94 1.67 2.52 1.67 2.11 2 1.76 2.41 1.74 3.38 1.71 3.38 3.33 2.41 3.3Z",10:"M-4.48 3.18V2.24H-3.06V-1.94H-4.23V-2.66C-3.71-2.74-3.21-2.92-2.76-3.18H-1.9V2.24H-0.65V3.18ZM2.27 3.3C-0.66 3.38-0.69-3.4 2.27-3.3 5.23-3.39 5.2 3.38 2.27 3.3ZM2.27 2.4C3.71 2.54 3.74-2.56 2.27-2.4 0.8-2.56 0.83 2.53 2.27 2.4Z",11:"M-4.38 3.18V2.24H-2.96V-1.94H-4.13V-2.66C-3.61-2.74-3.11-2.92-2.66-3.18H-1.8V2.24H-0.55V3.18ZM0.55 3.18V2.24H1.97V-1.94H0.8V-2.66C1.32-2.74 1.82-2.92 2.27-3.18H3.13V2.24H4.38V3.18Z",12:"M-4.43 3.24V2.3H-3.01V-1.88H-4.18V-2.6C-3.67-2.68-3.17-2.86-2.71-3.12H-1.85V2.3H-0.6V3.24ZM0.13 3.24V2.57C1.22 1.37 2.79 0.37 3.01-1.23 3.04-2.65 1.37-2.56 0.73-1.62L0.09-2.26C1.03-3.5 3.33-3.69 3.98-2.09 4.62-0.32 2.88 1.1 1.82 2.33 2.69 2.26 3.56 2.24 4.43 2.26V3.24Z",13:"M-4.41 3.18V2.24H-2.99V-1.94H-4.16V-2.66C-3.65-2.74-3.15-2.92-2.69-3.18H-1.83V2.24H-0.58V3.18ZM2.18 3.3C1.36 3.34 0.57 3.01 0.02 2.4L0.57 1.66C2.78 3.88 4.94 0.26 1.38 0.32V-0.52C4.34-0.44 2.86-3.74 0.82-1.79L0.23-2.5C1.21-3.49 3.31-3.71 4.04-2.34 4.24-1.92 4.25-1.45 4.07-1.03 3.88-0.61 3.53-0.29 3.09-0.16V-0.12C5.43 0.57 4.38 3.46 2.18 3.3Z",14:"M-4.53 3.18V2.24H-3.11V-1.94H-4.28V-2.66C-3.76-2.74-3.26-2.92-2.81-3.18H-1.95V2.24H-0.7V3.18ZM2.65 3.18V1.54H-0.16V0.76L2.36-3.18H3.73V0.65H4.53V1.54H3.73V3.18ZM0.98 0.65H2.65C2.65-0.13 2.64-1.34 2.7-2.11H2.66C2.5-1.77 2.32-1.46 2.14-1.12Z",15:"M-4.41 3.12V2.18H-2.99V-2H-4.16V-2.72C-3.65-2.8-3.15-2.98-2.69-3.24H-1.83V2.18H-0.58V3.12ZM2.19 3.24C1.37 3.26 0.59 2.94 0.02 2.36L0.55 1.62C1.3 2.53 3.29 2.63 3.27 1.08 3.33-0.14 1.88-0.42 1.07 0.25L0.52-0.1 0.71-3.24H4.11V-2.27H1.72L1.59-0.73C4.9-2.06 5.56 3.22 2.18 3.24Z",16:"M-4.47 3.18V2.24H-3.05V-1.94H-4.22V-2.66C-3.71-2.74-3.21-2.92-2.75-3.18H-1.89V2.24H-0.64V3.18ZM2.46 3.3C-0.24 3.25-0.35-0.85 0.92-2.48 1.34-2.98 1.96-3.28 2.61-3.3 3.27-3.32 3.9-3.06 4.35-2.58L3.73-1.88C2.29-3.24 1.14-1.59 1.22-0.01 1.54-0.43 2.01-0.7 2.53-0.75 3.05-0.8 3.56-0.63 3.95-0.28 5.09 0.94 4.26 3.39 2.46 3.3ZM2.44 2.42C3.41 2.46 3.65 0.95 3.13 0.36 2.84 0.13 2.45 0.04 2.09 0.13 1.72 0.22 1.41 0.47 1.25 0.81 1.36 1.7 1.61 2.37 2.45 2.42Z",17:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM1.42 3.18C1.42 1.24 2.04-0.65 3.19-2.21H0.18V-3.18H4.45V-2.48C3.15-0.89 2.49 1.13 2.59 3.18Z",18:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM2.31 3.3C0.16 3.38-0.74 0.92 1.3-0.08V-0.12C0.59-0.52 0.26-1.36 0.51-2.14 0.77-2.91 1.53-3.4 2.34-3.3 3.14-3.37 3.88-2.88 4.12-2.12 4.37-1.36 4.05-0.53 3.36-0.12V-0.08C5.33 0.9 4.42 3.43 2.31 3.3ZM2.33 2.48C2.68 2.52 3.02 2.36 3.22 2.06 3.41 1.77 3.43 1.39 3.26 1.08 2.88 0.68 2.39 0.38 1.85 0.24 0.82 0.87 0.96 2.51 2.33 2.48ZM2.73-0.41C3.47-1 3.48-2.49 2.32-2.48 2.01-2.49 1.72-2.33 1.56-2.06 1.4-1.79 1.39-1.46 1.55-1.19 1.85-0.81 2.26-0.54 2.73-0.41Z",19:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM1.91 3.3C1.27 3.31 0.65 3.05 0.21 2.58L0.83 1.88C2.28 3.23 3.44 1.59 3.35 0.01 2.97 0.53 2.33 0.81 1.69 0.74 1.05 0.66 0.5 0.25 0.24-0.35-0.03-0.99 0.03-1.73 0.4-2.31 0.77-2.9 1.41-3.27 2.11-3.3 5.4-3.26 5.12 3.36 1.91 3.3ZM2.18-0.08C2.66-0.12 3.09-0.39 3.32-0.82 3.3-1.94 2.35-2.96 1.45-2.11 0.91-1.48 1.12 0.01 2.18-0.08Z",20:"M-4.63 3.18V2.51C-3.54 1.31-1.98 0.31-1.75-1.29-1.73-2.71-3.4-2.62-4.04-1.68L-4.68-2.32C-3.74-3.56-1.44-3.75-0.79-2.15-0.15-0.38-1.88 1.04-2.95 2.27-2.08 2.2-1.21 2.18-0.33 2.2V3.18ZM2.48 3.3C-0.45 3.38-0.48-3.4 2.48-3.3 5.43-3.39 5.4 3.38 2.48 3.3ZM2.48 2.4C3.92 2.54 3.95-2.56 2.48-2.4 1.01-2.56 1.03 2.53 2.48 2.4Z"},kh=40,Vh={4:{net:Bo,meshScale:.9,numberScale:.08,colour:m.red,thumbnailY:8,renderOptions:{fov:180,hideBackface:!0}},6:{net:zo,meshScale:.744,numberScale:.1,colour:m.yellow,renderOptions:{fov:120,hideBackface:!0}},8:{net:Fo,meshScale:.85,numberScale:.07,colour:m.green,thumbnailY:3,renderOptions:{fov:180,hideBackface:!0}},10:{net:Gu,meshScale:1,numberScale:.06,numberShift:2,colour:m.teal,renderOptions:{fov:180}},12:{net:jo,meshScale:.6,numberScale:.1,colour:m.blue,renderOptions:{fov:!1,hideBackface:!0}},20:{net:Uo,meshScale:.6,numberScale:.06,colour:m.purple,renderOptions:{fov:!1,hideBackface:!0}}};function am(i,t){let e=Vh[i],s=[],n=gn(e.net,r=>{let a=new pe(r.shape,{class:"polygon-tile",style:"stroke-width: 0.5"});a.color=E(e.colour),s.push(a);let l=new pe(iw[s.length],{class:"dice-dot"});return l.transform.scale(J.all(e.numberScale)),e.numberShift&&l.transform.translate(0,e.numberShift,0),new ve([a,l])}).group,o=n.children[0].children.map(r=>{let a=r.getTransformed(J.zero).fixFloat(),l=0;(a.x!==0||a.z!==0)&&(l=Math.atan2(a.z,a.x)-dt);let c=a.transform(pt.rotateY(l)),p=0;(c.y!==0||c.z!==0)&&(p=Math.atan2(c.y,c.z));let u=Et.product(pt.rotateX(p),pt.rotateY(l)),f=r.getTransformed(new J(1,0,0)).transform(u).fixFloat().xy,g=Math.atan2(-f.y,f.x);return new J(p,l,g)});return t.append(n.$el),{die:n,faces:s,rotationOptions:o}}var Oh=class extends T{constructor(t,e,s){super(e,s);this.type="polyhedral-dice";this.isAnimating=!1;this.options=t;let[n,o]=t.split(":").map(l=>+l);n=n||0,n>=o&&(n=0),this.faceCount=o,this.definition=Vh[o];let r=am(o,this.$el);this.faces=r.faces,this.die=r.die,this.rotationOptions=r.rotationOptions,this.setValue(+n||tt.integer(1,o));let a=this.die.getProjectedVertices(this.definition.renderOptions);this.path=M.convexHull(...a),this.$outline=h("path",{class:"outline",path:this.path},this.$el)}setColour(t){super.setColour(t);for(let e of this.faces)e.color=E(this.colour);this.die.render(this.definition.renderOptions)}setValue(t){if(this.value===t)return;this.value=t,this.options=`${t}:${this.faceCount}`;let e=this.rotationOptions[this.value-1];this.die.transform.matrix=Et.product(pt.rotateZ(e.z),pt.rotateX(e.x),pt.rotateY(e.y),pt.scaleAll(this.definition.meshScale*kh)),this.die.render(this.definition.renderOptions)}roll(t=2e3){return R(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("roll");let e=Math.floor(Math.random()*this.faceCount),s=this.rotationOptions[this.value-1],n=this.rotationOptions[e];yield X(o=>{o=rt("sine",o),this.die.transform.matrix=Et.product(pt.translate(new J(0,0,4*o*(1-o)*kh/2)),pt.rotateZ(s.z+(n.z-s.z)*o),pt.rotateX(s.x+(n.x-s.x+4*Math.PI)*o),pt.rotateY(s.y+(n.y-s.y+4*Math.PI)*o),pt.scaleAll(this.definition.meshScale*kh)),this.die.render(this.definition.renderOptions)},t).promise,this.setValue(e+1),this.isAnimating=!1})}doubleClick(){$e.roll([this],this.$parent)}static makeThumbnail(t,e){let s=+t.split(":")[1],n=Vh[s],o=h("svg",{width:70,height:70},e),r=h("g",{transform:`translate(35, ${35+(n.thumbnailY||0)})`},o),a=am(s,r),l=a.rotationOptions[a.rotationOptions.length-1];a.die.transform.matrix=Et.product(pt.rotateZ(l.z),pt.rotateX(l.x),pt.rotateY(l.y),pt.scaleAll(n.meshScale*32)),a.die.render()}};var sw="M0 7.4L8.6 12L7 2.4L13.9 -4.4L4.3 -5.8L0 -14.5L-4.3 -5.8L-13.9 -4.4L-7 2.4L-8.6 12L0 7.4",lm="M12.9,9.7C13.9,3,4,5.3,4,1.2H4C9.4-3.7,7.6-14,.1-14.3S-9.3-3.9-4,1.3c-.1,3.8-9.8,1.9-8.9,8.4h0C-5.5,13.2,5.2,13.2,12.9,9.7Z",hm=23,nw=[m.red,m.blue],ow=[sw,lm],Lh=class extends T{constructor(t,e,s){super(e,s);this.type="coin";this.isAnimating=!1;let n=new H($,hm),o=nw.map((r,a)=>{let l=new pe(n,{class:"dice-face",fill:r,stroke:r}),c=new pe(ow[a],{class:"dice-dot"});return c.transform.translate(0,0,1),new ve([l,c])});o[0].transform.translate(0,0,.5),o[1].transform.rotate(Math.PI,0,0).translate(0,0,-.5),this.coin=new ve(o,{},this.$el),this.coin.sorting=!0,this.setValue(t?+t:tt.integer(0,1)),this.path=new H($,25),this.$outline=h("path",{class:"outline",path:this.path},this.$el)}setValue(t){this.value!==t&&(this.value=t,this.options=""+t,this.coin.transform.clear().rotate(t?Math.PI:0,0,0),this.coin.render())}setColour(t){this.colour=t.slice(0,7)}roll(t=2e3){return R(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("coinToss");let e=tt.integer(0,1),s=this.value?Math.PI:0,n=6*Math.PI+(e?Math.PI:0)-s;yield X(o=>{let r=rt("sine",o);this.coin.transform.clear().translate(0,0,4*r*(1-r)*hm).rotate(s+r*n,.4*Math.sin(r*8*Math.PI),0),this.coin.render()},t).promise,this.setValue(e),this.isAnimating=!1})}doubleClick(){$e.roll([this],this.$parent)}static makeThumbnail(t,e){let s=h("svg",{width:60,height:60},e);h("circle",{cx:30,cy:30,r:28,class:"polygon-tile",fill:m.blue},s),h("path",{d:lm,class:"dice-dot"},s).setTransform({x:30,y:30},0,1.2)}};var Rh=75,dr="M9.8-39.1,0-63-9.8-39.1-3-43V60a2.9,2.9,0,0,0,3,3,2.9,2.9,0,0,0,3-3V-43Z";function In(i,t,e,s=Rh,n=$){let o=e?F.shades(e,t.length):F.rainbow(t.length);i.removeChildren();for(let[r,a]of t.entries()){let l=t[r+1]?t[r+1]-a:D-a+t[0],c=new Ie(n,d.fromPolar(a-dt,s).add(n),l),p=o[r];h("path",{path:c,class:"polygon-tile",fill:p},i)}}var Nn=class extends T{constructor(t,e,s){super(e,s);this.type="spinner";this.angle=0;this.isAnimating=!1;this.path=new H($,Rh),this.$sectors=h("g",{},this.$el),this.$arrow=h("path",{d:dr,class:"spinner"},this.$el),this.$outline=h("path",{class:"outline",path:this.path},this.$el),this.setupHandles(),h("circle",{r:4,class:"spinner"},this.$el),e.events.listen(this.$arrow,{move:({posn:r})=>{let a=this.relativePosn(r).angle()+dt;this.$arrow.css("transform",`rotate(${a}rad)`)},end:({lastPosn:r})=>{let a=this.relativePosn(r).angle()+dt;this.setValue(_t(a))},click:()=>this.roll()}),this.$arrow.css("cursor","pointer");let[n,o]=t.split(":");this.drawSectors(+o),this.setValue(+n||0)}setupHandles(){this.$handle=this.makeHandle("c",t=>{let e=(t.angle()+dt)%D;this.drawSectors(D/e)}),this.$handle.css("cursor","move")}drawSectors(t){let e=S(Math.round(t),2,16);if(e===this.sectors)return;this.sectors=e,this.options=`${this.angle}:${e}`;let s=D/e;In(this.$sectors,B(n=>s*n,e),this.colour),this.$handle.setCenter(d.fromPolar(s-dt,Rh))}setColour(t){this.colour=t;let e=this.$sectors.children,s=F.shades(t,e.length);for(let[n,o]of e.entries())o.setAttr("fill",s[n])}setValue(t){t=Rt(Math.round(t),360),this.angle!==t&&(this.angle=t,this.options=`${t}:${this.sectors}`,this.$arrow.css("transform",`rotate(${this.angle}deg)`))}roll(t=2e3){return R(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("spin");let e=this.angle,s=(4+Math.random())*360;yield X(n=>{let o=bt(e,s,rt("sine",n));this.$arrow.css("transform",`rotate(${o}deg)`)},t).promise,this.setValue(s),this.isAnimating=!1})}doubleClick(){$e.roll([this],this.$parent)}static makeThumbnail(t,e){let s=h("svg",{width:80,height:80},e),n=new d(40,40);In(s,B(r=>D/5*r,5),"",36,n),h("path",{d:dr,class:"spinner"},s).css("transform","translate(40px, 40px) rotate(-0.8rad) scale(0.5)")}};var Ih=75,Nh=class extends Nn{constructor(t,e,s){super(`${t.split(":")[0]}:1`,e,s);this.type="custom-spinner";this.$handles=[];for(let n of t.split(":")[1].split(","))this.makeVertex(d.fromPolar(Z(+n)-dt,Ih))}setupHandles(){let t;this.$parent.events.listen(this.$outline,{down:({posn:e})=>t=this.makeVertex(this.relativePosn(e)),move:({posn:e})=>this.moveVertex(this.relativePosn(e),t),end:()=>this.$parent.change({changed:[this]})}),this.$outline.css("cursor","crosshair")}drawSectors(){if(!this.$handles||this.$handles.length<2)return;let t=this.$handles.map(s=>(s.center.angle()+dt)%D).sort();this.sectors=t.map(s=>Math.round(_t(s))).join(",");let e=`${this.angle}:${this.sectors}`;e!==this.options&&(this.options=e,In(this.$sectors,t,this.colour))}makeVertex(t){if(this.$handles.length>=24)return;let e=this.makeHandle("c",s=>{!e||(s.length>2*Ih?(this.deleteVertex(e),e=void 0):this.moveVertex(s,e))},()=>{e&&this.deleteVertex(e)});return e.setAttr("r",8),e.css("cursor","move"),this.$handles.push(e),this.moveVertex(t,e),e}deleteVertex(t){this.$handles.length<=2||(t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.drawSectors())}moveVertex(t,e){if(!e)return;let s=Z(ht(_t(t.angle()),10));e.setCenter(d.fromPolar(s,Ih)),this.drawSectors()}static makeThumbnail(t,e){let s=h("svg",{width:80,height:80},e),n=new d(40,40),o=t.split(":")[1].split(",").map(a=>Z(+a));In(s,o,"",36,n),h("path",{d:dr,class:"spinner"},s).css("transform","translate(40px, 40px) rotate(0.4rad) scale(0.5)");for(let a of o){let l=d.fromPolar(a-dt,36).add(n);h("circle",{cx:l.x,cy:l.y,r:3,fill:"white"},s)}}};var ke=50;function pr(i,t,e,s=0,n=0){for(let o of Rn[t]){let r=o[0]*.23*e+e/2+s,a=o[1]*.23*e+e/2+n;h("circle",{cx:r,cy:a,r:e/10,class:"dice-dot"},i)}}var Gh=class extends T{constructor(t,e,s){super(e,s);this.type="domino";this.options=t,this.path=new x($,ke,ke*2),this.$mainShape=h("rect",{class:"polygon-tile",rx:5},this.$el),h("line",{x1:0,y1:ke,x2:ke,y2:ke,class:"polygon-tile"},this.$el);let[n,o]=t.split(":").map(r=>+r);pr(this.$el,n,ke,0,0),pr(this.$el,o,ke,0,ke),this.value=n+o,this.$outline=h("rect",{class:"outline",rx:5},this.$el),this.$mainShape.setRect(this.path),this.$outline.setRect(this.path),this.transform(),this.setColour(m.teal)}getSnapPoints(){return[...super.getSnapPoints(),new d(0,ke),new d(ke,ke)]}setColour(t){super.setColour(t),this.$mainShape.setAttr("fill",E(t))}static makeThumbnail(t,e){let s=30,n=h("svg",{width:s+4,height:s*2+4},e);h("rect",{x:2,y:2,width:s,height:s*2,rx:2,class:"polygon-tile",fill:m.teal},n),h("line",{x1:2,y1:s+2,x2:s+2,y2:s+2,class:"polygon-tile"},n);let[o,r]=t.split(":").map(a=>+a);pr(n,o,s,2,2),pr(n,r,s,2,2+s)}};var rw=[[0,0]],cm=[[0,-39],[0,39]],aw=[...cm,[0,0]],ur=[[-18,-39],[18,-39],[-18,39],[18,39]],lw=[...ur,[0,0]],dm=[...ur,[-18,0],[18,0]],hw=[...dm,[0,-19]],Dh=[...ur,[-18,-13],[18,-13],[-18,13],[18,13]],cw=[...Dh,[0,0]],dw=[...Dh,[0,-26],[0,26]],pw={C:"#333",S:"#333",H:m.orange,D:m.orange},uw={A:rw,2:cm,3:aw,4:ur,5:lw,6:dm,7:hw,8:Dh,9:cw,10:dw},fw="AH:2H:3H:4H:5H:6H:7H:8H:9H:0H:JH:QH:KH:AC:2C:3C:4C:5C:6C:7C:8C:9C:0C:JC:QC:KC:KD:QD:JD:0D:9D:8D:7D:6D:5D:4D:3D:2D:AD:KS:QS:JS:0S:9S:8S:7S:6S:5S:4S:3S:2S:AS".split(":").map(i=>i+"f").join(":"),mw={A:1,J:11,Q:12,K:13,0:10};function pm(i,t){i.removeChildren();let[e,s,n]=t.split("");if(t==="deck"||n)return h("rect",{x:-39,y:-57,width:78,height:114,rx:2,fill:"url(#card-bg)"},i);e==="0"&&(e="10"),i.setAttr("fill",pw[s]);let o=`#suit-${s.toLowerCase()}`;if(s==="J")h("image",{href:"/polypad/assets/cards/joker.svg",style:"transform: translate(-35px, -53px)",width:70},i),e="Joker";else if(["K","Q","J"].includes(e))h("use",{href:o,style:"transform: translate(-35px, -36px) scale(0.6)",width:24,height:24},i),h("use",{href:o,style:"transform: rotate(180deg) translate(-35px, -36px) scale(0.6)",width:24,height:24},i),h("image",{href:`/polypad/assets/cards/${t.toLowerCase()}.svg`,style:"transform: translate(-35px, -53px)",width:70},i);else{let a=e==="A"?" scale(1.7)":"";for(let l of uw[e]||[]){let c=l[1]>0?" rotate(180deg)":"";h("use",{href:o,style:`transform: translate(${l[0]}px, ${l[1]}px)`+c+a,width:24,height:24},i)}}let r={text:e,x:-40,y:-45,style:"font-size: 16px; letter-spacing: -1px;"};h("text",r,i),h("text",j(j({},r),{style:"transform: rotate(180deg)"}),i)}var js=class extends T{constructor(t,e,s){super(e,s);this.type="card";this.padding=[0,0,20,0];this.count=0;this.$label=h("g",{class:"outline card-label"},this.$el),this.$labelRect=h("rect",{width:30,height:35,rx:5},this.$label),this.$labelText=h("text",{x:6,y:30},this.$label),this.$stack=h("rect",{class:"polygon-tile",fill:"url(#card-gradient)",rx:10},this.$el),this.$path=h("rect",{class:"polygon-tile",fill:"#eee",rx:10},this.$el),this.$body=h("g",{transform:"scale(1.4)"},this.$el),this.$outline=h("rect",{class:"outline",rx:10},this.$el),this.$path.setRect(new x(new d(-125/2,-175/2),125,175)),this.setOptions(t==="deck"?fw:t)}setOptions(t){if(t===this.options)return;this.options=t;let e=t.split(":");this.count=e.length,this.value=q(e.map(o=>+(mw[o[0]]||o[0])));let s=Math.sqrt(this.count-1)*3;this.path=new x(new d(-125/2,-175/2),125,175+s);for(let o of[this.$stack,this.$outline])o.setRect(this.path);this.transform(),this.$label.setAttr("hidden",this.count<=1?!0:void 0),this.$label.setTransform({x:-125/2,y:175/2-15+s}),this.$labelRect.setAttr("width",46+this.count.toFixed().length*8),this.$labelText.text=`${this.count} cards`;let n=_(e);n!==this.top&&pm(this.$body,n),this.top=n}setColour(t){super.setColour(t||m.blue)}addCards(t){this.setOptions(this.options+":"+t)}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findNearby("card",75))}collide(t){t.highlight(!1),t.addCards(this.options),this.delete();let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e})}doubleClick(){let t=this.draw();t&&this.$parent.change({added:[t],changed:[this]})}flip(){this.$parent.playSound("click");let t=this.options.split(":").reverse();this.setOptions(t.map(e=>e.length>2?e.slice(0,2):e+"f").join(":"))}draw(){if(this.count<=1)return;this.$parent.playSound("draw"),this.$parent.selection.clear();let t=this.options.split(":"),e=t.pop();this.setOptions(t.join(":"));let s=new js(e,this.$parent);return s.rot=this.rot,s.animateTo(this.posn.shift(150,0),this.posn),s}shuffle(){this.count<=1||(this.$parent.playSound("shuffle"),this.setOptions(tt.shuffle(this.options.split(":")).join(":")))}static makeThumbnail(t,e){let s=h("svg",{width:60,height:74},e);h("rect",{x:5,y:2,width:50,height:70,fill:"white",rx:4},s);let n=h("g",{style:"transform: translate(30px, 37px) scale(0.55)"},s);e.onAttr("data-options",o=>pm(n,o))}};I([{type:"button",tileTypes:["card"],label:"Turn over",click:(i,t)=>{for(let e of i)e.flip();t.change({changed:i})}},{type:"button",tileTypes:["card"],label:"Stack",show:i=>i.length>1,click:(i,t)=>{let e=i.map(n=>n.options).join(":"),s=new js(e,i[0].$parent);s.setTransform(d.average(...i.map(n=>n.posn)));for(let n of i)n.delete();t.selection.add(s),t.change({added:[s],deleted:i})}},{type:"button",tileTypes:["card"],label:"Draw",show:i=>i.length===1&&i[0].count>1,click:(i,t)=>{let e=i[0].draw();t.change({added:[e],changed:i})}},{type:"button",tileTypes:["card"],label:"Shuffle",show:i=>i.some(t=>t.count>1),click:(i,t)=>{for(let e of i)e.shuffle();t.change({changed:i})}}]);var fr=[{key:"discrete",label:"Discrete Uniform",params:[{label:"Min:",int:!0},{label:"Max:",int:!0}],defaults:[1,10],get:(i,t)=>tt.integer(i,t)},{key:"bernoulli",label:"Bernoulli",params:[{label:"p",range:[0,1]}],defaults:[.5],get:i=>tt.bernoulli(i)},{key:"binomial",label:"Binomial",params:[{label:"p",range:[0,1]},{label:"n",range:[1,void 0],int:!0}],defaults:[.5,10],get:(i,t)=>tt.binomial(t,i)},{key:"poisson",label:"Poisson",params:[{label:"\u03BB",range:[0,void 0]}],defaults:[1,10],get:i=>tt.poisson(i)},{key:"geometric",label:"Geometric",params:[{label:"p",range:[0,1]}],defaults:[.5],get:i=>tt.geometric(i)||0},{key:"continuous",label:"Continuous Uniform",params:[{label:"Min:"},{label:"Max:"}],defaults:[0,1],get:(i,t)=>tt.uniform(i,t)},{key:"normal",label:"Normal",params:[{label:"\u03BC"},{label:"\u03C3\xB2",range:[0,void 0]}],defaults:[0,1],get:(i,t)=>tt.normal(i,t)},{key:"exponential",label:"Exponential",params:[{label:"\u03BB"}],defaults:[1],get:i=>tt.exponential(i)},{key:"cauchy",label:"Cauchy",params:[],defaults:[],get:()=>tt.cauchy()}],_h=class extends T{constructor(t,e,s){super(e,s);this.type="random";this.path=new x($,75,50);this.$body=h("rect",{class:"polygon-tile",rx:6,width:75,height:50},this.$el),h("rect",{class:"polygon-tile",fill:"none",opacity:.7,style:"stroke-width:2px;stroke-dasharray:2px 4px",x:3.5,y:3.5,rx:3,width:68,height:43},this.$el),this.$text=h("text",{x:75/2,fill:"white",style:"text-anchor: middle"},this.$el),this.$outline=h("rect",{class:"outline",rx:6,width:75,height:50},this.$el);let[n,o,...r]=t.split(",");this.setDistribution(o,r.length?r.map(a=>+a):void 0),n?this.setValue(+n):this.roll(),this.setColour(m.green)}setColour(t){super.setColour(t),this.$body.setAttr("fill",t)}setDistribution(t,e){this.distribution=fr.find(s=>s.key===t)||fr[0],this.params=e||this.distribution.defaults.slice(0),this.roll()}setValue(t){this.value=t,this.options=`${this.value},${this.distribution.key},${this.params.join(",")}`;let e=this.$text.text=nt(t,6),s=S(65/e.length*2,16,32);this.$text.css("font-size",s+"px"),this.$text.setAttr("y",.3*s+26)}roll(){this.setValue(this.distribution.get(...this.params))}doubleClick(){this.roll(),this.$parent.change({changed:[this]})}static makeThumbnail(t,e){let s=h("svg",{width:85,height:60},e);h("rect",{x:5,y:5,width:75,height:50,class:"polygon-tile",rx:6,fill:m.green},s),h("rect",{class:"polygon-tile",fill:"none",opacity:.7,style:"stroke-width:2px;stroke-dasharray:2px 4px",x:8.5,y:8.5,rx:3,width:68,height:43},s),h("text",{fill:"white",x:42.5,y:41,style:"font-size:32px;text-anchor: middle",text:"?"},s)}},gw=qt(fr.map(i=>i.params.map((t,e)=>({type:"input",tileTypes:["random"],label:t.label,value:"number",advanced:!0,range:t.range,show:s=>s.every(n=>n.distribution===i),get:s=>s.params[e],set:(s,n)=>{n.params[e]=t.int?Math.round(+s):+s,n.roll()}}))));I([{type:"select",tileTypes:["random"],options:fr,label:"Distribution:",advanced:!0,get:i=>i.distribution.key,set:(i,t)=>t.setDistribution(i)},...gw]);var Hh=/(,|^[^.\-0-9]+|[^.\-0-9]+$)/g,um=[m.red,m.blue,m.green,m.yellow,m.purple,m.orange,m.lime],as=class extends T{constructor(t,e,s){super(e,s);this.focussedSeries=-1;this.default=!0;this.chartOptions=mt({}),t&&Object.assign(this.chartOptions,ki(t)),this.chartColors=this.chartOptions.colours||[],this.chartOptions.watchAll(()=>this.options=JSON.stringify(this.chartOptions)),this.$series=h("g",{},this.$el),this.$outline=h("path",{class:"outline"},this.$el),e.events.listen(this.$el,{click:n=>this.focusOnSeries(n),checkIfActive:()=>this.focussedSeries>=0})}setColour(t,e){let s=this.focussedSeries;if(s>=0&&e==="picker"){if(this.chartColors[s]===t)return;this.chartColors[s]=t,this.colorSeries(E(t),s),this.chartOptions.colours=this.chartColors.slice(0),this.$parent.change({changed:[this]})}else e==="theme"||super.setColour(t)}getSeriesColor(t){if(this.default)return m.grey;let e=this.chartColors[t]||um[t%um.length];return E(e)}doubleClick(t){this.focussedSeries>=0||(this.focusOnSeries(t),!(this.focussedSeries<0)&&(super.focus(),this.$el.addClass("chart-focussed")))}focusOnSeries(t){let e=t.event.target.getAttribute("series-idx")||this.findClosestElement(t);!e||(this.focussedSeries=+e,this.focusSeries(+e))}findClosestElement(t){return""}blur(){this.focussedSeries<0||(this.focussedSeries=-1,this.$el.removeClass("chart-focussed"),super.blur())}};function Gn(i){i=i.filter((e,s)=>!s||e.some(n=>n));let t=i[0].map((e,s)=>i.some((n,o)=>o>0&&n[s]));return i.map(e=>e.filter((s,n)=>t[n]))}function fm(i){if(i=Gn(i),!i.length||!i[0].length)return[[],[]];i[0].length===1&&(i=i.map((n,o)=>[`${o}`,n[0]]));let t=i.slice(1),e=t.map(n=>n[0]),s=i[0].slice(1).map((n,o)=>({label:n,data:t.map(r=>+r[o+1].replace(Hh,"")||0)}));return[e,s]}function mm(i,t,e=!0){let s=i[0].data.length,n=[];for(let o=0;o<s;++o){let r=[];if(t==="grouped")for(let a of i)r.push([0,a.data[o]]);else if(e){let a=0,l=0,c=i.map(u=>u.data[o]),p=t==="percentage"?99.99/q(c):1;for(let u of c)u<0?(r.push([a,a+u*p]),a+=u*p):(r.push([l,l+u*p]),l+=u*p)}else{let a=0,l=i.map(p=>p.data[o]),c=t==="percentage"?99.99/q(l):1;for(let p of l)r.push([a,a+p*c]),a+=p*c}n.push(r)}return n}var Ue=class{constructor(t){this.makeNew=t;this.stack=[]}get(t){return this.stack[t]||(this.stack[t]=this.makeNew()),this.stack[t]}};var vw=["A","B","C"],ww=[[10,20,30],[30,10,40],[20,25,10]].map(i=>({label:"",data:i})),qh=class extends as{constructor(t,e,s){super(t,e,s);this.type="chart";this.colour=m.darkGrey;this.padding=[0,0,25,30];this.tables=[];this.categories=[];this.series=[];this.$rects=new Ue(()=>h("rect",{class:"polygon-tile"}));this.$areas=new Ue(()=>h("polygon",{opacity:.5}));this.$lines=new Ue(()=>h("polyline",{class:"chart-line"}));this.$points=new Ue(()=>h("circle",{r:5}));this.$background=h("path",{fill:"transparent"},this.$el),this.$el.prepend(this.$background),this.$axes=h("path",{class:"grid-axis",stroke:E(m.darkGrey)},this.$el),this.$labels=h("g",{class:"axis-labels",fill:E(m.darkGrey)},this.$el),this.$foreground=h("g",{},this.$el),this.$handle=this.makeHandle("c",n=>{this.chartOptions.height=Math.max(ht(-n.y,25),100),this.chartOptions.width=Math.max(ht(n.x,25),100)}),this.$handle.css("cursor","nesw-resize"),this.chartOptions.watch(({type:n,layout:o,width:r,height:a})=>{this.updateOutline(r,a),this.drawChart(n,o)}),this.makeInPort("main",{tileTypes:["table"],message:(n,o)=>{if(n.type!=="table")return;let[r,a]=fm(n.table),l=this.tables.find(c=>c.cable===o);l?Object.assign(l,{categories:r,series:a}):this.tables.push({cable:o,categories:r,series:a}),this.reconcileSeries(),this.drawChart(this.chartOptions.type,this.chartOptions.layout)},disconnect:n=>{this.tables=this.tables.filter(o=>o.cable!==n),this.reconcileSeries(),this.drawChart(this.chartOptions.type,this.chartOptions.layout)}})}reconcileSeries(){var t,e;this.categories=((t=this.tables[0])==null?void 0:t.categories.slice(0))||[],this.series=((e=this.tables[0])==null?void 0:e.series.map(s=>({label:s.label,data:s.data.slice(0)})))||[];for(let s of this.tables.slice(1)){let n=this.categories.length,o=this.series.length;for(let r of s.series)this.series.push({label:r.label,data:Ht(0,n)});for(let[r,a]of s.categories.entries()){let l=this.categories.indexOf(a);if(l<0){this.categories.push(a);for(let c of this.series)c.data.push(0);l=this.categories.length-1}for(let[c,p]of s.series.entries())this.series[o+c].data[l]=p.data[r]}}}updateOutline(t=400,e=250){this.path=new x($.shift(0,-e),t,e),this.$background.draw(this.path),this.$outline.draw(this.path),this.$handle.setCenter({x:t,y:-e}),this.transform(),this.$parent.selection.update()}getX(t){return(t-this.bounds.xMin)/this.bounds.dx*this.path.w}getY(t){return(t-this.bounds.yMin)/this.bounds.dy*this.path.h}drawChart(t="column",e="grouped"){this.$series.removeChildren(),this.$foreground.removeChildren();let s=["line","area"].includes(t);this.default=!this.series.length;let n=this.default?ww:this.series,o=this.default?vw:this.categories,r=mm(n,e,!s),a=Math.min(0,...r.map(w=>Math.min(...w.map(v=>v[1])))),l=Math.max(0,...r.map(w=>Math.max(...w.map(v=>v[1])))),c=t==="row"?this.path.w:this.path.h,p=Pi("",c,[a,l],0),u=[0,o.length-1,1],f=s&&!o.some(w=>isNaN(+w)),g=f?o.map(w=>+w):void 0;if(f){let w=Math.min(...g),v=Math.max(...g);u=Pi("",this.path.w,[w,v],0)}t==="row"&&([p,u]=[u,p]),this.bounds=new At(u[0],u[1],p[0],p[1]),t==="column"?this.drawColumnChart(r,e):t==="row"?this.drawRowChart(r,e):(g&&([r,g]=this.getSortedData(r,g)),t==="area"&&this.drawAreas(r,g),this.drawLines(r,g),t==="line"&&this.drawPoints(r,g)),this.drawAxes(t,this.path.w,this.path.h,u[2],p[2],f?void 0:o)}getSortedData(t,e){let s=pi(e.length).sort((n,o)=>e[n]-e[o]);return[s.map(n=>t[n]),s.map(n=>e[n])]}drawAxes(t,e,s,n,o,r){var l;this.$labels.removeChildren();let a=`M0 0v${-s}M0 0h${e}`;if(it(0,this.bounds.yMin,this.bounds.yMax)&&(a+=`M0 ${-this.getY(0)}h${e}`),it(0,this.bounds.xMin,this.bounds.xMax)&&(a+=`M${this.getX(0)} 0 v${-s}`),t==="column"&&r){let c=r.length?e/r.length:0;for(let p=0;p<=r.length;++p){let u=p*c;a+=`M${u} 0L${u} 5`,h("text",{text:r[p],x:u+c/2,y:21,"text-anchor":"middle"},this.$labels)}}else for(let c=this.bounds.xMin;c<=this.bounds.xMax;c+=n){let p=this.getX(c);a+=`M${p},0v5`;let u=t==="row"?nt(c,4):(l=r==null?void 0:r[c])!=null?l:nt(c,4);h("text",{text:u,x:p,y:21,"text-anchor":"middle"},this.$labels)}if(t==="row"&&r){let c=r.length?s/r.length:0;for(let p=0;p<=r.length;++p){let u=-p*c;a+=`M0 ${u}h-5`,h("text",{text:r[p],x:-12,y:u-c/2+5,"text-anchor":"end"},this.$labels)}}else for(let c=this.bounds.yMin;c<=this.bounds.yMax;c+=o){let p=this.getY(c);a+=`M0 ${-p}h-5`;let u=nt(c,4);h("text",{text:u,x:-10,y:-p+5,"text-anchor":"end"},this.$labels)}this.$axes.setAttr("d",a)}drawColumnChart(t,e){let s=t.length,n=t[0].length,o=this.path.w/s,r=o/4,a=o-r,l=e==="grouped";l&&(a/=n);for(let c=0;c<n;++c)for(let p=0;p<s;++p){let u=t[p][c],f=p*o+r/2+(l?c*a:0),g=[-this.getY(u[0]),-this.getY(u[1])],w=Math.abs(g[1]-g[0]);this.drawRect(c*s+p,c,f,Math.min(...g),a,w)}}drawRowChart(t,e){let s=t.length,n=t[0].length,o=this.path.h/s,r=o/4,a=o-r,l=e==="grouped";l&&(a/=n);for(let c=0;c<n;++c)for(let p=0;p<s;++p){let u=t[p][c],f=p*o+r/2+(l?c*a:0),g=[this.getX(u[0]),this.getX(u[1])],w=Math.abs(g[1]-g[0]);this.drawRect(c*s+p,c,Math.min(...g),-(f+a),w,a)}}drawRect(t,e,s,n,o,r){let a=this.$rects.get(t);this.$series.append(a),a.setAttr("fill",this.getSeriesColor(e)),a.setAttr("x",s),a.setAttr("y",n),a.setAttr("width",o),a.setAttr("height",r),a.setAttr("series-idx",e)}drawLines(t,e){let s=t[0].length;for(let n=0;n<s;++n){let o=t.map((a,l)=>{var c;return`${this.getX((c=e==null?void 0:e[l])!=null?c:l)} ${-this.getY(a[n][1])}`}).join(" "),r=this.$lines.get(n);r.setAttr("stroke",this.getSeriesColor(n)),r.setAttr("points",o),r.setAttr("series-idx",n),this.$series.append(r)}}drawPoints(t,e){var o;let s=t[0].length,n=t.length;for(let r=0;r<s;++r)for(let a=0;a<n;++a){let l=this.$points.get(r*n+a);l.setCenter({x:this.getX((o=e==null?void 0:e[a])!=null?o:a),y:-this.getY(t[a][r][1])}),l.setAttr("fill",this.getSeriesColor(r)),l.setAttr("series-idx",r),this.$foreground.append(l)}}drawAreas(t,e){let s=t[0].length;for(let n=0;n<s;++n){let o=t.map((l,c)=>{var p;return`${this.getX((p=e==null?void 0:e[c])!=null?p:c)} ${-this.getY(l[n][1])}`}).join(" "),r=t.map((l,c)=>{var p;return`${this.getX((p=e==null?void 0:e[c])!=null?p:c)} ${-this.getY(l[n][0])}`}).reverse().join(" "),a=this.$areas.get(n);a.setAttr("fill",this.getSeriesColor(n)),a.setAttr("points",o+" "+r),a.setAttr("series-idx",n),this.$series.append(a)}}setColour(t,e){super.setColour(t,e),this.focussedSeries<0&&(this.$labels.setAttr("fill",E(t)),this.$axes.setAttr("stroke",E(t)))}colorSeries(t,e){var s,n,o,r;if(!!this.series.length){(s=this.$lines.stack[e])==null||s.setAttr("stroke",t),(n=this.$areas.stack[e])==null||n.setAttr("stroke",t),(o=this.$areas.stack[e])==null||o.setAttr("fill",t),e===this.focussedSeries&&((r=this.$focussedLine)==null||r.setAttr("stroke",t));for(let a of this.$series.$$(`rect[series-idx="${e}"]`))a.setAttr("fill",t);for(let a of this.$foreground.$$(`circle[series-idx="${e}"]`))a.setAttr("fill",t)}}focusSeries(t){if(this.chartOptions.type==="line"){this.$focussedLine||(this.$focussedLine=h("polyline",{class:"chart-shadow"}),this.$background.insertAfter(this.$focussedLine)),this.$focussedLine.setAttr("points",this.$lines.get(t).attr("points")),this.$focussedLine.setAttr("stroke",this.getSeriesColor(t)),this.$focussedLine.show();return}if(this.$focussedOutline||(this.$focussedOutline=h("path",{class:"chart-outline"},this.$el)),this.chartOptions.type==="area"){let e=ls(this.$areas.get(t).attr("points").split(" "),2),s="M"+e.map(n=>n.join(" ")).join("L")+"Z";this.$focussedOutline.setAttr("d",s)}else{let e=this.$rects.stack.filter(n=>+n.attr("series-idx")===t&&n.css("display")),s="";for(let n of e){let o=+n.attr("height");if(P(0,o))continue;let r=n.attr("width");s+=`M${n.attr("x")} ${n.attr("y")}h${r}v${o}h${-r}Z`}this.$focussedOutline.setAttr("d",s)}this.$focussedOutline.show()}blur(){var t,e;super.blur(),(t=this.$focussedOutline)==null||t.hide(),(e=this.$focussedLine)==null||e.hide()}findClosestElement(t){var n;if(this.chartOptions.type!=="line"&&this.chartOptions.type!=="area")return"";let e=this.relativePosn(t.posn),s=this.$lines.stack.slice(0,this.series.length);return((n=Qe(s,o=>{let r=ls(o.attr("points").split(" "),2).map(([l,c])=>new d(+l,+c)),a=new se(...r);return d.distance(e,a.project(e))}))==null?void 0:n.attr("series-idx"))||""}};I([{type:"select",tileTypes:["chart"],radio:!0,label:"Chart type",options:[{label:"Column chart",key:"column",icon:"column-chart"},{label:"Row chart",key:"row",icon:"row-chart"},{label:"Line chart",key:"line",icon:"line-chart"},{label:"Area chart",key:"area",icon:"area-chart"}],get:i=>i.chartOptions.type||"column",set:(i,t)=>t.chartOptions.type=i},{type:"select",tileTypes:["chart"],radio:!0,label:"Chart layout",options:[{label:"Grouped",key:"grouped",icon:"chart-grouped"},{label:"Stacked",key:"stacked",icon:"chart-stacked"},{label:"Percentage",key:"percentage",icon:"chart-percentage"}],show:i=>i.some(t=>t.series.length>1),get:i=>i.chartOptions.layout||"grouped",set:(i,t)=>t.chartOptions.layout=i}]);var yw=[2,4,5],Bh=class extends as{constructor(t,e,s){super(t,e,s);this.type="pie-chart";this.series=[];this.$sectors=new Ue(()=>h("path",{class:"polygon-tile"}));this.$focussedOutline=h("path",{class:"chart-outline"},this.$el),this.$handle=this.makeHandle("c",n=>{this.chartOptions.width=S(ht(n.length,25),50,300)}),this.$handle.css("cursor","ew-resize"),this.chartOptions.watch(({type:n,width:o})=>{this.updateOutline(o),this.drawChart(n||"pie",o)}),this.makeInPort("main",{tileTypes:["table"],max:1,message:n=>{if(n.type!=="table")return;let o=Gn(n.table).slice(1);if(o.length===0)this.series=[];else{let r=o[0].length>1?1:0;this.series=o.map(a=>Math.abs(+a[r].replace(Hh,"")||0))}this.drawChart(this.chartOptions.type,this.chartOptions.width)},disconnect:()=>{this.series=[],this.drawChart(this.chartOptions.type,this.chartOptions.width)}})}updateOutline(t=100){this.path=new H($,t),this.$outline.draw(this.path),this.$handle.setTransform({x:t,y:0}),this.transform(),this.$parent.selection.update()}drawChart(t,e=100){var a,l;this.default=!this.series.length||this.series.every(c=>c===0);let s=this.default?yw:this.series,n=q(s),o=s.map(c=>c/n*D);this.$series.removeChildren();let r=-dt;for(let[c,p]of o.entries()){if(p===0)continue;P(p,D)&&(p=D-.001);let u=this.$sectors.get(c);this.$series.append(u),u.setAttr("fill",this.getSeriesColor(c)),u.setAttr("series-idx",c),u.draw(new Ie($,d.fromPolar(r,e),p)),r+=p}t==="donut"&&!this.$donutHole&&(this.$donutHole=h("circle",{class:"donut-hole"},this.$el)),(a=this.$donutHole)==null||a.setAttr("r",e/2),(l=this.$donutHole)==null||l.toggle(t==="donut")}colorSeries(t,e){!this.series.length||this.$sectors.get(e).setAttr("fill",t)}focusSeries(t){this.$focussedOutline.setAttr("d",this.$sectors.get(t).attr("d")),this.$focussedOutline.show()}blur(){super.blur(),this.$focussedOutline.hide()}};I([{type:"select",tileTypes:["pie-chart"],radio:!0,label:"Chart type",options:[{label:"Pie chart",key:"pie",icon:"pie-chart"},{label:"Donut chart",key:"donut",icon:"donut-chart"}],get:i=>i.chartOptions.type||"pie",set:(i,t)=>t.chartOptions.type=i}]);var bw=[[1,2,3,4,5]].map(i=>({label:"",data:i}));function $w(i,t=!1){let e=us(i,.25),s=us(i,.75),n=1.5*(s-e),o=t?i.filter(c=>it(c,e-n,s+n)):i,r=Math.min(...o);e=us(o,.25);let a=us(o,.5);s=us(o,.75);let l=Math.max(...o);return[r,e,a,s,l]}var zh=class extends as{constructor(t,e,s){super(t,e,s);this.type="box-whisker";this.colour=m.darkGrey;this.padding=[0,0,25,0];this.$boxPlots=new Ue(()=>h("path",{class:"chart-line"}));this.range=[0,5];this.series=[];this.tables=new Map;this.$background=h("path",{fill:"transparent"}),this.$el.prepend(this.$background),this.$axis=h("path",{class:"grid-axis",stroke:m.darkGrey},this.$el),this.$labels=h("g",{class:"axis-labels"},this.$el),this.$focussedOutline=h("path",{class:"chart-shadow"},this.$el),this.$handle=this.makeHandle("h",n=>{this.chartOptions.width=Math.max(ht(n.x,25),100)}),this.chartOptions.watch(({width:n})=>{this.updateOutline(n),this.drawChart()}),this.makeInPort("main",{tileTypes:["table"],message:(n,o)=>{n.type==="table"&&(this.tables.set(o,n.table),this.redraw())},disconnect:n=>{this.tables.delete(n),this.redraw()}})}drawChart(){this.default=!this.series.length;let t=this.default?bw:this.series;this.$series.removeChildren(),this.range[0]=Math.min(...t.map(e=>Math.min(...e.data))),this.range[1]=Math.max(...t.map(e=>Math.max(...e.data))),t.forEach((e,s)=>this.drawBoxWhiskerPlot(e.data,s,-25-50*(t.length-1-s))),this.drawAxes(t)}drawBoxWhiskerPlot(t,e,s){let n=this.$boxPlots.get(e),o=this.chartOptions.layout==="outliers",[r,a,l,c,p]=$w(t,o).map(w=>this.getX(w)),u=16,f=10,g=`M${r} ${s+f}V${s-f}M${r} ${s}H${a}V${s+u}H${c}V${s-u}H${a}V${s}M${l} ${s+u}V${s-u}M${c} ${s}H${p}M${p} ${s+f}V${s-f}`;if(o){let w=t.map(v=>this.getX(v)).filter(v=>v<r||v>p);for(let v of w)g+=Bt(new H(new d(v,s),4))}n.setAttr("d",g),n.setAttr("series-idx",e),n.setAttr("stroke",this.getSeriesColor(e)),this.$series.append(n)}drawAxes(t){this.$labels.removeChildren();let e=Pi("",this.path.w,this.range,0),s=`M 0 0 h ${this.path.w}`;for(let n=this.range[0];n<=this.range[1]+.001;n+=e[2]){let o=this.getX(n);s+=`M${o},0v5`,h("text",{text:nt(n,4),x:o,y:21,"text-anchor":"middle"},this.$labels)}this.$axis.setAttr("d",s),t.forEach((n,o)=>{let r=-25-50*(t.length-1-o),a=n.label;h("text",{text:a,x:-14,y:r,"text-anchor":"end"},this.$labels)})}updateOutline(t=this.chartOptions.width||300){let e=(this.series.length||1)*50;this.path=new x($.shift(0,-e),t,e),this.$outline.draw(this.path),this.$background.draw(this.path),this.$handle.translate(t,-e),this.transform(),this.$parent.selection.update()}colorSeries(t,e){this.$boxPlots.get(e).setAttr("stroke",t),this.$focussedOutline.setAttr("stroke",t)}getX(t){return(t-this.range[0])/(this.range[1]-this.range[0])*this.path.w}setColour(t,e){super.setColour(t,e),this.focussedSeries<0&&(this.$labels.setAttr("fill",E(t)),this.$axis.setAttr("stroke",E(t)))}redraw(){this.buildSeries(),this.drawChart(),this.updateOutline()}buildSeries(){this.series=[];for(let t of this.tables.values()){let e=Gn(t).slice(1);if(!!e.length)for(let s=0;s<e[0].length;s++){let n=e.map(o=>parseInt(o[s])).filter(o=>!Number.isNaN(o));n.length&&this.series.push({label:t[0][s],data:n})}}}focusSeries(t){this.$focussedOutline.setAttr("d",this.$boxPlots.get(t).attr("d")),this.$focussedOutline.setAttr("stroke",this.getSeriesColor(t)),this.$focussedOutline.show()}blur(){super.blur(),this.$focussedOutline.hide()}findClosestElement(t){let e=Math.round((this.relativePosn(t.posn).y+25)/50);return""+S(-e,0,this.series.length-1)}static makeThumbnail(t,e){let[s,n]=[180,45],[o,r,a,l,c]=[0,1,2,3,4].map(y=>5+y/4*170),[p,u,f]=[n/2,14,8],g=h("svg",{width:s,height:n},e),w=h("path",{class:"chart-line",stroke:"white",style:"stroke-width: 2px"},g),v=`M${o} ${p-f} V ${p+f}M${o} ${p} H ${r}V${p-u}H${l} V ${p+u}H${r} V ${p}M${a} ${p-u} V ${p+u}M${l} ${p}H${c}M${c} ${p-f}V${p+f}`;w.setAttr("d",v)}};I([{type:"checkbox",tileTypes:["box-whisker"],label:"Outliers:",get:i=>i.chartOptions.layout==="outliers",set:(i,t)=>t.chartOptions.layout=i?"outliers":void 0}]);var Ze=50,xw=["chart","pie-chart","box-whisker","axes"],Fh=class extends T{constructor(t,e,s){super(e,s);this.type="table";this.padding=[0,25,25,0];this.size=0;this.$handles=[];this.$cells=[];this.rows=3;this.cols=2;this.data=[["x","y"],["",""],[""],[""]];this.columnWidths=[];this.selection={startRow:0,startCol:0,endRow:0,endCol:0};this.options=t,t&&this.initializeData(),this.$foreignObject=h("foreignObject",{x:this.posn.x,y:this.posn.y,width:1,height:1,overflow:"visible"},this.$el),this.$table=h("div",{xmlns:"http://www.w3.org/1999/xhtml",class:"table-tile"},this.$foreignObject),this.$outline=h("path",{class:"outline"},this.$el),this.$selectionOutline=h("rect",{class:"table-selection",hidden:!0,rx:2},this.$el),e.events.listen(this.$el,{down:n=>{this.findSelection(this.relativePosn(n.posn)),this.$hidden.focus()},move:n=>{let o=this.relativePosn(n.startPosn),r=this.relativePosn(n.posn);this.findSelection(o,r)},click:n=>this.focusCell(this.findCellAt(this.relativePosn(n.posn))),blurInput:!1,checkIfActive:()=>!!this.isFocussed}),this.$hidden=h("textarea",{class:"table-hidden"},this.$parent),this.$hidden.on("blur",n=>{var o;((o=G(n.relatedTarget))==null?void 0:o.hasClass("table-cell"))||this.blur()}),this.$hidden.on("paste",n=>{var o;n.preventDefault(),this.paste(((o=n.clipboardData)==null?void 0:o.getData("text").trim())||"")}),this.$hidden.on("cut copy",n=>{var r;let o=this.getSelectionContents();o&&((r=window.navigator.clipboard)==null||r.writeText(o)),n.type==="cut"&&this.removeSelectionContents()}),this.$hidden.onKeyDown("escape",n=>{n.stopPropagation(),this.$hidden.blur(),this.$parent.selection.add(this)}),this.$hidden.onKeyDown("enter",n=>{n.preventDefault(),this.moveDown(!0)}),this.$hidden.onKeyDown("tab",n=>{n.preventDefault(),this.moveRight()}),this.$hidden.onKeyDown("backspace delete",n=>{n.stopPropagation(),this.removeSelectionContents()}),this.$handles[0]=this.makeHandle("h",n=>this.updateCols(n.x)),this.$handles[1]=this.makeHandle("v",n=>this.updateRows(n.y)),this.$handles[1].css("cursor","ns-resize"),this.setColour("#bbb"),this.buildTable()}setColour(t){this.colour=t,this.$table.css("border-color",t);for(let s of this.$cells)s.css("border-color",t);let e=F.mix(t,"#fff",.6);this.$table.css("background",e.rgb),this.$table.setClass("contrast",e.brightness<128),this.emitMessage("main",{type:"table",table:this.rawData})}transpose(){for(let t=0;t<this.data.length;t++)for(let e=0;e<t;e++)[this.data[t][e],this.data[e][t]]=[this.data[e][t],this.data[t][e]];[this.rows,this.cols]=[this.cols,this.rows],this.updateData(),this.buildTable()}updateOutline(){let t=_(this.columnWidths),e=this.rows*Ze;this.$foreignObject.setAttr("width",t||1),this.$foreignObject.setAttr("height",e||1);let s=new x($,t,e);this.$outline.draw(s),this.path=s.shift(.5),this.$handles[0].setTransform({x:t,y:0}),this.$handles[1].setTransform({x:0,y:e})}initializeData(){this.data=ki(this.options,[[""],[""]]),this.rows=this.data.length,this.cols=this.data[0].length}updateCols(t){let e=_(this.columnWidths),s=this.columnWidths[this.columnWidths.length-2]||0;t>e+Ze?(this.cols+=1,this.buildTable()):this.cols>1&&t<s+Ze&&(this.cols-=1,this.buildTable())}updateRows(t){let e=S(Math.round(t/Ze),1,100);e!==this.rows&&(this.rows=e,this.buildTable())}resizeColumns(){this.columnWidths=ui(B(t=>this.$cells[t].width,this.cols)),this.drawSelection()}makeCell(){let t=this.$cells.length,e=h("div",{class:"table-cell",contenteditable:!0,"cell-index":t},this.$table);e.css("border-color",this.colour),this.$cells.push(e);let s=!1;e.on("focus",()=>s=!0),e.on("pointerdown",o=>{s&&o.stopPropagation()}),e.on("blur",o=>{s=!1,this.data[this.cellPosn(e)[0]][this.cellPosn(e)[1]]=e.text,this.updateData();let r=G(o.relatedTarget);!(r==null?void 0:r.hasClass("table-cell"))&&!(r==null?void 0:r.hasClass("table-hidden"))&&this.blur()});let n=e.width;e.on("change keyup input",()=>{let o=n;n=e.width,o!==n&&this.resizeColumns()}),e.on("paste",o=>{var a;let r=((a=o.clipboardData)==null?void 0:a.getData("text").trim())||"";(r.includes(`
`)||r.includes("	"))&&(o.preventDefault(),this.paste(r))}),e.onKeyDown("escape",o=>{o.stopPropagation(),e.blur(),this.$parent.selection.add(this)}),e.onKeyDown("enter",o=>{o.preventDefault(),this.$parent.events.shiftKey?this.moveUp():this.moveDown(!0)}),e.onKeyDown("tab",o=>{o.preventDefault(),this.$parent.events.shiftKey?this.moveLeft():this.moveRight()})}cellPosn(t){let e=parseInt(t.attr("cell-index"));return[Math.floor(e/this.cols),e%this.cols]}buildTable(){this.$table.css("grid-template-columns",`repeat(${this.cols}, max-content)`);let t=this.cols*this.rows;for(let e=this.$cells.length;e<t;++e)this.makeCell();for(let e=t;e<this.$cells.length;++e)this.$cells[e].hide();for(let e=0;e<this.rows;++e)for(let s=0;s<this.cols;++s){this.data[e]||(this.data[e]=[]),this.data[e][s]||(this.data[e][s]="");let n=this.$cells[e*this.cols+s];n.show(),n.text=this.data[e][s],n.setClass("header",!e)}this.resizeColumns(),this.updateOutline(),this.$parent.selection.update(),this.makeOutPort("main",{tileTypes:xw,location:new d(_(this.columnWidths),this.rows*Ze/2),connect:e=>e.enqueueMessage({type:"table",table:this.rawData})}),this.transform(),this.updateData()}paste(t){let[e,s]=[this.selection.startRow,this.selection.startCol],n=t.trim().split(`
`).map(o=>o.split("	"));this.rows=Math.max(this.rows,e+n.length),this.cols=Math.max(this.cols,s+Math.max(...n.map(o=>o.length)));for(let o=0;o<n.length;++o)for(let r=0;r<n[o].length;++r)this.data[e+o]||(this.data[e+o]=[]),this.data[e+o][s+r]=n[o][r];this.updateSelection(s,e,s+n[0].length-1,e+n.length-1),this.buildTable()}moveLeft(){let[t,e]=[this.selection.startRow,this.selection.startCol];this.focusCell(this.$cells[t*this.cols+e-1]||this.$cells[this.$cells.length-1])}moveRight(){let[t,e]=[this.selection.startRow,this.selection.startCol];this.focusCell(this.$cells[t*this.cols+e+1]||this.$cells[0])}moveUp(){let[t,e]=[this.selection.startRow,this.selection.startCol],s=t===0?this.rows:t;this.focusCell(this.$cells[(s-1)*this.cols+e])}moveDown(t=!0){let[e,s]=[this.selection.startRow,this.selection.startCol];t&&this.rows<=e+1&&(this.data[e][s]=this.$cells[e*this.cols+s].text,this.rows+=1,this.buildTable()),this.focusCell(this.$cells[(e+1)*this.cols+s])}doubleClick(t){this.focus(),this.focusCell(this.findCellAt(this.relativePosn(t.posn)))}focus(){this.isFocussed||(super.focus(),this.initialOptions=this.options,this.$table.addClass("active"),this.$selectionOutline.show())}findCellAt(t){let e=this.columnWidths.findIndex(n=>n>t.x),s=Math.floor(t.y/Ze);return this.$cells[this.cols*s+e]}focusCell(t){var o,r;let[e,s]=this.cellPosn(t);this.updateSelection(s,e),t.focus();let n=document.createRange();n.selectNodeContents(t._el),(o=document.getSelection())==null||o.removeAllRanges(),(r=document.getSelection())==null||r.addRange(n)}blur(){!this.isFocussed||(super.blur(),this.updateData(),this.updateOutline(),this.transform(),this.$table.removeClass("active"),this.$selectionOutline.hide(),this.$parent.selection.add(this),this.initialOptions!==this.options&&this.$parent.change({changed:[this]}))}get rawData(){return this.data.slice(0,this.rows).map(t=>t.slice(0,this.cols))}updateData(){let t=this.rawData;this.options=JSON.stringify(t),this.initialOptions!==this.options&&this.emitMessage("main",{type:"table",table:t})}findSelection(t,e=t){let s=Math.floor(Math.min(t.y,e.y)/Ze),n=Math.ceil(Math.max(t.y,e.y)/Ze)-1,o=this.columnWidths.findIndex(a=>a>Math.min(t.x,e.x)),r=this.columnWidths.findIndex(a=>a>Math.max(t.x,e.x));r<0&&(r=this.cols),this.updateSelection(o,s,r,n)}updateSelection(t,e,s=t,n=e){var o,r,a,l;t=S(t,0,this.cols-1),s=S(s,t,this.cols-1),e=S(e,0,this.rows-1),n=S(n,e,this.rows-1),!(((o=this.selection)==null?void 0:o.startRow)===e&&((r=this.selection)==null?void 0:r.endRow)===n&&((a=this.selection)==null?void 0:a.startCol)===t&&((l=this.selection)==null?void 0:l.endCol)===s)&&(this.selection={startCol:t,startRow:e,endCol:s,endRow:n},this.drawSelection())}drawSelection(){if(!this.selection)return;let t=this.columnWidths[this.selection.startCol-1]||0,e=new d(t,this.selection.startRow*Ze),s=this.columnWidths[this.selection.endCol]-t||0,n=(this.selection.endRow+1-this.selection.startRow)*Ze;this.$selectionOutline.setRect(new x(e,s+1,n+1))}getSelectionContents(){let t="",e=this.selection;if(!e)return t;for(let s=e.startRow;s<=e.endRow;++s){for(let n=e.startCol;n<=e.endCol;++n)n>e.startCol&&(t+="	"),t+=this.data[s][n];t+=`
`}return t}removeSelectionContents(){let t=this.selection;if(!!t)for(let e=t.startRow;e<=t.endRow;++e)for(let s=t.startCol;s<=t.endCol;++s)this.data[e][s]="",this.$cells[e*this.cols+s].text=""}static makeThumbnail(t,e){let s=h("svg",{width:110,height:85},e),n=(o,r,a,l,c,p="")=>{h("rect",{x:5+o,y:5+r,width:a,height:l,fill:c,class:"polygon-tile"},s),p&&h("text",{x:25+5/2+o,y:25-5/2+r,text:p,fill:"white"},s)};for(let o=0;o<2;++o)for(let r=0;r<3;++r)n(50*o,25*r,50,25,r?"#ffffff33":"#ffffff66",r?"":o?"y":"x")}};I([{type:"button",tileTypes:["table"],label:"Transpose",click:(i,t)=>{for(let e of i)e.transpose();t.change({changed:i})}}]);var gm=["hours","minutes","seconds"],Pw={hours:"M-3,0-4-29l4-5,4,5L3,0Z",minutes:"M-2,0-3-47l3-5,3,5L2,0",seconds:"M-1,-52L1,-52L1,0L-1,0Z"};function vm(i,t=75){let e=t-5,s="";for(let a=0;a<60;++a){let l=d.fromPolar(a/30*Math.PI),c=e-(a%5?3:8);s+=`M${l.x*c} ${l.y*c}L${l.x*e} ${l.y*e}`}let n=h("circle",{r:t,class:"polygon-tile"},i);h("circle",{r:e,class:"clock-face"},i);let o=h("path",{d:s,class:"clock-ticks"},i);for(let a=1;a<=12;++a){let l=d.fromPolar((a-3)/6*Math.PI).scale(53).shift(0,5);h("text",{text:a,x:l.x,y:l.y,class:"clock-label"},i)}let r=gm.map(a=>h("path",{class:"clock-handle",d:Pw[a],opacity:a==="hours"?.8:void 0},i));return h("circle",{r:4,class:"spinner"},i),[n,o,...r]}var jh=class extends T{constructor(t,e,s){super(e,s);this.type="clock";this.showSeconds=!0;this.prevAngle=0;this.currentAngle=0;this.seconds=0;this.time=[0,0,0];this.options=t;let n=75;this.path=new H($,n),[this.$border,this.$ticks,...this.$hands]=vm(this.$el,n),this.$outline=h("circle",{class:"outline",r:n},this.$el);let o=this.options;for(let[c,p]of this.$hands.entries())e.events.listen(p,{start:({posn:u})=>{o=this.options,this.prevAngle=this.getPointerAngle(u)%D},move:({posn:u})=>this.handleMoveHand(gm[c],u),end:()=>{this.updateOptions(),this.options!==o&&e.change({changed:[this]})}});let[r,a,...l]=this.options.split(":");if(+a||this.$hands[2].hide(),r==="l"){this.clockType="live";let c=new Date().getTimezoneOffset()*60,p=-1;this.animation=X(()=>{let u=Math.round(Date.now()/1e3-c);u!==p&&(p=u,this.setTime(u))});for(let u of this.$hands)u.css("pointer-events","none")}else r==="g"?(this.clockType="geared",this.setTime(+l[0]||0)):(this.clockType="free",this.setHands(+l[0]||0,+l[1]||0,+l[2]||0))}setTime(t){this.seconds=t;let e=t%60,s=t/60%60,n=t/3600%12;this.setHands(n,s,e)}setHands(t,e,s){this.time=[t%12,e%60,s%60],this.$hands[2].setTransform(void 0,Math.round(s)/60*D),this.$hands[1].setTransform(void 0,e/60*D),this.$hands[0].setTransform(void 0,t/12*D),this.value=Rt(t,12)+Rt(e,60)/60+Rt(s,60)/3600}updateOptions(){let t=this.showSeconds?"1":"0";this.clockType==="live"?this.options=`l:${t}`:this.clockType==="geared"?this.options=`g:${t}:${this.seconds}`:this.options=`f:${t}:${this.time[0]}:${this.time[1]}:${this.time[2]}`}delete(){var t;(t=this.animation)==null||t.cancel,super.delete()}getPointerAngle(t){return this.relativePosn(t).angle()+dt}handleMoveHand(t,e){this.currentAngle=this.getPointerAngle(e)%D,this.prevAngle/D>.75?this.currentAngle/D<.25&&(this.currentAngle+=D):this.prevAngle/D<.25&&this.currentAngle/D>.75&&(this.currentAngle-=D);let s=(this.currentAngle-this.prevAngle)/D;if(this.clockType==="geared"){let n=s*(t==="hours"?43200:t==="minutes"?3600:60);this.setTime(this.seconds+n)}else if(this.clockType==="free"){let[n,o,r]=this.time;t==="hours"?n+=s*12:t==="minutes"?o+=s*60:r+=s*60,this.setHands(n,o,r)}this.currentAngle>=D?this.currentAngle-=D:this.currentAngle<0&&(this.currentAngle+=D),this.prevAngle=this.currentAngle}setColour(t){super.setColour(t),this.$border.setAttr("fill",E(t)),this.$ticks.setAttr("stroke",E(t)),this.$hands[2].css("fill",E(t))}static makeThumbnail(t,e){let s=h("svg",{width:80,height:80,viewBox:"-80 -80 160 160"},e),n=e.data.colour,[o,r,...a]=vm(s,75);o.removeClass("polygon-tile"),o.setAttr("fill",n),r.setAttr("stroke",n),a[2].css("fill",n),a[2].setTransform(void 0,57/60*D),a[1].setTransform(void 0,37/60*D),a[0].setTransform(void 0,2.62/12*D)}};I([{type:"checkbox",tileTypes:["clock"],label:"Seconds:",get:i=>i.showSeconds,set:(i,t)=>{t.$hands[2].toggle(i),t.showSeconds=i,t.updateOptions()}}]);var Yt=50,wm="#585",ym=["r","n","b","q","k","b","n","r"],bm={k:"M25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37ZM34.3,16.6a13.8,13.8,0,0,0-6.1,1.3l-.9-4h3.8c1.2,0,1.7-1.5,1.7-2.6s-.5-2.6-1.7-2.6H27.8v-3c0-.9-1.7-1.4-2.8-1.4s-2.8.5-2.8,1.4v3H18.9c-1.2,0-1.7,1.6-1.7,2.6s.5,2.6,1.7,2.6h3.8l-.9,4a13.8,13.8,0,0,0-6.1-1.3c-9.8,0-14.3,11.5-3.2,19.1l.8,2.8C16.1,37,23,37,25,37s8.9,0,11.7,1.5l.8-2.8C48.6,28.1,44.1,16.6,34.3,16.6ZM22,30.9s-3.6.2-5.3.5c-2.8-1.7-5.4-4.8-4.6-6.7,1.2-3.8,9.9.3,9.9.3Zm11.3.5c-1.7-.3-5.3-.5-5.3-.5V25c1.6-1.8,8.7-4.1,9.9-.3C38.7,26.6,36.1,29.7,33.3,31.4Z",q:"M25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37ZM40,13.6a4,4,0,0,0-3.4,6.2l-4.9,3.4V14.4c4.5-1.2,3.6-7.8-1.1-7.8a3.9,3.9,0,0,0-2.3,7.2L25,21.9l-3.3-8.1a3.9,3.9,0,0,0-2.3-7.2c-4.7,0-5.6,6.6-1.1,7.8v8.8l-4.9-3.4A4,4,0,0,0,10,13.6a4,4,0,1,0,.6,7.9l6.3,16A55,55,0,0,1,25,37a55,55,0,0,1,8.1.5l6.3-16a4,4,0,1,0,.6-7.9Z",r:"M17.8,20.7a53.4,53.4,0,0,1,14.4,0c2.6-.1,4.8-2,3.8-10.9l-3.7-.5L31.2,13H28l-.5-3.8h-5L22,12.9H18.8L17.7,9.3,14,9.8C13,18.7,15.2,20.6,17.8,20.7ZM25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37ZM25,37c1.7,0,7,0,10.3,1L32.2,20.7a53.4,53.4,0,0,0-14.4,0L14.7,38C18,37,23.3,37,25,37Z",b:"M16.9,37.5A55,55,0,0,1,25,37a53.2,53.2,0,0,1,8,.5,17.4,17.4,0,0,0,1-18.2l-4.6,6.3a2.4,2.4,0,0,1-3.9-2.8L31,15a27.6,27.6,0,0,0-3.8-3.9l1.5-2.6c0-1.1-1.7-2-3.7-2s-3.8.9-3.8,2l1.5,2.6C8.6,23.4,15.3,35.1,16.9,37.5ZM25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37Z",n:"M25,37c2,0,9.4,0,12,1.6s2.2,3.7,1.9,6.4H11.1c-.3-2.7.1-5.3,1.9-6.4S23,37,25,37ZM14.8,26.1c3-2.6,5.5-2.1,9.2-3.7,1.9,3.1-11.9,9.3-9.4,15.6,3.2-1,8.7-1,10.4-1s8.2,0,11.2,1.3c-5.9-8.9,9.4-23.2-10.5-29.5a7.9,7.9,0,0,0-5.2-2.7V9.4L8.4,21.9C11.1,26.9,14.8,26.1,14.8,26.1ZM20.7,15c.1-.5.4-1.4,1.1-1.4h0a2.9,2.9,0,0,1,1,.3.4.4,0,0,1,.1.3,1.9,1.9,0,0,1-.9,1.2l-1.2.2h-.1Z",p:"M25,10.8a6,6,0,0,0-4.1,10.5c-4,1.7-3.7,2.3-3.3,6.5h3.8c-1.6,8.3-9.1,6.4-8.9,15.7h25c.2-9.3-7.3-7.3-8.9-15.7h3.8c.4-4.2.7-4.8-3.3-6.5A6,6,0,0,0,25,10.8Z"};function $m(i,t,e){let{x:s,y:n,tile:o}=t,r=(f,g)=>f>=0&&g>=0&&f<8&&g<8,a=(f,g)=>i.pieces.filter(w=>w.x===f&&w.y===g),l=(f,g,w=!1)=>{let v=i.pieces.filter(y=>y.tile.dark===t.tile.dark||y.x!==f||y.y!==g).map(y=>y.x===t.x&&y.y===t.y&&y.tile.dark===t.tile.dark?j(j({},y),{x:f,y:g,justJumped:y.justJumped||w}):j({},y));return{newX:f,newY:g,isJump:w,newState:{pieces:v}}};if(o.piece==="n")return[[1,-2],[2,-1],[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2]].map(([f,g])=>[s+f,n+g]).filter(([f,g])=>r(f,g)&&!a(f,g).some(w=>w.tile.dark===o.dark)).map(([f,g])=>l(f,g));let c=[],p=o.dark?1:-1;if(o.piece==="p"){let f=[[s-1,n+p],[s+1,n+p]].filter(([g,w])=>{let v=a(g,w)[0];return r(g,w)&&v&&v.tile.dark!==o.dark});if(n===(o.dark?4:3)){let g=a(s-1,n)[0];g&&g.tile.dark!==o.dark&&g.tile.piece==="p"&&g.justJumped&&f.push([s-1,n+p]);let w=a(s+1,n)[0];w&&w.tile.dark!==o.dark&&w.tile.piece==="p"&&w.justJumped&&f.push([s+1,n+p])}if(c.push(...f.map(([g,w])=>l(g,w))),e)return c}let u=[];["k","q","r"].includes(o.piece)&&u.push([-1,0],[0,1],[1,0],[0,-1]),["k","q","b"].includes(o.piece)&&u.push([-1,-1],[1,1],[1,-1],[-1,1]),o.piece==="p"&&u.push([0,p]);for(let f of u){let{x:g,y:w}=t,v=7;o.piece==="k"&&(v=1),o.piece==="p"&&(w===(o.dark?1:6)?v=2:v=1);for(let y=0;y<v&&(g+=f[0],w+=f[1],!!r(g,w));y++){let C=a(g,w)[0];if(C){C.tile.dark!==o.dark&&o.piece!=="p"&&c.push(l(g,w));break}c.push(l(g,w,o.piece==="p"&&y===1))}}return c}var Dn=class extends T{constructor(t,e,s){super(e,s);this.type="chess-board";this.canDragToSelect=!1;this.canRotate=!1;this.$cells=[];this.$dots=[];for(let n=0;n<8;n++)for(let o=0;o<8;o++){let r=(n*8+o+n)%2?wm:"#ccc";this.$cells.push(h("rect",{x:o*Yt,y:n*Yt,width:Yt,height:Yt,fill:r},this.$el)),this.$dots.push(h("circle",{cx:(o+.5)*Yt,cy:(n+.5)*Yt,r:16,opacity:.7},this.$el))}this.options=t||"off",this.path=new x($,Yt*8,Yt*8),this.$outline=h("rect",{class:"outline"},this.$el),this.$outline.setRect(this.path),this.hideDots(),this.setOrder("back")}getPiecePosition(t){let e=this.relativePosn(t.posn).scale(1/Yt).floor();return e.x>=0&&e.x<=7&&e.y>=0&&e.y<=7?e:void 0}getCurrentState(){let t=[];for(let e of this.$parent.getTilesOfType("chess-piece")){let s=this.getPiecePosition(e);s&&t.push({x:s.x,y:s.y,tile:e,justJumped:e.justJumped})}return{pieces:t}}moveStart(t=!1){if(super.moveStart(),!t)for(let e of this.getCurrentState().pieces)this.$parent.selection.add(e.tile)}showDots(t){if(this.options==="off")return;let e=this.getCurrentState(),s=e.pieces.find(o=>o.tile===t),n=$m(e,s,!1);for(let o=0;o<8;o++)for(let r=0;r<8;r++){let a=this.$dots[o*8+r];a.hide();let l=n.find(c=>c.newX===r&&c.newY===o);if(l&&(a.show(),this.options==="moves"&&a.setAttr("fill",m.yellow),this.options==="danger")){let c=!1;for(let p of l.newState.pieces){if(p.tile.dark===s.tile.dark)continue;let u=$m(l.newState,p,!0);c||(c=u.some(f=>{if(f.newX===r&&f.newY===o)return!0;let g=s.tile.dark?1:-1;if(l.isJump&&f.newX===r&&f.newY===o-g)return!0}))}a.setAttr("fill",c?m.red:m.blue)}}}hideDots(){for(let t of this.$dots)t.hide()}completeMove(t,e){let s=this.getCurrentState(),n=s.pieces.find(r=>r.tile===t);if(!n||n.x===e.x&&n.y===e.y)return;let o=s.pieces.filter(r=>r.tile.dark!==n.tile.dark&&r.x===n.x&&r.y===n.y&&r!==n);for(let r of o)r.tile.delete();for(let r of s.pieces)r.tile.justJumped=!1;(e.y===6&&n.y===4||e.y===1&&n.y===3)&&n.tile.piece==="p"&&(n.tile.justJumped=!0),this.$parent.change({changed:[t],deleted:o.map(r=>r.tile)})}getSnapPoints(){let t=[];for(let e=0;e<=8;e++)for(let s=0;s<=8;s++)t.push(new d(e*Yt,s*Yt));return t}reset(t=!1){let e=[],s=[];for(let r of this.getCurrentState().pieces)s.push(r.tile),r.tile.delete();let n=(r,a,l,c)=>{let p=new mr(l+(c?"d":"l"),this.$parent);p.setTransform(this.posn.add(new d(r+.5,a+.5).scale(Yt))),e.push(p)},o=r=>r==="k"?"k":t?tt.find(["q","r","b","n","p"]):r;for(let r=0;r<8;++r)n(r,0,o(ym[r]),!0),n(r,1,o("p"),!0),n(r,6,o("p"),!1),n(r,7,o(ym[r]),!1);return{added:e,deleted:s}}static makeThumbnail(t,e){let s=h("svg",{width:124,height:124},e),n=120/8;for(let o=0;o<8;o++)for(let r=0;r<8;r++){let a=(r*8+o+r)%2?wm:"#ccc";h("rect",{width:n,height:n,x:2+o*n,y:2+r*n,fill:a},s)}}static reset(t,e,s=!1){let n=[],o=[];for(let r of t){let a=r.reset(s);n=n.concat(a.added),o=o.concat(a.deleted)}e.change({added:n,deleted:o})}};I([{type:"select",label:"Hints:",tileTypes:["chess-board"],options:[{label:"None",key:"off"},{label:"Moves",key:"moves"},{label:"Danger",key:"danger"}],get:i=>i.options,set:(i,t)=>t.options=i},{type:"button",label:"Reset",tileTypes:["chess-board"],click:(i,t)=>Dn.reset(i,t)},{type:"button",label:"Randomise",tileTypes:["chess-board"],click:(i,t)=>Dn.reset(i,t,!0)}]);var mr=class extends T{constructor(t,e,s){super(e,s);this.type="chess-piece";this.canRotate=!1;this.justJumped=!1;this.options=t,this.piece=t[0],this.dark=t[1]==="d",this.path=new x(new d(-Yt/2,-Yt/2),Yt,Yt),h("path",{path:this.path,fill:"transparent"},this.$el),this.$piece=h("path",{d:bm[this.piece],style:"transform: translate(-25px, -25px)"},this.$el),this.$outline=h("path",{class:"outline",path:this.path},this.$el),this.setColour(this.dark?"#333":"#eee")}setColour(t){super.setColour(t),this.$piece.setAttr("fill",t),this.$piece.setAttr("stroke",this.dark?"white":"#181824")}get board(){return this.$parent.getTileAt(this.posn,["chess-board"])}down(){var t,e;this.$parent.selection.size>1||(this.startCell=(t=this.board)==null?void 0:t.getPiecePosition(this),(e=this.board)==null||e.showDots(this))}up(){var t;(t=this.board)==null||t.hideDots()}moveEnd(){if(this.$parent.selection.size>1)return;let t=this.board;t&&this.startCell&&(t.completeMove(this,this.startCell),this.$parent.selection.tiles.delete(this),setTimeout(()=>this.$parent.selection.tiles.add(this))),this.startCell=void 0}static makeThumbnail(t,e){let s=h("svg",{width:40,height:40,viewBox:"0 0 50 50"},e),n=bm[t[0]],o=t[1]==="d"?"#333":"#ddd",r=t[1]==="d"?"#fff":"#181824";h("path",{d:n,fill:o,stroke:r},s)}};var We=["logic-gate","logic-button","logic-switch","logic-bulb","logic-display","logic-speaker","logic-metronome"],gr={and:"M37.3,9H18V41H37.3C47.6,41,56,33.8,56,25S47.6,9,37.3,9Z",buffer:"M25 9L25 41L55 25Z",xor:"M23,41a30.2,30.2,0,0,0,4.6-16A30.2,30.2,0,0,0,23,9h1c13.2,0,26.4,5.1,32,16C50.4,35.9,37.2,41,24,41Zm-2.5,0a26.8,26.8,0,0,0,5.1-16A26.8,26.8,0,0,0,20.5,9H18a25,25,0,0,1,5.6,16A25,25,0,0,1,18,41Z",or:"M24,9H18a25,25,0,0,1,5.6,16A25,25,0,0,1,18,41h6c13.2,0,26.4-5.1,32-16C50.4,14.1,37.2,9,24,9Z"},Sw={buffer:[1,([i])=>i],not:[1,([i])=>!i],or:[2,([i,t])=>i||t],nor:[2,([i,t])=>!(i||t)],and:[2,([i,t])=>i&&t],nand:[2,([i,t])=>!(i&&t)],xor:[2,([i,t])=>i?!t:t],xnor:[2,([i,t])=>i?t:!t],t:[1,(i,[t],e)=>t===-1?!e:e],sr:[2,([i,t],e,s)=>i===t?s:i],d:[2,([i],[t,e],s)=>e===1?i:s],jk:[3,([i,t,e],[s,n,o],r)=>n!==1?r:i!==e?i:i?!r:r]};function xm(i,t){let e=gr[i]||gr[i.slice(1)];if(i==="not"&&(e=gr.buffer),i==="xnor"&&(e=gr.xor),!e){t.addClass("logic-gate");let l=i==="sr"?"Latch":"Flip-flop",c={"font-weight":"bold","text-anchor":"middle",fill:"white"};h("text",j({text:i.toUpperCase(),x:38,y:35,"font-size":24},c),t),h("text",j({text:l,x:38,y:55,"font-size":14},c),t);return}h("path",{d:e,fill:"white"},t);let s={stroke:"white","stroke-width":2},n=i[0]==="n"||i==="xnor",o=i.startsWith("x"),r=n?63:50,a=o?22:25;i==="buffer"||i==="not"?(h("line",j({x1:10,y1:25,x2:a,y2:25},s),t),h("line",j({x1:r,y1:25,x2:66,y2:a},s),t),n&&h("circle",j({r:4,cx:58,cy:25,fill:"transparent"},s),t)):(h("line",j({x1:10,y1:16,x2:a,y2:16},s),t),h("line",j({x1:10,y1:34,x2:a,y2:34},s),t),h("line",j({x1:r,y1:25,x2:68,y2:25},s),t),n&&h("circle",j({r:4,cx:59,cy:25,fill:"transparent"},s),t))}var Uh=class extends T{constructor(t,e,s){super(e,s);this.type="logic-gate";this.options=t;let n=["t","sr","d","jk"].includes(t),o=n?75:50;this.path=new x($,75,o),this.$rect=h("rect",{width:75,height:o,rx:5},this.$el),this.$outline=h("rect",{class:"outline",width:75,height:o,rx:5},this.$el),xm(t,this.$el);let[r,a]=Sw[t],l=Ht(r,0),c=0;this.makeOutPort("main",{connect:f=>f.enqueueMessage({type:"number",value:c}),location:new d(75,o/2),persistent:!0,highlights:!0,tileTypes:We});let p=(f,g)=>{let w=l.map((y,C)=>C!==f||y===g?0:g?1:-1);l[f]=g;let v=c;c=a(l.map(y=>!!y),w,!!c)?1:0,c!==v&&this.emitMessage("main",{type:"number",value:c})},u=r===1?[0]:r===2?[-.2,.2]:[-.25,0,.25];for(let f=0;f<r;f++)this.makeInPort("in-"+f,{message:g=>{g.type==="number"&&p(f,g.value)},location:[new d(0,o*(.5+u[f])),Math.PI],disconnect:()=>p(f,0),max:1,tileTypes:We}),p(f,0);this.setColour(n?m.teal:m.green)}setColour(t,e){super.setColour(t,e),this.$rect.setAttr("fill",t)}static makeThumbnail(t,e){let s=["t","sr","d","jk"].includes(t),n=h("svg",{width:55,height:s?55:39,viewBox:`0 0 75 ${s?75:53}`},e),o=s?m.teal:m.green;h("rect",{fill:o,rx:5,width:75,height:s?75:50},n),xm(t,n)}};var vt=50,Zh=class extends T{constructor(t,e,s){super(e,s);this.type="logic-button";this.path=new x($,vt,vt),this.$path=h("rect",{rx:5,width:vt,height:vt},this.$el),this.$outline=h("rect",{class:"outline",rx:5,width:vt,height:vt},this.$el),this.$circle=h("circle",{fill:"#0005",cx:vt/2,cy:vt/2,r:8},this.$el),this.makeOutPort("main",{persistent:!0,highlights:!0,tileTypes:We,location:[new d(vt,vt/2),0]}),this.setColour(m.red)}setColour(t){super.setColour(t),this.$path.setAttr("fill",t)}down(){this.$circle.setAttr("fill","white"),this.emitMessage("main",{type:"number",value:1})}up(){this.$circle.setAttr("fill","#0005"),this.emitMessage("main",{type:"number",value:0})}static makeThumbnail(t,e){let s=h("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},e);h("rect",{fill:m.red,rx:5,width:50,height:50},s),h("circle",{cx:25,cy:25,r:8,fill:"white"},s)}},Pm="M30,16H20a9,9,0,0,0,0,18H30a9,9,0,0,0,0-18Z",Wh=class extends T{constructor(t,e,s){super(e,s);this.type="logic-switch";this.path=new x($,vt,vt),this.$body=h("rect",{rx:5,width:vt,height:vt},this.$el),this.$outline=h("rect",{class:"outline",rx:5,width:vt,height:vt},this.$el),this.$toggle=h("path",{d:Pm,fill:"none","stroke-width":3,style:"transition: stroke .1s"},this.$el),this.$circle=h("circle",{cx:20,cy:vt/2,r:5,style:"transition: transform .1s, fill .1s"},this.$el),this.makeOutPort("main",{connect:n=>n.enqueueMessage({type:"number",value:this.value||0}),location:[new d(vt,vt/2),0],persistent:!0,highlights:!0,tileTypes:We}),this.setColour(m.red),this.setState(t==="true")}setState(t=!1){this.value=t?1:0,this.options=t?"true":"",this.$toggle.css("stroke",t?"white":"#0005"),this.$circle.css("fill",t?"white":"#0005"),this.$circle.css("transform",t?"translate(10px)":""),this.$parent.change({changed:[this]}),this.emitMessage("main",{type:"number",value:this.value})}click(){this.setState(!this.value)}setColour(t){super.setColour(t),this.$body.setAttr("fill",t)}static makeThumbnail(t,e){let s=h("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},e);h("rect",{fill:m.red,rx:5,width:50,height:50},s),h("path",{d:Pm,fill:"none","stroke-width":3,stroke:"white"},s),h("circle",{cx:30,cy:vt/2,r:5,fill:"white"},s)}},Sm="M28,11a3,3,0,1,1-3-3A2.9,2.9,0,0,1,28,11ZM25,36a3,3,0,1,0,3,3A2.9,2.9,0,0,0,25,36ZM8,25a3,3,0,1,0,3-3A2.9,2.9,0,0,0,8,25Zm28,0a3,3,0,1,0,3-3A2.9,2.9,0,0,0,36,25Zm1-7.8A3,3,0,0,1,32.8,13,3,3,0,0,1,37,17.2ZM17.2,32.8a3,3,0,1,0,0,4.2A2.9,2.9,0,0,0,17.2,32.8ZM13,13a3,3,0,0,0,4.2,4.2A3,3,0,0,0,13,13ZM32.8,32.8a3,3,0,1,0,4.2,0A2.9,2.9,0,0,0,32.8,32.8Z",Kh=class extends T{constructor(t,e,s){super(e,s);this.type="logic-bulb";this.colour=m.yellow;this.value=0;this.path=new x($,vt,vt),this.$path=h("rect",{fill:m.grey,rx:5,width:vt,height:vt},this.$el),this.$outline=h("rect",{class:"outline",rx:5,width:vt,height:vt},this.$el),h("circle",{cx:25,cy:25,r:8,fill:"white"},this.$el),this.$lights=h("path",{d:Sm,fill:"white",hidden:!0},this.$el),this.makeInPort("main",{message:n=>{n.type==="number"&&this.setState(!!n.value)},disconnect:()=>this.setState(!1),location:[new d(0,vt/2),Math.PI],max:1,tileTypes:We}),this.setState(!1)}setState(t=!1){this.value=t?1:0,this.setColour(this.colour),this.$lights.toggle(t)}setColour(t){super.setColour(t),this.$path.css("fill",this.value?t:m.grey)}static makeThumbnail(t,e){let s=h("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},e);h("rect",{fill:m.yellow,rx:5,width:50,height:50},s),h("circle",{cx:25,cy:25,r:8,fill:"white"},s),h("path",{d:Sm,fill:"white"},s)}},Xh=class extends T{constructor(t,e,s){super(e,s);this.type="logic-display";this.path=new x($,100,100);let n={x:0,y:0,width:100,height:100,rx:10};this.$path=h("rect",j({},n),this.$el),this.$outline=h("rect",j(j({},n),{class:"outline"}),this.$el),this.$number=h("text",{x:50,y:56,fill:"#fff","text-anchor":"middle","font-size":58},this.$el),this.$binary=h("text",{x:50,y:82,fill:"#fff","text-anchor":"middle","font-size":20,"font-weight":600},this.$el);let o=[0,0,0,0],r=()=>{this.$number.textStr=q(o.map((a,l)=>a*2**l)),this.$binary.text=[...o].reverse().join(" ")};for(let a=0;a<4;a++)this.makeInPort(`bit-${a}`,{location:[new d(0,20+a*20),Math.PI],tileTypes:We,persistent:!0,max:1,disconnect(){o[a]=0,r()},message(l){l.type==="number"&&(o[a]=l.value,r())}});r(),this.setColour(m.orange)}setColour(t){super.setColour(t),this.$path.setAttr("fill",E(t))}static makeThumbnail(t,e){let s=h("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},e);h("rect",{fill:m.orange,rx:5,width:50,height:50},s),h("text",{x:25,y:35,fill:"#fff","text-anchor":"middle","font-size":30,text:"15"},s)}};var Yh=3.5,Tm=1.5,Us={USD:[{value:1,width:19.05},{value:5,width:21.21},{value:10,width:17.91},{value:25,width:24.26},{value:100,width:26.49}],EUR:[{value:1,width:16.25},{value:2,width:18.75},{value:5,width:21.25},{value:10,width:19.75},{value:20,width:22.25},{value:50,width:24.25},{value:100,width:23.25},{value:200,width:25.75}],GBP:[{value:1,width:20.3},{value:2,width:25.9},{value:5,width:18},{value:10,width:24.5},{value:20,width:21.2},{value:50,width:27.3},{value:100,width:22.4},{value:200,width:28.4}]},Cm=Us.EUR[0].width*Yh,Tw=Cm-2;function vr(i){return Object.keys(Us).map(t=>i.filter(e=>e.currency===t)).filter(t=>t.length)}var Cw=le((i,t)=>{let e=Us[i].map(r=>r.value).filter(r=>r<t),s=[],n=e.length-1,o=0;for(;o<t&&n>=0;)o+e[n]<=t?(o+=e[n],s.push(e[n])):n-=1;return s});function Mm(i){let t=i[0].currency,e=i.map(l=>l.value),s=q(e),n=Us[t].map(l=>l.value).filter(l=>l<=s),o=[],r=n.length-1,a=0;for(;a<s&&r>=0;)a+n[r]<=s?(a+=n[r],o.push(n[r])):r-=1;if(!(a!==s||o.sort().join("")===e.sort().join("")))return o}function Em(i,t=!1){t&&(i=i.sort((f,g)=>g-f));let e=i.length,s={};for(let f of i)s[f]=(s[f]||0)+1;let n=Object.values(s),o=n.filter(f=>f>=4).length>1||n.filter(f=>f>=3).length>2||n.some(f=>f>=8)||n.some(f=>f>=5)&&e>10||n.some(f=>f>=4)&&e>12,r=10,a=0,l=-1,c=i.map((f,g)=>{if(!o)return[g%r,Math.floor(g/r)];let w=g>0&&(l+1>=r||f!==i[g-1]);return l=w?0:l+1,a=w?a+1:a,[l,a]}),p=Math.max(...c.map(f=>f[0])),u=Math.max(...c.map(f=>f[1]));return c.map(([f,g],w)=>({value:i[w],posn:new d(f-p/2,g-u/2).scale(Tw)}))}function Qh(i,t){let e=`/polypad/assets/currency/coins-${t.value}-${i.toLowerCase()}.svg`;return h("image",{width:t.width,height:t.height||t.width,href:e})}function Mw(i,t){let e=D/(i===5?4.5:i),s=Math.PI*Math.random(),n=t*.5;return B(o=>{if(i===5&&o===4)return $;let r=e*(Math.random()-.5)/2,a=Math.random()*t*(i===3?.33:.1);return d.fromPolar(e*o+s+r,n+a)},i)}var Zs=class extends T{constructor(t,e,s){super(e,s);this.type="currency";this.options=t;let[n,o]=t.split(":");this.value=+n,this.currency=o,this.change=Cw(this.currency,this.value);let r=Us[this.currency].find(c=>c.value===+this.value);if(!r.height){let c=r.width*Yh/2,p=Qh(this.currency,r);p.css("transform",`translate(${-r.width/2}px,${-r.width/2}px) scale(${Yh})`),this.$el.append(p),this.$outline=h("circle",{r:c,class:"outline"},this.$el),this.path=new H($,c);return}this.$el.append(Qh(this.currency,r));let a=r.width*Tm,l=r.height*Tm;this.$outline=h("rect",{width:a,height:l,class:"outline"},this.$el),this.path=new x($,a,l)}split(){let t=Mw(this.change.length,Cm);return this.change.map((e,s)=>{let n=new Zs(`${e}:${this.currency}`,this.$parent);return n.setTransform(this.posn.add(t[s]),this.rot),n})}static makeThumbnail(t,e){let[s,n]=t.split(":"),o=Us[n].find(c=>c.value===+s),r=!o.height,a=`-1 -1 ${o.width+2} ${(o.height||o.width)+2}`;h("svg",{width:r?60:120,height:60,viewBox:a},e).append(Qh(n,o))}};I([{type:"button",tileTypes:["currency"],label:"Make change",show:i=>it(q(i.map(t=>t.change.length)),1,201),click:(i,t)=>{let e=[],s=[];for(let n of i)!n.change.length||(e.push(...n.split()),n.delete(),s.push(n));t.selection.select(e),t.playSound("splitCoins"),t.change({added:e,deleted:s})}},{type:"button",tileTypes:["currency"],label:"Cash in",show:i=>i.length>1&&vr(i).some(t=>Mm(t)),click:(i,t)=>{let e=[],s=[];for(let n of vr(i)){let o=Mm(n);if(o){let r=n[0].currency,a=x.aroundPoints(n.map(l=>l.posn)).center;for(let l of n)l.delete();s.push(...n);for(let{value:l,posn:c}of Em(o,!0)){let p=new Zs(`${l}:${r}`,t);p.setTransform(a.add(c)),e.push(p)}}}t.selection.select(e),t.playSound("mergeCoins"),t.change({deleted:s,added:e})}},{type:"button",tileTypes:["currency"],label:"Organize",show:i=>i.length>1&&vr(i).some(t=>t.length>1),click:(i,t)=>{for(let e of vr(i)){if(e.length<=1)return;let s=x.aroundPoints(e.map(r=>r.posn)).center,n=[...e].sort((r,a)=>a.value-r.value||r.posn.y-a.posn.y||r.posn.x-a.posn.x),o=Em(n.map(r=>r.value));for(let[r,a]of n.entries())a.select(),t.selection.tiles.delete(a),t.selection.tiles.add(a),a.animateTo(s.add(o[r].posn))}t.change({changed:i})}}]);var Ew="M7,4,2.3-.3,6.6-5a1.2,1.2,0,0,0,0-1.5l-.4-.3a1,1,0,0,0-1.4,0L0-2.5-4.8-6.8a1,1,0,0,0-1.4,0l-.4.3A1.2,1.2,0,0,0-6.6-5L-2.3-.3-7,4a1.1,1.1,0,0,0-.1,1.4l1.5,1.4a.9.9,0,0,0,1.3,0L0,2.1,4.3,6.8a.9.9,0,0,0,1.3,0L7.1,5.4A1.1,1.1,0,0,0,7,4Z",Am="M7.7-5.7l-.2-.4-.3-.2c-.1-.1-.3,0-.4,0A36.6,36.6,0,0,0-3,2.1,36.1,36.1,0,0,0-7.8-.8h-.5l-1,.9a.4.4,0,0,0-.1.3c0,.2,0,.3.1.4a72.1,72.1,0,0,1,6.6,7h.4l.4-.2C1.9,1,3.8-1.8,7.5-5.2,7.7-5.3,7.7-5.5,7.7-5.7Z",km={fill:"none",style:"touch-action: none",stroke:m.green},Vm=class{constructor(t){this.$el=h("g",{});this.$ring=h("circle",j({opacity:.6},km),this.$el);this.$burst=h("path",km,this.$el);this.$mark=h("g",{class:"problem-marker"},this.$el);this.$circle=h("circle",{r:13},this.$mark);this.$cross=h("path",{d:Ew,fill:"white"},this.$mark);this.$check=h("path",{d:Am,fill:"white"},this.$mark);this.isAnimating=!1;t.append(this.$el)}show(t=!1,e=!0){this.$cross.toggle(!t),this.$check.toggle(t),this.$circle.setAttr("fill",t?m.green:m.red),this.$mark.addClass("show"),e&&t&&this.burst()}hide(){this.$mark.removeClass("show")}burst(t=1e3,e=60,s=20){return R(this,null,function*(){this.isAnimating||(this.isAnimating=!0,yield X(n=>{let o=rt("sine-out",n);this.$ring.setAttr("r",.6*o*e),this.$ring.setAttr("stroke-width",.25*(1-o)*e);let r=rt("exp-out",n),a=(.4+.6*r)*e,l=(.1+.9*r)*e,c="";for(let p=0;p<s;++p){let u=Math.cos(D*p/s),f=Math.sin(D*p/s);c+=`M${u*l} ${f*l}L${u*a} ${f*a}`}this.$burst.setAttr("d",c)},t).promise,this.isAnimating=!1)})}},_n=class extends T{constructor(t,e,s){super(e,s);this.type="question-blank";this.size=100;this.canRotate=!1;this.solution="";this.submitted="";this.attempts=0;this.correct=!1;this.options=t||"Pw::0";let[n,o,r]=this.options.split(":");this.solution=atob(n),this.submitted=o,this.attempts=+r||0,this.$box=h("rect",{class:"problem-box",rx:6},this.$el),this.$text=h("text",{class:"problem-text",text:this.text,y:36},this.$el),this.mark=new Vm(this.$el),this.$input=h("input",{class:"problem-text"},e.$html),this.$input.onKeyDown("enter",()=>this.$input.blur()),this.$input.on("blur",()=>this.blur()),this.$parent.canEditQuestions?(this.$handle=this.makeHandle("c",a=>this.setSize(a.x)),this.$handle.css("cursor","ew-resize")):(this.$input.setInputPattern(this.solution),this.checkAnswer(!1),this.canMove=!1),this.setSize(100),this.setOrder("front")}setSize(t){var e;super.setSize(ht(S(t,50,400),25)),this.path=new x($,this.size,50),this.$input.css({width:this.size+"px",height:"50px"}),this.$box.setRect(this.path),this.$text.setAttr("x",this.size/2),this.mark.$el.setTransform({x:this.size,y:0}),(e=this.$handle)==null||e.setCenter({x:this.size,y:50}),this.transform()}hideForThumbnail(t){this.$text.text=t?this.text:"?"}delete(){super.delete(),this.$input.remove()}get text(){return(this.$parent.canEditQuestions?this.solution:this.submitted)||"?"}click(){this.isFocussed||this.$parent.events.shiftKey||this.correct&&!this.$parent.canEditQuestions||(this.isFocussed=!0,this.$parent.selection.add(this,!0),setTimeout(()=>{this.$el.removeClass("correct incorrect"),this.mark.hide()}),this.$input.css({top:this.posn.y+"px",left:this.posn.x+"px"}),this.$input.value=this.text,this.$text.hide(),this.$input.show(),this.$input.focus(),document.execCommand("selectAll",!1))}blur(){if(!this.isFocussed)return;this.isFocussed=!1,this.$input.hide(),this.$text.show();let t=this.text,e=this.$input.value.trim();this.$parent.canEditQuestions?(this.solution=e,this.options=`${btoa(e)}::0`):(e&&e!==this.submitted&&(this.attempts+=1),this.submitted=e==="?"?"":e,this.options=`${btoa(this.solution)}:${e}:${this.attempts}`,setTimeout(()=>{this.checkAnswer(),_n.gradeWorksheet(this.$parent)})),this.$text.text=this.text,this.text!==t&&this.$parent.change({changed:[this]})}isCorrect(){if(!this.submitted||!this.solution)return!1;if(this.submitted.toLowerCase()===this.solution.toLowerCase())return!0;let t=Qs(this.solution),e=Qs(this.submitted);return P(e,t)||ds(t)===this.submitted||this.solution===ds(e)}checkAnswer(t=!0){this.correct=this.isCorrect(),this.submitted&&this.mark.show(this.correct,t),this.$el.setClass("correct",this.correct),this.$el.setClass("incorrect",!!this.submitted&&!this.correct)}static gradeWorksheet(t){let e=[0,0,0,0];for(let s of t.getTilesOfType("question-blank"))e[0]+=1,!!s.submitted&&(e[s.correct?s.attempts<=1?1:2:3]+=1);e[0]===e[1]+e[2]&&Hi()}static makeThumbnail(t,e){let s=h("svg",{width:130,height:70},e);h("rect",{x:15,y:15,width:100,height:50,class:"problem-box",rx:6},s),h("text",{x:65,y:50,text:"?",class:"problem-text"},s),h("circle",{cx:115,cy:15,r:13,fill:m.blue},s),h("path",{d:Am,fill:"white",transform:"translate(115 15)"},s)}};var Om=le(so),Jh=class extends T{constructor(t,e,s){super(e,s);this.type="image";this.path=new x($,0,0);this.aspectRatio=1;this.options=t,this.$image=h("image",{href:t,crossorigin:"anonymous"},this.$el),this.$outline=h("path",{class:"outline"},this.$el),Om(t).then(n=>{this.aspectRatio=n.height/n.width,this.setSize(this.size||n.width)}),this.$handle=this.makeHandle("c",n=>this.setSize(n.x)),this.$handle.css("cursor","nwse-resize")}setHref(t){this.options=t,this.$image.setAttr("href",t),Om(t)}setSize(t){let e=Math.max(50,50*this.aspectRatio),s=Math.min(1e3,1e3/this.aspectRatio);this.size=S(t,e,s),this.$image.setAttr("width",this.size),this.$image.setAttr("height",this.aspectRatio*this.size),this.path=new x($,this.size,this.aspectRatio*this.size),this.$outline.draw(this.path),this.$handle.setCenter({x:this.size,y:this.aspectRatio*this.size}),this.transform(),this.$parent.selection.update()}};var Aw={bold:"font-weight",italic:"font-style",underline:"text-decoration",colour:"color"};function Lm(i,t){return i.style.getPropertyValue(t)||""}function Rm(i,t,e){i.style.setProperty(t,e)}function kw(i,t){t==="font-weight"||t==="font-style"?i.style.setProperty(t,"normal"):t==="text-decoration"?i.style.setProperty(t,"none"):i.style.removeProperty(t)}var tc=class extends T{constructor(t,e,s){super(e,s);this.type="text";this.size=0;this.creating=!1;this.$box=h("rect",{fill:"transparent"},this.$el),this.$foreignObject=h("foreignObject",{x:this.posn.x,y:this.posn.y,width:1,height:1,overflow:"visible"},this.$el),this.$text=h("div",{class:"text-edit",style:"pointer-events: none",xmlns:"http://www.w3.org/1999/xhtml"},this.$foreignObject),this.$outline=h("path",{class:"outline"},this.$el),this.options=this.$text.html=vu(t)||"Text",this.setColour(e.state.penColor),this.setOrder("front"),this.updateOutline(),this.$text.on("pointerdown",n=>n.handled=!0),this.$text.on("keydown",n=>this.interceptKeys(n)),this.$text.on("blur",()=>this.blur())}setSize(t){super.setSize(S(t,-5,10)),this.$text.css("font-size",20*1.2**this.size+"px"),this.updateOutline()}setColour(t){if(this.isFocussed)return this.formatFont("color",t);this.colour=t,this.$text.css("color",E(this.colour))}getSnapPoints(){return[]}updateOutline(){let t=this.$text.width,e=this.$text.height;this.$foreignObject.setAttr("width",t||1),this.$foreignObject.setAttr("height",e||1),this.path=new x($,t,e),this.$box.setRect(this.path),this.$outline.draw(this.path),this.transform()}selectAll(){let t=this.selection,e=document.createRange();e.selectNodeContents(this.$text._el),t==null||t.removeAllRanges(),t==null||t.addRange(e)}format(t){this.formatFont(Aw[t]||"",t),this.cleanupElements(this.$text._el.children),this.updateOutline(),this.options=this.$text.html}get selection(){var e,s;return(((s=(e=this.$el._el).getRootNode)==null?void 0:s.call(e))||document).getSelection()}formatFont(t,e){if(!this.isFocussed){let o=new Range,r=this.$text._el.childNodes;return o.setStartBefore(r[0]),o.setEndAfter(r[r.length-1]),this.formatRange(o,t,e)}let s=this.selection;if(!s)return;let n=[];for(let o=0;o<s.rangeCount;++o){let r=s.getRangeAt(o);this.formatRange(r,t,e),n.push(s.getRangeAt(o))}s.removeAllRanges();for(let o=0;o<n.length;++o)s.addRange(n[o])}formatRange(t,e,s){let n=t==null?void 0:t.extractContents().childNodes;if(!n)return;let o=t.commonAncestorContainer;(o==null?void 0:o.nodeName)==="#text"&&o.parentNode&&(o=o.parentNode),this.removeEmptyTextNodes(n),this.wrapChildrenInSpans(o,n,e),this.updateRangeChildren(n,e,s);for(let r=n.length-1;r>=0;--r)t.insertNode(n[r])}removeEmptyTextNodes(t){for(let e=0;e<t.length;e++){let s=t[e];s.nodeName==="#text"&&!s.nodeValue&&s.remove()}}wrapChildrenInSpans(t,e,s){for(let n=0;n<e.length;++n){let o=e[n];if(o.nodeName==="#text"){let r=document.createElement("span");t.nodeName==="SPAN"&&Rm(r,s,Lm(t,s)),r.appendChild(document.createTextNode(o.nodeValue||"")),o.replaceWith(r)}}}updateRangeChildren(t,e,s){if(s==="smaller"||s==="larger"){let n=t[0],o=parseFloat(n.style.fontSize)||100,r=(s==="smaller"?1/1.2:1.2)*o;this.setChildrenStyles(t,"font-size",r+"%")}else this.allChildrenHaveStyle(t,e,s)?this.unsetChildrenStyles(t,e):this.setChildrenStyles(t,e,s)}allChildrenHaveStyle(t,e,s){for(let n=0;n<t.length;++n){let o=t[n];if(Lm(o,e)!==s||!this.allChildrenHaveStyle(o.children,e,s))return!1}return!0}unsetChildrenStyles(t,e){for(let s=0;s<t.length;++s){let n=t[s];kw(n,e),this.unsetChildrenStyles(n.children,e)}}setChildrenStyles(t,e,s){for(let n=0;n<t.length;++n){let o=t[n];Rm(o,e,s),this.clearChildrenStyles(o.children,e)}}clearChildrenStyles(t,e){for(let s=0;s<t.length;++s){let n=t[s];n.style.removeProperty(e),this.clearChildrenStyles(n.children,e)}}cleanupElements(t){for(let e=0;e<t.length;++e)this.cleanupElements(t[e].children);for(let e=0;e<t.length;++e)t[e].textContent||t[e].remove();for(let e=0;e<t.length;++e)t[e].getAttribute("style")||t[e].replaceWith(...Array.from(t[e].childNodes))}doubleClick(){this.focus()}focus(t=!1){this.isFocussed||(super.focus(),this.creating=t,this.$text.css("pointer-events","all"),this.$text.setAttr("contenteditable",!0),this.$text.focus(),this.selectAll())}blur(){var s;if(!this.isFocussed)return;super.blur(),this.$text.css("pointer-events","none"),this.$text.removeAttr("contenteditable");let t=this.$text.html,e=this.options!==t;if(t){this.$text.show(),this.options=t,this.updateOutline();let n=this.creating?"added":"changed";(this.creating||e)&&this.$parent.change({[n]:[this]})}else this.delete(),this.creating||this.$parent.change({deleted:[this]});(s=this.selection)==null||s.removeAllRanges()}interceptKeys(t){if(t.key==="Escape"){this.$text.blur(),setTimeout(()=>this.$parent.selection.add(this));return}if(this.path=new x($,this.$text.width,this.$text.height),this.transform(),this.$parent.trigger("change-focus",{tiles:[this]}),!(t.ctrlKey||t.metaKey))return;let s={b:"bold",i:"italic",u:"underline"}[t.key];s&&(t.stopPropagation(),t.preventDefault(),this.format(s))}};I([["Bold","bold"],["Italic","italic"],["Underline","underline"]].map(([i,t])=>({type:"button",label:i,icon:t,tileTypes:["text"],focus:"showAlways",noDivider:t!=="underline",click:(e,s,n)=>{for(let o of e)o.format(t);n||s.change({changed:e})}})));I(["Grow","Shrink"].map((i,t)=>({type:"button",label:i,icon:t?"font-shrink":"font-grow",tileTypes:["text","equation"],focus:"showAlways",noDivider:!t,show:(e,s)=>!s||e.every(n=>n.is("text")),click:(e,s,n)=>{if(n)for(let o of e)o.format(t?"smaller":"larger");else{for(let o of e){let r=o.path.h;o.setSize(o.size+(t?-1:1));let a=o.path.h;o.setTransform(o.posn.shift(0,r-a))}s.change({changed:e})}}})));function Qt(i){return!!i.setValue}function Im(i,t){let e=i;for(let s of i.parents()){if(s.type in t&&s.children.indexOf(e)===t[s.type])return s;e=s}}function Vw(i,t){for(let e of i.parents(!0))for(let s of t.parents(!0))if(e===s)return s}function Nm(i,t,e=!1){let s=e?i.children.slice(0).reverse():i.children,n=t.parent;return s.findIndex((o,r)=>n.hasParent(a=>a===o)||Qt(n)&&n===o||i===n&&(e?s.length-r:r)===t.offset)}var ec=class{constructor(t){this.equation=t;this.offset=0;this.$el=h("line",{class:"cursor",hidden:!0},t.$row),this.$range=h("rect",{class:"range",hidden:!0}),t.$row.prepend(this.$range),this.parent=t.root}redraw(){let t=this.getRangeRect();if(this.$el.toggle(!t),this.$range.toggle(!!t),t)this.$range.setRect(t);else{this.selected=void 0;let e=this.getCursorLine();e&&this.$el.setLine(...e),this.$el.restartAnimation()}}hide(){this.$el.hide(),this.$range.hide(),this.clearRange()}startRange(){this.start={parent:this.parent,offset:this.offset}}clearRange(){this.selected=void 0,this.start=void 0}moveToPoint(t){let e=this.equation.root.hitTest(t)||this.equation.root,s=e.worldTransform,n=(t.x-s.x)/(e.width*s.scale);Qt(e)?this.moveInto(e,Math.round(n*e.value.length)):n<.5?this.moveBefore(e):this.moveAfter(e)}getRangeRect(){if(!this.start||this.start.parent===this.parent&&this.start.offset===this.offset)return;let t=Vw(this.parent,this.start.parent),e=[t];if(t.children.length){let s=Nm(t,this.start),n=Nm(t,this);n<s&&([s,n]=[n,s]),(s>0||n<t.children.length-1)&&(e=t.children.slice(s,n+1)),e.length||(e=[t]),(s<0||n<0)&&t.type==="mrow"&&t.parent&&(e=[t.parent]),e.length===1&&e[0].type==="mrow"&&(e=e[0].children.slice(0))}return this.selected=e,x.aroundPoints(hs(e,s=>{let n=s.worldTransform;return[n,{x:n.x+s.width*n.scale,y:n.y+s.height*n.scale}]}))}getCursorLine(){let t=Qt(this.parent)?this.parent:this.prev||this.next;if(!t)return;let e=t.worldTransform,s=t.height*e.scale,n=-1;return Qt(this.parent)?n=t.width*e.scale*this.offset/t.value.length:this.prev&&(n=this.prev.width*e.scale+1),[{x:e.x+n,y:e.y+2},{x:e.x+n,y:e.y+s-2}]}moveAfter(t){if(t.type==="mrow")return this.moveAfter(_(t.children));if(!t.parent)throw new Error("Move cursor to unattached node");this.parent=t.parent,this.offset=this.parent.children.indexOf(t)+1}moveBefore(t){if(t.type==="mrow")return this.moveBefore(t.children[0]);if(!t.parent)throw new Error("Move cursor to unattached node");this.parent=t.parent,this.offset=this.parent.children.indexOf(t)}moveInto(t,e){if(Qt(t)){if(e<=0)return this.moveBefore(t);if(e>=t.value.length)return this.moveAfter(t)}this.parent=t,this.offset=e}get prev(){return this.parent.children[this.offset-1]}get next(){return this.parent.children[this.offset]}handleShift(t,e=!1){if(t&&!this.selected)this.startRange();else if(!t&&this.selected)return e?this.moveBefore(this.selected[0]):this.moveAfter(_(this.selected)),this.clearRange(),!0;this.selected&&this.parent!==this.selected[0].parent&&this.moveAfter(_(this.selected))}left(t){if(this.handleShift(t,!0))return;if(this.selected)return this.offset-=1;if(Qt(this.parent))return this.moveInto(this.parent,this.offset-1);let e=this.prev;if(e)return Qt(e)?this.moveInto(e,e.value.length-1):e.children.length?this.moveAfter(_(e.children)):this.moveBefore(e);let s=this.parent,n=(s==null?void 0:s.type)==="mrow";if(n&&(s==null?void 0:s.prev))return this.moveAfter(s.prev);let o=n?s.parent:s;o&&this.moveBefore(o)}right(t){if(this.handleShift(t))return;if(this.selected)return this.offset+=1;if(Qt(this.parent))return this.moveInto(this.parent,this.offset+1);let e=this.next;if(e)return Qt(e)?this.moveInto(e,1):e.children.length?this.moveBefore(e.children[0]):this.moveAfter(e);let s=this.parent,n=(s==null?void 0:s.type)==="mrow";if(n&&(s==null?void 0:s.next))return this.moveBefore(s.next);let o=n?s.parent:s;o&&this.moveAfter(o)}up(t){this.selected&&this.clearRange();let e=Im(this.parent,{mfrac:1,msub:1,msup:0});(e==null?void 0:e.type)==="mfrac"&&this.moveAfter(_(e.children[0].children)),(e==null?void 0:e.type)==="msub"&&this.moveAfter(_(e.children[0].children)),(e==null?void 0:e.type)==="msup"&&this.moveBefore(e.children[1].children[0])}down(t){this.selected&&this.clearRange();let e=Im(this.parent,{mfrac:0,msub:0,msup:1});(e==null?void 0:e.type)==="mfrac"&&this.moveBefore(e.children[1].children[0]),(e==null?void 0:e.type)==="msub"&&this.moveBefore(e.children[1].children[0]),(e==null?void 0:e.type)==="msup"&&this.moveAfter(_(e.children[0].children))}backspace(){var o;if(this.selected){this.moveBefore(this.selected[0]);for(let r of this.selected)r.deleteFromDom();this.clearRange(),this.parent.children.length||this.parent.addChildren([this.placeholder]);return}if(Qt(this.parent)){let r=this.parent.value;return this.setText(r.slice(0,this.offset-1)+r.slice(this.offset)),this.moveInto(this.parent,this.offset-1)}let t=this.prev;if(t)return Qt(t)&&t.value.length>1?t.setValue(t.value.slice(0,t.value.length-1)):t.type==="placeholder"||t.children.length?this.left():(t.deleteFromDom(),this.parent.children.length||this.parent.addChildren([this.placeholder]),this.moveInto(this.parent,this.offset-1));let e=this.parent,s=e.children,n=0;e.type==="mrow"&&e.parent&&(n=((o=e.prev)==null?void 0:o.children.filter(r=>r.type!=="placeholder").length)||0,e=e.parent,s=qt((e==null?void 0:e.children.map(r=>r.children))||[])),!!(e==null?void 0:e.parent)&&(this.moveInto(e.parent,e.index+n),e.insertAfter(s.filter(r=>r.type!=="placeholder")),e.deleteFromDom(),this.parent.children.length||this.parent.addChildren([this.placeholder]))}get placeholder(){return new Oo(this.equation)}setText(t,e){if(!e&&Qt(this.parent)&&(e=this.parent),!!e){if(t in yi&&(t=yi[t]),t==="sqrt"){let s=this.createNode("msqrt");return e.insertAfter([s]),e.deleteFromDom(),this.moveBefore(s.children[0].children[0])}e.setValue(t)}}createNode(t,e){let s=Be(this.equation,e||[this.placeholder]);if(t==="mfenced")return new dn([s],this.equation);if(t==="msqrt")return new Vs(t,[s],this.equation);let n=Be(this.equation,[this.placeholder]);if(t==="mfrac")return new Lo([s,n],this.equation);if(t==="mroot")return new Vs(t,[s,n],this.equation);if(t==="msub"||t==="msup")return new ks(t,[s,n],this.equation)}splitTextNode(){let t=this.parent,e=t.value.slice(this.offset);t.setValue(t.value.slice(0,this.offset)),t.insertAfter([new Ki(t.type,e,this.equation)]),this.moveAfter(t)}insert(t,e){var n,o,r,a,l;let s=((n=this.prev)==null?void 0:n.type)==="placeholder";if(Qt(this.parent)&&!this.start&&!this.selected){let c=this.parent.value;((o=this.parent)==null?void 0:o.type)===t?(this.setText(c.slice(0,this.offset)+e+c.slice(this.offset)),this.moveInto(this.parent,this.offset+1)):(this.splitTextNode(),this.insert(t,e))}else if(t==="mi"||t==="mn"||t==="mtext")this.selected&&this.backspace(),((r=this.prev)==null?void 0:r.type)===t?this.setText(this.prev.value+e,this.prev):((a=this.next)==null?void 0:a.type)===t?(this.setText(e+this.next.value,this.next),this.moveInto(this.next,1)):(this.parent.addChildren([new Ki(t,e,this.equation)],this.offset),s||(this.offset+=1));else if(t==="mo"||t==="mspace"){this.selected&&this.backspace();let c=t==="mo"?new Ki("mo",e,this.equation):new Vo(this.equation);this.parent.addChildren([c],this.offset),s||(this.offset+=1)}else{let c=t==="msub"||t==="msup"||t==="mfrac"&&((l=this.prev)==null?void 0:l.type)!=="mo",p=this.selected||(c&&this.prev?[this.prev]:void 0);p&&this.moveBefore(p[0]),this.selected&&this.clearRange();let u=this.createNode(t,p);this.parent.addChildren([u],this.offset),this.moveBefore(u.children[p&&u.children.length>1?1:0].children[0])}}toSubSup(t){let e=this.placeholder,s=t.type==="msub"?2:1;t.addChildren([Be(this.equation,[e])],s),t.type="msubsup",this.moveBefore(e)}type(t){var e,s,n,o,r,a;if(t=t.replace("*","\xD7").replace("-","\u2212"),t.match(/^[A-Za-zπ]$/))this.insert("mi",t);else if("0123456789.".includes(t))this.insert("mn",t);else if("+\u2212\xB1\xD7\xF7<>\u2264\u2265=%!".includes(t))this.insert("mo",t);else if(t===" "){let l=(e=this.prev)==null?void 0:e.type,c=(s=this.next)==null?void 0:s.type;if(l==="placeholder"||l==="mspace"||c==="placeholder"||c==="mspace"||!Qt(this.parent)&&l!=="mi"&&c!=="mi")return;this.insert("mspace")}else if(t==="frac"||t==="/")this.insert("mfrac",t);else if(t==="sqrt")this.insert("msqrt",t);else if(t==="^"||t==="sup"){if(((n=this.prev)==null?void 0:n.type)==="msub")return this.toSubSup(this.prev);this.insert("msup",t)}else if(t==="_"||t==="sub"){if(((o=this.prev)==null?void 0:o.type)==="msup")return this.toSubSup(this.prev);this.insert("msub",t)}else if(t==="brackets"||"([{|".includes(t))this.insert("mfenced",t);else if(")]}".includes(t))if(((a=(r=this.parent)==null?void 0:r.parent)==null?void 0:a.type)==="mfenced")this.moveAfter(this.parent.parent);else{let l=this.prev;this.parent.addChildren([this.createNode("mfenced",l?[l]:void 0)],this.offset),l||(this.offset+=1)}}copy(){return this.selected?this.selected.map(t=>t.expr).join(""):""}paste(t){try{let e=this.equation.parse(t);if(this.selected&&this.backspace(),e.length===1&&Qt(e[0]))return this.insert(e[0].type,e[0].value),e[0].deleteFromDom();Qt(this.parent)&&this.splitTextNode(),this.parent.addChildren(e,this.offset),this.moveAfter(_(e))}catch(e){}}};var Gm=class{constructor(t,e,s=!0){this.$el=h("g",{class:"equation","font-size":"20px"},t),this.equation=new Ee(this.$el,void 0,0,"",20,s);try{this.equation.setValue(e)}catch(n){console.warn("Parsing error",e,n.message)}}get expr(){return kt.parse(this.equation.root.expr).collapse()}get width(){return this.equation.root.width}get height(){return this.equation.root.height}},Dm=class extends Gm{constructor(t,e,s,n=!0){super(e,s,n);this.tile=t;this.cursor=new ec(this.equation),this.$textarea=h("textarea",{class:"hidden-input",tabindex:-1},t.$parent),this.$textarea.on("key",o=>this.handleKey(o)),this.$textarea.on("blur",()=>t.blur()),this.$textarea.on("cut copy",o=>{var r;(r=window.navigator.clipboard)==null||r.writeText(this.cursor.copy()),o.type==="cut"&&(this.cursor.backspace(),this.redraw())}),this.$textarea.on("paste",()=>R(this,null,function*(){var r;let o=yield(r=window.navigator.clipboard)==null?void 0:r.readText();!o||(this.cursor.paste(o),this.redraw())}))}redraw(){this.equation.resize(),this.tile.transform(),this.cursor.redraw(),this.tile.$parent.trigger("change-focus",{tiles:[this.tile]})}bindSlideEvents(t,e){this.tile.$parent.events.listen(this.tile.$el,{down:s=>{s.event.preventDefault(),this.cursor.clearRange(),this.moveCursor(t(s))},start:()=>this.cursor.startRange(),move:s=>this.moveCursor(t(s)),blurInput:!1,checkIfActive:e})}handleKey(t){var e;if(!((e=this.excludedChars)==null?void 0:e.includes(t.char))){if(t.code===ne.enter||t.code===ne.escape){this.$textarea.blur(),setTimeout(()=>this.tile.$parent.selection.add(this.tile,!0));return}else if(t.code===ne.left)this.cursor.left(t.shift);else if(t.code===ne.right)this.cursor.right(t.shift);else if(t.code===ne.up)this.cursor.up(t.shift);else if(t.code===ne.down)this.cursor.down(t.shift);else return t.code===ne.backspace||t.code===ne.delete?(this.cursor.backspace(),this.redraw()):(this.cursor.type(t.char),this.redraw());this.cursor.redraw()}}moveCursor(t){this.cursor.moveToPoint(t||$),this.cursor.redraw()}focus(){this.$textarea.show(),this.$textarea.focus()}blur(){return this.cursor.hide(),this.$textarea.hide(),this.equation.updateDescription(),this.equation.root.expr}delete(){this.$el.remove(),this.$textarea.remove()}},ic=class extends T{constructor(t,e,s){super(e,s);this.type="equation";this.size=0;this.linkTypes=["axes"];this.creating=!1;this.options=t||"placeholder",this.$box=h("rect",{fill:"transparent"},this.$el),this.$outline=h("rect",{class:"outline"},this.$el),this.$resultText=h("text",{opacity:.5,style:"font-size: 13px"},this.$el),this.watchPolypadOptions(n=>{var o;this.$resultText.toggle(n.evalEquations),(o=this.watcher)==null||o.call(this)}),this.equationArea=new Dm(this,this.$el,this.options),this.equationArea.bindSlideEvents(n=>this.getCursorOffset(n),()=>!!this.isFocussed),this.setOrder("front"),this.makeOutPort("main",{tileTypes:["axes"],connect:n=>n.enqueueMessage({type:"equation",text:this.options})}),this.transform(),this.setColour(e.state.penColor),this.updateMath()}setSize(t){super.setSize(S(t,-5,10)),this.equationArea.$el.css("transform",this.size?`scale(${this.scale})`:""),this.$resultText.css("font-size",13*this.scale+"px"),this.transform()}get scale(){return 1.2**this.size}doubleClick(t){this.focus(!1,t)}customTransform(){let t=this.equationArea.width*this.scale+16,e=this.equationArea.height*this.scale+12;this.path=new x($.shift(-8,-6),t,e);for(let s of[this.$box,this.$outline])s.setRect(this.path);this.$resultText.setTransform({x:0,y:e+10*this.scale-6})}setColour(t){super.setColour(t),this.equationArea.$el.css("color",E(this.colour)),this.$resultText.setAttr("fill",E(this.colour)),this.emitMessage("main",{type:"equation",text:this.options})}delete(){super.delete(),this.equationArea.delete()}getSnapPoints(){return[]}focus(t=!1,e){this.isFocussed||(super.focus(),this.creating=t,this.showErrorIcon(void 0),this.$el.css("cursor","text"),this.equationArea.focus(),this.equationArea.moveCursor(this.getCursorOffset(e)))}blur(){if(!this.isFocussed)return;super.blur(),this.$el.css("cursor","grab");let t=this.options;if(this.options=this.equationArea.blur(),this.updateMath(),this.creating||t!==this.options){let e=this.creating?"added":"changed";this.$parent.change({[e]:[this]}),this.emitMessage("main",{type:"equation",text:this.options})}}updateMath(){let t=this.$parent.mathContext;this.watcher&&t.unwatch(this.watcher);let e=t.attemptUpdateSource(this,this.options);if(!e){this.watcher=void 0,this.value=0;return}let s=Fs(e)[1]instanceof si,n=()=>{let{error:o,value:r}=t.evaluate(e);if(this.showErrorIcon(this.$parent.options.evalEquations?o:void 0),this.value=r||0,s||isNaN(r))return this.$resultText.textStr="";this.$resultText.textStr=`= ${nt(r,8)}`};this.watcher=n,t.watch(e.unknowns,n,!0)}getCursorOffset(t){return t?this.relativePosn(t.posn).scale(1/this.scale):$}};I([["Fraction","fraction","frac"],["Exponent","power","sup"],["Square Root","sqrt","sqrt"]].map(([i,t,e])=>({type:"button",label:i,icon:t,tileTypes:["equation"],focus:"show",click:s=>s[0].equationArea.handleKey({char:e})})));var Mi,Hn=new Map;function Ow(i){return R(this,null,function*(){if(Mi||(Mi=new AudioContext),Hn.has(i))return Hn.get(i);let t=yield fetch(i).then(s=>s.arrayBuffer()),e=yield Mi.decodeAudioData(t);return Hn.set(i,e),e})}function Lw(i,t=.2){return R(this,null,function*(){if(!Mi)return;yield Mi.resume();let e=Mi.createBufferSource();e.buffer=i;let s=Mi.createGain();s.gain.value=t,e.connect(s).connect(Mi.destination),e.start()})}var Ei="/polypad/assets/audio/instruments",sc={perc:{name:"Perc",url:`${Ei}/perc.mp3`},snare:{name:"Snare",url:`${Ei}/snare.mp3`},clap:{name:"Clap",url:`${Ei}/clap.mp3`},kick:{name:"Kick",url:`${Ei}/kick.mp3`},openHat:{name:"Open Hat",url:`${Ei}/open.mp3`},closedHat:{name:"Closed Hat",url:`${Ei}/closed.mp3`},tomHigh:{name:"High Tom",url:`${Ei}/tom-high.mp3`},tomLow:{name:"Low Tom",url:`${Ei}/tom-low.mp3`}},qn=50,nc=class extends T{constructor(t,e,s){super(e,s);this.type="logic-speaker";this.model=mt({soundName:"kick"});this.path=new x($,qn,qn),this.$body=h("rect",{rx:5},this.$el),this.$body.setRect(this.path),this.$outline=h("rect",{class:"outline",rx:5},this.$el),this.$outline.setRect(this.path);let n=h("use",{href:"/icons.svg#audio",fill:"#fff",width:36,height:36,x:9,y:7},this.$el);this.setColour(m.yellow),this.model.soundName=t||"kick",this.model.watch(()=>R(this,null,function*(){this.options=this.model.soundName,Ow(sc[this.model.soundName].url)}));let o=()=>{let a=sc[this.model.soundName].url;n.effect("speaker-move"),Hn.has(a)&&Lw(Hn.get(a))},r=0;this.makeInPort("main",{location:[new d(0,qn/2),Math.PI],message:a=>{a.type==="number"&&(a.value===1&&!r&&o(),r=a.value)},disconnect:()=>r=0,max:1,tileTypes:We})}setColour(t,e){super.setColour(t,e),this.$body.setAttr("fill",t)}static makeThumbnail(t,e){let s=h("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},e);h("rect",{fill:m.yellow,rx:5,width:50,height:50},s),h("use",{href:"/icons.svg#audio",fill:"#fff",width:36,height:36,x:7,y:7},s)}};I([{type:"select",tileTypes:["logic-speaker"],label:"Sound:",options:Object.entries(sc).map(([i,t])=>({key:i,label:t.name})),get:i=>i.model.soundName,set:(i,t)=>t.model.soundName=i}]);var _m="M37.9,37.8,30.5,9.5,25,8,19.5,9.5,12.1,37.8s-.1.6-.1.8A3.3,3.3,0,0,0,15.2,42H34.8A3.3,3.3,0,0,0,38,38.6C38,38.4,37.9,37.8,37.9,37.8ZM16.7,32,22,11.9l3-.8,3,.8L33.3,32Z",oc=class extends T{constructor(t,e,s){super(e,s);this.type="logic-metronome";this.path=new x($,qn,qn);this.$body=h("rect",{rx:5},this.$el),this.$body.setRect(this.path),this.$outline=h("rect",{class:"outline",rx:5},this.$el),this.$outline.setRect(this.path),h("path",{d:_m,fill:"white"},this.$el),this.$handle=h("rect",{fill:"white",x:22.5,y:14,width:5,height:22,rx:3,"stroke-width":2,style:"transform-origin:center 100%;transform-box:fill-box;"},this.$el),h("rect",{fill:"white",x:18,y:32,width:14,height:10},this.$el),this.makeOutPort("main",{highlights:!0,location:this.path,persistent:!0,tileTypes:We}),this.setColour(m.purple),this.options=t||'{"bpm":120}',this.model=mt(JSON.parse(this.options)),this.model.running=!1;let n=()=>this.emitMessage("main",{type:"number",value:1}),o=()=>this.emitMessage("main",{type:"number",value:0}),r,a=Date.now(),l,c=()=>{!this.model.running||(Date.now()>=l*1e3+a&&(a=Date.now(),n(),window.setTimeout(o,50),r=window.setTimeout(c,l*1e3)),requestAnimationFrame(c))};this.model.watchAll(()=>{this.options=JSON.stringify(this.model),r&&clearTimeout(r),l=60/(this.model.bpm||120),o(),this.model.running&&c(),this.$handle.css("animation",this.model.running?`metronome infinite ${l}s ease-in-out`:"")})}setColour(t,e){super.setColour(t,e),this.$body.setAttr("fill",t),this.$handle.setAttr("stroke",t)}static makeThumbnail(t,e){let s=h("svg",{width:40,height:44,viewBox:"0 0 50 55",style:"margin:0 16px"},e);h("rect",{fill:m.purple,rx:5,width:50,height:50},s),h("path",{d:_m,fill:"white"},s),h("rect",{fill:"white",x:22.5,y:14,width:5,height:22,rx:3,"stroke-width":2,stroke:m.purple},s),h("rect",{fill:"white",x:18,y:32,width:14,height:10},s)}};I([{type:"button",icon:"play",label:"Play",tileTypes:["logic-metronome"],show:i=>i.every(t=>!t.model.running),click:i=>{for(let t of i)t.model.running=!0}},{type:"button",icon:"pause",label:"Pause",tileTypes:["logic-metronome"],show:i=>i.some(t=>t.model.running),click:i=>{for(let t of i)t.model.running=!1}},{type:"input",value:"number",label:"BPM:",tileTypes:["logic-metronome"],range:[10,200],get:i=>i.model.bpm,set:(i,t)=>t.model.bpm=S(Math.round(+i),1,240)}]);var Hm={"number-bar":eh,"number-tile":ir,polygon:K,pentomino:Nl,tangram:Gl,"fraction-bar":zs,"fraction-circle":vh,text:tc,"algebra-tile":kn,"log-bar":Eh,grid:yh,"custom-polygon":Rl,image:Jh,dice:$e,"polyhedral-dice":Oh,coin:Lh,"number-line":fh,"multi-jump":mh,penrose:Dl,kolam:_l,"prime-disk":Mn,balance:$h,"decimal-grid":ih,spinner:Nn,"custom-spinner":Nh,token:Ph,egg:Hl,geo:ae,fractal:Bl,ruler:Zl,protractor:Wl,compass:Yl,"set-triangle":Xl,"dot-machine":sh,dot:En,garden:zl,tantrix:Fl,axes:Ch,"question-blank":_n,equation:ic,"number-card":nh,card:js,abacus:oh,bucket:ah,table:Fh,pentagon:jl,domino:Gh,slider:Mh,"number-grid":lh,"number-frame":hh,"ten-frame":ch,"ten-frame-counter":dh,"number-dot":Vn,polyhedron:ss,chart:qh,"pie-chart":Bh,clock:jh,rectangle:Ql,random:_h,"reg-polygon":Jl,"box-whisker":zh,"logic-bulb":Kh,"logic-button":Zh,"logic-switch":Wh,"logic-gate":Uh,"chess-board":Dn,"chess-piece":mr,currency:Zs,"logic-display":Xh,"logic-speaker":nc,"logic-metronome":oc};function rc(i){if(!(i in Hm))throw new Error(`Unknown tile type: ${i}`);return Hm[i]}var qm,Bm,wr=new Set,ac=new Set;function Rw(i,t,e){let s=Rt(i-t,e);return s>e/2?s-e:s}var lc=class{constructor(t){this.$parent=t;this.angle=0;this.startAngle=0;this.hasChanged=!1;this.showTools=!1;this.isMoving=!1;this.tiles=new Set;this.implicitChanges=new Set;this.$tools=t.$(".transform-tools"),this.$shadow=t.$(".group-shadow"),this.$rect=this.$tools.$(".group-outline"),this.$rotateBar=this.$tools.$(".rotate-bar"),this.$rotateCircle=this.$tools.$(".rotate-circle"),t.events.listen(this.$rotateCircle,{start:()=>{this.startAngle=this.angle,this.rotateStart()},move:({startPosn:e,posn:s})=>{this.rotate(this.startAngle-new Ot(s,this.center,e).deg)},end:()=>this.rotateEnd()}),b.onKey("up down left right r R",(e,s)=>{if(!(e.metaKey||e.ctrlKey||!this.tiles.size)){if(s==="r"||s==="R"){if(Array.from(this.tiles).some(n=>n.fixed||!n.canRotate))return;this.rotateStart(),this.rotate(this.angle+(s==="R"?-15:15)),this.rotateEnd()}else{let n=$,o=e.shiftKey?5:25,r=s==="left"?-o:s==="right"?o:0,a=s==="up"?-o:s==="down"?o:0,l=n.shift(r,a);this.moveStart(),this.move({posn:l,startPosn:n}),this.moveEnd()}t.trigger("shift-selection")}}),b.onKey("escape",()=>this.clear())}get size(){return this.tiles.size}add(t,e=!1,s=!1){e&&this.clear(),!t.isActive&&this.$parent.tiles.has(t.id)&&this.select([t],s)}select(t,e=!1){var s;(s=this.$parent.focussedTile)==null||s.blur();for(let n of t)n.isActive||!this.$parent.tiles.has(n.id)||(this.tiles.add(n),n.select(),this.hasChanged=!0);e||this.update(!0)}remove(t,e=!1){!t.isActive||(t.deselect(),this.hasChanged=!0,this.tiles.delete(t),e||this.update(!0))}clear(){if(!this.isMoving){for(let t of this.tiles)t.deselect();this.tiles.size&&(this.hasChanged=!0),this.tiles.clear(),this.update(!0)}}getTileProperty(t){if(!this.size)return;let e=Array.from(this.tiles),s=t(e[0]);return e.slice(1).some(o=>t(o)!==s)?void 0:s}update(t=!1){if(t&&!this.hasChanged)return;if(this.hasChanged=!1,this.implicitChanges.clear(),!this.size){for(let l of[this.$shadow,this.$tools])l.hide();this.$parent.trigger("change-selection",{tiles:[],color:void 0});return}let e=Array.from(this.tiles).filter(l=>l.transformed);this.angle=this.getTileProperty(l=>l.rot)||0;let s=ri(...e.map(l=>l.transformed.rotate(-Z(this.angle)))),n=s.p.shift(s.w/2,s.h/2).rotate(Z(this.angle)).shift(-s.w/2,-s.h/2);this.rect=new x(n,s.w,s.h),this.center=this.rect.center;let o=!this.$parent.options.noRotating&&e.every(l=>l.canRotate&&!l.fixed);if(e.length===1&&ct(e[0].transformed)&&(o=!1),o&&this.getTileProperty(l=>l.rotateAroundOrigin)){let l=e[0].posn;e.slice(1).every(c=>c.posn.equals(l))&&(this.center=l,this.angle&&e.length===1&&(this.rect=ri(e[0].transformed.rotate(-Z(this.angle),l))))}this.$rotateBar.toggle(o),this.$rotateCircle.toggle(o);let r=this.size>1||e[0].showSelectionOutline;this.$rect.toggle(r),this.showTools=!this.getTileProperty(l=>l.hideSelectionOutline),this.$tools.toggle(this.showTools),this.$shadow.toggle(r&&this.showTools),(!o||!this.showTools)&&(this.rotateHandle=void 0),(this.size===1?e[0].$container:this.$parent.$svg).append(this.$tools),this.positionTools();let a=this.getTileProperty(l=>l.colour);this.$parent.trigger("change-selection",{tiles:e,color:a})}positionTools(){if(!this.showTools)return;let t=this.bounds;for(let n of[this.$shadow,this.$rect])n.draw(t);let e=new d(this.center.x,this.rect.p.y),s=new st(e,e.shift(0,-28)).rotate(Z(this.angle),this.center);this.$rotateBar.setLine(s.p1,s.p2),this.$rotateCircle.setCenter(s.p2),this.rotateHandle=s.p2}get bounds(){return this.rect.rotate(Z(this.angle),this.center)}moveStart(t=!1){for(let e of this.tiles)if(e.fixed||!e.canMove)return;this.isMoving=!0;for(let e of this.tiles)e.moveStart(t);this.startSnapPoints=[];for(let e of this.tiles)for(let s of e.snapPoints)this.startSnapPoints.some(n=>s.equals(n))||this.startSnapPoints.push(s);Bm=this.rect,qm=this.center,this.$parent.newTileShift=0,this.$parent.trigger("move-start")}move({posn:t,startPosn:e}){if(!this.isMoving)return;let s=t.subtract(e),n=this.startSnapPoints.map(a=>a.add(s)),o=this.$parent.snapping.snap(n);o&&(s=s.add(o.shift));let r=this.tiles.size===1?o:void 0;for(let a of this.tiles)a.move(s,r);this.rect=Bm.translate(s),this.center=qm.add(s),this.positionTools(),this.$parent.trigger("move-selection")}moveEnd(t=!1){if(!this.isMoving)return;for(let s of this.tiles)s.transform(),s.moveEnd();if(Pe(this.tiles,s=>s.type==="geo")&&this.$parent.snapping.updateIntersections(),this.$parent.trigger("move-end"),this.isMoving=!1,!this.tiles.size)return;let e=[...Array.from(this.tiles),...Array.from(this.implicitChanges)];this.$parent.change({[t?"added":"changed"]:e}),this.implicitChanges.clear()}rotateStart(){ac.clear();for(let t of this.tiles)for(let e of t.snapAngles)ac.add(Rt(e+t.rot,180));wr.clear(),wr.add(0);for(let t of this.$parent.tiles.values())if(!t.isActive&&!!Pe(this.tiles,e=>d.distance(e.posn,t.posn)<140))for(let e of t.snapAngles)wr.add(Rt(e+t.rot,180));this.$parent.newTileShift=0,this.$parent.trigger("rotate-start")}rotate(t){if(t=ht(t,3),t===this.angle)return;let e=Infinity;for(let n of ac)for(let o of wr){let r=Rw(o,n+t-this.startAngle,180);Math.abs(r)<Math.abs(e)&&(e=r)}if(Math.abs(e)<8&&(t+=e),t===this.angle)return;let s=t-this.angle;this.angle=t;for(let n of this.tiles)n.posn=n.posn.rotate(Z(s),this.center),n.rot=Rt(n.rot+s,360),n.transform(!0);this.positionTools(),this.$parent.trigger("rotate-selection")}rotateEnd(){for(let t of this.tiles)t.transform();this.$parent.change({changed:Array.from(this.tiles)}),this.$parent.trigger("rotate-end")}copy(){if(this.isMoving||!this.tiles.size||re.isMoving)return[];let t=Array.from(this.tiles).map(s=>s.serialize()),e=new Set;for(let s of this.tiles)if(s.is("geo")){for(let n of s.parents)if(!this.tiles.has(n)&&!e.has(n)&&n.geoType==="point"){let o=n.serialize(),r=n.path;o.options=`${n.key}=point(${r.x},${r.y})=${n.label}`,t.push(o),e.add(n)}}return t}delete(){var s;if(this.isMoving||this.$parent.options.noDeleting||re.isMoving)return;let t=Array.from(this.tiles).filter(n=>!n.fixed);if(!t.length)return;let e=new Set;for(let n of t){for(let o of hs(((s=n.inPorts)==null?void 0:s.values())||[],r=>r.cables))e.add(o.from.tile);n.delete()}t.some(n=>n.type==="geo")&&this.$parent.snapping.updateIntersections(),this.$parent.change({deleted:t,changed:Array.from(e).filter(n=>!t.includes(n))}),this.$parent.newTileShift=0}};var Ai=class{constructor(t){this.$parent=t}getTileAt(t){let e=this.$parent.snapping.snapGeo(t.posn);if((e==null?void 0:e.tile)&&e.tile.canSelect)return e.tile;let s=t.event.target;for(;s;){let n=Ho.get(s);if(n&&n.canSelect&&n.type!=="geo")return n;if(s=s.parentNode||void 0,s===this.$parent._el)return}}hoverGeoTile(t){var e;this.hoveringTile!==t&&((e=this.hoveringTile)==null||e.hover(!1)),t==null||t.hover(),this.hoveringTile=t}down(t){}start(t){}move(t){}up(t){}end(t){}click(t){}hover(t){}cancel(){}},hc=class extends Ai{constructor(){super(...arguments);this.clickTimeout=0}down(t){var s;let e=this.activeTile=this.getTileAt(t);this.previousSelection=void 0,(s=this.$parent.focussedTile)==null||s.blur(),this.$parent.warningBanner.hide(),e?(e.isActive&&this.$parent.events.shiftKey?this.$parent.selection.remove(e):(this.$parent.events.shiftKey||!e.isActive)&&this.$parent.selection.add(e,!this.$parent.events.shiftKey),e.down(t),zt.addClass("grabbing")):this.$parent.events.shiftKey?this.previousSelection=new Set(this.$parent.selection.tiles):this.$parent.selection.clear()}up(t){var e;(e=this.activeTile)==null||e.up(t)}start(){this.activeTile?(this.$parent.events.altKey&&this.$parent.paste(this.$parent.selection.copy(),$),this.$parent.selection.moveStart()):this.$parent.$selection.show()}move(t){var s;if(this.activeTile){this.$parent.selection.move(t);return}let e=x.aroundPoints([t.startPosn,t.posn]);this.$parent.$selection.setRect(e);for(let n of this.$parent.tiles.values()){if(!n.canSelect||!n.canDragToSelect||!n.transformed)continue;let o=Rs(e,n.transformed,n.type);(this.$parent.events.shiftKey&&((s=this.previousSelection)==null?void 0:s.has(n))?!o:o)?this.$parent.selection.add(n,!1,!0):this.$parent.selection.remove(n,!0)}this.$parent.selection.update(!0)}end(){this.activeTile?this.$parent.selection.moveEnd():this.$parent.$selection.hide(),zt.removeClass("grabbing")}click(t){if(this.activeTile){this.activeTile.click(t);let e=Date.now();e-this.clickTimeout<500&&this.activeTile.doubleClick(t),this.clickTimeout=e}}hover(t){let e=this.getTileAt(t);this.hoverGeoTile((e==null?void 0:e.is("geo"))?e:void 0),this.$parent.$svg.css("cursor",e?"grab":"")}},cc=class extends Ai{constructor(){super(...arguments);this.erased=[]}down({posn:t}){this.erase(t)}move({posn:t,lastPosn:e}){let s=d.distance(t,e)/4;for(let n=0;n<s;++n)this.erase(d.interpolate(t,e,n/s))}shouldErase(t,e,s){return wt(e)?d.distance(e,t)<10:Ct(e)?e.distanceSquared(t)<100:to(e)?e.edges.some(n=>n.distanceSquared(t)<100):ct(e)&&s==="geo"?Math.abs(d.distance(t,e.c)-e.r)<10:e.contains(t)}erase(t){for(let e of this.$parent.tiles.values())if(!(!e.transformed||!e.canDragToSelect||!e.canSelect)&&this.shouldErase(t,e.transformed,e.type)){e.delete(),this.erased.push(e);return}for(let e of this.$parent.strokes.values())if(e.hitTest(t,10)){e.delete(),this.erased.push(e);return}}end(){this.erased.length&&(this.$parent.change({deleted:this.erased}),this.$parent.snapping.updateIntersections()),this.erased=[]}click(){this.end()}},dc=class extends Ai{constructor(){super(...arguments);this.options="text"}down({posn:t}){let e=this.$parent.newTile(this.options,"");e.setTransform(t.shift(-10,-15)),this.$parent.trigger("add-tile",{tile:e}),this.$parent.setActiveTool("move"),e.focus(!0)}},pc=class extends Ai{enable(){this.previousTool=this.$parent.state.tool,this.$parent.setActiveTool("pan")}down(t){this.initialOrigin=this.$parent.origin,this.startPosn=he(t.event)}move(t){let e=he(t.event).subtract(this.startPosn),s=this.initialOrigin.subtract(e.scale(1/this.$parent.zoom));this.$parent.setViewport(s,this.$parent.zoom)}end(){this.$parent.setActiveTool(this.previousTool)}click(){this.end()}},uc=class extends Ai{constructor(){super(...arguments);this.options="pen"}getUtensil(t){for(let e of this.$parent.tiles.values()){let s=Ef(e)?e.getDrawingPath(t):void 0;if(s)return s}}down({posn:t}){this.stroke=new Fe(this.$parent,"",this.$parent.state.penColor,this.options),this.stroke.start(t,this.getUtensil(t))}move({posn:t}){this.stroke.addPoint(t)}click(){this.$parent.change({added:[this.stroke]}),this.stroke=void 0}end(t){this.stroke.end(),this.click()}},yr=class extends Ai{constructor(){super(...arguments);this.options="line";this.angleIndex=0}expr(t,e){var s;switch(this.options){case"line":return`segment(${t},${e})`;case"circle":return`circle(${t},distance(${t},${e}))`;case"rect":return`rectangle(${t},${e}.x-${t}.x,${e}.y-${t}.y)`;case"angle":return`angle(${e},${(s=this.midPoint)==null?void 0:s.key},${t})`}}snapPoint(t){var o;let e=this.$parent.snapping.snap([t]);e&&(t=t.add(e.shift));let s="",n=((o=e==null?void 0:e.tile)==null?void 0:o.type)==="geo"?e==null?void 0:e.tile:void 0;return(n==null?void 0:n.path)&&wt(n.path)&&(s=n.key),(e==null?void 0:e.intersection)&&(s=e.intersection),{point:t,tile:n,expr:s||`point(${t.x},${t.y})`}}getOrMakePointTile(t){var s,n;if(((s=t==null?void 0:t.tile)==null?void 0:s.path)&&wt(t.tile.path))return t.tile;if((n=t==null?void 0:t.tile)==null?void 0:n.path){let o=t.tile.path.offset(t.point),r=new ae(`${t.tile.key}.at(${o})`,this.$parent);return this.$parent.trigger("add-tile",{tile:r}),r}let e=new ae(t.expr,this.$parent);return this.$parent.trigger("add-tile",{tile:e}),e}drawPendingPoint(t){var n,o;let e=((o=(n=t.tile)==null?void 0:n.path)==null?void 0:o.type)==="point",s=t.expr.startsWith("intersection");this.$parent.$pendingPoint.toggle(!e),e||(this.$parent.$pendingPoint.setCenter(t.point),this.$parent.$pendingPoint.setClass("intersection",s),this.$parent.$pendingPoint.setAttr("r",s?3.5:6))}down({posn:t}){var n;let e=this.snapPoint(t),s=this.getOrMakePointTile(e);this.createdNewStart=((n=e.tile)==null?void 0:n.geoType)!=="point",this.options==="angle"?this.angleIndex===0?(this.startPoint=s,this.angleIndex=1,this.createdNewStart&&this.$parent.change({added:[s]})):this.angleIndex===1?(this.midPoint=s,this.angleIndex=2,this.path=new ae(this.expr(this.startPoint.key,s.key),this.$parent),this.createdNewStart&&this.$parent.change({added:[s]})):(this.path.setExpr(this.expr(this.startPoint.key,s.key)),this.$parent.change({added:this.createdNewStart?[s,this.path]:[this.path]}),this.angleIndex=0,this.path=this.startPoint=this.midPoint=this.createdNewStart=void 0):this.startPoint=s}start(){var t;this.options!=="angle"&&(this.path=new ae("",this.$parent),this.startPoint.pending=this.path.pending=!0,(t=this.$parent.$pendingPoint)==null||t.show(),this.hoverGeoTile(void 0))}move({posn:t}){var e;this.options!=="angle"&&(this.endSnap=this.snapPoint(t),this.path.setExpr(this.expr(this.startPoint.key,this.endSnap.expr),!0),this.drawPendingPoint(this.endSnap),this.hoverGeoTile((e=this.endSnap)==null?void 0:e.tile))}end(){var s,n,o;if(this.options==="angle")return;let t=d.distance(this.startPoint.path,this.endSnap.point)<8,e;if(t?this.path.delete():(e=this.getOrMakePointTile(this.endSnap),this.path.setExpr(this.expr(this.startPoint.key,e.key)),this.path.setPending(!1),this.$parent.trigger("add-tile",{tile:this.path})),this.startPoint.setPending(!1),(s=this.$parent.$pendingPoint)==null||s.hide(),this.hoverGeoTile(void 0),this.$parent.snapping.updateIntersections(),this.createdNewStart||!t){let r=[];this.createdNewStart&&r.push(this.startPoint),this.path&&r.push(this.path),e&&((o=(n=this.endSnap)==null?void 0:n.tile)==null?void 0:o.geoType)!=="point"&&r.push(e),this.$parent.change({added:r})}this.startPoint=this.path=this.endSnap=void 0}click(){this.options!=="angle"&&this.createdNewStart&&this.$parent.change({added:[this.startPoint]})}hover(t){var s;let e=this.snapPoint(t.posn);this.drawPendingPoint(e),this.hoverGeoTile(((s=e==null?void 0:e.tile)==null?void 0:s.type)==="geo"?e.tile:void 0),this.options==="angle"&&this.angleIndex===2&&this.path.setExpr(this.expr(this.startPoint.key,e.expr))}cancel(){this.$parent.$pendingPoint.hide(),this.path&&this.path.delete(),this.startPoint=this.path=this.endSnap=void 0,this.angleIndex=0}},fc=class extends yr{constructor(){super(...arguments);this.startId="";this.expression=""}enable(t){var e;this.expression=t,this.$parent.selection.clear(),this.$parent.setActiveTool("geoPending"),((e=window.event)==null?void 0:e.clientX)&&this.hover({posn:ge(window.event,this.$parent.$svg)})}makePath(){return this.path=new ae("",this.$parent),this.path.$el.css("opacity",.5),this.path.pending=!0,this.path}down(t){if(!this.expression)return;super.down(t);let e=this.path||this.makePath();e.$el.css("opacity",1),e.setExpr(this.expression.replace(/\$1/g,this.startPoint.key)),e.pending=!1,this.path=void 0,this.$parent.selection.add(e,!0);let s=this.createdNewStart?[this.startPoint]:[];this.$parent.change({added:[...s,e]}),this.$parent.snapping.updateIntersections(),this.$parent.trigger("add-tile",{tile:e}),this.$parent.setActiveTool("move")}hover({posn:t}){var s;if(!this.expression)return;let e=this.snapPoint(t);this.drawPendingPoint(e),this.hoverGeoTile(((s=e==null?void 0:e.tile)==null?void 0:s.type)==="geo"?e.tile:void 0),this.path||this.makePath(),this.path.setExpr(this.expression.replace(/\$1/g,e.expr))}cancel(){super.cancel(),this.expression=""}},mc=class extends Ai{enable(){if(this.tiles=Array.from(this.$parent.selection.tiles).filter(t=>!t.fixed),!this.tiles.length)return this.cancel();this.$parent.selection.clear(),this.$parent.setActiveTool("cutPolygon");for(let t of this.tiles)t.$el.addClass("active")}down(){}start({posn:t}){var e;!this.tiles||(this.startPoint=((e=this.$parent.snapping.snap([t]))==null?void 0:e.posn)||t,this.$stroke=h("line",{class:"stroke cut"},this.$parent.$strokes))}move({posn:t}){var e,s;!this.tiles||(this.endPoint=((e=this.$parent.snapping.snap([t]))==null?void 0:e.posn)||t.snap(this.startPoint,5),(s=this.$stroke)==null||s.setLine(this.startPoint,this.endPoint))}end(t){var r;if(!this.tiles)return;if(t.cancelled)return this.cancel();let e=new $t(this.startPoint,this.endPoint),s=!1,n=[],o=[];for(let a of this.tiles||[]){let c=a.transformed.cut(e);if(c.length>1){for(let p of c){let u=new K(gt(p.points),this.$parent);u.setColour(a.colour),u.transform(),n.push(u)}a.delete(),o.push(a),s=!0}else a.$el.removeClass("active")}s&&this.$parent.change({added:n,deleted:o}),(r=this.$stroke)==null||r.remove(),this.$stroke=this.tiles=this.startPoint=this.endPoint=void 0,this.$parent.setActiveTool("move")}click(){this.cancel()}cancel(){var t;for(let e of this.tiles||[])e.$el.removeClass("active");(t=this.$stroke)==null||t.remove(),this.$stroke=this.tiles=this.startPoint=this.endPoint=void 0,setTimeout(()=>this.$parent.setActiveTool("move"))}};var zm='<x-icon class="bg-icon" name="eye-off" size="360"></x-icon><svg class="canvas" tabindex="0"><defs><pattern class="grid-pattern" id="square2-grid" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="50" height="50" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="square-dots" x="-4" y="-4" width="25" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="4" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="square-grid" x="0" y="0" width="125" height="125" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="25" y1="0" x2="25" y2="125"></line><line x1="0" y1="25" x2="125" y2="25"></line><line x1="50" y1="0" x2="50" y2="125"></line><line x1="0" y1="50" x2="125" y2="50"></line><line x1="75" y1="0" x2="75" y2="125"></line><line x1="0" y1="75" x2="125" y2="75"></line><line x1="100" y1="0" x2="100" y2="125"></line><line x1="0" y1="100" x2="125" y2="100"></line></g><rect x="0" y="0" width="125" height="125" opacity="0.5"></rect></pattern><pattern class="grid-pattern" id="tri-dots" x="0" y="-4" width="25" height="43.302" patternUnits="userSpaceOnUse"><circle cx="0" cy="4" r="2" opacity="0.3"></circle><circle cx="25" cy="4" r="2" opacity="0.3"></circle><circle cx="12.5" cy="25.651" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri-grid" x="0" y="0" width="25" height="43.302" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="25" y2="0"></line><line x1="0" y1="21.651" x2="25" y2="21.651"></line><line x1="0" y1="43.302" x2="25" y2="43.302"></line><line x1="0" y1="0" x2="25" y2="43.302"></line><line x1="25" y1="0" x2="0" y2="43.302"></line></g></pattern><pattern class="grid-pattern" id="tri2-dots" x="-4" y="0" width="43.302" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="0" r="2" opacity="0.3"></circle><circle cx="4" cy="25" r="2" opacity="0.3"></circle><circle cx="25.651" cy="12.5" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri2-grid" x="0" y="0" width="43.302" height="25" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="0" y2="25"></line><line x1="21.651" y1="0" x2="21.651" y2="25"></line><line x1="43.302" y1="0" x2="43.302" y2="25"></line><line x1="0" y1="0" x2="43.302" y2="25"></line><line x1="0" y1="25" x2="43.302" y2="0"></line></g></pattern><pattern class="grid-pattern" id="square-checked" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect class="filled" x="0" y="0" width="25" height="25" opacity="0.2"></rect><rect class="filled" x="25" y="25" width="25" height="25" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="rainbow-grid" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="10" y1="-10" x2="-110" y2="110" style="stroke:#cd0e66" stroke-width="17.678"></line><line x1="35" y1="-10" x2="-85" y2="110" style="stroke:#fd8c00" stroke-width="17.678"></line><line x1="60" y1="-10" x2="-60" y2="110" style="stroke:#22ab24" stroke-width="17.678"></line><line x1="85" y1="-10" x2="-35" y2="110" style="stroke:#0f82f2" stroke-width="17.678"></line><line x1="110" y1="-10" x2="-10" y2="110" style="stroke:#cd0e66" stroke-width="17.678"></line><line x1="135" y1="-10" x2="15" y2="110" style="stroke:#fd8c00" stroke-width="17.678"></line><line x1="160" y1="-10" x2="40" y2="110" style="stroke:#22ab24" stroke-width="17.678"></line><line x1="185" y1="-10" x2="65" y2="110" style="stroke:#0f82f2" stroke-width="17.678"></line><line x1="210" y1="-10" x2="90" y2="110" style="stroke:#cd0e66" stroke-width="17.678"></line></g></pattern><radialGradient id="sphere-gradient" cx="65%" cy="35%" r="65%"><stop offset="0" stop-color="white" stop-opacity="0.3"></stop><stop offset="0.32" stop-color="white" stop-opacity="0"></stop><stop offset="0.33" stop-opacity="0"></stop><stop offset="1" stop-opacity="0.2"></stop></radialGradient><linearGradient id="card-gradient"><stop offset="0" stop-color="#999"></stop><stop offset="0.08" stop-color="#bbb"></stop><stop offset="0.92" stop-color="#bbb"></stop><stop offset="1" stop-color="#999"></stop></linearGradient><filter id="handdrawn" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" basefrequency="0.004 0.004" numoctaves="26" stitchtiles="stitch" result="turbulence"></feTurbulence><feDisplacementMap in="SourceGraphic" in2="turbulence" scale="20" xchannelselector="R" ychannelselector="G" result="displacementMap"></feDisplacementMap></filter><filter id="pencil" x="-10%" y="-10%" width="110%" height="110%" filterUnits="objectBoundingBox"><feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="3" result="noise"></feTurbulence><feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="2" in="SourceGraphic" result="newSource"></feDisplacementMap></filter><symbol id="suit-c" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c2.3.1 4.2 1.9 4.3 4.2 0 1.6-.9 3-2.3 3.8.8-.3 1.6-.5 2.5-.5 2.4-.1 4.4 1.7 4.5 4.1v.2c0 2.3-1.9 4.2-4.2 4.2-.1 0-.2 0-.3 0-1.2-.1-2.4-.4-3.5-1 0 0-.3 2 2 5h-6c2.3-3 2-5 2-5-1.1.6-2.3.9-3.5 1-2.3.2-4.3-1.6-4.5-3.9 0-.1 0-.2 0-.3 0-2.4 1.9-4.3 4.3-4.3h.2c.9 0 1.7.2 2.5.5-1.4-.8-2.3-2.2-2.3-3.8.1-2.3 2-4.1 4.3-4.2z"></path></symbol><symbol id="suit-s" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c-3 5-8 7-8 12 .1 2.1 1.9 3.9 4 4 1.1.1 2.2-.2 3-1 0 0 .3 2-2 5h6c-2-3-2-5-2-5 .8.8 1.9 1.1 3 1 2.1-.1 3.9-1.9 4-4 0-5-5-7-8-12z"></path></symbol><symbol id="suit-h" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0 8.5-1.3-1.3c-4.6-4.1-7.7-6.9-7.7-10.3-.1-2.7 2.1-4.9 4.8-5h.2c1.5 0 3.1.7 4 1.9 1-1.2 2.5-1.9 4-1.9 2.8-.1 4.9 2.1 5 4.8v.2c0 3.4-3.1 6.2-7.7 10.3z"></path></symbol><symbol id="suit-d" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m7 0-7 10-7-10 7-10"></path></symbol><pattern id="card-bg" width="6" height="8" patternUnits="userSpaceOnUse"><rect width="6" height="8" fill="#0f82f2"></rect><line x2="6" y2="8" stroke="#eee" stroke-width="1"></line><line x1="6" y2="8" stroke="#eee" stroke-width="1"></line></pattern></defs><rect class="grid"></rect><path class="group-shadow"></path><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="strokes"></g><g class="geo-shadows"></g><g class="geo-paths"></g><g class="geo-points"></g><g class="tiles"></g><g class="tiles"></g><rect class="selection"></rect><g class="transform-tools" hidden><path class="group-outline"></path><line class="rotate-bar"></line><circle class="rotate-circle" r="10"></circle></g></svg><div class="html-overlay"></div><div class="panels"></div><slot></slot>';var Ve="https://static.mathigon.org/polypad/audio",Fm={roll:new fe(`${Ve}/roll.mp3`,.6,!1),spin:new fe(`${Ve}/spin.mp3`,.5,!1),coinToss:new fe(`${Ve}/coin-toss.mp3`,.3,!1),shuffle:new fe(`${Ve}/shuffle.mp3`,.3,!1),draw:new fe(`${Ve}/card-draw.mp3`,.2,!1),click:new fe(`${Ve}/click.mp3`,.3,!1),woosh:new fe(`${Ve}/woosh.mp3`,.2,!1),rise:new fe(`${Ve}/rise.mp3`,.3,!1),fall:new fe(`${Ve}/fall.mp3`,.3,!1),splitCoins:new fe(`${Ve}/split-coins.mp3`,.175,!1),mergeCoins:new fe(`${Ve}/merge-coins.mp3`,.3,!1)};var Ke=25,gc=Ke*Math.sqrt(3)/2,Iw=Math.sqrt(2*Ke**2)/2;function Ws(i,t,e){let s,n,o;t:for(let r of e)for(let a of t){let l=r.posn||r.path.project(a),c=l.subtract(a),p=c.length;if(p<i&&(i=p,s=l,n=c,o=r,p<1))break t}return n?j(j({},o),{posn:s,shift:n}):void 0}function*vc(i){for(let[t,e]of i){let s=ft(t.path,e.path);for(let[n,o]of s.entries())yield{posn:o,intersection:`intersections(${t.key},${e.key||e.path})[${n}]`}}}var wc=class{constructor(t){this.$parent=t;this.geoIntersections=new Set;this.strokeIntersections=new Set}*getGeoPoints(){for(let t of this.$parent.getTilesOfType("geo"))t.isActive||t.pending||t.hidden||t.path&&wt(t.path)&&(yield{posn:t.path,tile:t});for(let t of this.geoIntersections)yield t}*getVertices(){for(let t of this.$parent.tiles.values())if(!(t.isActive||t.pending||t.type==="geo"))for(let e of t.snapPoints)yield{posn:e,tile:t};for(let t of this.$parent.strokes.values())for(let e of t.snapPoints||[])yield{posn:e};for(let t of this.strokeIntersections)yield t}*getGridPoints(t){if(!this.$parent.options.grid||this.$parent.options.grid==="none")return;let e=this.$parent.options.grid.split("-")[0],s=x.aroundPoints(t),n=new At(s.p.x-Ke,s.p.x+s.w+2*Ke,s.p.y-Ke,s.p.y+s.h+2*Ke);if(e.startsWith("square")){let o=(e==="square2"?2:1)*Ke,r=ht(n.xMin,o);for(let a=ht(n.yMin,o);a<n.yMax;a+=o)for(let l=r;l<n.xMax;l+=o)yield{posn:new d(l,a)}}else if(e.startsWith("tri")){let o=e==="tri2";o&&(n=n.flip);let r=ht(n.xMin,Ke);for(let a=Math.floor(n.yMin/gc);a*gc<n.yMax;++a)for(let l=r+(a%2?Ke/2:0);l<n.xMax;l+=Ke){let c=new d(l,a*gc);yield{posn:o?c.flip:c}}}}*getSnapLines(){for(let t of this.$parent.tiles.values())if(!(t.isActive||t.pending))for(let e of t.snapLines)yield{path:e,tile:t};for(let t of this.$parent.strokes.values())t.snap&&(yield{path:t.path})}snap(t){if(!this.$parent.options.noSnapping)return Ws(12,t,this.getGeoPoints())||Ws(8,t,this.getVertices())||Ws(Iw,t,this.getGridPoints(t))||Ws(6,t,this.getSnapLines())}*getGeoEls(t=!0){for(let e of this.$parent.getTilesOfType("geo"))!e.canSelect||!e.transformed||(t&&wt(e.transformed)&&(yield{posn:e.transformed,tile:e}),!t&&!wt(e.transformed)&&(yield{path:e.transformed,tile:e}))}snapGeo(t){if(!this.$parent.options.noSnapping)return Ws(12,[t],this.getGeoEls(!0))||Ws(6,[t],this.getGeoEls(!1))}*geoTiles(){for(let t of this.$parent.getTilesOfType("geo"))t.path&&!t.hidden&&!wt(t.path)&&(yield t)}*strokes(){for(let t of this.$parent.strokes.values())t.snap&&(yield t)}updateIntersections(){this.geoIntersections.clear(),this.strokeIntersections.clear();let t=Array.from(this.geoTiles()),e=Array.from(this.strokes());for(let s of vc(Or(t)))this.geoIntersections.add(s);for(let s of vc(cs(t,e)))this.geoIntersections.add(s);for(let[s,n]of Or(e))for(let o of ft(s.path,n.path))this.strokeIntersections.add({posn:o})}addStroke(t){if(!!t.snap){for(let e of this.strokes())if(e!==t)for(let s of ft(e.path,t.path))this.strokeIntersections.add({posn:s});for(let e of vc(cs(this.geoTiles(),[t])))this.geoIntersections.add(e)}}};var yc=[{type:"checkbox",tileTypes:["axes","balance","grid","fraction-bar","decimal-grid","multi-jump","number-line","ten-frame","number-tile","image","spinner","custom-spinner","box-whisker","chart","pie-chart","table","rectangle","reg-polygon","custom-polygon"],label:"Show handles:",icon:"handles",advanced:!0,get:i=>!i.hideHandles,set:(i,t)=>t.setHandles(!i)},{type:"button",tileTypes:["all"],label:"Copy",icon:"copy",show:i=>!i[0].$parent.options.noCopyPaste,click:(i,t)=>t.paste(t.selection.copy(),new d(25,25))},{type:"button",tileTypes:["all"],label:"Delete",icon:"delete",show:i=>!i[0].$parent.options.noDeleting&&i.every(t=>!t.fixed),click:(i,t)=>t.selection.delete()},{type:"checkbox",tileTypes:["all"],label:"Keep on top:",icon:"layer-front",advanced:!0,get:i=>i.order==="front",set:(i,t)=>t.setOrder(i?"front":void 0)},{type:"checkbox",tileTypes:["all"],label:"Keep at back:",icon:"layer-back",advanced:!0,get:i=>i.order==="back",set:(i,t)=>t.setOrder(i?"back":void 0)},{type:"checkbox",tileTypes:["all"],label:"Lock position:",icon:"move-off",advanced:!0,get:i=>!!i.fixed,set:(i,t)=>t.fixed=i},{type:"checkbox",tileTypes:["all"],label:"Lock tile:",icon:"lock",advanced:!0,get:i=>!!i.locked,set:(i,t)=>t.lock(i)},{type:"checkbox",tileTypes:["all"],label:"Invisible:",icon:"eye-off",advanced:!0,get:i=>!!i.hidden,set:(i,t)=>t.hide(i)}];var jm=i=>i.toLowerCase().replace(":","").replace(/\s/g,"-"),Nw=["polygons","polyominoes","tangram","penrose","pentagons","solids","measuring","patterns","number-tiles","number-bars","number-frames","number-cards","number-line","primes","number-dots","number-grid","number-tools","fraction-bars","fraction-circles","algebra","balance","axes","sliders","probability","charts","playing-cards","polyhedral-dice","non-trans-dice","logic","chess","currency","clocks","dominoes"],Gw=["move","pen","geo","text","equation","eraser","image","color"],Dw=Dt([...yc,...Is].map(i=>jm(i.label))).sort(),br=[["toolbar",Gw],["sidebar",Nw],["actionbar",Dw]],bc=["mergeTiles","evalEquations","altColors","largeUI"],$c=["noCopyPaste","noDeleting","noRotating","noUndoRedo","noPinchPan","noSnapping","noAudio"],_w=["fullscreen","grid"],Um=[...br.map(i=>i[0]),...bc,...$c,"settings"],Zm={advanced:{mergeTiles:!0,evalEquations:!0},common:{actionbar:Dt([...yc,...Is].filter(i=>!i.advanced).map(i=>jm(i.label))).join(","),mergeTiles:!0,evalEquations:!0},simple:{sidebar:"polygons,polyominoes,tangram,solids,measuring,number-tiles,number-bars,number-frames,number-cards,number-line,fraction-bars,fraction-circles,algebra,balance,probability,playing-cards,polyhedral-dice,clocks,dominoes",toolbar:"move,pen,text,eraser,color",actionbar:"copy,delete,unfold,hinges,flip,cut,fold-net,turn-over,draw,shuffle,merge-tiles,split-tiles,start,step,width,divisions,rename,balance,randomize,seconds",settings:"grid",mergeTiles:!0,largeUI:!0,noPinchPan:!0}};function Wm(){var e;let i=b.getStorage("polypad.options")||{},t={};for(let s of Um)t[s]=(e=i[s])!=null?e:Zm.advanced[s];return t}function Km(){let i=io(location.search),t=location.pathname.includes("/embed"),e={};for(let s of["sidebar","toolbar","settings","actionbar","grid"])i[s]&&(e[s]=i[s].toLowerCase().replace(/[^a-z,-]/g,""));return i.rotate==="no"&&(e.noRotating=!0),i.delete==="no"&&(e.noDeleting=!0),i.copy==="no"&&(e.noCopyPaste=!0),i.pan==="no"&&(e.noPinchPan=!0),t&&i.pan!=="yes"&&(e.noPinchPan=!0),e}function Hw(i,t,e,s){let n=h("label",{text:" "+e},i),o=h("input",{type:"checkbox"});n.prepend(o),o.bindVariable(s,t)}function qw(i){return i.replace(/(^|-)(\w)/g,(t,e,s)=>` ${s.toUpperCase()}`)}var xc=class extends O{bindPolypad(t){this.options=t.options}ready(){this.$modal=this.parents("x-modal")[0],this.$modal.on("open",()=>this.load(this.options)),this.setup()}setup(){let t=mt({preset:n=>this.load(Zm[n]||{}),cancel:()=>this.$modal.close(),save:()=>this.save()});this.bindModel(t);let e=this.$$(".ui-columns").slice(1),s=this.$$("button.switch");for(let[n,[o,r]]of br.entries()){for(let a of r)Hw(e[n],`${o}-${a}`,qw(a),t);s[n].on("click",()=>{let a=r.some(l=>t[`${o}-${l}`]);for(let l of r)t[`${o}-${l}`]=!a}),this.model[o]=!0}}load(t){var s;for(let[n,o]of br){let r=t[n]||"";this.model[n]=r!=="hidden";let a=r.split(",");for(let l of o)this.model[`${n}-${l}`]=!r||a.includes(l)}let e=(s=t.settings)==null?void 0:s.split(",");for(let n of _w)this.model[n]=!e||e.includes(n);for(let n of bc)this.model[n]=!!t[n];for(let n of $c)this.model[n]=!t[n]}save(){for(let[t,e]of br)this.model[t]?e.every(s=>this.model[`${t}-${s}`])?this.options[t]=void 0:this.options[t]=e.filter(s=>this.model[`${t}-${s}`]).join(","):this.options[t]="hidden";this.options.settings=this.model.fullscreen&&this.model.grid?void 0:this.model.fullscreen?"fullscreen":this.model.grid?"grid":"other";for(let t of bc)this.options[t]=!!this.model[t]||void 0;for(let t of $c)this.options[t]=!this.model[t]||void 0;for(let t of Um)b.setStorage(`polypad.options.${t}`,this.options[t]);this.$modal.close()}};xc=N([A("x-polypad-customise")],xc);var Pc=3,Bw=new At(-2e3,4e3,-2e3,4e3),$r=i=>`${i.xMin} ${i.yMin} ${i.dx} ${i.dy}`,Sc=i=>!!i.name,Tc=class extends O{constructor(){super(...arguments);this.tiles=new Map;this.strokes=new Map;this.options=mt({});this.state=mt({tool:"move",changeCount:0,penColor:"#242436"});this.mathContext=new Sh;this.snapping=new wc(this);this.tools={move:new hc(this),pen:new uc(this),geo:new yr(this),geoPending:new fc(this),eraser:new cc(this),text:new dc(this),pan:new pc(this),cutPolygon:new mc(this)};this.initial={};this.margins=[20,20,20,20];this.origin=$;this.zoom=1;this.newTileShift=0;this.tileWeights=new Map;this.setup=!1;this.undoStack=[];this.redoStack=[]}ready(){this.$svg=this.$("svg.canvas"),this.$tiles=this.$svg.$$(".tiles"),this.$selection=this.$svg.$(".selection"),this.$strokes=this.$svg.$(".strokes"),this.$grid=this.$svg.$(".grid"),this.$html=this.$(".html-overlay"),this.$panels=this.$(".panels"),this.$geoShadows=this.$svg.$(".geo-shadows"),this.$geoPaths=this.$svg.$(".geo-paths"),this.$geoPoints=this.$svg.$(".geo-points"),this.$pendingPoint=h("circle",{class:"geo-point pending",hidden:!0},this.$geoPoints),this.setAttr("data-tool","move"),this.events=new un(this.$svg,{down:t=>this.tools[this.state.tool].down(t),up:t=>this.tools[this.state.tool].up(t),start:t=>this.tools[this.state.tool].start(t),move:t=>this.tools[this.state.tool].move(t),end:t=>this.tools[this.state.tool].end(t),click:t=>this.tools[this.state.tool].click(t),hover:t=>this.tools[this.state.tool].hover(t),cursor:!1}),this.selection=new lc(this),this.warningBanner=new al(this),this.setViewport($,1),this.options.watch(t=>{this.$grid.setAttr("fill",t.grid&&t.grid!=="none"?`url(#${t.grid})`:"none"),this.$grid.setRect(this.canvasBounds.rect)}),this.$svg.on("contextmenu",t=>{this.focussedTile||t.preventDefault()}),this.enablePinchPan(),this.enableAccessibility(),b.onThemeChange(()=>{for(let t of this.tiles.values())t.colour&&t.setColour(t.colour,"theme");for(let t of this.strokes.values())t.setColor(t.color)}),this.state.watch(t=>this.setClass("high-contrast",!!t.highContrast)),this.state.watch(t=>this.setClass("handdrawn",!!t.handdrawn)),this.state.watch(t=>{this.setClass("setup-mode",!!t.setupMode);for(let e of this.selection.tiles)e.canSelect||this.selection.remove(e);this.selection.update()})}playSound(t){this.options.noAudio||Fm[t].play()}getTileAt(t,e){for(let s of this.tiles.values())if(!(e&&!e.includes(s.type))&&s.contains(t))return s}getInputAt(t,e){for(let s of this.tiles.values()){let n=s.getClosestPort(t,e);if(n)return n}}*getTilesOfType(t){for(let e of this.tiles.values())e.is(t)&&(yield e)}enablePinchPan(){this.on("wheel",s=>{if(!this.options.noPinchPan)if(s.preventDefault(),s.ctrlKey){let n=this.zoom*(1-s.deltaY/100);this.setViewport(this.origin,n,ge(s,this.$svg))}else{let n=this.origin.shift(s.deltaX/this.zoom,s.deltaY/this.zoom);this.setViewport(n,this.zoom)}});let t=0,e=this.origin;this.on("gesturestart",s=>{this.options.noPinchPan||(s.preventDefault(),e=new d(s.pageX,s.pageY).subtract(this.origin),t=this.zoom,this.events.cancel())}),this.on("gesturechange",s=>{if(this.options.noPinchPan)return;s.preventDefault();let n=t*s.scale,o=new d(s.pageX,s.pageY).subtract(e);this.setViewport(o,n,ge(s,this.$svg))}),this.on("gestureend",s=>{this.options.noPinchPan||s.preventDefault()})}enableImageDrop(t,e){let s=h("div",{class:"image-drop"},this);this.imageUploadCallback=t,this.on("dragenter dragover dragleave drop",o=>o.preventDefault()),this.on("dragenter dragover",()=>s.show()),this.on("dragleave drop",()=>s.hide());let n=(o,r)=>R(this,null,function*(){let l=Array.from((o==null?void 0:o.files)||[]).slice(0,10).map((p,u)=>this.newImage(p,r.shift(u*25),t)),c=yield Promise.all(l);this.change({added:c}),this.trigger("paste")});this.on("drop",o=>n(o.dataTransfer,ge(o,this.$svg))),e==null||e.on("change",()=>R(this,null,function*(){yield n(e._el,this.canvasBounds.center),e.value=""}))}enableHotkeys(){b.onKey("backspace delete",()=>this.selection.delete()),b.onKey("z",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),t.shiftKey?this.redo():this.undo())}),b.onKey("y",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.redo())}),b.onKey("c",t=>{if(t.ctrlKey||t.metaKey||this.options.noCopyPaste)return;let e=this.selection.copy();this.paste(e,new d(25,25))}),b.onKey("a",t=>{var e;!(t.ctrlKey||t.metaKey)||((e=G("x-modal"))==null?void 0:e.getOpenModal())||(t.preventDefault(),this.selection.select(Array.from(this.tiles.values())))}),W.on("cut copy",t=>{var s,n;if(!this.selection.tiles.size||this.options.noCopyPaste||((s=b.getActiveInput())==null?void 0:s.is("input, textarea, [contenteditable]")))return;let e=this.selection.copy();(n=window.navigator.clipboard)==null||n.writeText(JSON.stringify(e)),t.type==="cut"&&this.selection.delete()}),W.on("paste",t=>R(this,null,function*(){var n,o;if(this.options.noCopyPaste||((n=b.getActiveInput())==null?void 0:n.is("input, textarea, [contenteditable]")))return;let e=mu(t.clipboardData);if(e&&this.imageUploadCallback){let r=yield this.newImage(e,this.center.shift(-50),this.imageUploadCallback);return this.trigger("paste"),this.change({added:[r]})}let s=yield(o=window.navigator.clipboard)==null?void 0:o.readText();if(!!s)try{let r=JSON.parse(s);if(!r.length)return;this.paste(r)}catch(a){let r=this.newTile("text",s);r.setTransform(this.canvasBounds.center.subtract(r.center)),this.selection.add(r,!0),this.change({added:[r]}),this.trigger("paste"),this.selection.select([r])}}))}enableAccessibility(){let t,e=n=>{this.focussedTile||(t=n,this.$svg.setAttr("aria-description",n?n.ariaDescription:"Empty Canvas"),n&&this.selection.add(n,!0))},s=!1;this.$svg.on("focusin",()=>{if(!s)return;let n=Array.from(this.tiles.values());e(this.events.shiftKey?_(n):n[0])}),this.$svg.on("focusout",()=>t=void 0),W.on("keydown",n=>{if(s=!0,n.keyCode!==9||!t)return;let o=Array.from(this.tiles.values());e(o[o.indexOf(t)+(n.shiftKey?-1:1)]),t&&n.preventDefault()}),W.on("pointerdown",()=>s=!1)}newImage(t,e,s){return R(this,null,function*(){let n=new FileReader;n.readAsDataURL(t),yield new Promise(r=>n.onloadend=r);let o=this.newTile("image",(n.result||"").toString());return o.setTransform(e),this.selection.add(o,!0),yield s==null?void 0:s(t,o),o})}newTile(t,e,s){return new(rc(t))(e,this,s)}setViewport(t,e=1,s){if(e=S(e,1/Pc,Pc),s){let a=this.zoom/e;t=s.subtract(s.subtract(this.origin).scale(a))}let n=this.width/e,o=this.height/e;this.zoom=e,this.origin=t.clamp(Bw.resize(-n,-o)),this.canvasBounds=new At(this.origin.x,this.origin.x+n,this.origin.y,this.origin.y+o),this.$svg.setAttr("viewBox",this.attr("viewBox")||$r(this.canvasBounds)),this.$html.setTransform(this.origin.inverse.scale(this.zoom),0,this.zoom);let r=this.canvasBounds.rect;this.options.grid!=="none"&&this.$grid.setRect(r),ae.redrawLines(r),this.newTileShift=0,this.trigger("viewport")}resetViewport(){if(!this.tiles.size&&!this.strokes.size)return this.setViewport($,1);let t=Io(this.tiles,this.strokes,0),[e,s,n,o]=this.margins,r=(this.width-o-s)/t.dx,a=(this.height-e-n)/t.dy,l=S(Math.min(r,a),1/Pc,1),c=new d(this.width+o-s,this.height+e-n),p=t.center.subtract(c.scale(1/2/l));this.setViewport(p,l)}setZoom(t){let e=this.canvasBounds.center;this.setViewport(this.origin,this.zoom*t,e)}bindSource(t,e,s,n){rc(e).makeThumbnail(s,t,this);let o,r=n==null?void 0:n.$(".tiles"),a=+t.attr("data-rot")||0,l=()=>{o=this.newTile(e,t.data.options||s),t.data.colour&&o.setColour(t.data.colour),t.data.labels&&o.setLabels(t.data.labels)};this.events.listen(t,{down:()=>this.trigger("add-tile-start"),start:({posn:c})=>{l(),o.setTransform(c.subtract(o.center),a),this.selection.add(o,!0),this.selection.moveStart(!0),n&&n.setAttr("viewBox",$r(this.canvasBounds)),(r||o.$container).append(o.$el),this.trigger("add-tile",{tile:o})},move:c=>this.selection.move(c),end:()=>{o.$container.append(o.$el),this.selection.moveEnd(!0)},click:()=>{l(),o.setTransform(this.center.subtract(o.center).shift(this.newTileShift*25),a),this.selection.add(o,!0),o.moveEnd(),this.trigger("add-tile",{tile:o}),this.change({added:[o]}),this.newTileShift+=1}})}get center(){let[t,e,s,n]=this.margins;return this.canvasBounds.center.shift((n-e)/this.zoom/2,(t-s)/this.zoom/2)}setActiveTool(t,e){this.tools[this.state.tool].cancel(),this.warningBanner.hide(),this.selection.clear(),this.state.assign({tool:t,toolOptions:e}),e&&(this.tools[this.state.tool].options=e),this.setAttr("data-tool",t)}clear(t=!0){this.selection.clear();let e=[...Array.from(this.tiles.values()),...Array.from(this.strokes.values())];for(let s of e)s.delete();t&&this.setViewport($,1),e.length&&this.change({deleted:e})}thumbnail(t,e,s="jpg"){return R(this,null,function*(){let n=this.canEditQuestions?Array.from(this.getTilesOfType("question-blank")):[];for(let a of n)a.hideForThumbnail();let o=Io(this.tiles,this.strokes,50),r=yield this.$svg.image(s,t,e,$r(o));for(let a of n)a.hideForThumbnail(!0);return r})}paste(t,e){let s=new Map,n=new Map,o=t.map(a=>{a.name==="geo"&&(a.options=ae.copy(n,a.options));let l=T.unSerialize(a,this,!0);return(l==null?void 0:l.fixed)&&(l.fixed=!1),l&&s.set(a.id,l.id),l}).filter(a=>a);for(let a of t)for(let l of a.cables||[])re.unSerialize(s.get(a.id),{fromPort:l.fromPort,toPort:l.toPort,toTileId:s.get(l.toTileId)},this);let r=ri(...o.map(a=>a.transformed)).center;e===void 0&&(e=this.center.subtract(r).shift(this.newTileShift*25));for(let a of o)a.is("geo")?a.shift(e):a.setTransform(a.posn.add(e));this.newTileShift+=1,this.change({added:o}),this.trigger("paste"),this.selection.select(o)}downloadImage(t="png",e){var o;this.selection.clear();let s=e||((o=this.state.title)==null?void 0:o.replace(/\s+/g,"-").replace(/[^\w-]/g,"").toLowerCase())||"polypad",n=Io(this.tiles,this.strokes,50);this.$svg.downloadImage(`${s}.${t}`,n.dx,n.dy,$r(n))}check(t){let e=!1;return new Promise(s=>{this.on("change",()=>{!e&&t(Array.from(this.tiles.values()))&&(e=!0,s())})})}change(t){var e,s,n;this.setup||this.options.noUndoRedo||(this.trigger("change",{action:"change",data:t}),this.undoStack.push({added:(e=t.added)==null?void 0:e.map(o=>o.serialize()),changed:(s=t.changed)==null?void 0:s.map(o=>[o.lastSavedData,o.serialize()]),deleted:(n=t.deleted)==null?void 0:n.map(o=>o.lastSavedData)}),this.undoStack.length>50&&this.undoStack.shift(),this.redoStack=[],this.state.canUndo=!0,this.state.canRedo=!1,this.state.changeCount+=1)}undo(){!this.undoStack.length||(this.applyChange(_(this.undoStack),!0),this.redoStack.push(this.undoStack.pop()),this.state.canUndo=!!this.undoStack.length,this.state.canRedo=!0,this.state.changeCount-=1,this.selection.update(),this.trigger("change",{action:"undo"}))}redo(){!this.redoStack.length||(this.applyChange(_(this.redoStack)),this.undoStack.push(this.redoStack.pop()),this.state.canUndo=!0,this.state.canRedo=!!this.redoStack.length,this.state.changeCount+=1,this.selection.update(),this.trigger("change",{action:"redo"}))}applyChange(t,e=!1){var s,n;for(let o of(e?t.deleted:t.added)||[])(Sc(o)?T:Fe).unSerialize(o,this);for(let o of(e?t.added:t.deleted)||[])(s=(Sc(o)?this.tiles:this.strokes).get(o.id))==null||s.delete();for(let[o,r]of t.changed||[])(n=this.tiles.get(o.id))==null||n.applyChange(e?o:r);for(let o of(e?t.deleted:t.added)||[])if(Sc(o)&&o.cables)for(let r of o.cables)re.unSerialize(o.id,r,this)}serialize(t=2e3,e=1e3,s=16e3){var n;return{title:(n=this.state.title)==null?void 0:n.slice(0,30),tiles:Array.from(this.tiles.values()).slice(0,t).map(o=>o.serialize()),strokes:Array.from(this.strokes.values()).slice(0,e).map(o=>o.serialize(s)),options:this.options.copy()}}load(t){var e,s;this.setup=!0,this.clear(!1),ae.clearModel(),this.initial=t,this.canEditQuestions=this.attr("user-type")==="teacher"&&((e=t.canEdit)!=null?e:!0),this.state.assign({title:t.title,canUndo:!1,canRedo:!1,changeCount:0}),this.undoStack=this.redoStack=[],t.options||(t.options=Wm()),Object.assign(t.options,Km()),t.options.grid||(t.options.grid="none"),this.options.assign(t.options,!0),this.options.forceUpdate(),Yf(this,((s=t.options)==null?void 0:s.tileWeights)||"");for(let n of t.tiles||[])T.unSerialize(n,this);for(let n of t.strokes||[])Fe.unSerialize(n,this);for(let n of t.tiles||[])for(let o of n.cables||[])re.unSerialize(n.id,o,this);for(let n of this.tiles.values())n.move();this.snapping.updateIntersections(),this.resetViewport(),this.setActiveTool("move"),this.setup=!1}};Tc=N([A("x-polypad",{template:zm})],Tc);var Xm=`<div class="factris-panel-left"><div class="keys-play"><button @click="app.reset()" title="Restart Game"><x-icon name="restart" size="36"></x-icon></button><button @click="app.toggle()" :title="playing ? 'Pause' : 'Play'"><span :show="playing"><x-icon name="pause" size="36"></x-icon></span><span :show="!playing"><x-icon name="play" size="36"></x-icon></span></button><button class="highscore-btn" @click="app.showHighscore()" title="Highscore"><x-icon name="trophy" size="36"></x-icon></button></div><div class="panel-item"><div class="text-large" :class="points &gt; 999999 ? 'narrow' : ''">\${numberFormat(points)}</div><div class="text-small">Points</div></div><div class="panel-item"><div class="text-large margin"><span :show="min(time)" data-display="inline">\${min(time)}m</span> \${time % 60}s</div><div class="text-small">Time</div></div><hr :show="highscore.length"><div class="highscore-panel" :show="highscore.length"><div class="highscore-title">Highscore</div><table><tr><td>\${highscore[0].name.slice(0, 4)}</td><td>\${numberFormat(highscore[0].score)}</td></tr><tr><td>\${highscore[1].name.slice(0, 4)}</td><td>\${numberFormat(highscore[1].score)}</td></tr><tr><td>\${highscore[2].name.slice(0, 4)}</td><td>\${numberFormat(highscore[2].score)}</td></tr><tr><td>\${highscore[3].name.slice(0, 4)}</td><td>\${numberFormat(highscore[3].score)}</td></tr><tr><td colspan="2"><a @click="app.showHighscore()">View more\u2026</a></td></tr></table></div><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V5A12,12,0,0,1,12,17h1V0Z"></path><path d="M0,0V1A12,12,0,0,1,12,13v4h1V0Z"></path></svg></div></div><div class="factris-panel-right"><div class="panel-item"><div class="text-small">Next blocks:</div><div class="text-large">\${next[0]}</div><div class="text-large">\${next[1]}</div><div class="text-large">\${next[2]}</div><div class="text-large">\${next[3]}</div><div class="text-large">\${next[4]}</div></div><hr><div class="text-small discharge-label">Discharge:</div><button class="discharge" :show="!discardCounter" data-display="inline-block" @click="app.discharge()" title="Discard Tile"><x-icon name="delete" size="36"></x-icon></button><svg class="discharge-count" :show="discardCounter" data-display="inline-block" width="74" height="74" viewBox="0 0 74 74"><circle cx="37" cy="37" r="32" style="strokeDashoffset:\${201*discardCounter/5}px"></circle><text class="large" x="37" y="38">\${discardCounter}</text><text class="small" x="37" y="51">needed</text></svg><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V17H1A12,12,0,0,1,13,5V0Z"></path><path d="M0,0V17H1V13A12,12,0,0,1,13,1V0Z"></path></svg></div></div><div class="factris-body"><svg class="factris-board" :show="(playing || lost) &amp;&amp; !showHighscore &amp;&amp; !initial" data-display="visibility"><defs><linearGradient id="shadow" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color: white; stop-opacity: 0.2"></stop><stop offset="100%" style="stop-color: white; stop-opacity: 0.05"></stop></linearGradient></defs><rect class="shadow" fill="url(#shadow)"></rect><g class="tiles"></g><g class="grid"><g class="faint-grid"></g></g><g class="scores"></g></svg><div class="logo" :class="initial &amp;&amp; !showHighscore ? 'show' : ''"><svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg"><g fill="#ffffff"><path d="m1.5039 59.1143v-57.9034h24.7227v7.8077h-16.4278v17.5659h14.313v7.8071h-14.313v24.7227z"/><path d="m23.7871 59.1143 12.9307-57.9034h6.9122l12.931 57.9034h-8.2954l-2.4394-12.4429h-11.3042l-2.44 12.4429zm20.4937-20.25-4.066-20.9815h-.1626l-4.0664 20.9815z"/><path d="m86.9766 42.6055v3.5781a12.9 12.9 0 0 1 -1.0166 5.083 14.0881 14.0881 0 0 1 -2.8057 4.27 13.5323 13.5323 0 0 1 -4.1885 2.9683 12.2636 12.2636 0 0 1 -5.164 1.0977 18.5964 18.5964 0 0 1 -4.7984-.65 11.3307 11.3307 0 0 1 -4.3911-2.2774 12.5723 12.5723 0 0 1 -3.2123-4.1889 14.814 14.814 0 0 1 -1.2608-6.5463v-31.8795a14.0993 14.0993 0 0 1 .976-5.2861 12.4357 12.4357 0 0 1 2.7648-4.229 12.863 12.863 0 0 1 4.27-2.8054 14.35 14.35 0 0 1 5.4892-1.0169 12.5807 12.5807 0 0 1 9.5151 3.8223 13.6266 13.6266 0 0 1 2.8057 4.4321 14.9842 14.9842 0 0 1 1.0166 5.5708v3.253h-8.2954v-2.7652a6.7153 6.7153 0 0 0 -1.3824-4.2285 4.4819 4.4819 0 0 0 -3.7412-1.789q-3.0915 0-4.1064 1.9111a10.23 10.23 0 0 0 -1.0166 4.8384v29.6025a7.6635 7.6635 0 0 0 1.0976 4.2285q1.098 1.7081 3.9444 1.708a6.0109 6.0109 0 0 0 1.7485-.2846 5.2115 5.2115 0 0 0 1.7485-.9351 4.953 4.953 0 0 0 1.22-1.79 7.2474 7.2474 0 0 0 .4878-2.8462v-2.8457z"/><path d="m99.1748 59.1143v-50.0957h-9.5967v-7.8077h27.4878v7.8077h-9.5959v50.0957z"/><path d="m120.7246 59.1143v-57.9034h13.3369q14.6385 0 14.6385 16.9971a21.4218 21.4218 0 0 1 -1.5859 8.7017 12.2983 12.2983 0 0 1 -5.5708 5.7739l8.9458 26.4307h-8.7832l-7.7256-24.7227h-4.9603v24.7227zm8.2954-50.0957v18.0537h4.7168a8.348 8.348 0 0 0 3.4971-.61 4.7555 4.7555 0 0 0 2.0332-1.7485 7.9534 7.9534 0 0 0 .8945-2.8057 26.9748 26.9748 0 0 0 .2437-3.8628 26.99 26.99 0 0 0 -.2437-3.8628 7.7387 7.7387 0 0 0 -.976-2.8872q-1.5467-2.2753-5.8556-2.2767z"/><path d="m155.6123 59.1143v-57.9034h8.2954v57.9034z"/><path d="m198.7954 17.8828h-8.2949v-1.8706a8.8535 8.8535 0 0 0 -1.3423-4.92 4.962 4.962 0 0 0 -4.5132-2.0737 5.2227 5.2227 0 0 0 -2.7651.65 5.4612 5.4612 0 0 0 -1.708 1.6265 6.8624 6.8624 0 0 0 -.8946 2.3989 15.6706 15.6706 0 0 0 -.2436 2.8057 27.5758 27.5758 0 0 0 .1216 2.8467 5.3954 5.3954 0 0 0 .61 2.0332 4.5014 4.5014 0 0 0 1.4229 1.5449 12.9606 12.9606 0 0 0 2.562 1.3013l6.3433 2.521a15.7628 15.7628 0 0 1 4.4726 2.48 10.7272 10.7272 0 0 1 2.6839 3.2943 15.4228 15.4228 0 0 1 1.22 4.4321 44.0689 44.0689 0 0 1 .3252 5.6524 29.8066 29.8066 0 0 1 -.7319 6.7905 14.3039 14.3039 0 0 1 -2.3584 5.3267 11.699 11.699 0 0 1 -4.4727 3.5781 15.7942 15.7942 0 0 1 -6.75 1.3013 14.7745 14.7745 0 0 1 -5.6113-1.0572 13.31 13.31 0 0 1 -4.4732-2.9277 14.2235 14.2235 0 0 1 -2.9682-4.3506 13.2116 13.2116 0 0 1 -1.0982-5.4082v-3.09h8.2955v2.6025a6.7761 6.7761 0 0 0 1.3418 4.1069q1.3418 1.83 4.5136 1.83a7.2794 7.2794 0 0 0 3.2935-.61 4.3859 4.3859 0 0 0 1.83-1.7486 6.4244 6.4244 0 0 0 .7729-2.7246q.1216-1.5856.1221-3.5376a35.0565 35.0565 0 0 0 -.1631-3.7407 6.4528 6.4528 0 0 0 -.65-2.3584 4.59 4.59 0 0 0 -1.5044-1.4639 19.57 19.57 0 0 0 -2.4805-1.22l-5.9365-2.44q-5.3679-2.1958-7.1972-5.8145a19.9948 19.9948 0 0 1 -1.83-9.0679 21.0112 21.0112 0 0 1 .8945-6.1806 14.0506 14.0506 0 0 1 2.6841-5.042 12.3042 12.3042 0 0 1 4.3506-3.375 14.5257 14.5257 0 0 1 6.3018-1.2609 13.7661 13.7661 0 0 1 5.6519 1.1387 14.5927 14.5927 0 0 1 4.4326 3.0088 12.5712 12.5712 0 0 1 3.7407 8.9458z"/></g></svg></div><x-icon class="play" :class="initial &amp;&amp; !showHighscore ? 'show' : ''" @click="app.play()" name="play" size="80"></x-icon><div class="overlay lost" :class="lost &amp;&amp; !showHighscore ? 'show' : ''">Game over!</div><div class="overlay paused" :class="playing || lost || initial || showHighscore ? '' : 'show'">Paused</div><div class="highscore" :show="showHighscore"><div class="text-large"><x-icon name="trophy" size="36"></x-icon> Highscore</div><table><tr><td>\${highscore[0].name}</td><td>\${numberFormat(highscore[0].score)}</td></tr><tr><td>\${highscore[1].name}</td><td>\${numberFormat(highscore[1].score)}</td></tr><tr><td>\${highscore[2].name}</td><td>\${numberFormat(highscore[2].score)}</td></tr><tr><td>\${highscore[3].name}</td><td>\${numberFormat(highscore[3].score)}</td></tr><tr><td>\${highscore[4].name}</td><td>\${numberFormat(highscore[4].score)}</td></tr><tr><td>\${highscore[5].name}</td><td>\${numberFormat(highscore[5].score)}</td></tr><tr><td>\${highscore[6].name}</td><td>\${numberFormat(highscore[6].score)}</td></tr><tr><td>\${highscore[7].name}</td><td>\${numberFormat(highscore[7].score)}</td></tr><tr><td>\${highscore[8].name}</td><td>\${numberFormat(highscore[8].score)}</td></tr><tr><td>\${highscore[9].name}</td><td>\${numberFormat(highscore[9].score)}</td></tr><tr><td>\${highscore[10].name}</td><td>\${numberFormat(highscore[10].score)}</td></tr></table></div></div><div class="factris-keys"><button class="key-left" :class="key === 'left' ? 'active' : ''" title="Left" @pointerdown="app.keyPress('left')"><x-icon name="left" size="36"></x-icon></button><div class="keys-center"><button class="key-up" :class="key === 'up' ? 'active' : ''" title="Resize" @pointerdown="app.keyPress('up')"><svg class="icon" width="54" height="36" viewBox="0 0 54 36" xmlns="http://www.w3.org/2000/svg"><path d="m41.1973 11 1.5975-1.635a.75.75 0 0 1 1.2751.5325v.495a6 6 0 0 1 5.2501 5.8575.75.75 0 0 1 -1.5 0 4.5 4.5 0 0 0 -3.75-4.3426v1.1475a.75.75 0 0 1 -1.2751.5326l-1.5975-1.56a.7676.7676 0 0 1 -.0001-1.0275z"/><path d="m12.8027 11-1.5975-1.635a.75.75 0 0 0 -1.2752.5324v.495a6 6 0 0 0 -5.25 5.8576.75.75 0 0 0 1.5 0 4.5 4.5 0 0 1 3.75-4.3426v1.1475a.75.75 0 0 0 1.2751.5326l1.5975-1.56a.7676.7676 0 0 0 .0001-1.0275z"/><rect height="11" rx="2" width="11" x="15" y="6"/><rect height="11" rx="2" width="11" x="28" y="6"/><rect height="11" rx="2" width="11" x="15" y="19"/><rect height="11" rx="2" width="11" x="28" y="19"/><path d="m50 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/><path d="m11 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/></svg>
</button><button class="key-down" :class="key === 'down' ? 'active' : ''" title="Down" @pointerdown="app.keyPress('down')"><x-icon name="down" size="36"></x-icon></button></div><button class="key-right" :class="key === 'right' ? 'active' : ''" title="Right" @pointerdown="app.keyPress('right')"><x-icon name="right" size="36"></x-icon></button></div><div class="factris-panel-top" :class="showHighscore ? 'hide' : ''"><div class="text-small">Block size:</div><div class="text-large">\${active[0] || '?' } = \${active[2]|| '?'} \xD7 \${active[1]|| '?'}</div><div class="corner left"><svg width="13" height="13"><path d="M12,0A12,12,0,0,1,0,12v1H13V0Z"></path></svg></div><div class="corner right"><svg width="13" height="13"><path d="M1,0A12,12,0,0,0,13,12v1H0V0Z"></path></svg></div></div>`;var zw=1e3,ut=S(+io(location.search).size||16,8,24),Fw=5,Ks=Math.ceil(ut/2),xr=ut+Ks,Pr=[];for(let i=2;i<=ut*1.5;i+=1){let t=Js(i);t&&i>.75*ut||i>ut&&jc(i)[0]>ut/2||(t&&i>ut/2||i>1.25*ut?Pr.push(i):Pr.push(i,i))}var Bn=()=>Pr[tt.integer(Pr.length)],jw=pi(1,ut),Uw=ut*10,Ym=B(i=>Uw*2**i,ut),Qm=class{constructor(t,e,s){this.$el=h("rect",{width:20,height:20},s),this.setPosition(t,e)}setPosition(t,e){this.x=t,this.y=e,this.$el.setTransform({x:10+20*this.x,y:10+20*this.y})}go(t,e,s){this.setPosition(this.x+s-e,this.y+t)}canSet(t,e,s){return!s.find(n=>n.x===t&&n.y===e)}canGo(t,e,s,n){let o=this.x+s-e,r=this.y+t;return r>=xr||o<0||o>=ut?!1:this.canSet(o,r,n)}canGoDown(t){return this.canGo(1,0,0,t)}goDown(t=1){if(t!==0)return this.go(t,0,0)}},Cc=class extends O{constructor(){super(...arguments);this.interval=void 0;this.tiles=[];this.activeTiles=[];this.activeSize=[0,0,0];this.activeFactors=[];this.isDown=!1;this.keyLock=!1;this.requestQueue=Promise.resolve("");this.highscore=!0}ready(){this.$svg=this.$(".factris-board"),this.$tiles=this.$svg.$(".tiles"),this.$shadow=this.$svg.$(".shadow"),this.attr("highscore")==="no"&&(this.highscore=!1);let t=this.$svg.$(".scores");this.$scores=Ym.map((e,s)=>{let n=h("g",{},t);return h("text",{text:"+"+e,class:`s${s+1}`},n),n}),this.bindModel(mt({time:0,points:0,playing:!1,lost:!1,initial:!0,key:void 0,discardCounter:0,next:[],active:[],highscore:[],showHighscore:!1,min:e=>Math.floor(e/60),numberFormat:nt,app:this}));for(let e of this.$$("button, .play"))e.on("contextmenu",s=>s.preventDefault());b.onKey("left up right down",(e,s)=>{!this.model.playing||(e.preventDefault(),this.isDown=!0,this.model.key=s,this.keyPress(s))}),b.onKey("left up right down",()=>{!this.model.playing||(this.isDown=this.keyLock=!1,this.model.key=void 0)},!0),this.setupSVG(),this.updateHighscore()}setupSVG(){this.$svg.setAttr("viewBox",`0 0 ${(ut+1)*20} ${(xr+1)*20}`);let t=this.$svg.$(".grid"),e=t.$(".faint-grid");for(let s=0;s<=ut;s+=1){let n=10+s*20,o=10+(Ks+s)*20,r=!(s%4)||s===ut?t:e,a=!(s%2)||s===ut?"thick":"";h("line",{x1:10,y1:o,x2:10+ut*20,y2:o,class:a},r),h("line",{x1:n,y1:10+Ks*20,x2:n,y2:xr*20+10,class:a},r)}}drawShadow(){!this.activeTiles.length||(this.$shadow.setAttr("x",10+20*this.activeSize[0]),this.$shadow.setAttr("y",10+20*this.activeSize[1]),this.$shadow.setAttr("width",20*this.activeSize[2]),this.$shadow.setAttr("height",20*(xr-this.activeSize[1])))}newRect(){let t=this.getNewTileSize();this.activeFactors=jw.filter(n=>t%n==0);let e=this.activeFactors.pop(),s=Math.floor((ut-e)/2);this.activeTiles=B(n=>new Qm(s+n%e,Math.floor(n/e),this.$tiles),t),this.model.active=[t,e,t/e],this.activeSize=[s,t/e,e],this.drawShadow(),this.isDown&&(this.keyLock=!0)}reset(){this.pause(),this.model.time=0,this.model.points=0,this.model.discardCounter=0,this.model.showHighscore=!1,this.model.lost=!1,this.model.next=[Bn(),Bn(),Bn(),Bn()];for(let t of this.tiles)t.$el.remove();for(let t of this.activeTiles)t.$el.remove();this.tiles=[],this.newRect(),this.play(),this.requestQueue=Promise.resolve("")}toggle(){this.model.lost?this.reset():this.model.playing?this.pause():this.play()}pause(){this.model.playing=!1,clearInterval(this.interval)}play(){var t,e;if(this.model.showHighscore=!1,(t=window.ga)==null||t.call(window,"send","event","Factris","play"),(e=window.gtag)==null||e.call(window,"event","factris",{action:"play"}),this.model.initial||this.model.lost)return this.model.initial=!1,this.reset();this.model.playing=!0,this.interval=window.setInterval(()=>this.tick(),zw)}getNewTileSize(){let t=ut*ut-this.tiles.length;if(this.model.next[0]>t)return t>ut?t-ut:ut;this.model.discardCounter>0&&(this.model.discardCounter-=1);let e=this.model.next[0];return this.model.next=[...this.model.next.slice(1),Bn()],e}tick(){if(this.model.time+=1,this.activeTiles.every(o=>o.canGoDown(this.tiles))){for(let o of this.activeTiles)o.goDown();this.activeSize[1]+=1,this.drawShadow();return}this.tiles.push(...this.activeTiles);for(let o of this.activeTiles)o.$el.addClass("fixed");if(this.tiles.some(o=>o.y<Ks))return this.gameOver();this.activeTiles=[];let e=this.getFullRows();if(!e.length)return this.newRect();this.model.points+=q(Ym.slice(0,e.length)),e.length>=6&&Hi(10,150*e.length/ut),this.removeRows(e);let s=this.model.points,n=(s+ut)%13+(s-ut)%87;this.requestQueue=this.requestQueue.then(o=>ti("/factris-verify",{token:o,size:ut,score:s,check:n})),this.trigger("score",{points:s})}getFullRows(){return B(t=>this.tiles.filter(e=>e.y===t+Ks),ut).filter(t=>t.length===ut)}removeRows(t){let e=qt(t);this.tiles=this.tiles.filter(o=>!e.includes(o)),this.$tiles.addClass("animated"),b.redraw();for(let o of e)o.$el.addClass("removing");let s=t.map(o=>o[0].y);for(let o of this.tiles)o.goDown(s.filter(r=>r>o.y).length);let n=400/t.length;for(let[o,r]of s.reverse().entries())this.$scores[o].setTransform({x:10+Ks*20,y:27+r*20}),xe(()=>this.$scores[o].addClass("visible"),o*n);return setTimeout(()=>{for(let o of this.$scores)o.removeClass("visible")},600),setTimeout(()=>{for(let o of e)o.$el.remove();this.$tiles.removeClass("animated"),this.newRect()},1e3),!1}gameOver(){this.model.lost=!0;for(let t of this.activeTiles)t.$el.addClass("error");this.pause(),this.requestQueue.then(t=>{t&&this.trigger("game-over",{token:t,points:this.model.points})})}discharge(){if(!!this.model.playing){for(let t of this.activeTiles)t.$el.remove();this.newRect(),this.model.discardCounter=Fw}}keyPress(t,e=!0){if(!!this.model.playing&&!this.keyLock){if(t==="up"){if(!this.activeFactors.length)return;let s=this.activeFactors.pop(),n=this.activeSize[0]+Math.floor((this.activeSize[2]-s)/2),o=this.activeSize[1];if(this.activeTiles.some((l,c)=>!l.canSet(n+c%s,o-1-Math.floor(c/s),this.tiles)))return;for(let[l,c]of this.activeTiles.entries())c.setPosition(n+l%s,o-1-Math.floor(l/s));let a=this.model.active[0];this.model.active=[a,s,a/s],this.activeSize=[n,o,s]}else{let s=t==="down"?1:0,n=t==="left"?1:0,o=t==="right"?1:0;if(this.activeTiles.every(r=>r.canGo(s,n,o,this.tiles))){for(let r of this.activeTiles)r.go(s,n,o);this.activeSize[0]+=o-n,this.activeSize[1]+=s}e&&t==="down"&&setTimeout(()=>this.keyPress("down",!1),100)}this.drawShadow()}}showHighscore(){!this.highscore||(this.pause(),this.model.showHighscore=!0)}updateHighscore(){return R(this,null,function*(){if(!this.highscore)return;let t=yield fetch(`/factris-highscore?size=${ut}`);this.model.highscore=yield t.json()})}};Cc=N([A("x-factris",{template:Xm})],Cc);var Mc=class extends O{ready(){let t=Array.from(this._el.children);this.removeChildren();let e=h("svg",{class:"equation"},this),s=h("g",{transform:"translate(2 0)"},e),n=h("div",{class:"overlay"},this),o=parseFloat(this.css("font-size")),r=this.parents(".text-center").length||this.hasClass("display"),a=new Ee(s,n,0,"",o,!!r);a.setValue(this.attr("expr")||t),this.css({width:a.root.width+4+"px",height:a.root.height+"px","vertical-align":`-${a.root.height-a.root.baseline}px`})}};Mc=N([A("x-math")],Mc);window.$=G;window.$$=Ge;window.Browser=b;var Sr=G("x-modal#privacy");Sr&&Sr.$("form").on("submit",i=>{i.preventDefault();let t=Sr.$('input[name="newsletter"]');ti("/settings/privacy",{policies:"on",newsletter:t.checked?"on":"off"}),Sr.close()});var Jm="";function Ec(){return fetch("/joke").then(i=>i.text()).then(i=>Jm=i),Jm}var Ac=G(".error-box");Ac&&Ac.on("click",()=>Ac.html=Ec());Ec();window.tellMeAJoke=function(){return Ec().replace(/<p>/g,"").replace(/<\/p>/g,`
`).trim()};console.log(`%cWelcome to Mathigon!
%cYou can see our source code at https://github.com/mathigon
%cIf you want to contribute, visit https://mathigon.io
%cJust here for fun? Run tellMeAJoke()`,"color: #cd0e66; font-weight: bold; font-size: 18px;","color: #0f82f2; font-weight: bold;","color: #22ab24; font-weight: bold;","color: #fd8c00; font-weight: bold;");var tg=[38,38,40,40,37,39,37,39,66,65],zn=0;document.addEventListener("keydown",i=>{i.keyCode===tg[zn]?(zn+=1,zn===tg.length&&(Hi(),zn=0)):zn=0});})();